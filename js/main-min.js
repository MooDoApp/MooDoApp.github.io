function dateWrapper(){this.dateLibLoaded=!0,Date.CultureInfo={name:"en-US",englishName:"English (United States)",nativeName:"English (United States)",dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbreviatedDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortestDayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],firstLetterDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"am",pmDesignator:"pm",firstDayOfWeek:0,twoDigitYearMax:2029,dateElementOrder:"mdy",formatPatterns:{shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"MMMM dd",yearMonth:"MMMM, yyyy"},regexPatterns:{jan:/^jan(uary)?/i,feb:/^feb(ruary)?/i,mar:/^mar(ch)?/i,apr:/^apr(il)?/i,may:/^may/i,jun:/^jun(e)?/i,jul:/^jul(y)?/i,aug:/^aug(ust)?/i,sep:/^sep(t(ember)?)?/i,oct:/^oct(ober)?/i,nov:/^nov(ember)?/i,dec:/^dec(ember)?/i,sun:/^sun(day)?/i,mon:/^mon(day)?/i,tue:/^tue(s(day)?)?/i,wed:/^wed(nesday)?/i,thu:/^thu(rsday)?/i,fri:/^fri(day)?/i,sat:/^sat(urday)?/i,future:/^next/i,past:/^last|past|prev(ious)?/i,yesterday:/^yesterday/i,today:/^today/i,tomorrow:/^tom(orrow)?/i,soon:/^soon/i,later:/^later/i,now:/^now/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt|utc)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a(?!u|p)|p)/i},timezones:[{name:"UTC",offset:"-000"},{name:"GMT",offset:"-000"},{name:"EST",offset:"-0500"},{name:"EDT",offset:"-0400"},{name:"CST",offset:"-0600"},{name:"CDT",offset:"-0500"},{name:"MST",offset:"-0700"},{name:"MDT",offset:"-0600"},{name:"PST",offset:"-0800"},{name:"PDT",offset:"-0700"}]},function(){var $D=Date,$P=$D.prototype,$C=$D.CultureInfo,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)};$P.clearTime=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},$P.setTimeToNow=function(){var n=new Date;return this.setHours(n.getHours()),this.setMinutes(n.getMinutes()),this.setSeconds(n.getSeconds()),this.setMilliseconds(n.getMilliseconds()),this},$D.today=function(){return(new Date).clearTime()},$D.compare=function(date1,date2){if(isNaN(date1)||isNaN(date2))throw new Error(date1+" - "+date2);if(date1 instanceof Date&&date2 instanceof Date)return date2>date1?-1:date1>date2?1:0;throw new TypeError(date1+" - "+date2)},$D.equals=function(date1,date2){return 0===date1.compareTo(date2)},$D.getDayNumberFromName=function(name){for(var n=$C.dayNames,m=$C.abbreviatedDayNames,o=$C.shortestDayNames,s=name.toLowerCase(),i=0;i<n.length;i++)if(n[i].toLowerCase()==s||m[i].toLowerCase()==s||o[i].toLowerCase()==s)return i;return-1},$D.getMonthNumberFromName=function(name){for(var n=$C.monthNames,m=$C.abbreviatedMonthNames,s=name.toLowerCase(),i=0;i<n.length;i++)if(n[i].toLowerCase()==s||m[i].toLowerCase()==s)return i;return-1},$D.isLeapYear=function(year){return year%4===0&&year%100!==0||year%400===0},$D.getDaysInMonth=function(year,month){return[31,$D.isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month]},$D.getTimezoneAbbreviation=function(offset){for(var z=$C.timezones,p,i=0;i<z.length;i++)if(z[i].offset===offset)return z[i].name;return null},$D.getTimezoneOffset=function(name){for(var z=$C.timezones,p,i=0;i<z.length;i++)if(z[i].name===name.toUpperCase())return z[i].offset;return null},$P.clone=function(){var tempDate=new Date(this.getTime());return tempDate._explicitTime=this._explicitTime,tempDate},$P.compareTo=function(date){return Date.compare(this,date)},$P.equals=function(date){return Date.equals(this,date||new Date)},$P.between=function(start,end){return this.getTime()>=start.getTime()&&this.getTime()<=end.getTime()},$P.isAfter=function(date){return 1===this.compareTo(date||new Date)},$P.isBefore=function(date){return-1===this.compareTo(date||new Date)},$P.isToday=function(){return this.isSameDay(new Date)},$P.isSameDay=function(date){return this.clone().clearTime().equals(date.clone().clearTime())},$P.addMilliseconds=function(value){return this.setMilliseconds(this.getMilliseconds()+value),this},$P.addSeconds=function(value){return this.addMilliseconds(1e3*value)},$P.addMinutes=function(value){return this.addMilliseconds(6e4*value)},$P.addHours=function(value){return this.addMilliseconds(36e5*value)},$P.addDays=function(value){return this.setDate(this.getDate()+value),this},$P.addWeeks=function(value){return this.addDays(7*value)},$P.addMonths=function(value){var n=this.getDate();return this.setDate(1),this.setMonth(this.getMonth()+value),this.setDate(Math.min(n,$D.getDaysInMonth(this.getFullYear(),this.getMonth()))),this},$P.addYears=function(value){return this.addMonths(12*value)},$P.add=function(config){if("number"==typeof config)return this._orient=config,this;var x=config;return x.millisecond&&this.addMilliseconds(x.millisecond),x.second&&this.addSeconds(x.second),x.minute&&this.addMinutes(x.minute),x.hour&&this.addHours(x.hour),x.week&&this.addWeeks(x.week),x.month&&this.addMonths(x.month),x.years&&this.addYears(x.years),x.days&&this.addDays(x.days),x.setExplicitTime&&(this._explicitTime=!0),this};var $y,$m,$d;$P.getWeek=function(){var a,b,c,d,e,f,g,n,s,w;return $y=$y?$y:this.getFullYear(),$m=$m?$m:this.getMonth()+1,$d=$d?$d:this.getDate(),2>=$m?(a=$y-1,b=(a/4|0)-(a/100|0)+(a/400|0),c=((a-1)/4|0)-((a-1)/100|0)+((a-1)/400|0),s=b-c,e=0,f=$d-1+31*($m-1)):(a=$y,b=(a/4|0)-(a/100|0)+(a/400|0),c=((a-1)/4|0)-((a-1)/100|0)+((a-1)/400|0),s=b-c,e=s+1,f=$d+(153*($m-3)+2)/5+58+s),g=(a+b)%7,d=(f+g-e)%7,n=f+3-d|0,w=0>n?53-((g-s)/5|0):n>364+s?1:(n/7|0)+1,$y=$m=$d=null,w},$P.getISOWeek=function(){return $y=this.getUTCFullYear(),$m=this.getUTCMonth()+1,$d=this.getUTCDate(),p(this.getWeek())},$P.setWeek=function(n){return this.moveToDayOfWeek(1).addWeeks(n-this.getWeek())},$D._validate=function(n,min,max,name){if("undefined"==typeof n)return!1;if("number"!=typeof n)throw new TypeError(n+" is not a Number.");if(min>n||n>max)throw new RangeError(n+" is not a valid value for "+name+".");return!0},$D.validateMillisecond=function(value){return $D._validate(value,0,999,"millisecond")},$D.validateSecond=function(value){return $D._validate(value,0,59,"second")},$D.validateMinute=function(value){return $D._validate(value,0,59,"minute")},$D.validateHour=function(value){return $D._validate(value,0,23,"hour")},$D.validateDay=function(value,year,month){return $D._validate(value,1,$D.getDaysInMonth(year,month),"day")},$D.validateMonth=function(value){return $D._validate(value,0,11,"month")},$D.validateYear=function(value){return $D._validate(value,0,9999,"year")},$P.set=function(config){return $D.validateMillisecond(config.millisecond)&&this.addMilliseconds(config.millisecond-this.getMilliseconds()),$D.validateSecond(config.second)&&this.addSeconds(config.second-this.getSeconds()),$D.validateMinute(config.minute)&&this.addMinutes(config.minute-this.getMinutes()),$D.validateHour(config.hour)&&this.addHours(config.hour-this.getHours()),$D.validateMonth(config.month)&&this.addMonths(config.month-this.getMonth()),$D.validateYear(config.year)&&this.addYears(config.year-this.getFullYear()),$D.validateDay(config.day,this.getFullYear(),this.getMonth())&&this.addDays(config.day-this.getDate()),config.timezone&&this.setTimezone(config.timezone),config.timezoneOffset&&this.setTimezoneOffset(config.timezoneOffset),config.week&&$D._validate(config.week,0,53,"week")&&this.setWeek(config.week),config.setExplicitTime&&(this._explicitTime=!0),this},$P.moveToFirstDayOfMonth=function(){return this.set({day:1})},$P.moveToLastDayOfMonth=function(){return this.set({day:$D.getDaysInMonth(this.getFullYear(),this.getMonth())})},$P.moveToNthOccurrence=function(dayOfWeek,occurrence){var shift=0;if(occurrence>0)shift=occurrence-1;else if(-1===occurrence)return this.moveToLastDayOfMonth(),this.getDay()!==dayOfWeek&&this.moveToDayOfWeek(dayOfWeek,-1),this;return this.moveToFirstDayOfMonth().addDays(-1).moveToDayOfWeek(dayOfWeek,1).addWeeks(shift)},$P.moveToDayOfWeek=function(dayOfWeek,orient){var diff=(dayOfWeek-this.getDay()+7*(orient||1))%7;return this.addDays(0===diff?diff+=7*(orient||1):diff)},$P.moveToMonth=function(month,orient){var diff=(month-this.getMonth()+12*(orient||1))%12;return this.addMonths(0===diff?diff+=12*(orient||1):diff)},$P.getOrdinalNumber=function(){return Math.ceil((this.clone().clearTime()-new Date(this.getFullYear(),0,1))/864e5)+1},$P.getTimezone=function(){return $D.getTimezoneAbbreviation(this.getUTCOffset())},$P.setTimezoneOffset=function(offset){var here=this.getTimezoneOffset(),there=-6*Number(offset)/10;return this.addMinutes(there-here)},$P.setTimezone=function(offset){return this.setTimezoneOffset($D.getTimezoneOffset(offset))},$P.hasDaylightSavingTime=function(){return Date.today().set({month:0,day:1}).getTimezoneOffset()!==Date.today().set({month:6,day:1}).getTimezoneOffset()},$P.isDaylightSavingTime=function(){return this.hasDaylightSavingTime()&&(new Date).getTimezoneOffset()===Date.today().set({month:6,day:1}).getTimezoneOffset()},$P.getUTCOffset=function(){var n=-10*this.getTimezoneOffset()/6,r;return 0>n?(r=(n-1e4).toString(),r.charAt(0)+r.substr(2)):(r=(n+1e4).toString(),"+"+r.substr(1))},$P.getElapsed=function(date){return(date||new Date)-this},$P.toISOString||($P.toISOString=function(){function f(n){return 10>n?"0"+n:n}return'"'+this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+'Z"'}),$P._toString=$P.toString,$P.toString=function(format){var x=this;if(format&&1==format.length){var c=$C.formatPatterns;switch(x.t=x.toString,format){case"d":return x.t(c.shortDate);case"D":return x.t(c.longDate);case"F":return x.t(c.fullDateTime);case"m":return x.t(c.monthDay);case"r":return x.t(c.rfc1123);case"s":return x.t(c.sortableDateTime);case"t":return x.t(c.shortTime);case"T":return x.t(c.longTime);case"u":return x.t(c.universalSortableDateTime);case"y":return x.t(c.yearMonth)}}var ord=function(n){switch(1*n){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}};return format?format.replace(/(\\)?(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|S)/g,function(m){if("\\"===m.charAt(0))return m.replace("\\","");switch(x.h=x.getHours,m){case"hh":return p(x.h()<13?0===x.h()?12:x.h():x.h()-12);case"h":return x.h()<13?0===x.h()?12:x.h():x.h()-12;case"HH":return p(x.h());case"H":return x.h();case"mm":return p(x.getMinutes());case"m":return x.getMinutes();case"ss":return p(x.getSeconds());case"s":return x.getSeconds();case"yyyy":return p(x.getFullYear(),4);case"yy":return p(x.getFullYear());case"dddd":return $C.dayNames[x.getDay()];case"ddd":return $C.abbreviatedDayNames[x.getDay()];case"dd":return p(x.getDate());case"d":return x.getDate();case"MMMM":return $C.monthNames[x.getMonth()];case"MMM":return $C.abbreviatedMonthNames[x.getMonth()];case"MM":return p(x.getMonth()+1);case"M":return x.getMonth()+1;case"t":return x.h()<12?$C.amDesignator.substring(0,1):$C.pmDesignator.substring(0,1);case"tt":return x.h()<12?$C.amDesignator:$C.pmDesignator;case"S":return ord(x.getDate());default:return m}}):this._toString()}}(),function(){var $D=Date,$P=$D.prototype,$C=$D.CultureInfo,$N=Number.prototype;$P._orient=1,$P._nth=null,$P._is=!1,$P._same=!1,$P._explicitTime=!1,$P._isSecond=!1,$N._dateElement="day",$P.next=function(){return this._orient=1,this},$D.next=function(){return $D.today().next()},$P.last=$P.prev=$P.previous=function(){return this._orient=-1,this},$D.last=$D.prev=$D.previous=function(){return $D.today().last()},$P.is=function(){return this._is=!0,this},$P.same=function(){return this._same=!0,this._isSecond=!1,this},$P.today=function(){return this.same().day()},$P.weekday=function(){return this._is?(this._is=!1,!this.is().sat()&&!this.is().sun()):!1},$P.at=function(time){return"string"==typeof time?$D.parse(this.toString("d")+" "+time):this.set(time)},$N.fromNow=$N.after=function(date){var c={};return c[this._dateElement]=this,(date?date.clone():new Date).add(c)},$N.ago=$N.before=function(date){var c={};return c[this._dateElement]=-1*this,(date?date.clone():new Date).add(c)};var dx="sunday monday tuesday wednesday thursday friday saturday".split(/\s/),mx="january february march april may june july august september october november december".split(/\s/),px=[],pxf=[],nth="final first second third fourth fifth".split(/\s/),de;$P.toObject=function(){for(var o={},i=0;i<px.length;i++)o[px[i].toLowerCase()]=this["get"+pxf[i]]();return o},$D.fromObject=function(config){return config.week=null,Date.today().set(config)};for(var df=function(n){return function(){if(this._is)return this._is=!1,this.getDay()==n;if(null!==this._nth){this._isSecond&&this.addSeconds(-1*this._orient),this._isSecond=!1;var ntemp=this._nth;this._nth=null;var temp=this.clone().moveToLastDayOfMonth();if(this.moveToNthOccurrence(n,ntemp),this>temp)throw new RangeError($D.getDayName(n)+" does not occur "+ntemp+" times in the month of "+$D.getMonthName(temp.getMonth())+" "+temp.getFullYear()+".");return this}return this.moveToDayOfWeek(n,this._orient)}},sdf=function(n){return function(){var t=$D.today(),shift=n-t.getDay();return(0===n&&1===$C.firstDayOfWeek&&0!==t.getDay()||0>shift)&&(shift+=7),t.addDays(shift)}},i=0;i<dx.length;i++)$D[dx[i].toUpperCase()]=$D[dx[i].toUpperCase().substring(0,3)]=i,$D[dx[i]]=$D[dx[i].substring(0,3)]=sdf(i),$P[dx[i]]=$P[dx[i].substring(0,3)]=df(i);for(var mf=function(n){return function(){return this._is?(this._is=!1,this.getMonth()===n):this.moveToMonth(n,this._orient)}},smf=function(n){return function(){return $D.today().set({month:n,day:1})}},j=0;j<mx.length;j++)$D[mx[j].toUpperCase()]=$D[mx[j].toUpperCase().substring(0,3)]=j,$D[mx[j]]=$D[mx[j].substring(0,3)]=smf(j),$P[mx[j]]=$P[mx[j].substring(0,3)]=mf(j);for(var ef=function(j){return function(){if(this._isSecond)return this._isSecond=!1,this;if(this._same){this._same=this._is=!1;for(var o1=this.toObject(),o2=(arguments[0]||new Date).toObject(),v="",k=j.toLowerCase(),m=px.length-1;m>-1;m--){if(v=px[m].toLowerCase(),o1[v]!=o2[v])return!1;if(k==v)break}return!0}return"s"!=j.substring(j.length-1)&&(j+="s"),this["add"+j](this._orient)}},nf=function(n){return function(){return this._dateElement=n,this}},k=0;k<px.length;k++)de=px[k].toLowerCase(),$P[de]=$P[de+"s"]=ef(px[k]),$N[de]=$N[de+"s"]=nf(de);$P._ss=ef("Second");for(var nthfn=function(n){return function(dayOfWeek){return this._same?this._ss(arguments[0]):dayOfWeek||0===dayOfWeek?this.moveToNthOccurrence(dayOfWeek,n):(this._nth=n,2!==n||void 0!==dayOfWeek&&null!==dayOfWeek?this:(this._isSecond=!0,this.addSeconds(this._orient)))}},l=0;l<nth.length;l++)$P[nth[l]]=nthfn(0===l?-1:l)}(),function(){Date.Parsing={Exception:function(s){this.message="Parse error at '"+s.substring(0,10)+" ...'"}};for(var $P=Date.Parsing,_=$P.Operators={rtoken:function(r){return function(s){var mx=s.match(r);if(mx)return[mx[0],s.substring(mx[0].length)];throw new $P.Exception(s)}},token:function(s){return function(s){return _.rtoken(new RegExp("^s*"+s+"s*"))(s)}},stoken:function(s){return _.rtoken(new RegExp("^"+s))},until:function(p){return function(s){for(var qx=[],rx=null;s.length;){try{rx=p.call(this,s)}catch(e){qx.push(rx[0]),s=rx[1];continue}break}return[qx,s]}},many:function(p){return function(s){for(var rx=[],r=null;s.length;){try{r=p.call(this,s)}catch(e){return[rx,s]}rx.push(r[0]),s=r[1]}return[rx,s]}},optional:function(p){return function(s){var r=null;try{r=p.call(this,s)}catch(e){return[null,s]}return[r[0],r[1]]}},not:function(p){return function(s){try{p.call(this,s)}catch(e){return[null,s]}throw new $P.Exception(s)}},ignore:function(p){return p?function(s){var r=null;return r=p.call(this,s),[null,r[1]]}:null},product:function(){for(var px=arguments[0],qx=Array.prototype.slice.call(arguments,1),rx=[],i=0;i<px.length;i++)rx.push(_.each(px[i],qx));return rx},cache:function(rule){var cache={},r=null;return function(s){try{r=cache[s]=cache[s]||rule.call(this,s)}catch(e){r=cache[s]=e}if(r instanceof $P.Exception)throw r;return r}},any:function(){var px=arguments;return function(s){for(var r=null,i=0;i<px.length;i++)if(null!=px[i]){try{r=px[i].call(this,s)}catch(e){r=null}if(r)return r}throw new $P.Exception(s)}},each:function(){var px=arguments;return function(s){for(var rx=[],r=null,i=0;i<px.length;i++)if(null!=px[i]){try{r=px[i].call(this,s)}catch(e){throw new $P.Exception(s)}rx.push(r[0]),s=r[1]}return[rx,s]}},all:function(){var px=arguments,_=_;return _.each(_.optional(px))},sequence:function(px,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,1==px.length?px[0]:function(s){for(var r=null,q=null,rx=[],i=0;i<px.length;i++){try{r=px[i].call(this,s)}catch(e){break}rx.push(r[0]);try{q=d.call(this,r[1])}catch(ex){q=null;break}s=q[1]}if(!r)throw new $P.Exception(s);if(q)throw new $P.Exception(q[1]);if(c)try{r=c.call(this,r[1])}catch(ey){throw new $P.Exception(r[1])}return[rx,r?r[1]:s]}},between:function(d1,p,d2){d2=d2||d1;var _fn=_.each(_.ignore(d1),p,_.ignore(d2));return function(s){var rx=_fn.call(this,s);return[[rx[0][0],r[0][2]],rx[1]]}},list:function(p,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,p instanceof Array?_.each(_.product(p.slice(0,-1),_.ignore(d)),p.slice(-1),_.ignore(c)):_.each(_.many(_.each(p,_.ignore(d))),px,_.ignore(c))},set:function(px,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,function(s){for(var r=null,p=null,q=null,rx=null,best=[[],s],last=!1,i=0;i<px.length;i++){q=null,p=null,r=null,last=1==px.length;try{r=px[i].call(this,s)}catch(e){continue}if(rx=[[r[0]],r[1]],r[1].length>0&&!last)try{q=d.call(this,r[1])}catch(ex){last=!0}else last=!0;if(last||0!==q[1].length||(last=!0),!last){for(var qx=[],j=0;j<px.length;j++)i!=j&&qx.push(px[j]);p=_.set(qx,d).call(this,q[1]),p[0].length>0&&(rx[0]=rx[0].concat(p[0]),rx[1]=p[1])}if(rx[1].length<best[1].length&&(best=rx),0===best[1].length)break}if(0===best[0].length)return best;if(c){try{q=c.call(this,best[1])}catch(ey){throw new $P.Exception(best[1])}best[1]=q[1]}return best}},forward:function(gr,fname){return function(s){return gr[fname].call(this,s)}},replace:function(rule,repl){return function(s){var r=rule.call(this,s);return[repl,r[1]]}},process:function(rule,fn){return function(s){var r=rule.call(this,s);return[fn.call(this,r[0]),r[1]]}},min:function(min,rule){return function(s){var rx=rule.call(this,s);if(rx[0].length<min)throw new $P.Exception(s);return rx}}},_generator=function(op){return function(){var args=null,rx=[];if(arguments.length>1?args=Array.prototype.slice.call(arguments):arguments[0]instanceof Array&&(args=arguments[0]),!args)return op.apply(null,arguments);for(var i=0,px=args.shift();i<px.length;i++)return args.unshift(px[i]),rx.push(op.apply(null,args)),args.shift(),rx}},gx="optional not ignore cache".split(/\s/),i=0;i<gx.length;i++)_[gx[i]]=_generator(_[gx[i]]);for(var _vector=function(op){return function(){return arguments[0]instanceof Array?op.apply(null,arguments[0]):op.apply(null,arguments)}},vx="each any all".split(/\s/),j=0;j<vx.length;j++)_[vx[j]]=_vector(_[vx[j]])}(),function(){var $D=Date,$P=$D.prototype,$C=$D.CultureInfo,flattenAndCompact=function(ax){for(var rx=[],i=0;i<ax.length;i++)ax[i]instanceof Array?rx=rx.concat(flattenAndCompact(ax[i])):ax[i]&&rx.push(ax[i]);return rx};$D.Grammar={},$D.Translator={hour:function(s){return function(){this.hour=Number(s),this.setExplicitTime=!0}},minute:function(s){return function(){this.minute=Number(s),this.setExplicitTime=!0}},second:function(s){return function(){this.second=Number(s),this.setExplicitTime=!0}},meridian:function(s){return function(){this.meridian=s.slice(0,1).toLowerCase()}},timezone:function(s){return function(){var n=s.replace(/[^\d\+\-]/g,"");n.length?this.timezoneOffset=Number(n):this.timezone=s.toLowerCase()}},day:function(x){var s=x[0];return function(){this.day=Number(s.match(/\d+/)[0])}},month:function(s){return function(){this.month=3==s.length?"jan feb mar apr may jun jul aug sep oct nov dec".indexOf(s)/4:Number(s)-1}},year:function(s){return function(){var n=Number(s);this.year=s.length>2?n:n+(n+2e3<$C.twoDigitYearMax?2e3:1900)}},rday:function(s){return function(){var day=(new Date).getDate();switch(s){case"yesterday":this.days=-1;break;case"later":this.days=5;break;case"soon":this.days=2;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0,this.now=!0}}},finishExact:function(x){x=x instanceof Array?x:[x];for(var i=0;i<x.length;i++)x[i]&&x[i].call(this);var now=new Date;if(!this.hour&&!this.minute||this.month||this.year||this.day||(this.day=now.getDate()),this.year||(this.year=now.getFullYear(),this.month<now.getMonth()&&this.year++),this.month||0===this.month||(this.month=now.getMonth()),this.day||(this.day=1),this.hour||(this.hour=0),this.minute||(this.minute=0),this.second||(this.second=0),this.meridian&&this.hour&&("p"==this.meridian&&this.hour<12?this.hour=this.hour+12:"a"==this.meridian&&12==this.hour&&(this.hour=0)),this.day>$D.getDaysInMonth(this.year,this.month))throw new RangeError(this.day+" is not a valid value for days.");var r=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second);return r._explicitTime=this.setExplicitTime,this.timezone?r.set({timezone:this.timezone}):this.timezoneOffset&&r.set({timezoneOffset:this.timezoneOffset}),r},finish:function(x){if(x=x instanceof Array?flattenAndCompact(x):[x],0===x.length)return null;for(var i=0;i<x.length;i++)"function"==typeof x[i]&&x[i].call(this);var today=$D.today();if(this.now&&!this.unit&&!this.operator)return new Date;this.now&&(today=new Date);var givenYear=!!this.year,expression=!!(this.days&&null!==this.days||this.orient||this.operator),gap,mod,orient;if(orient="past"==this.orient||"subtract"==this.operator?-1:1,this.now||-1=="hour minute second".indexOf(this.unit)||today.setTimeToNow(),(this.month||0===this.month)&&-1!="year day hour minute second".indexOf(this.unit)&&(this.value=this.month+1,this.month=null,expression=!0),!expression&&this.weekday&&!this.day&&!this.days){var temp=Date[this.weekday]();this.day=temp.getDate(),this.month||(this.month=temp.getMonth()),this.year=temp.getFullYear()}if(expression&&this.weekday&&"month"!=this.unit&&(this.unit="day",gap=$D.getDayNumberFromName(this.weekday)-today.getDay(),mod=7,this.days=gap?(gap+orient*mod)%mod:orient*mod),this.month&&"day"==this.unit&&this.operator&&(this.value=this.month+1,this.month=null),null!=this.value&&null!=this.month&&null!=this.year&&(this.day=1*this.value),this.month&&!this.day&&this.value&&(today.set({day:1*this.value}),expression||(this.day=1*this.value)),this.month||!this.value||"month"!=this.unit||this.now||(this.month=this.value,expression=!0),expression&&(this.month||0===this.month)&&"year"!=this.unit&&(this.unit="month",gap=this.month-today.getMonth(),mod=12,this.months=gap?(gap+orient*mod)%mod:orient*mod,this.month=null),this.unit||(this.unit="day"),!this.value&&this.operator&&null!==this.operator&&this[this.unit+"s"]&&null!==this[this.unit+"s"]?this[this.unit+"s"]=this[this.unit+"s"]+("add"==this.operator?1:-1)+(this.value||0)*orient:(null==this[this.unit+"s"]||null!=this.operator)&&(this.value||(this.value=1),this[this.unit+"s"]=this.value*orient),this.meridian&&this.hour&&("p"==this.meridian&&this.hour<12?this.hour=this.hour+12:"a"==this.meridian&&12==this.hour&&(this.hour=0)),this.weekday&&!this.day&&!this.days){var temp=Date[this.weekday]();this.day=temp.getDate(),temp.getMonth()!==today.getMonth()&&(this.month=temp.getMonth())}return!this.month&&0!==this.month||this.day||(this.day=1),this.orient||this.operator||"week"!=this.unit||!this.value||this.day||this.month?(expression&&this.timezone&&this.day&&this.days&&(this.day=this.days),!givenYear&&this.month<today.getMonth()&&(this.year=today.getFullYear()+1),expression?today.add(this):today.set(this)):Date.today().setWeek(this.value)}};var _=$D.Parsing.Operators,g=$D.Grammar,t=$D.Translator,_fn;g.datePartDelimiter=_.rtoken(/^([\s\-\.\,\/\x27]+)/),g.timePartDelimiter=_.stoken(":"),g.whiteSpace=_.rtoken(/^\s*/),g.generalDelimiter=_.rtoken(/^(([\s\,]|at|@|on)+)/);var _C={};g.ctoken=function(keys){var fn=_C[keys];if(!fn){for(var c=$C.regexPatterns,kx=keys.split(/\s+/),px=[],i=0;i<kx.length;i++)px.push(_.replace(_.rtoken(c[kx[i]]),kx[i]));fn=_C[keys]=_.any.apply(null,px)}return fn},g.ctoken2=function(key){return _.rtoken($C.regexPatterns[key])},g.h=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2]|[1-9])/),t.hour)),g.hh=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2])/),t.hour)),g.H=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3]|[0-9])/),t.hour)),g.HH=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3])/),t.hour)),g.m=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.minute)),g.mm=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.minute)),g.s=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.second)),g.ss=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.second)),g.hms=_.cache(_.sequence([g.H,g.m,g.s],g.timePartDelimiter)),g.t=_.cache(_.process(g.ctoken2("shortMeridian"),t.meridian)),g.tt=_.cache(_.process(g.ctoken2("longMeridian"),t.meridian)),g.z=_.cache(_.process(_.rtoken(/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/),t.timezone)),g.zz=_.cache(_.process(_.rtoken(/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/),t.timezone)),g.zzz=_.cache(_.process(g.ctoken2("timezone"),t.timezone)),g.timeSuffix=_.each(_.ignore(g.whiteSpace),_.set([g.tt,g.zzz])),g.time=_.each(_.optional(_.ignore(_.stoken("T"))),g.hms,g.timeSuffix),g.d=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1]|\d)/),_.optional(g.ctoken2("ordinalSuffix"))),t.day)),g.dd=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1])/),_.optional(g.ctoken2("ordinalSuffix"))),t.day)),g.rday=_.cache(_.process(g.ctoken("yesterday tomorrow soon later today now"),t.rday)),g.ddd=g.dddd=_.cache(_.process(g.ctoken("sun mon tue wed thu fri sat"),function(s){return function(){this.weekday=s}})),g.M=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d|\d)/),t.month)),g.MM=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d)/),t.month)),g.MMM=g.MMMM=_.cache(_.process(g.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),t.month)),g.y=_.cache(_.process(_.rtoken(/^(\d\d?)/),t.year)),g.yy=_.cache(_.process(_.rtoken(/^(\d\d)/),t.year)),g.yyy=_.cache(_.process(_.rtoken(/^(\d\d?\d?\d?)/),t.year)),g.yyyy=_.cache(_.process(_.rtoken(/^(\d\d\d\d)/),t.year)),_fn=function(){return _.each(_.any.apply(null,arguments),_.not(g.ctoken2("timeContext")))},g.day=_fn(g.d,g.dd,g.rday),g.month=_fn(g.M,g.MMM),g.year=_fn(g.yyyy,g.yy),g.orientation=_.process(g.ctoken("past future"),function(s){return function(){this.orient=s}}),g.value=_.process(_.rtoken(/^\d\d?(st|nd|rd|th)?/),function(s){return function(){this.value=s.replace(/\D/g,"")}}),g.expression=_.set([g.rday,g.value,g.orientation,g.ddd,g.MMM]),_fn=function(){return _.set(arguments,g.datePartDelimiter)},g.mdy=_fn(g.ddd,g.month,g.day,g.year),g.ymd=_fn(g.ddd,g.year,g.month,g.day),g.dmy=_fn(g.ddd,g.day,g.month,g.year),g.date=function(s){return(g[$C.dateElementOrder]||g.mdy).call(this,s)},g.format=_.process(_.many(_.any(_.process(_.rtoken(/^(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(fmt){if(g[fmt])return g[fmt];throw $D.Parsing.Exception(fmt)}),_.process(_.rtoken(/^[^dMyhHmstz]+/),function(s){return _.ignore(_.stoken(s))}))),function(rules){return _.process(_.each.apply(null,rules),t.finishExact)});var _F={},_get=function(f){return _F[f]=_F[f]||g.format(f)[0]};g.formats=function(fx){if(fx instanceof Array){for(var rx=[],i=0;i<fx.length;i++)rx.push(_get(fx[i]));return _.any.apply(null,rx)}return _get(fx)};var dateParseFormats=["M/d H","M-d H","MMddyyyy","ddMMyyyy","Mddyyyy","ddMyyyy","Mdyyyy","dMyyyy","yyyy","Mdyy","dMyy"];g._formats=g.formats(dateParseFormats),g._start=_.process(_.set([g.date,g.time,g.expression],g.generalDelimiter,g.whiteSpace),t.finish),g.start=function(s){try{var r=g._formats.call({},s);if(0===r[1].length)return r}catch(e){}return g._start.call({},s)},$D._parse=$D.parse,$D.parse=function(s){var r=null;if(!s)return null;if(s instanceof Date)return s;try{r=$D.Grammar.start.call({},s.replace(/^\s*(\S*(\s+\S+)*)\s*$/,"$1"))}catch(e){return null}return 0===r[1].length?r[0]:null},$D.getParseFunction=function(fx){var fn=$D.Grammar.formats(fx);return function(s){var r=null;try{r=fn.call({},s)}catch(e){return null}return 0===r[1].length?r[0]:null}},$D.parseExact=function(s,fx){return $D.getParseFunction(fx)(s)}}()}function DuchessHelpersWrapper(self){function escape(html,formats){return String(html).replace(/[&\"<>]/g,function(chr){return charMap[chr]})}function trimPunc(str){var outStr=str.replace(/[:,\.\'\"\)\]]$/g,"");return outStr}this.helperLibLoaded=!0;var VMLIFlag={LSNormal:0,LSComplete:4096},NumListPrefix="#.",NumListPrefixOther="1.",DatePrefix="@",ContactPrefix="+",cmdChar=-1==navigator.userAgent.indexOf("Mac")?"ctrl":"⌘";String.prototype.insertTag=function(sIndex,sTag,length,eTag){return this.substr(0,sIndex)+sTag+this.substr(sIndex,length)+eTag+this.substr(sIndex+length)},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(str){return 0===this.lastIndexOf(str,0)});var charMap={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"},softDates=["YESTERDAY","TODAY","TOMORROW"],tagRegexp=/(^#|[\(\s]#)([^\s\),]+)/g,dateRegexp=/(?:^@|[\(\s]@)([^\s\)]+)(\s[^\s\)@]+)?(\s[^\s\)@]+)?/g,linkRegexp=/\b((?:https?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/g,minLinkRegexp=/(?:^|[\s\(\[])([^\(\[@\s]+\.(?:com|org|net))/gi;self.parseText=function parseTextFn(itemText,prevDate,isUpdate,contactsList){var hasDiffParse=!1,parsedText=itemText,contacts=[];if(0===itemText.length)return{parsedText:void 0};var startText=itemText,hasStyle=!1,oldLength=itemText.length;itemText=escape(itemText),oldLength!==itemText.length&&(hasStyle=!0);var match,startTag,endTag,dates=[];if(contactsList&&contactsList.___info___.count>0&&itemText.indexOf(ContactPrefix)>=0){for(var words=itemText.split(" "),lineIndex=0,i=0;i<words.length;i++){if(0===words[i].indexOf(ContactPrefix)){for(var matchedName=void 0,combined=words[i].substring(1),u=1;4>u;u++){var compStr=trimPunc(combined);if(""===contactsList[compStr]&&(matchedName=compStr),!(i+u<words.length))break;combined+=" "+words[i+u]}matchedName&&contacts.push({name:matchedName,lineIndex:lineIndex})}lineIndex+=words[i].length+1}if(contacts.length>0)for(var i=contacts.length-1;i>=0;i--)itemText=itemText.insertTag(contacts[i].lineIndex,'<p class="contact">',contacts[i].name.length+1,"</p>"),hasStyle=!0}for(tagRegexp.lastIndex=0;match=tagRegexp.exec(itemText);){var matchIndex=match.index+match[1].length-1,matchLength=match[2].length+1;":"==match[2].charAt(match[2].length-1)&&matchLength--,itemText=itemText.insertTag(matchIndex,'<p class="tag" title="'+cmdChar+'+click to search">',matchLength,"</p>"),hasStyle=!0}for(dateRegexp.lastIndex=0;match=dateRegexp.exec(itemText);){for(var prefixLength=match[0].indexOf(DatePrefix),dateString,puncFound=!1,i=1;i<match.length&&match[i];++i)if(puncFound)match[i]=void 0;else{var lastChar=match[i][match[i].length-1];(":"===lastChar||","===lastChar||"."===lastChar)&&(match[i]=match[i].slice(0,-1),puncFound=!0)}dateString=match[1]+(match[2]?match[2]:"")+(match[3]?match[3]:"");var dt=Date.parse(dateString);if(!dt&&match[3]&&(dateString=match[1]+(match[2]?match[2]:""),dt=Date.parse(dateString)),!dt&&match[2]&&(dateString=match[1],dt=Date.parse(dateString)),dt){var newDateInfo=self.computeDateInfo(prevDate,isUpdate,dt,dateString);if(newDateInfo.replacedDate){dateLength=newDateInfo.text.length+1;var dateTextOffset=match.index+prefixLength+1;
itemText=itemText.substr(0,dateTextOffset)+newDateInfo.text+itemText.substr(dateTextOffset+dateString.length),itemText=itemText.insertTag(match.index+prefixLength,'<p class="date">',dateLength,"</p>");var parsedDateIndex=parsedText.indexOf(dateString);parsedText=parsedText.substr(0,parsedDateIndex)+newDateInfo.text+parsedText.substr(parsedDateIndex+dateString.length),hasDiffParse=!0,dates.push({date:newDateInfo.date,text:newDateInfo.text,explicitTime:dt._explicitTime})}else dateLength=dateString.length+1,itemText=itemText.insertTag(match.index+prefixLength,'<p class="date">',dateLength,"</p>"),dates.push({date:newDateInfo.date,text:dateString,explicitTime:dt._explicitTime});hasStyle=!0;break}}if(linkRegexp.lastIndex=0,match=linkRegexp.exec(itemText)){var linkHref=match[0].startsWith("http")?match[0]:"http://"+match[0];startTag="<a target='_blank' href='"+linkHref+"' title='"+cmdChar+"+click to navigate'>",endTag="</a>",itemText=itemText.insertTag(match.index,startTag,match[0].length,endTag),hasStyle=!0}else if(minLinkRegexp.lastIndex=0,match=minLinkRegexp.exec(itemText)){var prefixLength=match[0].length-match[1].length,linkHref=match[1].startsWith("http")?match[1]:"http://"+match[1];startTag="<a target='_blank' href='"+linkHref+"' title='"+cmdChar+"+click to navigate'>",endTag="</a>",itemText=itemText.insertTag(match.index+prefixLength,startTag,match[1].length,endTag),hasStyle=!0}return{text:startText,styledText:itemText,parsedText:hasDiffParse?parsedText:void 0,dates:dates,hasStyle:hasStyle,numContacts:contacts.length}},self.computeDateInfo=function computeDateInfoFn(prevDate,isUpdate,dt,dateString){function getSoftText(date){var DAY_LENGTH=864e5,diff=new Date(date).clearTime()-(new Date).clearTime();return 0>diff?diff>=-DAY_LENGTH?"yesterday":date.toString("M/d"):DAY_LENGTH>=diff&&date.isToday()?"today":2*DAY_LENGTH>=diff?"tomorrow":void 0}var finalString=dateString,replacedDate=!1,newDate;if(isUpdate)newDate=dt;else if(newDate=new Date(prevDate),void 0!==prevDate&&dt.getTime()!==prevDate){if(softDates.indexOf(dateString.toUpperCase())>=0){var explicitTime=dt._explicitTime;newDate=new Date(prevDate);var transString=getSoftText(newDate);transString&&(finalString=transString,explicitTime&&(finalString+=" "+newDate.toString("h:mmtt")),replacedDate=!0)}}else void 0===prevDate&&(newDate=dt);return{text:finalString,date:newDate,replacedDate:replacedDate}}}function parseWorkerWrapper(){DuchessHelpersWrapper&&!this.helperLibLoaded&&DuchessHelpersWrapper(this.DuchessHelpers=this.DuchessHelpers||{}),dateWrapper&&!this.dateLibLoaded&&dateWrapper(),log=postMessage;var contacts;onmessage=function(e){if(e.data.contacts&&(contacts=e.data.contacts),e.data.items){for(var startTime=Date.now(),results=new Array(e.data.items.length),i=0;i<e.data.items.length;i++){var entry=e.data.items[i];results[i]=DuchessHelpers.parseText(entry.text,entry.prevDate,entry.isUpdate,contacts)}postMessage({id:e.data.id,styles:results,done:!0,start:startTime,end:Date.now()})}else postMessage({id:e.data.id,done:!1,msg:"ERROR: No items passed to the worker"})}}function makeLogger(i){window.log[i]=function(){window.DEBUG&&log.apply(console,arguments)}}function GoogleApiLoaded(){if(!gapiCalled){if(gapiCalled=!0,gapi.auth.init(),window.location.hash.indexOf("offline=true")>=0||window.location.hash.indexOf("offline%22:true")>=0||window.location.hash.indexOf('offline":true')>=0||window.location.hash.indexOf("demo=true")>=0)return void log("%cOffline","color: pink");gapi.client.setApiKey(window.gapiKey),gapi.client.load("drive","v2",function(){}),gapi.load("drive-realtime",function(){if(gapi&&gapi.drive&&gapi.drive.realtime)require(["globals","goog"],function(g,goog){goog.loadClientDefaultFile(),g.removeDOM("blockedError")});else{var loadArgs=arguments;require(["globals","platform"],function(g,platform){var errorString;errorString=gapi?gapi.drive?gapi.drive.realtime?"all exist":"gapi.drive.realtime":"gapi.drive":"gapi",gapiCalled=!1,gapiLoadError=!0,g.reportError(new Error("Drive returned load, but unable to load "+errorString));var msgEle=document.getElementById("blockedMessage");msgEle.innerText=platform.app?"There was an error loading the Google APIs, "+platform.actionVerb()+" to try again.":"You are running an extension that blocked drive.google.com from loading, Moo.do requires access to function correctly.",document.getElementById("blockedError").classList.remove("none"),g.vmMain&&g.vmMain.gdriveStatus(DriveStatus.Offline)})}}),require(["globals","util","platform","goog","VMSetup"],function(g,util,platform,goog,VMSetup){var setTokenFromHash=!1;(!platform.ie||platform.mobile)&&(setTokenFromHash=goog.checkTokenInHash());var doLogin=setTokenFromHash||util.hasURLParam("login","true")||g.getLoginState()==LoginState.LOGGED_IN;goog.runAuthenticate(goog.requestScopes,!0,!1,function(token){util.removeURLParam("login",!0),token&&!token.error?(doLogin&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),goog.loadClientDefaultFile(),g.openMainPage()),goog.ensureRequiredScopesAreRequested()):goog.requiredScopes!==goog.requestScopes?(g.settings.reset(Settings.authScopes),goog.runAuthenticate(goog.requiredScopes,!0,!1,function(token2){token2&&!token2.error?doLogin&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),goog.loadClientDefaultFile(),g.openMainPage()):(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_OUT):g.setLoginState(LoginState.LOGGED_OUT),g.openSetupPage())})):(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_OUT):g.setLoginState(LoginState.LOGGED_OUT),g.openSetupPage())})})}}var requirejs,require,define;!function(undef){function hasProp(obj,prop){return hasOwn.call(obj,prop)}function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&"."===name.charAt(0))if(baseName){for(baseParts=baseParts.slice(0,baseParts.length-1),name=baseParts.concat(name.split("/")),i=0;i<name.length;i+=1)if(part=name[i],"."===part)name.splice(i,1),i-=1;else if(".."===part){if(1===i&&(".."===name[2]||".."===name[0]))break;i>0&&(name.splice(i-1,2),i-=2)}name=name.join("/")}else 0===name.indexOf("./")&&(name=name.substring(2));if((baseParts||starMap)&&map){for(nameParts=name.split("/"),i=nameParts.length;i>0;i-=1){if(nameSegment=nameParts.slice(0,i).join("/"),baseParts)for(j=baseParts.length;j>0;j-=1)if(mapValue=map[baseParts.slice(0,j).join("/")],mapValue&&(mapValue=mapValue[nameSegment])){foundMap=mapValue,foundI=i;break}if(foundMap)break;!foundStarMap&&starMap&&starMap[nameSegment]&&(foundStarMap=starMap[nameSegment],starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return name}function makeRequire(relName,forceSync){return function(){return req.apply(undef,aps.call(arguments,0).concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(hasProp(waiting,name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!hasProp(defined,name)&&!hasProp(defining,name))throw new Error("No "+name);return defined[name]}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;return index>-1&&(prefix=name.substring(0,index),name=name.substring(index+1,name.length)),[prefix,name]}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var main,req,makeMap,handlers,defined={},waiting={},config={},defining={},hasOwn=Object.prototype.hasOwnProperty,aps=[].slice;makeMap=function(name,relName){var plugin,parts=splitPrefix(name),prefix=parts[0];return name=parts[1],prefix&&(prefix=normalize(prefix,relName),plugin=callDep(prefix)),prefix?name=plugin&&plugin.normalize?plugin.normalize(name,makeNormalize(relName)):normalize(name,relName):(name=normalize(name,relName),parts=splitPrefix(name),prefix=parts[0],name=parts[1],prefix&&(plugin=callDep(prefix))),{f:prefix?prefix+"!"+name:name,n:name,pr:prefix,p:plugin}},handlers={require:function(name){return makeRequire(name)},exports:function(name){var e=defined[name];return"undefined"!=typeof e?e:defined[name]={}},module:function(name){return{id:name,uri:"",exports:defined[name],config:makeConfig(name)}}},main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,args=[],usingExports;if(relName=relName||name,"function"==typeof callback){for(deps=!deps.length&&callback.length?["require","exports","module"]:deps,i=0;i<deps.length;i+=1)if(map=makeMap(deps[i],relName),depName=map.f,"require"===depName)args[i]=handlers.require(name);else if("exports"===depName)args[i]=handlers.exports(name),usingExports=!0;else if("module"===depName)cjsModule=args[i]=handlers.module(name);else if(hasProp(defined,depName)||hasProp(waiting,depName)||hasProp(defining,depName))args[i]=callDep(depName);else{if(!map.p)throw new Error(name+" missing "+depName);map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName]}ret=callback.apply(defined[name],args),name&&(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name]?defined[name]=cjsModule.exports:ret===undef&&usingExports||(defined[name]=ret))}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync,alt){return"string"==typeof deps?handlers[deps]?handlers[deps](callback):callDep(makeMap(deps,callback).f):(deps.splice||(config=deps,callback.splice?(deps=callback,callback=relName,relName=null):deps=undef),callback=callback||function(){},"function"==typeof relName&&(relName=forceSync,forceSync=alt),forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},4),req)},req.config=function(cfg){return config=cfg,config.deps&&req(config.deps,config.callback),req},define=function(name,deps,callback){deps.splice||(callback=deps,deps=[]),hasProp(defined,name)||hasProp(waiting,name)||(waiting[name]=[name,deps,callback])},define.amd={jQuery:!0}}(),define("lib/almond",function(){}),function(){!function(q){var w=this||(0,eval)("this"),t=w.document,G=w.navigator,s=w.jQuery,A=w.JSON;!function(q){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?q(module.exports||exports):"function"==typeof define&&define.amd?define("ko",["exports"],q):q(w.ko={})}(function(B){function F(b,c,d,f){a.d[b]={init:function(b){return a.a.f.set(b,H,{}),{controlsDescendantBindings:!0}},update:function(b,e,k,h,m){k=a.a.f.get(b,H),e=a.a.c(e()),h=!d!=!e;var l=!k.gb;(l||c||h!==k.wb)&&(l&&(k.gb=a.a.Pa(a.e.childNodes(b),!0)),h?(l||a.e.S(b,a.a.Pa(k.gb)),a.Ka(f?f(m,e):m,b)):a.e.ca(b),k.wb=h)}},a.g.V[b]=!1,a.e.N[b]=!0}function I(b,c,d){d&&c!==a.i.n(b)&&a.i.X(b,c),c!==a.i.n(b)&&a.o.P(a.a.Ha,null,[b,"change"])}var a="undefined"!=typeof B?B:{};a.b=function(b,c){for(var d=b.split("."),f=a,g=0;g<d.length-1;g++)f=f[d[g]];f[d[d.length-1]]=c},a.q=function(a,c,d){a[c]=d},a.version="2.3.0",a.b("version",a.version),a.a=function(){function b(a,b){for(var e in a)a.hasOwnProperty(e)&&b(e,a[e])}function c(b,e){if("input"!==a.a.u(b)||!b.type||"click"!=e.toLowerCase())return!1;var c=b.type;return"checkbox"==c||"radio"==c}var d={},f={};d[G&&/Firefox\/2/i.test(G.userAgent)?"KeyboardEvent":"UIEvents"]=["keyup","keydown","keypress"],d.MouseEvents="click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave".split(" "),b(d,function(a,b){if(b.length)for(var e=0,c=b.length;c>e;e++)f[b[e]]=a});var g={propertychange:!0},e=t&&function(){for(var a=3,b=t.createElement("div"),e=b.getElementsByTagName("i");b.innerHTML="<!--[if gt IE "+ ++a+"]><i></i><![endif]-->",e[0];);return a>4?a:q}(),k={__proto__:[]}instanceof Array;return{Ua:["authenticity_token",/^__RequestVerificationToken(_.*)?$/],r:function(a,b){for(var e=0,c=a.length;c>e;e++)b(a[e])},k:function(a,b){if("function"==typeof Array.prototype.indexOf)return Array.prototype.indexOf.call(a,b);for(var e=0,c=a.length;c>e;e++)if(a[e]===b)return e;return-1},Ma:function(a,b,e){for(var c=0,d=a.length;d>c;c++)if(b.call(e,a[c]))return a[c];return null},la:function(b,e){var c=a.a.k(b,e);c>=0&&b.splice(c,1)},Na:function(b){b=b||[];for(var e=[],c=0,d=b.length;d>c;c++)0>a.a.k(e,b[c])&&e.push(b[c]);return e},$:function(a,b){a=a||[];for(var e=[],c=0,d=a.length;d>c;c++)e.push(b(a[c]));return e},Z:function(a,b){a=a||[];for(var e=[],c=0,d=a.length;d>c;c++)b(a[c])&&e.push(a[c]);return e},U:function(a,b){if(b instanceof Array)a.push.apply(a,b);else for(var e=0,c=b.length;c>e;e++)a.push(b[e]);return a},ka:function(b,e,c){var d=b.indexOf?b.indexOf(e):a.a.k(b,e);0>d?c&&b.push(e):c||b.splice(d,1)},extend:function(a,b){if(b)for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);return a},w:b,pa:function(b){for(;b.firstChild;)a.removeNode(b.firstChild)},Ob:function(b){b=a.a.Q(b);for(var e=t.createElement("div"),c=0,d=b.length;d>c;c++)e.appendChild(a.J(b[c]));return e},Pa:function(b,e){for(var c=0,d=b.length,g=[];d>c;c++){var f=b[c].cloneNode(!0);g.push(e?a.J(f):f)}return g},S:function(b,e){if(a.a.pa(b),e)for(var c=0,d=e.length;d>c;c++)b.appendChild(e[c])},fb:function(b,e){var c=b.nodeType?[b]:b;if(0<c.length){for(var d=c[0],g=d.parentNode,f=0,k=e.length;k>f;f++)g.insertBefore(e[f],d);for(f=0,k=c.length;k>f;f++)a.removeNode(c[f])}},ib:function(a,b){7>e?a.setAttribute("selected",b):a.selected=b},H:function(a){return null===a||a===q?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")},Yb:function(b,e){for(var c=[],d=(b||"").split(e),g=0,f=d.length;f>g;g++){var k=a.a.H(d[g]);""!==k&&c.push(k)}return c},Vb:function(a,b){return a=a||"",b.length>a.length?!1:a.substring(0,b.length)===b},zb:function(a,b){if(b.compareDocumentPosition)return 16==(16&b.compareDocumentPosition(a));for(;null!=a;){if(a==b)return!0;a=a.parentNode}return!1},ba:function(b){return a.a.zb(b,b.ownerDocument)},qb:function(b){return!!a.a.Ma(b,a.a.ba)},u:function(a){return a&&a.tagName&&a.tagName.toLowerCase()},p:function(b,d,f){var k=e&&g[d];if(k||"undefined"==typeof s)if(k||"function"!=typeof b.addEventListener){if("undefined"==typeof b.attachEvent)throw Error("Browser doesn't support addEventListener or attachEvent");var p=function(a){f.call(b,a)},r="on"+d;b.attachEvent(r,p),a.a.F.ja(b,function(){b.detachEvent(r,p)})}else b.addEventListener(d,f,!1);else{if(c(b,d)){var x=f;f=function(a,b){var e=this.checked;b&&(this.checked=!0!==b.tb),x.call(this,a),this.checked=e}}s(b).bind(d,f)}},Ha:function(a,b){if(!a||!a.nodeType)throw Error("element must be a DOM node when calling triggerEvent");if("undefined"!=typeof s){var e=[];c(a,b)&&e.push({tb:a.checked}),s(a).trigger(b,e)}else if("function"==typeof t.createEvent){if("function"!=typeof a.dispatchEvent)throw Error("The supplied element doesn't support dispatchEvent");e=t.createEvent(f[b]||"HTMLEvents"),e.initEvent(b,!0,!0,w,0,0,0,0,0,!1,!1,!1,!1,0,a),a.dispatchEvent(e)}else{if("undefined"==typeof a.fireEvent)throw Error("Browser doesn't support triggering events");c(a,b)&&(a.checked=!0!==a.checked),a.fireEvent("on"+b)}},c:function(b){return a.W(b)?b():b},za:function(b){return a.W(b)?b.t():b},ha:function(b,e,c){if(e){var d=/\S+/g,g=b.className.match(d)||[];a.a.r(e.match(d),function(b){a.a.ka(g,b,c)}),b.className=g.join(" ")}},jb:function(b,e){var c=a.a.c(e);(null===c||c===q)&&(c="");var d=a.e.firstChild(b);!d||3!=d.nodeType||a.e.nextSibling(d)?a.e.S(b,[t.createTextNode(c)]):d.data=c,a.a.Cb(b)},hb:function(a,b){if(a.name=b,7>=e)try{a.mergeAttributes(t.createElement("<input name='"+a.name+"'/>"),!1)}catch(c){}},Cb:function(a){e>=9&&(a=1==a.nodeType?a:a.parentNode,a.style&&(a.style.zoom=a.style.zoom))},Ab:function(a){if(e){var b=a.style.width;a.style.width=0,a.style.width=b}},Sb:function(b,e){b=a.a.c(b),e=a.a.c(e);for(var c=[],d=b;e>=d;d++)c.push(d);return c},Q:function(a){for(var b=[],e=0,c=a.length;c>e;e++)b.push(a[e]);return b},Wb:6===e,Xb:7===e,da:e,Va:function(b,e){for(var c=a.a.Q(b.getElementsByTagName("input")).concat(a.a.Q(b.getElementsByTagName("textarea"))),d="string"==typeof e?function(a){return a.name===e}:function(a){return e.test(a.name)},g=[],f=c.length-1;f>=0;f--)d(c[f])&&g.push(c[f]);return g},Pb:function(b){return"string"==typeof b&&(b=a.a.H(b))?A&&A.parse?A.parse(b):new Function("return "+b)():null},Da:function(b,e,c){if(!A||!A.stringify)throw Error("Cannot find JSON.stringify(). Some browsers (e.g., IE < 8) don't support it natively, but you can overcome this by adding a script reference to json2.js, downloadable from http://www.json.org/json2.js");return A.stringify(a.a.c(b),e,c)},Qb:function(e,c,d){d=d||{};var g=d.params||{},f=d.includeFields||this.Ua,k=e;if("object"==typeof e&&"form"===a.a.u(e))for(var k=e.action,x=f.length-1;x>=0;x--)for(var E=a.a.Va(e,f[x]),q=E.length-1;q>=0;q--)g[E[q].name]=E[q].value;c=a.a.c(c);var u=t.createElement("form");u.style.display="none",u.action=k,u.method="post";for(var y in c)e=t.createElement("input"),e.name=y,e.value=a.a.Da(a.a.c(c[y])),u.appendChild(e);b(g,function(a,b){var e=t.createElement("input");e.name=a,e.value=b,u.appendChild(e)}),t.body.appendChild(u),d.submitter?d.submitter(u):u.submit(),setTimeout(function(){u.parentNode.removeChild(u)},0)},I:function(a,b){return k?(a.__proto__=b,!0):!1}}}(),a.b("utils",a.a),a.b("utils.arrayForEach",a.a.r),a.b("utils.arrayFirst",a.a.Ma),a.b("utils.arrayFilter",a.a.Z),a.b("utils.arrayGetDistinctValues",a.a.Na),a.b("utils.arrayIndexOf",a.a.k),a.b("utils.arrayMap",a.a.$),a.b("utils.arrayPushAll",a.a.U),a.b("utils.arrayRemoveItem",a.a.la),a.b("utils.extend",a.a.extend),a.b("utils.fieldsIncludedWithJsonPost",a.a.Ua),a.b("utils.getFormFields",a.a.Va),a.b("utils.peekObservable",a.a.za),a.b("utils.postJson",a.a.Qb),a.b("utils.parseJson",a.a.Pb),a.b("utils.registerEventHandler",a.a.p),a.b("utils.stringifyJson",a.a.Da),a.b("utils.range",a.a.Sb),a.b("utils.toggleDomNodeCssClass",a.a.ha),a.b("utils.triggerEvent",a.a.Ha),a.b("utils.unwrapObservable",a.a.c),a.b("utils.objectForEach",a.a.w),a.b("utils.addOrRemoveItem",a.a.ka),a.b("unwrap",a.a.c),Function.prototype.bind||(Function.prototype.bind=function(a){var c=this,d=Array.prototype.slice.call(arguments);return a=d.shift(),function(){return c.apply(a,d.concat(Array.prototype.slice.call(arguments)))}}),a.a.f=new function(){var b=0,c="__ko__"+(new Date).getTime(),d={};return{get:function(b,c){var e=a.a.f.qa(b,!1);return e===q?q:e[c]},set:function(b,c,e){(e!==q||a.a.f.qa(b,!1)!==q)&&(a.a.f.qa(b,!0)[c]=e)},qa:function(a,g){var e=a[c];if(!e||"null"===e||!d[e]){if(!g)return q;e=a[c]="ko"+b++,d[e]={}}return d[e]},clear:function(a){var b=a[c];return b?(delete d[b],a[c]=null,!0):!1}}},a.b("utils.domData",a.a.f),a.b("utils.domData.clear",a.a.f.clear),a.a.F=new function(){function b(b,c){var g=a.a.f.get(b,d);return g===q&&c&&(g=[],a.a.f.set(b,d,g)),g}function c(e){var d=b(e,!1);if(d)for(var d=d.slice(0),f=0;f<d.length;f++)d[f](e);if(a.a.f.clear(e),"function"==typeof s&&"function"==typeof s.cleanData&&s.cleanData([e]),g[e.nodeType])for(d=e.firstChild;e=d;)d=e.nextSibling,8===e.nodeType&&c(e)}var d="__ko_domNodeDisposal__"+(new Date).getTime(),f={1:!0,8:!0,9:!0},g={1:!0,9:!0};return{ja:function(a,c){if("function"!=typeof c)throw Error("Callback must be a function");b(a,!0).push(c)},eb:function(e,c){var g=b(e,!1);g&&(a.a.la(g,c),0==g.length&&a.a.f.set(e,d,q))},J:function(b){if(f[b.nodeType]&&(c(b),g[b.nodeType])){var d=[];a.a.U(d,b.getElementsByTagName("*"));for(var h=0,m=d.length;m>h;h++)c(d[h])}return b},removeNode:function(b){a.J(b),b.parentNode&&b.parentNode.removeChild(b)}}},a.J=a.a.F.J,a.removeNode=a.a.F.removeNode,a.b("cleanNode",a.J),a.b("removeNode",a.removeNode),a.b("utils.domNodeDisposal",a.a.F),a.b("utils.domNodeDisposal.addDisposeCallback",a.a.F.ja),a.b("utils.domNodeDisposal.removeDisposeCallback",a.a.F.eb),function(){a.a.ya=function(b){var c;if("undefined"!=typeof s){if(s.parseHTML)c=s.parseHTML(b)||[];else if((c=s.clean([b]))&&c[0]){for(b=c[0];b.parentNode&&11!==b.parentNode.nodeType;)b=b.parentNode;b.parentNode&&b.parentNode.removeChild(b)}}else{var d=a.a.H(b).toLowerCase();for(c=t.createElement("div"),d=d.match(/^<(thead|tbody|tfoot)/)&&[1,"<table>","</table>"]||!d.indexOf("<tr")&&[2,"<table><tbody>","</tbody></table>"]||(!d.indexOf("<td")||!d.indexOf("<th"))&&[3,"<table><tbody><tr>","</tr></tbody></table>"]||[0,"",""],b="ignored<div>"+d[1]+b+d[2]+"</div>","function"==typeof w.innerShiv?c.appendChild(w.innerShiv(b)):c.innerHTML=b;d[0]--;)c=c.lastChild;c=a.a.Q(c.lastChild.childNodes)}return c},a.a.ga=function(b,c){if(a.a.pa(b),c=a.a.c(c),null!==c&&c!==q)if("string"!=typeof c&&(c=c.toString()),"undefined"!=typeof s)s(b).html(c);else for(var d=a.a.ya(c),f=0;f<d.length;f++)b.appendChild(d[f])}}(),a.b("utils.parseHtmlFragment",a.a.ya),a.b("utils.setHtml",a.a.ga),a.s=function(){function b(c,f){if(c)if(8==c.nodeType){var g=a.s.ab(c.nodeValue);null!=g&&f.push({yb:c,Mb:g})}else if(1==c.nodeType)for(var g=0,e=c.childNodes,k=e.length;k>g;g++)b(e[g],f)}var c={};return{wa:function(a){if("function"!=typeof a)throw Error("You can only pass a function to ko.memoization.memoize()");var b=(4294967296*(1+Math.random())|0).toString(16).substring(1)+(4294967296*(1+Math.random())|0).toString(16).substring(1);return c[b]=a,"<!--[ko_memo:"+b+"]-->"},nb:function(a,b){var g=c[a];if(g===q)throw Error("Couldn't find any memo with ID "+a+". Perhaps it's already been unmemoized.");try{return g.apply(null,b||[]),!0}finally{delete c[a]}},ob:function(c,f){var g=[];b(c,g);for(var e=0,k=g.length;k>e;e++){var h=g[e].yb,m=[h];f&&a.a.U(m,f),a.s.nb(g[e].Mb,m),h.nodeValue="",h.parentNode&&h.parentNode.removeChild(h)}},ab:function(a){return(a=a.match(/^\[ko_memo\:(.*?)\]$/))?a[1]:null}}}(),a.b("memoization",a.s),a.b("memoization.memoize",a.s.wa),a.b("memoization.unmemoize",a.s.nb),a.b("memoization.parseMemoText",a.s.ab),a.b("memoization.unmemoizeDomNodeAndDescendants",a.s.ob),a.Ta={throttle:function(b,c){b.throttleEvaluation=c;var d=null;return a.h({read:b,write:function(a){clearTimeout(d),d=setTimeout(function(){b(a)},c)}})},notify:function(b,c){return b.equalityComparer="always"==c?function(){return!1}:a.l.fn.equalityComparer,b}},a.b("extenders",a.Ta),a.lb=function(b,c,d){this.target=b,this.ma=c,this.xb=d,a.q(this,"dispose",this.D)},a.lb.prototype.D=function(){this.Jb=!0,this.xb()},a.A=function(){this.B={},a.a.I(this,a.A.fn)||a.a.extend(this,a.A.fn),a.q(this,"subscribe",this.Ea),a.q(this,"extend",this.extend),a.q(this,"getSubscriptionsCount",this.Eb)},a.A.fn={Ea:function(b,c,d){d=d||"change";var f=new a.lb(this,c?b.bind(c):b,function(){a.a.la(this.B[d],f)}.bind(this));return this.B[d]||(this.B[d]=[]),this.B[d].push(f),f},notifySubscribers:function(b,c){if(c=c||"change",this.Fb(c))try{a.o.Oa();for(var d=this.B[c].slice(0),f=0,g;g=d[f];++f)g&&!0!==g.Jb&&g.ma(b)}finally{a.o.end()}},Fb:function(a){return this.B[a]&&this.B[a].length},Eb:function(){var b=0;return a.a.w(this.B,function(a,d){b+=d.length}),b},extend:function(b){var c=this;return b&&a.a.w(b,function(b,f){var g=a.Ta[b];"function"==typeof g&&(c=g(c,f))}),c}},a.a.I(a.A.fn,Function.prototype),a.Xa=function(a){return null!=a&&"function"==typeof a.Ea&&"function"==typeof a.notifySubscribers},a.b("subscribable",a.A),a.b("isSubscribable",a.Xa),a.o=function(){var b=[];return{Oa:function(a){b.push(a&&{ma:a,Sa:[]})},end:function(){b.pop()},cb:function(c){if(!a.Xa(c))throw Error("Only subscribable things can act as dependencies");if(0<b.length){var d=b[b.length-1];!d||0<=a.a.k(d.Sa,c)||(d.Sa.push(c),d.ma(c))}},P:function(a,d,f){try{return b.push(null),a.apply(d,f||[])}finally{b.pop()}}}}();var K={undefined:!0,"boolean":!0,number:!0,string:!0};a.l=function(b){function c(){return 0<arguments.length?(c.equalityComparer&&c.equalityComparer(d,arguments[0])||(c.M(),d=arguments[0],c.L()),this):(a.o.cb(c),d)}var d=b;return a.A.call(c),c.t=function(){return d},c.L=function(){c.notifySubscribers(d)},c.M=function(){c.notifySubscribers(d,"beforeChange")},a.a.I(c,a.l.fn)||a.a.extend(c,a.l.fn),a.q(c,"peek",c.t),a.q(c,"valueHasMutated",c.L),a.q(c,"valueWillMutate",c.M),c},a.l.fn={equalityComparer:function(a,c){return null===a||typeof a in K?a===c:!1}};var z=a.l.Rb="__ko_proto__";a.l.fn[z]=a.l,a.a.I(a.l.fn,a.A.fn),a.ra=function(b,c){return null===b||b===q||b[z]===q?!1:b[z]===c?!0:a.ra(b[z],c)},a.W=function(b){return a.ra(b,a.l)},a.Ya=function(b){return"function"==typeof b&&b[z]===a.l||"function"==typeof b&&b[z]===a.h&&b.Gb?!0:!1},a.b("observable",a.l),a.b("isObservable",a.W),a.b("isWriteableObservable",a.Ya),a.K=function(b){if(b=b||[],"object"!=typeof b||!("length"in b))throw Error("The argument passed when initializing an observable array must be an array, or null, or undefined.");return b=a.l(b),a.a.I(b,a.K.fn)||a.a.extend(b,a.K.fn),b},a.K.fn={remove:function(a){for(var c=this.t(),d=[],f="function"==typeof a?a:function(e){return e===a},g=0;g<c.length;g++){var e=c[g];f(e)&&(0===d.length&&this.M(),d.push(e),c.splice(g,1),g--)}return d.length&&this.L(),d},removeAll:function(b){if(b===q){var c=this.t(),d=c.slice(0);return this.M(),c.splice(0,c.length),this.L(),d}return b?this.remove(function(c){return 0<=a.a.k(b,c)}):[]},destroy:function(a){var c=this.t(),d="function"==typeof a?a:function(c){return c===a};this.M();for(var f=c.length-1;f>=0;f--)d(c[f])&&(c[f]._destroy=!0);this.L()},destroyAll:function(b){return b===q?this.destroy(function(){return!0}):b?this.destroy(function(c){return 0<=a.a.k(b,c)}):[]},indexOf:function(b){var c=this();return a.a.k(c,b)},replace:function(a,c){var d=this.indexOf(a);d>=0&&(this.M(),this.t()[d]=c,this.L())}},a.a.r("pop push reverse shift sort splice unshift".split(" "),function(b){a.K.fn[b]=function(){var a=this.t();return this.M(),a=a[b].apply(a,arguments),this.L(),a}}),a.a.r(["slice"],function(b){a.K.fn[b]=function(){var a=this();return a[b].apply(a,arguments)}}),a.a.I(a.K.fn,a.l.fn),a.b("observableArray",a.K),a.h=function(b,c,d){function f(){a.a.r(u,function(a){a.D()}),u=[]}function g(){var a=k.throttleEvaluation;a&&a>=0?(clearTimeout(y),y=setTimeout(e,a)):e()}function e(){if(!n)if(l&&E())C();else{n=!0;try{var b=a.a.$(u,function(a){return a.target});a.o.Oa(function(e){var c;0<=(c=a.a.k(b,e))?b[c]=q:u.push(e.Ea(g))});for(var e=c?p.call(c):p(),d=b.length-1;d>=0;d--)b[d]&&u.splice(d,1)[0].D();l=!0,k.notifySubscribers(m,"beforeChange"),m=e,k.notifySubscribers(m)}finally{a.o.end(),n=!1}u.length||C()}}function k(){if(0<arguments.length){if("function"!=typeof r)throw Error("Cannot write a value to a ko.computed unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters.");return r.apply(c,arguments),this}return l||e(),a.o.cb(k),m}function h(){return!l||0<u.length}var m,l=!1,n=!1,p=b;if(p&&"object"==typeof p?(d=p,p=d.read):(d=d||{},p||(p=d.read)),"function"!=typeof p)throw Error("Pass a function that returns the value of the ko.computed");var r=d.write,x=d.disposeWhenNodeIsRemoved||d.aa||null,E=d.disposeWhen||d.Ra||function(){return!1},C=f,u=[],y=null;if(c||(c=d.owner),k.t=function(){return l||e(),m},k.Db=function(){return u.length},k.Gb="function"==typeof d.write,k.D=function(){C()},k.ua=h,a.A.call(k),a.a.I(k,a.h.fn)||a.a.extend(k,a.h.fn),a.q(k,"peek",k.t),a.q(k,"dispose",k.D),a.q(k,"isActive",k.ua),a.q(k,"getDependenciesCount",k.Db),!0!==d.deferEvaluation&&e(),x&&h()){C=function(){a.a.F.eb(x,C),f()},a.a.F.ja(x,C);var s=E,E=function(){return!a.a.ba(x)||s()}}return k},a.Ib=function(b){return a.ra(b,a.h)},B=a.l.Rb,a.h[B]=a.l,a.h.fn={},a.h.fn[B]=a.h,a.a.I(a.h.fn,a.A.fn),a.b("dependentObservable",a.h),a.b("computed",a.h),a.b("isComputed",a.Ib),function(){function b(a,g,e){if(e=e||new d,a=g(a),"object"!=typeof a||null===a||a===q||a instanceof Date||a instanceof String||a instanceof Number||a instanceof Boolean)return a;var k=a instanceof Array?[]:{};return e.save(a,k),c(a,function(c){var d=g(a[c]);switch(typeof d){case"boolean":case"number":case"string":case"function":k[c]=d;break;case"object":case"undefined":var l=e.get(d);k[c]=l!==q?l:b(d,g,e)}}),k}function c(a,b){if(a instanceof Array){for(var e=0;e<a.length;e++)b(e);"function"==typeof a.toJSON&&b("toJSON")}else for(e in a)b(e)}function d(){this.keys=[],this.Ia=[]}a.mb=function(c){if(0==arguments.length)throw Error("When calling ko.toJS, pass the object you want to convert.");return b(c,function(b){for(var e=0;a.W(b)&&10>e;e++)b=b();return b})},a.toJSON=function(b,c,e){return b=a.mb(b),a.a.Da(b,c,e)},d.prototype={save:function(b,c){var e=a.a.k(this.keys,b);e>=0?this.Ia[e]=c:(this.keys.push(b),this.Ia.push(c))},get:function(b){return b=a.a.k(this.keys,b),b>=0?this.Ia[b]:q}}}(),a.b("toJS",a.mb),a.b("toJSON",a.toJSON),function(){a.i={n:function(b){switch(a.a.u(b)){case"option":return!0===b.__ko__hasDomDataOptionValue__?a.a.f.get(b,a.d.options.xa):7>=a.a.da?b.getAttributeNode("value")&&b.getAttributeNode("value").specified?b.value:b.text:b.value;case"select":return 0<=b.selectedIndex?a.i.n(b.options[b.selectedIndex]):q;default:return b.value}},X:function(b,c){switch(a.a.u(b)){case"option":switch(typeof c){case"string":a.a.f.set(b,a.d.options.xa,q),"__ko__hasDomDataOptionValue__"in b&&delete b.__ko__hasDomDataOptionValue__,b.value=c;break;default:a.a.f.set(b,a.d.options.xa,c),b.__ko__hasDomDataOptionValue__=!0,b.value="number"==typeof c?c:""}break;case"select":""===c&&(c=q),(null===c||c===q)&&(b.selectedIndex=-1);for(var d=b.options.length-1;d>=0;d--)if(a.i.n(b.options[d])==c){b.selectedIndex=d;break}1<b.size||-1!==b.selectedIndex||(b.selectedIndex=0);break;default:(null===c||c===q)&&(c=""),b.value=c}}}}(),a.b("selectExtensions",a.i),a.b("selectExtensions.readValue",a.i.n),a.b("selectExtensions.writeValue",a.i.X),a.g=function(){function b(a,b){for(var d=null;a!=d;)d=a,a=a.replace(c,function(a,c){return b[c]});return a}var c=/\@ko_token_(\d+)\@/g,d=["true","false","null","undefined"],f=/^(?:[$_a-z][$\w]*|(.+)(\.\s*[$_a-z][$\w]*|\[.+\]))$/i;return{V:[],ea:function(c){var e=a.a.H(c);if(3>e.length)return[];"{"===e.charAt(0)&&(e=e.substring(1,e.length-1)),c=[];for(var d=null,f,m=0;m<e.length;m++){var l=e.charAt(m);if(null===d)switch(l){case'"':case"'":case"/":d=m,f=l}else if(l==f&&"\\"!==e.charAt(m-1)){l=e.substring(d,m+1),c.push(l);var n="@ko_token_"+(c.length-1)+"@",e=e.substring(0,d)+n+e.substring(m+1),m=m-(l.length-n.length),d=null}}f=d=null;for(var p=0,r=null,m=0;m<e.length;m++){if(l=e.charAt(m),null===d)switch(l){case"{":d=m,r=l,f="}";break;case"(":d=m,r=l,f=")";break;case"[":d=m,r=l,f="]"}l===r?p++:l===f&&(p--,0===p&&(l=e.substring(d,m+1),c.push(l),n="@ko_token_"+(c.length-1)+"@",e=e.substring(0,d)+n+e.substring(m+1),m-=l.length-n.length,d=null))}for(f=[],e=e.split(","),d=0,m=e.length;m>d;d++)p=e[d],r=p.indexOf(":"),r>0&&r<p.length-1?(l=p.substring(r+1),f.push({key:b(p.substring(0,r),c),value:b(l,c)})):f.push({unknown:b(p,c)});return f},fa:function(b){var e="string"==typeof b?a.g.ea(b):b,c=[];b=[];for(var h,m=0;h=e[m];m++)if(0<c.length&&c.push(","),h.key){var l;a:{l=h.key;var n=a.a.H(l);switch(n.length&&n.charAt(0)){case"'":case'"':break a;default:l="'"+n+"'"}}h=h.value,c.push(l),c.push(":"),c.push(h),h=a.a.H(h),0<=a.a.k(d,a.a.H(h).toLowerCase())?h=!1:(n=h.match(f),h=null===n?!1:n[1]?"Object("+n[1]+")"+n[2]:h),h&&(0<b.length&&b.push(", "),b.push(l+" : function(__ko_value) { "+h+" = __ko_value; }"))}else h.unknown&&c.push(h.unknown);return e=c.join(""),0<b.length&&(e=e+", '_ko_property_writers' : { "+b.join("")+" } "),e},Lb:function(b,c){for(var d=0;d<b.length;d++)if(a.a.H(b[d].key)==c)return!0;return!1},ia:function(b,c,d,f,m){b&&a.W(b)?!a.Ya(b)||m&&b.t()===f||b(f):(b=c()._ko_property_writers)&&b[d]&&b[d](f)}}}(),a.b("expressionRewriting",a.g),a.b("expressionRewriting.bindingRewriteValidators",a.g.V),a.b("expressionRewriting.parseObjectLiteral",a.g.ea),a.b("expressionRewriting.preProcessBindings",a.g.fa),a.b("jsonExpressionRewriting",a.g),a.b("jsonExpressionRewriting.insertPropertyAccessorsIntoJson",a.g.fa),function(){function b(a){return 8==a.nodeType&&(g?a.text:a.nodeValue).match(e)
}function c(a){return 8==a.nodeType&&(g?a.text:a.nodeValue).match(k)}function d(a,e){for(var d=a,g=1,f=[];d=d.nextSibling;){if(c(d)&&(g--,0===g))return f;f.push(d),b(d)&&g++}if(!e)throw Error("Cannot find closing comment tag to match: "+a.nodeValue);return null}function f(a,b){var c=d(a,b);return c?0<c.length?c[c.length-1].nextSibling:a.nextSibling:null}var g=t&&"<!--test-->"===t.createComment("test").text,e=g?/^\x3c!--\s*ko(?:\s+(.+\s*\:[\s\S]*))?\s*--\x3e$/:/^\s*ko(?:\s+(.+\s*\:[\s\S]*))?\s*$/,k=g?/^\x3c!--\s*\/ko\s*--\x3e$/:/^\s*\/ko\s*$/,h={ul:!0,ol:!0};a.e={N:{},childNodes:function(a){return b(a)?d(a):a.childNodes},ca:function(c){if(b(c)){c=a.e.childNodes(c);for(var e=0,d=c.length;d>e;e++)a.removeNode(c[e])}else a.a.pa(c)},S:function(c,e){if(b(c)){a.e.ca(c);for(var d=c.nextSibling,g=0,f=e.length;f>g;g++)d.parentNode.insertBefore(e[g],d)}else a.a.S(c,e)},bb:function(a,c){b(a)?a.parentNode.insertBefore(c,a.nextSibling):a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)},Wa:function(c,e,d){d?b(c)?c.parentNode.insertBefore(e,d.nextSibling):d.nextSibling?c.insertBefore(e,d.nextSibling):c.appendChild(e):a.e.bb(c,e)},firstChild:function(a){return b(a)?!a.nextSibling||c(a.nextSibling)?null:a.nextSibling:a.firstChild},nextSibling:function(a){return b(a)&&(a=f(a)),a.nextSibling&&c(a.nextSibling)?null:a.nextSibling},pb:function(a){return(a=b(a))?a[1]:null},$a:function(e){if(h[a.a.u(e)]){var d=e.firstChild;if(d)do if(1===d.nodeType){var g;g=d.firstChild;var k=null;if(g)do if(k)k.push(g);else if(b(g)){var r=f(g,!0);r?g=r:k=[g]}else c(g)&&(k=[g]);while(g=g.nextSibling);if(g=k)for(k=d.nextSibling,r=0;r<g.length;r++)k?e.insertBefore(g[r],k):e.appendChild(g[r])}while(d=d.nextSibling)}}}}(),a.b("virtualElements",a.e),a.b("virtualElements.allowedBindings",a.e.N),a.b("virtualElements.emptyNode",a.e.ca),a.b("virtualElements.insertAfter",a.e.Wa),a.b("virtualElements.prepend",a.e.bb),a.b("virtualElements.setDomNodeChildren",a.e.S),function(){a.O=function(){this.sb={}},a.a.extend(a.O.prototype,{nodeHasBindings:function(b){switch(b.nodeType){case 1:return null!=b.getAttribute("data-bind");case 8:return null!=a.e.pb(b);default:return!1}},getBindings:function(a,c){var d=this.getBindingsString(a,c);return d?this.parseBindingsString(d,c,a):null},getBindingsString:function(b){switch(b.nodeType){case 1:return b.getAttribute("data-bind");case 8:return a.e.pb(b);default:return null}},parseBindingsString:function(b,c,d){try{var f=this.sb,g;if(!(g=f[b])){var e,k="with($context){with($data||{}){return{"+a.g.fa(b)+"}}}";e=new Function("$context","$element",k),g=f[b]=e}return g(c,d)}catch(h){throw h.message="Unable to parse bindings.\nBindings value: "+b+"\nMessage: "+h.message,h}}}),a.O.instance=new a.O}(),a.b("bindingProvider",a.O),function(){function b(b,e,d){for(var f=a.e.firstChild(e);e=f;)f=a.e.nextSibling(e),c(b,e,d)}function c(c,e,f){var h=!0,m=1===e.nodeType;m&&a.e.$a(e),(m&&f||a.O.instance.nodeHasBindings(e))&&(h=d(e,null,c,f).Ub),h&&b(c,e,!m)}function d(b,c,d,h){function m(a){return function(){return p[a]}}function l(){return p}var n=0,p,r,x=a.a.f.get(b,f);if(!c){if(x)throw Error("You cannot apply bindings multiple times to the same element."+b.id+" "+b.className);a.a.f.set(b,f,!0)}return a.h(function(){var f=d&&d instanceof a.C?d:new a.C(a.a.c(d)),C=f.$data;!x&&h&&a.kb(b,f),(p=("function"==typeof c?c(f,b):c)||a.O.instance.getBindings(b,f))&&(0===n&&(n=1,a.a.w(p,function(c){var e=a.d[c];if(e&&8===b.nodeType&&!a.e.N[c])throw Error("The binding '"+c+"' cannot be used with virtual elements");if(e&&"function"==typeof e.init&&(e=e.init(b,m(c),l,C,f))&&e.controlsDescendantBindings){if(r!==q)throw Error("Multiple bindings ("+r+" and "+c+") are trying to control descendant bindings of the same element. You cannot use these bindings together on the same element.");r=c}}),n=2),2===n&&a.a.w(p,function(c){var e=a.d[c];e&&"function"==typeof e.update&&e.update(b,m(c),l,C,f)}))},null,{aa:b}),{Ub:r===q}}a.d={},a.C=function(b,c,d){c?(a.a.extend(this,c),this.$parentContext=c,this.$parent=c.$data,this.$parents=(c.$parents||[]).slice(0),this.$parents.unshift(this.$parent)):(this.$parents=[],this.$root=b,this.ko=a),this.$data=b,d&&(this[d]=b)},a.C.prototype.createChildContext=function(b,c){return new a.C(b,this,c)},a.C.prototype.extend=function(b){var c=a.a.extend(new a.C,this);return a.a.extend(c,b)};var f="__ko_boundElement";a.kb=function(b,c){return 2!=arguments.length?a.a.f.get(b,"__ko_bindingContext__"):void a.a.f.set(b,"__ko_bindingContext__",c)},a.La=function(b,c,f){return 1===b.nodeType&&a.e.$a(b),d(b,c,f,!0)},a.Ka=function(a,c){1!==c.nodeType&&8!==c.nodeType||b(a,c,!0)},a.Ja=function(a,b){if(b&&1!==b.nodeType&&8!==b.nodeType)throw Error("ko.applyBindings: first parameter should be your view model; second parameter should be a DOM node");b=b||w.document.body,c(a,b,!0)},a.oa=function(b){switch(b.nodeType){case 1:case 8:var c=a.kb(b);if(c)return c;if(b.parentNode)return a.oa(b.parentNode)}return q},a.vb=function(b){return(b=a.oa(b))?b.$data:q},a.b("bindingHandlers",a.d),a.b("applyBindings",a.Ja),a.b("applyBindingsToDescendants",a.Ka),a.b("applyBindingsToNode",a.La),a.b("contextFor",a.oa),a.b("dataFor",a.vb)}();var J={"class":"className","for":"htmlFor"};a.d.attr={update:function(b,c){var d=a.a.c(c())||{};a.a.w(d,function(c,d){d=a.a.c(d);var e=!1===d||null===d||d===q;e&&b.removeAttribute(c),8>=a.a.da&&c in J?(c=J[c],e?b.removeAttribute(c):b[c]=d):e||b.setAttribute(c,d.toString()),"name"===c&&a.a.hb(b,e?"":d.toString())})}},a.d.checked={init:function(b,c,d){a.a.p(b,"click",function(){var f;if("checkbox"==b.type)f=b.checked;else{if("radio"!=b.type||!b.checked)return;f=b.value}var g=c(),e=a.a.c(g);"checkbox"==b.type&&e instanceof Array?a.a.ka(g,b.value,b.checked):a.g.ia(g,d,"checked",f,!0)}),"radio"!=b.type||b.name||a.d.uniqueName.init(b,function(){return!0})},update:function(b,c){var d=a.a.c(c());"checkbox"==b.type?b.checked=d instanceof Array?0<=a.a.k(d,b.value):d:"radio"==b.type&&(b.checked=b.value==d)}},a.d.css={update:function(b,c){var d=a.a.c(c());"object"==typeof d?a.a.w(d,function(c,d){d=a.a.c(d),a.a.ha(b,c,d)}):(d=String(d||""),a.a.ha(b,b.__ko__cssValue,!1),b.__ko__cssValue=d,a.a.ha(b,d,!0))}},a.d.enable={update:function(b,c){var d=a.a.c(c());d&&b.disabled?b.removeAttribute("disabled"):d||b.disabled||(b.disabled=!0)}},a.d.disable={update:function(b,c){a.d.enable.update(b,function(){return!a.a.c(c())})}},a.d.event={init:function(b,c,d,f){var g=c()||{};a.a.w(g,function(e){"string"==typeof e&&a.a.p(b,e,function(b){var g,m=c()[e];if(m){var l=d();try{var n=a.a.Q(arguments);n.unshift(f),g=m.apply(f,n)}finally{!0!==g&&(b.preventDefault?b.preventDefault():b.returnValue=!1)}!1===l[e+"Bubble"]&&(b.cancelBubble=!0,b.stopPropagation&&b.stopPropagation())}})})}},a.d.foreach={Za:function(b){return function(){var c=b(),d=a.a.za(c);return d&&"number"!=typeof d.length?(a.a.c(c),{foreach:d.data,as:d.as,includeDestroyed:d.includeDestroyed,afterAdd:d.afterAdd,beforeRemove:d.beforeRemove,afterRender:d.afterRender,beforeMove:d.beforeMove,afterMove:d.afterMove,templateEngine:a.G.ta}):{foreach:c,templateEngine:a.G.ta}}},init:function(b,c){return a.d.template.init(b,a.d.foreach.Za(c))},update:function(b,c,d,f,g){return a.d.template.update(b,a.d.foreach.Za(c),d,f,g)}},a.g.V.foreach=!1,a.e.N.foreach=!0,a.d.hasfocus={init:function(b,c,d){function f(e){b.__ko_hasfocusUpdating=!0;var f=b.ownerDocument;if("activeElement"in f){var g;try{g=f.activeElement}catch(l){g=f.body}e=g===b}f=c(),a.g.ia(f,d,"hasfocus",e,!0),b.__ko_hasfocusLastValue=e,b.__ko_hasfocusUpdating=!1}var g=f.bind(null,!0),e=f.bind(null,!1);a.a.p(b,"focus",g),a.a.p(b,"focusin",g),a.a.p(b,"blur",e),a.a.p(b,"focusout",e)},update:function(b,c){var d=!!a.a.c(c());b.__ko_hasfocusUpdating||b.__ko_hasfocusLastValue===d||(d?b.focus():b.blur(),a.o.P(a.a.Ha,null,[b,d?"focusin":"focusout"]))}},a.d.hasFocus=a.d.hasfocus,a.d.html={init:function(){return{controlsDescendantBindings:!0}},update:function(b,c){a.a.ga(b,c())}};var H="__ko_withIfBindingData";F("if"),F("ifnot",!1,!0),F("with",!0,!1,function(a,c){return a.createChildContext(c)}),a.d.options={init:function(b){if("select"!==a.a.u(b))throw Error("options binding applies only to SELECT elements");for(;0<b.length;)b.remove(0);return{controlsDescendantBindings:!0}},update:function(b,c,d){function f(a,b,c){var d=typeof b;return"function"==d?b(a):"string"==d?a[b]:c}function g(b,c){if(p){var d=0<=a.a.k(p,a.i.n(c[0]));a.a.ib(c[0],d)}}var e=0==b.length,k=!e&&b.multiple?b.scrollTop:null;c=a.a.c(c());var h=d(),m=h.optionsIncludeDestroyed,l={},n,p;if(b.multiple?p=a.a.$(b.selectedOptions||a.a.Z(b.childNodes,function(b){return b.tagName&&"option"===a.a.u(b)&&b.selected}),function(b){return a.i.n(b)}):0<=b.selectedIndex&&(p=[a.i.n(b.options[b.selectedIndex])]),c){"undefined"==typeof c.length&&(c=[c]);var r=a.a.Z(c,function(b){return m||b===q||null===b||!a.a.c(b._destroy)});"optionsCaption"in h&&(n=a.a.c(h.optionsCaption),null!==n&&n!==q&&r.unshift(l))}else c=[];d=g,h.optionsAfterRender&&(d=function(b,c){g(0,c),a.o.P(h.optionsAfterRender,null,[c[0],b!==l?b:q])}),a.a.Ba(b,r,function(b,c,d){return d.length&&(p=d[0].selected&&[a.i.n(d[0])]),c=t.createElement("option"),b===l?(a.a.ga(c,n),a.i.X(c,q)):(d=f(b,h.optionsValue,b),a.i.X(c,a.a.c(d)),b=f(b,h.optionsText,d),a.a.jb(c,b)),[c]},null,d),p=null,e&&"value"in h&&I(b,a.a.za(h.value),!0),a.a.Ab(b),k&&20<Math.abs(k-b.scrollTop)&&(b.scrollTop=k)}},a.d.options.xa="__ko.optionValueDomData__",a.d.selectedOptions={init:function(b,c,d){a.a.p(b,"change",function(){var f=c(),g=[];a.a.r(b.getElementsByTagName("option"),function(b){b.selected&&g.push(a.i.n(b))}),a.g.ia(f,d,"selectedOptions",g)})},update:function(b,c){if("select"!=a.a.u(b))throw Error("values binding applies only to SELECT elements");var d=a.a.c(c());d&&"number"==typeof d.length&&a.a.r(b.getElementsByTagName("option"),function(b){var c=0<=a.a.k(d,a.i.n(b));a.a.ib(b,c)})}},a.d.style={update:function(b,c){var d=a.a.c(c()||{});a.a.w(d,function(c,d){d=a.a.c(d),b.style[c]!==d&&(b.style[c]=d||"")})}},a.d.submit={init:function(b,c,d,f){if("function"!=typeof c())throw Error("The value for a submit binding must be a function");a.a.p(b,"submit",function(a){var d,k=c();try{d=k.call(f,b)}finally{!0!==d&&(a.preventDefault?a.preventDefault():a.returnValue=!1)}})}},a.d.text={update:function(b,c){a.a.jb(b,c())}},a.e.N.text=!0,a.d.uniqueName={init:function(b,c){if(c()){var d="ko_unique_"+ ++a.d.uniqueName.ub;a.a.hb(b,d)}}},a.d.uniqueName.ub=0,a.d.value={init:function(b,c,d){function f(){k=!1;var e=c(),f=a.i.n(b);a.g.ia(e,d,"value",f)}var g=["change"],e=d().valueUpdate,k=!1;e&&("string"==typeof e&&(e=[e]),a.a.U(g,e),g=a.a.Na(g)),!a.a.da||"input"!=b.tagName.toLowerCase()||"text"!=b.type||"off"==b.autocomplete||b.form&&"off"==b.form.autocomplete||-1!=a.a.k(g,"propertychange")||(a.a.p(b,"propertychange",function(){k=!0}),a.a.p(b,"blur",function(){k&&f()})),a.a.r(g,function(c){var d=f;a.a.Vb(c,"after")&&(d=function(){setTimeout(f,0)},c=c.substring(5)),a.a.p(b,c,d)})},update:function(b,c){var d="select"===a.a.u(b),f=a.a.c(c()),g=a.i.n(b);f!==g&&(g=function(){a.i.X(b,f)},g(),d&&setTimeout(g,0)),d&&0<b.length&&I(b,f,!1)}},a.d.visible={update:function(b,c){var d=a.a.c(c()),f="none"!=b.style.display;d&&!f?b.style.display="":!d&&f&&(b.style.display="none")}},function(b){a.d[b]={init:function(c,d,f,g){return a.d.event.init.call(this,c,function(){var a={};return a[b]=d(),a},f,g)}}}("click"),a.v=function(){},a.v.prototype.renderTemplateSource=function(){throw Error("Override renderTemplateSource")},a.v.prototype.createJavaScriptEvaluatorBlock=function(){throw Error("Override createJavaScriptEvaluatorBlock")},a.v.prototype.makeTemplateSource=function(b,c){if("string"==typeof b){c=c||t;var d=c.getElementById(b);if(!d)throw Error("Cannot find template with ID "+b);return new a.m.j(d)}if(1==b.nodeType||8==b.nodeType)return new a.m.T(b);throw Error("Unknown template type: "+b)},a.v.prototype.renderTemplate=function(a,c,d,f){return a=this.makeTemplateSource(a,f),this.renderTemplateSource(a,c,d)},a.v.prototype.isTemplateRewritten=function(a,c){return!1===this.allowTemplateRewriting?!0:this.makeTemplateSource(a,c).data("isRewritten")},a.v.prototype.rewriteTemplate=function(a,c,d){a=this.makeTemplateSource(a,d),c=c(a.text()),a.text(c),a.data("isRewritten",!0)},a.b("templateEngine",a.v),a.Fa=function(){function b(b,c,d,k){b=a.g.ea(b);for(var h=a.g.V,m=0;m<b.length;m++){var l=b[m].key;if(h.hasOwnProperty(l)){var n=h[l];if("function"==typeof n){if(l=n(b[m].value))throw Error(l)}else if(!n)throw Error("This template engine does not support the '"+l+"' binding within its templates")}}return d="ko.__tr_ambtns(function($context,$element){return(function(){return{ "+a.g.fa(b)+" } })()},'"+d.toLowerCase()+"')",k.createJavaScriptEvaluatorBlock(d)+c}var c=/(<([a-z]+\d*)(?:\s+(?!data-bind\s*=\s*)[a-z0-9\-]+(?:=(?:\"[^\"]*\"|\'[^\']*\'))?)*\s+)data-bind\s*=\s*(["'])([\s\S]*?)\3/gi,d=/\x3c!--\s*ko\b\s*([\s\S]*?)\s*--\x3e/g;return{Bb:function(b,c,d){c.isTemplateRewritten(b,d)||c.rewriteTemplate(b,function(b){return a.Fa.Nb(b,c)},d)},Nb:function(a,g){return a.replace(c,function(a,c,d,f,l){return b(l,c,d,g)}).replace(d,function(a,c){return b(c,"<!-- ko -->","#comment",g)})},rb:function(b,c){return a.s.wa(function(d,k){var h=d.nextSibling;h&&h.nodeName.toLowerCase()===c&&a.La(h,b,k)})}}}(),a.b("__tr_ambtns",a.Fa.rb),function(){a.m={},a.m.j=function(a){this.j=a},a.m.j.prototype.text=function(){var b=a.a.u(this.j),b="script"===b?"text":"textarea"===b?"value":"innerHTML";if(0==arguments.length)return this.j[b];var c=arguments[0];"innerHTML"===b?a.a.ga(this.j,c):this.j[b]=c},a.m.j.prototype.data=function(b){return 1===arguments.length?a.a.f.get(this.j,"templateSourceData_"+b):void a.a.f.set(this.j,"templateSourceData_"+b,arguments[1])},a.m.T=function(a){this.j=a},a.m.T.prototype=new a.m.j,a.m.T.prototype.text=function(){if(0==arguments.length){var b=a.a.f.get(this.j,"__ko_anon_template__")||{};return b.Ga===q&&b.na&&(b.Ga=b.na.innerHTML),b.Ga}a.a.f.set(this.j,"__ko_anon_template__",{Ga:arguments[0]})},a.m.j.prototype.nodes=function(){return 0==arguments.length?(a.a.f.get(this.j,"__ko_anon_template__")||{}).na:void a.a.f.set(this.j,"__ko_anon_template__",{na:arguments[0]})},a.b("templateSources",a.m),a.b("templateSources.domElement",a.m.j),a.b("templateSources.anonymousTemplate",a.m.T)}(),function(){function b(b,c,d){var f;for(c=a.e.nextSibling(c);b&&(f=b)!==c;)b=a.e.nextSibling(f),1!==f.nodeType&&8!==f.nodeType||d(f)}function c(c,d){if(c.length){var f=c[0],g=c[c.length-1];b(f,g,function(b){a.Ja(d,b)}),b(f,g,function(b){a.s.ob(b,[d])})}}function d(a){return a.nodeType?a:0<a.length?a[0]:null}function f(b,f,h,m,l){l=l||{};var n=b&&d(b),n=n&&n.ownerDocument,p=l.templateEngine||g;if(a.Fa.Bb(h,p,n),h=p.renderTemplate(h,m,l,n),"number"!=typeof h.length||0<h.length&&"number"!=typeof h[0].nodeType)throw Error("Template engine must return an array of DOM nodes");switch(n=!1,f){case"replaceChildren":a.e.S(b,h),n=!0;break;case"replaceNode":a.a.fb(b,h),n=!0;break;case"ignoreTargetNode":break;default:throw Error("Unknown renderMode: "+f)}return n&&(c(h,m),l.afterRender&&a.o.P(l.afterRender,null,[h,m.$data])),h}var g;a.Ca=function(b){if(b!=q&&!(b instanceof a.v))throw Error("templateEngine must inherit from ko.templateEngine");g=b},a.Aa=function(b,c,h,m,l){if(h=h||{},(h.templateEngine||g)==q)throw Error("Set a template engine before calling renderTemplate");if(l=l||"replaceChildren",m){var n=d(m);return a.h(function(){var g=c&&c instanceof a.C?c:new a.C(a.a.c(c)),r="function"==typeof b?b(g.$data,g):b,g=f(m,l,r,g,h);"replaceNode"==l&&(m=g,n=d(m))},null,{Ra:function(){return!n||!a.a.ba(n)},aa:n&&"replaceNode"==l?n.parentNode:n})}return a.s.wa(function(d){a.Aa(b,c,h,d,"replaceNode")})},a.Tb=function(b,d,g,m,l){function n(a,b){c(b,r),g.afterRender&&g.afterRender(b,a)}function p(c,d){r=l.createChildContext(a.a.c(c),g.as),r.$index=d;var k="function"==typeof b?b(c,r):b;return f(null,"ignoreTargetNode",k,r,g)}var r;return a.h(function(){var b=a.a.c(d)||[];"undefined"==typeof b.length&&(b=[b]),b=a.a.Z(b,function(b){return g.includeDestroyed||b===q||null===b||!a.a.c(b._destroy)}),a.o.P(a.a.Ba,null,[m,b,p,g,n])},null,{aa:m})},a.d.template={init:function(b,c){var d=a.a.c(c());return"string"==typeof d||d.name||1!=b.nodeType&&8!=b.nodeType||(d=1==b.nodeType?b.childNodes:a.e.childNodes(b),d=a.a.Ob(d),new a.m.T(b).nodes(d)),{controlsDescendantBindings:!0}},update:function(b,c,d,f,g){c=a.a.c(c()),d={},f=!0;var n,p=null;"string"!=typeof c&&(d=c,c=a.a.c(d.name),"if"in d&&(f=a.a.c(d["if"])),f&&"ifnot"in d&&(f=!a.a.c(d.ifnot)),n=a.a.c(d.data)),"foreach"in d?p=a.Tb(c||b,f&&d.foreach||[],d,b,g):f?(g="data"in d?g.createChildContext(n,d.as):g,p=a.Aa(c||b,g,d,b)):a.e.ca(b),g=p,(n=a.a.f.get(b,"__ko__templateComputedDomDataKey__"))&&"function"==typeof n.D&&n.D(),a.a.f.set(b,"__ko__templateComputedDomDataKey__",g&&g.ua()?g:q)}},a.g.V.template=function(b){return b=a.g.ea(b),1==b.length&&b[0].unknown||a.g.Lb(b,"name")?null:"This template engine does not support anonymous templates nested within its templates"},a.e.N.template=!0}(),a.b("setTemplateEngine",a.Ca),a.b("renderTemplate",a.Aa),a.a.Qa=function(){function a(b,d,f,g,e){var k=Math.min,h=Math.max,m=[],l,n=b.length,p,r=d.length,q=r-n||1,s=n+r+1,t,u,y;for(l=0;n>=l;l++)for(u=t,m.push(t=[]),y=k(r,l+q),p=h(0,l-1);y>=p;p++)t[p]=p?l?b[l-1]===d[p-1]?u[p-1]:k(u[p]||s,t[p-1]||s)+1:p+1:l+1;for(k=[],h=[],q=[],l=n,p=r;l||p;)r=m[l][p]-1,p&&r===m[l][p-1]?h.push(k[k.length]={status:f,value:d[--p],index:p}):l&&r===m[l-1][p]?q.push(k[k.length]={status:g,value:b[--l],index:l}):(k.push({status:"retained",value:d[--p]}),--l);if(h.length&&q.length){b=10*n;var w;for(d=f=0;(e||b>d)&&(w=h[f]);f++){for(g=0;m=q[g];g++)if(w.value===m.value){w.moved=m.index,m.moved=w.index,q.splice(g,1),d=g=0;break}d+=g}}return k.reverse()}return function(c,d,f){return c=c||[],d=d||[],c.length<=d.length?a(c,d,"added","deleted",f):a(d,c,"deleted","added",f)}}(),a.b("utils.compareArrays",a.a.Qa),function(){function b(b){for(;b.length&&!a.a.ba(b[0]);)b.splice(0,1);if(1<b.length){for(var c=b[0],g=b[b.length-1],e=[c];c!==g;){if(c=c.nextSibling,!c)return;e.push(c)}Array.prototype.splice.apply(b,[0,b.length].concat(e))}return b}function c(c,f,g,e,k){var h=[];return c=a.h(function(){var c=f(g,k,b(h))||[];0<h.length&&(a.a.fb(h,c),e&&a.o.P(e,null,[g,c,k])),h.splice(0,h.length),a.a.U(h,c)},null,{aa:c,Ra:function(){return!a.a.qb(h)}}),{R:h,h:c.ua()?c:q}}a.a.Ba=function(d,f,g,e,k){function h(a,c){v=n[c],w!==c&&(A[a]=v),v.sa(w++),b(v.R),s.push(v),y.push(v)}function m(b,c){if(b)for(var d=0,e=c.length;e>d;d++)c[d]&&a.a.r(c[d].R,function(a){b(a,d,c[d].Y)})}f=f||[],e=e||{};var l=a.a.f.get(d,"setDomNodeChildrenFromArrayMapping_lastMappingResult")===q,n=a.a.f.get(d,"setDomNodeChildrenFromArrayMapping_lastMappingResult")||[],p=a.a.$(n,function(a){return a.Y}),r=a.a.Qa(p,f,e.dontLimitMoves),s=[],t=0,w=0,u=[],y=[];f=[];for(var A=[],p=[],v,D=0,z,B;z=r[D];D++)switch(B=z.moved,z.status){case"deleted":B===q&&(v=n[t],v.h&&v.h.D(),u.push.apply(u,b(v.R)),e.beforeRemove&&(f[D]=v,y.push(v))),t++;break;case"retained":h(D,t++);break;case"added":B!==q?h(D,B):(v={Y:z.value,sa:a.l(w++)},s.push(v),y.push(v),l||(p[D]=v))}m(e.beforeMove,A),a.a.r(u,e.beforeRemove?a.J:a.removeNode);for(var D=0,l=a.e.firstChild(d),F;v=y[D];D++){for(v.R||a.a.extend(v,c(d,g,v.Y,k,v.sa)),t=0;r=v.R[t];l=r.nextSibling,F=r,t++)r!==l&&a.e.Wa(d,r,F);!v.Hb&&k&&(k(v.Y,v.R,v.sa),v.Hb=!0)}m(e.beforeRemove,f),m(e.afterMove,A),m(e.afterAdd,p),a.a.f.set(d,"setDomNodeChildrenFromArrayMapping_lastMappingResult",s)}}(),a.b("utils.setDomNodeChildrenFromArrayMapping",a.a.Ba),a.G=function(){this.allowTemplateRewriting=!1},a.G.prototype=new a.v,a.G.prototype.renderTemplateSource=function(b){var c=(9>a.a.da?0:b.nodes)?b.nodes():null;return c?a.a.Q(c.cloneNode(!0).childNodes):(b=b.text(),a.a.ya(b))},a.G.ta=new a.G,a.Ca(a.G.ta),a.b("nativeTemplateEngine",a.G),function(){a.va=function(){var a=this.Kb=function(){if("undefined"==typeof s||!s.tmpl)return 0;try{if(0<=s.tmpl.tag.tmpl.open.toString().indexOf("__"))return 2}catch(a){}return 1}();this.renderTemplateSource=function(b,f,g){if(g=g||{},2>a)throw Error("Your version of jQuery.tmpl is too old. Please upgrade to jQuery.tmpl 1.0.0pre or later.");var e=b.data("precompiled");return e||(e=b.text()||"",e=s.template(null,"{{ko_with $item.koBindingContext}}"+e+"{{/ko_with}}"),b.data("precompiled",e)),b=[f.$data],f=s.extend({koBindingContext:f},g.templateOptions),f=s.tmpl(e,b,f),f.appendTo(t.createElement("div")),s.fragments={},f},this.createJavaScriptEvaluatorBlock=function(a){return"{{ko_code ((function() { return "+a+" })()) }}"},this.addTemplate=function(a,b){t.write("<script type='text/html' id='"+a+"'>"+b+"</script>")},a>0&&(s.tmpl.tag.ko_code={open:"__.push($1 || '');"},s.tmpl.tag.ko_with={open:"with($1) {",close:"} "})},a.va.prototype=new a.v;var b=new a.va;0<b.Kb&&a.Ca(b),a.b("jqueryTmplTemplateEngine",a.va)}()})}()}(),define("util",[],function(){function setURLPart(part,str){part===URLPart.Search?window.location.search=str:part===URLPart.Hash&&(window.location.hash=str)}function getStringForPart(part){return part===URLPart.Search?window.location.search:part===URLPart.Hash?window.location.hash:void 0}function getURLPartForParam(param){return URLParamMap[param]}function dummyStorageGetFn(){}var self={};window.URLPart={Search:1,Hash:2};var URLParamMap={demo:URLPart.Hash,login:URLPart.Hash,access_token:URLPart.Hash,error:URLPart.Hash,expires_in:URLPart.Hash,scope:URLPart.Hash,token_type:URLPart.Hash,data:URLPart.Hash,script:URLPart.Hash,dmode:URLPart.Hash,jasmine:URLPart.Hash,touch:URLPart.Hash,file:URLPart.Hash,panes:URLPart.Hash,offline:URLPart.Hash,live:URLPart.Hash,test:URLPart.Hash,nolocal:URLPart.Hash,nosync:URLPart.Hash,rdebug:URLPart.Hash,rsession:URLPart.Hash,cacheError:URLPart.Hash,state:URLPart.Search};self.hasURLParam=function hasURLParamFn(key,value){var str=key+"=";value&&(str+=value);var part=getURLPartForParam(key);part||log("Invalid URL Part");var rawString=getStringForPart(part);return rawString.indexOf(str)>=0},self.getURLParam=function getURLParamFn(key,forcePart){var part=forcePart?forcePart:getURLPartForParam(key);if(part===URLPart.Search){key=key.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+key+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(window.location.href);return null===results?void 0:decodeURIComponent(results[1].replace(/\+/g," "))}if(part===URLPart.Hash){for(var queryString=window.location.hash.substring(1),regex=/([^&=]+)=([^&]*)/g,m;m=regex.exec(queryString);)if(decodeURIComponent(m[1])===key)return decodeURIComponent(m[2]);return void 0}log("Invalid URL part")},self.insertURLParam=function insertURLParamFn(key,value,noReload){key=encodeURIComponent(key),value=encodeURIComponent(value);for(var part=getURLPartForParam(key),rawString=getStringForPart(part),params=rawString.substr(1).split("&"),i=params.length-1;i>=0;i--){var param=params[i].split("=");if(param[0]==key){param[1]=value,params[i]=param.join("=");break}}0>i&&(params[params.length]=[key,value].join("=")),setURLPart(part,params.join("&")),part!==URLPart.Hash||noReload||window.location.reload()},self.removeURLParam=function removeURLParamFn(key,noReload){key=encodeURIComponent(key);for(var part=getURLPartForParam(key),rawString=getStringForPart(part),params=rawString.substr(1).split("&"),i=params.length-1;i>=0;i--){var param=params[i].split("=");if(param[0]==key){params.splice(i,1);break}}setURLPart(part,params.join("&")),part!==URLPart.Hash||noReload||window.location.reload()};var pck="chrome-extension:"===window.location.protocol;return self.__storage=pck?chrome.storage.local:window.localStorage,self.storage={getItem:(self.__storage.getItem||function(key,cb){return this.get(key,cb||dummyStorageGetFn)}).bind(self.__storage),setItem:(self.__storage.setItem||function(key,value){var obj={};obj[key]=value,self.__storage.set(obj)}).bind(self.__storage),removeItem:(self.__storage.removeItem||function(key,cb){this.remove(key,cb)}).bind(self.__storage)},self}),define("platform",["ko","util"],function(ko,util){function platform(){this.versionRequired=[],this.versionRequired[AppPlatform.iOS]=4,this.versionRequired[AppPlatform.Android]=4,this.appPlatform=void 0,this.requireCustomRedirect=!1,this.b=document.documentElement||document.body,this.orientation=Orientation.Portrait,this.windowWidth=ko.observable(0),this.windowHeight=ko.observable(0),this.kbsize=void 0,this.kbsizePortrait=void 0,this.kbsizeLandscape=void 0,this.hasBeenPortrait=!1,this.iframeApp=void 0,this.appState=void 0,this.isDevURL="dev.moo.do"===window.location.hostname,this.init();var useLocationHost=!1||this.isDevURL||this.app&&this.debugApp||!this.app&&this.standalone;this.customRedirectString=window.location.protocol+"//"+(useLocationHost?window.location.host:"www.moo.do"),this.app&&(this.customRedirectState={app:!0,appv:this.versionRequired[this.appPlatform]}),this.keyboardOpenTime=this.app||this.android?200:this.winphone?200:this.mobileie?600:0}return window.Orientation={Portrait:0,Landscape:1},window.AppPlatform={iOS:0,Android:1,WinPhone:2},platform.prototype={getPlatformInfo:function getPlatformInfoFn(obj){obj.os=this.OSName,obj.browser=this.browser,obj.appVersionRequired=this.versionRequired[this.appPlatform],obj.app=this.app,obj.appPlatform=this.appPlatform,obj.standalone=this.standalone,obj.packagedApp=this.packagedApp,obj.requireCustomRedirect=this.requireCustomRedirect,obj.isMobile=this.mobile,obj.isPhone=this.phone,obj.isTouch=this.touch,obj.isTouchDevice=this.isTouchDevice,obj.usePointerEvents=this.usePointerEvents,obj.kbsize=this.kbsize,obj.appState=this.appState,obj.bodyClass=this.b.className,obj.rawUA=navigator.userAgent},init:function initFn(){this.initAppState();var userAgent=navigator.userAgent,bodyClass="",OSName="Unknown OS";if(this.app&&(bodyClass+=" app"),-1!==userAgent.indexOf("Win")?(this.OSName="Windows",this.windows=!0,-1!==userAgent.indexOf("Windows Phone")&&(this.phone=!0,this.touch=!0,this.mobile=!0,this.app&&(this.appPlatform=AppPlatform.WinPhone))):-1!==userAgent.indexOf("iPad")?(this.OSName="iPad",this.ios=!0,this.ipad=!0,this.phone=!0,this.touch=!0,this.mobile=!0,this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("iPhone")?(this.OSName="iPhone",this.ios=!0,this.iphone=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("iPod")?(this.OSName="iPod",this.ios=!0,this.ipod=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("Mac")?(this.OSName="MacOS",this.mac=!0):-1!==userAgent.indexOf("X11")?(this.OSName="UNIX",this.unix=!0):-1!==userAgent.indexOf("Android")?(this.OSName="Android",this.android=!0,this.touch=!0,this.mobile=!0,this.phone=!0,this.app&&(this.appPlatform=AppPlatform.Android),bodyClass+=" android"):-1!==userAgent.indexOf("Linux")&&(this.OSName="Linux",this.linux=!0),this.ios&&(this.ios7=-1!==userAgent.indexOf("OS 7"),this.ios70=-1!==userAgent.indexOf("OS 7_0"),this.ios71=-1!==userAgent.indexOf("OS 7_1"),this.ios7&&(bodyClass+=" ios7")),this.majorVersion=1e3,this.minorVersion=1e3,-1!==userAgent.indexOf("MSIE")||-1!==userAgent.indexOf("Trident")){this.browser="Trident",this.ie=!0,this.winphone=!!userAgent.match(/IEMobile/i);var re;if(re=new RegExp(this.winphone||"Microsoft Internet Explorer"===navigator.appName?"MSIE ([0-9]{1,}[.0-9]{0,})":"Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),null!=re.exec(userAgent))this.majorVersion=parseFloat(RegExp.$1);else{var take2=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})");null!=take2.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}}else if(-1!==userAgent.indexOf("Chrome")||-1!==userAgent.indexOf("CriOS")){this.browser="Chrome",this.isChrome=!0;var re=new RegExp("Chrome/([0-9]{1,}).");null!=re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}else if(-1!==userAgent.indexOf("Android")){this.browser="Native Android";var re=new RegExp("Linux; Android ([0-9]{1,}).([0-9]{1,}).");null!=re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else if(-1!==userAgent.indexOf("Firefox")){this.browser="Firefox";var re=new RegExp("Firefox/([0-9]{1,}).");null!=re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}else if(-1!==userAgent.indexOf("Safari")||"iPad"===this.OSName||"iPhone"===this.OSName||"iPod"===this.OSName){this.browser="Safari";var re;re=new RegExp(this.mobile?"OS ([0-9]{1,})_([0-9]{1,})":"Version/([0-9]{1,}).([0-9]{1,})."),null!=re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else-1!==userAgent.indexOf("Opera")&&(this.browser="Opera");this.isTouchDevice=!!("ontouchstart"in window||window.navigator.msMaxTouchPoints),this.usePointerEvents=!!window.navigator.msPointerEnabled,log("Touch Device: "+this.isTouchDevice+" Pointer Events: "+this.usePointerEvents),log("Browser: "+this.browser+"  Major Version: "+this.majorVersion+"  Minor Version: "+this.minorVersion),this.isTouchDevice&&(this.usePointerEvents?(this.touchStartEvent="MSPointerDown",this.touchMoveEvent="MSPointerMove",this.touchEndEvent="MSPointerUp",this.touchCancelEvent="MSPointerCancel"):(this.touchStartEvent="touchstart",this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",this.touchCancelEvent="touchcancel")),this.usePointerEvents?(this.downEvent="MSPointerDown",this.moveEvent="MSPointerMove",this.upEvent="MSPointerUp"):(this.downEvent="mousedown",this.moveEvent="mousemove",this.upEvent="mouseup");try{var forceFullUI=!!util.storage.getItem("forceFullUI")}catch(err){}util.hasURLParam("touch","false")||forceFullUI?(this.touch=!1,this.phone=!1,this.mobile=!1,this.ios=!1,this.android=!1):(this.isTouchDevice||util.hasURLParam("touch","true"))&&(this.touch=!0,this.phone=!0,this.mobile=!0),this.windows&&(bodyClass+=" windows",this.ie?(bodyClass+=" ie",this.demo||(this.mobro=this.isMobro())):"Firefox"===this.browser&&(bodyClass+=" firefox")),this.phone&&(bodyClass+=" phone",bodyClass+=" nonbodyscroll",this.bodyscroll=!1),this.ipad&&(bodyClass+=" ipad"),this.mobileie=this.ie&&this.mobile,this.mobile&&!this.app&&this.calcKeyboardSize(),this.cmdChar=this.mac?"⌘":"ctrl",this.cmdCharC=this.mac?"⌘":"Ctrl",this.cmdCharP=this.mac?"⌘":"Ctrl+",this.noErrorStacks="iPad"===platform.OSName||"iPhone"===platform.OSName||"iPod"===platform.OSName,this.packagedApp="chrome-extension:"===window.location.protocol,this.standalone=!!window.navigator.standalone||this.packagedApp||window.navigator.userAgent.indexOf("FluidApp")>=0,(this.standalone||this.app||this.mobro)&&(this.requireCustomRedirect=!0),bodyClass&&bodyClass.length>0&&(this.b.className+=bodyClass),this.transition=this.addPrefix("transition"),this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin"),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)},this.ie&&(document.documentElement.addEventListener("MSHoldVisual",function(e){e.preventDefault()},!1),document.documentElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1)),document.documentElement.addEventListener("keydown",this.normalizeKeys,!0),document.documentElement.addEventListener("keypress",this.normalizeKeys,!0),document.documentElement.addEventListener("keyup",this.normalizeKeys,!0)},isMobro:function isMobroFn(){var supported=null;try{new ActiveXObject("")}catch(e){errorName=e.name}try{supported=!!new ActiveXObject("htmlfile")}catch(e){supported=!1}return supported="ReferenceError"!=errorName&&0==supported?!1:!0,!supported},calcKeyboardSize:function calcKeyboardSizeFn(){this.ios?this.iphone||this.ipod?(this.kbsizePortrait=216,this.kbsizeLandscape=162,this.ios71&&(this.kbsizePortrait+=44,this.kbsizeLandscape+=44)):this.ipad&&(this.kbsizePortrait=264,this.kbsizeLandscape=352,this.kbsizePortrait+=44,this.kbsizeLandscape+=44):this.android?(this.kbsizePortrait=0,this.kbsizeLandscape=0):this.mobileie&&(this.kbsizePortrait=226,this.kbsizeLandscape=200)
},normalizeKeys:function normalizeKeysFn(ev){void 0===ev.normCode&&(ev.normCode=null===ev.keyCode||0===ev.keyCode?null!=ev.charCode?ev.charCode:ev.which:ev.keyCode)},initAppState:function initAppStateFn(){var appState=location.hash.substring(1);if(appState)for(var regex=/([^&=]+)=([^&]*)/g,m;m=regex.exec(appState);)if("state"===decodeURIComponent(m[1])){var uri=decodeURIComponent(m[2]);if(uri){try{appState=JSON.parse(uri)}catch(err){log("Error parsing AppState: ",uri),appState=void 0}appState&&(this.app=appState.app===!0,this.appv=appState.appv,this.debugApp=appState.debug,this.live=appState.live,this.offline=appState.offline,this.syncContacts=appState.syncContacts,this.test=appState.test,this.appState=appState)}break}this.live=this.live||util.hasURLParam("live","true"),this.test=!1,this.offline=this.offline||this.test||util.hasURLParam("offline","true")||!1,this.demo=util.hasURLParam("demo","true")||!1,this.script=util.hasURLParam("script")},addPrefix:function addPrefixFn(p){var prefix="",v=["ms","webkit","moz","o"],s=this.b.style;if("string"==typeof s[p])prefix="";else for(var i=0;i<v.length;i++)if("string"==typeof s["-"+v[i]+"-"+p]){prefix=v[i];break}var styleString=prefix.length>0?p.charAt(0).toUpperCase()+p.slice(1):p;return prefix?{prop:"-"+prefix+"-"+p,style:prefix+styleString}:{prop:p,style:styleString}},blockClient:function blockClientFn(){switch(this.browser){case"Firefox":if(this.majorVersion<16)return{platform:"Firefox",browser:this.browser,update:!0};break;case"Chrome":if(this.majorVersion<26)return{platform:"Chrome",browser:this.browser,update:!0};break;case"Native Android":if(2===this.majorVersion&&this.minorVersion<1||this.majorVersion<2)return{platform:"Native Android",browser:"NativeAndroid",update:!0};break;case"Opera":return{platform:this.browser,browser:this.browser,update:!1};case"Trident":if(this.majorVersion<10)return{platform:"Internet Explorer",browser:this.browser,update:!0};break;case"Safari":if(this.mobile&&this.majorVersion<6)return{platform:"Safari",browser:this.browser,update:!0};if(!this.mobile&&(6==this.majorVersion&&this.minorVersion<1||this.majorVersion<6))return{platform:"Safari",browser:this.browser,update:!0}}if(this.app){if(this.appv<this.versionRequired[this.appPlatform])return log("App Version out of date."),{version:this.versionRequired[this.appPlatform]};if(this.appv>this.versionRequired[this.appPlatform])return log("App is newer than the javascript, forcing an app cache update"),{cacheUpdate:!0,error:!1}}if("1404538773065"!==document.body.getAttribute("ver")){var cErr=util.hasURLParam("cacheError");if(require(["globals"],function(g){g.reportError(new Error("VersionMismatch, CacheError: "+cErr))}),!cErr)return this.sendToApp("resetCache"),{cacheUpdate:!0,error:!0}}},actionVerb:function actionVerbFn(){return this.touch?"tap":"click"},actionVerbCaps:function actionVerbCapsFn(){return this.touch?"Tap":"Click"},updateOrientation:function updateOrientationFn(){var orientation=90==Math.abs(window.orientation)?Orientation.Landscape:Orientation.Portrait;return this.orientation==Orientation.Portrait&&(this.hasBeenPortrait=!0),this.orientation=orientation,this.app||(this.kbsize=this.orientation==Orientation.Portrait?this.kbsizePortrait:this.kbsizeLandscape),this.orientation},sendToApp:function sendToAppFn(method,data){if(this.app)if(this.ios){this.iframeApp||(this.iframeApp=document.createElement("IFRAME"),this.iframeApp.setAttribute("height","1px"),this.iframeApp.setAttribute("width","1px"),document.documentElement.appendChild(this.iframeApp));var href="duchess://"+method;void 0!==data&&(href+="//"+data),this.iframeApp.setAttribute("src",href)}else this.android&&void 0!==AppInterface&&(void 0!==AppInterface.sendMessage&&null!==AppInterface.sendMesage?AppInterface.sendMessage(method,data):require(["globals"],function(g){g.reportError(new Error("Missing AppInterface.sendMessage from app"))}))}},new platform}),this.document&&(window.dateWrapper=dateWrapper),this.dateLibLoaded||dateWrapper(),define("date",function(){}),define("globals",["ko","platform","util","date"],function(ko,platform,util){function murmurhash3_32_gc(key,seed){var remainder,bytes,h1,h1b,c1,c1b,c2,c2b,k1,i;for(remainder=3&key.length,bytes=key.length-remainder,h1=seed,c1=3432918353,c2=461845907,i=0;bytes>i;)k1=255&key.charCodeAt(i)|(255&key.charCodeAt(++i))<<8|(255&key.charCodeAt(++i))<<16|(255&key.charCodeAt(++i))<<24,++i,k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1,h1=h1<<13|h1>>>19,h1b=5*(65535&h1)+((5*(h1>>>16)&65535)<<16)&4294967295,h1=(65535&h1b)+27492+(((h1b>>>16)+58964&65535)<<16);switch(k1=0,remainder){case 3:k1^=(255&key.charCodeAt(i+2))<<16;case 2:k1^=(255&key.charCodeAt(i+1))<<8;case 1:k1^=255&key.charCodeAt(i),k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1}return h1^=key.length,h1^=h1>>>16,h1=2246822507*(65535&h1)+((2246822507*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>13,h1=3266489909*(65535&h1)+((3266489909*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>16,h1>>>0}function sanitizePaneState(stateObj){try{for(var stateOut=JSON.parse(JSON.stringify(stateObj)),i=0;i<stateOut.length;++i)""!==stateOut[i].search&&(stateOut[i].search="HasSearch");return JSON.stringify(stateOut)}catch(err){return"Failed to sanitize pane state"}}function sanitizeLocalSettings(settingsIn){try{var settingsOut=JSON.parse(settingsIn);return delete settingsOut.paneState,delete settingsOut.gdocTitle,JSON.stringify(settingsOut)}catch(err){return"Failed to parse settings"}}function sanitizeKey(keyIn){switch(keyIn){case KeyCode.BackSpace:return"BACKSPACE";case KeyCode.Delete:return"DELETE";case KeyCode.Enter:return"ENTER";case KeyCode.Escape:return"ESCAPE";default:return"CHAR"}}function generateRemoteDebugKey(){var user=self.settings.get("activeUser");return user?"MooDoRDebug"+(new Date).getTime()+"_"+user:"Unknown"}function tagEvent(e,info,handlers){e.id||(e.id=eventID++)}function replaceFunction(obj,name){var rep=obj.prototype[name];obj.prototype[name]=function(){log(this.activeHandler?this.type+"."+name+" "+self.elementToString(this.target)+self.elementToString(this.activeHandler.owner):this.type+"."+name+" "+self.elementToString(this.target)+"[NOTTAGGED]");var stack=self.getCurrentStack(),call={fn:name,handler:this.activeHandler?this.activeHandler.owner:"NOTTAGGED",stack:stack};this.calls?this.calls.push(call):this.calls=[call],rep.call(this)}}function fnCatch(cb){try{self.PAssert(801,cb,"Must specify a callback")}catch(PERR){g.reportError(PERR)}return function dbgCatch(){try{if(cb)return cb.apply(void 0,arguments)}catch(err){self.reportError(err,arguments)}}}function readyStateCallback(e,callback){e.onloadDone=!1,e.onload=function(){e.onloadDone=!0,callback&&callback()},e.onReadystatechange=function(){"loaded"!==e.readyState||e.onloadDone||(e.onloadDone=!0,callback&&callback())}}function makeString(args){for(var str="",i=0;i<args.length;++i)str+=" "+self.safeStringify(args[i]);return str}function getTextNodesIn(element){function getTextNodes(node){if(node)if(node.nodeType===Node.TEXT_NODE)nodes.push(node);else for(var i=0;i<node.childNodes.length;++i){var el=node.childNodes[i];getTextNodes(el)}}var nodes=[];return getTextNodes(element),nodes}function getOffsetChildElement(element,offset){for(var totalOffset=0,children=getTextNodesIn(element),i=0;i<children.length;++i){var childLength=children[i].length;if(totalOffset+childLength>=offset)return{element:children[i],offset:offset-totalOffset};totalOffset+=childLength}try{self.PAssert(812,!1,"Unable to find offset child element")}catch(PERR){g.reportError(PERR)}return void 0}function getElementLength(element){for(var children=getTextNodesIn(element),total=0,i=0;i<children.length;++i)total+=children[i].length;return total}function hasValidClass(el){return self.hasClass(el,"text")||"androidInput"===el.id&&android.isEnabled()}function performScroll(){var minSpeed=2,maxSpeedAdd=12,scroller=lastState.pane.getScroller(),diff=minSpeed+maxSpeedAdd*lastState.speed;scroller.scrollTop+=diff,runScroll&&requestAnimationFrame(performScroll)}function searchVMLIArray(options,array){for(var i=0;i<array.length;++i)options.comparator?options.comparator(array[i])&&options.action(array[i]):options.each&&options.each(array[i]),options.item=array[i],self.searchVMLIs(options)}function getMapping(obj,map){try{self.PAssert(850,"string"!=typeof obj,"Should only pass objects to the obj mapping function",obj)}catch(PERR){g.reportError(PERR)}var target={};for(var i in obj){try{self.PAssert(851,obj.hasOwnProperty(i),"This should always be the case, the prototype shouldn't be extended")}catch(PERR){g.reportError(PERR)}if(void 0!==obj[i]&&null!==obj[i]){var mappedField=map[i];if(mappedField)target[mappedField]=obj[i];else{try{self.PAssert(852,!1,"Incoming field should be added to the field map",i)}catch(PERR){g.reportError(PERR)}target[i]=obj[i]}}}return target}function fireKeyEventInternal(ele,etype,key){try{self.PAssert(859,void 0!==key,"Must pass in valid key data to type")}catch(PERR){g.reportError(PERR)}if(!ele){var selection=self.getSelectionInfo();selection?ele=selection.node:android.isEnabled()&&(ele=android.getCurrentSpan())}if(document.createEvent&&ele){var eventObj=document.createEvent("Event");eventObj.normCode=key.normCode,eventObj.shiftKey=!!key.shiftKey,eventObj.synthetic=!0,eventObj.initEvent(etype,!0,!0),ele.dispatchEvent(eventObj)}else try{self.PAssert(860,!1,"Unable to fire key event")}catch(PERR){g.reportError(PERR)}}function fireClickEventInternal(ele,etype,button){try{self.PAssert(861,void 0!==button,"Must pass in a valid button to click with")}catch(PERR){g.reportError(PERR)}if(!ele){var selection=self.getSelectionInfo();selection&&(ele=selection.node)}if(document.createEvent){var evObj=document.createEvent("Event");evObj.button=button,evObj.synthetic=!0,evObj.initEvent(etype,!0,!0),ele.dispatchEvent(evObj)}else try{self.PAssert(862,!1,"Unable to fire click event")}catch(PERR){g.reportError(PERR)}}function loadDone(cb){document.removeEventListener("DOMContentLoaded",loadDone,!1),window.removeEventListener("load",loadDone,!1);for(var i=0;i<onLoadCallbacks.length;++i)onLoadCallbacks[i]();onLoadCallbacks=void 0}function generateQueryString(data){var queryString="";if("object"==typeof data){var queryArr=[];for(key in data)queryArr[queryArr.length]=encodeURIComponent(key)+"="+encodeURIComponent(data[key]);queryString=queryArr.join("&").replace(/%20/g,"+")}else{try{self.PAssert(891,"string"==typeof data,"Only Objects or Strings are currently supported")}catch(PERR){g.reportError(PERR)}queryString=data}return queryString}var self={vmMain:void 0,vmDebug:void 0,topBarHeight:40,phoneMainY:40,topBoxHeight:platform.phone?50:150,keyboardToolbarHeight:40,hasFocus:!0,zoomTime:0,demoMode:!1,intro:void 0,focusedPaneID:void 0,focusedPane:void 0,focusedItem:void 0,isScrolling:!1,ClickThreshold:5,noLocalWrites:!1,isLoadingRemote:!1,revealingMenu:!1,isKeyboardOpen:!1,dragging:void 0,draggingHidden:void 0,dragStartInfo:{x:0,y:0},dragStartTimeout:void 0,startDrag:void 0,itemMenuOpenedOn:void 0,tempUL:document.getElementById("tempUL"),elements:{}},g=self,android={isEnabled:function(){return!!platform.android}};require(["android"],function(droidLoad){android=droidLoad});var VMLI;require(["VMLI"],function(VMLILoad){VMLI=VMLILoad}),window.KeyCode={BackSpace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Escape:27,Space:32,PageUp:33,PageDown:34,Hash:35,Home:36,LeftArrow:37,UpArrow:38,RightArrow:39,DownArrow:40,Delete:46,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D8:56,LAngle:60,RAngle:62,At:64,A:65,B:66,E:69,F:70,G:71,I:73,N:78,O:79,S:83,U:85,V:86,Y:89,Z:90,LeftMeta:91,RightMeta:93,NumPlus:107,F4:115,Equals:187,Comma:188,Dash:189,Period:190,Slash:191,Tilde:192,LBracket:219,RBracket:221,Apos:222},window.TextSpace="﻿",self.PhoneWidth=480,window.DriveStatus={Offline:0,Connecting:1,Saving:2,Saved:3,Reconnecting:4},window.PaneMode={Normal:1,Timeline:2},window.MessageAction={Default:0,Reload:1,Login:2,Demo:3,ResetClient:4,None:5,SyncContacts:6},window.MessageType={Info:0,Warning:1,Error:2,Fatal:3,Subtitle:4,Intro:5,RequiredUpdate:6,InfoGray:7,MobileOffline:8},window.MessageID={Undefined:0,ConnectionError:1,OfflineUndo:2,FatalError:3,DocChange:4,OfflineWarn:5,OnlineInfo:6,CacheReset:7,RequiredUpdate:8,Updated:9,MobileOffline:10,SyncContacts:11},window.VMLIFlag={None:0,Header:1,Collapsed:2,Selected:4,Highlighted:8,NumList:16,Complete:4096,P2:8192,P1:16384,P0:32768,Flagged:65536},window.VersionType={Structure:1,Text:2},window.SaveFlag={None:0,Prop:1,Text:2,All:3},window.PropChangeType={None:0,Date:2,Complete:4,Archive:8,Flagged:16,Priority:32,All:63},window.LoginState={NONE:0,LOGGED_OUT:1,LOGGED_IN:2},self.isFlagSet=function isFlagSetFn(data,mask){return(data&mask)===mask},self.isAtLeastOneFlagSet=function isAtLeastOneFlagSetFn(data,mask){return 0!==(data&mask)},self.PCFMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Complete|VMLIFlag.Flagged,self.PCMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Complete,self.PFMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Flagged,self.PMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2,self.fieldMapIn={id:"id",items:"i",archivedItems:"ai",text:"t",modifiedOffline:"l",modifiedOfflineText:"o",versionText:"u",version:"v",formats:"f",isArchived:"a",isDeleted:"x",isCollapsed:"m",date:"d",dateText:"s",allDayDate:"ad",dateCreated:"c",dateCompleted:"^",priority:"p",isComplete:"z",isFlagged:"*"},self.priorityMapOut={},self.priorityMapOut[VMLIFlag.None]=" ",self.priorityMapOut[VMLIFlag.P0]=" p0",self.priorityMapOut[VMLIFlag.P1]=" p1",self.priorityMapOut[VMLIFlag.P2]=" p2",window.NumListPrefix="#.",window.NumListPrefixOther="1.",window.DatePrefix="@",window.ContactPrefix="+",self.getTransitionClass=function getTransitionClassFn(time){var trans;switch(time){case 50:trans="trans05";break;case 100:trans="trans1";break;case 200:trans="trans2";break;case 300:trans="trans3";break;case 400:trans="trans4";break;case 500:trans="trans5";break;case 1e3:trans="trans10";break;default:console.log("ERROR: no time for ",time)}return trans},self.setTransformStyle=function setTransformStyleFn(element,x,y){try{self.PAssert(760,element,"Must provide a valid element")}catch(PERR){g.reportError(PERR)}if(element){try{self.PAssert(761,void 0!==x,"Must supply a valid X offset")}catch(PERR){g.reportError(PERR)}try{self.PAssert(762,void 0!==y,"Must supply a valid Y offset")}catch(PERR){g.reportError(PERR)}element.style[platform.transform.style]=platform.ie?"translate("+x+"px, "+y+"px)":"translate3d("+x+"px, "+y+"px, 0px)"}},self.setTransitionStyle=function setTransitionStyleFn(element,property,time,easing){try{self.PAssert(763,element,"Must provide a valid element")}catch(PERR){g.reportError(PERR)}element&&(easing=easing||"ease",element.style[platform.transition.style]=property+" "+time+"ms "+easing,setTimeout(function(){element.style[platform.transition.style]=""},time))};var IE_ANIM_WORKAROUND=!1;self.setTransform=function setTransformFn(element,x,y,time,easing){time>0?IE_ANIM_WORKAROUND?self.setTransformStyle(element,x,y):(self.setTransitionStyle(element,platform.transform.prop,time,easing),self.setTransformStyle(element,x,y)):x||y?self.setTransformStyle(element,x,y):element.style[platform.transform.style]="none"},self.reload=function reloadFn(){try{self.PAssert(764,!appCacheUpdating,"Page should not be reloaded while waiting for an appcache update to finish.")}catch(PERR){g.reportError(PERR)}appCacheUpdating&&self.reportError(new Error("Page requesting reload while waiting for AppCache update.")),window.location.reload()},self.isSetupPageOpen=!1,self.isMainPageOpen=!1,self.openMainPage=function openMainPageFn(){self.isSetupPageOpen&&(self.isSetupPageOpen=!1),self.isMainPageOpen||(self.isMainPageOpen=!0);var outer=document.getElementById("outerWrapper"),setup=document.getElementById("setupWrapper");outer&&setup&&(self.removeClass(outer,"none"),self.addClass(setup,"none")),platform.mobile&&setTimeout(function(){g.ScreenManager.computeSnapPoints(),platform.mobileie&&g.ScreenManager.scrollToScreen(window.Screens.List,0)}.bind(this),0)},self.openSetupPage=function openSetupPageFn(){self.isMainPageOpen&&(self.isMainPageOpen=!1),self.addClass(document.getElementById("outerWrapper"),"none"),self.removeClass(document.getElementById("setupWrapper"),"none")};var wasAppCacheUpdated=!1,appCacheUpdating=!1;self.setAppCacheUpdateState=function setAppCacheUpdateStateFn(state){appCacheUpdating=state,state&&(wasAppCacheUpdated=!0)},self.isEmpty=function isEmptyFn(object){for(var i in object)return!1;return!0},self.isEmail=function isEmailFn(string){var regex=new RegExp(/.+@.+\..+/i),results=regex.exec(string);return!!results},self.removeDOM=function removeDOMFn(id){var domElem=document.getElementById(id);try{self.PAssert(765,domElem,"DOM Element must exist to remove it")}catch(PERR){g.reportError(PERR)}domElem&&domElem.parentNode.removeChild(domElem)},self.isRunningScript=function isRunningScriptFn(){return self.AScript&&self.AScript.isRunning};var isOffline=!1;self.goOnline=function goOnlineFn(){self.noLocalWrites&&!self.isDemoMode()&&(self.messageQueue.clearMessage(MessageID.OfflineWarn),self.messageQueue.pushMessage(MessageID.OnlineInfo)),isOffline=!1},self.goOffline=function goOfflineFn(){self.noLocalWrites&&!self.isDemoMode()&&(self.messageQueue.clearMessage(MessageID.OnlineInfo),self.messageQueue.pushMessage(MessageID.OfflineWarn)),isOffline=!0},self.isOffline=function isOfflineFn(){return isOffline},self.preventLocalWrites=function preventLocalWritesFn(){ShouldLog(LogLevels.Warning)&&log("---- WARNING: Local Writes Disabled ----"),isOffline&&!self.isDemoMode()&&(self.messageQueue.clearMessage(MessageID.OnlineInfo),self.messageQueue.pushMessage(MessageID.OfflineWarn)),self.noLocalWrites=!0},self.shouldWriteLocal=function shouldWriteLocalFn(){return!self.noLocalWrites},self.enableDemoMode=function enableDemoModeFn(){self.demoMode=!0;var dmode=util.getURLParam("dmode");dmode&&self.enableMinMode(dmode),platform.mobile||platform.script||self.activeDisplayMode&DisplayMode.NoDemoSidebar||self.messageQueue.pushMessage({text:"You are in demo mode, your information is not being saved. Click here to leave.",type:MessageType.Info,action:MessageAction.Login}),self.preventLocalWrites()},self.isDemoMode=function isDemoModeFn(){return self.demoMode},window.DisplayMode={Default:0,NoTopBar:1,NoPaneHeaders:2,ForceTwoPane:4,NoScrollbars:8,NoBackground:16,NoPaneTop:32,NoInteraction:64,NoPanePadding:128,NoPaneStyle:256,NoRightClick:512,ShowBanner:1024,NoDemoSidebar:2048,FullMin:4095},self.activeDisplayMode=DisplayMode.Default,self.isDisplayModeActive=function isDisplayModeActiveFn(mode){return(self.activeDisplayMode&mode)===mode},self.enableMinMode=function enableMinModeFn(mode){try{if(mode=parseInt(mode),("Trident"===platform.browser||platform.android===!0)&&(mode|=DisplayMode.NoScrollbars,mode|=DisplayMode.NoInteraction),!platform.touch){if(mode&DisplayMode.NoTopBar){var desktopMenu=document.getElementById("desktopMenu");desktopMenu&&self.addClass(desktopMenu,"none");var container=document.getElementById("container");container&&(container.style.top="0px");for(var panes=document.getElementsByClassName("pane"),i=0;i<panes.length;++i)panes[i]&&(panes[i].style.marginTop="0px",panes[i].style.height="100%")}mode&DisplayMode.NoPaneHeaders&&self.addClass(document.body,"noPaneHeaders"),mode&DisplayMode.NoPaneTop&&self.addClass(document.body,"noPaneTopBox"),mode&DisplayMode.NoPaneStyle&&self.addClass(document.body,"noPaneStyle")}if(mode&DisplayMode.NoPaneTop&&self.addClass(document.body,"noPanePadding"),mode&DisplayMode.NoScrollbars&&self.addClass(document.body,"noScrollbars"),mode&DisplayMode.NoBackground){var html=document.getElementsByTagName("html")[0];try{self.PAssert(766,html,"Must have a valid HTML element")}catch(PERR){g.reportError(PERR)}html&&self.addClass(html,"noBackground")}if(mode&DisplayMode.NoInteraction){var grabber=document.getElementById("preventInteraction");grabber&&(self.removeClass(grabber,"none"),grabber.addEventListener("mousewheel",function(e){return e.stopImmediatePropagation(),!1},!0),grabber.addEventListener("mousedown",function(e){return e.preventDefault(),e.stopImmediatePropagation(),!1},!0),grabber.addEventListener("keydown",function(e){return e.preventDefault(),e.stopImmediatePropagation(),!1},!0))}mode&DisplayMode.ShowBanner&&!(mode&DisplayMode.NoInteraction)?self.removeClass(document.getElementById("cornerBannerMessage"),"none"):self.removeDOM("cornerBannerMessage"),self.activeDisplayMode=parseInt(mode)}catch(err){self.reportError(err)}},self.sendEvent=function sendEventFn(category,action,value){try{self.PAssert(767,!self.isString(value),"Values must be numeric")}catch(PERR){g.reportError(PERR)}window.ga&&!self.isDemoMode()&&ga("send","event",category,action,self.getAnonUserIdentifier(),value)},self.sendTimeEvent=function sendTimeEventFn(category,variable,value){try{self.PAssert(768,!self.isString(value),"Values must be numeric")}catch(PERR){g.reportError(PERR)}window.ga&&!self.isDemoMode()&&ga("send","timing",category,variable,value,self.getAnonUserIdentifier())};var currentTimeEvent=void 0;self.startTimeEvent=function startTimeEventFn(category,variable){if(log&&log.now){try{self.PAssert(769,void 0===currentTimeEvent,"This function needs to be updated to allow nested timing events")}catch(PERR){g.reportError(PERR)}currentTimeEvent={startTime:log.now(),category:category,variable:variable}}},self.endTimeEvent=function endTimeEventFn(){if(log&&log.now){try{self.PAssert(770,void 0!==currentTimeEvent,"Must have started a timing event")}catch(PERR){g.reportError(PERR)}var elapsedTime=log.now()-currentTimeEvent.startTime;self.sendTimeEvent(currentTimeEvent.category,currentTimeEvent.variable,elapsedTime),currentTimeEvent=void 0}};var aggregateEvents={};self.registerEvent=function registerEventFn(name,category,action){try{self.PAssert(771,!aggregateEvents.hasOwnProperty(name),"Should only register an event once")}catch(PERR){g.reportError(PERR)}try{self.PAssert(772,void 0!==name,"Must specify a name for the event")}catch(PERR){g.reportError(PERR)}try{self.PAssert(773,void 0!==category,"Must specify a category for the event")}catch(PERR){g.reportError(PERR)}try{self.PAssert(774,void 0!==action,"Must specify an action for the event")}catch(PERR){g.reportError(PERR)}var registerEvent={category:category,action:action,label:self.getAnonUserIdentifier(),count:0};aggregateEvents[name]=registerEvent},self.aggregateEvent=function aggregateEventFn(name,count){try{self.PAssert(775,aggregateEvents.hasOwnProperty(name),"Must register an event before using it")}catch(PERR){g.reportError(PERR)}void 0===count&&(count=1),aggregateEvents[name]&&(aggregateEvents[name].count+=count)};var isPageDataCleared=!1;self.pageDataCleared=function pageDataClearedFn(){isPageDataCleared=!0},self.onunload=function onunloadFn(){log("Unloading the page");for(var evName in aggregateEvents){var ev=aggregateEvents[evName];self.sendEvent(ev.category,ev.action,ev.count),ev.count=0}if(self.vmMain&&self.vmMain.failedGapiLoad?self.sendEvent("ScriptLoad","GapiFailed"):gapiCalled||self.sendEvent("ScriptLoad","GapiNotLoaded"),self.vmMain&&self.vmMain.updatePaneScrollState(),!isPageDataCleared){var gdata=require("gdata");gdata&&self.settings.set(Settings.lastServerVersion,gdata.getServerVersion())}return self.isLoadingRemote?"We are still syncing your changes, are you sure you want to exit?":void 0},platform.demo||platform.packagedApp||(window.onbeforeunload=self.onunload);var lastSetLoginState=LoginState.LOGGED_OUT;self.getLoginState=function getLoginStateFn(){var state=lastSetLoginState;if(self.shouldWriteLocal())try{var savedState=util.storage.getItem("loginState");null!==savedState&&void 0!==savedState&&(state=parseInt(savedState))}catch(err){self.reportError(err)}try{self.PAssert(776,state===LoginState.NONE||state===LoginState.LOGGED_OUT||state===LoginState.LOGGED_IN,"Invalid login state set")}catch(PERR){g.reportError(PERR)}return state},self.setLoginState=function setLoginStateFn(value){try{self.PAssert(777,null!==value&&void 0!==value&&!isNaN(value),"Should always be a valid LoginState enum value")}catch(PERR){g.reportError(PERR)}if(lastSetLoginState=value,self.shouldWriteLocal())try{(isNaN(value)||null===value||void 0===value)&&(value=LoginState.LOGGED_OUT);try{self.PAssert(778,value===LoginState.NONE||value===LoginState.LOGGED_OUT||value===LoginState.LOGGED_IN,"Invalid login state set")}catch(PERR){g.reportError(PERR)}util.storage.setItem("loginState",value)}catch(err){self.reportError(err)}},window.Settings={theme:"theme",syncContacts:"syncContacts",lastContactSync:"lastContactSync",disableNotifications:"disableNotifications",docSharing:"docSharing",authScopes:"authScopes",localIntegrity:"localIntegrity",paneState:"paneState",localDataVersion:"localDataVersion",shownTutorial:"shownTutorial",gdocId:"gdocId",gdocTitle:"gdocTitle",activeUser:"activeUser",noSounds:"noSounds",noLocalWrites:"noLocalWrites",lastMessageSync:"lastMessageSync",lastServerVersion:"lastServerVersion",helpPaneState:"helpPaneState",shownInstallInfo:"shownInstall"};var ignoreSettings=[Settings.localIntegrity,Settings.paneState,Settings.authScopes,Settings.localDataVersion,Settings.shownTutorial,Settings.lastContactSync,Settings.disableNotifications,Settings.gdocId,Settings.gdocTitle,Settings.activeUser,Settings.noSounds,Settings.lastMessageSync,Settings.lastServerVersion,Settings.noLocalWrites,Settings.lastMessageSync];if(self.settings={settings:{},prefix:"V~",init:function initFn(){try{util.storage.setItem("poke",0)}catch(err){self.preventLocalWrites()}this.ensureLocalCopy()},initEvents:function initEventsFn(fn){try{self.PAssert(779,fn,"Must supply a callback function")}catch(PERR){g.reportError(PERR)}self.shouldWriteLocal()&&window.addEventListener("storage",function(e){if(e||(e=window.event),fn(e),"localSettings"===e.key)try{this.settings=e.newValue?JSON.parse(e.newValue):{}}catch(err){self.reportError(err),this.settings={}}}.bind(this),!1)},ensureLocalCopy:function ensureLocalCopyFn(forceSync){try{self.PAssert(780,void 0===forceSync,"Invalid caller param forceSync")}catch(PERR){g.reportError(PERR)}if(self.shouldWriteLocal()&&(forceSync||self.isEmpty(this.settings)))try{var storValue=util.storage.getItem("localSettings");this.settings=storValue?JSON.parse(storValue):{}}catch(err){self.reportError(err),this.settings={}}},flushLocalCopy:function flushLocalCopyFn(){if(self.shouldWriteLocal())try{util.storage.setItem("localSettings",JSON.stringify(this.settings))}catch(err){self.reportError(err)}},set:function setFn(property,value,remoteVersion){try{self.PAssert(781,void 0!==property&&null!==property,"Must specify a valid property name")}catch(PERR){g.reportError(PERR)}try{self.PAssert(782,!property.startsWith(this.prefix),"Use setVersion to set version properties")}catch(PERR){g.reportError(PERR)}this.ensureLocalCopy(),null===remoteVersion&&(remoteVersion=0);var oldValue=this.settings[property],localVersion=this.getVersion(property),writeProperty=!1;if(oldValue!==value||"object"==typeof value){if(void 0===remoteVersion){if(writeProperty=!0,localVersion>=0&&ignoreSettings.indexOf(property)<0){var oldVersion=this.getVersion(property);this.settings[this.prefix+property]=-(oldVersion+1)}}else{try{self.PAssert(783,remoteVersion>=0,"Remote version must be positive")}catch(PERR){g.reportError(PERR)}writeProperty=this.isPropertyNewer(property,remoteVersion),writeProperty&&(this.settings[this.prefix+property]=remoteVersion)}writeProperty&&(this.settings[property]=value,ignoreSettings.indexOf(property)<0&&(self.fireCustomEvent("settingsChange",{property:this.prefix+property,value:this.settings[this.prefix+property],isRemote:void 0!==remoteVersion}),self.fireCustomEvent("settingsChange",{property:property,value:value,isRemote:void 0!==remoteVersion}))),this.flushLocalCopy()}return writeProperty},get:function getFn(property,forceSync){try{self.PAssert(784,void 0!==property&&null!==property,"Must specify a valid property name")}catch(PERR){g.reportError(PERR)}return this.ensureLocalCopy(forceSync),this.settings[property]},getVersion:function getVersionFn(property,forceSync){try{self.PAssert(785,void 0!==property&&null!==property,"Must specify a valid property name")}catch(PERR){g.reportError(PERR)}return this.ensureLocalCopy(forceSync),this.settings[this.prefix+property]||0},setVersion:function setVersionFn(property,value,forceSync){try{self.PAssert(786,void 0!==property&&null!==property,"Must specify a valid property name")}catch(PERR){g.reportError(PERR)}try{self.PAssert(787,property.startsWith(this.prefix),"Setting versions requires a version property name")}catch(PERR){g.reportError(PERR)}try{self.PAssert(788,value>=0,"Versions should always be positive")}catch(PERR){g.reportError(PERR)}this.ensureLocalCopy(forceSync),this.settings[property]=value},reset:function resetFn(property){if(property)this.ensureLocalCopy(),delete this.settings[property],this.flushLocalCopy();else if(this.settings={},self.shouldWriteLocal())try{util.storage.setItem("localSettings","{}")}catch(err){self.reportError(err)}},resetAll:function resetAllFn(skip){var newSettings={};if(skip)for(var i=0;i<skip.length;++i)newSettings[skip[i]]=this.settings[skip[i]];if(this.settings=newSettings,skip)this.flushLocalCopy();else if(self.shouldWriteLocal())try{util.storage.setItem("localSettings","{}")}catch(err){self.reportError(err)}},isPropertyNewer:function isPropertyNewerFn(property,version){try{self.PAssert(789,void 0!==version&&null!==version&&version>=0,"Remote versions should always be positive")}catch(PERR){g.reportError(PERR)}var selfVersion=this.getVersion(property);try{self.PAssert(790,void 0!==selfVersion&&null!==selfVersion,"Self version should always be valid")}catch(PERR){g.reportError(PERR)}return Math.abs(selfVersion)<Math.abs(version)},getRawSettings:function getRawSettingsFn(){var rawSettings;if(self.shouldWriteLocal())try{rawSettings=util.storage.getItem("localSettings")}catch(err){self.reportError(err)}else try{return JSON.stringify(this.settings)}catch(err){return self.reportError(err),'{m: "Invalid Settings"}'}return rawSettings}},REPORT_ACTIONS){window.ResolveAction={Error:1,SetRemoteText:2,SetLocalText:4,DupeItem:8,AddLocalItem:16,RemoveRemoteItem:32,AddBackDeletedItem:64,LocalMoveCandidate:128,MoveLocalItem:256,DeleteLocalItem:512,MoveRemoteItem:1024},window.RATAG={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,O:13,P:14,Q:15,R:16,S:17};var noSync=util.hasURLParam("nosync")||util.hasURLParam("demo");noSync||console.log("%cGenerating Sync Report - use #noSync=true to disable and __syncReport.printList() to view.","color: green");var syncReport=[];self.reportAction=function reportActionFn(tag,type,info){noSync||syncReport.push({tag:tag,type:type,info:info,tagString:self.enumToString(window.RATAG,tag),typeString:self.enumToString(window.ResolveAction,type)})},self.reportActionCrash=function reportActionCrashFn(sErr){self.reportAction(RATAG.S,ResolveAction.Error,{msg:sErr.message,stack:sErr.stack})},window.DataSnapshot={Before:0,After:1};var snapshots=[];self.reportData=function reportDataFn(data,loc){snapshots[loc]=JSON.stringify(data)},window.__syncReport={print:function printFn(){return syncReport},printList:function printListFn(){if(noSync)return"Sync Report Disabled";if(0===syncReport.length)return"No Actions Perfomed in Sync";for(var i=0;i<syncReport.length;++i){var tt=syncReport[i];log("Action: ",{type:tt.typeString,tag:tt.tagString,info:tt.info})}return"Actions Complete"},filterType:function filterTypeFn(type){return syncReport.filter(function(item){return item.type===type})},filterTag:function filterTagFn(tag){return syncReport.filter(function(item){return item.tag===tag})},getData:function getDataFn(){var syncData={snapshotBefore:snapshots[DataSnapshot.Before],actions:JSON.stringify(syncReport),snapshotAfter:snapshots[DataSnapshot.After]};
return syncData},getSaveData:function getSaveDataFn(){var syncData=this.getData();return JSON.stringify(syncData)},save:function saveFn(){var blob=new Blob([this.getSaveData()],{type:"text/plain;charset=utf-8"});saveAs(blob,"SyncReport.json")},view:function viewFn(){self.XHR({type:"POST",url:window.location.protocol+"//"+window.location.host+"/debug/sendSyncReport",data:this.getSaveData(),cb:function cbFn(xhr){if(log("SyncReport Response: ",xhr),200===xhr.status)try{var reportInfo=JSON.parse(xhr.responseText);window.location=window.location.protocol+"//"+window.location.host+"/syncReport?"+reportInfo.reportID}catch(err){log("Error parsing SyncReport Response: "+err.message)}else log("Remote Sync Report Error: ",xhr.status,xhr.responseText)}})}}}self.applyBindings=function applyBindingsFn(model,eleID){var elem=document.getElementById(eleID);try{self.PAssert(791,model,"A valid model must be defined when apply bindings")}catch(PERR){g.reportError(PERR)}try{self.PAssert(792,elem,"A valid element must be defined when apply bindings")}catch(PERR){g.reportError(PERR)}if(elem&&model)try{ko.applyBindings(model,elem)}catch(err){throw err.message+=" | Binding on: "+self.elementToString(elem),self.reportError(err),err}else{var errStr="Invalid model or element passed to applyBindings | ";errStr+=elem?"NoModel - Elem: "+self.elementToString(elem):model?"NoElem - Elem: #"+eleID:"NoModelNoElem - Elem: #"+eleID,self.reportError(new Error(errStr))}},ko.observable.fn.toString=function(){return"observable: "+ko.toJSON(this(),null,2)},ko.computed.fn.toString=function(){return"computed: "+ko.toJSON(this(),null,2)},ko.bindingHandlers.load={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel,context){try{self.PAssert(793,viewModel.onLoad,"If no load function is specified, remove the binding from the template")}catch(PERR){g.reportError(PERR)}var pIndex=context.$parents.length-2,paneRoot;pIndex>=0&&(paneRoot=context.$parents[pIndex]),viewModel.onLoad(element,paneRoot)}},ko.bindingHandlers.check={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){var obs=valueAccessor();obs()&&self.addClass(element,"checked"),self.setupClick(element,viewModel,{onClick:function onClickFn(e){obs(!obs()),obs()?self.addClass(element,"checked"):self.removeClass(element,"checked"),e.preventDefault(),e.stopPropagation()}})},update:function updateFn(element,valueAccessor,allBindingsAccessor,viewModel){var obs=valueAccessor();obs()?self.addClass(element,"checked"):self.removeClass(element,"checked")}},ko.bindingHandlers.tap={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){self.setupClick(element,viewModel,valueAccessor())}},ko.bindingHandlers.stopBinding={init:function initFn(){return{controlsDescendantBindings:!0}}},ko.bindingHandlers.possHTML={init:function initFn(){return{controlsDescendantBindings:!0}},update:function updateFn(element,valueAccessor,allBindingsAccessor,viewModel){viewModel.isStyled?element.innerHTML=ko.utils.unwrapObservable(valueAccessor()):element.textContent=ko.utils.unwrapObservable(valueAccessor())}},ko.bindingHandlers.tooltip={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){platform.mobile||self.setupMouseOver(element,ko.utils.unwrapObservable(valueAccessor()),!1)},update:function updateFn(element,valueAccessor,allBindingsAccessor,viewModel){platform.mobile||self.setupMouseOver(element,ko.utils.unwrapObservable(valueAccessor()),!0)}},self.setupMouseOver=function setupMouseOverFn(element,value,isUpdate){try{self.PAssert(794,!platform.mobile)}catch(PERR){g.reportError(PERR)}self.tooltip?isUpdate?self.tooltip.update(element,value):self.tooltip.register(element,value):self.reportError(new Error("Tooltips registered before VMTooltip created"))},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(str){return 0===this.lastIndexOf(str,0)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(str){return-1!==this.indexOf(str,this.length-str.length)}),ko.bindingHandlers.css2=ko.bindingHandlers.css,self.findFirstDiff=function findFirstDiffFn(str1,str2,ignoreCase){if(!str1)return str2.length;if(!str2)return str1.length;for(var minLen=Math.min(str1.length,str2.length),i=0;minLen>i;++i)if(ignoreCase){if(str1.charAt(i).toLowerCase()!==str2.charAt(i).toLowerCase())return i}else if(str1.charAt(i)!==str2.charAt(i))return i;return Math.max(str1.length,str2.length)},self.findMatchingLength=function findMatchingLengthFn(str1,str2,ignoreCase){if(!str1||!str2)return 0;for(var minLen=Math.min(str1.length,str2.length),i=0;minLen>i;++i)if(ignoreCase){if(str1.charAt(i).toLowerCase()!==str2.charAt(i).toLowerCase())return i}else if(str1.charAt(i)!==str2.charAt(i))return i;return minLen},self.TEMP_PREFIX="~T^";var idx=0;self.generateTempId=function generateTempIdFn(){return self.TEMP_PREFIX+Date.now()+ ++idx},self.isLocalItem=function isLocalItemFn(item){try{self.PAssert(795,item.id,"All items should have an ID even if it is a temp one")}catch(PERR){g.reportError(PERR)}return item.id[0]===self.TEMP_PREFIX[0]&&item.id[1]===self.TEMP_PREFIX[1]&&item.id[2]===self.TEMP_PREFIX[2]},self.getClientInfo=function getClientInfoFn(cb){self.XHR({type:"GET",url:"http://api.hostip.info/get_json.php",cb:function cbFn(xhr){if(200===xhr.status){var clientInfo=JSON.parse(xhr.responseText);cb(clientInfo)}else cb({ip:"Unknown"})}})},self.requestNotification=function requestNotificationFn(platform){var reqForm=document.forms.requestNotification,reqResult=document.getElementById("notificationResult"),email=reqForm.email.value;return void 0===email||null===email||email.length<5?reqResult.innerText="Please enter a valid email address.":self.XHR({type:"POST",url:window.location.protocol+"//api.moo.do/requestNotification",data:{email:email,platform:platform},cb:function cbFn(xhr){200===xhr.status?(reqForm.email.value="",reqResult.innerText="Thanks for your interest!"):reqResult.innerText="There was an error processing your request, please try again in a few minutes."}}),!1};var cachedID=void 0;self.getUserIdentifier=function getUserIdentifierFn(){if(!cachedID){var goog=require("goog"),user=goog.authenticatedUserEmail()||self.settings.get("activeUser");if(!user)return"Unknown";cachedID=user}return cachedID};var anonID=void 0;self.getAnonUserIdentifier=function getAnonUserIdentifierFn(){if(!anonID){var userID=self.getUserIdentifier();anonID=userID[0]+userID[1]+userID[2]+murmurhash3_32_gc(userID,17124123)}return anonID},self.introHash=function introHashFn(str){return murmurhash3_32_gc(str,347236113)},self.getRunningState=function getRunningStateFn(obj){try{var paneState=self.settings.get(Settings.paneState)}catch(err){log("Failed to get paneState")}obj.isDebug=!1,obj.isDemo=self.isDemoMode(),obj.localWrites=self.shouldWriteLocal(),obj.url=window.location.href,obj.paneState=sanitizePaneState(paneState),obj.localSettings=sanitizeLocalSettings(self.settings.getRawSettings()),obj.loginState=self.getLoginState(),obj.checkpoints=window.__checkpoints,obj.gapiLoadError=gapiLoadError,obj.windowWidth=window.innerWidth,obj.windowHeight=window.innerHeight,obj.selection=self.parseExtra(window.getSelection()),obj.eventStream=self.getEventStream(),obj.trackerStream=self.getTrackerStream()},self.getAppInfo=function getAppInfoFn(obj){var gapiStatus="Loaded";self.vmMain&&self.vmMain.failedGapiLoad?gapiStatus="ErrorLoading":gapiCalled||(gapiStatus="NotLoaded"),obj.gapiStatus=gapiStatus,obj.sessionID=window.__SESSION_ID,obj.appCacheUpdated=wasAppCacheUpdated,platform.getPlatformInfo(obj),self.getRunningState(obj),require("gdata").getState(obj)},self.reportSignup=function reportSignupFn(email){try{self.PAssert(796,email,"Must specify a valid email address to signup with")}catch(PERR){g.reportError(PERR)}self.XHR({type:"POST",url:window.location.protocol+"//api.moo.do/reportSignup",data:{email:email},cb:function cbFn(xhr){200!==xhr.status&&ShouldLog(LogLevels.Error)&&log("Failed to report signup",xhr.responseText,xhr)}})};var hasCriticalError=!1;self.criticalErrorReported=function criticalErrorReportedFn(){return hasCriticalError},self.handleCriticalError=function handleCriticalErrorFn(){if(hasCriticalError=!0,self.isDemoMode())self.reload();else{var errorNode=document.createElement("div");errorNode.id="criticalError",errorNode.textContent="There was a critical error while loading the app, "+platform.actionVerb()+" to reload.",platform.isTouchDevice?errorNode.addEventListener(platform.touchStartEvent,function(e){self.reload()},!0):errorNode.addEventListener(platform.upEvent,function(e){self.reload()},!0),self.prependChild(document.body,errorNode),self.removeDOM("outerWrapper"),self.removeDOM("setupWrapper"),self.removeDOM("templates")}},self.safeStringify=function safeStringifyFn(obj){try{return JSON.stringify(obj)}catch(err){log("Error stringify object: "+err.message)}},self.reportEvent=function reportEventFn(e){if(!self.isDemoMode()){var eventString=self.parseExtra(e);self.eventStream.push(eventString)}},self.getEventStream=function getEventStreamFn(){return self.safeStringify(self.eventStream.ordered())},window.__getEventStream=self.getEventStream,self.getTrackerStream=function getTrackerStreamFn(){try{var tracker=require("tracker");return tracker.stringifyGroups()}catch(err){log("Error getting tracker stream: ",err.message)}},self.parseExtra=function parseExtraFn(extra){var extraString;if(extra)try{var info;if(extra instanceof KeyboardEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),target:self.elementToString(extra.target||extra.srcElement),keyCode:sanitizeKey(extra.keyCode),normCode:sanitizeKey(extra.normCode),ctrlKey:extra.ctrlKey,shiftKey:extra.shiftKey,metaKey:extra.metaKey,altKey:extra.altKey,tstamp:Date.now()};else if(extra instanceof window.MouseEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),clientX:extra.clientX,clientY:extra.clientY,ctrlKey:extra.ctrlKey,shiftKey:extra.shiftKey,metaKey:extra.metaKey,altKey:extra.altKey,which:extra.which,button:extra.button,tstamp:Date.now()};else if(window.TouchEvent&&extra instanceof window.TouchEvent){info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),tstamp:Date.now()};var touch=extra.touches[0];touch&&(info.clientX=touch.clientX,info.clientY=touch.clientY)}else if(window.PointerEvent&&extra instanceof window.PointerEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),clientX:extra.clientX,clientY:extra.clientY,tstamp:Date.now()};else if(extra instanceof window.Event)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),tstamp:Date.now()};else if(extra instanceof Selection)if(0===extra.rangeCount)info={rangeCount:0};else{var range=extra.getRangeAt(0),startElement=range.startContainer,startWasTextNode=!1,startElementLength=0,endElement=range.endContainer,endWasTextNode=!1,endElementLength=0;startElement.nodeType===Node.TEXT_NODE&&(startElementLength=startElement.length,startElement=startElement.parentNode,startWasTextNode=!0),self.hasClass(startElement,"text")&&(startElementLength=getElementLength(startElement)),endElement.nodeType===Node.TEXT_NODE&&(endElementLength=endElement.length,endElement=endElement.parentNode,endWasTextNode=!0),self.hasClass(endElement,"text")&&(startElementLength=getElementLength(endElement)),info={rangeCount:extra.rangeCount,startContainer:self.getElementPath(startElement),startWasTextNode:startWasTextNode,startOffset:range.startOffset,startElementLength:startElementLength,endContainer:self.getElementPath(endElement),endWasTextNode:endWasTextNode,endOffset:range.endOffset,endElementLength:endElementLength}}else info=extra;extraString=self.safeStringify(info)}catch(err){log("Error parsing extra "+err.message)}return extraString},window.__jsVersion="1404538773065",self.handleJSError=function handleJSErrorFn(msg,stack,extra,noMsg){function reportError(){var appInfo={};self.getAppInfo(appInfo),self.XHR({type:"POST",url:window.location.protocol+"//api.moo.do/debug/reportError",data:{msg:msg,url:window.location.href,stack:stack,logs:logs,info:JSON.stringify(appInfo),user:user,extra:extraString,jsVersion:window.__jsVersion,htmlVersion:document.body.getAttribute("ver")},cb:function cbFn(xhr){200!==xhr.status?log("Failed to report remote error",xhr.responseText,xhr):log("Reported Remote Error: ",xhr.responseText)}})}if(noMsg||console.error("JS Error: "+msg,"  Stack: ",stack,"  Extra: ",extra),msg||stack)try{var logs=logs=__LOG_BUFFER.ordered().join("\r\n"),user=self.getUserIdentifier(),extraString=self.parseExtra(extra);"Unknown"!==user?reportError():self.getClientInfo(function(info){info&&(user=info.ip),reportError()})}catch(err){log("Badness happened reporting errors to server: ",err)}else;},window.onerror=function(errorMsg,url,lineNumber,colNumber,errorObj){errorObj?(log("Reported Global OnError: "+errorMsg+" Script: "+url+" Line: "+lineNumber+" Column: "+colNumber),self.reportError(errorObj)):(log("Unreported Global OnError: "+errorMsg+" Script: "+url+" Line: "+lineNumber+" Column: "+colNumber),self.reportError(errorMsg))},self.reportError=function reportErrorFn(err,extra){!err||extra||err.message||err.stack||(extra=err,err=void 0),err||(err={message:"Undefined error passed to reporter",stack:self.getCurrentStack("")}),self.handleJSError(err.message,err.stack,extra)},window.__SendInfo=function(text){return self.handleJSError("Remote Client Info",void 0,text,!0),"Thank you for providing your client info!"},window.__CreateDebugSession=function(key){if(window.remote)return"Debug session already started";var debugKey=key||generateRemoteDebugKey();window.rcon=window.console,self.handleJSError("Remote Debug Session",void 0,debugKey,!0),self.addScript("http://jsconsole.com/remote.js?"+debugKey,"rDebugScript");var profileRunning=!1,profileIndex=0,profileName="";return window.rdbg={startProfile:function startProfileFn(forceName){try{return profileRunning?"Profiler already running":(profileName=forceName?forceName:"RDBGProfile_"+profileIndex,window.rcon.profile(profileName),profileRunning=!0,"Profiler Started: "+profileName)}catch(err){return"Error starting profile: "+err.message}},stopProfile:function stopProfileFn(){try{if(profileRunning){window.rcon.profileEnd(profileName),profileRunning=!1;var retString="Profile Completed: "+profileName;return profileName="",profileIndex++,retString}return"Profiler not running, use startProfile()"}catch(err){return"Error stopping profile: "+err.message}}},"Your remote debug session has started: "+debugKey},(util.hasURLParam("rsession")||util.hasURLParam("rdebug","true"))&&setTimeout(function(){var useKey=util.getURLParam("rsession")||generateRemoteDebugKey();window.__CreateDebugSession(useKey),log("%c---- REMOTE DEBUGGING ENABLED: "+useKey+" ----","color: green")},2e3),platform.demo||console.log('%cIf you have been asked to send us your client information or have been seeing issues, please use __SendInfo("MESSAGE") to give us your information.',"color: green"),window.Checkpoint={MainRun:1,RequireLoaded:2,PageLoad:4,LocalDocLoad:8,InitData:16,DBLoaded:32,OnInitializedData:64,InitializeMain:128,MaskRequired:255},self.checkpoint=function checkpointFn(chk){window.__checkpoints|=chk},self.hasSentLowMemoryWarning=ko.observable(!1),self.handleLowMemory=function handleLowMemoryFn(e){self.hasSentLowMemoryWarning()||(self.hasSentLowMemoryWarning(!0),log("Low Memory Event: ",e),self.handleJSError("DeviceLowMemory: "+e,void 0))};var fnRegex=/function\s+([^(]*?)\s*\(([^)]*)\)/,supportSimpleStack=!1;self.getCurrentStack=function getCurrentStackFn(message){if(supportSimpleStack||platform.noErrorStacks)try{var msg=JSON.stringify(message)}catch(err){log("Error stringifying stack message",err,message)}if(supportSimpleStack){var err=new Error(msg||message);if(err.stack)return err.stack}supportSimpleStack=!1;try{for(var callstack=["GenError: "+(msg||message)],currentFunction=arguments.callee.caller,DEPTH_LIMIT=75,depth=0;currentFunction&&depth++<DEPTH_LIMIT;){var fn=currentFunction.toString(),fnMatch=fnRegex.exec(fn),fnName;fnName=fnMatch&&3===fnMatch.length&&""!==fnMatch[1]&&void 0!==fnMatch[1]?"at "+fnMatch[1]+"("+fnMatch[2].replace(/[\r\n]/g,"")+")":fnMatch&&3===fnMatch.length?"at <anonymous> ("+fnMatch[2].replace(/[\r\n]/g,"")+")":"at <anonymous> (<unknown>)",callstack.push(fnName),currentFunction=currentFunction.caller}return callstack.join("\n")}catch(err){log("Error generating stack trace",err)}return""};var remoteUpdateWait=12e5,lastUpdateTime=0;self.checkForRemoteChanges=function checkForRemoteChangesFn(){var currentTime=Date.now();if(lastUpdateTime-currentTime>=remoteUpdateWait)try{self.AppCache.checkForUpdate(),self.messageQueue.updateRemoteMessages()}catch(err){self.reportError(err)}finally{lastUpdateTime=currentTime}},self.createRingBuffer=function createRingBufferFn(len){var p=0,b=[],limit=len;return{get:function getFn(i){return b[i]},push:function pushFn(e){b[p]=e,p=(limit+p+1)%limit},count:function countFn(){return p},reset:function resetFn(){p=0,b=[]},buffer:function bufferFn(){return b},limit:function limitFn(lim){limit=lim},ordered:function orderedFn(){return b.slice(p).concat(b.slice(0,p))},entries:function entriesFn(){for(var arr=this.ordered(),i=0;i<arr.length;++i)console.log("---- Entry ["+i+"] ----"),console.log(arr[i])}}},self.wrapFn=function wrapFnFn(func){function wrapper(){try{return func.apply(this,arguments)}catch(err){var argString;try{argString=JSON.stringify(arguments)}catch(err2){log("Unable to stringify args: ",arguments)}finally{self.reportError(err,argString)}}}return wrapper},function wrapAsyncCallbacks(){var _helper=function _helperFn(fnName){var originalFn=window[fnName];window[fnName]=function wrapAsyncFn(){var args=Array.prototype.slice.call(arguments),originalCallback=args[0];return"function"==typeof originalCallback&&(args[0]=self.wrapFn(originalCallback)),originalFn.apply?originalFn.apply(this,args):originalFn(args[0],args[1])}};_helper("setTimeout"),_helper("setInterval")}();var logBufferLength=platform.mobile?30:50;window.__LOG_BUFFER=self.createRingBuffer(logBufferLength);var oldLog=window.log,logErrorReported;platform.isChrome||(window.log=function(){__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," ")),console.log.apply(console,arguments)});for(var i in oldLog)window.log[i]=oldLog[i];self.isFunction=function isFunctionFn(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)},self.isArray=function isArrayFn(obj){return"[object Array]"===Object.prototype.toString.call(obj)},self.isString=function isStringFn(obj){return"string"==typeof obj},self.isObject=function isObjectFn(obj){return"object"==typeof obj&&null!==obj},self.enumToString=function enumToStringFn(en,value){for(var k in en)if(en[k]==value)return k;return null},self.elementToString=function elementToStringFn(ele,includeLength){if(ele){var nodeString=ele.nodeName;return ele.id&&(nodeString+="#"+ele.id),ele.className&&(nodeString+="."+ele.className),includeLength&&ele.innerText&&(nodeString+=":"+ele.innerText.length),"["+nodeString+"]"}return"[UNDEFINED]"},self.getElementPath=function getElementPathFn(ele,includeLength){var isFirst=!0,path=[];try{for(;ele!==document.documentElement&&ele!==document.body;)path.push(isFirst?self.elementToString(ele,includeLength):self.elementToString(ele)),isFirst=!1,ele=ele.nodeType===Node.TEXT_NODE?ele.parentNode:ele.parentElement}catch(err){path.push(err.message)}return path},self.highlightElement=function highlightElementFn(ele,horizOffset,vertOffset){try{self.PAssert(797,ele,"Must have a valid element to highlight")}catch(PERR){g.reportError(PERR)}if(ele){var horizP=horizOffset||.5,vertP=vertOffset||1,box=ele.getBoundingClientRect(),topOffset=box.top+box.height*vertP,leftOffset=box.left+box.width*horizP;self.showArrowAt(topOffset,leftOffset)}},self.showArrowAt=function showArrowAtFn(top,left){var arrow=document.getElementById("iarrow");try{self.PAssert(799,arrow,"Must have a valid highlight arrow")}catch(PERR){g.reportError(PERR)}arrow.style.display="block";var extraOffset=platform.mobile?-35:0;arrow.style.top=top+extraOffset+"px",arrow.style.left=left+"px"},self.hideHighlightElement=function hideHighlightElementFn(){var arrow=document.getElementById("iarrow");try{self.PAssert(800,arrow,"Must have a valid highlight arrow")}catch(PERR){g.reportError(PERR)}arrow.style.display="none"};var eventID,dblClickTime=500;self.setupClick=function setupClickFn(obj,item,params){function move(e){var xThisFrame=e.eventX-this.lastX,yThisFrame=e.eventY-this.lastY;if(0!==xThisFrame||0!==yThisFrame){var firstMove=!this.moved;if(this.lastX=e.eventX,this.lastY=e.eventY,e.distanceX=this.distanceX=this.distanceX+Math.abs(xThisFrame),e.distanceY=this.distanceY=this.distanceY+Math.abs(yThisFrame),(this.moved||e.distanceX>self.ClickThreshold||e.distanceY>self.ClickThreshold)&&(this.moved=!0,e.moved=this.moved),(params.onMove||params.onFirstMove)&&(e.diffX=e.eventX-this.startX,e.diffY=e.eventY-this.startY,e.xThisFrame=xThisFrame,e.yThisFrame=yThisFrame,e.xFromTopLeft=this.xFromTopLeft,e.yFromTopLeft=this.yFromTopLeft,e.startX=this.startX,e.startY=this.startY,e.startClientX=this.startClientX,e.startClientY=this.startClientY,e.startSrc=this.startSrc,firstMove&&params.onFirstMove&&params.onFirstMove.call(item,e),params.onMove)){var handled=!1;handled=params.onMove.call(item,e),handled&&e.stopImmediatePropagation()}}}function end(e){e.srcElement||(e.srcElement=e.target);var now=Date.now(),lastTouch=this.lastTouch||now,delta=Math.max(0,now-lastTouch);this.numClicks?this.numClicks++:this.numClicks=1,e.eventX=this.lastX,e.eventY=this.lastY,e.moved=this.moved,e.timeDelta=delta,e.diffX=this.lastX-this.startX,e.diffY=this.lastY-this.startY,e.startX=this.startX,e.startY=this.startY,e.xFromTopLeft=this.xFromTopLeft,e.yFromTopLeft=this.yFromTopLeft,e.startSrc=this.startSrc,dblClickTime>delta&&delta>0&&params.onDblClick&&!this.moved&&params.onDblClick.call(item,e),isNaN(e.button)||0===e.button?(this.lastTouch=now,params.onClick&&!this.moved&&params.onClick.call(item,e)):1==e.button&&params.onMiddleClick&&!this.moved&&params.onMiddleClick.call(item,e),(isNaN(e.button)||0===e.button)&&params.onEnd&&params.onEnd.call(item,e),setTimeout(function(){this.lastTouch=void 0,this.numClicks=void 0}.bind(this),dblClickTime)}function cancel(e){params.onCancel&&params.onCancel.call(item,e)}function start(e){e.timeStart=this.timeStart=Date.now(),e.srcElement||(e.srcElement=e.target),this.startSrc=e.srcElement,this.moved=!1,e.startX=this.startX=e.eventX,e.startY=this.startY=e.eventY,e.startClientX=this.startClientX=e.clientX,e.startClientY=this.startClientY=e.clientY,this.lastX=e.eventX,this.lastY=e.eventY,this.distanceX=0,this.distanceY=0;var offset=self.offset(e.srcElement);e.xFromTopLeft=this.xFromTopLeft=e.eventX-offset.left,e.yFromTopLeft=this.yFromTopLeft=e.eventY-offset.top,(isNaN(e.button)||0===e.button)&&params.onStart&&params.onStart.call(item,e),isNaN(e.changeLastY)||(this.lastY+=e.changeLastY)}function touchMove(e){var touch=platform.ie?e:e.touches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,move.call(obj,e),e.returnFalse?!1:void 0}function touchUp(e){return document.removeEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.removeEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.removeEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&gesture.stop(),end.call(obj,e),e.returnFalse?!1:void 0}function touchCancel(e){return document.removeEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.removeEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.removeEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&gesture.stop(),cancel.call(obj,e),e.returnFalse?!1:void 0}function touchStart(e){if(!e.handled){this.lastInputTouch=!0;var touch=platform.ie?e:e.touches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,start.call(obj,e),e.ignore||(document.addEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.addEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.addEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&(log("Add Gesture Pointer: ",e.id,self.elementToString(e.target),self.elementToString(obj)),gesture.addPointer(e.pointerId))),e.returnFalse?!1:void 0}}function mouseMove(e){return this.lastInputTouch?void 0:(e.eventX=e.pageX,e.eventY=e.pageY,move.call(obj,e),e.returnFalse?!1:void 0)}function mouseUp(e){return e.handled||this.lastInputTouch?void 0:(document.removeEventListener(platform.moveEvent,mouseMoveHandler,useCapture),document.removeEventListener(platform.upEvent,mouseUpHandler,useCapture),0===e.button&&end.call(obj,e),e.returnFalse?!1:void 0)}function mouseDown(e){return e.handled||this.lastInputTouch?void 0:(this.lastInputTouch=!1,e.eventX=e.pageX,e.eventY=e.pageY,start.call(obj,e),e.ignore||(0===e.button&&document.addEventListener(platform.moveEvent,mouseMoveHandler,useCapture),document.addEventListener(platform.upEvent,mouseUpHandler,useCapture)),e.returnFalse?!1:void 0)}function contextMenu(e){e.handled||this.lastInputTouch||(e.srcElement||(e.srcElement=e.target),params.onRightClick&&params.onRightClick.call(item,e))}try{self.PAssert(802,obj,"Expecting an object to bind the click hanlders to.")}catch(PERR){g.reportError(PERR)}if(!obj)return void log("Skipping setupClick because no valid DOM object was provided to bind to");item||(item=obj);var useCapture=!1;self.isFunction(params)?params={onClick:params}:params&&params.useCapture&&(useCapture=params.useCapture);var touchStartHandler=fnCatch(touchStart),touchMoveHandler=fnCatch(touchMove),touchEndHandler=fnCatch(touchUp),touchCancelHandler=fnCatch(touchCancel),gesture=void 0,mouseDownHandler=fnCatch(mouseDown),mouseMoveHandler=fnCatch(mouseMove),mouseUpHandler=fnCatch(mouseUp),contextMenuHandler=fnCatch(contextMenu);return platform.isTouchDevice?obj.addEventListener(platform.touchStartEvent,touchStartHandler,useCapture):obj.addEventListener(platform.downEvent,mouseDownHandler,useCapture),platform.usePointerEvents&&platform.mobile&&obj.addEventListener("mousedown",function(e){return android.isEnabled()&&android.isTargetBox(e)||(e.preventDefault(),e.stopImmediatePropagation()),!1},useCapture),params.onRightClick&&!platform.mobile&&obj.addEventListener("contextmenu",contextMenuHandler,useCapture),this};var spinnerRunning=!1;self.StartSpinner=function StartSpinnerFn(){platform.mobile&&!spinnerRunning&&(spinnerRunning=!0,self.removeClass(document.getElementById("loading"),"hidden"))},self.StopSpinner=function StopSpinnerFn(){var spinner=document.getElementById("loading");spinnerRunning&&spinner&&self.addClass(document.getElementById("loading"),"hidden")},Array.prototype.pushOnlyUniques=function(arr,comp){if(!arr)return this;for(var i=0,len=arr.length;len>i;++i){for(var isUnique=!0,u=0,len2=this.length;len2>u;++u)if(comp&&comp(arr[i],this[u])||!comp&&arr[i]==this[u]){isUnique=!1;break}isUnique&&this.push(arr[i])}return this},Array.prototype.pushArray=function(arr){return this.push.apply(this,arr)},Array.prototype.removeAt=function(from){return this.splice(from,1)[0]},Array.prototype.remove=function(obj){var index=this.indexOf(obj);return index>=0&&this.removeAt.call(this,index),index},Array.prototype.findInsertIndex=function(ele,comp){try{self.PAssert(804,ele,"Require a valid element to insert")}catch(PERR){g.reportError(PERR)}try{self.PAssert(805,comp,"Require a valid comparison function")}catch(PERR){g.reportError(PERR)}for(var low=0,high=this.length-1;high>=low;){var i=low+high>>1,c=comp(this[i],ele);if(0>c)low=i+1;else{if(!(c>0))return i;high=i-1}}return low},Array.prototype.insertSorted=function(ele,comp){var idx=this.findInsertIndex(ele,comp);this.splice.apply(this,[idx,0,ele])},ko.observableArray.fn.insertSorted=function(ele,comp){this.peek().insertSorted(ele,comp),this.valueHasMutated()},self.clamp=function clampFn(val,min,max){return Math.max(min,Math.min(max,val))},self.randParam=function randParamFn(){return"?t="+Date.now()},self.createPath=function createPathFn(filename){return window.location.protocol+"//"+window.location.host+"/"+filename},self.addScript=function addScriptFn(filename,id,callback){var e=document.createElement("script");e.type="text/javascript",e.src=filename,id&&(e.id=id),callback&&readyStateCallback(e,callback),"undefined"!=typeof e&&document.getElementsByTagName("head")[0].appendChild(e)},self.addStylesheet=function addStylesheetFn(filename,callback){var e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=filename,callback&&readyStateCallback(e,callback),"undefined"!=typeof e&&document.getElementsByTagName("head")[0].appendChild(e)},self.PAssert=function PAssertFn(tag,value){if(!value){var assertExtra={isAssert:!0,tag:tag};try{var argString=makeString(Array.prototype.slice.call(arguments,2));log(arguments.length>2?"Assert Failure: "+argString:"Assert Failure"),self.reportError(new Error("Assert Failure: "+argString),assertExtra)}catch(err){log("Exception in PAssert: ",err),self.reportError(err,assertExtra)}}},self.getSelectionInfo=function getSelectionInfoFn(){var selection=window.getSelection(),node=selection.anchorNode;return node?{node:node.nodeType===Node.TEXT_NODE?node.parentNode:node,selection:selection}:void 0},self.getSelectionRange=function getSelectionRangeFn(){var selection=window.getSelection();if(selection.rangeCount>0){var range=selection.getRangeAt(0);return range}return void 0},self.getItemForElement=function getItemForElementFn(el){if(android.isEnabled()){var currentVMLI=android.getCurrentVMLI();if(currentVMLI)return currentVMLI}if(el&&el!==document.body){el.nodeType===Node.TEXT_NODE&&(el=el.parentNode);var vm=ko.dataFor(el);return vm instanceof VMLI?vm:void 0}return void 0},self.getSelectedItem=function getSelectedItemFn(){var selection=window.getSelection();return self.getItemForElement(selection.anchorNode)},self.clearSelection=function clearSelectionFn(){window.getSelection().removeAllRanges()},self.selectElement=function selectElementFn(ele,selectEnd){if(ele.textContent.length>0&&ele.textContent!==TextSpace){var sel=window.getSelection(),range=document.createRange(),selStart=selectEnd?ele.textContent.length:0;range.setStart(ele.childNodes[0],selStart),range.setEnd(ele.childNodes[0],ele.textContent.length),sel.removeAllRanges(),sel.addRange(range)}else ele.focus()},self.selectChildren=function selectChildrenFn(item,start,length){if(item&&item instanceof VMLI){if(android.isEnabled()){try{self.PAssert(807,0===length,"Android editing code must be updated if setting a non-zero length")}catch(PERR){g.reportError(PERR)}return void android.updateInput(item,start)}var maxLength=item.getParsedText().length-item.styleLength,start=Math.min(start,maxLength),end=Math.min(start+length,maxLength),sel=window.getSelection(),range=document.createRange(),startElement=void 0,startOffset=-1,endElement=void 0,endOffset=-1,totalOffset=0,element=item.getSpan();if(element){for(var children=getTextNodesIn(element),i=0;i<children.length;++i){var childLength=children[i].length;if(-1===startOffset&&totalOffset+childLength>=start&&(startElement=children[i],startOffset=start-totalOffset),totalOffset+childLength>=end){endElement=children[i],endOffset=end-totalOffset;break}totalOffset+=childLength}try{self.PAssert(808,startElement&&startOffset>=0)
}catch(PERR){g.reportError(PERR)}try{self.PAssert(809,endElement&&endOffset>=0)}catch(PERR){g.reportError(PERR)}try{self.PAssert(810,startOffset<=startElement.length)}catch(PERR){g.reportError(PERR)}try{self.PAssert(811,endOffset<=endElement.length)}catch(PERR){g.reportError(PERR)}startOffset=0>startOffset?0:startOffset,endOffset=0>endOffset?0:endOffset,range.setStart(startElement,startOffset),range.setEnd(endElement,endOffset),sel.removeAllRanges(),sel.addRange(range)}}else try{self.PAssert(806,!1,"Valid item and text required to perform selection")}catch(PERR){g.reportError(PERR)}},self.getOffsetOfSubNode=function getOffsetOfSubNodeFn(element,subnode){for(var offset=0,children=getTextNodesIn(element),childrenSub=getTextNodesIn(subnode),i=0;i<children.length&&children[i]!=childrenSub[0];++i)offset+=children[i].length;return offset},self.selectMultiline=function selectMultilineFn(eStart,oStart,eEnd,oEnd){var retVal=!1,sel=window.getSelection(),range=document.createRange(),start=getOffsetChildElement(eStart,oStart),end=getOffsetChildElement(eEnd,oEnd);try{self.PAssert(813,start&&start.element&&!isNaN(start.offset),"Start element is invalid")}catch(PERR){g.reportError(PERR)}try{self.PAssert(814,end&&end.element&&!isNaN(end.offset),"End element is invalid")}catch(PERR){g.reportError(PERR)}return start&&start.element&&end&&end.element&&(range.setStart(start.element,start.offset),range.setEnd(end.element,end.offset),sel.removeAllRanges(),sel.addRange(range),retVal=!0),retVal},self.saveSelectionItem=function saveSelectionItemFn(range){if(!range){var selection=self.getSelectionInfo();if(!selection||0===selection.rangeCount)return void 0;range=selection.selection.getRangeAt(0)}var validSelectionInfo=!0;if(range&&range.startContainer&&range.endContainer)try{var startItem=self.getItemForElement(range.startContainer),endItem=self.getItemForElement(range.endContainer);if(startItem&&endItem&&startItem!=self.vmMain.root())var startOffsets=self.getSelectOffsetsInSpan(startItem,startItem.getSpan(),range),endOffsets=self.getSelectOffsetsInSpan(endItem,endItem.getSpan(),range),savedPane=self.getPaneForElement(startItem.getSpan());else validSelectionInfo=!1}catch(err){self.reportError(err),validSelectionInfo=!1}else validSelectionInfo=!1;var selData=void 0;return validSelectionInfo&&(selData={start:startOffsets,end:endOffsets,startItem:startItem,endItem:endItem,pane:savedPane}),selData};var savedSelections={};self.saveSelection=function saveSelectionFn(name,range){savedSelections[name]=self.saveSelectionItem(range,name)},self.clearSavedSelection=function clearSavedSelectionFn(name){savedSelections[name]=void 0},self.restoreSavedSelection=function restoreSavedSelectionFn(name,forcePane){var selData=savedSelections[name],restoreItem=void 0;if(selData&&(!forcePane||forcePane===selData.pane)){try{restoreItem=self.restoreSelectionItem(selData),restoreItem&&self.scrollIntoView(restoreItem.getSpan(),0)}catch(err){self.reportError(err)}self.clearSavedSelection(name)}return!!restoreItem},self.restoreSelectionItem=function restoreSelectionItemFn(selectionInfo){try{self.PAssert(815,selectionInfo,"Must restore to a valid selection")}catch(PERR){g.reportError(PERR)}var startIsHidden=self.hasClass(selectionInfo.startItem.getElement(),"hidden"),endIsHidden=self.hasClass(selectionInfo.endItem.getElement(),"hidden");if(startIsHidden&&!endIsHidden){var setSelection=self.selectMultiline(selectionInfo.endItem.getSpan(),selectionInfo.end.end,selectionInfo.endItem.getSpan(),selectionInfo.end.end);return setSelection?selectionInfo.endItem:void 0}if(!startIsHidden&&endIsHidden){var setSelection=self.selectMultiline(selectionInfo.startItem.getSpan(),selectionInfo.start.start,selectionInfo.startItem.getSpan(),selectionInfo.start.start);return setSelection?selectionInfo.startItem:void 0}var setSelection=self.selectMultiline(selectionInfo.startItem.getSpan(),selectionInfo.start.start,selectionInfo.endItem.getSpan(),selectionInfo.end.end);return setSelection?selectionInfo.startItem:void 0},self.getSelectOffsetsInSpan=function getSelectOffsetsInSpanFn(item,element,range,forceSelection){var styleLength=item?item.styleLength:0,returnValue={start:0,startText:styleLength,end:0,endText:styleLength,total:0,totalText:styleLength};if(android.isEnabled()&&!forceSelection)returnValue.start=android.getSelectionStart(),returnValue.startText=returnValue.start+styleLength,returnValue.end=android.getSelectionEnd(),returnValue.endText=returnValue.end+styleLength,returnValue.total=android.getInputText().length,returnValue.totalText=returnValue.total+styleLength;else{try{self.PAssert(816,element&&"SPAN"===element.tagName,"Expected SPAN, Actual: ",element)}catch(PERR){g.reportError(PERR)}if(element&&element.textContent!==TextSpace&&(!android.isEnabled()||""!==element.textContent)){var startElement=range.startContainer,startOffset=range.startOffset,endElement=range.endContainer,endOffset=range.endOffset;try{self.PAssert(817,"#text"===startElement.nodeName||"SPAN"===startElement.tagName,"Expected #text or SPAN, Actual: ",startElement.nodeName)}catch(PERR){g.reportError(PERR)}var totalOffset=0,children=getTextNodesIn(element);"SPAN"===startElement.tagName&&g.hasClass(startElement,"text")&&(startElement=children[0]);for(var i=0;i<children.length;++i)children[i]===startElement&&(returnValue.start=totalOffset+startOffset,returnValue.startText=totalOffset+startOffset+styleLength),children[i]===endElement&&(returnValue.end=totalOffset+endOffset,returnValue.endText=totalOffset+endOffset+styleLength),totalOffset+=children[i].length;returnValue.total=totalOffset,returnValue.totalText=totalOffset+styleLength}}return returnValue},self.getSpanParent=function getSpanParentFn(el){if(android.isEnabled())return android.getInputBox();if(self.hasClass(el,"noItems"))return void 0;for(;el&&("SPAN"!==el.tagName||!hasValidClass(el));)el=el.parentNode;if(el&&hasValidClass(el))return el;try{self.PAssert(818,!1,"This shouldn't happen, spans should always be found")}catch(PERR){g.reportError(PERR)}return void 0},self.getLIParent=function getLIParentFn(el){for(;el&&"LI"!==el.tagName;)el=el.parentNode;return el&&!self.hasClass(el,"item")?null:el},self.getPreviousItem=function getPreviousItemFn(item,pane,options){try{self.PAssert(820,item,"Item must be specified")}catch(PERR){g.reportError(PERR)}if(!item)return void 0;var found=void 0,isTest=options&&options.isTest,ignoreSearch=options&&options.ignoreSearch,prev=item.parent();if(!prev)return void 0;var index=prev.getChildIndex(item);if(index>0){for(;!found;){for(var newChild=!1,i=index-1;i>=0;i--){var prevChild=prev.getChild(i);if(prevChild.hasChildren()&&!prevChild.isCollapsed()){if(ignoreSearch||!pane||!self.hasClass(prevChild.getElement(pane.id),"hidden")){prev=prevChild,index=prevChild.numChildren(),newChild=!0;break}}else if(ignoreSearch||!pane||!self.hasClass(prevChild.getElement(pane.id),"hidden")){found=prevChild,newChild=!0;break}}newChild||(found=prev)}try{self.PAssert(821,isTest||!found||found.isCollapsed()||item===self.getNextItem(found,pane,{isTest:!0,ignoreSearch:ignoreSearch}),"Previous/Next should always match")}catch(PERR){g.reportError(PERR)}}else found=item.parent();return found},self.getNextItem=function getNextItemFn(item,pane,options){try{self.PAssert(822,item,"Item must be specified")}catch(PERR){g.reportError(PERR)}if(!item)return void 0;var next=void 0,isTest=options&&options.isTest,ignoreSearch=options&&options.ignoreSearch;if(item.hasChildren()&&!item.isCollapsed())for(var numChildren=item.numChildren(),i=0;numChildren>i;++i){var candidate=item.getChild(i);if(ignoreSearch||!pane||!self.hasClass(candidate.getElement(pane.id),"hidden")){next=candidate,options&&options.numLevels++;break}}for(var cItem=item;!next;){var parent=cItem.parent();if(!parent)break;var index=parent.getChildIndex(cItem),numChildren=parent.numChildren();if(!parent.isCollapsed())for(var i=index+1;numChildren>i;++i){var candidate=parent.getChild(i);try{self.PAssert(823,!pane||candidate.getElement(pane.id),"next element should be visible in pane")}catch(PERR){g.reportError(PERR)}if(ignoreSearch||!pane||!self.hasClass(candidate.getElement(pane.id),"hidden")){next=candidate;break}}if(cItem=parent,options&&!next&&options.numLevels--,pane&&cItem===pane.item())break}try{self.PAssert(824,isTest||!next||item===self.getPreviousItem(next,pane,{isTest:!0,ignoreSearch:ignoreSearch}),"Previous/Next should always match")}catch(PERR){g.reportError(PERR)}return next},self.getFirstPaneItem=function getFirstPaneItemFn(pane){try{self.PAssert(825,pane,"Should always provide a valid pane when grabbing the first item")}catch(PERR){g.reportError(PERR)}return pane?self.getNextItem(pane.item()):void 0},self.getLastPaneItem=function getLastPaneItemFn(pane){for(var item=pane.item().getLastChild();item.hasChildren();item=item.getLastChild());try{self.PAssert(826,item,"Must always have a valid pane item")}catch(PERR){g.reportError(PERR)}return item},self.getItemCounts=function getItemCountsFn(start,end,pane){try{self.PAssert(827,start,"Start must be a valid item")}catch(PERR){g.reportError(PERR)}try{self.PAssert(828,end,"End must be a valid item")}catch(PERR){g.reportError(PERR)}var count=0,fullscreenChildCount=0,item=start;do{item=self.getNextItem(item,pane);try{self.PAssert(829,item,"Items must exist")}catch(PERR){g.reportError(PERR)}item.parent()===pane.item()&&item.isHeader()&&fullscreenChildCount++,count++}while(item!==end);return{fscount:fullscreenChildCount,icount:count}},self.getItemsBetween=function getItemsBetweenFn(start,end,pane){try{self.PAssert(830,start,"Start must be a valid item")}catch(PERR){g.reportError(PERR)}try{self.PAssert(831,end,"End must be a valid item")}catch(PERR){g.reportError(PERR)}for(var selected=[start],item=start;item!==end;){item=self.getNextItem(item,pane);try{self.PAssert(832,item,"Items must exist")}catch(PERR){g.reportError(PERR)}selected.push(item)}return selected},self.getFirstItem=function getFirstItemFn(item1,item2){if(item1.id==item2.id||item2.parent().id==item1.id)return item1;if(item1.parent().id==item2.id)return item2;var p=item1,prevP=void 0;do{var q=item2,prevQ=void 0;do{if(p.id==q.id){if(void 0===prevP)return item1;if(void 0===prevQ)return item2;try{self.PAssert(833,void 0!==prevQ,"Fix this assert by handling this edge case!")}catch(PERR){g.reportError(PERR)}try{self.PAssert(834,p.id==prevQ.parent().id,"Must share a common parent")}catch(PERR){g.reportError(PERR)}try{self.PAssert(835,p.id==prevP.parent().id,"Must share a common parent")}catch(PERR){g.reportError(PERR)}try{self.PAssert(836,prevP.id!=prevQ.id,"If both previous items match, they should have been the common ancestor")}catch(PERR){g.reportError(PERR)}return prevP.getIndex()<prevQ.getIndex()?item1:item2}prevQ=q}while(void 0!==(q=q.parent()));prevP=p}while(void 0!==(p=p.parent()));try{self.PAssert(837,!1,"One item must appear first in the tree")}catch(PERR){g.reportError(PERR)}return void 0},self.animateTransform=function animateTransformFn(element,options){function onComplete(){options.clearTransform&&(element.style[platform.transform.style]="",element.style[platform.transformOrigin.style]=""),options.onComplete&&options.onComplete()}var transform=options.transform;if(!isNaN(options.delay)){var delay=options.delay;return options.delay=void 0,void setTimeout(self.animateTransform,delay,element,options)}if(options.time){var trans=self.getTransitionClass(options.time);self.addClass(element,trans),setTimeout(function(){self.removeClass(element,trans),onComplete()},options.time)}else onComplete();isNaN(options.opacity)||(element.style.opacity=options.opacity),transform||isNaN(options.left)||isNaN(options.top)||(transform="translate3d("+left+"px,"+top+"px,0)"),options.origin&&(element.style[platform.transformOrigin.style]=options.origin),element.style[platform.transform.style]=transform},self.easeOut=function easeOutFn(t,b,c){return-c*t*(t-2)+b},self.scrollTo=function scrollToFn(n,duration,element,horiz,cb){function scrollLoop(timestamp){startTime||(startTime=timestamp-20);var t=Math.min((timestamp-startTime)/duration,1),scrollOffset=self.easeOut(t,scrollValue,difference);return element[scrollVar]=scrollOffset,1==t?(self.isScrollingIntoView=!1,void(platform.ios&&(self.setSelectionToWhatItAlreadyIs(),cb&&cb()))):void requestAnimationFrame(scrollLoop)}element=element||self.focusedPane.rootElement;var scrollVar=horiz?"scrollLeft":"scrollTop";if(duration>0){self.isScrollingIntoView=!0;var scrollValue=element[scrollVar],startTime,difference=n-scrollValue,lastValue=scrollValue;requestAnimationFrame(scrollLoop)}else element&&(element[scrollVar]=n)},self.computeScrollSpeed=function computeScrollSpeedFn(min,max,val){return(max-min-(max-val))/(max-min)};var lastState={speed:0,pane:void 0},runScroll=!1;self.repeatScroll=function repeatScrollFn(speed,pane){lastState.speed=speed,lastState.pane=pane,runScroll||(runScroll=!0,requestAnimationFrame(performScroll))},self.cancelRepeatScroll=function cancelRepeatScrollFn(){runScroll=!1};var VMPane;self.getPaneForElement=function getPaneForElementFn(element){if(VMPane||(VMPane=require("VMPane")),element){var localContext;localContext=ko.contextFor(android&&android.isEnabled()&&"androidInput"==element.id?android.getCurrentVMLI().getSpan():element);var paneCandidate=localContext?localContext.$parents[localContext.$parents.length-2]:void 0;if(!paneCandidate&&localContext&&1===localContext.$parents.length&&(paneCandidate=localContext.$data),paneCandidate instanceof VMPane)return paneCandidate}return void 0},self.elementInPane=function elementInPaneFn(element){if(element){var localContext=ko.contextFor(element);if(localContext){var paneCandidate=localContext.$parents[localContext.$parents.length-2];if(paneCandidate)return self.hasClass(paneCandidate.element,"pane")}}return!1},self.scrollToTop=function scrollToTopFn(element,duration,options){if(element){var callback=options&&options.callback,scrollView=self.findParent(element,"scroller");if(scrollView){var top=element.getBoundingClientRect().top,scrollTop=scrollView.scrollTop,amtMoved=top-self.topBoxHeight+(platform.orientation==Orientation.Landscape?self.topBarHeight:0),n=scrollTop+amtMoved;return self.scrollTo(n,duration,scrollView),amtMoved||!0}}return!1},self.scrollIntoView=function scrollIntoViewFn(element,duration,options){var callback=options&&options.callback,noToolbar=options&&options.noToolbar;isNaN(duration)&&(duration=200);var performedScroll=!1;if(element){var scrollView=self.findParent(element,"scroller");if(scrollView){var scrollBounds=scrollView.getBoundingClientRect(),scrollBottom=scrollBounds.bottom,bounds=element.getBoundingClientRect(),extraMoveAmt=10,scrollTop=scrollView.scrollTop,n;if(platform.mobile&&(noToolbar||(scrollBottom-=self.keyboardToolbarHeight),platform.ios&&!platform.ios71&&self.isKeyboardOpen||(scrollBottom-=platform.kbsize?platform.kbsize:248)),bounds.top<scrollBounds.top){var item=ko.dataFor(element);n=platform.mobile||item!=self.getFirstPaneItem(self.focusedPane)?scrollTop+bounds.top-scrollBounds.top-extraMoveAmt:0}else bounds.bottom>scrollBottom&&(n=scrollTop+bounds.bottom-scrollBottom+extraMoveAmt);void 0!==n&&(self.scrollTo(n,duration,scrollView),callback&&(duration>0?setTimeout(callback,duration):callback()),performedScroll=!0)}}return performedScroll},self.isKeyboardInputElement=function isKeyboardInputElementFn(ele){return"checkbox"===ele.type?!1:"INPUT"==ele.nodeName||"textarea"==ele.type?!0:!1},self.openKeyboardOn=function openKeyboardOnFn(e,element,showKeyboard,focusFn,blurFn){try{self.PAssert(839,platform.mobile,"Should only be opening keyboard on mobile devices")}catch(PERR){g.reportError(PERR)}var scrollView=self.findParent(element,"scroller"),scrollStart=scrollView?scrollView.scrollTop:0,performedScroll=!1;if(showKeyboard&&self.keyboardToolbar.preShow(),self.isKeyboardOpen)log("keyboard open");else if(platform.app||platform.android||platform.mobileie){var callback=function(){showKeyboard?self.keyboardToolbar.show():self.isKeyboardOpen=!0,focusFn&&focusFn(),self.enforceScroll()};self.addClass(scrollView,"padded"),performedScroll=self.scrollIntoView(element,platform.keyboardOpenTime,{callback:callback,noToolbar:!showKeyboard})}else performedScroll=self.scrollIntoView(element,platform.keyboardOpenTime);performedScroll&&platform.app&&!platform.android||(focusFn&&focusFn(),showKeyboard&&self.keyboardToolbar.show()),self.onCloseKeyboard=function onCloseKeyboardFn(){self.addClass(scrollView,"padded"),self.scrollTo(scrollStart,platform.keyboardOpenTime,scrollView,!1,function(){self.removeClass(scrollView,"padded")}),self.isKeyboardOpen=!1,blurFn&&blurFn(),window.removeEventListener("closeKeyboard",self.onCloseKeyboard),self.onCloseKeyboard=void 0},window.addEventListener("closeKeyboard",self.onCloseKeyboard),platform.ios&&self.preventClick(),e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0,self.enforceScroll()},self.blurActiveElement=function blurActiveElementFn(ignoreSelectionChange){self.ignoreSelectionChange=!!ignoreSelectionChange,self.fireCustomEvent("closeKeyboard"),document.activeElement.blur(),setTimeout(function(){self.ignoreSelectionChange=!1},100)},self.preventScrollPropagation=function preventScrollPropagationFn(ele){return ele.scrollHeight===ele.clientHeight?!1:(0===ele.scrollTop?ele.scrollTop=1:ele.scrollTop+ele.offsetHeight>=ele.scrollHeight&&(ele.scrollTop=ele.scrollHeight-ele.offsetHeight-1),!0)},self.setSelectionToWhatItAlreadyIs=function setSelectionToWhatItAlreadyIsFn(){var sel=window.getSelection();if(sel.rangeCount>0){var range=sel.getRangeAt(0);sel.removeAllRanges(),sel.addRange(range)}},self.setSelection=function setSelectionFn(element,start,end){try{self.PAssert(841,element,"Must supply a valid element to set selection on")}catch(PERR){g.reportError(PERR)}try{self.PAssert(842,start>=0&&end>=0,"Must specify positive start and end offsets")}catch(PERR){g.reportError(PERR)}if(0>start||0>end)return!1;if(!element)return!1;var retVal=!0,select;try{var children=getTextNodesIn(element),range=document.createRange();select=children.length>0?children[0]:element,range.setStart(select,start),range.setEnd(select,end);var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}catch(err){self.reportError(err,{element:self.elementToString(element,!0),select:self.elementToString(select,!0),start:start,end:end,children:children.length>0?self.elementToString(element,!0):void 0}),retVal=!1}return retVal},self.restrictSelectionToText=function restrictSelectionToTextFn(){if(!android||!android.isEnabled()){var selection,range,rangeStartContainer,rangeEndContainer,rangeStart,rangeEnd,updateSelection=function(){return selection=self.getSelectionInfo(),selection&&0!==selection.rangeCount?(range=selection.selection.getRangeAt(0),rangeStartContainer=range.startContainer,rangeEndContainer=range.endContainer,rangeStart=range.startOffset,void(rangeEnd=range.endOffset)):!0};if(updateSelection(),selection){try{self.PAssert(843,"#text"==rangeStartContainer.nodeName||"SPAN"==rangeStartContainer.nodeName,"Expected #text or SPAN, Actual: "+rangeStartContainer.nodeName)}catch(PERR){g.reportError(PERR)}try{self.PAssert(844,"#text"==rangeEndContainer.nodeName||"LI"==rangeEndContainer.tagName||"UL"==rangeEndContainer.tagName||"SPAN"==rangeEndContainer.tagName,"Expected LI, UL, #text, SPAN, Actual: "+rangeEndContainer.tagName)}catch(PERR){g.reportError(PERR)}if("SPAN"===rangeStartContainer.nodeName&&(self.selectMultiline(rangeStartContainer,rangeStart,rangeEndContainer,rangeEnd),updateSelection()),"#text"===rangeStartContainer.nodeName&&rangeStartContainer.previousSibling&&"#comment"===rangeStartContainer.previousSibling.nodeName){try{self.PAssert(845,!1,"This case shouldnt be getting hit")}catch(PERR){g.reportError(PERR)}self.selectChildren(self.getSpanParent(rangeStartContainer),0,rangeEnd),updateSelection()}if(rangeStartContainer!==rangeEndContainer&&0===rangeEnd&&"P"==rangeEndContainer.nodeName){rangeEndContainer=rangeEndContainer.parentNode.parentNode;var prevLI=rangeEndContainer.previousElementSibling;try{self.PAssert(846,!prevLI||"LI"==prevLI.tagName)}catch(PERR){g.reportError(PERR)}if(prevLI){if(prevLI.children.length>1){var children=prevLI.children[1].children;prevLI=children[children.length-1]}}else prevLI=rangeEndContainer.parentNode.parentNode;var textLength=ko.dataFor(prevLI).getParsedText().length;self.selectMultiline(rangeStartContainer,rangeStart,prevLI,textLength)}else if("LI"===rangeEndContainer.tagName){var prevLI=rangeEndContainer.previousElementSibling;try{self.PAssert(847,!prevLI||"LI"===prevLI.tagName)}catch(PERR){g.reportError(PERR)}if(prevLI){if(prevLI.children.length>1){var children=prevLI.children[1].children;prevLI=children[children.length-1]}}else prevLI=rangeEndContainer.parentNode.parentNode,console.log(prevLI);var prevSpan=prevLI.firstChild;try{self.PAssert(848,"SPAN"===prevSpan.tagName,"Expected SPAN, Actual: "+prevSpan.tagName)}catch(PERR){g.reportError(PERR)}self.selectChildren(ko.dataFor(prevSpan),0,prevSpan.textContent.length)}else if("UL"===rangeEndContainer.nodeName){var item=self.getFirstPaneItem(g.focusedPane);item&&self.selectChildren(item,0,item.getSpan().textContent.length)}}}},self.trimString=function trimStringFn(str){for(var str=str.replace(/^\s\s*/,""),ws=/\s/,i=str.length;ws.test(str.charAt(--i)););return str.slice(0,i+1)},self.enforceScroll=function enforceScrollFn(force,top){(force||(platform.ios||platform.android)&&(!platform.app||platform.ios71)&&!platform.bodyscroll)&&(setTimeout(function(){window.scrollTo(0,top||0)},0),requestAnimationFrame(function(){window.scrollTo(0,top||0)}),window.scrollTo(0,top||0),document.body.scrollTop=0)},self.preventDefault=function preventDefaultFn(e){e.preventDefault()},self.preventClick=function preventClickFn(){self.addClass(self.element("outerWrapper"),"noClick"),window.ontouchstart=self.preventDefault,requestAnimationFrame(function(){window.ontouchstart=void 0,self.removeClass(self.element("outerWrapper"),"noClick")})},self.searchVMLIs=function searchVMLIsFn(options){var startItem=options.item;startItem||(startItem=self.vmMain.root()),options.headers?searchVMLIArray(options,startItem.headers()):searchVMLIArray(options,startItem.items()),options.includeArchived&&startItem.hasArchivedChildren()&&searchVMLIArray(options,startItem.archivedItems(!0))},self.getLastVisibleItem=function getLastVisibleItemFn(root){for(var list=root.items(),i=list.length-1;i>=0;i--)if(!self.vmSearchPhone.hiddenItems[list[i].id]){var lastItem=self.getLastVisibleItem(list[i]);return lastItem?lastItem:list[i]}return void 0},self.invertObject=function invertObjectFn(obj){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(target[obj[i]]=i);return target},self.fieldMapOut=self.invertObject(self.fieldMapIn),self.translateFieldIn=function translateFieldInFn(field){try{self.PAssert(853,self.fieldMapIn[field],"Incoming field should be added to the field map",field)}catch(PERR){g.reportError(PERR)}try{self.PAssert(854,"string"==typeof field,"Should only pass strings to the field mapping function",field)}catch(PERR){g.reportError(PERR)}return self.fieldMapIn[field]||field},self.translateFieldOut=function translateFieldOutFn(field){try{self.PAssert(855,self.fieldMapOut[field],"Incoming field should be added to the field map",field)}catch(PERR){g.reportError(PERR)}try{self.PAssert(856,"string"==typeof field,"Should only pass strings to the field mapping function",field)}catch(PERR){g.reportError(PERR)}return self.fieldMapOut[field]||field},self.translateObjIn=function translateObjInFn(obj){return getMapping(obj,self.fieldMapIn)},self.translateObjOut=function translateObjOutFn(obj){return getMapping(obj,self.fieldMapOut)};var eventListeners={};self.addCustomEventListener=function addCustomEventListenerFn(name,fn,priority){if(void 0!==priority){var evs=eventListeners[name],entry={fn:fn,pri:priority};evs?eventListeners[name].insertSorted(entry,function(left,right){return right>left?1:-1}):(eventListeners[name]=[entry],window.addEventListener(name,function(e){for(var i=0;i<eventListeners[name].length;++i){var ev=eventListeners[name][i],ret=ev.fn(e);if(ret===!1)break}}))}else window.addEventListener(name,fn)},self.removeCustomEventListener=function removeCustomEventListenerFn(name,fn,isPriority){if(isPriority){for(var evs=eventListeners[name],found=!1,i=0;i<evs.length;++i)if(evs[i].fn===fn){found=!0,evs.removeAt(i);break}try{self.PAssert(857,found,"Event listener should always be found when removing")}catch(PERR){g.reportError(PERR)}}else window.removeEventListener(name,fn)},self.fireCustomEvent=function fireCustomEventFn(name,data,target){if(document.createEvent){var eventObj=document.createEvent("Event");return data&&(eventObj.data=data),eventObj.initEvent(name,!0,!0),(target||window).dispatchEvent(eventObj)}try{self.PAssert(858,!1,"Unable to fire custom event")}catch(PERR){g.reportError(PERR)}},self.fireKeyEvent=function fireKeyEventFn(ele,keyData){fireKeyEventInternal(ele,"keydown",keyData),fireKeyEventInternal(ele,"keypress",keyData),fireKeyEventInternal(ele,"keyup",keyData)},self.fireClickEvent=function fireClickEventFn(ele,button){fireClickEventInternal(ele,"mousedown",button),fireClickEventInternal(ele,"mouseup",button),fireClickEventInternal(ele,"mouseclick",button)},self.clone=function cloneFn(obj){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(target[i]=obj[i]);return target},self.alias=function aliasFn(){for(var args=Array.prototype.slice.call(arguments),obj=args[0],i=1;i<args.length;i++){var fn=args[i];obj[fn]=obj["_"+fn]}},self.extend=function extendFn(target,source){try{self.PAssert(863,target&&source,"Invalid call to extend")}catch(PERR){g.reportError(PERR)}if(source)for(var prop in source)source.hasOwnProperty(prop)&&(target[prop]=source[prop]);return target},self.loadXML=function loadXMLFn(xml){try{if("undefined"!=typeof window.DOMParser)return(new window.DOMParser).parseFromString(xml,"text/xml");if("undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")){var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");return xmlDoc.async="false",xmlDoc.loadXML(xml),xmlDoc}try{self.PAssert(864,!1,"No XML parser found")}catch(PERR){g.reportError(PERR)}return void 0}catch(err){return void self.reportError(err)}},self.adjustOriginToBeInsideBounds=function adjustOriginToBeInsideBoundsFn(bounds,rect,xMin,yMin,xPad,yPad){var out={x:rect.left,y:rect.top};return xMin=xMin||0,yMin=yMin||0,xPad=xPad||0,yPad=yPad||0,rect.bottom+yPad>bounds.bottom&&(out.y=Math.max(yMin,rect.top-(rect.bottom+yPad-bounds.bottom))),rect.top-yPad<bounds.top&&(out.y=Math.max(yMin,rect.top)),rect.right+xPad>bounds.right&&(out.x=Math.max(xMin,rect.left-(rect.right+xPad-bounds.right))),out},self.setOrigin=function setOriginFn(rect,xOrigin,yOrigin){var xDiff=rect.left-xOrigin,yDiff=rect.top-yOrigin;rect.left-=xDiff,rect.right-=xDiff,rect.top-=yDiff,rect.bottom-=yDiff},self.copyStyles=function copyStylesFn(src,dst,styles){try{self.PAssert(865,src,"Must have a valid source element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(866,dst,"Must have a valid dest element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(867,styles,"Must have a valid list of styles to copy")}catch(PERR){g.reportError(PERR)}var computedStyle=window.getComputedStyle(src);if(computedStyle){for(var values=[],i=0;i<styles.length;++i)values[i]=computedStyle[styles[i]];for(var i=0;i<values.length;++i)dst.style[styles[i]]=values[i]}},self.hasClass=function hasClassFn(elem,cls){try{self.PAssert(868,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}return elem&&elem.classList?elem.classList.contains(cls):void 0},self.removeClass=function removeClassFn(elem,cls){try{self.PAssert(869,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}elem&&elem.classList&&elem.classList.remove(cls)},self.addClass=function addClassFn(elem,cls){try{self.PAssert(870,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}elem&&elem.classList&&elem.classList.add(cls)},self.toggleClass=function toggleClassFn(elem,cls){try{self.PAssert(871,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}elem&&elem.classList&&elem.classList.toggle(cls)},self.css=function cssFn(elem,styles){try{self.PAssert(872,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(elem)for(var style in styles)if(styles.hasOwnProperty(style)){var value=styles[style];"number"==typeof value&&(value+="px"),elem.style[style]=value}},self.findChild=function findChildFn(elem,cls){try{self.PAssert(873,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(elem)for(var i=0;i<elem.childElementCount;++i)if(self.hasClass(elem.children[i],cls))return elem.children[i];return void 0},self.findParent=function findParentFn(elem,cls,num){try{self.PAssert(874,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(num||(num=1e4),elem){var parent=elem;try{self.PAssert(875,parent,"Must have a valid parent element")}catch(PERR){g.reportError(PERR)}for(var i=0;num>i&&parent;++i,parent=parent.parentNode)if(self.hasClass(parent,cls))return parent}return void 0},self.isAncestor=function isAncestorFn(elem,candidate){try{self.PAssert(876,elem,"Must have a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(877,candidate,"Must have a valid candidate")}catch(PERR){g.reportError(PERR)}for(;elem&&elem!==candidate;)elem=elem.parentNode;return!!elem},self.firstChildTag=function firstChildTagFn(elem,tag){try{self.PAssert(878,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(879,tag,"Must pass in a valid tag to check")}catch(PERR){g.reportError(PERR)}if(elem)for(var upper=tag.toUpperCase(),i=0;i<elem.childElementCount;++i)if(elem.children[i].tagName===upper)return elem.children[i];return void 0},self.insertAfter=function insertAfterFn(reference,newNode){try{self.PAssert(881,reference,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(882,newNode,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}reference.parentNode.insertBefore(newNode,reference.nextSibling)},self.prependChild=function prependChildFn(parent,newNode){try{self.PAssert(883,parent,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(884,newNode,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}parent.insertBefore(newNode,parent.firstChild)},self.offset=function offsetFn(elem){try{self.PAssert(885,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,docElem=elem.ownerDocument.documentElement,win=doc.defaultView,customAns={top:box.top+win.pageYOffset-docElem.clientTop,left:box.left+win.pageXOffset-docElem.clientLeft};return customAns},self.height=function heightFn(elem){try{self.PAssert(887,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}var customHeight=elem.offsetHeight,cStyle=window.getComputedStyle(elem);return cStyle?("border-box"!==cStyle.boxSizing&&(customHeight-=parseFloat(cStyle.paddingTop)+parseFloat(cStyle.paddingBottom)),customHeight-=parseFloat(cStyle.borderTopWidth)+parseFloat(cStyle.borderBottomWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::height"),customHeight},self.width=function widthFn(elem){try{self.PAssert(889,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}var customWidth=elem.offsetWidth,cStyle=window.getComputedStyle(elem);return cStyle?("border-box"!==cStyle.boxSizing&&(customWidth-=parseFloat(cStyle.paddingLeft)+parseFloat(cStyle.paddingRight)),customWidth-=parseFloat(cStyle.borderLeftWidth)+parseFloat(cStyle.borderRightWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::width"),customWidth};var onLoadCallbacks=void 0;return self.runOnLoad=function runOnLoadFn(cb){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(cb):(onLoadCallbacks||(onLoadCallbacks=[],document.addEventListener("DOMContentLoaded",loadDone,!1),window.addEventListener("load",loadDone,!1)),onLoadCallbacks[onLoadCallbacks.length]=cb)
},self.XHR=function XHRFn(params){var url=params.url,type=params.type,cb=params.cb,data=params.data,headers=params.headers,username=params.username,password=params.password,xhr=new XMLHttpRequest;if(xhr.onreadystatechange=function(){4===xhr.readyState&&cb(xhr)},username&&password?xhr.open(type.toUpperCase(),url,!0,username,password):xhr.open(type.toUpperCase(),url,!0),headers)for(var key in headers)xhr.setRequestHeader(key,headers[key]);if(data){xhr.setRequestHeader("Accept","*/*"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");var queryString=generateQueryString(data);xhr.send(queryString)}else xhr.send()},self.element=function elementFn(id,reload){try{self.PAssert(892,id,"Tried to get an element without an id")}catch(PERR){g.reportError(PERR)}(!self.elements[id]||reload)&&(self.elements[id]=document.getElementById(id));try{self.PAssert(893,self.elements[id],"Tried to get an element that doesn't exist",id)}catch(PERR){g.reportError(PERR)}return self.elements[id]},self.waitingList={},self._waitForElement=function _waitForElementFn(id,cb){var el=document.getElementById(id);return el?(cb(el),delete self.waitingList[id],el):void setTimeout(self._waitForElement,100,id,cb)},self.waitForElement=function waitForElementFn(id,cb){var el=self._waitForElement(id,cb);el||(self.waitingList[id]=cb)},self.getElementByClassName=function getElementByClassNameFn(className,parent){if(!parent)return document.getElementsByClassName(className)[0];for(var len=parent.children.length,i=0;len>i;i++)if(parent.children[i].className.indexOf(className)>=0)return parent.children[i]},self.getElementsByClassName=function getElementsByClassNameFn(className,parent){if(parent){for(var arr=[],len=parent.children.length,i=0;len>i;i++)parent.children[i].className.indexOf(className)>=0&&arr.push(parent.children[i]);return arr}return document.getElementsByClassName(className)},self.isDateSoft=function isDateSoftFn(dateText){if(dateText)switch(dateText.toUpperCase()){case"NEXT":case"SOON":case"LATER":case"NOW":return!0}return!1},self.handlerPreventStop=function handlerPreventStopFn(e){e.preventDefault(),e.stopImmediatePropagation()},self.fFalse=function fFalseFn(){return!1},self.fTrue=function fTrueFn(){return!0},self.emptyFn=function emptyFnFn(){},util.hasURLParam("nolocal","true")&&(self.noLocalWrites=!0),self.settings.init(),self.eventStream=self.createRingBuffer(100),self}),define("gdata",["ko","globals","data","platform"],function(ko,g,d,platform){function printDriveItems(includeSubItems){log("----");for(var itemID in itemCache){var item=itemCache[itemID];if(log(item.id,self.get(item.data,"text"),self.getVersion(item.data,VersionType.Structure)),includeSubItems){var subitems=self.get(item.data,"items");if(subitems)for(var u=0;u<subitems.length;u++)log("    ",subitems.get(u))}}log("----")}function migrateItemData_Four(map){function iterateLink(items){if(items)for(var i=0;i<items.length;++i){var item=items.get(i),text=self.get(item,"text");if(text.indexOf("@")>=0)for(var words=text.split(" "),lineIndex=0,i=0;i<words.length;++i){if(0===words[i].indexOf("@")){for(var matchedName=void 0,combined=words[i].substring(1),u=1;4>u;u++){var compStr=-1!==combined.indexOf(":",combined.length-1)?combined.substr(0,combined.length-1):combined;if(d.contactsByName[compStr]&&(matchedName=compStr),i+u<words.length){if(!(i+u<words.length))break;combined+=" "+words[i+u]}}if(matchedName){try{g.PAssert(911,"@"==text[lineIndex],"Explicitly matching @, should always match")}catch(PERR){g.reportError(PERR)}var newText=text.substr(0,lineIndex)+"+"+text.substr(lineIndex+1);self.set(item,"text",newText),setRemoteTextVersion(item)}}lineIndex+=words[i].length+1}iterateRemoteLink(item)}}function iterateRemoteLink(remoteItem){var collabItems=self.get(remoteItem,"items");collabItems&&iterateLink(collabItems);var collabArchivedItems=self.get(remoteItem,"archivedItems");collabArchivedItems&&iterateLink(collabArchivedItems)}self.beginWriteAction();try{g.PAssert(910,map,"Must have a valid root item to migrate")}catch(PERR){g.reportError(PERR)}if(0===d.contacts.length)return void log("Skipping remote data migration four");var rootItem=map.get("root");iterateRemoteLink(rootItem)}function migrateItemData_Three(map){function iterateLink(items){if(items)for(var i=0;i<items.length;++i){var item=items.get(i),text=self.get(item,"text");text.startsWith("!")?(self.set(item,"priority",VMLIFlag.P0),self.set(item,"text",text.substr(1)),setRemoteTextVersion(item)):text.startsWith("*")?(self.set(item,"isFlagged",!0),self.set(item,"text",text.substr(1)),setRemoteTextVersion(item)):text.startsWith("^")&&(self.set(item,"isComplete",!0),self.set(item,"text",text.substr(1)),setRemoteTextVersion(item)),iterateRemoteLink(item)}}function iterateRemoteLink(remoteItem){var collabItems=self.get(remoteItem,"items");collabItems&&iterateLink(collabItems);var collabArchivedItems=self.get(remoteItem,"archivedItems");collabArchivedItems&&iterateLink(collabArchivedItems)}self.beginWriteAction();try{g.PAssert(912,map,"Must have a valid root item to migrate")}catch(PERR){g.reportError(PERR)}var rootItem=map.get("root");iterateRemoteLink(rootItem)}function migrateItemData_Two(map){function iterateLink(items){if(items)for(var i=0;i<items.length;++i){var item=items.get(i);try{g.PAssert(914,item,"Remote item must exist")}catch(PERR){g.reportError(PERR)}try{g.PAssert(915,!g.isString(item),"New items must be collab maps not strings")}catch(PERR){g.reportError(PERR)}iterateRemoteLink(item)}}function iterateRemoteLink(remoteItem){var currentText=self.get(remoteItem,"text");g.isString(currentText)||(self.set(remoteItem,"text",currentText.getText()),log("Updated Text: ",self.get(remoteItem,"text")));var collabItems=self.get(remoteItem,"items");collabItems&&iterateLink(collabItems);var collabArchivedItems=self.get(remoteItem,"archivedItems");collabArchivedItems&&iterateLink(collabArchivedItems)}self.beginWriteAction();try{g.PAssert(913,map,"Must have a valid root item to migrate")}catch(PERR){g.reportError(PERR)}var rootItem=map.get("root");iterateRemoteLink(rootItem)}function migrateItemData_One(map){function iterateLink(items){var newItems=[];if(items)for(var i=0;i<items.length;++i){var itemID=items.get(i);try{g.PAssert(917,g.isString(itemID),"Must be a valid ID string")}catch(PERR){g.reportError(PERR)}var item=lookupTable.get(itemID);try{g.PAssert(918,item,"Remote item must exist in DB")}catch(PERR){g.reportError(PERR)}try{g.PAssert(919,!g.isString(item),"New items must be collab maps not strings")}catch(PERR){g.reportError(PERR)}newItems.push(item),iterateRemoteLink(item)}return newItems}function iterateRemoteLink(remoteItem){var collabItems=self.get(remoteItem,"items");if(collabItems){var newItems=iterateLink(collabItems);try{g.PAssert(920,newItems.length===collabItems.length,"New item list must be the same length as the old one")}catch(PERR){g.reportError(PERR)}newItems.length>0&&collabItems.replaceRange(0,newItems)}var collabArchivedItems=self.get(remoteItem,"archivedItems");if(collabArchivedItems){var newArchivedItems=iterateLink(collabArchivedItems);try{g.PAssert(921,newArchivedItems.length===collabArchivedItems.length,"New item list must be the same length as the old one")}catch(PERR){g.reportError(PERR)}newArchivedItems.length>0&&collabArchivedItems.replaceRange(0,newArchivedItems)}}self.beginWriteAction();try{g.PAssert(916,map,"Must have a valid root item to migrate")}catch(PERR){g.reportError(PERR)}var rootItemID=map.get("root").id,lookupTable=map.get("items"),rootItem=lookupTable.get(rootItemID);iterateRemoteLink(rootItem),map.set("root",rootItem)}function ensureWriteAction(){try{g.PAssert(931,!self.inCompoundOperation,"Should never be in a compound operation after sync block finishes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(932,!self.wantCompoundOperation,"Should never want a compound operation after a sync block finishes")}catch(PERR){g.reportError(PERR)}self.inCompoundOperation&&(self.model.endCompoundOperation(),g.reportError(new Error("Compound operation open after sync block finished"))),ensureActionTimeout=void 0}function attachEvents(item){try{g.PAssert(938,item,"Must have a valid local item to attach events to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(939,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(940,item.data,"Must have a valid remote item to attach events to")}catch(PERR){g.reportError(PERR)}item.data.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,item.onObjectChanged.bind(item))}function ensureRemoteItemsArray(item){self.beginWriteAction();try{g.PAssert(962,item instanceof VMLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(963,item.data,"Must have valid remote item to attach events to and create")}catch(PERR){g.reportError(PERR)}var itemList=self.get(item.data,"items");return itemList||(itemList=self.model.createList(),self.set(item.data,"items",itemList)),itemList}function ensureRemoteArchiveArray(item){self.beginWriteAction();try{g.PAssert(964,item instanceof VMLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(965,item.data,"Must have valid remote item to attach events to and create")}catch(PERR){g.reportError(PERR)}var archivedList=self.get(item.data,"archivedItems");return archivedList||(archivedList=self.model.createList(),self.set(item.data,"archivedItems",archivedList)),archivedList}function setRemoteVersion(data){self.beginWriteAction();var v=self.getVersion(data,VersionType.Structure);v=v?v+1:1;var verStr;self.set(data,"version",v)}function setRemoteTextVersion(data){self.beginWriteAction();var v=self.getVersion(data,VersionType.Text);v=v?v+1:1;var verStr;self.set(data,"versionText",v)}function saveChangesInternal(item,changes){var itemData=self.canSave(item);if(itemData){if(g.isEmpty(changes))return void(ShouldLog(LogLevels.Warning)&&log("Skipped remote saving an empty object"));self.beginWriteAction(),d.addPendingUpdate(item.id);for(var prop in changes){try{g.PAssert(993,changes.hasOwnProperty(prop),"Changes should only contain properties they own")}catch(PERR){g.reportError(PERR)}if(changes.hasOwnProperty(prop))switch(prop){case"text":try{g.PAssert(994,g.isString(changes.text))}catch(PERR){g.reportError(PERR)}self.set(itemData,"text",changes.text);break;case"date":try{g.PAssert(995,!changes.date||"number"==typeof changes.date)}catch(PERR){g.reportError(PERR)}self.set(itemData,"date",changes.date);break;case"dateCreated":try{g.PAssert(996,"number"==typeof changes.dateCreated)}catch(PERR){g.reportError(PERR)}self.set(itemData,"dateCreated",changes.dateCreated);break;case"dateCompleted":try{g.PAssert(997,!changes.dateCompleted||"number"==typeof changes.dateCompleted)}catch(PERR){g.reportError(PERR)}self.set(itemData,"dateCompleted",changes.dateCompleted);break;case"allDayDate":case"priority":case"isComplete":case"isFlagged":self.set(itemData,prop,changes[prop]);break;case"isCollapsed":case"isArchived":try{g.PAssert(998,!1,"These properties are not set this way")}catch(PERR){g.reportError(PERR)}self.set(itemData,prop,changes[prop]);break;case"modifiedOfflineText":case"dateText":break;default:try{g.PAssert(999,!1,"Attempting to remotely save an unknown field: ",prop)}catch(PERR){g.reportError(PERR)}}}setRemoteTextVersion(itemData)}}function tryDriveReconnect(){log("Try Reconnect: ",retryCount,driveReconnectTimer),driveReconnectTimer=void 0,g.goog.reconnectToActiveDocument()}function onSettingsChanged(change){for(var wasChanged=!1,i=0;i<change.events.length;++i){var ev=change.events[i];ev.isLocal||(ev.property.startsWith(g.settings.prefix)||(wasChanged=!0),self.settingsLocal[ev.property]=ev.newValue,g.fireCustomEvent("settingsChange_"+ev.property,ev.newValue))}wasChanged&&self.onRemoteSettingsLoad()}var self={isClosed:!0,isInitialized:!0,wantCompoundOperation:!1,inCompoundOperation:!1,flushingDeferredActions:!1,authenticatedUser:ko.observable()},CURRENT_VERSION=5;self.currentVersion=function currentVersionFn(){return CURRENT_VERSION};var itemCache={};self.cacheItem=function cacheItemFn(item){try{g.PAssert(894,void 0===itemCache[item.id]||itemCache[item.id]===item,"Should not be caching different items with the same ID")}catch(PERR){g.reportError(PERR)}itemCache[item.id]=item},self.getState=function getStateFn(obj){try{var gState={};if(self.doc)try{var model=self.doc.getModel();gState.isReadOnly=model.isReadOnly,gState.serverVersion=model.serverVersion,gState.size=model.bytesUsed}catch(err2){obj.docAccessError=!0}gState.lastPending=lastPending,gState.lastSaving=lastSaving,gState.isClosed=self.isClosed,gState.initialized=self.initialized,obj.gState=gState}catch(err){log("Error getting information in gdata::getState()"+err.message)}};var d,VMLI;self.checkRemoteIntegrity=function checkRemoteIntegrityFn(){function verifyChildren(children,isArchived){if(children)for(var j=0;j<children.length;++j){var child=children.get(j).id;child||(log(child,": Child does not have a valid reference in our remote database"),remoteDataError=!0),seen[child]?seen[child].ref?(log(child,": Item is referenced remotely multiple times"),log("   ",seen[child].ref),log("   ",item.id),remoteDataError=!0,self.beginWriteAction(),children.remove(j)):seen[child].ref=item.id:seen[child]={exist:!1,arch:isArchived,ref:item.id}}}self.beginAction();var remoteDataError=!1,seen={},rootSeen=!1;for(var itemID in itemCache){var item=itemCache[itemID];seen[item.id]?seen[item.id].exist?(log(item.id,": Duplicated IDs in the remote database",item),remoteDataError=!0):seen[item.id].exist=!0:seen[item.id]={exist:!0,ref:!1},item.id==self.rootID&&(rootSeen&&(log(item.id,": Multiple roots present remotely",item),remoteDataError=!0),rootSeen=!0,seen[item.id].isRoot=!0);var childItems=self.get(item,"items");verifyChildren(childItems,!1);var childArchivedItems=self.get(item,"archivedItems");verifyChildren(childArchivedItems,!0)}rootSeen||(log("No root present"),localDataError=!0);for(var entryID in seen){var entry=seen[entryID];if(!entry.exist){try{g.PAssert(896,!1,"This should never happen as the database is inline with the item tree now")}catch(PERR){g.reportError(PERR)}log(entryID,": Item is referenced remotely as a child but does not exist in the database");var parent=itemCache[entry.ref];try{g.PAssert(897,parent,"Parent must exist otherwise it couldn't reference this item")}catch(PERR){g.reportError(PERR)}var parentItems=self.getItemList(parent,entry.arch);try{g.PAssert(898,parentItems,"If the item has been seen here, we will always have a valid parent list")}catch(PERR){g.reportError(PERR)}if(parentItems){var remoteIndex=parentItems.indexOf(entryID);if(remoteIndex>=0)self.beginWriteAction(),parentItems.remove(remoteIndex);else try{g.PAssert(899,!1,"If we previously saw this item, we expect to be able to delete it from the parent list")}catch(PERR){g.reportError(PERR)}}}entry.ref||entry.isRoot||(log(entryID,": Item exists remotely but is not referenced by a parent"),log("   : ",self.get(itemCache[entryID],"text")),delete itemCache[entryID]),entry.isRoot&&entry.ref&&(log(entryID,": Remote root has a parent"),localDataError=!0)}d.removeDeletedItems(seen),self.endAction()},self.migrateData=function migrateDataFn(){function reloadFn(){reqCount++,2===reqCount&&g.reload()}var stopDocLoad=!1,requireLocalReload=!1,requireRemoteReload=!1,remoteVersion=self.root.get("dataVersion");if(CURRENT_VERSION>remoteVersion){self.beginAction(),log("Migrating to latest version: ",remoteVersion);try{switch(remoteVersion){case 1:migrateItemData_One(self.root);case 2:migrateItemData_Two(self.root);case 3:migrateItemData_Three(self.root),requireRemoteReload=!0;case 4:migrateItemData_Four(self.root);default:log("Remote Migration Completed")}}catch(err){requireRemoteReload=!0,g.reportError(err)}self.endAction(),self.model.getRoot().set("dataVersion",CURRENT_VERSION),log("Done Migrating Remote Data!",CURRENT_VERSION)}else remoteVersion>CURRENT_VERSION&&(requireLocalReload=!0,stopDocLoad=!0);if(d.hasLocalData){var localVersion=g.settings.get(Settings.localDataVersion)||0;if(CURRENT_VERSION>localVersion){try{switch(localVersion){case 0:d.migrateLocalData_One(),requireLocalReload=!0,stopDocLoad=!0;case 4:d.migrateLocalData_Two();default:log("Local Migration Completed")}}catch(err){requireLocalReload=!0,g.reportError(err)}g.settings.set(Settings.localDataVersion,CURRENT_VERSION),log("Done Migrating Local Data!",CURRENT_VERSION)}}else g.settings.set(Settings.localDataVersion,remoteVersion);if(requireLocalReload||requireRemoteReload)if(requireLocalReload&&!requireRemoteReload)g.AppCache.runOnFinish(function(){g.reload()},!0);else if(requireRemoteReload&&!requireLocalReload)self.registerSaveNotify(function(){g.reload()});else{var reqCount=0;g.AppCache.runOnFinish(reloadFn,!0),self.registerSaveNotify(reloadFn)}return stopDocLoad},self.beginAction=function beginActionFn(){if(self.model){try{g.PAssert(922,!self.flushingDeferredActions,"Should never begin a new action while flushing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(923,!self.inCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}try{g.PAssert(924,!self.wantCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}try{g.PAssert(925,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}self.wantCompoundOperation=!0}};var ensureActionTimeout=void 0;self.beginWriteAction=function beginWriteActionFn(){if(self.model&&!self.flushingDeferredActions){try{g.PAssert(926,self.inCompoundOperation||self.wantCompoundOperation,"If performing an action, we should have already requested a compound operation")}catch(PERR){g.reportError(PERR)}if(!self.inCompoundOperation&&self.wantCompoundOperation)self.flushDeferredActions(),setTimeout(ensureWriteAction,0),self.model.beginCompoundOperation(),self.inCompoundOperation=!0,self.wantCompoundOperation=!1;else try{g.PAssert(927,!self.wantCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}}},self.endAction=function endActionFn(){if(self.model){try{g.PAssert(928,!self.flushingDeferredActions,"Should never end an action while flushing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(929,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(930,self.inCompoundOperation||self.wantCompoundOperation,"If ending an action, a beginning should have happened")}catch(PERR){g.reportError(PERR)}try{self.inCompoundOperation&&self.model.endCompoundOperation()}catch(err){g.goog.recoverFromError(err)}finally{self.inCompoundOperation=!1,self.wantCompoundOperation=!1,clearTimeout(ensureActionTimeout)}}};var DEFERRED_ACTION_TIMEOUT=800,deferredActions={},hasPendingDeferredActions=!1,flushDeferredActionsTimeout=void 0;self.performDeferredAction=function performDeferredActionFn(item,action){try{g.PAssert(933,item,"Must supply a valid item to perform the action on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(934,action,"Must supply a valid action to be performed")}catch(PERR){g.reportError(PERR)}if(self.model){try{g.PAssert(935,!self.inCompoundOperation,"Cannot perform deferred action after a compound operation has started")}catch(PERR){g.reportError(PERR)}if(deferredActions[item.id])for(var prop in action)deferredActions[item.id].changes[prop]=action[prop];else deferredActions[item.id]={item:item,changes:action};hasPendingDeferredActions=!0,clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=setTimeout(self.flushDeferredActions,DEFERRED_ACTION_TIMEOUT)}},self.flushDeferredActions=function flushDeferredActionsFn(){if(self.model&&!self.isClosed){try{g.PAssert(936,!self.flushingDeferredActions,"Should never recursively call flushDeferredActions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(937,!self.inCompoundOperation,"Must flush deferred actions before starting a compound operation")}catch(PERR){g.reportError(PERR)}if(hasPendingDeferredActions){clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=void 0,self.flushingDeferredActions=!0;try{self.model.beginCompoundOperation();try{for(var id in deferredActions)saveChangesInternal(deferredActions[id].item,deferredActions[id].changes);self.flushingDeferredActions=!1,hasPendingDeferredActions=!1,deferredActions={}}catch(innerErr){g.reportError(err)}self.model.endCompoundOperation()}catch(err){g.reportError(err)}}}},self.createNewItem=function createNewItemFn(item,hasItems,hasArchivedItems){self.beginWriteAction();try{g.PAssert(941,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(942,self.inCompoundOperation,"Should always create an item inside of a compound operation")}catch(PERR){g.reportError(PERR)}try{g.PAssert(943,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(944,self.model,"Need a valid model to create collaborative items")}catch(PERR){g.reportError(PERR)}try{g.PAssert(945,!item.data,"When initializing a new item, it should have no gdata components already")}catch(PERR){g.reportError(PERR)}var map=self.model.createMap();if(item.data=map,self.set(map,"text",item.getRawText()),hasItems){var collabList=self.model.createList();self.set(map,"items",collabList)}if(hasArchivedItems){var collabArchiveList=self.model.createList();self.set(map,"archivedItems",collabArchiveList)}return self.set(map,"dateCreated",item.dateCreated.getTime()),item.id=map.id,itemCache[map.id]||(itemCache[map.id]=map),map.id},self.initializeNewItem=function initializeNewItemFn(item){self.beginWriteAction();try{g.PAssert(946,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(947,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(948,self.inCompoundOperation,"Should always initialize an item inside of a compound operation")}catch(PERR){g.reportError(PERR)}if(item.hasChildren()){var items=item.items(),collabList=ensureRemoteItemsArray(item);try{g.PAssert(949,collabList)}catch(PERR){g.reportError(PERR)}for(var i=0;i<items.length;++i){try{g.PAssert(950,items[i].data,"Item must have a valid remote to be added to a collab list")}catch(PERR){g.reportError(PERR)}collabList.push(items[i].data)}}if(item.hasArchivedChildren()){var archivedItems=item.archivedItems(!0),collabArchivedList=ensureRemoteArchiveArray(item);try{g.PAssert(951,collabArchivedList)}catch(PERR){g.reportError(PERR)}for(var i=0;i<archivedItems.length;++i){try{g.PAssert(952,archivedItems[i].data,"Item must have a valid remote to be added to a collab list")}catch(PERR){g.reportError(PERR)}collabArchivedList.push(archivedItems[i].data)}}attachEvents(item)},self.attachEventsToItem=function attachEventsToItemFn(item){try{g.PAssert(953,item instanceof VMLI,"Must pass in a valid local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(954,item.data,"Must have loaded data from gdrive before attaching events to item")}catch(PERR){g.reportError(PERR)}attachEvents(item)};var undoRedoStateChangeHandler;self.registerForUndoRedoStateChange=function registerForUndoRedoStateChangeFn(handler){self.model?(self.model.addEventListener(gapi.drive.realtime.EventType.UNDO_REDO_STATE_CHANGED,handler.stateChangeForUndoRedo),handler.stateChangeForUndoRedo({canUndo:self.model.canUndo,canRedo:self.model.canRedo})):undoRedoStateChangeHandler=handler},self.registerForSaveStateChange=function registerForSaveStateChangeFn(handler){try{g.PAssert(955,self.doc,"Must have a valid doc to connect to")}catch(PERR){g.reportError(PERR)}self.doc.addEventListener(gapi.drive.realtime.EventType.DOCUMENT_SAVE_STATE_CHANGED,handler)},self.loadCollaborators=function loadCollaboratorsFn(){for(var collabs=self.doc.getCollaborators(),selfInfo=void 0,i=0;i<collabs.length;++i){var collab=collabs[i];collab.isMe&&(selfInfo=collab)}self.authenticatedUser(selfInfo)},self.undoAction=function undoActionFn(){self.flushDeferredActions();try{g.PAssert(956,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(957,self.model.canUndo)}catch(PERR){g.reportError(PERR)}self.model.undo()},self.redoAction=function redoActionFn(){self.flushDeferredActions();try{g.PAssert(958,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(959,self.model.canRedo)}catch(PERR){g.reportError(PERR)}self.model.redo()},self.getItemList=function getItemListFn(model,isArchived){self.beginWriteAction();try{g.PAssert(960,!(model instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return isArchived?self.get(model,"archivedItems"):self.get(model,"items")},self.ensureItemList=function ensureItemListFn(item,isArchived){self.beginWriteAction();try{g.PAssert(961,item instanceof VMLI,"Must pass in a valid local item")}catch(PERR){g.reportError(PERR)}return isArchived?ensureRemoteArchiveArray(item):ensureRemoteItemsArray(item)},self.canSave=function canSaveFn(item){if(self.initialized){var data=item instanceof VMLI?item.data:item;try{g.PAssert(966,data,"Must have a valid remote item to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(967,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}return data&&!self.isClosed?data:!1}},self.deleteTree=function deleteTreeFn(item){self.beginWriteAction();try{g.PAssert(968,!(item instanceof VMLI),"Must not be a VMLI, should be a remote item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(969,!g.isString(item),"Must pass in a valid remote item not an ID")}catch(PERR){g.reportError(PERR)}var items=self.get(item,"items");if(items)for(var i=0;i<items.length;i++){var child=items.get(i);self.deleteTree(child)}delete itemCache[item.id]},self.itemAdded=function itemAddedFn(params){self.beginWriteAction();var item=params.item,addedItem=params.addedItem,index=params.index,isArchived=params.isArchived,noVersion=params.noVersion;try{g.PAssert(970,void 0!==item&&void 0!==addedItem&&void 0!==isArchived,"itemAdded is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(971,index>=-1||void 0===index,"Invalid index",index)}catch(PERR){g.reportError(PERR)}var itemData=self.canSave(item);if(itemData){var addedData=addedItem.data;try{g.PAssert(972,addedData,"Must have valid gdata for the item being inserted")}catch(PERR){g.reportError(PERR)}d.addPendingUpdate(item.id),d.addPendingUpdate(addedItem.id);var arr=self.ensureItemList(item,isArchived);try{g.PAssert(973,arr,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}0>index||isNaN(index)||index>arr.length?arr.push(addedData):arr.insert(index,addedData),noVersion||setRemoteVersion(addedItem.data)}},self.itemsAdded=function itemsAddedFn(params){self.beginWriteAction();var item=params.item;try{g.PAssert(974,item instanceof VMLI,"Passed in item must be a VMLI")}catch(PERR){g.reportError(PERR)}var addedItems=params.addedItems,index=params.index,isArchived=params.isArchived,noVersion=params.noVersion;try{g.PAssert(975,void 0!==item&&void 0!==addedItems&&void 0!==isArchived,"itemsAdded is missing parameters")}catch(PERR){g.reportError(PERR)}var itemData=self.canSave(item);if(itemData){var arr=self.ensureItemList(item,isArchived);try{g.PAssert(976,arr,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}for(var addedArr=new Array(addedItems.length),i=0;i<addedItems.length;++i)addedArr[i]=addedItems[i].data,d.addPendingUpdate(addedItems[i].id),!noVersion&&addedArr[i]&&setRemoteVersion(addedArr[i]);if(d.addPendingUpdate(item.id),0>index||isNaN(index)){try{g.PAssert(977,isArchived,"Only archived items should be inserted into a list by pushing")}catch(PERR){g.reportError(PERR)}arr.pushAll(addedArr)}else arr.insertAll(index,addedArr)}},self.itemRemoved=function itemRemovedFn(params){self.beginWriteAction();var item=params.item,index=params.index,numToRemove=params.numToRemove,isArchived=params.isArchived,noDelete=params.noDelete,noVersion=params.noVersion;try{g.PAssert(978,void 0!==item&&void 0!==index&&void 0!==numToRemove&&void 0!==isArchived,"itemRemoved is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(979,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}var itemData=self.canSave(item);if(itemData){isNaN(numToRemove)&&(numToRemove=1);var arr=self.getItemList(itemData,isArchived);try{g.PAssert(980,arr,"Must have a valid remote list to remove the item from")}catch(PERR){g.reportError(PERR)}for(var i=index;index+numToRemove>i;i++){var deleted=arr.get(i);d.addPendingUpdate(deleted.id),noVersion||setRemoteVersion(deleted),noDelete||self.deleteTree(deleted)}d.addPendingUpdate(item.id),1===numToRemove?arr.remove(index):arr.removeRange(index,index+numToRemove)}},self.itemMoved=function itemMovedFn(params){self.beginWriteAction();var item=params.item,newInfo=params.newInfo,oldParent=params.oldParent,oldInfo=params.oldInfo,noVersion=params.noVersion;try{g.PAssert(981,void 0!==item&&void 0!==newInfo&&void 0!==oldParent&&void 0!==oldInfo,"itemMoved is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(982,newInfo&&newInfo.index>=-1)}catch(PERR){g.reportError(PERR)}try{g.PAssert(983,newInfo&&void 0!==newInfo.isArchived)}catch(PERR){g.reportError(PERR)}try{g.PAssert(984,oldParent)}catch(PERR){g.reportError(PERR)}try{g.PAssert(985,oldInfo&&oldInfo.index>=0)}catch(PERR){g.reportError(PERR)}try{g.PAssert(986,oldInfo&&void 0!==oldInfo.isArchived)}catch(PERR){g.reportError(PERR)}var itemData=self.canSave(item);itemData&&(d.addPendingUpdate(item.id),self.itemRemoved({item:oldParent,index:oldInfo.index,numToRemove:1,isArchived:oldInfo.isArchived,noDelete:!0,noVersion:!0}),self.itemAdded({item:item.parent(),addedItem:item,index:newInfo.index,isArchived:newInfo.isArchived,noVersion:noVersion}))},self.itemArchived=function itemArchivedFn(item,itemArchived,index){try{g.PAssert(987,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}self.beginWriteAction();var itemData=self.canSave(item);if(itemData){d.addPendingUpdate(item.id),d.addPendingUpdate(itemArchived.id);var items=self.get(itemData,"items");try{g.PAssert(988,items,"Must be an items array present")}catch(PERR){g.reportError(PERR)}var archivedItems=ensureRemoteArchiveArray(item);try{g.PAssert(989,archivedItems,"Must be an archived items array present")}catch(PERR){g.reportError(PERR)}items.remove(index),archivedItems.push(itemArchived.data),setRemoteVersion(itemArchived.data)}},self.itemUnarchived=function itemUnarchivedFn(item,itemUnarchived,removeIndex,insertIndex){try{g.PAssert(990,removeIndex>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}self.beginWriteAction();var itemData=self.canSave(item);if(itemData){d.addPendingUpdate(item.id),d.addPendingUpdate(itemUnarchived.id);var items=self.get(itemData,"items");try{g.PAssert(991,items,"Must be an items array present")}catch(PERR){g.reportError(PERR)}var archivedItems=self.get(itemData,"archivedItems");try{g.PAssert(992,archivedItems,"Must be an archived items array present")}catch(PERR){g.reportError(PERR)}archivedItems.remove(removeIndex),items.insert(insertIndex,itemUnarchived.data),setRemoteVersion(itemUnarchived.data)}},self.saveChanges=function saveChangesFn(item,changes){self.inCompoundOperation?saveChangesInternal(item,changes):self.performDeferredAction(item,changes)};var RECONNECT_RETRY_INTERVAL=3e4,retryCount=0,driveReconnectTimer=void 0;self.setupReconnect=function setupReconnectFn(){if(log("Setup Reconnect: ",retryCount,driveReconnectTimer),!driveReconnectTimer){var retryTimeout=0===retryCount?500:RECONNECT_RETRY_INTERVAL;retryCount++,driveReconnectTimer=setTimeout(tryDriveReconnect,retryTimeout)}},self.resetDriveData=function resetDriveDataFn(){itemCache={},self.initialized=!1,self.doc=void 0,self.model=void 0,self.root=void 0,self.rootItem=void 0,self.rootID=void 0,window.__remoteDoc=void 0,d.forEachModel(function(vmli){vmli&&vmli.resetDriveData()
}),g.vmMain.notifyDriveDisconnect(),self.inCompoundOperation=!1,self.wantCompoundOperation=!1,self.flushingDeferredActions=!1,clearTimeout(ensureActionTimeout),ensureActionTimeout=void 0,clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=void 0,hasPendingDeferredActions=!1,deferredActions={}},self.close=function closeFn(info){try{g.PAssert(1e3,!self.wantCompoundOperation,"Closing the doc with a deferred compound operation")}catch(PERR){g.reportError(PERR)}if(self.doc&&!self.isClosed){log("---- Closing Remote Document! ----",info),self.isClosed=!0,g.vmMain.setGDriveStatus(DriveStatus.Offline);try{self.doc.close()}catch(err){log("Error Closing Doc: ",err)}self.resetDriveData()}self.setupReconnect()},self.onInitialized=function onInitializedFn(model){log("Initializing",model),d||(d=require("data")),VMLI||(VMLI=require("VMLI"));var home=model.createMap(),homeItems=model.createList();self.set(home,"text","Home"),self.set(home,"items",homeItems),self.set(home,"archivedItems",model.createList()),self.set(home,"dateCreated",Date.now());var root=model.getRoot();root.set("dataVersion",CURRENT_VERSION),root.set("root",home)},self.saveSetting=function saveSettingFn(e){self.flushDeferredActions();try{g.PAssert(1001,self.settingsRemote,"Remote settings required to sync")}catch(PERR){g.reportError(PERR)}if(!e.data.isRemote){var value=e.data.value,property=e.data.property;property.startsWith(g.settings.prefix)&&(value=Math.abs(value),g.settings.setVersion(property,value)),self.settingsLocal[property]!==value&&(self.settingsLocal[property]=value,self.isConnected()&&self.settingsRemote.set(property,value))}},self.onRemoteSettingsLoad=function onRemoteSettingsLoadFn(){g.settings.set(Settings.syncContacts,self.settingsLocal[Settings.syncContacts],self.settingsLocal[g.settings.prefix+Settings.syncContacts])&&g.goog.authAndLoadContacts(),g.settings.set(Settings.docSharing,self.settingsLocal[Settings.docSharing],self.settingsLocal[g.settings.prefix+Settings.docSharing])&&g.goog.authDocSharing(),window.addEventListener("settingsChange",self.saveSetting)},self.loadSettings=function loadSettingsFn(){self.settingsLocal={},self.settingsRemote=self.root.get("settings"),self.settingsRemote||(self.settingsRemote=self.model.createMap(),self.root.set("settings",self.settingsRemote));try{self.settingsLocal[Settings.syncContacts]=self.settingsRemote.get(Settings.syncContacts);var syncContactsV=g.settings.prefix+Settings.syncContacts;self.settingsLocal[syncContactsV]=self.settingsRemote.get(syncContactsV),self.settingsLocal[Settings.docSharing]=self.settingsRemote.get(Settings.docSharing);var docSharingV=g.settings.prefix+Settings.docSharing;self.settingsLocal[docSharingV]=self.settingsRemote.get(docSharingV),self.settingsLocal[Settings.theme]=self.settingsRemote.get(Settings.theme);var themeV=g.settings.prefix+Settings.theme;self.settingsLocal[themeV]=self.settingsRemote.get(themeV),self.settingsRemote.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,onSettingsChanged.bind(self))}catch(err){g.reportError(err)}},self.poke=function pokeFn(){if(self.root&&!self.isClosed)try{var pk=self.root.get("poke");pk?self.root.set("poke",pk+1):self.root.set("poke",1)}catch(err){self.close()}},window.__poke=self.poke,self.rootChanged=function rootChangedFn(e){if(e.ocHandled||e.isLocal||self.root.id!==e.target.id)return!1;for(var i=0;i<e.events.length;++i)switch(e.events[i].type){case gapi.drive.realtime.EventType.VALUES_ADDED:case gapi.drive.realtime.EventType.VALUES_REMOVED:break;case gapi.drive.realtime.EventType.VALUE_CHANGED:"dataVersion"===e.property&&(e.newValue>CURRENT_VERSION?g.AppCache.checkForUpdate(!0):e.newVersion<CURRENT_VERSION&&g.reportError(new Error("Remote setting dataVersion to invalid value"+e.newVersion)));break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:try{g.PAssert(1002,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}},self.isConnected=function isConnectedFn(){return self.initialized&&!self.isClosed&&!!self.model},self.onLoad=function onLoadFn(doc){try{try{g.PAssert(1003,self.isClosed,"Document must not already be open when we are loading")}catch(PERR){g.reportError(PERR)}self.initialized=!0,d||(d=require("data")),VMLI||(VMLI=require("VMLI")),self.doc=doc,self.model=doc.getModel(),self.root=self.model.getRoot(),self.root.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,self.rootChanged),self.isClosed=!1,self.registerForSaveStateChange(self.onSaveStateChange),retryCount>0&&(log("Reconnect Successful: "+retryCount),clearTimeout(driveReconnectTimer),driveReconnectTimer=void 0,retryCount=0);var stopLoadingRemote=self.migrateData();return stopLoadingRemote?(log("---- Skipping Document Load! ----"),self.isClosed=!0,self.initialized=!1,self.doc=void 0,self.model=void 0,self.root=void 0,!1):(self.loadSettings(),self.rootItem=self.root.get("root"),self.rootItem?(self.rootID=self.rootItem.id,window.__remoteDoc=doc,undoRedoStateChangeHandler&&(self.registerForUndoRedoStateChange(undoRedoStateChangeHandler),undoRedoStateChangeHandler=void 0),g.vmMain&&g.vmMain.root()?g.vmMain.loadGDriveData():g.requireGDriveDataCallback=!0,self.loadCollaborators(),!0):void g.messageQueue.pushMessage({text:"Document is corrupted, "+platform.actionVerb()+" to reload. If the problem persists, please contact support.",type:MessageType.Fatal,action:MessageAction.ResetClient}))}catch(err){g.reportError(err)}},self.getServerVersion=function getServerVersionFn(){return self.model&&!self.isClosed?self.model.serverVersion:void 0};var notifyOfSaveChange=[];self.registerSaveNotify=function registerSaveNotifyFn(fn){notifyOfSaveChange.push(fn)};var lastPending=!1,lastSaving=!1,saveTimeout;return self.onSaveStateChange=function onSaveStateChangeFn(e){if(lastPending!==e.isPending||lastSaving!==e.isSaving){if(e.isSaving||e.isPending)navigator.onLine?e.isSaving&&(e.isPending||g.vmMain.setGDriveStatus(DriveStatus.Saving),clearTimeout(saveTimeout),saveTimeout=platform.mobile?setTimeout(self.onErrorSaving,12e3):setTimeout(self.onErrorSaving,8e3)):g.vmMain.setGDriveStatus(DriveStatus.Offline);else{g.vmMain.setGDriveStatus(DriveStatus.Saved),d.clearPendingUpdates(),clearTimeout(saveTimeout),saveTimeout=void 0,g.messageQueue.clearMessage(MessageID.ConnectionError);for(var i=0;i<notifyOfSaveChange.length;++i)notifyOfSaveChange[i]()}lastPending=e.isPending,lastSaving=e.isSaving}},self.onErrorSaving=function onErrorSavingFn(){g.vmMain.setGDriveStatus(DriveStatus.Offline),saveTimeout=void 0},self.getVersion=function getVersionFn(map,type){try{g.PAssert(1004,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}var field,v;switch(type){case VersionType.Structure:v=map.get(g.translateFieldIn("version"));break;case VersionType.Text:v=map.get(g.translateFieldIn("versionText"));break;default:v=-2;try{g.PAssert(1005,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},self.get=function getFn(map,field){try{g.PAssert(1006,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return map.get(g.translateFieldIn(field))},self.set=function setFn(map,field,value){self.beginWriteAction();try{g.PAssert(1007,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return void 0===value&&(value=null),map.set(g.translateFieldIn(field),value)},self.delete=function deleteFn(map,field){self.beginWriteAction();try{g.PAssert(1008,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return map.delete(g.translateFieldIn(field))},self.findInTree=function findInTreeFn(item,searched){function findItemInTree(arr,isArchived){if(!arr)return!1;for(var i=0;i<arr.length;i++){var result=arr.get(i);if(result.id==item.id)return{parent:searched,index:i,isArchived:isArchived};var found=self.findInTree(item,result);if(found)return found}return void 0}searched||(searched=self.rootItem);var items=self.get(searched,"items"),foundItem=findItemInTree(items,!1);if(!foundItem){var archivedItems=self.get(searched,"archivedItems");foundItem=findItemInTree(archivedItems,!0)}return foundItem},self});var idbModules={},cleanInterface=!1;!function(){var testObject={test:!0};if(Object.defineProperty)try{Object.defineProperty(testObject,"test",{enumerable:!1}),testObject.test&&(cleanInterface=!0)}catch(e){}}(),function(idbModules){function callback(fn,context,event,func){event.target=context,"function"==typeof context[fn]&&context[fn].apply(context,[event]),"function"==typeof func&&func()}function throwDOMException(name,message,error){var e=new DOMException.prototype.constructor(0,message);throw e.name=name,e.message=message,e}var StringList=function(){this.length=0,this._items=[],cleanInterface&&Object.defineProperty(this,"_items",{enumerable:!1})};if(StringList.prototype={contains:function(str){return-1!==this._items.indexOf(str)},item:function(key){return this._items[key]},indexOf:function(str){return this._items.indexOf(str)},push:function(item){this._items.push(item),this.length+=1;for(var i=0;i<this._items.length;i++)this[i]=this._items[i]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var i in this)i===String(parseInt(i,10))&&delete this[i];for(i=0;i<this._items.length;i++)this[i]=this._items[i]}},cleanInterface)for(var i in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(StringList.prototype,i,{enumerable:!1});idbModules.util={throwDOMException:throwDOMException,callback:callback,quote:function(arg){return"'"+arg+"'"},StringList:StringList}}(idbModules),function(idbModules){var Sca=function(){return{decycle:function(object,callback){function checkForCompletion(){0===queuedObjects.length&&returnCallback(derezObj)}function readBlobAsDataURL(blob,path){var reader=new FileReader;reader.onloadend=function(loadedEvent){var dataURL=loadedEvent.target.result,blobtype="blob";updateEncodedBlob(dataURL,path,blobtype)},reader.readAsDataURL(blob)}function updateEncodedBlob(dataURL,path,blobtype){var encoded=queuedObjects.indexOf(path);path=path.replace("$","derezObj"),eval(path+'.$enc="'+dataURL+'"'),eval(path+'.$type="'+blobtype+'"'),queuedObjects.splice(encoded,1),checkForCompletion()}function derez(value,path){var i,name,nu;if(!("object"!=typeof value||null===value||value instanceof Boolean||value instanceof Date||value instanceof Number||value instanceof RegExp||value instanceof Blob||value instanceof String)){for(i=0;i<objects.length;i+=1)if(objects[i]===value)return{$ref:paths[i]};if(objects.push(value),paths.push(path),"[object Array]"===Object.prototype.toString.apply(value))for(nu=[],i=0;i<value.length;i+=1)nu[i]=derez(value[i],path+"["+i+"]");else{nu={};for(name in value)Object.prototype.hasOwnProperty.call(value,name)&&(nu[name]=derez(value[name],path+"["+JSON.stringify(name)+"]"))}return nu}return value instanceof Blob?(queuedObjects.push(path),readBlobAsDataURL(value,path)):value instanceof Boolean?value={$type:"bool",$enc:value.toString()}:value instanceof Date?value={$type:"date",$enc:value.getTime()}:value instanceof Number?value={$type:"num",$enc:value.toString()}:value instanceof RegExp&&(value={$type:"regex",$enc:value.toString()}),value}var objects=[],paths=[],queuedObjects=[],returnCallback=callback,derezObj=derez(object,"$");checkForCompletion()},retrocycle:function retrocycle($){function dataURLToBlob(dataURL){var BASE64_MARKER=";base64,",contentType,parts,raw;if(-1===dataURL.indexOf(BASE64_MARKER))return parts=dataURL.split(","),contentType=parts[0].split(":")[1],raw=parts[1],new Blob([raw],{type:contentType});parts=dataURL.split(BASE64_MARKER),contentType=parts[0].split(":")[1],raw=window.atob(parts[1]);for(var rawLength=raw.length,uInt8Array=new Uint8Array(rawLength),i=0;rawLength>i;++i)uInt8Array[i]=raw.charCodeAt(i);return new Blob([uInt8Array.buffer],{type:contentType})}function rez(value){var i,item,name,path;if(value&&"object"==typeof value)if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"==typeof item&&(path=item.$ref,value[i]="string"==typeof path&&px.test(path)?eval(path):rez(item));else if(void 0!==value.$type)switch(value.$type){case"blob":case"file":value=dataURLToBlob(value.$enc);break;case"bool":value=Boolean("true"===value.$enc);break;case"date":value=new Date(value.$enc);break;case"num":value=Number(value.$enc);break;case"regex":value=eval(value.$enc)}else for(name in value)"object"==typeof value[name]&&(item=value[name],item&&(path=item.$ref,value[name]="string"==typeof path&&px.test(path)?eval(path):rez(item)));return value}var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return rez($),$},encode:function(val,callback){function finishEncode(val){callback(JSON.stringify(val))}this.decycle(val,finishEncode)},decode:function(val){return this.retrocycle(JSON.parse(val))}}}();idbModules.Sca=Sca}(idbModules),function(idbModules){var collations=["","number","string","boolean","object","undefined"],getGenericEncoder=function(){return{encode:function(key){return collations.indexOf(typeof key)+"-"+JSON.stringify(key)},decode:function(key){return"undefined"==typeof key?void 0:JSON.parse(key.substring(2))}}},types={number:getGenericEncoder("number"),"boolean":getGenericEncoder(),object:getGenericEncoder(),string:{encode:function(key){return collations.indexOf("string")+"-"+key},decode:function(key){return""+key.substring(2)}},undefined:{encode:function(key){return collations.indexOf("undefined")+"-undefined"},decode:function(key){return void 0}}},Key=function(){return{encode:function(key){return types[typeof key].encode(key)},decode:function(key){return types[collations[key.substring(0,1)]].decode(key)}}}();idbModules.Key=Key}(idbModules),function(idbModules,undefined){var Event=function(type,debug){return{type:type,debug:debug,bubbles:!1,cancelable:!1,eventPhase:0,timeStamp:new Date}};idbModules.Event=Event}(idbModules),function(idbModules){var IDBRequest=function(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"},IDBOpenRequest=function(){this.onblocked=this.onupgradeneeded=null};IDBOpenRequest.prototype=IDBRequest,idbModules.IDBRequest=IDBRequest,idbModules.IDBOpenRequest=IDBOpenRequest}(idbModules),function(idbModules,undefined){var IDBKeyRange=function(lower,upper,lowerOpen,upperOpen){this.lower=lower,this.upper=upper,this.lowerOpen=lowerOpen,this.upperOpen=upperOpen};IDBKeyRange.only=function(value){return new IDBKeyRange(value,value,!1,!1)},IDBKeyRange.lowerBound=function(value,open){return new IDBKeyRange(value,undefined,open,undefined)},IDBKeyRange.upperBound=function(value){return new IDBKeyRange(undefined,value,undefined,open)},IDBKeyRange.bound=function(lower,upper,lowerOpen,upperOpen){return new IDBKeyRange(lower,upper,lowerOpen,upperOpen)},idbModules.IDBKeyRange=IDBKeyRange}(idbModules),function(idbModules,undefined){function IDBCursor(range,direction,idbObjectStore,cursorRequest,keyColumnName,valueColumnName){this.__range=range,this.source=this.__idbObjectStore=idbObjectStore,this.__req=cursorRequest,this.key=undefined,this.direction=direction,this.__keyColumnName=keyColumnName,this.__valueColumnName=valueColumnName,this.__valueDecoder="value"===valueColumnName?idbModules.Sca:idbModules.Key,this.source.transaction.__active||idbModules.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active."),this.__offset=-1,this.__lastKeyContinued=undefined,this["continue"]()}IDBCursor.prototype.__find=function(key,tx,success,error,recordsToLoad){recordsToLoad=recordsToLoad||1;var me=this,sql=["SELECT * FROM ",idbModules.util.quote(me.__idbObjectStore.name)],sqlValues=[];sql.push("WHERE ",me.__keyColumnName," NOT NULL"),me.__range&&(me.__range.lower||me.__range.upper)&&(sql.push("AND"),me.__range.lower&&(sql.push(me.__keyColumnName+(me.__range.lowerOpen?" >":" >= ")+" ?"),sqlValues.push(idbModules.Key.encode(me.__range.lower))),me.__range.lower&&me.__range.upper&&sql.push("AND"),me.__range.upper&&(sql.push(me.__keyColumnName+(me.__range.upperOpen?" < ":" <= ")+" ?"),sqlValues.push(idbModules.Key.encode(me.__range.upper)))),"undefined"!=typeof key&&(me.__lastKeyContinued=key,me.__offset=0),me.__lastKeyContinued!==undefined&&(sql.push("AND "+me.__keyColumnName+" >= ?"),sqlValues.push(idbModules.Key.encode(me.__lastKeyContinued))),sql.push("ORDER BY ",me.__keyColumnName),sql.push("LIMIT "+recordsToLoad+" OFFSET "+me.__offset),me.__prefetchedData=null,tx.executeSql(sql.join(" "),sqlValues,function(tx,data){data.rows.length>1?(me.__prefetchedData=data.rows,me.__prefetchedIndex=0,me.__decode(data.rows.item(0),success)):1===data.rows.length?me.__decode(data.rows.item(0),success):success(undefined,undefined)},function(tx,data){error(data)})},IDBCursor.prototype.__decode=function(rowItem,callback){var key=idbModules.Key.decode(rowItem[this.__keyColumnName]),val=this.__valueDecoder.decode(rowItem[this.__valueColumnName]),primaryKey=idbModules.Key.decode(rowItem.key);callback(key,val,primaryKey)},IDBCursor.prototype["continue"]=function(key){var recordsToPreloadOnContinue=idbModules.cursorPreloadPackSize||1e4,me=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__offset++;var successCallback=function(key,val,primaryKey){me.key=key,me.value=val,me.primaryKey=primaryKey,success("undefined"!=typeof me.key?me:undefined,me.__req)};return me.__prefetchedData&&(me.__prefetchedIndex++,me.__prefetchedIndex<me.__prefetchedData.length)?void me.__decode(me.__prefetchedData.item(me.__prefetchedIndex),successCallback):void me.__find(key,tx,successCallback,error,recordsToPreloadOnContinue)})},IDBCursor.prototype.advance=function(count){0>=count&&idbModules.util.throwDOMException("Type Error - Count is invalid - 0 or negative",count);var me=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__offset+=count,me.__find(undefined,tx,function(key,value){me.key=key,me.value=value,success("undefined"!=typeof me.key?me:undefined,me.__req)},error)})},IDBCursor.prototype.update=function(valueToUpdate){var me=this,request=this.__idbObjectStore.transaction.__createRequest(function(){});return idbModules.Sca.encode(valueToUpdate,function(encoded){me.__idbObjectStore.transaction.__pushToQueue(request,function(tx,args,success,error){me.__find(undefined,tx,function(key,value,primaryKey){var sql="UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" SET value = ? WHERE key = ?";tx.executeSql(sql,[encoded,idbModules.Key.encode(primaryKey)],function(tx,data){1===data.rowsAffected?success(key):error("No rows with key found"+key)},function(tx,data){error(data)})},error)})}),request},IDBCursor.prototype["delete"]=function(){var me=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__find(undefined,tx,function(key,value,primaryKey){var sql="DELETE FROM  "+idbModules.util.quote(me.__idbObjectStore.name)+" WHERE key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){1===data.rowsAffected?(me.__offset--,success(undefined)):error("No rows with key found"+key)},function(tx,data){error(data)})},error)})},idbModules.IDBCursor=IDBCursor}(idbModules),function(idbModules,undefined){function IDBIndex(indexName,idbObjectStore){this.indexName=this.name=indexName,this.__idbObjectStore=this.objectStore=this.source=idbObjectStore;var indexList=idbObjectStore.__storeProps&&idbObjectStore.__storeProps.indexList;indexList&&(indexList=JSON.parse(indexList)),this.keyPath=indexList&&indexList[indexName]&&indexList[indexName].keyPath||indexName,["multiEntry","unique"].forEach(function(prop){this[prop]=!!(indexList&&indexList[indexName]&&indexList[indexName].optionalParams&&indexList[indexName].optionalParams[prop])},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this,transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(){idbModules.util.throwDOMException(0,"Could not create new index",arguments)}2!==transaction.mode&&idbModules.util.throwDOMException(0,"Invalid State error, not a version transaction",me.transaction);var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);"undefined"!=typeof idxList[indexName]&&idbModules.util.throwDOMException(0,"Index already exists on store",idxList);var columnName=indexName;idxList[indexName]={columnName:columnName,keyPath:keyPath,optionalParams:optionalParameters},me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",columnName,"BLOB"].join(" ");tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){!function initIndexForRow(i){if(i<data.rows.length)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+columnName+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(tx,data){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",!0),success(me)},error)}(0)},error)},error)},"createObjectStore")})},IDBIndex.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this.source,cursorRequest,this.indexName,"value");return cursorRequest},IDBIndex.prototype.openKeyCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this.source,cursorRequest,this.indexName,"key");return cursorRequest},IDBIndex.prototype.__fetchIndexData=function(key,opType){var me=this;return me.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){var sql=["SELECT * FROM ",idbModules.util.quote(me.__idbObjectStore.name)," WHERE",me.indexName,"NOT NULL"],sqlValues=[];"undefined"!=typeof key&&(sql.push("AND",me.indexName," = ?"),sqlValues.push(idbModules.Key.encode(key))),tx.executeSql(sql.join(" "),sqlValues,function(tx,data){var d;d="count"===opType?data.rows.length:0===data.rows.length?undefined:"key"===opType?idbModules.Key.decode(data.rows.item(0).key):idbModules.Sca.decode(data.rows.item(0).value),success(d)},error)})},IDBIndex.prototype.get=function(key){return this.__fetchIndexData(key,"value")},IDBIndex.prototype.getKey=function(key){return this.__fetchIndexData(key,"key")},IDBIndex.prototype.count=function(key){return this.__fetchIndexData(key,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){var IDBObjectStore=function(name,idbTransaction,ready){this.name=name,this.transaction=idbTransaction,this.__ready={},this.__setReadyState("createObjectStore","undefined"==typeof ready?!0:ready),this.indexNames=new idbModules.util.StringList};IDBObjectStore.prototype.__setReadyState=function(key,val){this.__ready[key]=val},IDBObjectStore.prototype.__waitForReady=function(callback,key){var ready=!0;if("undefined"!=typeof key)ready="undefined"==typeof this.__ready[key]?!0:this.__ready[key];else for(var x in this.__ready)this.__ready[x]||(ready=!1);if(ready)callback();else{var me=this;window.setTimeout(function(){me.__waitForReady(callback,key)},100)}},IDBObjectStore.prototype.__getStoreProps=function(tx,callback,waitOnProperty){var me=this;this.__waitForReady(function(){me.__storeProps?callback(me.__storeProps):tx.executeSql("SELECT * FROM __sys__ where name = ?",[me.name],function(tx,data){1!==data.rows.length?callback():(me.__storeProps={name:data.rows.item(0).name,indexList:data.rows.item(0).indexList,autoInc:data.rows.item(0).autoInc,keyPath:data.rows.item(0).keyPath},callback(me.__storeProps))},function(){callback()})},waitOnProperty)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(tx,data){callback(1!==data.rows.length?0:data.rows.item(0).seq)},function(tx,error){idbModules.util.throwDOMException(0,"Data Error - Could not get the auto increment value for key",error)})}var me=this;me.__getStoreProps(tx,function(props){if(props||idbModules.util.throwDOMException(0,"Data Error - Could not locate defination for this table",props),props.keyPath)if("undefined"!=typeof key&&idbModules.util.throwDOMException(0,"Data Error - The object store uses in-line keys and the key parameter was provided",props),value)try{var primaryKey=eval("value['"+props.keyPath+"']");primaryKey?callback(primaryKey):"true"===props.autoInc?getNextAutoIncKey():idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath")}catch(e){idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath",e)}else idbModules.util.throwDOMException(0,"Data Error - KeyPath was specified, but value was not");else"undefined"!=typeof key?callback(key):"false"===props.autoInc?idbModules.util.throwDOMException(0,"Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props):getNextAutoIncKey()})},IDBObjectStore.prototype.__insertData=function(tx,encoded,value,primaryKey,success,error){var paramMap={};"undefined"!=typeof primaryKey&&(paramMap.key=idbModules.Key.encode(primaryKey));var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes)try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(key in paramMap)sqlStart.push(key+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(encoded);var sql=sqlStart.join(" ")+sqlEnd.join(" ");tx.executeSql(sql,sqlValues,function(tx,data){success(primaryKey)},function(tx,err){error(err)})},IDBObjectStore.prototype.add=function(value,key){var me=this,request=me.transaction.__createRequest(function(){});return idbModules.Sca.encode(value,function(encoded){me.transaction.__pushToQueue(request,function(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){me.__insertData(tx,encoded,value,primaryKey,success,error)})})}),request},IDBObjectStore.prototype.put=function(value,key){var me=this,request=me.transaction.__createRequest(function(){});return idbModules.Sca.encode(value,function(encoded){me.transaction.__pushToQueue(request,function(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){var sql="DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){me.__insertData(tx,encoded,value,primaryKey,success,error)},function(tx,err){error(err)})})})}),request},IDBObjectStore.prototype.get=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var primaryKey=idbModules.Key.encode(key);tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){try{if(0===data.rows.length)return success();success(idbModules.Sca.decode(data.rows.item(0).value))}catch(e){success(void 0)}},function(tx,err){error(err)})})})},IDBObjectStore.prototype["delete"]=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var primaryKey=idbModules.Key.encode(key);tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){success()},function(tx,err){error(err)})})})},IDBObjectStore.prototype.clear=function(){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name),[],function(tx,data){success()},function(tx,err){error(err)})})})},IDBObjectStore.prototype.count=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var sql="SELECT * FROM "+idbModules.util.quote(me.name)+("undefined"!=typeof key?" WHERE key = ?":""),sqlValues=[];"undefined"!=typeof key&&sqlValues.push(idbModules.Key.encode(key)),tx.executeSql(sql,sqlValues,function(tx,data){success(data.rows.length)},function(tx,err){error(err)})})})},IDBObjectStore.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this,cursorRequest,"key","value");return cursorRequest},IDBObjectStore.prototype.index=function(indexName){var index=new idbModules.IDBIndex(indexName,this);return index},IDBObjectStore.prototype.createIndex=function(indexName,keyPath,optionalParameters){var me=this;optionalParameters=optionalParameters||{},me.__setReadyState("createIndex",!1);var result=new idbModules.IDBIndex(indexName,me);return me.__waitForReady(function(){result.__createIndex(indexName,keyPath,optionalParameters)},"createObjectStore"),me.indexNames.push(indexName),result},IDBObjectStore.prototype.deleteIndex=function(indexName){var result=new idbModules.IDBIndex(indexName,this,!1);return result.__deleteIndex(indexName),result},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(idbModules){var READ=0,READ_WRITE=1,VERSION_TRANSACTION=2,IDBTransaction=function(storeNames,mode,db){if("number"==typeof mode)this.mode=mode;else if("string"==typeof mode)switch(mode){case"readwrite":this.mode=READ_WRITE;break;case"readonly":this.mode=READ;break;default:this.mode=READ}this.storeNames="string"==typeof storeNames?[storeNames]:storeNames;for(var i=0;i<this.storeNames.length;i++)db.objectStoreNames.contains(this.storeNames[i])||idbModules.util.throwDOMException(0,"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",this.storeNames[i]);this.__active=!0,this.__running=!1,this.__requests=[],this.__aborted=!1,this.db=db,this.error=null,this.onabort=this.onerror=this.oncomplete=null;var me=this};IDBTransaction.prototype.__executeRequests=function(){if(!this.__running||this.mode===VERSION_TRANSACTION){this.__running=!0;var me=this;window.setTimeout(function(){2===me.mode||me.__active||idbModules.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",me.__active),me.db.__db.transaction(function(tx){function success(result,req){req&&(q.req=req),q.req.readyState="done",q.req.result=result,delete q.req.error;var e=idbModules.Event("success");idbModules.util.callback("onsuccess",q.req,e),i++,executeRequest()}function error(errorVal){q.req.readyState="done",q.req.error="DOMError";var e=idbModules.Event("error",arguments);idbModules.util.callback("onerror",q.req,e),i++,executeRequest()}function executeRequest(){return i>=me.__requests.length?(me.__active=!1,void(me.__requests=[])):(q=me.__requests[i],void q.op(tx,q.args,success,error))}me.__tx=tx;var q=null,i=0;try{executeRequest()}catch(e){"function"==typeof me.onerror&&me.onerror()}},function(){"function"==typeof me.onerror&&me.onerror()},function(){"function"==typeof me.oncomplete&&me.oncomplete()})},1)}},IDBTransaction.prototype.__addToTransactionQueue=function(callback,args){this.__active||this.mode===VERSION_TRANSACTION||idbModules.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished.",this.__mode);
var request=this.__createRequest();return this.__pushToQueue(request,callback,args),request},IDBTransaction.prototype.__createRequest=function(){var request=new idbModules.IDBRequest;return request.source=this.db,request.transaction=this,request},IDBTransaction.prototype.__pushToQueue=function(request,callback,args){this.__requests.push({op:callback,args:args,req:request}),this.__executeRequests()},IDBTransaction.prototype.objectStore=function(objectStoreName){return new idbModules.IDBObjectStore(objectStoreName,this)},IDBTransaction.prototype.abort=function(){!this.__active&&idbModules.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",this.__active)},IDBTransaction.prototype.READ_ONLY=0,IDBTransaction.prototype.READ_WRITE=1,IDBTransaction.prototype.VERSION_CHANGE=2,idbModules.IDBTransaction=IDBTransaction}(idbModules),function(idbModules){var IDBDatabase=function(db,name,version,storeProperties){this.__db=db,this.version=version,this.__storeProperties=storeProperties,this.objectStoreNames=new idbModules.util.StringList;for(var i=0;i<storeProperties.rows.length;i++)this.objectStoreNames.push(storeProperties.rows.item(i).name);this.name=name,this.onabort=this.onerror=this.onversionchange=null};IDBDatabase.prototype.createObjectStore=function(storeName,createOptions){var me=this;createOptions=createOptions||{},createOptions.keyPath=createOptions.keyPath||null;var result=new idbModules.IDBObjectStore(storeName,me.__versionTransaction,!1),transaction=me.__versionTransaction;return transaction.__addToTransactionQueue(function(tx,args,success,failure){function error(){idbModules.util.throwDOMException(0,"Could not create new object store",arguments)}me.__versionTransaction||idbModules.util.throwDOMException(0,"Invalid State error",me.transaction);var sql=["CREATE TABLE",idbModules.util.quote(storeName),"(key BLOB",createOptions.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");tx.executeSql(sql,[],function(tx,data){tx.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[storeName,createOptions.keyPath,createOptions.autoIncrement?!0:!1,"{}"],function(){result.__setReadyState("createObjectStore",!0),success(result)},error)},error)}),me.objectStoreNames.push(storeName),result},IDBDatabase.prototype.deleteObjectStore=function(storeName){var error=function(){idbModules.util.throwDOMException(0,"Could not delete ObjectStore",arguments)},me=this;!me.objectStoreNames.contains(storeName)&&error("Object Store does not exist"),me.objectStoreNames.splice(me.objectStoreNames.indexOf(storeName),1);var transaction=me.__versionTransaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__versionTransaction||idbModules.util.throwDOMException(0,"Invalid State error",me.transaction),me.__db.transaction(function(tx){tx.executeSql("SELECT * FROM __sys__ where name = ?",[storeName],function(tx,data){data.rows.length>0&&tx.executeSql("DROP TABLE "+idbModules.util.quote(storeName),[],function(){tx.executeSql("DELETE FROM __sys__ WHERE name = ?",[storeName],function(){},error)},error)})})})},IDBDatabase.prototype.close=function(){},IDBDatabase.prototype.transaction=function(storeNames,mode){var transaction=new idbModules.IDBTransaction(storeNames,mode||1,this);return transaction},idbModules.IDBDatabase=IDBDatabase}(idbModules),function(idbModules){var DEFAULT_DB_SIZE=2097152;if(window.openDatabase){var sysdb=window.openDatabase("__sysdb__",1,"System Database",DEFAULT_DB_SIZE);sysdb.transaction(function(tx){tx.executeSql("SELECT * FROM dbVersions",[],function(t,data){shimIndexedDB.notifyIsReady(!0)},function(){sysdb.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){shimIndexedDB.notifyIsReady(!0)},function(){shimIndexedDB.notifyIsReady(!1)})})})},function(){});var shimInitSuccess=!1,isShimReady=!1,isReadyCallbacks=void 0,shimIndexedDB={notifyIsReady:function(success){if(isShimReady=!0,shimInitSuccess=success,isReadyCallbacks){for(var i=0;i<isReadyCallbacks.length;++i)isReadyCallbacks[i](shimInitSuccess);isReadyCallbacks=void 0}},onIsReady:function(cb){isShimReady?setTimeout(function(){cb(shimInitSuccess)},0):isReadyCallbacks?isReadyCallbacks.push(cb):isReadyCallbacks=[cb]},open:function(name,version){function dbCreateError(){if(!calledDbCreateError){var e=idbModules.Event("error",arguments);req.readyState="done",req.error="DOMError",idbModules.util.callback("onerror",req,e),calledDbCreateError=!0}}function openDB(oldVersion){var db=window.openDatabase(name,1,name,DEFAULT_DB_SIZE);req.readyState="done","undefined"==typeof version&&(version=oldVersion||1),(0>=version||oldVersion>version)&&idbModules.util.throwDOMException(0,"An attempt was made to open a database using a lower version than the existing version.",version),db.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){tx.executeSql("SELECT * FROM __sys__",[],function(tx,data){var e=idbModules.Event("success");req.source=req.result=new idbModules.IDBDatabase(db,name,version,data),version>oldVersion?sysdb.transaction(function(systx){systx.executeSql("UPDATE dbVersions set version = ? where name = ?",[version,name],function(){var e=idbModules.Event("upgradeneeded");e.oldVersion=oldVersion,e.newVersion=version,req.transaction=req.result.__versionTransaction=new idbModules.IDBTransaction([],2,req.source),idbModules.util.callback("onupgradeneeded",req,e,function(){var e=idbModules.Event("success");idbModules.util.callback("onsuccess",req,e)})},dbCreateError)},dbCreateError):idbModules.util.callback("onsuccess",req,e)},dbCreateError)},dbCreateError)},dbCreateError)}var req=new idbModules.IDBOpenRequest,calledDbCreateError=!1;return sysdb.transaction(function(tx){tx.executeSql("SELECT * FROM dbVersions where name = ?",[name],function(tx,data){0===data.rows.length?tx.executeSql("INSERT INTO dbVersions VALUES (?,?)",[name,version||1],function(){openDB(0)},dbCreateError):openDB(data.rows.item(0).version)},dbCreateError)},dbCreateError),req},deleteDatabase:function(name){function dbError(msg){if(!calledDBError){req.readyState="done",req.error="DOMError";var e=idbModules.Event("error");e.message=msg,e.debug=arguments,idbModules.util.callback("onerror",req,e),calledDBError=!0}}function deleteFromDbVersions(){sysdb.transaction(function(systx){systx.executeSql("DELETE FROM dbVersions where name = ? ",[name],function(){req.result=void 0;var e=idbModules.Event("success");e.newVersion=null,e.oldVersion=version,idbModules.util.callback("onsuccess",req,e)},dbError)},dbError)}var req=new idbModules.IDBOpenRequest,calledDBError=!1,version=null;return sysdb.transaction(function(systx){systx.executeSql("SELECT * FROM dbVersions where name = ?",[name],function(tx,data){if(0===data.rows.length){req.result=void 0;var e=idbModules.Event("success");return e.newVersion=null,e.oldVersion=version,void idbModules.util.callback("onsuccess",req,e)}version=data.rows.item(0).version;var db=window.openDatabase(name,1,name,DEFAULT_DB_SIZE);db.transaction(function(tx){tx.executeSql("SELECT * FROM __sys__",[],function(tx,data){var tables=data.rows;!function deleteTables(i){i>=tables.length?tx.executeSql("DROP TABLE __sys__",[],function(){deleteFromDbVersions()},dbError):tx.executeSql("DROP TABLE "+idbModules.util.quote(tables.item(i).name),[],function(){deleteTables(i+1)},function(){deleteTables(i+1)})}(0)},function(e){deleteFromDbVersions()})},dbError)})},dbError),req},cmp:function(key1,key2){return idbModules.Key.encode(key1)>idbModules.Key.encode(key2)?1:key1===key2?0:-1}};idbModules.shimIndexedDB=shimIndexedDB}}(idbModules),function(window,idbModules){"undefined"!=typeof window.openDatabase&&(window.shimIndexedDB=idbModules.shimIndexedDB,window.shimIndexedDB&&(window.shimIndexedDB.__useShim=function(){console.log("---- Using SQL Shim ----"),window.indexedDB=idbModules.shimIndexedDB,window.IDBDatabase=idbModules.IDBDatabase,window.IDBTransaction=idbModules.IDBTransaction,window.IDBCursor=idbModules.IDBCursor,window.IDBKeyRange=idbModules.IDBKeyRange,window.indexedDB!==idbModules.shimIndexedDB&&Object.defineProperty&&Object.defineProperty(window,"indexedDB",{value:idbModules.shimIndexedDB})},window.shimIndexedDB.__debug=function(val){})),"indexedDB"in window||(window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB);var poorIndexedDbSupport=!1;(navigator.userAgent.match(/Android 2/)||navigator.userAgent.match(/Android 3/)||navigator.userAgent.match(/Android 4\.[0-3]/))&&(navigator.userAgent.match(/Chrome/)||(poorIndexedDbSupport=!0));var forceSQL=window.location.hash.indexOf("forcesql=true")>=0;if(forceSQL||("undefined"==typeof window.indexedDB||poorIndexedDbSupport)&&"undefined"!=typeof window.openDatabase)window.shimIndexedDB.__useShim();else{window.IDBDatabase=window.IDBDatabase||window.webkitIDBDatabase,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBCursor=window.IDBCursor||window.webkitIDBCursor,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,window.IDBTransaction||(window.IDBTransaction={});try{window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite"}catch(e){}}}(window,idbModules),define("IndexedDBShim",function(){}),define("db",["IndexedDBShim"],function(idbpoly){var indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB,IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,transactionModes={readonly:"readonly",readwrite:"readwrite"},hasOwn=Object.prototype.hasOwnProperty;if(!indexedDB)return void console.log("IndexedDB is not available");var defaultMapper=function(value){return value},CallbackList=function(){var state,list=[],exec=function(context,args){if(list){args=args||[],state=state||[context,args];for(var i=0,il=list.length;il>i;i++)list[i].apply(state[0],state[1]);list=[]}};this.add=function(){for(var i=0,il=arguments.length;il>i;i++)list.push(arguments[i]);return state&&exec(),this},this.execute=function(){return exec(this,arguments),this}},Deferred=function(func){var state="progress",actions=[["resolve","done",new CallbackList,"resolved"],["reject","fail",new CallbackList,"rejected"],["notify","progress",new CallbackList]],deferred={},promise={state:function(){return state},then:function(){var handlers=arguments;return Deferred(function(newDefer){actions.forEach(function(action,i){var handler=handlers[i];deferred[action[1]]("function"==typeof handler?function(){var returned=handler.apply(this,arguments);returned&&"function"==typeof returned.promise&&returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify)}:newDefer[action[0]])})}).promise()},promise:function(obj){return obj?(Object.keys(promise).forEach(function(key){obj[key]=promise[key]}),obj):promise}};return actions.forEach(function(action,i){var list=action[2],actionState=action[3];promise[action[1]]=list.add,actionState&&list.add(function(){state=actionState}),deferred[action[0]]=list.execute}),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},Server=function(db,name){var that=this,closed=!1;this.add=function(table){if(closed)throw"Database has been closed";for(var records=[],counter=0,i=0;i<arguments.length-1;i++)if(Array.isArray(arguments[i+1]))for(var j=0;j<arguments[i+1].length;j++)records[counter]=arguments[i+1][j],counter++;else records[counter]=arguments[i+1],counter++;var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred();return records.forEach(function(record){var req;if(record.item&&record.key){var key=record.key;record=record.item,req=store.add(record,key)}else req=store.add(record);req.onsuccess=function(e){var target=e.target,keyPath=target.source.keyPath;null===keyPath&&(keyPath="__id__"),Object.defineProperty(record,keyPath,{value:target.result,enumerable:!0}),deferred.notify()}}),transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.update=function(table){if(closed)throw"Database has been closed";for(var records=[],i=0;i<arguments.length-1;i++)records[i]=arguments[i+1];var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred();return records.forEach(function(record){var req;if(record.item&&record.key){var key=record.key;record=record.item,req=store.put(record,key)}else req=store.put(record);req.onsuccess=function(e){deferred.notify()}}),transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.updateObject=function(table){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),records=arguments[1];for(var id in records)store.put(records[id]);return transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.remove=function(table,key){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),req=store.delete(key);return transaction.oncomplete=function(){deferred.resolve(key)},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.clear=function(table){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),req=store.clear();return transaction.oncomplete=function(){deferred.resolve()},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.close=function(){if(closed)throw"Database has been closed";db.close(),closed=!0,delete dbCache[name]},this.get=function(table,id){if(closed)throw"Database has been closed";var transaction=db.transaction(table),store=transaction.objectStore(table),deferred=Deferred(),req=store.get(id);return req.onsuccess=function(e){deferred.resolve(e.target.result)},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.query=function(table,index){if(closed)throw"Database has been closed";return new IndexQuery(table,db,index)};for(var i=0,il=db.objectStoreNames.length;il>i;i++)!function(storeName){that[storeName]={};for(var i in that)hasOwn.call(that,i)&&"close"!==i&&(that[storeName][i]=function(i){return function(){var args=[storeName].concat([].slice.call(arguments,0));return that[i].apply(that,args)}}(i))}(db.objectStoreNames[i])},IndexQuery=function(table,db,indexName){var that=this,modifyObj=!1,runQuery=function(type,args,cursorType,direction,limitRange,filters,mapper){var transaction=db.transaction(table,modifyObj?transactionModes.readwrite:transactionModes.readonly),store=transaction.objectStore(table),index=indexName?store.index(indexName):store,keyRange=type?IDBKeyRange[type].apply(null,args):null,results=[],deferred=Deferred(),indexArgs=[keyRange],limitRange=limitRange?limitRange:null,filters=filters?filters:void 0,counter=0;"count"!==cursorType&&indexArgs.push(direction||"next");var modifyKeys=modifyObj?Object.keys(modifyObj):!1,modifyRecord=function(record){for(var i=0;i<modifyKeys.length;i++){var key=modifyKeys[i],val=modifyObj[key];val instanceof Function&&(val=val(record)),record[key]=val}return record};return index[cursorType].apply(index,indexArgs).onsuccess=function(e){var cursor=e.target.result;if("number"==typeof cursor)results=cursor;else if(cursor)if(null!==limitRange&&limitRange[0]>counter)counter=limitRange[0],cursor.advance(limitRange[0]);else if(null!==limitRange&&counter>=limitRange[0]+limitRange[1]);else{var matchFilter=!0,result="value"in cursor?cursor.value:cursor.key;filters&&filters.forEach(function(filter){filter&&filter.length&&(matchFilter=2===filter.length?result[filter[0]]===filter[1]:filter[0].apply(void 0,[result]))}),matchFilter&&(counter++,results.push(mapper(result)),modifyObj&&(result=modifyRecord(result),cursor.update(result))),cursor.continue()}},transaction.oncomplete=function(){deferred.resolve(results)},transaction.onerror=function(e){deferred.reject(e)},transaction.onabort=function(e){deferred.reject(e)},deferred.promise()},Query=function(type,args){var direction="next",cursorType="openCursor",filters=[],limitRange=null,mapper=defaultMapper,unique=!1,execute=function(){return runQuery(type,args,cursorType,unique?direction+"unique":direction,limitRange,filters,mapper)},limit=function(){return limitRange=Array.prototype.slice.call(arguments,0,2),1==limitRange.length&&limitRange.unshift(0),{execute:execute}},count=function(){return direction=null,cursorType="count",{execute:execute}},keys=function(){return cursorType="openKeyCursor",{desc:desc,execute:execute,filter:filter,distinct:distinct,map:map}},filter=function(){return filters.push(Array.prototype.slice.call(arguments,0,2)),{keys:keys,execute:execute,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}},desc=function(){return direction="prev",{keys:keys,execute:execute,filter:filter,distinct:distinct,modify:modify,map:map}},distinct=function(){return unique=!0,{keys:keys,count:count,execute:execute,filter:filter,desc:desc,modify:modify,map:map}},modify=function(update){return modifyObj=update,{execute:execute}},map=function(fn){return mapper=fn,{execute:execute,count:count,keys:keys,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}};return{execute:execute,count:count,keys:keys,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}};"only bound upperBound lowerBound".split(" ").forEach(function(name){that[name]=function(){return new Query(name,arguments)}}),this.filter=function(){var query=new Query(null,null);return query.filter.apply(query,arguments)},this.all=function(){return this.filter()}},createSchema=function(e,schema,db){"function"==typeof schema&&(schema=schema());for(var tableName in schema){var table=schema[tableName],store;store=!hasOwn.call(schema,tableName)||db.objectStoreNames.contains(tableName)?e.currentTarget.transaction.objectStore(tableName):db.createObjectStore(tableName,table.key);for(var indexKey in table.indexes)if(!store.indexNames.contains(indexKey)){var index=table.indexes[indexKey];store.createIndex(indexKey,index.key||indexKey,Object.keys(index).length?index:{unique:!1})}}},open=function(e,server,version,schema){var db=e.target.result,s=new Server(db,server),upgrade,deferred=Deferred();return deferred.resolve(s),dbCache[server]=db,deferred.promise()},dbCache={},db={version:"0.9.0",open:function(options){var request,deferred=Deferred();return dbCache[options.server]?open({target:{result:dbCache[options.server]}},options.server,options.version,options.schema).done(deferred.resolve).fail(deferred.reject).progress(deferred.notify):(request=indexedDB.open(options.server,options.version),request.onsuccess=function(e){open(e,options.server,options.version,options.schema).done(deferred.resolve).fail(deferred.reject).progress(deferred.notify)},request.onupgradeneeded=function(e){createSchema(e,options.schema,e.target.result)},request.onerror=function(e){deferred.reject(e)}),deferred.promise()}};return db}),define("demo",["globals","util"],function(g,util){var self={cache:{}};return self.loadRemoteData=function loadRemoteDataFn(info,cb){try{g.PAssert(1011,info&&cb,"Must supply valid remote load info as well as a cb when data is loaded")}catch(PERR){g.reportError(PERR)}var rInfo=info.split(".");self.cache[rInfo[0]]?cb(self.cache[rInfo[0]][rInfo[1]]):g.XHR({type:"GET",url:window.location.protocol+"//"+window.location.host+"/data/"+rInfo[0]+".json",cb:function cbFn(xhr){if(200===xhr.status)try{var demoData=JSON.parse(xhr.responseText);self.cache[rInfo[0]]=demoData,cb(demoData[rInfo[1]])}catch(err){log("Error parsing demo data: "+err.message)}else log("Error getting demo data",xhr.status,xhr.responseText)}})},self}),define("data",["globals","util","gdata","db","demo","platform"],function(g,util,gdata,db,demo,platform){function migrateFromOldData(item){item._id&&(item.id=g.TEMP_PREFIX+item._id,delete item._id),delete item.hasLocalChange,delete item.isLocalRoot,delete item.modifiedOffline,delete item.isRoot,delete item.v,delete item.isLayout2D,item.modifiedOffline=!0,item.modifiedOfflineText=!0,item.dateCreated=Date.now();var itemText=item.getRawText();if(itemText.length>0&&"#"==itemText[0]?item.setRawText(itemText.substr(1)+":"):itemText.length>1&&"x"==itemText[0]&&" "==itemText[1]&&item.setRawText("^"+itemText.substr(2)),item.items)for(var i=0;item.items&&i<item.items.length;i++){var child=item.items[i];child.itemRef&&(item.items[i]="T"+child.itemRef)}}function transactionDoneCallback(){}function transactionErrorCallback(){log("Transaction Error: ",arguments)}function removeItemSubtree(id){var item=self.getItem(id);if(item){var children=item.items;if(children)for(var i=0;i<children.length;++i)removeItemSubtree(children[i]);self.dbDeleteItem(item.id)}}function doArchive(item,archivedItem,value){item.save({items:item.getItemsArrayForSave()},SaveFlag.None),archivedItem.save({isArchived:value},SaveFlag.None)}function makePropString(item,field){var value=item[field];return value?',"'+field+'":'+value:""}function makeJSON(item,hasPrev,allowArchived){var str="";hasPrev&&(str+=",");var model=self.getModel(item.id),text=String(model.getParsedText()).replace(/[\"]/g,function(chr){return charMapJSON[chr]}),item=self.getItem(item.id),dateCompletedString=makePropString(item,"dateCompleted"),priorityString=makePropString(item,"priority"),isCompleteString=makePropString(item,"isComplete"),isFlaggedString=makePropString(item,"isFlagged"),isArchivedString=makePropString(item,"isArchived");if(str+='{"text": "'+text+'"'+dateCompletedString+priorityString+isCompleteString+isFlaggedString+isArchivedString,item.items&&item.items.length>0){str+=',"items":[';for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]);(!child.isArchived||child.isArchived&&allowArchived)&&(str+=makeJSON(child,i>0))}str+="]"}return str+="}"}var DB_CONTACTS="ctcs",DB_HELP_INTRO="helpIntro",DB_HELP_NORMAL="helpNormal",defaultContactNames={___info___:{count:0}},self={contacts:[],contactsByName:{},contactNames:defaultContactNames,pendingRemoteUpdates:{},itemsById:{},loadedItemCount:0,hasLocalData:!1,freezeUpdates:!1,dbi:void 0};REPORT_ACTIONS&&(self.reportData=function reportDataFn(loc){if(!util.hasURLParam("nosync")){var rData={};for(var id in self.itemsById)rData[id]=self.itemsById[id].data;g.reportData(rData,loc)}});var contactSaveTimer;self.forEachModel=function forEachModelFn(fn){try{g.PAssert(1012,fn,"Must pass a valid function to iterate on")}catch(PERR){g.reportError(PERR)}for(var id in self.itemsById)self.itemsById[id]&&fn(self.itemsById[id].model)},self.getModel=function getModelFn(id){try{g.PAssert(1013,id,"Tried to get a model that doesn't exist")}catch(PERR){g.reportError(PERR)}var entry=self.itemsById[id];return entry?entry.model:void 0},self.setModel=function setModelFn(id,model){try{g.PAssert(1014,id,"Tried to set a model with an invalid id")}catch(PERR){g.reportError(PERR)}self.itemsById[id]?self.itemsById[id].model=model:self.itemsById[id]={model:model,data:void 0}},self.getItem=function getItemFn(id){try{g.PAssert(1015,id,"Tried to get an item that doesn't exist")}catch(PERR){g.reportError(PERR)}var entry=self.itemsById[id];return entry?entry.data:void 0},self.setItem=function setItemFn(id,data){try{g.PAssert(1016,id,"Tried to set an item with an invalid id")}catch(PERR){g.reportError(PERR)}self.itemsById[id]?self.itemsById[id].data=data:self.itemsById[id]={model:void 0,data:data}},self.getRootItem=function getRootItemFn(){return self.rootId?self.getItem(self.rootId):void 0},self.getRootModel=function getRootModelFn(){return self.rootId?self.getModel(self.rootId):void 0},self.initializeIndexedDB=function initializeIndexedDBFn(handler){function initLocalDB(initSuccess){initSuccess?db.open({server:"duchess",version:version,schema:{items:{key:{keyPath:"id"}},settings:{}}}).done(function(server){self.dbi=server,handler()}).fail(function(e){log("Error loading local DB client",e),g.preventLocalWrites(),g.reportError(e),handler()}):(log("Shim failed to init."),g.preventLocalWrites(),handler())}var version=1;void 0!==window.indexedDB.onIsReady&&null!==window.indexedDB.onIsReady?window.indexedDB.onIsReady(initLocalDB):setTimeout(function(){initLocalDB(!0)},0)},self.migrateLocalData_One=function migrateLocalData_OneFn(){for(var id in self.itemsById){var hasChanges=!1,changes={},item=self.getItem(id);if(item){var text=item.text;text.startsWith("!")?(changes.priority=VMLIFlag.P0,changes.text=text.substr(1),hasChanges=!0):text.startsWith("*")?(changes.isFlagged=!0,changes.text=text.substr(1),hasChanges=!0):text.startsWith("^")&&(changes.isComplete=!0,changes.text=text.substr(1),hasChanges=!0),hasChanges&&self.dbUpdateItem({id:id,changes:changes,saveFlags:SaveFlag.None})}}},self.migrateLocalData_Two=function migrateLocalData_TwoFn(){if(0===self.contacts.length)return void log("Skipping local data migration two");for(var id in self.itemsById){var hasChanges=!1,changes={},item=self.getItem(id);if(item&&item.text.indexOf("@")>=0)for(var words=item.text.split(" "),lineIndex=0,i=0;i<words.length;++i){if(0===words[i].indexOf("@")){for(var matchedName=void 0,combined=words[i].substring(1),u=1;4>u;u++){var compStr=-1!==combined.indexOf(":",combined.length-1)?combined.substr(0,combined.length-1):combined;if(self.contactsByName[compStr]&&(matchedName=compStr),!(i+u<words.length))break;combined+=" "+words[i+u]}if(matchedName){try{g.PAssert(1017,"@"==item.text[lineIndex],"Explicitly matching @, should always match")}catch(PERR){g.reportError(PERR)}var text=item.text.substr(0,lineIndex)+"+"+item.text.substr(lineIndex+1);changes.text=text,hasChanges=!0;var model=self.getModel(id);model&&(model.setRawText(text),model.parseText(!0))}}lineIndex+=words[i].length+1}hasChanges&&self.dbUpdateItem({id:id,changes:changes,saveFlags:SaveFlag.None})}};var isLocalDataLoaded=!1;self.localDataLoaded=function localDataLoadedFn(){return isLocalDataLoaded},self.loadFromIndexedDB=function loadFromIndexedDBFn(callback){try{g.PAssert(1018,!isLocalDataLoaded,"Should never load local data twice")}catch(PERR){g.reportError(PERR)}self.itemsById={},g.shouldWriteLocal()&&self.dbi&&self.dbi.items?self.dbi.items.query().all().execute().done(function(results){self.loadedItemCount=results.length;for(var i=0;i<results.length;++i)self.setItem(results[i].id,g.translateObjOut(results[i]));isLocalDataLoaded=!0,self.dbi.settings?self.dbi.settings.get("root").done(function(result){if(!g.criticalErrorReported()){if(result){try{g.PAssert(1019,self.getItem(result.root),"If there is a root item defined there should be a corresponding local item")}catch(PERR){g.reportError(PERR)}self.rootId=result.root}log("Root Item: ",self.rootId),callback&&callback()}}).fail(callback):(log("Unable to load local settings DB"),callback&&callback())}):(log("Unable to load local items DB"),isLocalDataLoaded=!0,g.preventLocalWrites(),callback&&callback())};var updateTransaction=void 0;self.beginTransaction=function beginTransactionFn(){g.shouldWriteLocal()&&(updateTransaction={})},self.transactionUpdate=function transactionUpdateFn(id,data){try{g.PAssert(1020,g.shouldWriteLocal(),"Should never be writing during a transaction if local writes are disabled")}catch(PERR){g.reportError(PERR)}if(updateTransaction[id])for(var attr in data)updateTransaction[id][attr]=data[attr];else updateTransaction[id]=data},self.endTransaction=function endTransactionFn(){g.shouldWriteLocal()&&self.dbi&&self.dbi.items?self.dbi.items.updateObject(updateTransaction).done(transactionDoneCallback).fail(transactionErrorCallback):void 0!==updateTransaction&&g.reportError(new Error("Started a transaction and stopped writes halfway through")),updateTransaction=void 0},self.dbUpdateItem=function dbUpdateItemFn(params){function trackUpdates(){if(window.__UPDATES_ACTUAL++,callback){var args=Array.prototype.slice.call(arguments,1);callback(args)}}if(!self.freezeUpdates){self.hasLocalData||g.isLoadingRemote||params.skipLocalModification||(self.hasLocalData=!0);var changes=params.changes||{},id=params.id?params.id:changes.id,callback=params.callback,saveFlags=params.saveFlags;try{g.PAssert(1021,saveFlags===SaveFlag.None||saveFlags===SaveFlag.Prop||saveFlags===SaveFlag.Text||saveFlags===SaveFlag.All)}catch(PERR){g.reportError(PERR)}var item=self.getItem(id);if(g.shouldWriteLocal()){var translated;try{g.PAssert(1022,!saveFlags||void 0===changes.modifiedOffline&&void 0===changes.modifiedOfflineText,"Shouldn't be setting a modified flag while passing them in with changes")}catch(PERR){g.reportError(PERR)}if(g.isFlagSet(saveFlags,SaveFlag.Prop)){try{g.PAssert(1023,void 0===changes.modifiedOffline,"Shouldnt be passing in a value and assigning true")}catch(PERR){g.reportError(PERR)}changes.modifiedOffline=!0;var model=self.getModel(id);model&&(model.modifiedOffline=!0)}if(g.isFlagSet(saveFlags,SaveFlag.Text)){try{g.PAssert(1024,void 0===changes.modifiedOfflineText,"Shouldnt be passing in a value and assigning true")}catch(PERR){g.reportError(PERR)}changes.modifiedOfflineText=!0;var model=self.getModel(id);model&&(model.modifiedOfflineText=!0)}if(item){for(var prop in changes)if(changes.hasOwnProperty(prop)){var verStr;item[prop]=changes[prop]}translated=g.translateObjIn(item)}else{try{g.PAssert(1025,changes.id,"Item being modified does not already exist as expected",changes)}catch(PERR){g.reportError(PERR)}var verStr,verStr;self.setItem(id,changes),translated=g.translateObjIn(changes)}if(updateTransaction){try{g.PAssert(1027,!callback,"Callbacks not supported for updates inside of a transaction")}catch(PERR){g.reportError(PERR)}self.transactionUpdate(id,translated)}else callback?self.dbi.items.update(translated).done(callback).fail(callback):self.dbi.items.update(translated)}else{if(item)for(var prop in changes)changes.hasOwnProperty(prop)&&(item[prop]=changes[prop]);else self.setItem(id,changes);callback&&callback()}}},self.dbDeleteItem=function dbDeleteItemFn(id,callback){self.freezeUpdates||(self.setItem(id,void 0),g.shouldWriteLocal()&&(callback?self.dbi.items.remove(id).done(callback).fail(callback):self.dbi.items.remove(id)))},self.setRoot=function setRootFn(id){return self.freezeUpdates?void 0:(g.shouldWriteLocal()&&self.dbi.settings.update({key:"root",item:{root:id}}),self.rootId=id,self.getRootItem())};var demoId=0,loadedDemoData={};self.loadDemoData=function loadDemoDataFn(testData,handler){function insertIntoDB(root){root.id||(root.id="demo"+demoId++),self.setItem(root.id,root);var items=root.items;if(items){for(var itemIDs=[],i=0;i<items.length;++i)items[i].id||(items[i].id="demo"+demoId++),itemIDs.push(items[i].id),insertIntoDB(items[i]);root.items=itemIDs}}function handleDataLoad(demoData){var root;demoData&&(root=demoData[0]),root&&(insertIntoDB(root),self.setRoot(root.id),loadedDemoData[testData]=root,isLocalDataLoaded=!0,handler&&handler(root.id))}if(void 0===testData&&(testData="demo.5"),void 0!==testData&&""!==testData&&void 0!==loadedDemoData[testData]){log("Use Preloaded demo data: ",testData);var newRoot=loadedDemoData[testData];self.setRoot(newRoot.id),handler&&handler(newRoot.id)}else""===testData?demo.loadRemoteData("demo.5",handleDataLoad):demo.loadRemoteData(testData,handleDataLoad)};var initDataCalled=!1;self.initData=function initDataFn(handler){if(initDataCalled)return!1;
initDataCalled=!0;try{g.isDemoMode()?setTimeout(function(){var testData=util.getURLParam("data");self.loadDemoData(testData,handler)},0):(g.checkpoint(Checkpoint.InitData),self.initializeIndexedDB(function(){self.loadFromIndexedDB(function(){g.checkpoint(Checkpoint.DBLoaded),self.checkLocalIntegrity(function(localDataStatus){self.loadLocalContacts(),handler(),self.hasLocalData||platform.offline||!navigator.onLine||g.vmMain.isLoadingDoc(!0)})})}))}catch(err){g.reportError(err)}return!0},self.initializeItem=function initializeItemFn(item){var oldId=item.id,isNewItem=!oldId||g.isLocalItem(item)||!item.data;if(isNewItem){var newId=gdata.createNewItem(item,item.hasChildren(),item.hasArchivedChildren());oldId&&oldId!==newId&&self.modifyItemId(oldId,newId);for(var hasNewChildren=!1,items=item.items(),i=0;i<items.length;++i)hasNewChildren|=self.initializeItem(items[i]);if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;++i)hasNewChildren|=self.initializeItem(archivedItems[i]);if(gdata.initializeNewItem(item),oldId&&oldId!==newId){var parent=item.parent();parent&&parent.save(null,SaveFlag.None)}}return isNewItem},self.checkLocalIntegrity=function checkLocalIntegrityFn(callback){var localDataError=!1,localData=!1;self.ensureLocalCache(function(){var rootSeen=!1,seen={};for(var id in self.itemsById)if(self.itemsById.hasOwnProperty(id)&&self.getItem(id)){var item=self.getItem(id);(item.i||item.t)&&(log("%cInvalid local properties on item: ","color: red",item),localDataError=!0),seen[item.id]?seen[item.id].exist?(log(item.id,": Duplicated IDs in the local database",item),localDataError=!0):(seen[item.id].exist=!0,seen[item.id].del=!!item.isDeleted):seen[item.id]={exist:!0,ref:!1,del:!!item.isDeleted},item.id==self.rootId&&(rootSeen&&(log(item.id,": Multiple roots present locally",item),localDataError=!0),rootSeen=!0,seen[item.id].isRoot=!0),void 0==item.text&&(log("Found item with no text",item.id),item.text="",self.dbUpdateItem({id:id,changes:{text:""},saveFlags:SaveFlag.None}));for(var seenArchived=void 0,j=0;item.items&&j<item.items.length;++j)if(item.items[j]){var child=item.items[j],childInfo=self.getItem(child);if(childInfo?(childInfo.isArchived&&(seenArchived=child),seenArchived&&!childInfo.isArchived&&(log(child,": Unarchived child found after an archived one"),log("   ",item.id,": Parent with incorrectly ordered children"),localDataError=!0)):(log(child,": Child does not have a valid reference on our local database"),localDataError=!0),seen[child])if(seen[child].ref){log(child,": Item is referenced locally multiple times: ",childInfo?self.getItem(child).id:"UNDEFINED"),log("   ",seen[child].ref,": ",self.getItem(seen[child].ref).id),log("   ",item.id,": <CLIENTDATA>"),localDataError=!0;var newItems=item.items;newItems.removeAt(j),self.dbUpdateItem({id:id,changes:{items:newItems},saveFlags:SaveFlag.None})}else seen[child].ref=item.id;else seen[child]={exist:!1,ref:item.id}}else log(item.id,": Invalid item in local items array"),localDataError=!0}rootSeen||(log("No root present"),localDataError=!0);for(var entryID in seen){var entry=seen[entryID];if(!entry.exist){log(entryID,": Item is referenced locally as a child but does not exist in the database");var item=self.getItem(entry.ref);try{g.PAssert(1028,item,"Parent of item must exist")}catch(PERR){g.reportError(PERR)}if(item){var newItems=item.items;newItems?newItems.remove(entryID):newItems=[],self.dbUpdateItem({id:item.id,changes:{items:newItems},saveFlags:SaveFlag.None})}}if(entry.ref||entry.isRoot||entry.del||(log(entryID,": Item exists locally but is not referenced by a parent"),removeItemSubtree(entryID)),entry.ref&&entry.del){log(entryID,": Item is referenced locally by a parent but has been deleted");var item=self.getItem(entry.ref);try{g.PAssert(1029,item)}catch(PERR){g.reportError(PERR)}var newItems=item.items;newItems?newItems.remove(entryID):newItems=[],self.dbUpdateItem({id:item.id,changes:{items:newItems},saveFlags:SaveFlag.None})}if(entry.isRoot&&entry.ref&&(log(entryID,": Local root has a parent"),localDataError=!0),entry.del&&!entry.ref){var item=self.getItem(entryID);g.isLocalItem(item)&&(log("Deleting Unreferenced Local Item: ",entryID),self.dbDeleteItem(entryID))}}callback({error:localDataError,local:localData})})},self.removeDeletedItems=function removeDeletedItemsFn(remoteSeen){for(var id in self.itemsById){var localItem=self.getItem(id);localItem&&localItem.isDeleted&&(remoteSeen[id]||(log("Deleting Removed Local Item: ",id),self.dbDeleteItem(id)))}},self.clearData=function clearDataFn(cb,skip){self.freezeUpdates=!0,setTimeout(function(){function clearLocalStorage(){self.clearContacts(),g.settings.resetAll(skip),cb&&cb()}function clearItems(){self.dbi.items&&self.dbi.items.clear().done(function(){clearLocalStorage()}).fail(function(){log("Failed to reset items!",arguments),clearLocalStorage()})}return g.pageDataCleared(),self.dbi?void(self.dbi.settings&&self.dbi.settings.clear().done(function(){clearItems()}).fail(function(){log("Failed to reset settings!",arguments),clearItems()})):void self.initializeIndexedDB(function(){self.clearData(cb,skip)})},0)},self.contactComparator=function contactComparatorFn(a,b){return a.text.localeCompare(b.text)},self.contactEmailComparator=function contactEmailComparatorFn(email1,email2){return email1.address==email2.address},self.contactPhoneComparator=function contactPhoneComparatorFn(phone1,phone2){return phone1.number==phone2.number},self.sortContacts=function sortContactsFn(){self.contacts.sort(self.contactComparator)},self.addContact=function addContactFn(contact,sorted){try{g.PAssert(1030,contact.id,"Incoming contacts must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1031,contact.text,"All contacts are expected to have a text")}catch(PERR){g.reportError(PERR)}var existingContact=self.contactsByName[contact.text];existingContact?(contact.emails&&(existingContact.emails||(existingContact.emails=[]),existingContact.emails.pushOnlyUniques(contact.emails,self.contactEmailComparator)),contact.phoneNumbers&&(existingContact.phoneNumbers||(existingContact.phoneNumbers=[]),existingContact.phoneNumbers.pushOnlyUniques(contact.phoneNumbers,self.contactPhoneComparator))):(sorted?self.contacts.insertSorted(contact,self.contactComparator):self.contacts.push(contact),contact.text&&(self.contactNames[contact.text]="",self.contactsByName[contact.text]=contact),self.contactNames.___info___.count=self.contacts.length)},self.updateContact=function updateContactFn(contact,sorted){try{g.PAssert(1032,contact.id,"Incoming contacts must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1033,contact.text,"All contacts are expected to have a text")}catch(PERR){g.reportError(PERR)}for(var wasReplaced=!1,i=0;i<self.contacts.length;++i)if(self.contacts[i].id===contact.id){self.contacts[i].text=contact.text,self.contacts[i].emails=self.contacts[i].phoneNumbers=void 0,self.addContact(contact,sorted),wasReplaced=!0;break}return wasReplaced?void 0:(self.addContact(contact),!0)};var localContactsLoaded=!1;self.clearLocalContacts=function clearLocalContactsFn(){if(localContactsLoaded=!1,g.shouldWriteLocal())try{util.storage.setItem(DB_CONTACTS,"[]")}catch(err){g.reportError(err)}self.contacts=[],g.settings.set(Settings.lastContactSync,void 0)},self.loadLocalContacts=function loadLocalContactsFn(){if(!localContactsLoaded&&(localContactsLoaded=!0,g.shouldWriteLocal()))try{self.loadContacts(JSON.parse(util.storage.getItem(DB_CONTACTS)),!1)}catch(err){g.reportError(err)}},self.loadContacts=function loadContactsFn(contacts,isDemo){try{g.PAssert(1034,0===self.contacts.length,"Should only load contacts once")}catch(PERR){g.reportError(PERR)}if(self.contacts=contacts,self.contacts){for(var modifiedContact=!1,i=0;i<self.contacts.length;i++){var contact=self.contacts[i];if(contact.name&&(contact.text=contact.name,self.contacts[i].text=contact.name,delete self.contacts[i].name,modifiedContact=!0),!isDemo&&contact.isDemo||contact.text&&!contact.phoneNumbers&&!contact.emails)self.contacts.removeAt(i--),modifiedContact=!0;else{contact.text&&(self.contactNames[contact.text]="",self.contactsByName[contact.text]=contact);try{g.PAssert(1035,contact.id,"Each contact must have a valid id")}catch(PERR){g.reportError(PERR)}}}modifiedContact&&self.saveContacts(),self.contactNames.___info___.count=self.contacts.length}else self.contacts=[],self.contactsByName={},self.contactNames=defaultContactNames;log("Contacts Loaded: ",self.numContacts())},self.saveContacts=function saveContactsFn(){g.shouldWriteLocal()&&util.storage.setItem(DB_CONTACTS,JSON.stringify(self.contacts))},self.clearContacts=function clearContactsFn(){g.settings.reset(Settings.lastContactSync),g.shouldWriteLocal()&&util.storage.removeItem(DB_CONTACTS,void 0)},self.contactRelevanceComparator=function contactRelevanceComparatorFn(a,b){return a.index!=b.index?a.index<b.index?-1:1:a.object.text.localeCompare(b.object.text)},self.findContactsLike=function findContactsLikeFn(like){for(var lower=like.toLowerCase(),results=[],maxResults=50,i=0;i<self.contacts.length;++i){var index=self.contacts[i].text.toLowerCase().indexOf(lower);if(index>=0&&(results.push({index:index,object:self.contacts[i]}),results.length>maxResults))break}return results.sort(self.contactRelevanceComparator),results},self.findContactsExact=function findContactsExactFn(exact){return self.contactsByName[exact]},self.findContactByEmail=function findContactByEmailFn(email){for(var i=0;i<self.contacts.length;++i){var contact=self.contacts[i];if(contact.emails)for(var u=0;u<contact.emails.length;++u)if(contact.emails[u].address==email)return contact}},self.getContacts=function getContactsFn(){return self.contactNames},self.numContacts=function numContactsFn(){try{g.PAssert(1036,self.contacts.length===self.contactNames.___info___.count,"Contact names count should match contacts value")}catch(PERR){g.reportError(PERR)}return self.contacts.length},self.areLocalContactsLoaded=function areLocalContactsLoadedFn(){return localContactsLoaded},self.insertItems=function insertItemsFn(item,items,index){try{g.PAssert(1037,item,"Must pass in a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1038,void 0===index||index>=0,"Must pass in a valid index")}catch(PERR){g.reportError(PERR)}item.save({items:item.getItemsArrayForSave()},SaveFlag.Prop),1===items.length?gdata.itemAdded({item:item,addedItem:items[0],index:index,isArchived:!1}):gdata.itemsAdded({item:item,addedItems:items,index:index,isArchived:!1})},self.removeItem=function removeItemFn(item,index,removedItem,isArchived){try{g.PAssert(1039,item,"Must pass in a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1040,void 0===index||index>=0,"Must pass in a valid index")}catch(PERR){g.reportError(PERR)}item.save({items:item.getItemsArrayForSave()},SaveFlag.Prop),removedItem&&removedItem.data&&gdata.itemRemoved({item:item,index:index,numToRemove:1,isArchived:isArchived})},self.moveItem=function moveItemFn(params){var item=params.item,newInfo=params.newInfo,oldParent=params.oldParent,oldInfo=params.oldInfo,isRemoteChange=params.isRemoteChange,noVersion=params.noVersion,saveFlags=isRemoteChange?SaveFlag.None:SaveFlag.Prop;try{g.PAssert(1041,void 0!==item&&void 0!==newInfo&&void 0!==oldParent&&void 0!==oldInfo,"moveItem is missing parameters")}catch(PERR){g.reportError(PERR)}oldParent.save({items:oldParent.getItemsArrayForSave()},saveFlags),item.parent().save({items:item.parent().getItemsArrayForSave()},saveFlags),oldInfo.isArchived!==newInfo.isArchived&&(item.isArchived(newInfo.isArchived),item.save({isArchived:newInfo.isArchived},saveFlags)),isRemoteChange||(self.saveChanges(item,{},saveFlags),gdata.itemMoved({item:item,newInfo:newInfo,oldParent:oldParent,oldInfo:oldInfo,noVersion:noVersion}))},self.archiveItem=function archiveItemFn(item,index,archivedItem){try{g.PAssert(1042,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}doArchive(item,archivedItem,!0),archivedItem.data&&gdata.itemArchived(item,archivedItem,index)},self.unarchiveItem=function unarchiveItemFn(item,index,unarchivedItem){try{g.PAssert(1043,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}doArchive(item,unarchivedItem,!1),unarchivedItem.data&&gdata.itemUnarchived(item,unarchivedItem,index,item.items().length-1)},self.modifyItemId=function modifyItemIdFn(id,newId,callback){var item=self.getItem(id),model=self.getModel(id);if(item.id=newId,model.id=newId,self.pendingRemoteUpdates[id]&&(self.pendingRemoteUpdates[id]=void 0,self.pendingRemoteUpdates[newId]=!0),item.version=-1,item.versionText=-1,"root"===id)for(var i=item.items.length-1;i>=0;i--){var rootChild=self.getItem(item.items[i]);if(g.isLocalItem(rootChild)&&!rootChild.modifiedOffline&&!rootChild.modifiedOfflineText){item.items.removeAt(i);try{g.PAssert(1044,model.items()[i].id===rootChild.id,"Item arrays should match")}catch(PERR){g.reportError(PERR)}model.items().removeAt(i)}}self.itemsById[newId]={data:item,model:self.itemsById[id].model},self.dbDeleteItem(id),self.dbUpdateItem({changes:item,callback:callback,skipLocalModification:!0,saveFlags:SaveFlag.None}),self.itemsById[id]=void 0,delete self.itemsById[id]},self.deleteItem=function deleteItemFn(item){try{g.PAssert(1045,!item.isDeleted,"Should never try to delete an item that has already been deleted")}catch(PERR){g.reportError(PERR)}var localItem=self.getItem(item.id);if(localItem)item.isDeleted=!0,self.dbUpdateItem({id:item.id,changes:{isDeleted:!0},saveFlags:SaveFlag.Prop});else try{g.PAssert(1046,"Expected local item, didnt find one",item.id)}catch(PERR){g.reportError(PERR)}},self.undeleteItem=function undeleteItemFn(item){var localItem=self.getItem(item.id);if(localItem)item.isDeleted=!1,self.dbUpdateItem({id:item.id,changes:{isDeleted:void 0},saveFlags:SaveFlag.Prop});else try{g.PAssert(1047,"Expected local item, didnt find one",item.id)}catch(PERR){g.reportError(PERR)}},self.saveChanges=function saveChangesFn(item,changes,saveFlags){if(item)changes||(changes={}),self.dbUpdateItem({id:item.id,changes:changes,saveFlags:saveFlags});else{log("Incoming item to save has no item!",item,changes);try{g.PAssert(1048,!1,"Incoming item to save has no item!")}catch(PERR){g.reportError(PERR)}}},self.addPendingUpdate=function addPendingUpdateFn(id){try{g.PAssert(1049,id,"Invalid ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1050,g.isString(id),"Must provide a valid id string")}catch(PERR){g.reportError(PERR)}self.pendingRemoteUpdates[id]||(self.pendingRemoteUpdates[id]=!0)},self.clearPendingUpdates=function clearPendingUpdatesFn(){for(var itemID in self.pendingRemoteUpdates){try{g.PAssert(1051,self.pendingRemoteUpdates.hasOwnProperty(itemID))}catch(PERR){g.reportError(PERR)}var item=self.getModel(itemID),itemData=self.getItem(itemID);if(itemData&&itemData.isDeleted)self.dbDeleteItem(itemID);else if(item&&item.data){var changes={modifiedOffline:!1,modifiedOfflineText:!1};item.modifiedOffline=!1,item.modifiedOfflineText=!1;var newVersion=gdata.getVersion(item.data,VersionType.Structure),newTextVersion=gdata.getVersion(item.data,VersionType.Text);newVersion!=item.getVersion(VersionType.Structure)&&(changes.version=newVersion,item.setVersion(VersionType.Structure,newVersion)),newTextVersion!=item.getVersion(VersionType.Text)&&(changes.versionText=newTextVersion,item.setVersion(VersionType.Text,newTextVersion)),self.dbUpdateItem({id:itemID,changes:changes,saveFlags:SaveFlag.None})}}self.pendingRemoteUpdates={},self.printIndexedDB("id","text","version","versionText","modifiedOffline","isArchived")};var charMapHTML={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"},charMapJSON={'"':'\\"'};return self.toHtml=function toHtmlFn(item,allowArchived){var str="<ul>";if(item.items)for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]),model=self.getModel(child.id),text=String(model.getParsedText()).replace(/[&\"<>]/g,function(chr){return charMapHTML[chr]});(!child.isArchived||child.isArchived&&allowArchived)&&(str+="<li>"+text,child.items&&child.items.length>0&&(str+=self.toHtml(child)),str+="</li>")}return str+="</ul>"},self.toPlainText=function toPlainTextFn(item,indent,allowArchived){isNaN(indent)&&(indent=0);var str="";if(item.items)for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]),model=self.getModel(child.id);if(!child.isArchived||child.isArchived&&allowArchived){for(var u=0;indent>u;u++)str+="	";str+=model.getParsedText()+"\n",child.items&&child.items.length>0&&(str+=self.toPlainText(child,indent+1))}}return str},self.toJSON=function toJSONFn(item,hasPrev,allowArchived){var rootItem=makeJSON(item,hasPrev,allowArchived);return'{"moodoVer":'+(g.settings.get(Settings.localDataVersion)||gdata.currentVersion())+',"moodoRoot":'+rootItem+"}"},self.ensureLocalCache=function ensureLocalCacheFn(callback){var root=self.getRootItem();if(root)self.loadedItemCount>2&&(self.hasLocalData=!0),callback();else{var oldLocalData=self.hasLocalData,tempID=g.generateTempId();self.dbUpdateItem({changes:{id:"root",text:"Home",items:[]},skipLocalModification:!0,saveFlags:SaveFlag.None,callback:function callbackFn(){self.setRoot("root"),self.hasLocalData=oldLocalData,callback()}})}},self.printIndexedDB=function printIndexedDBFn(){var args,i,printAll},self}),define("goog",["ko","data","globals","util","gdata","platform"],function(ko,d,g,util,gdata,platform){function getAccessTokenInternal(){var token=void 0;try{var gapiToken=gapi.auth.getToken();gapiToken&&(token=gapiToken.access_token)}catch(err){self.recoverFromError(err)}return token}function showErrorMessage(){g.messageQueue.pushMessage({text:"There was an internal error in Google Drive, refresh to try again in a couple minutes.",type:MessageType.Error,action:MessageAction.Reload}),g.vmMain.setGDriveStatus(DriveStatus.Offline)}function openDefaultRealtimeFile(callback){g.vmMain.setGDriveStatus(DriveStatus.Connecting),gapi.client.load("drive","v2",function(){if(!gapi.client.drive)return void showErrorMessage();var queryString="(title='"+self.LEGACY_DefaultDriveDocTitle+"' or properties has {key='"+self.DefaultProperty+"' and value='"+self.DefaultPropertyValue+"' and visibility='PRIVATE'}) and 'me' in owners and trashed=false";gapi.client.drive.files.list({fields:docFields,q:queryString}).execute(function(results){results&&results.items?callback(results.items[0],!1):results&&200!==results.code&&results.error?showErrorMessage():createDefaultRealtimeFile(callback)})})}function deleteRealtimeFile(fileId,callback){gapi.client.drive.files.delete({fileId:fileId}).execute(callback)}function createDefaultRealtimeFile(callback){gapi.client.load("drive","v2",function(){gapi.client.drive.files.insert({resource:{mimeType:self.REALTIME_MIMETYPE,title:self.DefaultDocTitle,writersCanShare:!1,properties:[{key:self.DefaultProperty,value:self.DefaultPropertyValue,visibility:"PRIVATE"}]}}).execute(function(docInfo){if(200!==docInfo.code&&docInfo.error)showErrorMessage();else{var loadFileID=util.getURLParam("file");if(loadFileID)try{try{g.PAssert(1074,gapi.drive,"gapi.drive should exist")}catch(PERR){g.reportError(PERR)}util.removeURLParam("file"),gapi.drive.realtime.load(loadFileID,onDocLoaded,onDocInitialized,onDocLoadError)}catch(err){g.reportError(err)}else callback(docInfo,!0)}})})}function onFirstDocInitialized(doc){if(log("First Run Drive Document"),onDocInitialized(doc),self.authenticatedUserEmail())g.sendEvent("Subscribe","NewUser"),g.reportSignup(self.authenticatedUserEmail());else var userSub=self.authenticatedUserEmail.subscribe(function(newValue){userSub.dispose(),userSub=void 0,g.sendEvent("Subscribe","NewUser"),g.reportSignup(self.authenticatedUserEmail())})}function onDocInitialized(doc){if(log("Drive Document Initialized"),gdata.onInitialized(doc),self.authenticatedUserEmail())g.sendEvent("Documents","CreateNew");else var userSub=self.authenticatedUserEmail.subscribe(function(newValue){userSub.dispose(),userSub=void 0,g.sendEvent("Documents","CreateNew")})}function onDocLoaded(doc){g.vmMain.setGDriveStatus(DriveStatus.Saved);var success=gdata.onLoad(doc);success&&(gdata.onRemoteSettingsLoad(),self.startWatchdog())}function onDocLoadError(e){switch(ShouldLog(LogLevels.Error)&&log("Doc Load Error - ",JSON.stringify(e)),e.type){case gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED:try{g.PAssert(1075,!e.isFatal,"Token refresh required causes a non-fatal error")}catch(PERR){g.reportError(PERR)}self.recoverFromError();break;case gapi.drive.realtime.ErrorType.INVALID_COMPOUND_OPERATION:try{g.PAssert(1076,e.isFatal,"Invalid compound operation causes a fatal error")}catch(PERR){g.reportError(PERR)}ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+e.type+"] Fatal: "+e.isFatal),g.reportError(new Error("Invalid Compound Operation: "+g.safeStringify(e)));break;case gapi.drive.realtime.ErrorType.CONCURRENT_CREATION:case gapi.drive.realtime.ErrorType.CLIENT_ERROR:ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+e.type+"] Fatal: "+e.isFatal),g.reportError(new Error("Client Error: "+g.safeStringify(e))),self.clearDocInfo(),findAndLoadDoc();break;case gapi.drive.realtime.ErrorType.FORBIDDEN:case gapi.drive.realtime.ErrorType.NOT_FOUND:ShouldLog(LogLevels.Error)&&log("Unable to access or find the requested document"),g.reportError(new Error("DocError Forbidden/NotFound: "+g.safeStringify(e))),d.clearData(function(){g.reload()});break;case gapi.drive.realtime.ErrorType.SERVER_ERROR:try{g.PAssert(1077,e.isFatal,"Server errors are always fatal")}catch(PERR){g.reportError(PERR)}g.vmMain.setGDriveStatus(DriveStatus.Offline);break;default:ShouldLog(LogLevels.Error)&&log("Unkown Doc Error - ",g.safeStringify(e)),g.reportError(new Error("Unknown Doc Error: "+g.safeStringify(e)))}e.isFatal&&gdata.close(e)}function loadDoc(newDoc){var docId=self.getDocId();if(docId)try{var initFn=newDoc?onFirstDocInitialized:onDocInitialized;gapi.drive.realtime.load(docId,onDocLoaded,initFn,onDocLoadError)}catch(err){self.recoverFromError(err)}else findAndLoadDoc()}function findAndLoadDoc(){openDefaultRealtimeFile(function(docInfo,newDoc){docInfo&&docInfo.id?(self.setDocInfo(docInfo.id,docInfo.title),loadDoc(newDoc)):g.reportError(new Error("We should always find a valid document with a defined id")),newDoc&&g.fireCustomEvent("firstRun")})}function saveAuthorizedScopes(){for(var scopeArr=[],i=0;i<authorizedScopes.length;++i){var scopeIndex=self.scopes.indexOf(authorizedScopes[i]),forceNoSave=noSaveScopes.indexOf(authorizedScopes[i])>=0;scopeIndex>=0&&!forceNoSave&&scopeArr.push(scopeIndex)}var saveString=JSON.stringify(scopeArr);g.settings.set(Settings.authScopes,saveString)}function handleContactsLoaded(numContacts){numContacts>0&&g.vmMain.runParseWorkerNewContacts()}function frameIdx(frame){return parseInt(frame.id.split("_")[1])}function handleAuthorization(token,callback){if(token&&!token.error){try{g.PAssert(1080,token.scope,"Scopes must be valid")}catch(PERR){g.reportError(PERR)}g.isString(token.scope)&&(token.scope=token.scope.split(" "));var oldAuthorizedScopes=authorizedScopes,newAuthorizedScopes=ko.utils.arrayGetDistinctValues(token.scope);authorizedScopes=newAuthorizedScopes,(oldAuthorizedScopes.length!==newAuthorizedScopes.length||oldAuthorizedScopes!==newAuthorizedScopes)&&saveAuthorizedScopes();var expireMS=1e3*(parseInt(token.expires_in)-600);log("Token expires in",expireMS/1e3),authorizedUntil=Date.now()+expireMS,clearTimeout(refreshAuthorizationTimer),refreshAuthorizationTimer=setTimeout(function(){refreshAuthorization()},expireMS),lastRefreshWait=DEFAULT_REFRESH_WAIT,gdata.poke(),setTimeout(function(){for(var iframes=document.getElementsByTagName("iframe"),i=0;i<iframes.length;++i)if(iframes[i].src.startsWith("https://accounts.google.com/o/oauth2/auth?"))if(""===iframes[i].id)iframes[i].id="auth_"+authIndex++;else{var idx=frameIdx(iframes[i]);idx!==authIndex&&idx!==authIndex-1&&iframes[i].parentElement.removeChild(iframes[i])}},0)}else log("Error authorizing token"+(token?token.error:""));callback&&callback(token)}function refreshAuthorization(cb){if(!gapi||!gapi.auth||!gapi.auth.authorize)return cb(void 0),!1;try{g.PAssert(1082,authorizedScopes.length>=self.requiredScopes.length,"We lost some required scopes somewhere...")}catch(PERR){g.reportError(PERR)}refreshingAuth=!0;var tokenString,currentToken,userId=self.authenticatedUserEmail()||g.settings.get("activeUser"),config={client_id:self.CLIENT_ID,scope:authorizedScopes,immediate:!0,user_id:userId};return gapi.auth.authorize(config,function(token){tokenRefreshed=!0,refreshingAuth=!1,handleAuthorization(token,cb)}),!0}function tryToLoadGapi(){if(self.isRealtimeAPILoaded())isLoadingScript=!1;else{var oldScript=document.getElementById("gapiScript");oldScript&&oldScript.parentNode.removeChild(oldScript),g.addScript("https://apis.google.com/js/client.js?onload=GoogleApiLoaded","gapiScript",function(){isLoadingScript=!1}),numTriesLoad-->0?setTimeout(tryToLoadGapi,RELOAD_TIMEOUT):isLoadingScript=!1}}function tryToRefreshToken(){tokenRefreshed?(g.vmMain.setGDriveStatus(DriveStatus.Saved),g.messageQueue.clearMessage(MessageID.ConnectionError)):(refreshAuthorization(),setTimeout(tryToRefreshToken,RELOAD_TIMEOUT))}var self={CLIENT_ID:"597847337936.apps.googleusercontent.com",exportID:void 0,calendars:ko.observable({}),eventSubscribers:[],authenticatedUserEmail:ko.observable(void 0),gapiLoaded:!1};g.goog=self;var NUM_DAYS=14,MAX_RESULTS_EVENTS=50,MAX_RESULTS_CALENDARS=15,MAX_DESCRIPTION=8e3,DEFAULT_REFRESH_WAIT=1e4,MAX_REFRESH_WAIT=16e4;self.APP_ID="597847337936",self.REALTIME_MIMETYPE="application/vnd.google-apps.drive-sdk",window.GScope={Calendar:"https://www.googleapis.com/auth/calendar",CalendarRO:"https://www.googleapis.com/auth/calendar.readonly",Contacts:"https://www.googleapis.com/auth/contacts.readonly",Drive:"https://www.googleapis.com/auth/drive.file",UserInfoEmail:"https://www.googleapis.com/auth/userinfo.email",DriveFull:"https://www.googleapis.com/auth/drive",TasksRO:"https://www.googleapis.com/auth/tasks.readonly",UserInfoProfile:"https://www.googleapis.com/auth/userinfo.profile",DriveInstall:"https://www.googleapis.com/auth/drive.install",DriveAppData:"https://www.googleapis.com/auth/drive.appdata"};var noSaveScopes=[GScope.TasksRO];self.LEGACY_DefaultDriveDocTitle="DuchessBeta",self.DefaultDocTitle="Moo.do Personal Document",self.DefaultProperty="MooDoDefault",self.DefaultPropertyValue="TRUE",self.requiredScopes=[GScope.Drive,GScope.UserInfoEmail,GScope.DriveInstall],self.requestScopes=[],self.scopes=[GScope.Calendar,GScope.CalendarRO,GScope.Contacts,GScope.Drive,GScope.UserInfoEmail,GScope.DriveFull,GScope.UserInfoProfile,GScope.DriveInstall,GScope.DriveAppData];var authorizedScopes=[],docFields="items(id,title)",eventFields="created,description,extendedProperties,end,etag,htmlLink,id,kind,location,locked,start,status,summary,updated,creator",eventListFields="items("+eventFields+"),kind,updated,accessRole",calendarListFields="etag,items(description,etag,id,kind,location,selected,summary,summaryOverride,timeZone),kind,nextPageToken";self.isLoaded=!1,self.init=function initFn(){var savedScopesString=g.settings.get(Settings.authScopes);if(savedScopesString){var savedScopes;try{savedScopes=JSON.parse(savedScopesString)}catch(err){g.reportError(err)}if(savedScopes){for(var i=0;i<savedScopes.length;++i){try{g.PAssert(1060,savedScopes[i]>=0,"Each saved scope should be a valid array index")}catch(PERR){g.reportError(PERR)}savedScopes[i]>=0&&self.requestScopes.push(self.scopes[savedScopes[i]])}self.requestScopes=ko.utils.arrayGetDistinctValues(self.requestScopes)}}else self.requestScopes=self.requiredScopes;authorizedScopes=self.requestScopes,platform.syncContacts&&util.getURLParam("access_token")&&!util.hasURLParam("error")&&(authorizedScopes.indexOf(GScope.Contacts)<0&&(authorizedScopes.push(GScope.Contacts),saveAuthorizedScopes()),g.settings.set(Settings.syncContacts,!0));var authGASub=self.authenticatedUserEmail.subscribe(function(newValue){void 0!==newValue&&(window.ga&&ga("set","&uid",g.getAnonUserIdentifier()),authGASub.dispose(),authGASub=void 0)})},self.ensureRequiredScopesAreRequested=function ensureRequiredScopesAreRequestedFn(){for(var needsAdditionalScopes=!1,i=0;i<self.requiredScopes.length;++i)if(authorizedScopes.indexOf(self.requiredScopes[i])<0){needsAdditionalScopes=!0;break}needsAdditionalScopes&&self.runAuthenticate(self.requiredScopes,!0,!1,function(token){(!token||token.error)&&g.messageQueue.pushMessage({text:"We need additional permissions to give you the best experience, "+platform.actionVerb()+" here to authenticate.",type:MessageType.Warning,action:function actionFn(){self.runAuthenticate(self.requiredScopes,!1,!1,function(token2){(!token2||token2.error)&&g.messageQueue.pushMessage({text:"There was an error authenticating, "+platform.actionVerb()+" here to try again.",type:MessageType.Error,action:self.ensureRequiredScopesAreRequested})})}})})};var watchdogWait=96e4,watchdogInterval=void 0;self.startWatchdog=function startWatchdogFn(){watchdogInterval||(watchdogInterval=setInterval(self.watchdogFn,watchdogWait))},self.stopWatchdog=function stopWatchdogFn(){clearInterval(watchdogInterval),watchdogInterval=void 0};var lastWatchdogTime=0;self.watchdogFn=function watchdogFnFn(){var currentTime=Date.now();if(lastWatchdogTime-currentTime>=watchdogWait){try{var token=gapi.auth.getToken();if(token){var expireTime=1e3*parseInt(token.expires_at);currentTime>expireTime?(ShouldLog(LogLevels.Error)&&log("Active token is no longer valid: "+currentTime+" vs. "+expireTime),refreshAuthorization(),g.reportError(new Error("Watchdog found expired token on client"))):gdata.poke()}else ShouldLog(LogLevels.Error)&&log("No active token on client!"),refreshAuthorization(),g.reportError(new Error("Watchdog found client with no token set"))}catch(err){g.reportError(err)}finally{lastWatchdogTime=currentTime}g.checkForRemoteChanges()}},self.hasPermission=function hasPermissionFn(scope){return authorizedScopes.indexOf(scope)>-1};var refreshAuthorizationTimer=void 0,authorizedUntil=void 0,refreshingAuth=!0;self.onFocusHandler=function onFocusHandlerFn(){authorizedUntil&&Date.now()>authorizedUntil&&refreshAuthorization()},self.onBlurHandler=function onBlurHandlerFn(){refreshAuthorizationTimer&&clearTimeout(refreshAuthorizationTimer)},self.getAccessToken=function getAccessTokenFn(){var token=getAccessTokenInternal();return token||self.recoverFromError(),token},self.getContactInfo=function getContactInfoFn(name,callback){function handleResponse(xhr){if(200!==xhr.status)callback();else{var obj=JSON.parse(xhr.responseText);try{g.settings.set(Settings.lastContactSync,new Date(obj.feed.updated.$t))}catch(err){g.reportError(err)}callback(obj)}}var accessToken=self.getAccessToken();if(!accessToken)return void callback(void 0);var lastSync=void 0,url="https://www.google.com/m8/feeds/contacts/default/full?v=3.0&alt=json";name?url+='&q="'+name+'"':lastSync=g.settings.get(Settings.lastContactSync);var forceLoad=d.areLocalContactsLoaded()&&0===d.numContacts();if(lastSync&&!forceLoad){var syncDate=new Date(lastSync);url+="&updated-min="+syncDate.toString("yyyy-MM-ddTHH:mm:ss")}url+="&max-results=10000",url+="&access_token="+accessToken,g.XHR({type:"GET",url:url,cb:handleResponse})},self.loadedContacts=!1,self.loadContacts=function loadContactsFn(callback){if(!self.loadedContacts){self.loadedContacts=!0,d.loadLocalContacts();var loadedContacts=d.numContacts();self.getContactInfo(void 0,function(data){if(!data)return void callback(-1);log("Loading Remote Contacts!",parseInt(data.feed.openSearch$totalResults.$t));var contactCount=0,contactsAdded=!1;if(data&&data.feed&&data.feed.entry&&data.feed.entry.length){g.vmMain.notifyContactsUpdated(),contactCount=data.feed.entry.length;for(var entries=data.feed.entry,i=0;i<entries.length;i++){var entry=entries[i],contact={id:/\/([^\s\/]+$)/gi.exec(entry.id.$t)[1],text:""};if(entry.gd$name&&entry.gd$name.gd$fullName){var text=entry.gd$name.gd$fullName.$t;
contact.text=text,"'"==contact.text[0]&&(contact.text=contact.text.substr(1))}if(entry.gd$email){var emails=entry.gd$email;contact.emails=emails;for(var u=0;u<emails.length;u++)delete contact.emails[u].rel,!contact.text&&contact.emails[u].primary&&(contact.text=contact.emails[u].address);!contact.text&&emails.length>0&&(contact.text=contact.emails[0].address)}if(entry.gd$phoneNumber){var phoneNumbers=entry.gd$phoneNumber;contact.phoneNumbers=[];for(var u=0;u<phoneNumbers.length;u++){var phoneNumber={number:phoneNumbers[u].$t};phoneNumber.type=phoneNumbers[u].rel?phoneNumbers[u].rel.replace("http://schemas.google.com/g/2005#",""):phoneNumbers[u].label,contact.phoneNumbers.push(phoneNumber)}}if(contact.text){if(entry.link)for(var links=entry.link,u=0;u<links.length;u++)if(links[u].type.startsWith("image")&&void 0!==links[u].gd$etag){var url=links[u].href;contact.avatar=url}0===loadedContacts?(d.addContact(contact,!1),contactsAdded=!0):contactsAdded=d.updateContact(contact,!1)||contactsAdded}}}contactCount>0&&d.saveContacts(),contactsAdded&&d.sortContacts(),callback&&callback(contactCount)})}},self.setDocInfo=function setDocInfoFn(id,title){g.settings.set(Settings.gdocId,id),g.settings.set(Settings.gdocTitle,title)},self.getDocId=function getDocIdFn(){return g.settings.get(Settings.gdocId)},self.clearDocInfo=function clearDocInfoFn(){g.settings.reset(Settings.gdocId),g.settings.reset(Settings.gdocTitle)};var lastRecoverTime=0,lastRefreshWait=DEFAULT_REFRESH_WAIT;self.recoverFromError=function recoverFromErrorFn(err){err&&(ShouldLog(LogLevels.Error)&&log("GDrive Error: ",err),g.reportError(err)),g.vmMain.setGDriveStatus(DriveStatus.Connecting),refreshAuthorization(function(token){if(!token||token.error){g.messageQueue.pushMessage(MessageID.ConnectionError),g.vmMain.setGDriveStatus(DriveStatus.Offline);var errorMessage="Unable to refresh authentication token - ",sendReport=!0;token?(errorMessage+=token.error,"immediate_failed"===token.error&&(sendReport=!1)):errorMessage+="No Token",sendReport&&g.reportError(new Error(errorMessage)),MAX_REFRESH_WAIT>lastRefreshWait&&(setTimeout(self.recoverFromError,lastRefreshWait),lastRefreshWait*=2)}})},self.getActiveUser=function getActiveUserFn(cb){if(self.getAccessToken())if(self.authenticatedUserEmail())cb&&cb(self.authenticatedUserEmail());else{var url="https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token="+self.getAccessToken();g.XHR({type:"GET",url:url,cb:function cbFn(xhr){if(200===xhr.status){var obj=JSON.parse(xhr.responseText);self.authenticatedUserEmail(obj.email)}cb&&cb(self.authenticatedUserEmail())}})}else cb&&cb(self.authenticatedUserEmail())};var loadedClientDefaultFile=!1;self.loadClientDefaultFile=function loadClientDefaultFileFn(){var mainLoaded=!!g.vmMain,driveLoaded=!!window.gapi&&!!window.gapi.drive&&!!window.gapi.drive.realtime;if(!loadedClientDefaultFile&&mainLoaded&&driveLoaded){var token=getAccessTokenInternal();token&&g.getLoginState()==LoginState.LOGGED_IN&&(loadedClientDefaultFile=!0,g.vmMain.setGDriveStatus(DriveStatus.Connecting),self.getActiveUser(function(newUser){var prevUser=g.settings.get(Settings.activeUser);prevUser&&newUser&&newUser!==prevUser?d.clearData(function(){g.reload()}):!prevUser&&newUser&&g.settings.set(Settings.activeUser,newUser)}),loadDoc(),self.loadCalendarAndContacts())}},self.reconnectToActiveDocument=function reconnectToActiveDocumentFn(){var mainLoaded=!!g.vmMain,driveLoaded=!!window.gapi&&!!window.gapi.drive&&!!window.gapi.drive.realtime,isLoggedIn=g.getLoginState()==LoginState.LOGGED_IN,token=getAccessTokenInternal();try{g.PAssert(1078,!gdata.isConnected(),"Should not try to reconnect if gdata is still connected")}catch(PERR){g.reportError(PERR)}mainLoaded&&driveLoaded&&isLoggedIn&&token&&(g.vmMain.setGDriveStatus(DriveStatus.Reconnecting),loadDoc())},self.authAndLoadContacts=function authAndLoadContactsFn(cb){g.settings.get(Settings.syncContacts)&&(authorizedScopes.indexOf(GScope.Contacts)<0?self.runAuthenticate([GScope.Contacts],!0,!0,function(token){!token||token.error?(authorizedScopes.push(GScope.Contacts),saveAuthorizedScopes(),g.messageQueue.pushMessage({text:"Contact sync is enabled but permissions have been lost, "+platform.verb()+" here to find it again.",type:MessageType.Error,action:self.authAndLoadContacts}),cb&&cb(!1)):self.loadContacts(function(numContacts){handleContactsLoaded(numContacts),cb&&numContacts>0&&cb(!0)})}):self.loadContacts(function(numContacts){handleContactsLoaded(numContacts),cb&&numContacts>0&&cb(!0)}))},self.authDocSharing=function authDocSharingFn(){},self.loadCalendarAndContacts=function loadCalendarAndContactsFn(){window.gapi&&self.authAndLoadContacts()},self.checkTokenInHash=function checkTokenInHashFn(){var setToken=!1;if(util.hasURLParam("access_token"))try{var scopeString=util.getURLParam("scope"),token={access_token:util.getURLParam("access_token"),expires_in:util.getURLParam("expires_in"),scope:scopeString.split("+")};gapi.auth.setToken(token),setToken=!0,util.removeURLParam("access_token",!0),util.removeURLParam("expires_in",!0),util.removeURLParam("scope",!0),util.removeURLParam("token_type",!0)}catch(err){g.reportError(err)}return setToken},self.runAuthenticate=function runAuthenticateFn(requestScopes,runImmediate,retry,callback){if(!window.gapi||!window.gapi.auth)return callback&&callback(),!1;self.gapiLoaded||(g.fireCustomEvent("gapiLoaded"),self.gapiLoaded=!0);var currentToken=void 0;try{currentToken=gapi.auth.getToken()}catch(err){g.reportError(err)}var requiredScopesToRequest;if(currentToken){if(requiredScopesToRequest=currentToken.scope,!g.isArray(requiredScopesToRequest)&&(g.reportError(new Error("Scopes are not an array: "+requiredScopesToRequest)),g.isString(requiredScopesToRequest)))try{requiredScopesToRequest=currentToken.scope.split(" ")}catch(err){g.reportError(err)}for(var numScopesAdded=0,i=0;i<requestScopes.length;++i)currentToken.scope.indexOf(requestScopes[i])<0&&(requiredScopesToRequest.push(requestScopes[i]),numScopesAdded++);0===numScopesAdded&&(requiredScopesToRequest=[])}else requiredScopesToRequest=requestScopes;if(requiredScopesToRequest.length>0){requiredScopesToRequest.indexOf(GScope.DriveFull)>=0&&requiredScopesToRequest.remove(GScope.Drive);var userId=self.authenticatedUserEmail()||g.settings.get("activeUser"),config={client_id:self.CLIENT_ID,scope:requiredScopesToRequest,immediate:runImmediate,user_id:userId,authuser:runImmediate?0:-1};platform.requireCustomRedirect&&!runImmediate&&(config.redirect_uri=platform.customRedirectString,platform.customRedirectState&&(requiredScopesToRequest.indexOf(GScope.Contacts)>=0&&(platform.customRedirectState.syncContacts=!0),config.state=JSON.stringify(platform.customRedirectState))),refreshingAuth=!0;var tokenString;gapi.auth.authorize(config,function(token){refreshingAuth=!1,(!token||token.error)&&runImmediate&&retry?self.runAuthenticate(requiredScopesToRequest,!1,!1,callback):(token&&!token.error&&(platform.app||util.hasURLParam("login","true"))&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),self.loadClientDefaultFile()),handleAuthorization(token,callback))})}else ShouldLog(LogLevels.Error)&&log("Authorization request with no scopes: ",requiredScopesToRequest),callback&&callback(currentToken);return!0};var authIndex=0,tokenRefreshed=!1;self.isDriveAPILoaded=function isDriveAPILoadedFn(){return window.gapi&&window.gapi.client&&window.gapi.client.drive},self.isRealtimeAPILoaded=function isRealtimeAPILoadedFn(){return window.gapi&&window.gapi.client&&window.gapi.drive&&window.gapi.drive.realtime};var RELOAD_TIMEOUT=1e4,numTriesLoad=0,isLoadingScript=!1;return self.goOnline=function goOnlineFn(){return numTriesLoad=2,self.isRealtimeAPILoaded()?(tokenRefreshed=!1,setTimeout(tryToRefreshToken,2e3),!0):(isLoadingScript||(isLoadingScript=!0,setTimeout(tryToLoadGapi,2e3)),!1)},self.init(),self}),define("android",["ko","globals","platform"],function(ko,g,platform){var self={},paneRoot,paneScroller,paneContent,inputBox,currentVMLI,lastVMLI,canSetInput=!1,enabled=!1;self.isEnabled=function isEnabledFn(){return enabled},self.getCurrentVMLI=function getCurrentVMLIFn(){return currentVMLI},self.isVisible=function isVisibleFn(){return isInputVisible},self.getCurrentSpan=function getCurrentSpanFn(){return currentVMLI?currentVMLI.getSpan():void 0},self.isTargetBox=function isTargetBoxFn(e){return inputBox===(e.target||e.srcElement)},self.getInputBox=function getInputBoxFn(){return inputBox},self.getSelectionStart=function getSelectionStartFn(){return inputBox.selectionStart?inputBox.selectionStart-1:inputBox.selectionStart},self.getSelectionEnd=function getSelectionEndFn(){return inputBox.selectionEnd?inputBox.selectionEnd-1:inputBox.selectionEnd},self.setSelection=function setSelectionFn(start,end){inputBox.selectionStart=start+1,inputBox.selectionEnd=end+1},self.setPaneRoot=function setPaneRootFn(pane){function enforceSelection(){try{g.PAssert(1085,currentVMLI,"VMLI must be selected in order to enforce selection offset")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1086,self.getBoxHasTextSpace(),"Editor must always be prefixed with TextSpace")}catch(PERR){g.reportError(PERR)}0===inputBox.selectionStart&&(inputBox.selectionStart=1)}if(void 0===pane.rootElement)return void(enabled=!1);if(enabled=!0,pane.rootElement!==paneRoot){paneRoot=pane.rootElement,paneScroller=pane.scrollElement,paneContent=pane.paneContent,platform.mobileie&&paneContent.removeAttribute("contenteditable"),inputBox=document.createElement("textarea"),inputBox.id="androidInput",inputBox.style.visibility="hidden",paneRoot.appendChild(inputBox),inputBox.addEventListener("focus",function(e){g.dragging||g.isKeyboardOpen||g.keyboardToolbar.show()}),platform.mobileie||inputBox.addEventListener("blur",function(e){e.relatedTarget&&"searchPhone"!==e.relatedTarget.id||(self.finishInput(),g.keyboardToolbar.hide())});var edit,tracker;inputBox.addEventListener("input",function(e){try{g.PAssert(1083,currentVMLI,"VMLI must be selected in order to get input events")}catch(PERR){g.reportError(PERR)}if(currentVMLI){var isBackspace=!self.getBoxHasTextSpace();if(edit=edit||require("edit"),isBackspace){tracker=tracker||require("tracker");try{g.PAssert(1084,edit&&tracker,"Should always be defined")}catch(PERR){g.reportError(PERR)}tracker.beginAction(),edit.handleBackspace(e,currentVMLI.getSpan(),void 0),tracker.endAction()}self.ensureTextSpace(),edit.updateAutocomplete(e)}}),platform.ie||(inputBox.ontouchend=function(e){setTimeout(enforceSelection,30)}),canSetInput=null!==inputBox.selectionStart&&void 0!==inputBox.selectionStart&&null!==inputBox.selectionEnd&&void 0!==inputBox.selectionEnd,log("---- Android Editing Enabled ----")}};var wasHeader=!1,isInputVisible=!1;self.updateInput=function updateInputFn(vmli,forceOffset){try{g.PAssert(1087,self.isEnabled(),"Must be enabled to update input")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1088,vmli,"Must supply a valid item to select")}catch(PERR){g.reportError(PERR)}var sel=window.getSelection(),selOffset=void 0;if(void 0===forceOffset&&sel.rangeCount>0&&sel.getRangeAt(0).startContainer.nodeType===Node.TEXT_NODE){var oldRange=sel.getRangeAt(0);selOffset=g.getSelectOffsetsInSpan(vmli,vmli.getSpan(),oldRange,!0)}platform.mobileie&&(selOffset={start:vmli.getParsedText().length,end:vmli.getParsedText().length});var openingInput=!1;isInputVisible||(isInputVisible=!0,openingInput=!0,inputBox.style.visibility="visible"),g.isKeyboardOpen||g.keyboardToolbar.show();var itemChanged=vmli!==currentVMLI;(itemChanged||vmli&&vmli.isHeader()!==wasHeader)&&(currentVMLI&&itemChanged&&self.finishInput(!0),lastVMLI=currentVMLI,currentVMLI=vmli,wasHeader=vmli.isHeader(),self.updateInputText(vmli),self.updateInputBounds(vmli)),openingInput&&inputBox.focus(),canSetInput&&(void 0!==selOffset?(inputBox.selectionStart=selOffset.start+1,inputBox.selectionEnd=selOffset.end+1):void 0!==forceOffset?(inputBox.selectionStart=forceOffset+1,inputBox.selectionEnd=forceOffset+1):(inputBox.selectionStart=1,inputBox.selectionEnd=1))},self.updateInputText=function updateInputTextFn(vmli){if(vmli&&currentVMLI&&vmli.id===currentVMLI.id){var displayText=currentVMLI.getParsedText();self.setBoxValue(displayText)}},self.insertText=function insertTextFn(offset,text){var val=self.getBoxValue(),newText=val.substr(0,offset)+text+val.substr(offset);self.setBoxValue(newText),canSetInput&&(inputBox.selectionStart=offset+text.length+1,inputBox.selectionEnd=offset+text.length+1,g.autocomplete&&g.autocomplete.update({item:currentVMLI,start:self.getSelectionStart(),fromArrows:!1}))},self.getInputText=function getInputTextFn(){try{g.PAssert(1089,self.isEnabled(),"Must be enabled to get input")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1090,currentVMLI,"Android input must be active to get input text")}catch(PERR){g.reportError(PERR)}return currentVMLI?self.getBoxValue():""};var lastHeight=0;return self.updateInputBounds=function updateInputBoundsFn(vmli){if(vmli&&currentVMLI&&vmli.id===currentVMLI.id){var elem=vmli.getSpan(),bRect=elem.getBoundingClientRect(),leftOffset=8,topOffset=40,scrollTop=paneScroller.scrollTop;g.copyStyles(elem,inputBox,["paddingLeft","paddingTop","paddingRight","paddingBottom","width","height","fontSize","lineHeight"]),inputBox.style.top=Math.ceil(bRect.top+scrollTop-topOffset)+"px",inputBox.style.marginLeft=leftOffset+"px",inputBox.style.paddingLeft=parseInt(inputBox.style.paddingLeft)-leftOffset+"px",lastHeight=inputBox.scrollHeight}},self.checkAndroidBounds=function checkAndroidBoundsFn(){try{g.PAssert(1091,currentVMLI,"When updating Android bounds we should always have a current VMLI")}catch(PERR){g.reportError(PERR)}var boxHeight=inputBox.scrollHeight;if(boxHeight!==lastHeight){var resultText=self.getBoxValue();if(enabled=!1,currentVMLI){currentVMLI.getRawText()!==resultText&&currentVMLI.setText(resultText,!0,!0);var cStyle=window.getComputedStyle(currentVMLI.getSpan());inputBox.style.height=cStyle?cStyle.height:"16px"}enabled=!0,lastHeight=boxHeight}},self.flushInput=function flushInputFn(){var resultText=self.getBoxValue();currentVMLI.getRawText()!==resultText&&currentVMLI.setText(resultText,!0,!0)},self.finishInput=function finishInputFn(continueEditing){try{g.PAssert(1092,self.isEnabled(),"Must be enabled to finish input")}catch(PERR){g.reportError(PERR)}currentVMLI&&(isInputVisible&&!continueEditing&&(isInputVisible=!1,inputBox.style.visibility="hidden",g.blurActiveElement()),self.flushInput(),lastVMLI=currentVMLI,currentVMLI=void 0)},self.getBoxHasTextSpace=function getBoxHasTextSpaceFn(){var rawText=inputBox.value;if(0===rawText.length||rawText[0]!==TextSpace){try{g.PAssert(1093,rawText.indexOf(TextSpace)<0,"If TextSpace is not at the front of the editor, it shouldnt appear in the rest of the string")}catch(PERR){g.reportError(PERR)}return!1}return!0},self.ensureTextSpace=function ensureTextSpaceFn(){var rawText=inputBox.value;if(9===rawText.length||rawText[0]!==TextSpace){var index=rawText.indexOf(TextSpace);index>0&&(self.setBoxValue(rawText.replace(TextSpace,"")),log("TextSpace fixed in input: "+index))}},self.getBoxValue=function getBoxValueFn(){var rawText=inputBox.value,outText=rawText.replace(TextSpace,"");return outText},self.setBoxValue=function setBoxValueFn(text){text&&0!==text.length||(text=TextSpace);var newText=text[0]===TextSpace?text:TextSpace+text;inputBox.value=newText},self.passKeypress=function passKeypressFn(e){return currentVMLI?e.normCode===KeyCode.Enter||e.synthetic?!0:!1:!1},self.passKeydown=function passKeydownFn(e){return currentVMLI?e.normCode===KeyCode.Tab||e.synthetic?!0:!1:!1},self}),define("VMLI_TapHandlers",["ko","globals","platform","android","tracker"],function(ko,g,platform,android,tracker){var gestureThreshold=80,gestureSelectFirstThreshold=40,SPThresholdLeft=18,SPThresholdRight=36,dataTransfer=void 0,VMLI_TapHandlers={dragStart:function dragStartFn(e){try{g.PAssert(1094,!platform.mobile||!g.focusedPane.isTimeline(),"Should not be able to drag/drop on timeline on mobile")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1095,g.startDrag,"Should always have a valid item to start dragging from")}catch(PERR){g.reportError(PERR)}g.clearSelection(),android.isEnabled()&&android.finishInput();var target=g.startDrag.getElement();g.startDrag=void 0;try{g.PAssert(1096,void 0===g.dragging,"Only one element may be dragged or dropped at a time")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1097,void 0===g.draggingHidden,"Only one element may be dragged or dropped at a time")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1098,!g.tempUL.hasChildNodes(),"TempUL should never have children when starting a drag")}catch(PERR){g.reportError(PERR)}g.draggingHidden=target,g.dragging=target.cloneNode(!0),g.tempUL.appendChild(g.dragging);var scroll=document.getElementById("container").scrollTop,y=e.eventY+scroll-(platform.mobile?g.phoneMainY:0),width=g.width(target);g.dragStartInfo={x:e.eventX,y:e.eventY},g.tempUL.style.display="block",platform.mobile||(g.tempUL.style.left=e.eventX-e.xFromTopLeft+"px"),g.tempUL.style.top=y-e.yFromTopLeft+"px",g.tempUL.style.width=width+"px",g.addClass(g.draggingHidden,"itemBeingDragged"),g.disableMouseMove=!0},dragMove:function dragMoveFn(e){e.preventDefault();var x=platform.mobile?0:e.eventX-g.dragStartInfo.x,y=e.eventY-g.dragStartInfo.y,translate="translate3d("+x+"px, "+y+"px, 0)";g.tempUL.style[platform.transform.style]=translate;var dragOver=document.elementFromPoint(e.eventX,e.eventY);dataTransfer||(dataTransfer={dropEffect:"move",item:this}),g.vmMain.handleDragOver({srcElement:dragOver,dataTransfer:dataTransfer,diffY:e.diffY,offsetY:e.eventY,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn})},dragEnd:function dragEndFn(e){platform.ios&&g.preventClick(),g.disableMouseMove=!1;var dragging=g.dragging,draggingHidden=g.draggingHidden;g.dragging=void 0,g.draggingHidden=void 0,g.removeClass(draggingHidden,"itemBeingDragged"),dragging.parentNode.removeChild(dragging),g.tempUL.style.display="none",dataTransfer||(dataTransfer={dropEffect:"move",item:this}),g.vmMain.handleDrop({srcElement:e.srcElement,dataTransfer:dataTransfer,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn}),dataTransfer=void 0,platform.ios&&g.preventClick(),g.disableMouseMove=!1},onStart:function onStartFn(e){g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0),g.scrollAtTouchStart=g.focusedPane.getScrollOffset(),g.canRevealMenu=!0,g.isKeyboardOpen&&(g.revealTimeout=setTimeout(function(){g.canRevealMenu=!1},400)),!platform.mobile||platform.ie||"UL"===e.srcElement.tagName||g.isKeyboardOpen||g.focusedPane.isTimeline()?"SPAN"===e.srcElement.tagName&&e.offsetX<=SPThresholdLeft&&(g.clearSelection(),g.startDrag=this,e.preventDefault(),e.stopImmediatePropagation()):g.dragStartTimeout=setTimeout(function(){g.clearSelection(),g.startDrag=this,this.dragStart(e),this.dragMove(e)}.bind(this),500)},onMove:function onMoveFn(e){g.revealTimeout&&(clearTimeout(g.revealTimeout),g.revealTimeout=void 0),this.isItemMenuOpen?e.preventDefault():g.startDrag&&(!platform.touch||Math.abs(e.distanceY)>g.ClickThreshold&&Math.abs(e.distanceX)<g.ClickThreshold)&&g.startDrag===this&&this.dragStart(e),g.dragging?this.dragMove(e):platform.touch&&g.canRevealMenu&&!g.focusedPane.isTimeline()&&(g.revealingMenu||g.revealingRightMenu||e.distanceY<g.ClickThreshold&&Math.abs(e.diffX)>g.ClickThreshold)&&(g.revealingMenu||g.menus.revealGestureMenu(this,e),g.menus.updateRevealGestureMenu(e),e.preventDefault())},onClick:function onClickFn(e){if(platform.mobile&&g.phoneMenu.multiSelectMode())g.menus.multiSelect(this);else if("SPAN"===e.srcElement.tagName&&e.offsetX<=SPThresholdLeft)this.isComplete()||g.messageQueue.pushMessage({text:"You completed an item, click again to undo",type:MessageType.Info,timeout:3e3}),this.isComplete(!this.isComplete());else if("LI"===e.srcElement.tagName&&this.isCollapsed()&&e.offsetX>=g.focusedPane.getWidth()-SPThresholdRight)this.toggleCollapsed();else if(g.hasClass(e.srcElement,"tag")&&!platform.mobile){if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){var text=e.srcElement.textContent;e.shiftKey?g.focusedPane.vmSearch.setSearch(text):g.focusedPane.vmSearch.addToSearch(text)}}else if(g.hasClass(e.srcElement,"contact")){var offset=g.getOffsetOfSubNode(this.getSpan(),e.srcElement);g.autocomplete.update({item:this,start:offset+1}),g.autocomplete.show(this,e.srcElement),e.preventDefault(),platform.ios&&g.preventClick()}else if("itemOptions"===e.startSrc.id)g.itemMenuOpenedOn==this&&(g.itemMenuOpenedOn=void 0);else if("A"===e.srcElement.tagName){if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){var offset=g.offset(e.srcElement);open(e.srcElement.href,"link"+e.srcElement.href)}}else{if(g.autocomplete&&g.autocomplete.hide(),platform.ios||platform.android||platform.mobileie){var activeElement=document.activeElement,scrollTopClick=g.focusedPane.getScrollOffset(),justCancelledInertialScroll=Math.abs(scrollTopClick-g.scrollAtTouchStart)>0;if(g.isKeyboardOpen&&activeElement&&"searchPhone"!=activeElement.id||justCancelledInertialScroll||g.focusedPane.isTimeline())platform.mobileie&&android.isEnabled()&&!g.focusedPane.isTimeline()&&(android.updateInput(this),e.preventDefault(),e.stopPropagation());else{var performedScroll=!1,item=this;platform.mobile&&this==g.focusedPane.item()&&(item=g.getLastVisibleItem(g.focusedPane.item()));try{g.PAssert(1099,item,"Click on item should not happen")}catch(PERR){g.reportError(PERR)}platform.ios&&g.vmMain.setSelected([item]),g.openKeyboardOn(e,item.getSpan(),!0,function(){android.isEnabled()?android.updateInput(item):g.selectChildren(item,item.getParsedText().length,0)})}}else!platform.mobile;if(g.focusedPane.isTimeline()&&g.hasClass(e.srcElement,"text")){for(var i=0;i<this.elements.length;++i){var spanEle=this.getSpan(i),pane=g.vmMain.panes()[i];pane&&pane.vmSearch.isVisible(this)&&g.scrollIntoView(this.getSpan(i),200)}this.highlight(),g.sendEvent("Menu","GoTo")}}},onDblClick:function onDblClickFn(e){if(g.hasClass(e.srcElement,"text")&&platform.mobile){try{g.PAssert(1100,g.phoneMenu,"Phone menu should always be available on mobile")}catch(PERR){g.reportError(PERR)}g.phoneMenu.toggleMode(),e.preventDefault();for(var i=0;i<this.elements.length;++i)g.scrollIntoView(this.getSpan(i),200);this.highlight(),g.sendEvent("PhoneMenu","GoTo")}},onEnd:function onEndFn(e){g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0),g.startDrag=void 0,g.itemMenuOpenedOn==this&&g.menus.menuItemSelected(e.srcElement),(g.revealingMenu||g.phoneMenu&&g.phoneMenu.multiSelectMode())&&(e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0,platform.ios&&g.preventClick()),g.revealingMenu&&g.menus.stopRevealGestureMenu(e);var returnTime=200;g.dragging&&this.dragEnd(e)},onRightClick:function onRightClickFn(e){!e.stopPropagation||!e.preventDefault,g.menus.openItemMenu(this,e),e.preventDefault(),e.stopPropagation()},onAutocompleteTapped:function onAutocompleteTappedFn(text,trackingTag){if(android.isEnabled()){var aText=android.getInputText(),newText=aText.substr(0,trackingTag.index)+text+aText.substr(trackingTag.index+trackingTag.length);this.setText(newText,!0),android.updateInputText(this);var selOffset=trackingTag.index+text.length;android.setSelection(selOffset,selOffset)}else{var newText=this.getParsedText().substr(0,trackingTag.index)+text+this.getParsedText().substr(trackingTag.index+trackingTag.length);this.setText(newText,!0),g.selectChildren(this,trackingTag.index+text.length,0)}}};return VMLI_TapHandlers}),this.document&&(window.helperWrapper=DuchessHelpersWrapper),this.helperLibLoaded||DuchessHelpersWrapper(this.DuchessHelpers=this.DuchessHelpers||{}),define("DuchessHelpers",function(){}),define("VMLI_Text",["ko","data","gdata","globals","tracker","android","DuchessHelpers"],function(ko,d,gdata,g,tracker,android){var VMLI_Text={_runAndGetSaveData:function(text,immediateParse){var oldMetaData=this.getMetaTextSaveData();this.setRawText(text),this.parseText(immediateParse);var newMetaData=this.getMetaTextSaveData(),saveData={};for(var key in newMetaData)oldMetaData[key]!==newMetaData[key]&&(saveData[key]=newMetaData[key]);return saveData},setText:function setTextFn(text,immediateParse,fromAndroidEditing){var saveData=this._runAndGetSaveData(text,immediateParse);saveData.text=text,gdata.saveChanges(this,saveData),saveData.dateText=this.dateText,this.save(saveData,SaveFlag.Text),immediateParse&&!fromAndroidEditing&&android.isEnabled()&&android.updateInputText(this)},parseText:function parseTextFn(immediateParse){var styleInfo=void 0;immediateParse&&(styleInfo=DuchessHelpers.parseText(this.getRawText(),this.getDateTime(),this.isLoaded,d.getContacts()),styleInfo.numContacts>0&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddContact,data:[{itemID:this.id}]})),this.styleText(styleInfo,immediateParse)},styleText:function styleTextFn(styleInfo,parsedFull,changedStyles){try{g.PAssert(1101,!(!styleInfo&&parsedFull),"In a full parse, styleInfo should always be defined")}catch(PERR){g.reportError(PERR)}var styleChanges=!1,text;if(styleInfo){if(text=void 0!==styleInfo.styledText?styleInfo.styledText:void 0!==styleInfo.text?styleInfo.text:this.getRawText(),parsedFull&&this.setParsedText(styleInfo.parsedText),styleInfo.dates){0===styleInfo.dates.length&&this.date()&&this.date()&&(this.allDayDate=void 0,this.dateText=void 0,this.date(null),changedStyles&&(styleChanges=!0,changedStyles.date=void 0,changedStyles.dateText=void 0,changedStyles.allDayDate=void 0));for(var i=0;i<styleInfo.dates.length;i++){var dt=styleInfo.dates[i];this.dateText!==dt.text&&(this.dateText=dt.text,changedStyles&&(styleChanges=!0,changedStyles.dateText=dt.text)),dt.date&&this.date()&&dt.date==this.date()||(!!dt.date^!!this.date()||this.date()&&dt.date.getTime()!==this.date().getTime())&&(dt.explicitTime&&(dt.date._explicitTime=dt.explicitTime),this.allDayDate=!dt.date._explicitTime,this.date(dt.date),changedStyles&&(styleChanges=!0,changedStyles.date=dt.date,changedStyles.allDayDate=dt.date._explicitTime))}}else this.date()&&parsedFull&&(this.dateText=void 0,this.allDayDate=void 0,this.date(null),changedStyles&&(styleChanges=!0,changedStyles.date=void 0,changedStyles.dateText=void 0,changedStyles.allDayDate=void 0));this.isStyled=styleInfo.hasStyle}else text=this.getRawText();return 0===text.length&&(text=TextSpace,parsedFull=!0),this.setStyledText(text),styleChanges},checkFormats:function checkFormatsFn(i,format2,preventDisable){try{g.PAssert(1102,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1;var format1,oldEnd},toggleFormat:function toggleFormatFn(format,preventDisable){try{g.PAssert(1103,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1;var add,i,ret},clearFormats:function clearFormatsFn(){try{g.PAssert(1104,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1},areFormatsEqual:function areFormatsEqualFn(formatsA,formatsB){try{g.PAssert(1105,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!0;var i,entryA,entryB},setFormats:function setFormatsFn(format,isFromRemote){try{g.PAssert(1106,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1},appendFormats:function appendFormatsFn(newFormat,transform){try{g.PAssert(1107,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1;var i,fmt},getFormatsAfter:function getFormatsAfterFn(index){try{g.PAssert(1108,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1;var ret,i,fmt},removeFormatsAfter:function removeFormatsAfterFn(index){try{g.PAssert(1109,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1;var i,fmt},transformFormats:function transformFormatsFn(index,transform){try{g.PAssert(1110,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1;var wasModified,i,fmt},saveFormats:function saveFormatsFn(isFromRemote){try{g.PAssert(1112,!1,"No formats")}catch(PERR){g.reportError(PERR)}return!1}};return VMLI_Text}),define("VMLI_Drive",["globals","data","gdata","tracker"],function(g,d,gdata,tracker){var VMLI_Drive=function(VMLI){function iterateRemoteLink(remoteItem){gdata.cacheItem(remoteItem),iterateLink(gdata.get(remoteItem,"items")),iterateLink(gdata.get(remoteItem,"archivedItems"))}function iterateLink(itemArray){if(itemArray)for(var i=0;i<itemArray.length;++i){var item=itemArray.get(i);try{g.PAssert(1114,item,"Item must exist to get it from the array")}catch(PERR){g.reportError(PERR)}if(item){var localItem=d.getModel(item.id);localItem?localItem.linkToGDrive(item):iterateRemoteLink(item)}else itemArray.remove(i),i--}}return{linkToGDrive:function linkToGDriveFn(data,overwriteFromRemote){try{g.PAssert(1115,data,"Must be passing in valid data")}catch(PERR){g.reportError(PERR)}this.data||(this.data=data,gdata.cacheItem(data),this.setRemoteVersion(VersionType.Structure,gdata.getVersion(data,VersionType.Structure)),this.setRemoteVersion(VersionType.Text,gdata.getVersion(data,VersionType.Text)),overwriteFromRemote&&(this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text))),iterateLink(gdata.get(data,"items")),iterateLink(gdata.get(data,"archivedItems")))},resetModified:function resetModifiedFn(){var i;try{g.PAssert(1116,this.data,"Can only reset modified if remote data exists")}catch(PERR){g.reportError(PERR)}var remoteChanged=!1,versionChanges={};if(!this.modifiedOffline&&this.isRemoteVersionNewer(VersionType.Structure)){var remoteVersion=this.getRemoteVersion(VersionType.Structure);this.setVersion(VersionType.Structure,remoteVersion),versionChanges.version=remoteVersion,remoteChanged=!0}else this.modifiedOffline&&(versionChanges.modifiedOffline=!1,remoteChanged=!0);if(!this.modifiedOfflineText&&this.isRemoteVersionNewer(VersionType.Text)){var remoteVersionText=this.getRemoteVersion(VersionType.Text);this.setVersion(VersionType.Text,remoteVersionText),versionChanges.versionText=remoteVersionText,remoteChanged=!0}else this.modifiedOfflineText&&(versionChanges.modifiedOfflineText=!1,remoteChanged=!0);remoteChanged&&this.save(versionChanges,SaveFlag.None),this.setRemoteVersion(VersionType.Structure,void 0),this.setRemoteVersion(VersionType.Text,void 0);var items=this.items();for(i=0;i<items.length;++i)items[i].resetModified();if(this.hasArchivedChildren()){var archivedItems=this.archivedItems(!0);for(i=0;i<archivedItems.length;++i)archivedItems[i].resetModified()}},initFromGDrive:function initFromGDriveFn(data,parseChildren){try{g.PAssert(1119,data,"To initialize from gdrive a valid remote data object must be passed in")}catch(PERR){g.reportError(PERR)}if(!data)return void g.reportError(new Error("FATAL ERROR - No remote data for item"));this.data=data;var needsFullSave=void 0===this.id||this.forceModifiedItems,remoteChanges=needsFullSave?void 0:{},needsParsing=!1;this.id=data.id;try{needsParsing=this.resolveText(remoteChanges)||needsParsing,needsParsing=this.resolveMisc(remoteChanges)||needsParsing,needsParsing&&(g.vmMain.addParseItem(this,!0),g.vmMain.addModifiedItem(this)),this.resolveItems(remoteChanges,parseChildren)}catch(err){if(g.reportError(err),REPORT_ACTIONS)try{g.reportAction(RATAG.R,ResolveAction.Error,{msg:err.message,stacK:err.stack,item:this.getDebugData()})}catch(sErr){g.reportActionCrash(sErr)}}if(needsFullSave){try{g.PAssert(1122,void 0===remoteChanges,"If doing a full save, remoteChanges should always be undefined")}catch(PERR){g.reportError(PERR)}this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text)),this.save(null,SaveFlag.None)}else g.isEmpty(remoteChanges)||(remoteChanges.isDeleted!==!0&&(remoteChanges.isDeleted=void 0),this.save(remoteChanges,SaveFlag.None));gdata.attachEventsToItem(this)},resolveText:function resolveTextFn(remoteChanges){var needsParsing=!1;if(this.modifiedOfflineText&&!this.forceModifiedItems)if(this.isLocalVersionNewer(VersionType.Text)){if(REPORT_ACTIONS)try{g.reportAction(RATAG.A,ResolveAction.SetRemoteText,{text:this.getParsedText(),item:this.getDebugData()})
}catch(sErr){g.reportActionCrash(sErr)}gdata.saveChanges(this,{text:this.getParsedText()})}else{var remoteText=gdata.get(this.data,"text");try{g.PAssert(1123,void 0!==remoteText,"Every item should have text associated with it from gdrive")}catch(PERR){g.reportError(PERR)}var localText=this.getRawText(),needDupe=!1;if(localText!==remoteText&&(needDupe=!0),needDupe){var thisIndex=this.getIndex(),newItem=new VMLI({text:this.getParsedText()},{parent:this.parent(),forceSave:!0});if(this.parent().insertItem(newItem,thisIndex+1),this.setText(remoteText,!0),REPORT_ACTIONS)try{g.reportAction(RATAG.B,ResolveAction.DupeItem,{remoteText:remoteText,localText:this.getParsedText(),prevItem:this.getDebugData(),newItem:newItem.getDebugData()})}catch(sErr){g.reportActionCrash(sErr)}remoteChanges&&(remoteChanges.text=this.getParsedText()),needsParsing=!0}else remoteChanges&&(remoteChanges.modifiedOfflineText=!1);remoteChanges&&(remoteChanges.versionText=this.getRemoteVersion(VersionType.Text))}else if(this.isRemoteVersionNewer(VersionType.Text)){var remoteText=gdata.get(this.data,"text");try{g.PAssert(1124,void 0!==remoteText,"Every item should have text associated with it from gdrive")}catch(PERR){g.reportError(PERR)}if(this.getRawText()!=remoteText){if(REPORT_ACTIONS)try{g.reportAction(RATAG.C,ResolveAction.SetLocalText,{oldText:this.getRawText(),newText:remoteText,item:this.getDebugData()})}catch(sErr){g.reportActionCrash(sErr)}this.setRawText(remoteText),remoteChanges&&(remoteChanges.text=this.getRawText()),needsParsing=!0}remoteChanges&&this.getVersion(VersionType.Text)!==this.getRemoteVersion(VersionType.Text)&&(remoteChanges.versionText=this.getRemoteVersion(VersionType.Text))}return needsParsing},resolveMisc:function resolveMiscFn(remoteChanges){var useLocal=this.modifiedOfflineText&&this.isLocalVersionNewer(VersionType.Text),needsParsing=!1,modLocal=!1;if(useLocal||this.isRemoteVersionNewer(VersionType.Structure)||this.isRemoteVersionNewer(VersionType.Text)){var localChanges={},remoteAllDayDate=gdata.get(this.data,"allDayDate");remoteAllDayDate&&this.allDayDate!==remoteAllDayDate&&(useLocal?(localChanges.allDayDate=this.allDayDate,modLocal=!0):(this.allDayDate=remoteAllDayDate,remoteChanges&&(remoteChanges.allDayDate=remoteAllDayDate)));var remoteDate=gdata.get(this.data,"date");(remoteDate||this.date())&&(this.date()&&this.date().getTime()===remoteDate||(useLocal&&this.date()?(localChanges.date=this.date().getTime(),modLocal=!0):(this.date(new Date(remoteDate),!0),this.date()._explicitTime=!!this.allDayDate,remoteChanges&&(remoteChanges.date=this.date().getTime()),needsParsing=!0)));try{g.PAssert(1125,void 0===this.allDayDate||void 0!==this.date(),"Cannot have an alldaydate with no date specified")}catch(PERR){g.reportError(PERR)}var remoteDateCreated=gdata.get(this.data,"dateCreated");if(!this.dateCreated||!remoteDateCreated||this.dateCreated.getTime()!==remoteDateCreated)if(useLocal)localChanges.dateCreated=this.dateCreated?this.dateCreated.getTime():void 0,modLocal=!0;else{var rDate=remoteDateCreated;try{g.PAssert(1126,"string"!=typeof remoteDateCreated,"Invalid date format stored")}catch(PERR){g.reportError(PERR)}this.dateCreated=new Date(rDate),remoteChanges&&(remoteChanges.dateCreated=rDate)}var remoteDateCompleted=gdata.get(this.data,"dateCompleted");if(!(!remoteDateCompleted&&!this.dateCompleted||this.dateCompleted&&remoteDateCompleted&&this.dateCompleted.getTime()===remoteDateCompleted))if(useLocal)localChanges.dateCompleted=this.dateCompleted?this.dateCompleted.getTime():void 0,modLocal=!0;else{var rDate=remoteDateCompleted;try{g.PAssert(1127,"string"!=typeof remoteDateCompleted,"Invalid date format stored")}catch(PERR){g.reportError(PERR)}this.dateCompleted=new Date(rDate),remoteChanges&&(remoteChanges.dateCompleted=rDate)}var remotePriority=gdata.get(this.data,"priority");(remotePriority||this.priority())&&this.priority()!==remotePriority&&(useLocal?(localChanges.priority=this.priority(),modLocal=!0):(null===remotePriority&&(remotePriority=VMLIFlag.None),this.priority(remotePriority,!0)));var remoteFlagged=gdata.get(this.data,"isFlagged");(remoteFlagged||this.isFlagged())&&this.isFlagged()!==remoteFlagged&&(useLocal?(localChanges.isFlagged=this.isFlagged(),modLocal=!0):(null===remoteFlagged&&(remoteFlagged=!1),this.isFlagged(remoteFlagged,!0)));var remoteComplete=gdata.get(this.data,"isComplete");if((remoteComplete||this.isComplete())&&this.isComplete()!==remoteComplete&&(useLocal?(localChanges.isComplete=this.isComplete(),modLocal=!0):(null===remoteComplete&&(remoteComplete=!1),this.isComplete(remoteComplete,!0))),useLocal){try{g.PAssert(1128,modLocal===!g.isEmpty(localChanges),"Verify modLocal is computed properly. It should track any changes to localChanges")}catch(PERR){g.reportError(PERR)}modLocal===!0&&gdata.saveChanges(this,localChanges)}}return needsParsing},resolveItemsHelper:function resolveItemsHelperFn(resolveArchived,remoteChanges,parseChildren){var i,remoteItem,localIndex,localItem,localModel,saveItemLists,collabItemList=gdata.getItemList(this.data,resolveArchived),itemArray;itemArray=resolveArchived?this.hasArchivedChildren()?this.archivedItems(!0):[]:this.items();try{g.PAssert(1129,itemArray,"Item arrays must exist")}catch(PERR){g.reportError(PERR)}for(i=0;collabItemList&&i<collabItemList.length;i++)if(remoteItem=collabItemList.get(i)){try{g.PAssert(1131,void 0===gdata.loadSeen[remoteItem.id]||gdata.loadSeen[remoteItem.id]===!1,"Items can only be seen once on the remote.")}catch(PERR){g.reportError(PERR)}gdata.loadSeen[remoteItem.id]=this.id;var localIndex=this.getIndexOf(remoteItem.id,resolveArchived);if(localIndex>=0)localModel=itemArray[localIndex],localModel.initFromGDrive(remoteItem);else if(localItem=d.getItem(remoteItem.id),localModel=d.getModel(remoteItem.id),localItem)if(localItem.isDeleted){try{g.PAssert(1132,!localModel,"The local model should never exist when an item has been marked as deleted locally")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1133,localItem.modifiedOffline,"How did it get deleted if it wasn't modified offline?")}catch(PERR){g.reportError(PERR)}if(gdata.getVersion(remoteItem,VersionType.Structure)==localItem.version){if(gdata.itemRemoved({item:this,index:i,numToRemove:1,isArchived:resolveArchived}),REPORT_ACTIONS)try{g.reportAction(RATAG.E,ResolveAction.RemoveRemoteItem,{item:this.getChild(i).getDebugData(),parent:this.getDebugData(),index:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}i--}else{try{g.PAssert(1134,!localModel,"The local model should never exist when an item has been marked as deleted locally")}catch(PERR){g.reportError(PERR)}if(d.undeleteItem(localItem),localModel=new VMLI({data:remoteItem,isArchived:resolveArchived},{parent:this,parse:parseChildren,forceSave:!0}),itemArray.splice(i,0,localModel),saveItemLists=!0,REPORT_ACTIONS)try{g.reportAction(RATAG.F,ResolveAction.AddBackDeletedItem,{item:localModel.getDebugData(),parent:this.getDebugData(),index:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}g.vmMain.addModifiedItem(localModel)}}else if(localModel&&localModel.modifiedOffline)if(localModel.isLocalVersionNewer(VersionType.Structure)){if(REPORT_ACTIONS)try{g.reportAction(RATAG.G,ResolveAction.LocalMoveCandidate,{item:localModel.getDebugData(),parent:this.getDebugData(),index:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}try{g.PAssert(1135,gdata.loadSeen[remoteItem.id]===this.id)}catch(PERR){g.reportError(PERR)}gdata.loadSeen[remoteItem.id]=!1}else{if(REPORT_ACTIONS)try{g.reportAction(RATAG.H,ResolveAction.MoveLocalItem,{item:localModel.getDebugData(),oldParent:localModel.parent(),oldIndex:localModel.getIndex(),newParent:this.getDebugData(),newIndex:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}localModel.moveTo({parent:this,index:i,isRemoteChange:!0,shouldBeArchived:resolveArchived}),localModel.initFromGDrive(remoteItem),saveItemLists=!0,g.vmMain.addModifiedItem(localModel)}else if(localModel){if(REPORT_ACTIONS)try{g.reportAction(RATAG.I,ResolveAction.MoveLocalItem,{item:localModel.getDebugData(),oldParent:localModel.parent().getDebugData(),oldIndex:localModel.getIndex(),newParent:this.getDebugData(),newIndex:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}localModel.moveTo({parent:this,index:i,isRemoteChange:!0,shouldBeArchived:resolveArchived}),localModel.initFromGDrive(remoteItem),saveItemLists=!0,g.vmMain.addModifiedItem(localModel)}else{if(REPORT_ACTIONS)try{g.reportAction(RATAG.Q,ResolveAction.Error,{msg:"Local model does not exist for local item that was not deleted",item:localModel.getDebugData(),localIndex:i,data:localItem})}catch(sErr){g.reportActionCrash(sErr)}g.reportError(new Error("Local model does not exist for local item that was not deleted."))}else{if(localModel=new VMLI({data:remoteItem,isArchived:resolveArchived},{parent:this,parse:parseChildren}),itemArray.splice(i,0,localModel),saveItemLists=!0,REPORT_ACTIONS)try{g.reportAction(RATAG.D,ResolveAction.AddLocalItem,{item:localModel.getDebugData(),parent:this.getDebugData(),index:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}g.vmMain.addModifiedItem(localModel)}}else try{g.PAssert(1130,remoteItem,"Item in remote list does not exist")}catch(PERR){g.reportError(PERR)}if(d.hasLocalData){for(i=0;i<itemArray.length;i++)if(localModel=itemArray[i],gdata.loadSeen[localModel.id]!==this.id)if(remoteItem=localModel.data){if(localModel.modifiedOffline&&localModel.isLocalVersionNewer(VersionType.Structure)){var inTree=gdata.findInTree(remoteItem);try{g.PAssert(1142,inTree,"Item should be found in tree")}catch(PERR){g.reportError(PERR)}if(inTree){if(REPORT_ACTIONS)try{var oldParentModel=d.getModel(inTree.parent.id);g.reportAction(RATAG.M,ResolveAction.MoveRemoteItem,{item:localModel.getDebugData(),oldParent:oldParentModel?oldParentModel.getDebugData():void 0,oldIndex:inTree.index,newParent:localModel.parent().getDebugData(),newIndex:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}gdata.itemMoved({item:localModel,newInfo:{index:i,isArchived:resolveArchived},oldParent:inTree.parent,oldInfo:inTree})}else if(REPORT_ACTIONS)try{g.reportAction(RATAG.N,ResolveAction.Error,{msg:"Item not found in local tree",item:localModel.getDebugData(),localIndex:i,data:localItem})}catch(sErr){g.reportActionCrash(sErr)}localModel.initFromGDrive(remoteItem)}}else if(localModel.modifiedOfflineText){var childrenToRemove=[],localChildren;if(resolveArchived?localModel.hasArchivedChildren()&&(localChildren=localModel.archivedItems(!0)):localChildren=localModel.items(),localChildren)for(var j=0;j<localChildren.length;++j)if(localChildren[j].data&&localChildren[j].isLocalVersionNewer(VersionType.Structure)){var inTree=gdata.findInTree(localChildren[j].data);try{g.PAssert(1137,inTree,"Item should be found in tree")}catch(PERR){g.reportError(PERR)}inTree&&childrenToRemove.push({parent:inTree.parent,child:localChildren[j]})}if(d.initializeItem(localModel),gdata.itemAdded({item:this,addedItem:localModel,index:i,isArchived:resolveArchived}),REPORT_ACTIONS)try{g.reportAction(RATAG.J,ResolveAction.AddRemoteItem,{item:localModel.getDebugData(),parent:this.getDebugData(),index:i,isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}for(var j=0;j<childrenToRemove.length;++j){var removeData=childrenToRemove[j];try{g.PAssert(1138,removeData,"Must have valid data to remove")}catch(PERR){g.reportError(PERR)}var isArchived=removeData.child.isArchived(),remoteList=gdata.getItemList(removeData.parent,isArchived);try{g.PAssert(1139,remoteList,"The item has children, it must have a list")}catch(PERR){g.reportError(PERR)}var index=remoteList.indexOf(removeData.child.data);try{g.PAssert(1140,index>=0,"Remote item must be in the parents list")}catch(PERR){g.reportError(PERR)}if(gdata.itemRemoved({item:removeData.parent,index:index,numToRemove:1,isArchived:isArchived}),REPORT_ACTIONS)try{g.reportAction(RATAG.K,ResolveAction.RemoveRemoteItem,{item:removeData.child.getDebugData(),parent:d.getModel(removeData.parent.id).getDebugData(),index:index,isArchived:isArchived})}catch(sErr){g.reportActionCrash(sErr)}}localModel.initFromGDrive(localModel.data)}else{if(REPORT_ACTIONS)try{g.reportAction(RATAG.L,ResolveAction.DeleteLocalItem,{item:localModel.getDebugData(),parent:this.getDebugData(),index:localModel.getIndex(),isArchived:resolveArchived})}catch(sErr){g.reportActionCrash(sErr)}try{g.PAssert(1141,d.getItem(localModel.id),"Trying to delete an item locally that doesn't exist locally")}catch(PERR){g.reportError(PERR)}this.deleteChild(localModel),i--,saveItemLists=!0,g.vmMain.addModifiedItem(localModel)}if(!resolveArchived&&collabItemList&&(collabItemList.length>0||itemArray.length>0)){var localModArray=[],nonSharedArray=void 0,tempArray=[],remoteArray=collabItemList.asArray(),reorderFound=!1;for(i=0;i<remoteArray.length;++i){var tempID=remoteArray[i].id,tempModel=d.getModel(tempID);try{g.PAssert(1143,tempModel,"If the remote ID exists the local item should have been created.")}catch(PERR){g.reportError(PERR)}var localIndex=this.getIndexOf(tempID);tempModel&&tempModel.modifiedOffline&&tempModel.isLocalVersionNewer(VersionType.Structure)?localIndex>=0?localModArray.push(localIndex):(nonSharedArray||(nonSharedArray=[]),log(this.id+": Item in remote array not found in local array: ",tempID),nonSharedArray.push(tempID)):localIndex>=0?(tempArray.push(tempID),localIndex!==i&&(reorderFound=!0)):(nonSharedArray||(nonSharedArray=[]),log(this.id+": Item in remote array not found in local array: ",tempID),nonSharedArray.push(tempID))}if(reorderFound||localModArray.length>0){var tempArrayText;for(localModArray.sort(),i=0;i<localModArray.length;i++){var localItem=itemArray[localModArray[i]];localItem&&tempArray.splice(localModArray[i],0,localItem.id);var tempArrayText}nonSharedArray&&nonSharedArray.length>0&&(tempArray=tempArray.concat(nonSharedArray));var remoteArrayText,localArrayText,tempArrayText,remoteArrayText;for(i=0;i<tempArray.length;++i)for(var searchItem=tempArray[i],j=i;j<collabItemList.length;++j){var findItem=collabItemList.get(j);if(searchItem===findItem.id){if(i!==j){var lModel=d.getModel(findItem.id);if(REPORT_ACTIONS)try{g.reportAction(RATAG.O,ResolveAction.MoveRemoteItem,{item:lModel.getDebugData(),oldParent:this.getDebugData(),oldIndex:j,newParent:lModel.parent().getDebugData(),newIndex:i,isArchived:!1})}catch(sErr){g.reportActionCrash(sErr)}var oldInfo={index:j,isArchived:!1},newInfo={index:i,isArchived:!1};gdata.itemMoved({item:lModel,newInfo:newInfo,oldParent:this,oldInfo:oldInfo}),saveItemLists=!0,g.vmMain.addModifiedItem(lModel);var remoteArrayText}break}}var localArrayText;for(i=0;i<tempArray.length;++i)for(var searchItem=tempArray[i],j=i;j<itemArray.length;++j){var findItem=itemArray[j];if(searchItem===findItem.id){if(i!==j){if(REPORT_ACTIONS)try{g.reportAction(RATAG.P,ResolveAction.MoveLocalItem,{item:findItem.getDebugData(),oldParent:findItem.parent().getDebugData(),oldIndex:findItem.getIndex(),newParent:this.getDebugData(),newIndex:i,isArchived:!1})}catch(sErr){g.reportActionCrash(sErr)}findItem.moveTo({parent:this,index:i,isRemoteChange:!0,shouldBeArchived:!1}),saveItemLists=!0,g.vmMain.addModifiedItem(findItem);var localArrayText}break}}}}}if(saveItemLists){if(d.hasLocalData&&(resolveArchived?this.hasArchivedChildren()&&this.archivedItems().valueHasMutated():this.items.valueHasMutated()),resolveArchived&&!this.hasArchivedChildren()){try{g.PAssert(1148,itemArray.length>0,"If saving an archive array it should have data in it")}catch(PERR){g.reportError(PERR)}this.archivedItems()(itemArray)}remoteChanges&&(remoteChanges.items=this.getItemsArrayForSave())}},resolveItems:function resolveItemsFn(remoteChanges,parseChildren){this.resolveItemsHelper(!1,remoteChanges,parseChildren),this.resolveItemsHelper(!0,remoteChanges,parseChildren)},onValueChanged:function onValueChangedFn(event){if(!event.isLocal||tracker.undoRedoActive){var mappedProperty=g.translateFieldOut(event.property);if(this.id===event.target.id)switch(mappedProperty){case"version":case"versionText":var remoteVersion=gdata.get(this.data,mappedProperty);if(remoteVersion>this[mappedProperty]||void 0===this[mappedProperty]){var changes={modifiedOffline:!1};changes[mappedProperty]=this[mappedProperty]=remoteVersion,this.save(changes,SaveFlag.None)}break;case"formats":var formats=JSON.parse(JSON.stringify(gdata.get(this.data,"formats")));formats||(formats=[]),this.setFormats(formats,!0);break;case"priority":this.priority(event.newValue,!0);break;case"isComplete":this.isComplete(event.newValue,!0);break;case"isFlagged":this.isFlagged(event.newValue,!0);break;case"dateCompleted":this.dateCompleted=new Date(event.newValue),this.save({dateCompleted:event.newValue},SaveFlag.None);break;case"isArchived":this.isArchived(event.newValue),this.save({isArchived:event.newValue},SaveFlag.None);break;case"date":this.date(new Date(event.newValue)),this.save({date:event.newValue},SaveFlag.None);break;case"allDayDate":this.allDayDate=event.newValue,this.save({allDayDate:event.newValue},SaveFlag.None);break;case"items":case"archivedItems":var isArchived=!("items"===mappedProperty);if(event.newValue){for(var i=0;i<event.newValue.length;++i)this.addRemoteItem(event.newValue.get(i),i,isArchived);gdata.attachEventsToItem(this)}else{try{g.PAssert(1150,0===event.oldValue.length,"Expected no items in list")}catch(PERR){g.reportError(PERR)}this.removeAllRemoteItems(isArchived)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None);break;case"dateCreated":break;case"text":this.onTextChanged(event);break;default:ShouldLog(LogLevels.Error)&&log("Unhandled value changed remotely: ",mappedProperty,event)}}},onTextChanged:function onTextChangedFn(event){if(!event.isLocal||tracker.undoRedoActive){var remoteText=gdata.get(this.data,"text");if(remoteText!=this.getRawText()&&(this.setRawText(remoteText),this.parseText(!0),this.save({text:this.getRawText()},SaveFlag.None),tracker.undoRedoActive)){var evType=TrackerType.SetText;tracker.notifyStateChangedFromUndoRedo(evType,{itemID:this.id,position:g.findFirstDiff(event.newValue,event.oldValue),text:event.newValue})}}},addRemoteItem:function addRemoteItemFn(remoteItem,index,isArchived){var remoteID=remoteItem.id;gdata.cacheItem(remoteItem);var localList=isArchived?this.archivedItems():this.items;if(!(index<localList().length&&localList()[index].id===remoteID)){var vmli=d.getModel(remoteID);vmli?(clearTimeout(vmli.deleteTimeout),vmli.deleteTimeout=void 0):vmli=new VMLI({data:remoteItem},{parent:this,parse:!0}),vmli.isDeleted&&(vmli.isDeleted=!1,vmli.save(null,SaveFlag.None)),vmli.isArchived()!==isArchived&&(vmli.isArchived(isArchived),vmli.save({isArchived:isArchived},SaveFlag.None)),vmli.parent(this),localList.splice(index,0,vmli),g.fireCustomEvent("itemAdded",{item:vmli,force:!0}),g.timeline.notifyStateChanged(vmli),tracker.undoRedoActive&&tracker.notifyStateChangedFromUndoRedo(TrackerType.Create,{itemID:vmli.id,parent:this.id,position:index,text:gdata.get(remoteItem,"text")})}},removeAllRemoteItems:function(isArchived){isArchived?this.hasArchivedChildren()&&this.archivedItems()([]):this.items([])},removeRemoteItem:function removeRemoteItemFn(remoteItem,index,isArchived,deleteLocal){var localList;if(isArchived){try{g.PAssert(1151,this.hasArchivedChildren(),"Must have a valid item list to remove from")}catch(PERR){g.reportError(PERR)}localList=this.archivedItems()}else localList=this.items;var localItem=localList()[index];if(localItem&&localItem.id===remoteItem.id){try{g.PAssert(1152,localItem,"Expect a valid local item to remove")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1153,remoteItem.id==localItem.id,"Remote item should match local items")}catch(PERR){g.reportError(PERR)}tracker.undoRedoActive&&tracker.notifyStateChangedFromUndoRedo(TrackerType.Delete,{itemID:localItem.id,parent:this.id,position:index,previous:g.getPreviousItem(localItem).id}),localList.splice(index,1),localItem.deleteTimeout=deleteLocal?setTimeout(localItem.deleteFromServer.bind(localItem),2e3):setTimeout(localItem.markDeleted.bind(localItem),2e3)}},onListAdded:function onListAddedFn(event){if(!event.isLocal||tracker.undoRedoActive){var areItemsArchived=!1,remoteItemList=gdata.get(this.data,"items");if(!remoteItemList||event.target.id!==remoteItemList.id){var remoteArchivedList=gdata.get(this.data,"archivedItems");(remoteArchivedList&&event.target.id===remoteArchivedList.id||!remoteItemList)&&(areItemsArchived=!0)}var getRemoteFn,startIndex,endIndex;event.values.length>0?(startIndex=event.index,endIndex=startIndex+event.values.length,getRemoteFn=function(index){return event.values[index]}):(startIndex=0,endIndex=event.target.length,getRemoteFn=function(index){return event.target.get(index)});for(var i=startIndex;endIndex>i;++i){var eventIndex=i-startIndex,remoteItem=getRemoteFn(eventIndex);try{g.PAssert(1154,remoteItem,"Always expect a valid item at each index")}catch(PERR){g.reportError(PERR)}this.addRemoteItem(remoteItem,i,areItemsArchived)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None)}},onListRemoved:function onListRemovedFn(event){var localItem;if(!event.isLocal||tracker.undoRedoActive){var idx,remoteItem,debugLocalItem,localText,areItemsArchived=!1,remoteItemList=gdata.get(this.data,"items");if(!remoteItemList||event.target.id!==remoteItemList.id){var remoteArchivedList=gdata.get(this.data,"archivedItems");remoteArchivedList&&event.target.id===remoteArchivedList.id&&(areItemsArchived=!0)}for(var startIndex=event.index,endIndex=startIndex+event.values.length,i=endIndex-1;i>=startIndex;i--){var eventIndex=i-startIndex;try{g.PAssert(1156,!!event.values[eventIndex],"Always expect a valid item at each index")}catch(PERR){g.reportError(PERR)}var remoteItem=event.values[eventIndex],deleteLocal=event.isLocal&&tracker.undoRedoActive;this.removeRemoteItem(remoteItem,i,areItemsArchived,deleteLocal)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None)}},onListSet:function onListSetFn(event){try{g.PAssert(1157,!1,"What? This shouldn't happen!",event)}catch(PERR){g.reportError(PERR)}},onObjectChanged:function onObjectChangedFn(event){if(event.ocHandled)return!1;if(event.ocHandled=this.id,event.stopPropagation(),event.isLocal&&!tracker.undoRedoActive)return!1;for(var i=0;i<event.events.length;++i)switch(event.events[i].type){case gapi.drive.realtime.EventType.TEXT_DELETED:this.onTextChanged(event.events[i]);break;case gapi.drive.realtime.EventType.TEXT_INSERTED:this.onTextChanged(event.events[i]);break;case gapi.drive.realtime.EventType.VALUES_ADDED:this.onListAdded(event.events[i]);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:this.onListRemoved(event.events[i]);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:this.onValueChanged(event.events[i]);break;case gapi.drive.realtime.EventType.VALUES_SET:try{g.PAssert(1158,!1,"VALUES_SET should never be triggered")}catch(PERR){g.reportError(PERR)}break;default:try{g.PAssert(1159,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}return!1},deleteFromServer:function deleteFromServerFn(){d.dbDeleteItem(this.id)},markDeleted:function markDeletedFn(){d.deleteItem(this),g.timeline.notifyStateChanged(this)}}};return VMLI_Drive}),define("sounds",["globals","platform"],function(g,platform){function addSource(sound,src){var source=document.createElement("source");source.src=src,sound.appendChild(source)}var self={},bank={};return self.add=function addFn(name){if(self[name]=name,!bank[name]){var sound=document.createElement("audio");addSource(sound,"sounds/"+name+".mp3"),sound.preload="auto",bank[name]=sound}},self.play=function playFn(name){if(!g.settings.get(Settings.noSounds)){if(!bank[name])return log("Tried to play a sound that has not been loaded:",name),void console.trace();try{bank[name].play()}catch(err){log("Failed to play audio",err)}}},self}),define("VMLI",["ko","globals","platform","data","gdata","VMLI_TapHandlers","VMLI_Text","VMLI_Drive","tracker","sounds"],function(ko,g,platform,d,gdata,VMLI_TapHandlers,VMLI_Text,VMLI_Drive,tracker,sounds){function VMLI(p,extraInfo){if(!p.id&&p.data&&p.data.id)p.id=p.data.id;else if(p.id&&p.data)try{g.PAssert(1160,p.id==p.data.id,"If passing in a local id and a remote ID, they should match")}catch(PERR){g.reportError(PERR)}if(p.id&&d.getModel[p.id]){ShouldLog(LogLevels.Warning)&&log("Attempting to create an already created VMLI: ",p.id);try{g.PAssert(1161,!1,"Should not be constructing a VMLI here")}catch(PERR){g.reportError(PERR)}return d.getModel[p.id]}try{g.PAssert(1162,void 0===p.v,"We should never be passing in 'v'")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1163,void 0===p.extern,"We should never be passing in 'extern'")}catch(PERR){g.reportError(PERR)}this._parent=extraInfo?extraInfo.parent:void 0,this._rawText=p.data?"":p.text,this._searchText=p.data?"":p.text?p.text.toLowerCase():"",this._parsedText=void 0,this._styledText=ko.observable(""),this._isArchived=p.isArchived||!1,this.items=ko.observableArray(),this._archivedItems=void 0,this._date=ko.observable(void 0);var origFlags=VMLIFlag.None;p.isCollapsed&&(origFlags|=VMLIFlag.Collapsed),p.isComplete&&(origFlags|=VMLIFlag.Complete),p.isFlagged&&(origFlags|=VMLIFlag.Flagged),p.priority&&(origFlags|=p.priority),this._flags=ko.observable(origFlags),this.styleLength=0,this.dateText=p.dateText,this.allDayDate=void 0,this.dateCreated=p.dateCreated?new Date(p.dateCreated):new Date,this.dateCompleted=p.dateCompleted?new Date(p.dateCompleted):void 0,this.elements=[],this.outlineElements=[],this.isLoaded=!1,this.isDeleted=p.isDeleted||!1,this.isStyled=!1,this.modifiedOffline=void 0,this.modifiedOfflineText=void 0,this.deleteTimeout=void 0,this.highlightTimeout=void 0,this.data=void 0,this._version=-1,this._versionText=-1,this._versionRemote=void 0,this._versionRemoteText=void 0,this.levelsDeep=ko.observable(this._parent?this._parent.levelsDeep()+1:0),__TOTAL_ITEMS++,p.isArchived&&__TOTAL_ARCHIVED_ITEMS++,this._needsParse=!1,this.init(p,extraInfo)}return window.__TOTAL_ITEMS=0,window.__TOTAL_ARCHIVED_ITEMS=0,window.__TOTAL_ARCHIVE_PARENTS=0,VMLI.prototype={_getLineStyle:function _getLineStyleFn(){return this._flags()&g.LSMask},_getPriority:function _getPriorityFn(){return this._flags()&g.PMask},stylePadding:function stylePaddingFn(context){var paddingStart,paddingLevels;if(context){paddingStart=platform.phone?15:24;var pane=context.$parents[context.$parents.length-2];try{g.PAssert(1164,pane&&pane.item.peek(),"Invalid pane")}catch(PERR){g.reportError(PERR)}var rootDepth=pane.item.peek().levelsDeep.peek();paddingLevels=this.levelsDeep()-rootDepth-1}else paddingStart=platform.phone?40:25,paddingLevels=this.levelsDeep()-1;return paddingStart+20*paddingLevels+"px"},_updateStylePadding:function _updateStylePaddingFn(parentDepth,forceChange){try{g.PAssert(1165,this._parent,"Must have a valid parent to update padding, root should never change")}catch(PERR){g.reportError(PERR)}var newDepth=parentDepth+1,hasChanged=this.levelsDeep.peek()!==newDepth;if(hasChanged||forceChange){hasChanged?this.levelsDeep(newDepth):this.levelsDeep.valueHasMutated();for(var children=this.items.peek(),i=0;i<children.length;++i)children[i]._updateStylePadding(newDepth,forceChange)}},styleProps:function stylePropsFn(){var localFlags=this._flags(),styleProps=localFlags&VMLIFlag.Header?"pHeader ":"";return localFlags&VMLIFlag.Collapsed&&(styleProps+="collapsed "),localFlags&VMLIFlag.Selected&&(styleProps+="selected "),localFlags&VMLIFlag.Highlighted&&(styleProps+="highlight "),localFlags&VMLIFlag.NumList&&(styleProps+="pNumList "),this.isArchived()&&(styleProps+="archived "),styleProps+=localFlags&VMLIFlag.Complete?"pComplete ":localFlags&g.PMask?g.priorityMapOut[localFlags&g.PMask]+" ":"pNormal ",localFlags&VMLIFlag.Flagged&&(styleProps+="pStar "),styleProps},copyProperties:function copyPropertiesFn(src){this.isFlagged(src.isFlagged()),this.isComplete(src.isComplete()),this.priority(src.priority())},parent:function parentFn(){if(1===arguments.length){try{g.PAssert(1166,arguments[0]instanceof VMLI||void 0===arguments[0],"Parent must be a VMLI")}catch(PERR){g.reportError(PERR)}this._parent=arguments[0],void 0!==arguments[0]&&this._updateStylePadding(this._parent.levelsDeep(),!1)}return this._parent},archivedItems:function archivedItemsFn(underlying){return this._archivedItems||(this._archivedItems=ko.observableArray(),window.__TOTAL_ARCHIVE_PARENTS++),underlying?this._archivedItems():this._archivedItems},hasArchivedChildren:function hasArchivedChildrenFn(){return void 0!==this._archivedItems?this._archivedItems().length>0:!1},headers:function headersFn(){for(var headers=[],items=this.items(),i=0;i<items.length;++i)items[i].isHeader()&&headers.push(items[i]);return headers},isArchived:function isArchivedFn(){if(1===arguments.length){var oldValue=this._isArchived;this._isArchived=arguments[0],arguments[0]!==oldValue&&g.timeline.notifyStateChanged(this,PropChangeType.Archive)}return this._isArchived},getRawText:function getRawTextFn(){return this._rawText},getParsedText:function getParsedTextFn(){try{g.PAssert(1167,this._needsParse===!1,"Text should be parsed before calling get")}catch(PERR){g.reportError(PERR)}return this._parsedText?this._parsedText:this._rawText},getStyledText:function getStyledTextFn(){return this._styledText()},getSearchText:function getSearchTextFn(){try{g.PAssert(1169,void 0!==this._searchText,"Item should always have search text")}catch(PERR){g.reportError(PERR)}return this._searchText},setRawText:function setRawTextFn(text){(void 0===text||null===text)&&(text=""),this._rawText=text,text&&(this._searchText=text.toLowerCase()),this._parsedText=void 0,this._needsParse=!0},setParsedText:function setParsedTextFn(text){var changed=this._parsedText===text||void 0===text;this._parsedText=text,text&&(this._searchText=text.toLowerCase()),this._needsParse=!1},setStyledText:function setStyledTextFn(text){this._styledText(text)},priority:function priorityFn(pri,fromRemote){if(void 0===pri)return this._getPriority();try{g.PAssert(1172,g.priorityMapOut[pri],"Priority must be defined in globals")}catch(PERR){g.reportError(PERR)}var oldPriority=this._getPriority();if(pri!==oldPriority){var newFlags=this._flags()&~g.PCMask|pri;if(this._flags(newFlags),this.isLoaded){var saveData={priority:pri};fromRemote||(gdata.saveChanges(this,saveData),saveData=g.clone(saveData));var saveFlags=fromRemote?SaveFlag.None:SaveFlag.Text;this.save(saveData,saveFlags),g.timeline.notifyStateChanged(this,PropChangeType.Priority|PropChangeType.Complete),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"priority",newValue:pri,oldValue:oldPriority})}}},date:function dateFn(date,fromRemote){return void 0!==date&&date!==this._date()&&(null===date&&(date=void 0),this._date(date),this.allDayDate=date?!date._explicitTime:!1,g.timeline.notifyStateChanged(this,PropChangeType.Date),this.isLoaded&&!fromRemote&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:[{itemID:this.id,date:date}]})),this._date()},_isFlagHelper:function _isFlagHelperFn(flag,value){if(void 0!==value){var newFlags=value?this._flags()|flag:this._flags()&~flag;return void this._flags(newFlags)}return!!(this._flags()&flag)},isImportant:function isImportantFn(){return this._getPriority()},isComplete:function isCompleteFn(value,fromRemote){if(void 0===value)return this._isFlagHelper(VMLIFlag.Complete);var saveData={isComplete:value};if(value!==this._isFlagHelper(VMLIFlag.Complete)&&(this._isFlagHelper(VMLIFlag.Complete,value),this.isLoaded)){value?(this.dateCompleted||(this.dateCompleted=new Date,saveData.dateCompleted=this.getDateCompletedTime()),g.vmMain.isLoaded&&g.aggregateEvent("ItemCompleted")):(this.dateCompleted=void 0,saveData.dateCompleted=void 0),fromRemote||(gdata.saveChanges(this,saveData),saveData=g.clone(saveData));var saveFlags=fromRemote?SaveFlag.None:SaveFlag.Text;this.save(saveData,saveFlags),g.timeline.notifyStateChanged(this,PropChangeType.Complete),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isComplete",newValue:value,oldValue:!value})
}},isFlagged:function isFlaggedFn(value,fromRemote){if(void 0===value)return this._isFlagHelper(VMLIFlag.Flagged);if(value!==this._isFlagHelper(VMLIFlag.Flagged)){var origFlags=value?this._flags()&~VMLIFlag.Complete:this._flags(),newFlags=value?origFlags|VMLIFlag.Flagged:origFlags&~VMLIFlag.Flagged;if(this._flags(newFlags),this.isLoaded){var saveData={isFlagged:value};fromRemote||(gdata.saveChanges(this,saveData),saveData=g.clone(saveData));var saveFlags=fromRemote?SaveFlag.None:SaveFlag.Text;this.save(saveData,saveFlags),g.timeline.notifyStateChanged(this,PropChangeType.Flagged|PropChangeType.Complete)}tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isFlagged",newValue:value,oldValue:!value})}},isHeader:function isHeaderFn(){try{g.PAssert(1173,0===arguments.length,"Shouldnt be passing arguemtns to isHeader")}catch(PERR){g.reportError(PERR)}var value=this.items().length>0,currStyle=this._flags();if(!!(currStyle&VMLIFlag.Header)!==value){var newFlags=value?currStyle|VMLIFlag.Header:currStyle&~VMLIFlag.Header;this._flags(newFlags),this._parent&&this._parent.isFullscreen()&&this._updateStylePadding(this._parent.levelsDeep(),!0)}return value},isCollapsed:function isCollapsedFn(value){return this._isFlagHelper(VMLIFlag.Collapsed,value)},isSelected:function isSelectedFn(value){return platform.mobile?this._isFlagHelper(VMLIFlag.Selected,value):!1},isHighlighted:function isHighlightedFn(value){return this._isFlagHelper(VMLIFlag.Highlighted,value)},isNumList:function isNumListFn(value){return this._isFlagHelper(VMLIFlag.NumList,value)},hasCompletedAncestor:function hasCompletedAncestorFn(){for(var parent=this.parent();parent;){if(parent.isComplete())return!0;parent=parent.parent()}},hasTime:function hasTimeFn(){return this.date()?"12:00am"!==this.date().toString("h:mmtt"):this.dateCompleted},time:function timeFn(){return this.date()?"12:00am"==this.date().toString("h:mmtt")?"Any Time":this.date().toString("h:mm tt"):this.dateCompleted?this.dateCompleted.toString("h:mmtt"):""},createDateString:function createDateStringFn(dt){return dt.toString(dt.isBefore(Date.today().addWeeks(1))?"dddd h:mm tt":"MM/dd h:mm tt")},fullTime:function fullTimeFn(){var date=this.date();return date?void this.createDateString(date):""},setVersion:function setVersionFn(type,v){var verStr;switch(type){case VersionType.Structure:this._version=v;break;case VersionType.Text:this._versionText=v;break;default:try{g.PAssert(1174,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}},getVersion:function getVersionFn(type){var v;switch(type){case VersionType.Structure:v=this._version;break;case VersionType.Text:v=this._versionText;break;default:v=-2;try{g.PAssert(1175,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},setRemoteVersion:function setRemoteVersionFn(type,v){var verStr;switch(type){case VersionType.Structure:this._versionRemote=v;break;case VersionType.Text:this._versionRemoteText=v;break;default:try{g.PAssert(1176,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}},getRemoteVersion:function getRemoteVersionFn(type){var v;switch(type){case VersionType.Structure:v=this._versionRemote;break;case VersionType.Text:v=this._versionRemoteText;break;default:v=-2;try{g.PAssert(1177,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},isLocalVersionNewer:function isLocalVersionNewerFn(type){return this.getVersion(type)==this.getRemoteVersion(type)},isRemoteVersionNewer:function isRemoteVersionNewerFn(type){return!this.isLocalVersionNewer(type)},init:function initFn(p,extraInfo){if(p.data){var verStructure=gdata.getVersion(p.data,VersionType.Structure),verText=gdata.getVersion(p.data,VersionType.Text);this.setRemoteVersion(VersionType.Structure,verStructure),this.setRemoteVersion(VersionType.Text,verText),tracker.beginAction(),this.initFromGDrive(p.data,extraInfo&&extraInfo.parse),tracker.endAction(),this.setRemoteVersion(VersionType.Structure,void 0),this.setRemoteVersion(VersionType.Text,void 0)}else this.setVersion(VersionType.Structure,p.version),this.setVersion(VersionType.Text,p.versionText),this.modifiedOffline=p.modifiedOffline,this.modifiedOfflineText=p.modifiedOfflineText,this.modifiedOffline,this.modifiedOfflineText,g.vmMain.isLoaded&&gdata.isConnected()?d.initializeItem(this):this.id=p.id||g.generateTempId(),p.date&&(this.allDayDate=p.allDayDate,this.date(new Date(p.date)),this.date()._explicitTime=!this.allDayDate),p.dateCompleted&&(this.dateCompleted=new Date(p.dateCompleted)),p.items&&this.updateItems(p.items,extraInfo&&extraInfo.forceSave,extraInfo&&extraInfo.parse);this.parseText(extraInfo&&extraInfo.parse),extraInfo&&extraInfo.forceSave&&(this.save(void 0,SaveFlag.Prop),this.date()&&gdata.saveChanges(this,this.getMetaTextSaveData())),g.vmMain.isLoaded&&g.aggregateEvent("ItemCreated"),d.setModel(this.id,this)},onLoad:function onLoadFn(element,pModel){if(platform.mobile&&(pModel=g.focusedPane),pModel&&pModel.trackDOM&&pModel.trackDOM()){try{g.PAssert(1178,pModel,"Items must be added to a pane")}catch(PERR){g.reportError(PERR)}var paneID=pModel.id;if(this.isLoaded=!0,g.hasClass(element,"outlineItem"))this.outlineElements[paneID]=element,pModel.vmSearch.checkItem(this,!0,!1);else{this.elements[paneID]=element;try{g.PAssert(1181,g.hasClass(this.elements[paneID].firstElementChild,"text"))}catch(PERR){g.reportError(PERR)}(!g.vmMain.isLoaded||pModel!=g.focusedPane||pModel.reloading)&&pModel.vmSearch.checkItem(this,!1,!0)}}},resetDriveData:function resetDriveDataFn(){this._versionRemote=void 0,this._versionRemoteText=void 0,this.data=void 0},isFullscreen:function isFullscreenFn(){return g.focusedItem===this},findItem:function findItemFn(id){var found=this.getIndexOf(id,!1);return found>=0?{index:found,arr:this.items,isArchived:!1}:this.hasArchivedChildren()&&(found=this.getIndexOf(id,!0),found>=0)?{index:found,arr:this.archivedItems(),isArchived:!0}:void 0},updateItems:function updateItemsFn(newItems,forceSave,parse){var collabItemList,collabArchivedItemList;this.data&&(collabItemList=gdata.get(this.data,"items"),collabArchivedItemList=gdata.get(this.data,"archivedItems"));try{g.PAssert(1184,!this.hasChildren(),"Update items should only be called from initialize when there are no items already loaded")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1185,!this.hasArchivedChildren(),"Update items should only be called from initialize when there are no items already loaded")}catch(PERR){g.reportError(PERR)}for(var itemsModified=!1,archivedItemsModified=!1,i=0;i<newItems.length;++i){var item=newItems[i],itemVM=d.getModel(item);if(itemVM){var oldParentInfo=d.getItem(itemVM.parent().id),oldParentIndex=oldParentInfo.items.indexOf(itemVM.id);try{g.PAssert(1190,-1===oldParentIndex,"Expect that the old parent has been notified")}catch(PERR){g.reportError(PERR)}var childModelIndex=itemVM.getIndex();childModelIndex>-1&&itemVM.parent().removeChildAtIndex(childModelIndex),itemVM.parent(this)}else if("object"!=typeof item){var itemInfo=d.getItem(item);try{g.PAssert(1186,itemInfo,"Referenced item doesn't exist",item)}catch(PERR){g.reportError(PERR)}if(itemInfo)itemVM=new VMLI(itemInfo,{parent:this,forceSave:forceSave,parse:parse});else try{g.PAssert(1187,!1)}catch(PERR){g.reportError(PERR)}}else{try{g.PAssert(1188,item,"Item must exist otherwise we arent creating anything")}catch(PERR){g.reportError(PERR)}if(item)itemVM=new VMLI(item,{parent:this,forceSave:forceSave,parse:parse});else try{g.PAssert(1189,!1)}catch(PERR){g.reportError(PERR)}}try{g.PAssert(1191,itemVM,"There must be a model at this point")}catch(PERR){g.reportError(PERR)}itemVM&&(itemVM.isArchived()?(archivedItemsModified=!0,this.archivedItems(!0).push(itemVM),!collabArchivedItemList&&this.data&&(collabArchivedItemList=gdata.ensureItemList(this,!0)),collabArchivedItemList&&collabArchivedItemList.push(itemVM.data)):(itemsModified=!0,this.items().push(itemVM),!collabItemList&&this.data&&(collabItemList=gdata.ensureItemList(this,!1)),collabItemList&&collabItemList.push(itemVM.data)))}itemsModified&&this.items.valueHasMutated(),archivedItemsModified&&this.archivedItems().valueHasMutated()},insertItem:function insertItemFn(item,index,underlying){var arr=underlying?this.items():this.items;isNaN(index)?arr.push(item):arr.splice(index,0,item),d.insertItems(this,[item],index),g.fireCustomEvent("itemAdded",{item:item,force:!1})},moveTo:function moveToFn(params){var parent=params.parent,index=params.index,isRemoteChange=params.isRemoteChange,shouldBeArchived=params.shouldBeArchived,noVersion=params.noVersion,underlying=params.underlying;try{g.PAssert(1192,parent instanceof VMLI)}catch(PERR){g.reportError(PERR)}void 0===index&&(index=-1),void 0===isRemoteChange&&(isRemoteChange=!1),void 0===shouldBeArchived&&(shouldBeArchived=!1);var oldParent=this.parent(),oldInfo=oldParent.findItem(this);if(oldInfo){if(oldParent===parent){if(oldInfo.index===index)return;oldInfo.index<index&&index--}underlying&&(oldInfo.arr=oldInfo.arr()),oldInfo.arr.splice(oldInfo.index,1),this.parent(parent);var arr=shouldBeArchived?parent.archivedItems():parent.items;underlying&&(arr=arr()),0>index?arr.push(this):arr.splice(index,0,this);var newInfo={index:index,isArchived:shouldBeArchived};d.moveItem({item:this,newInfo:newInfo,oldParent:oldParent,oldInfo:oldInfo,isRemoteChange:isRemoteChange,noVersion:noVersion})}},getItemsArrayForSave:function getItemsArrayForSaveFn(){for(var saveItems=[],items=this.items(),i=0;i<items.length;++i)saveItems.push(items[i].id);if(this.hasArchivedChildren())for(var archivedItems=this.archivedItems(!0),i=0;i<archivedItems.length;++i)saveItems.push(archivedItems[i].id);return saveItems},getDateTime:function getDateTimeFn(){return this.date()?this.date().getTime():void 0},getDateCompletedTime:function getDateCompletedTimeFn(){return this.dateCompleted?this.dateCompleted.getTime():void 0},getMetaTextSaveData:function getMetaTextSaveDataFn(){var currentDate=this.date(),numDate,allDayDate;return void 0!==currentDate&&(numDate=currentDate.getTime(),allDayDate=!currentDate._explicitTime),{date:numDate,allDayDate:allDayDate,dateCompleted:this.getDateCompletedTime()}},getBasicJSON:function getBasicJSONFn(){try{g.PAssert(1193,this.date(),"Must have a valid date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1194,!this.allDayDate,"All day dates should not be scheduled")}catch(PERR){g.reportError(PERR)}if(this.allDayDate)return"";var dateJSON=this.date().toJSON(),alertDateJSON;return alertDateJSON=this.allDayDate?this.date().addDays(-1).setHours(17).toJSON():this.date().addMinutes(-30).toJSON(),'{"id":"'+this.id+'","text":"'+this.getRawText()+'","date":"'+dateJSON+'","alertDate":"'+alertDateJSON+'"}'},getDebugData:function getDebugDataFn(){var data={id:this.id,parent:this._parent?this._parent.id:void 0,items:this.getItemsArrayForSave(),text:this.getRawText(),isArchived:this.isArchived(),isDeleted:this.isDeleted,version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return data},getFullSaveData:function getFullSaveDataFn(){var data={id:this.id,text:this.getRawText(),date:this.getDateTime(),dateCreated:this.dateCreated.getTime(),dateCompleted:this.getDateCompletedTime(),priority:this._getPriority()||void 0,isComplete:this.isComplete()||void 0,isFlagged:this.isFlagged()||void 0,isCollapsed:this.isCollapsed()||void 0,allDayDate:this.allDayDate||void 0,isArchived:this.isArchived()||void 0,isDeleted:void 0,version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return data.items=this.getItemsArrayForSave(),data},save:function saveFn(changes,saveFlags){try{g.PAssert(1195,void 0!==saveFlags,"Must specify saveFlags for the changes that are being saved")}catch(PERR){g.reportError(PERR)}if(changes){var existingItem=d.getItem(this.id);existingItem||changes.id?(changes.items&&(changes.items=this.getItemsArrayForSave()),changes.date&&!changes.allDayDate&&(changes.allDayDate=this.allDayDate||void 0),changes.text&&g.fireCustomEvent("itemTextChanged",{item:this,force:saveFlags===SaveFlag.None})):changes=this.getFullSaveData()}else changes=this.getFullSaveData();d.saveChanges(this,changes,saveFlags)},toggleCollapsed:function toggleCollapsedFn(){function toggleFunc(){tracker.performAction(TrackerType.Update,{itemID:self.id,field:"isCollapsed",newValue:!self.isCollapsed(),oldValue:self.isCollapsed()}),self.isCollapsed(!self.isCollapsed()),self.save({isCollapsed:self.isCollapsed()},SaveFlag.Text)}if(!(this.items().length<=0)){var isCollapsed=this.isCollapsed(),self=this,element=g.firstChildTag(this.getElement(),"ul");isCollapsed?(toggleFunc(),g.animateTransform(element,{time:200,delay:0,transform:"scale(1, 1) translate3d(0,0,0)",clearTransform:!0,origin:"50% 0"})):g.animateTransform(element,{time:200,transform:"scale(1, 0)",origin:"50% 0",onComplete:function onCompleteFn(){toggleFunc()}})}},highlight:function highlightFn(){var self=this;this.highlightTimeout?(this.isHighlighted(!1),clearTimeout(this.highlightTimeout),this.highlightTimeout=0,setTimeout(function(){self.isHighlighted(!0)},0)):this.isHighlighted(!0),this.highlightTimeout=setTimeout(function(){self.isHighlighted(!1)},2e3)},getElement:function getElementFn(paneID){return void 0===paneID&&(paneID=g.focusedPaneID),this.elements[paneID]},getSpan:function getSpanFn(paneID){var ele=this.getElement(paneID);return ele?ele.firstElementChild:void 0},getOutlineElement:function getOutlineElementFn(paneID){return void 0===paneID&&(paneID=g.focusedPaneID),this.outlineElements[paneID]},removeChild:function removeChildFn(child){var removedIndex;if(child.isArchived()){try{g.PAssert(1200,this.hasArchivedChildren(),"For a child to be archived, this item must have valid archived children")}catch(PERR){g.reportError(PERR)}this.hasArchivedChildren()&&(removedIndex=this.archivedItems(!0).remove(child),d.removeItem(this,removedIndex,child,!0),this.archivedItems().valueHasMutated())}else removedIndex=this.items().remove(child),d.removeItem(this,removedIndex,child,!1),this.items.valueHasMutated();return removedIndex},removeChildAtIndex:function removeChildAtIndexFn(index){try{g.PAssert(1201,!this.items()[index].isArchived())}catch(PERR){g.reportError(PERR)}var removed=this.items().removeAt(index);return d.removeItem(this,index,removed,!1),this.items.valueHasMutated(),removed},archiveChild:function archiveChildFn(child){var retVal=!1;if(!child.isArchived()){tracker.beginAction(),child.isArchived(!0),this.archivedItems().push(child);var removedIndex=this.items().remove(child);d.archiveItem(this,removedIndex,child),this.items.valueHasMutated(),tracker.endAction(),retVal=!0}return retVal},unarchiveChild:function unarchiveChildFn(child){var retVal=!1;if(child.isArchived()){tracker.beginAction();try{g.PAssert(1202,child.isArchived(),"Child must be archived to be unarchived")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1203,this.hasArchivedChildren(),"Parent must have archived children to unarchive a child")}catch(PERR){g.reportError(PERR)}child.isArchived(!1);var removedIndex=this.archivedItems(!0).remove(child);this.items.push(child),d.unarchiveItem(this,removedIndex,child),this.archivedItems().valueHasMutated(),tracker.endAction(),retVal=!0}return retVal},_moveChildrenHelper:function _moveChildrenHelperFn(params){var newParent=params.newParent,index=params.index,isArchived=params.isArchived;try{g.PAssert(1204,void 0!==newParent&&void 0!==isArchived,"_moveChildrenHelper is missing parameters")}catch(PERR){g.reportError(PERR)}var oldItems=isArchived?this.archivedItems():this.items,children=oldItems();if(children.length>0){var newItems=isArchived?newParent.archivedItems():newParent.items;!isArchived&&(isNaN(index)||0>index)&&(index=newItems().length);for(var i=0;children.length>0;){try{g.PAssert(1205,children[i]!=newParent)}catch(PERR){g.reportError(PERR)}var id=children[0];children[0].moveTo({parent:newParent,index:index+i,shouldBeArchived:isArchived,underlying:!0}),tracker.performAction(TrackerType.Move,{itemID:id,oldParent:this.id,oldPosition:i,newParent:newParent.id,newPosition:index+i}),i++}oldItems.valueHasMutated(),newItems.valueHasMutated()}},moveChildren:function moveChildrenFn(newParent,index){try{g.PAssert(1206,this.id!==newParent.id)}catch(PERR){g.reportError(PERR)}if(newParent.parent()===this){var oldIndex=this.removeChild(newParent);tracker.performAction(TrackerType.Delete,{itemID:newParent.id,parent:this.id,position:oldIndex})}this._moveChildrenHelper({newParent:newParent,index:index,isArchived:!1}),this._moveChildrenHelper({newParent:newParent,index:index,isArchived:!0})},deleteSelf:function deleteSelfFn(){this.parent().deleteChild(this),this.parent(void 0)},deleteChild:function deleteChildFn(child,newParent,newIndex){if(tracker.beginAction(),child.hasChildren()||child.hasArchivedChildren())if(newParent)child.moveChildren(newParent,newIndex);else for(var childItems=child.items(),i=childItems.length-1;i>=0;i--)child.deleteChild(childItems[i]);if(!child.isDeleted){var oldIndex=this.removeChild(child);tracker.performAction(TrackerType.Delete,{itemID:child.id,parent:this.id,position:oldIndex}),d.deleteItem(child)}g.timeline.notifyStateChanged(child),tracker.endAction()},replaceChild:function replaceChildFn(oldChild,newChild){var index=oldChild.getIndex();this.items().removeAt(index),tracker.performAction(TrackerType.Delete,{itemID:oldChild.id,parent:this.id,position:index}),d.deleteItem(oldChild),newChild.moveTo({parent:this,index:index}),d.removeItem(this,index+1,oldChild,!1),oldChild.moveChildren(newChild,newChild.numChildren());var newChildOldParentID=newChild.parent().id;if(newChildOldParentID!==this.id){var newChildOldIndex=newChild.parent().items().remove(newChild);tracker.performAction(TrackerType.Move,{itemID:newChild.id,oldParent:newChildOldParentID,oldPosition:newChildOldIndex,newParent:this.id,newPosition:index})}this.items.valueHasMutated()},getChild:function getChildFn(index){try{g.PAssert(1207,index<this.items().length)}catch(PERR){g.reportError(PERR)}return this.items()[index]},getFirstChild:function getFirstChildFn(){return this.hasChildren()?this.items()[0]:void 0},isFirstChild:function isFirstChildFn(){return this.parent()?this.parent().getFirstChild()===this:!1},getLastChild:function getLastChildFn(){return this.hasChildren()?this.items()[this.items().length-1]:void 0},isLastChild:function isLastChildFn(){return this.parent()?this.parent().getLastChild()===this:!1},getChildIndex:function getChildIndexFn(child){return this.getIndexOf(child.id,child.isArchived())},getIndexOf:function getIndexOfFn(id,isArchived){id.id&&(id=id.id);var index=-1,arr;if(isArchived?this.hasArchivedChildren()&&(arr=this.archivedItems(!0)):arr=this.items(),arr)for(var i=0;i<arr.length;++i)if(arr[i].id===id){index=i;break}return index},getRemoteIndexOf:function getRemoteIndexOfFn(item,isArchived){var remoteList=gdata.getItemList(this.data,isArchived),index=-1;return remoteList&&(index=remoteList.indexOf(item)),index},getIndex:function getIndexFn(){return this.parent().getChildIndex(this)},hasChildren:function hasChildrenFn(){return this.items().length>0},numChildren:function numChildrenFn(){return this.items().length},canZoom:function canZoomFn(){return this.numChildren()>0||this.getParsedText().length>0},parents:function parentsFn(){for(var parents=[],parent=this;parent;)parents.splice(0,0,parent),parent=parent.parent();return parents},getSiblings:function getSiblingsFn(startIndex){startIndex=startIndex||0;var arr=[];if(this.parent())for(var items=this.parent().items(),i=0,_l=items.length;_l>i;i++)items[i]!==this&&arr.push(items[i]);return arr},outline:function outlineFn(context){if(context)for(var i=context.$parents.length-1;i>0;i--)if(context.$parents[i]instanceof g.VMOutline)return context.$parents[i];return g.focusedPane.outline}},g.extend(VMLI.prototype,VMLI_TapHandlers),g.extend(VMLI.prototype,VMLI_Text),g.extend(VMLI.prototype,VMLI_Drive(VMLI)),VMLI}),define("tracker",["globals","platform","data","gdata","VMLI"],function(g,platform,d,gdata,VMLI){function getNextGroupID(){return self.groupID+1}function useNextGroupID(){return++self.groupID}function getCurrentGroup(){return self.groups[self.cursor]}function getCurrentAction(){return self.groups[self.cursor].events[self.groups[self.cursor].events.length-1]}function handleGroupTrimmed(group){for(var i=0;i<group.events.length;++i){var action=group.events[i];switch(action.type){case TrackerType.Insert:break;case TrackerType.Remove:break;case TrackerType.Create:break;case TrackerType.Delete:break;case TrackerType.Move:break;case TrackerType.Update:break;case TrackerType.Format:break;case TrackerType.Zoom:break;case TrackerType.UIAction:break;default:try{g.PAssert(1210,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}}}function pushGroup(){var id=useNextGroupID();return self.groups.push({id:id,events:[],persisted:!1}),self.cursor<MaxGroups-1&&self.cursor++,self.groups.length>MaxGroups&&handleGroupTrimmed(self.groups.shift()),id}function doAction(type,data){var group=getCurrentGroup();try{g.PAssert(1211,group,"Expected group to exist")}catch(PERR){g.reportError(PERR)}var action={type:type,data:data};switch(type){case TrackerType.Insert:action.cb={undo:undoInsert,redo:redoInsert};break;case TrackerType.Remove:action.cb={undo:undoRemove,redo:redoRemove};break;case TrackerType.Create:action.cb={undo:undoCreate,redo:redoCreate};break;case TrackerType.Delete:action.cb={undo:undoDelete,redo:redoDelete};break;case TrackerType.Move:action.cb={undo:undoMove,redo:redoMove};break;case TrackerType.Update:action.cb={undo:undoUpdate,redo:redoUpdate};break;case TrackerType.Format:action.cb={undo:undoFormat,redo:redoFormat};break;case TrackerType.Zoom:action.cb={undo:undoZoom,redo:redoZoom};break;case TrackerType.UIAction:action.cb={undo:undoUIAction,redo:redoUIAction};break;default:try{g.PAssert(1212,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}group.events.push(action)}function doExternalAction(type,data){}function mergeAction(type,data){log("Tracker Action Merged: ",type,data);var action=getCurrentAction();try{g.PAssert(1213,action,"Expected action to exist")}catch(PERR){g.reportError(PERR)}switch(type){case TrackerType.Insert:break;case TrackerType.Remove:break;case TrackerType.Create:break;case TrackerType.Delete:break;case TrackerType.Move:break;case TrackerType.Update:break;case TrackerType.Format:try{g.PAssert(1214,!1,"Formats cannot be merged")}catch(PERR){g.reportError(PERR)}break;case TrackerType.Zoom:try{g.PAssert(1215,!1,"Zooms cannot be merged")}catch(PERR){g.reportError(PERR)}break;case TrackerType.UIAction:try{g.PAssert(1216,!1,"UIActions cannot be merged")}catch(PERR){g.reportError(PERR)}break;default:try{g.PAssert(1217,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}}function canMerge(type){var shouldMerge=!1,group=getCurrentGroup();return group&&group.events.length>0&&(group.events[group.events.length-1].type===type?type===TrackerType.Insert&&(shouldMerge=!0):shouldMerge=!1),shouldMerge}function canCombine(type,groupID){var group=getCurrentGroup();return group&&(group.id===groupID||0===group.events.length)}function undoInsert(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(1218,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),startIndex=0;"﻿"==oldText[0]&&(startIndex=1);var newText=oldText.slice(startIndex,entry.position)+oldText.slice(entry.position+entry.text.length);model.setText(newText,!0),g.selectChildren(model,entry.position,0)}}function redoInsert(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(1219,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),newText=oldText.slice(0,entry.position)+entry.text+oldText.slice(entry.position);0===newText.length&&(newText="﻿"),model.setText(newText,!0),g.selectChildren(model,entry.position,entry.text.length)}}function undoRemove(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(1220,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),startIndex=0;"﻿"==oldText[0]&&(startIndex=1);var newText=oldText.slice(startIndex,entry.position)+entry.text+oldText.slice(entry.position);model.setText(newText,!0),g.selectChildren(model,entry.position,entry.text.length)}}function redoRemove(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(1221,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),newText=oldText.slice(0,entry.position)+oldText.slice(entry.position+entry.text.length);0===newText.length&&(newText="﻿"),model.setText(newText,!0),g.selectChildren(model,entry.position,0)}}function undoCreate(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(1222,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var removedChild=parentModel.removeChildAtIndex(entry.position);try{g.PAssert(1223,removedChild.id===entry.itemID,"Expected data to match removed child: ",removedChild,entry)}catch(PERR){g.reportError(PERR)}removedChild.parent(void 0),d.deleteItem(removedChild);var selectionChild=parentModel;entry.position>0&&(selectionChild=parentModel.getChild(entry.position-1)),g.selectChildren(selectionChild,selectionChild.getParsedText().length,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function redoCreate(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(1224,parentModel,"Expected parent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newChild=d.getModel(entry.itemID);try{g.PAssert(1225,newChild,"Expected child model to exist: ",entry)}catch(PERR){g.reportError(PERR)}d.undeleteItem(newChild),parentModel.items.splice(entry.position,0,newChild),newChild.parent(parentModel),g.selectChildren(newChild,0,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function undoDelete(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(1227,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var childModel=d.getModel(entry.itemID);try{g.PAssert(1228,childModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}d.undeleteItem(childModel),parentModel.items.splice(entry.position,0,childModel),childModel.parent(parentModel),g.selectChildren(childModel,0,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function redoDelete(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(1230,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var removedChild=parentModel.removeChildAtIndex(entry.position);try{g.PAssert(1231,removedChild.id===entry.itemID,"Expected data to match removed child: ",removedChild,entry)}catch(PERR){g.reportError(PERR)}removedChild.parent(void 0),d.deleteItem(removedChild);var selectionChild=parentModel;entry.position>0&&(selectionChild=parentModel.getChild(entry.position-1)),g.selectChildren(selectionChild,selectionChild.getParsedText().length,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function undoMove(data){for(var i=0;i<data.length;++i){var entry=data[i],oldParent=d.getModel(entry.oldParent);try{g.PAssert(1232,oldParent,"Expected oldParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newParent=d.getModel(entry.newParent);try{g.PAssert(1233,newParent,"Expected newParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var child=newParent.removeChildAtIndex(entry.newPosition);try{g.PAssert(1234,child.id===entry.itemID,"Expected data to match child: ",child,entry)}catch(PERR){g.reportError(PERR)}child.parent(oldParent),oldParent.items.splice(entry.oldPosition,0,child),g.selectChildren(child,0,0),newParent.save({items:newParent.getItemsArrayForSave()},SaveFlag.None),oldParent.save({items:oldParent.getItemsArrayForSave()},SaveFlag.None)}}function redoMove(data){for(var i=0;i<data.length;++i){var entry=data[i],oldParent=d.getModel(entry.oldParent);try{g.PAssert(1235,oldParent,"Expected oldParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newParent=d.getModel(entry.newParent);try{g.PAssert(1236,newParent,"Expected newParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var child=oldParent.removeChildAtIndex(entry.oldPosition);try{g.PAssert(1237,child.id===entry.itemID)}catch(PERR){g.reportError(PERR)}child.parent(newParent),newParent.items.splice(entry.newPosition,0,child),g.selectChildren(child,0,0),newParent.save({items:newParent.getItemsArrayForSave()},SaveFlag.None),oldParent.save({items:oldParent.getItemsArrayForSave()},SaveFlag.None)}}function undoUpdate(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(1238,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1239,item[entry.field],"Expected field to exist: ",entry)}catch(PERR){g.reportError(PERR)}item[entry.field](entry.oldValue)}}function redoUpdate(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(1240,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1241,item[entry.field],"Expected field to exist: ",entry)}catch(PERR){g.reportError(PERR)}item[entry.field](entry.newValue)}}function undoFormat(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(1242,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}}}function redoFormat(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(1243,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}}}function undoZoom(data){var entry=data[0],oldItem=d.getModel(entry.oldItemID);try{g.PAssert(1244,oldItem,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}if(entry.zoomIn)oldItem.zoomOut(entry.time);else if(entry.zoomOut)oldItem.zoomin({time:entry.time});else try{g.PAssert(1245,!1,"Zoom action must define either zoomIn or zoomOut")}catch(PERR){g.reportError(PERR)}}function redoZoom(data){var entry=data[0],item=d.getModel(entry.itemID);try{g.PAssert(1246,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}if(entry.zoomIn)item.zoomin({time:entry.time});else if(entry.zoomOut)item.zoomOut(entry.time);else try{g.PAssert(1247,!1,"Zoom action must define either zoomIn or zoomOut")}catch(PERR){g.reportError(PERR)}}function undoUIAction(data){var entry=data[0];switch(entry.type){case TrackerUIAction.RemovePane:break;case TrackerUIAction.SwitchPaneMode:break;default:try{g.PAssert(1248,!1,"Invalid UIAction")}catch(PERR){g.reportError(PERR)}}}function redoUIAction(data){}function isActionFromLoad(){return!g.vmMain.isLoaded||g.isLoadingRemote}function processStateChangedSelection(stateChanged){try{g.PAssert(1256,!self.undoRedoActive)}catch(PERR){g.reportError(PERR)}for(var finalModel=void 0,finalPosition=0,finalLength=0,i=0;i<stateChanged.length;++i){var entry=stateChanged[i],data=entry.data,model=d.getModel(data.itemID);try{g.PAssert(1257,model,"Expected model to exist: ",data)}catch(PERR){g.reportError(PERR)}switch(entry.type){case TrackerType.Insert:finalModel=model,finalPosition=data.position,finalLength=data.text.length;break;case TrackerType.Remove:finalModel=model,finalPosition=data.position,finalLength=0;break;case TrackerType.SetText:model.deleteTimeout||(finalModel=model,finalPosition=data.position,finalLength=0);
break;case TrackerType.Create:finalModel=model,finalPosition=0,finalLength=0;break;case TrackerType.Delete:var selectionChild=d.getModel(data.previous);finalModel=selectionChild,finalPosition=selectionChild.getParsedText().length,finalLength=0}}finalModel&&(g.selectChildren(finalModel,finalPosition,finalLength),g.scrollIntoView(finalModel.getSpan(),200)),externalStateChanged=[]}function getOrderedGroups(){return self.groups.slice(self.cursor).concat(self.groups.slice(0,self.cursor))}function updateExternalID(oldID,newID){Assert(!1,"This should never be called")}var self={disabled:!1,allowOfflineUndo:!1,cursor:-1,groupID:0,groups:[],externalUndoRedo:!1,undoRedoActive:!1,canRedo:!1,canUndo:!1};window.TrackerType={Insert:1,Remove:2,SetText:3,Create:4,Delete:5,Move:6,Update:7,Format:8,Zoom:9,UIAction:10,Misc:11,Mobile:12},window.TrackerMisc={ToggleOutline:1,RightClick:2,CloseMessage:3,ChangeDate:4,AddContact:5,DropItem:6,SyncContacts:7,OpenContact:8,SearchChanged:10,ToggleSidebar:11,AddDocument:12,OpenDocument:13,OpenDocSharing:14,Copy:15,Paste:16,OpenImport:17,OpenExport:18,UndoRedo:19},window.TrackerMiscMobile={OpenKeyboard:1,CloseKeyboard:2,PaneAgenda:3,PaneNormal:4,OpenAutocomplete:5,CloseAutocomplete:6,AtButton:7,OpenMultiselect:8,CloseMultiselect:9},window.TrackerUIAction={AddPane:1,RemovePane:2,SwitchPaneMode:3};var MaxGroups=75,performingActions=!1;self.performActions=function performActionsFn(actions){try{g.PAssert(1249,!self.disabled||g.intro)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1250,!performingActions)}catch(PERR){g.reportError(PERR)}if(performingActions=!0,actions&&actions.length>0){if(!self.disabled){var groupID=void 0;self.cursor!=self.groups.length-1?(self.groups.splice(self.cursor+1,self.groups.length-(self.cursor+1)),groupID=pushGroup()):groupID=getNextGroupID()}for(var i=0;i<actions.length;++i){var action=actions[i];g.intro&&g.intro.onAction(action),self.disabled||(canCombine(action.type,groupID)?canMerge(action.type)?mergeAction(action.type,action.data):doAction(action.type,action.data):(groupID=pushGroup(),doAction(action.type,action.data)))}}performingActions=!1};var currentAction=[],aggregateActions=0;self.beginAction=function beginActionFn(){try{g.PAssert(1251,!performingActions)}catch(PERR){g.reportError(PERR)}if(0===aggregateActions){gdata.beginAction();try{g.PAssert(1252,0===currentAction.length,"Current actions should always be empty when starting a new action")}catch(PERR){g.reportError(PERR)}}aggregateActions++},self.performAction=function performActionFn(type,data){try{g.PAssert(1253,!performingActions)}catch(PERR){g.reportError(PERR)}var isFromLoad=isActionFromLoad();self.disabled?g.intro&&(isFromLoad||self.performActions([{type:type,data:[data]}])):aggregateActions?currentAction.push({type:type,data:[data]}):self.performActions([{type:type,data:[data]}])},self.endAction=function endActionFn(){try{g.PAssert(1254,!performingActions)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1255,0!==aggregateActions,"Must have called beginAction before calling endAction")}catch(PERR){g.reportError(PERR)}1===aggregateActions&&((!self.disabled||g.intro)&&self.performActions(currentAction),currentAction.length=0,gdata.endAction()),aggregateActions--};var externalStateChanged=[];return self.notifyStateChangedFromUndoRedo=function notifyStateChangedFromUndoRedoFn(type,data){try{g.PAssert(1258,self.undoRedoActive)}catch(PERR){g.reportError(PERR)}externalStateChanged.push({type:type,data:data})},self.undoAction=function undoActionFn(){g.vmMain.isOnline()||self.allowOfflineUndo||g.messageQueue.pushMessage(MessageID.OfflineUndo),self.undoRedoActive=!0;try{g.PAssert(1259,!performingActions)}catch(PERR){g.reportError(PERR)}if(!self.disabled&&self.allowOfflineUndo){if(self.cursor>=0)for(var group=self.groups[self.cursor--],i=group.events.length-1;i>=0;i--){var action=group.events[i];action.cb.undo(action.data)}}else if(self.canUndo){try{g.PAssert(1260,self.externalUndoRedo)}catch(PERR){g.reportError(PERR)}gdata.undoAction()}self.undoRedoActive=!1,processStateChangedSelection(externalStateChanged),self.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{undo:!0}]})},self.redoAction=function redoActionFn(){g.vmMain.isOnline()||self.allowOfflineUndo||g.messageQueue.pushMessage(MessageID.OfflineUndo),self.undoRedoActive=!0;try{g.PAssert(1261,!performingActions)}catch(PERR){g.reportError(PERR)}if(!self.disabled&&self.allowOfflineUndo){if(self.cursor>=-1&&self.cursor<self.groups.length-1)for(var group=self.groups[++self.cursor],i=0;i<group.events.length;++i){var action=group.events[i];action.cb.redo(action.data)}}else if(self.canRedo){try{g.PAssert(1262,self.externalUndoRedo)}catch(PERR){g.reportError(PERR)}gdata.redoAction()}self.undoRedoActive=!1,processStateChangedSelection(externalStateChanged),self.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{redo:!0}]})},self.miscAction=function miscActionFn(e){g.intro&&g.intro.onAction(e)},self.resetState=function resetStateFn(){performingActions=!1,externalStateChanged=[],currentAction=[],self.undoRedoActive=!1,self.cursor=-1,self.groupID=0,self.groups=[]},self.stringifyGroups=function stringifyGroupsFn(){var groups=getOrderedGroups();return"Tracker: "+groups.length},self.stateChangeForUndoRedo=function stateChangeForUndoRedoFn(event){self.externalUndoRedo=!0,self.disabled=!0,self.canRedo=event.canRedo,self.canUndo=event.canUndo},gdata.registerForUndoRedoStateChange(self),self}),define("edit",["ko","globals","platform","android","VMLI","tracker"],function(ko,g,platform,android,VMLI,tracker){function updateSelection(){if(android.isEnabled()){if(!android.getCurrentVMLI())return!0;selection={},range=void 0,rangeStartContainer=rangeEndContainer=android.getCurrentSpan(),rangeStart=android.getSelectionStart(),rangeEnd=android.getSelectionEnd()}else{if(selection=g.getSelectionInfo(),!selection||0===selection.rangeCount)return!0;range=selection.selection.getRangeAt(0),rangeStartContainer=range.startContainer,rangeEndContainer=range.endContainer,rangeStart=range.startOffset,rangeEnd=range.endOffset}}var self={},selection,range,rangeStartContainer,rangeEndContainer,rangeStart,rangeEnd,keyCodesDown=[KeyCode.Tab,KeyCode.BackSpace,KeyCode.Delete,KeyCode.Period],keyCodesArrows=[KeyCode.UpArrow,KeyCode.DownArrow,KeyCode.LeftArrow,KeyCode.RightArrow,KeyCode.Home,KeyCode.End],textSaveInfo={},tempInput,lastKeypress,lastEditSelect=0,StringNewLine=String.fromCharCode(10);return self.updateAutocomplete=function updateAutocompleteFn(e){var fromArrows=e.normCode&&keyCodesArrows.indexOf(e.normCode)>=0;if(g.autocomplete)if(android.isEnabled()){var span=android.getCurrentSpan();span?g.autocomplete.update({item:android.getCurrentVMLI(),start:android.getSelectionStart(),fromArrows:fromArrows}):g.autocomplete.hide()}else{var selection=g.getSelectionInfo();if(selection&&selection.selection.rangeCount>0){var range=selection.selection.getRangeAt(0),startLI=g.getLIParent(range.startContainer),endLI=g.getLIParent(range.endContainer);if(startLI&&startLI===endLI&&range.startOffset===range.endOffset&&"UL"!==range.startContainer.tagName){var item=ko.dataFor(startLI),span=item.getSpan();try{g.PAssert(1263,span,"Items should always have a valid span if we are performing updates in a VMPane")}catch(PERR){g.reportError(PERR)}if(span){var offset=g.getSelectOffsetsInSpan(item,span,range);offset.start===offset.end&&g.autocomplete.update({item:item,start:offset.start,fromArrows:fromArrows})}else g.autocomplete.hide()}}}},self.onTextInput=function onTextInputFn(e){if(textSaveInfo.item&&textSaveInfo.waitAutocorrect&&" "!=e.data&&e.data!=StringNewLine){var item=textSaveInfo.item,span="enter"==textSaveInfo.waitAutocorrect?tempInput:item.getSpan(),s=item.getParsedText();updateSelection();var offsets=g.getSelectOffsetsInSpan(item,span,range),oldLength=offsets.endText-offsets.startText,insertText="space"==textSaveInfo.waitAutocorrect?" ":"";textSaveInfo.text=s.substr(0,offsets.startText)+e.data+insertText+s.substr(offsets.endText),textSaveInfo.start+=e.data.length-oldLength,textSaveInfo.waitAutocorrect=void 0}},self.keyup=function keyupFn(element,e){textSaveInfo.item&&(tracker.beginAction(),void 0!=textSaveInfo.text&&textSaveInfo.item.setText(textSaveInfo.text,!0),textSaveInfo.nextItem?g.selectChildren(textSaveInfo.nextItem,0,0):g.selectChildren(textSaveInfo.item,textSaveInfo.start,0),self.updateAutocomplete(e),tracker.endAction()),textSaveInfo.item=void 0,textSaveInfo.nextItem=void 0,textSaveInfo.text=void 0,textSaveInfo.start=void 0,textSaveInfo.waitAutocorrect=void 0,(e.normCode===KeyCode.Enter||e.normCode===KeyCode.PageUp||e.normCode===KeyCode.PageDown)&&self.scrollTextIntoView();try{g.PAssert(1264,e.stopImmediatePropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopImmediatePropagation&&e.stopImmediatePropagation();try{g.PAssert(1265,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),e.handled?!0:void 0},self.scrollTextIntoView=function scrollTextIntoViewFn(direction,time){try{g.PAssert(1266,0!==direction,"Cannot have a null scroll direction")}catch(PERR){g.reportError(PERR)}if(isNaN(time)&&(time=200),!g.isScrolling&&(updateSelection(),rangeEndContainer&&"UL"!==rangeEndContainer.tagName&&"LI"!==rangeEndContainer.tagName)){var scrollSpan=g.getSpanParent(rangeEndContainer),currentItem=ko.dataFor(scrollSpan);if(currentItem){var item;0>direction?item=g.getPreviousItem(currentItem,g.focusedPane)||currentItem:direction>0&&(item=g.getNextItem(currentItem,g.focusedPane)||currentItem);var targetSpan=item?item.getSpan():scrollSpan;g.scrollIntoView(targetSpan,time)}}},self.handleSelectAll=function handleSelectAllFn(pane,e){updateSelection();var firstItem=g.getFirstPaneItem(pane),lastItem=g.getLastPaneItem(pane);return g.selectMultiline(firstItem.getSpan(),0,lastItem.getSpan(),lastItem.getParsedText().length),!1},self.handleArrows=function handleArrowsFn(element,e){if(g.restrictSelectionToText(),updateSelection(),platform.mac&&e.metaKey&&e.normCode===KeyCode.UpArrow||!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.Home){var firstItem=g.getFirstPaneItem(g.focusedPane);return e.shiftKey?g.selectMultiline(firstItem.getSpan(),0,rangeEndContainer,rangeEnd):g.selectChildren(firstItem,0,0),g.scrollIntoView(firstItem.getSpan()),!1}if(platform.mac&&e.metaKey&&e.normCode===KeyCode.DownArrow||!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.End){var lastItem=g.getLastPaneItem(g.focusedPane);return e.shiftKey?g.selectMultiline(rangeStartContainer,rangeStart,lastItem.getSpan(),lastItem.getParsedText().length):g.selectChildren(lastItem,lastItem.getParsedText().length,0),g.scrollIntoView(lastItem.getSpan()),!1}if(!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.UpArrow&&rangeStartContainer){var item=ko.dataFor(g.getSpanParent(rangeStartContainer)),focusItem;if(item.parent()===g.focusedItem){if(!item.isFirstChild()){try{g.PAssert(1268,item.getIndex()>0,"Should never hit this with the first item in the list")}catch(PERR){g.reportError(PERR)}focusItem=item.parent().getChild(item.getIndex()-1)}}else{for(;item.parent()!==g.focusedItem;)item=item.parent();focusItem=item}return void 0!==focusItem&&(g.selectChildren(focusItem,focusItem.getParsedText().length,0),g.scrollIntoView(focusItem.getSpan())),!1}if(!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.DownArrow&&rangeEndContainer){var item=ko.dataFor(g.getSpanParent(rangeEndContainer)),focusItem;if(item.parent()===g.focusedItem)item.isLastChild()||(focusItem=item.parent().getChild(item.getIndex()+1));else{for(;item.parent()!==g.focusedItem;)item=item.parent();item.isLastChild()||(focusItem=item.parent().getChild(item.getIndex()+1))}return void 0!==focusItem&&(g.selectChildren(focusItem,focusItem.getParsedText().length,0),g.scrollIntoView(focusItem.getSpan())),!1}if(void 0===rangeStartContainer||void 0===rangeEndContainer)return!0;if(e.normCode===KeyCode.LeftArrow||e.normCode===KeyCode.RightArrow){updateSelection();var li=g.getLIParent(rangeStartContainer),li2=g.getLIParent(rangeEndContainer);if(li==li2){var item=ko.dataFor(li);if(0===item.getParsedText().length){if(e.normCode===KeyCode.LeftArrow){var prev=g.getPreviousItem(item,g.focusedPane);prev&&g.selectChildren(prev,prev.getParsedText().length,0)}else if(e.normCode===KeyCode.RightArrow){var next=g.getNextItem(item,g.focusedPane);next&&g.selectChildren(next,0,0)}return!1}}}else if(platform.ie&&(e.normCode===KeyCode.UpArrow||e.normCode===KeyCode.DownArrow)){if(updateSelection(),e.normCode===KeyCode.UpArrow)var oldItem=ko.dataFor(g.getLIParent(rangeStartContainer)),newItem=g.getPreviousItem(oldItem,g.focusedPane);else if(e.normCode===KeyCode.DownArrow)var oldItem=ko.dataFor(g.getLIParent(rangeEndContainer)),newItem=g.getNextItem(oldItem,g.focusedPane);if(newItem){if(rangeStartContainer===rangeEndContainer)var selOffset=g.getSelectOffsetsInSpan(void 0,g.getSpanParent(rangeEndContainer),range),offset=Math.min(selOffset.start,newItem.getParsedText().length);else var offset=newItem.getParsedText().length;return g.selectChildren(newItem,offset,0),g.scrollIntoView(newItem.getSpan(),0),!1}}return self.updateAutocomplete(e),!0},self.keydown=function keydownFn(element,e){var ret=!0;if(keyCodesDown.indexOf(e.normCode)>=0)ret=self.keypress(element,e,!0);else if(keyCodesArrows.indexOf(e.normCode)>=0)ret=self.handleArrows(element,e);else if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){if(e.normCode===KeyCode.A)return self.handleSelectAll(element,e);if(e.normCode===KeyCode.Y||e.normCode===KeyCode.Z)return self.keypress(element,e,!0)}switch(e.normCode){case KeyCode.Enter:(!platform.mobile||android.isEnabled())&&self.scrollTextIntoView();break;case KeyCode.UpArrow:platform.mac&&!e.metaKey&&self.scrollTextIntoView(-1,10);break;case KeyCode.DownArrow:platform.mac&&!e.metaKey&&self.scrollTextIntoView(1,10);break;default:var validCharacter=e.normCode>=32&&e.normCode<=90&&e.normCode!==KeyCode.Period||e.normCode===KeyCode.Enter;!validCharacter||platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey||self.scrollTextIntoView()}return ret},self.keypress=function keypressFn(element,e,fromKeydown){var keyCodes=[KeyCode.Enter];try{g.PAssert(1269,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopPropagation&&e.stopPropagation();var returnValue=!0,validCharacter=e.normCode>=32&&e.normCode!==KeyCode.Period||keyCodes.indexOf(e.normCode)>=0,skipCharacter=platform.mobile&&e.normCode===KeyCode.Delete||0===e.which;if(!skipCharacter&&(fromKeydown||validCharacter)){if(updateSelection(),!selection&&!android.isEnabled())return!0;if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){if(e.normCode===KeyCode.Y||e.normCode===KeyCode.Z){e.normCode!==KeyCode.Z||e.shiftKey?(tracker.redoAction(),g.sendEvent("Hotkey","Redo")):(tracker.undoAction(),g.sendEvent("Hotkey","Undo")),e.handled=!0;try{g.PAssert(1270,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!0}var keyChar=String.fromCharCode(e.normCode);switch(keyChar){case"c":case"C":return e.handled=!0,!0;case"v":case"V":return e.handled=!0,!0;case"r":case"R":case"a":case"A":return e.handled=!0,!0}}var item;if("UL"==rangeStartContainer.nodeName){var pane=ko.dataFor(rangeStartContainer);pane instanceof VMLI||(item=pane.addItemToPane("",0),span=item.getSpan(),g.selectChildren(item,0,0))}g.restrictSelectionToText(),updateSelection();try{g.PAssert(1271,android.isEnabled()||"#text"==rangeStartContainer.nodeName||"SPAN"==rangeStartContainer.nodeName,"Expected SPAN, Actual: "+rangeStartContainer.tagName)}catch(PERR){g.reportError(PERR)}var startSpan=g.getSpanParent(rangeStartContainer);try{g.PAssert(1272,android.isEnabled()||"#text"==rangeEndContainer.nodeName||"SPAN"==rangeEndContainer.nodeName,"Expected SPAN, Actual: "+rangeEndContainer.tagName)}catch(PERR){g.reportError(PERR)}var endSpan=g.getSpanParent(rangeEndContainer);if(!startSpan||!endSpan)return e.stopPropagation(),e.preventDefault(),!1;tracker.beginAction(),startSpan!=endSpan&&e.normCode!==KeyCode.Tab&&(returnValue=returnValue&&self.handleMultiselect(e,startSpan,endSpan,range));var specialKeys=[KeyCode.Tab,KeyCode.Enter,KeyCode.BackSpace,KeyCode.Delete];if(returnValue&&specialKeys.indexOf(e.normCode)>=0){var span=g.getSpanParent(selection.node);try{g.PAssert(1273,android.isEnabled()||span&&"SPAN"===span.tagName,"Expected SPAN, Actual: "+span.tagName)}catch(PERR){g.reportError(PERR)}if(span){var treatBackspaceLikeTab=!1;if(e.shiftKey&&e.normCode===KeyCode.BackSpace){var startOffset=g.getSelectOffsetsInSpan(void 0,span,range);0===startOffset.start&&(treatBackspaceLikeTab=!0)}e.normCode===KeyCode.Tab||treatBackspaceLikeTab?returnValue=returnValue&&self.handleTab(e,range):e.normCode===KeyCode.Enter?returnValue=returnValue&&self.handleEnter(e,span,range):e.normCode===KeyCode.BackSpace?(returnValue=returnValue&&self.handleBackspace(e,span,range),textSaveInfo.item||self.updateAutocomplete(e)):e.normCode===KeyCode.Delete&&(returnValue=returnValue&&self.handleDelete(e,span,range))}}var keyCode=e.normCode;e.normCode===KeyCode.Period&&(keyCode=e.shiftKey?KeyCode.RAngle:KeyCode.Delete);var character=String.fromCharCode(keyCode);if(returnValue&&character&&e.normCode!==KeyCode.BackSpace&&e.normCode!==KeyCode.Enter&&!e.ctrlKey){updateSelection();try{g.PAssert(1274,g.getSpanParent(rangeStartContainer)==g.getSpanParent(rangeEndContainer))}catch(PERR){g.reportError(PERR)}var span=g.getSpanParent(selection.node);try{g.PAssert(1275,android.isEnabled()||"SPAN"===span.tagName,"Expected SPAN, Actual: "+span.tagName)}catch(PERR){g.reportError(PERR)}item||(item=g.getItemForElement(span));try{g.PAssert(1276,item,"Must be able to get a valid item from the selected span")}catch(PERR){g.reportError(PERR)}var offsets=g.getSelectOffsetsInSpan(item,span,range),s;s=android.isEnabled()?android.getInputText():item.getParsedText();var onlyInsert=!0,newText=s.substr(0,offsets.startText)+character+s.substr(offsets.endText);if(offsets.startText!==offsets.endText&&(onlyInsert=!1,tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:s.slice(offsets.startText,offsets.endText)})),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:offsets.startText,text:character}),platform.ios)textSaveInfo.text=newText,textSaveInfo.start=offsets.start+1,textSaveInfo.waitAutocorrect=" "==character?"space":void 0,textSaveInfo.item=item,returnValue=!0;else{g.clearSelection(),item.setText(newText,!0),g.selectChildren(item,offsets.start+1,0),returnValue=!1;try{g.PAssert(1277,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.preventDefault&&e.preventDefault(),self.updateAutocomplete(e)}}tracker.endAction()}return lastKeypress=e.normCode,returnValue},self.handleMultiselect=function handleMultiselectFn(e,startSpan,endSpan,range){var arrToDelete=[],levelsDeep=0,returnValue=!0,startLI=startSpan.parentNode,endLI=endSpan.parentNode;try{g.PAssert(1278,"LI"==startLI.tagName,"Expected LI, Actual: ",startLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1279,"LI"==endLI.tagName,"Expected LI, Actual: ",endLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1280,startLI!=endLI)}catch(PERR){g.reportError(PERR)}var startItem=ko.dataFor(startLI),endItem=ko.dataFor(endLI),nextItem=startItem,startOffset=g.getSelectOffsetsInSpan(startItem,startSpan,range),endOffset=g.getSelectOffsetsInSpan(endItem,endSpan,range),fscount=0;do{var nextItemOptions={numLevels:0};nextItem=g.getNextItem(nextItem,g.focusedPane,nextItemOptions),nextItem.parent()===g.focusedPane.item()&&nextItem.isHeader()&&fscount++,levelsDeep+=nextItemOptions.numLevels,(nextItem!==endItem||endOffset.end===endOffset.total)&&arrToDelete.push(nextItem)}while(nextItem!==endItem);var doAction=!0;if(arrToDelete.length>=16&&fscount>=2&&(platform.packagedApp||(doAction=confirm("You have selected a large number of items to delete, please confirm you want to perform this action."))),doAction){var newStartText;if(startOffset.start>0||endOffset.end<endOffset.total){var startText=startItem.getParsedText(),textAdded=endItem.getParsedText().substring(endOffset.endText);newStartText=startText.substring(0,startOffset.startText)+textAdded,tracker.performAction(TrackerType.Remove,{itemID:startItem.id,position:startOffset.startText,text:startText.slice(startOffset.startText)}),tracker.performAction(TrackerType.Insert,{itemID:startItem.id,position:startOffset.startText,text:textAdded}),arrToDelete.indexOf(endItem)<0&&arrToDelete.push(endItem),0===startOffset.start&&startItem.copyProperties(endItem)}else tracker.performAction(TrackerType.Remove,{itemID:startItem.id,position:0,text:startItem.getParsedText()}),newStartText="";if((e.normCode===KeyCode.BackSpace||e.normCode===KeyCode.Delete||e.normCode===KeyCode.Enter)&&(returnValue=!1),endItem.moveChildren(startItem,0),levelsDeep>0){var arrToMove=[],next;next=endLI.children.length>1?endLI.children[1].children[0]:endLI.nextElementSibling;for(var nextChild=next;levelsDeep>0&&nextChild;){for(levelsDeep--;void 0!==nextChild&&null!==nextChild;)arrToMove.push(nextChild),nextChild=nextChild.nextElementSibling;next=next.parentElement.parentElement,nextChild=next.nextElementSibling}if(arrToMove.length>0)for(var firstDelete=startItem,parentToMoveTo=firstDelete.parent(),index=firstDelete.getIndex()+1,i=0;i<arrToMove.length;i++){var item=ko.dataFor(arrToMove[i]),oldParent=item.parent();item.moveTo({parent:parentToMoveTo,index:index});var oldIndex=item.parent().getIndexOf(item);tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:oldParent.id,oldPosition:oldIndex,newParent:parentToMoveTo.id,newPosition:index}),index++}}for(var i=0;i<arrToDelete.length;i++){var item=arrToDelete[i];try{g.PAssert(1281,item,"Item must exist")}catch(PERR){g.reportError(PERR)}item.isDeleted||item.parent().deleteChild(item)}startItem.setText(newStartText,!0),g.selectChildren(startItem,startOffset.start,0)}else returnValue=!1;return returnValue},self.handleTab=function handleTabFn(e,range){if(android.isEnabled())var startItem=android.getCurrentVMLI(),endItem=android.getCurrentVMLI();else{var startSpan=g.getSpanParent(range.startContainer),endSpan=g.getSpanParent(range.endContainer),startOffset=g.getSelectOffsetsInSpan(void 0,startSpan,range),endOffset=g.getSelectOffsetsInSpan(void 0,endSpan,range);try{g.PAssert(1282,"LI"==startSpan.parentNode.tagName,"Expected LI, Actual: ",startSpan.parentNode)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1283,"LI"==endSpan.parentNode.tagName,"Expected LI, Actual: ",endSpan.parentNode)}catch(PERR){g.reportError(PERR)}var startItem=ko.dataFor(startSpan.parentNode),endItem=ko.dataFor(endSpan.parentNode)}var nextItem=startItem,needUpdate={},itemsToTab=[startItem],siblingsToMove=[],parent,newParent,moved={},itemsHighlighted={};if(itemsHighlighted[startItem.id]=!0,startItem!==endItem)do{var nextItemOptions={numLevels:0,ignoreSearch:!0};nextItem=g.getNextItem(nextItem,void 0,nextItemOptions),parent=nextItem.parent(),itemsToTab.push(nextItem),itemsHighlighted[nextItem.id]=!0}while(nextItem!==endItem);var i,condition,increment;if(e.shiftKey)var initial=function(){i=itemsToTab.length-1},condition=function(){return i>=0},increment=function(){i--};else var initial=function(){i=0},condition=function(){return i<itemsToTab.length},increment=function(){i++};for(initial();condition();increment()){var item=itemsToTab[i],parent=item.parent(),index=parent.items().indexOf(item),ok,u;if(e.shiftKey){if(ok=item.parent()!=g.focusedItem){newParent=item.parent().parent();var parentItems=parent.items(),numSiblings=parentItems.length-index-1;for(u=index+1;parentItems[index+1];){var siblingItem=parentItems[index+1];itemsHighlighted[siblingItem.id]||g.hasClass(siblingItem.getElement(),"hidden")?index++:(needUpdate[siblingItem.parent().id]=siblingItem.parent(),needUpdate[item.id]=item,siblingItem.moveTo({parent:item,underlying:!0}),moved[siblingItem.id]=!0,tracker.performAction(TrackerType.Move,{itemID:siblingItem.id,oldParent:parent.id,oldPosition:u,newParent:item.id,newPosition:item.items().length-1})),u++}if(itemsHighlighted[parent.id]>=0&&(!parent.parent()||parent.parent()!=g.focusedItem))continue;var parentIndex=newParent.items().indexOf(parent);needUpdate[item.parent().id]=item.parent(),needUpdate[newParent.id]=newParent,item.moveTo({parent:newParent,index:parentIndex+1,underlying:!0}),moved[item.id]=!0,tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:parent.id,oldPosition:index,newParent:newParent.id,newPosition:parentIndex+1})}}else{if(ok=index>0){for(newParent=parent.items()[index-1];g.hasClass(newParent.getElement(),"hidden");){if(index--,0>=index)return!1;newParent=parent.items()[index-1]}moved[parent.id]||(needUpdate[item.parent().id]=item.parent(),needUpdate[newParent.id]=newParent,item.moveTo({parent:newParent,underlying:!0})),moved[item.id]=!0,tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:parent.id,oldPosition:index,newParent:newParent.id,newPosition:newParent.items().length-1})}else newParent=parent,moved[item.id]=moved[parent.id];for(var moveSiblings=!1,parentMoved=item;parentMoved;){if(moved[parentMoved.id]){moveSiblings=!0;break}parentMoved=parentMoved.parent()}var siblingStartIndex=item.getIndex()+1;if(moveSiblings){var items=item.items(),numMoved=0;for(u=0;u<items.length;u++){var child=items[u];if(!itemsHighlighted[child.id]){if(g.hasClass(child.getElement(),"hidden"))continue;needUpdate[child.parent().id]=child.parent(),needUpdate[item.parent().id]=item.parent();var moveIndex=siblingStartIndex+numMoved;child.moveTo({parent:item.parent(),index:moveIndex,underlying:!0}),moved[child.id]=!0,tracker.performAction(TrackerType.Move,{itemID:child.id,oldParent:item.id,oldPosition:u,newParent:item.parent().id,newPosition:moveIndex}),numMoved++,u--}}}}}for(var itemId in needUpdate)needUpdate[itemId].items.valueHasMutated();if(android.isEnabled())android.updateInputBounds(startItem);else if(startItem||endItem){try{g.PAssert(1284,startItem&&endItem)}catch(PERR){g.reportError(PERR)}g.selectMultiline(startItem.getSpan(),startOffset.start,endItem.getSpan(),endOffset.end)}e.handled=!0;try{g.PAssert(1285,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1},self.handleEnter=function handleEnterFn(e,span,range){var item=g.getItemForElement(span),parent=item.parent(),index=parent.items().indexOf(item),offsets=g.getSelectOffsetsInSpan(item,span,range);android.isEnabled()&&android.finishInput(!0);var text=item.getParsedText(),createText="",item2,addToChild=!1,newParent=parent,useNextItem=!0;if(0===offsets.end&&""!==text)item2=item.isNumList()?new VMLI({text:NumListPrefix},{parent:newParent,forceSave:!0}):new VMLI({text:""},{parent:newParent,forceSave:!0}),index--,useNextItem=!1;else if(offsets.start>=offsets.total){addToChild=!e.shiftKey&&!item.isCollapsed()&&(item.items().length>0||item.isHeader()),addToChild&&(newParent=item);var newText="";item.isNumList()&&(newText=NumListPrefix),item2=new VMLI({text:newText},{parent:newParent,forceSave:!0})}else if(0===offsets.start&&offsets.end===offsets.total)item2=new VMLI({text:""},{parent:newParent,forceSave:!0}),item.setText("",!0),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text});else{var firstText=offsets.start>0?text.substring(0,offsets.startText):"";secondText=offsets.endText<text.length?text.substring(offsets.endText):"",item.isNumList()&&(secondText=NumListPrefix+secondText),item2=new VMLI({text:firstText},{parent:newParent,forceSave:!0}),item.setText(secondText,!0),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.substring(offsets.startText)}),item2.copyProperties(item),index--,useNextItem=!1}item2.parseText(!0),addToChild?(item.insertItem(item2,0),tracker.performAction(TrackerType.Create,{itemID:item2.id,parent:item.id,position:0,text:item2.getParsedText()})):(newParent.insertItem(item2,index+1),tracker.performAction(TrackerType.Create,{itemID:item2.id,parent:newParent.id,position:index+1,text:item2.getParsedText()}));var selectItem=useNextItem?item2:item;try{g.PAssert(1287,selectItem,"Expected another item to exist")}catch(PERR){g.reportError(PERR)}if(platform.ios)return textSaveInfo.start=offsets.start,textSaveInfo.waitAutocorrect="enter",textSaveInfo.item=useNextItem?item:item2,textSaveInfo.nextItem=useNextItem?item2:item,tempInput||(tempInput=g.element("tempInput")),tempInput.innerHTML=textSaveInfo.item.getStyledText(),g.selectMultiline(tempInput,offsets.start,tempInput,offsets.start),!0;if(android.isEnabled()){android.updateInput(selectItem,0);try{g.PAssert(1288,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1}g.selectChildren(selectItem,0,0);try{g.PAssert(1289,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1},self.handleBackspace=function handleBackspaceFn(e,span,range){var item=g.getItemForElement(span),parent=item.parent(),offsets=g.getSelectOffsetsInSpan(item,span,range);android.isEnabled()&&android.finishInput(!0),platform.ie&&(e.preventDefault(),e.stopImmediatePropagation());var text=item.getParsedText(),itemSelSpan=item.getSpan(),newText="",newTextOffset=0;if(0===offsets.startText&&0===offsets.endText||""===text){var prev=g.getPreviousItem(item,g.focusedPane),next=g.getNextItem(item,g.focusedPane);if(prev&&(!prev.isFullscreen()||""===text&&next)){var prevTextLength=prev.getParsedText().length;parent.deleteChild(item,prev,0),text.length>0&&""!==text&&(0===prev.getParsedText().length&&prev.copyProperties(item),prev.setText(prev.getParsedText()+text,!0),tracker.performAction(TrackerType.Insert,{itemID:prev.id,position:prevTextLength,text:text}));var selectItem=prev.isFullscreen()?prev.getFirstChild():prev,selectOffset=prev.isFullscreen()?0:prevTextLength;return g.selectChildren(selectItem,selectOffset,0),!1}return android.isEnabled()&&android.updateInput(item,offsets.startText),!1}if(e.metaKey&&offsets.startText===text.length||0===offsets.startText&&offsets.endText===text.length)tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:item.getParsedText()}),newText="",newTextOffset=0;else if(e.metaKey)newText=text.substring(offsets.startText),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,offsets.startText)}),newTextOffset=0;else if((platform.mac&&e.altKey||!platform.mac&&e.ctrlKey)&&offsets.start===offsets.end){for(var endOfText=text.substring(offsets.startText),seenALetter=!1,isHandled=!1,i=offsets.startText-1;i>=0&&!isHandled;i--)if(seenALetter=seenALetter||" "!==text[i],!(" "==text[i]&&" "==text[i-1]||0!==i&&" "!==text[i]&&"@"!==text[i])){var subIndex=0===i||i===offsets.startText-1?i:i+1;(seenALetter||" "!==text[i])&&(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:subIndex,text:text.slice(subIndex,offsets.startText)}),newText=text.substring(0,subIndex)+endOfText,newTextOffset=subIndex,isHandled=!0)}isHandled||(offsets.startText===text.length?0===offsets.start&&(newText="",tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text})):(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,offsets.startText)}),newText=endOfText),newTextOffset=0)}else if(1===offsets.start&&1===offsets.end&&1===text.length&&""!=text[0])tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:item.getParsedText()}),newText="",newTextOffset=0;else{try{g.PAssert(1292,offsets.start>=0)}catch(PERR){g.reportError(PERR)}if(offsets.start!=offsets.end)tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.slice(offsets.startText,offsets.endText)}),newText=text.substr(0,offsets.startText)+text.substr(offsets.endText),newTextOffset=offsets.start;else{var sub=1;text.length>1&&""==text[offsets.startText-1]&&sub++,newText=text.substr(0,offsets.startText-sub)+text.substr(offsets.startText),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText-sub,text:text.slice(offsets.startText-sub,offsets.startText)}),newTextOffset=offsets.startText-sub
}}return platform.phone&&lastKeypress!==KeyCode.BackSpace?(textSaveInfo.text=newText,textSaveInfo.start=newTextOffset,textSaveInfo.item=item,0===newText.length&&(item.setStyledText(TextSpace+" ",!0),g.selectChildren(item,1,0)),!0):(item.setText(newText,!0),g.selectChildren(item,newTextOffset,0),!1)},self.handleDelete=function handleDeleteFn(e,span,range){var item=ko.dataFor(span.parentNode),offsets=g.getSelectOffsetsInSpan(item,span,range);try{g.PAssert(1293,item)}catch(PERR){g.reportError(PERR)}var parent=item.parent(),index=item.getIndex(),text=item.getParsedText(),itemSelSpan=item.getSpan();if(""===text){var refocusItem=g.getNextItem(item,g.focusedPane),refocusIndex=0;refocusItem||(refocusItem=g.getPreviousItem(item,g.focusedPane),refocusIndex=refocusItem.getParsedText().length),refocusItem&&!refocusItem.isFullscreen()&&(item.hasChildren()?parent.replaceChild(item,item.getFirstChild()):parent.deleteChild(item,parent,index),g.selectChildren(refocusItem,refocusIndex,refocusIndex))}else if(offsets.start===offsets.total&&offsets.end===offsets.total||offsets.start===offsets.total-1&&offsets.end===offsets.total-1&&""===span.textContent[offsets.endText]){var next=g.getNextItem(item,g.focusedPane);next&&(item.setText(text+next.getParsedText(),!0),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:text.length,text:next.getParsedText()}),next.parent().deleteChild(next,item,0),g.selectChildren(item,offsets.total,0))}else if(0===offsets.start&&0===offsets.end&&1===text.length&&""!=text[0])item.setText("",!0),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text});else if((platform.mac&&e.altKey||!platform.mac&&e.ctrlKey)&&offsets.start===offsets.end){for(var startOfText=text.substring(0,offsets.startText),seenALetter=!1,isHandled=!1,i=offsets.startText;i<text.length&&!isHandled;i++)if(seenALetter=seenALetter||" "!==text[i],i===text.length-1||" "===text[i]){var subIndex=" "===text[i]&&" "==text[offsets.startText]?i:i+1;if(seenALetter||" "!==text[i]){var newText=startOfText+text.substring(subIndex);item.setText(newText,!0),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:subIndex,text:newText}),g.selectChildren(item,offsets.start,0),isHandled=!0}}}else if(offsets.start!=offsets.end){var newText=text.substr(0,offsets.startText)+text.substr(offsets.endText);item.setText(newText,!0),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.slice(offsets.startText,offsets.endText)}),g.selectChildren(item,offsets.start,0)}else{var newText=text.substr(0,offsets.startText)+text.substr(offsets.startText+1);item.setText(newText,!0),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.slice(offsets.startText,offsets.startText+1)}),g.selectChildren(item,offsets.start,0)}return!1},self}),define("AScript",["globals","platform","data","tracker","VMLI","edit"],function(g,platform,d,tracker,VMLI,edit){function AScript(){this.hasSelection=!1,this.isTyping=!1,this.isRunning=!1,this.isDisabled=!1,this.activeScript=void 0,this.index=0,this.repeat=!1,this.onScriptDone=void 0,this.selectedItem=void 0,this.needsFinish=!1,this.lastCreatedItem=void 0,this.lastLoadedData=void 0,this._scriptQueue=[],this.startText={},window.addEventListener("message",function(e){if(e.data.indexOf("{")<0){var params=e.data.split(":");try{g.PAssert(1294,params.length>=0,"Invalid number of params in message")}catch(PERR){g.reportError(PERR)}switch(params[0]){case"script":this.finishAndRunScript(params[1]);break;case"data":this.loadScriptData(params[1])}}}.bind(this),!1),window.pauseScript=function(){this.isDisabled||(log("pause script"),this.isDisabled=!0)}.bind(this)}var ActionType={Run:1,Reset:2};return AScript.prototype={runScript:function runScriptFn(id,repeat){if(!this.isDisabled){switch(id){case"search":this._scriptQueue.push(this.demoSearch(id));break;case"p0":case"p1":case"p2":case"p3":case"p4":case"p5":var index=parseInt(id.replace("p",""),10);this._scriptQueue.push(this.demoPrioritize(id,index)),repeat=!1;break;case"f0":case"f1":case"f2":case"f3":case"f4":case"f5":var index=parseInt(id.replace("f",""),10);this._scriptQueue.push(this.demoFocus(id,index)),repeat=!1;break;case"indent":this._scriptQueue.push(this.demoIndent(id));break;case"none":return;default:try{g.PAssert(1295,!1,"Invalid script request")}catch(PERR){g.reportError(PERR)}}this.repeat=repeat,this.activeScript=this._scriptQueue[0],!this.isRunning&&this.activeScript&&(this.onScriptStart(this.activeScript),this.reset(),this.run())}},forceFinish:function forceFinishFn(cb){try{g.PAssert(1296,cb,"Must supply a callback to force finish")}catch(PERR){g.reportError(PERR)}if(this.isRunning)this.needsFinish=!0,this.delayTimeout&&(clearTimeout(this.delayTimeout),this.delayCb(),this.delayCb=this.delayTimeout=void 0),this.onScriptDone=function(){this.needsFinish=!1,cb(),this.onScriptDone=void 0}.bind(this);else{try{g.PAssert(1297,this.needsFinish===!1,"Should never be forcing a finish if not actively running")}catch(PERR){g.reportError(PERR)}cb()}},finishAndRunScript:function finishAndRunScriptFn(id){this._scriptQueue=[],this.repeat=!1,this.forceFinish(function(){this.runScript(id,!1)}.bind(this))},loadScriptData:function loadScriptDataFn(dataId){log("Load Script Data: ",dataId),this._scriptQueue=[],this.repeat=!1,this.lastLoadedData!==dataId&&(this.lastLoadedData=dataId,g.vmMain.resetScrollOffsets(),d.loadDemoData(dataId,g.vmMain.changeRoot))},onScriptStart:function onScriptStartFn(script){script&&window.parent.postMessage(script.getName(),"*")},getRoot:function getRootFn(){return d.getRootModel()},getFirstItem:function getFirstItemFn(){return d.getRootModel().getChild(0)},setSelection:function setSelectionFn(item,paneIndex,offset,cb){try{g.PAssert(1299,item,"Must provide a valid item to select")}catch(PERR){g.reportError(PERR)}g.focusedPaneID!==paneIndex&&g.vmMain.setFocusedPane(g.vmMain.panes[paneIndex]),void 0===offset||null===offset?offset=0:0>offset&&(offset=item.getParsedText().length+offset+1),g.selectChildren(item,offset,0),this.hasSelection=!0,this.selectedItem=item,cb&&cb()},selectEndOfLine:function selectEndOfLineFn(item,paneIndex,cb){this.setSelection(item,paneIndex,-1,cb)},clearSelection:function clearSelectionFn(cb){g.clearSelection(),this.hasSelection=!1,this.selectedItem=void 0,cb&&cb()},scrollTo:function scrollToFn(index,offset,cb){var pane=g.vmMain.panes()[index];try{g.PAssert(1300,pane,"Must have selected a valid pane")}catch(PERR){g.reportError(PERR)}pane.setScrollOffset(offset),cb&&cb()},setText:function setTextFn(item,str,cb){item.setText(str,!0),cb&&cb()},appendText:function appendTextFn(item,str,cb){item.setText(item.getRawText()+str,!0),cb&&cb()},removeText:function removeTextFn(item,str,cb){var text=item.getRawText().replace(str,"");item.setText(text,!0),cb&&cb()},setPriority:function setPriorityFn(item,priority,cb){item.priority(priority),cb&&cb()},setFlagged:function setFlaggedFn(item,isFlagged,cb){item.isFlagged(isFlagged),cb&&cb()},setComplete:function setCompleteFn(item,isComplete,date,cb){item.dateCompleted=date,item.isComplete(isComplete),cb&&cb()},indent:function indentFn(outdent,cb){var keyData={normCode:KeyCode.Tab,shiftKey:outdent};g.fireKeyEvent(void 0,keyData),cb&&cb()},_deleteChildren:function _deleteChildrenFn(item){for(var i=0;i<item.items().length;i++)this._deleteChildren(item.items()[i]),delete d.itemsById[item.items()[i].id]},clearChildren:function clearChildrenFn(item,cb){this._deleteChildren(item),item.items.removeAll(),cb&&cb()},typeString:function typeStringFn(item,str,charDelay,cb){function typeChar(){g.fireKeyEvent(void 0,{normCode:str.charCodeAt(i)}),++i>=str.length&&(typeInterval&&clearInterval(typeInterval),this.isTyping=!1,cb&&cb())}try{g.PAssert(1301,cb,"typeString should always have a callback")}catch(PERR){g.reportError(PERR)}this.needsFinish&&(charDelay=0),this.selectEndOfLine(item||this.lastCreatedItem,0);try{g.PAssert(1302,this.hasSelection,"Must set selection before typing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1303,!this.isTyping,"Must wait until previous typing is finished")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1304,void 0!==str,"Must supply a string to be typed")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1305,void 0!==charDelay,"Must specify a delay between each typed character")}catch(PERR){g.reportError(PERR)}this.isTyping=!0;var i=0,typeInterval;typeInterval=setInterval(typeChar.bind(this),charDelay)},resetSearch:function resetSearchFn(cb){for(var i=0;i<g.vmMain.panes().length;i++)g.vmMain.panes()[i].vmSearch.setSearch("");cb&&cb()},hideAutoComplete:function hideAutoCompleteFn(cb){g.autocomplete&&g.autocomplete.hide(),cb&&cb()},setSearch:function setSearchFn(search,paneIndex,cb){g.vmMain.panes()[paneIndex].vmSearch.setSearch(search),cb&&cb()},searchString:function searchStringFn(str,charDelay,clearFirst,paneIndex,cb){try{g.PAssert(1306,!this.isTyping,"Must wait until previous typing is finished")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1307,void 0!==str,"Must supply a string to be typed")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1308,void 0!==charDelay,"Must specify a delay between each typed character")}catch(PERR){g.reportError(PERR)}this.isTyping=!0;var vmSearch=g.vmMain.panes()[paneIndex].vmSearch,startStr=clearFirst?"":vmSearch.search(),i=0,typeInterval=setInterval(function(){vmSearch.setSearch(startStr+str.substr(0,i+1)),++i>=str.length&&(clearInterval(typeInterval),this.isTyping=!1,cb&&cb())}.bind(this),charDelay)},createItemAfter:function createItemAfterFn(item,cb){item?this.setSelection(item,0,item.getParsedText().length):item=this.selectedItem||this.lastCreatedItem,g.fireKeyEvent(void 0,{normCode:KeyCode.Enter}),this.clearSelection(function(){var newItem;newItem=item.isHeader()?item.getChild(0):item.parent().getChild(item.getIndex()+1),this.lastCreatedItem=newItem,this.setSelection(newItem,0,-1,cb)}.bind(this))},clickElement:function clickElementFn(ele,cb){try{g.PAssert(1309,ele,"Requesting selection in an invalid element")}catch(PERR){g.reportError(PERR)}g.fireClickEvent(ele,Button.Left),cb&&cb()},zoomItem:function zoomItemFn(item,cb){g.vmMain.zoomin(item,!1),cb&&cb()},openOutline:function openOutlineFn(paneIndex,cb){var pane=g.vmMain.panes()[paneIndex];pane.outlineVisible()||pane.toggleOutlineVisibility(),cb&&cb()},closeOutline:function closeOutlineFn(paneIndex,cb){var pane=g.vmMain.panes()[paneIndex];pane.outlineVisible()&&pane.toggleOutlineVisibility(),cb&&cb()},openContextMenu:function openContextMenuFn(item,cb){try{g.PAssert(1310,item,"Requesting selection in an invalid item")}catch(PERR){g.reportError(PERR)}var box=item.getElement().getBoundingClientRect(),left=box.left+150,top=box.top+10;g.menus.openItemMenu(item,{x:left,y:top}),cb&&cb()},closeContextMenu:function closeContextMenuFn(cb){g.menus.closeItemMenu(),cb&&cb()},hoverMenuItem:function hoverMenuItemFn(ele,cb){try{g.PAssert(1311,ele,"Requesting selection in an invalid element")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1312,!g.hasClass(ele,"menuHover"),"Dont apply hover twice to an element")}catch(PERR){g.reportError(PERR)}g.addClass(ele,"menuHover"),cb&&cb()},unhoverMenuItem:function unhoverMenuItemFn(ele,cb){try{g.PAssert(1313,ele,"Requesting selection in an invalid element")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1314,g.hasClass(ele,"menuHover"),"Cant unhover when not previously hovered")}catch(PERR){g.reportError(PERR)}g.removeClass(ele,"menuHover"),cb&&cb()},delay:function delayFn(ms,cb){cb&&(this.needsFinish?cb&&cb():(this.delayCb=cb,this.delayTimeout=setTimeout(function(){this.delayCb=this.delayTimeout=void 0,cb()}.bind(this),ms)))},setPaneModeAnim:function setPaneModeAnimFn(paneID,mode,cb){var button=document.getElementsByClassName("paneOptionsButton")[paneID];this.clickElement(button),this.delay(function(){var menuName=mode===PaneMode.Timeline?"paneTimelineView":"paneListView",menuItem=document.getElementsByClassName(menuName)[paneID];this.hoverMenuItem(menuItem),this.delay(function(){this.clickElement(menuItem),this.unhoverMenuItem(menuItem),cb&&cb()}.bind(this),800)}.bind(this),300)},setPaneModeInstant:function setPaneModeInstantFn(paneID,mode,cb){var pane=g.vmMain.panes()[paneID];pane.mode(mode),cb&&cb()},addPane:function addPaneFn(mode,cb){g.vmMain.addPaneToRight(mode),cb&&cb()},removePaneAnim:function removePaneAnimFn(paneID,cb){var button=document.getElementsByClassName("paneOptionsButton")[paneID];this.clickElement(button),this.delay(function(){var menuItem=document.getElementsByClassName("paneClose")[paneID];this.hoverMenuItem(menuItem),this.delay(function(){this.clickElement(menuItem),this.unhoverMenuItem(menuItem),cb&&cb()}.bind(this),800)}.bind(this),300)},removePaneInstant:function removePaneInstantFn(paneID,cb){var pane=g.vmMain.panes()[paneID];g.vmMain.removePane(pane),cb&&cb()},setSubtitle:function setSubtitleFn(text,time,cb){var message=g.messageQueue.pushMessage({text:text,type:MessageType.Subtitle});setTimeout(function(){g.messageQueue.clearMessage(message),cb&&cb()}.bind(this),time)},createScript:function createScriptFn(name,repeat){var script={owner:this,_name:name,index:0,isResetting:!1,_repeat:!1,noDelay:!1,runQueue:[],resetQueue:[],_activeQueue:function _activeQueueFn(){return this.isResetting?this.resetQueue:this.runQueue},queue:function queueFn(type,fnName){var args=Array.prototype.slice.call(arguments,2),arr=type==ActionType.Run?this.runQueue:this.resetQueue;return arr.push({name:fnName,args:args}),arr},repeat:function repeatFn(val){this._repeat=val},reset:function resetFn(){this.index=0;for(var i=0;i<this.resetQueue.length;i++){var next=this.resetQueue[i];this.owner[next.name].apply(this.owner,next.args)}},nextStep:function nextStepFn(){var queue=this.runQueue;return queue[this.index++]},getName:function getNameFn(){return this._name}};return script},reset:function resetFn(){this.index=0;for(var i=0;i<this._scriptQueue.length;i++)this._scriptQueue[i].reset()},run:function runFn(){if(!this.isDisabled){try{g.PAssert(1317,this.activeScript,"Must have a script active to be running")}catch(PERR){g.reportError(PERR)}var next=this.activeScript.nextStep();if(!next){if(this.index++,this.index>=this._scriptQueue.length){if(!this.repeat)return this.isRunning=!1,void(this.onScriptDone&&this.onScriptDone());this.reset()}this.activeScript=this._scriptQueue[this.index],this.activeScript.reset(),this.onScriptStart(this.activeScript),next=this.activeScript.nextStep()}var args=next.args;args.push(this.run.bind(this)),args.push(this.activeScript),this.isRunning=!0,setTimeout(function(){try{this[next.name].apply(this,args)}catch(err){g.reportError(err),this.onDisable()}}.bind(this),0)}},onDisable:function onDisableFn(){this.isDisabled=!0},demoIndent:function demoIndentFn(id){var s=this.createScript(id),item=d.itemsById.itemIndent.model;return s.queue(ActionType.Run,"delay",2e3),s.queue(ActionType.Run,"setSelection",item,0,0),s.queue(ActionType.Run,"indent",!1),s.queue(ActionType.Run,"delay",2e3),s.queue(ActionType.Run,"setSelection",item,0,0),s.queue(ActionType.Run,"indent",!0),s},demoSearch:function demoSearchFn(id){var s=this.createScript(id),time=2e3,item=d.itemsById.searchItem.model;return s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"setSearch","#tag",0),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"resetSearch"),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"setSearch","!",0),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"setSearch","!!!",0),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"resetSearch"),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"zoomItem",item),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"setSearch","#tag",0),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"zoomItem",this.getRoot()),s.queue(ActionType.Run,"resetSearch"),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Run,"setSearch","+Jane",0),s.queue(ActionType.Run,"delay",time),s.queue(ActionType.Reset,"resetSearch"),s},loadItemAndReset:function loadItemAndResetFn(name,s){var item=d.itemsById[name].model,text;return text=this.startText[name]?this.startText[name]:this.startText[name]=d.itemsById[name].data.text,log("reset text = ",text),s.queue(ActionType.Reset,"setText",item,text),s.queue(ActionType.Reset,"setPriority",item,VMLIFlag.None),s.queue(ActionType.Reset,"setFlagged",item,!1),s.queue(ActionType.Reset,"setComplete",item,!1,void 0),item},demoPrioritize:function demoPrioritizeFn(id,index){var s=this.createScript(id),yard=this.loadItemAndReset("yard",s),roof=this.loadItemAndReset("roof",s),vacation=this.loadItemAndReset("vacation",s),chips=this.loadItemAndReset("chips",s),present=this.loadItemAndReset("present",s),shorts=this.loadItemAndReset("shorts",s),laptop=this.loadItemAndReset("laptop",s),app=this.loadItemAndReset("app",s);return 0===index?(s.queue(ActionType.Run,"appendText",yard," @later"),s.queue(ActionType.Run,"appendText",roof," @soon"),s.queue(ActionType.Run,"appendText",vacation," @later"),s.queue(ActionType.Run,"appendText",chips," @now"),s.queue(ActionType.Run,"appendText",present," @now"),s.queue(ActionType.Run,"appendText",shorts," @later"),s.queue(ActionType.Run,"appendText",laptop," @soon"),s.queue(ActionType.Run,"appendText",app," @now")):1===index?(s.queue(ActionType.Run,"appendText",yard," @next friday"),s.queue(ActionType.Run,"appendText",roof," @tomorrow"),s.queue(ActionType.Run,"appendText",vacation," @"+Date.today().addDays(42).toString("M/dd")),s.queue(ActionType.Run,"appendText",chips," @today 6pm"),s.queue(ActionType.Run,"appendText",present," @today 3pm"),s.queue(ActionType.Run,"appendText",shorts," @"+Date.today().addDays(4).toString("M/dd")),s.queue(ActionType.Run,"appendText",laptop," @"+Date.today().addDays(3).toString("M/dd")),s.queue(ActionType.Run,"appendText",app," @today "+(new Date).toString("h:mmtt"))):2===index?(s.queue(ActionType.Run,"setPriority",yard,VMLIFlag.P2),s.queue(ActionType.Run,"setPriority",roof,VMLIFlag.P1),s.queue(ActionType.Run,"setPriority",vacation,VMLIFlag.P2),s.queue(ActionType.Run,"setPriority",chips,VMLIFlag.P0),s.queue(ActionType.Run,"setPriority",present,VMLIFlag.P0),s.queue(ActionType.Run,"setPriority",shorts,VMLIFlag.P2),s.queue(ActionType.Run,"setPriority",laptop,VMLIFlag.P1),s.queue(ActionType.Run,"setPriority",app,VMLIFlag.P0)):3===index?(s.queue(ActionType.Run,"setFlagged",chips,!0),s.queue(ActionType.Run,"setFlagged",present,!0),s.queue(ActionType.Run,"setFlagged",app,!0)):4===index?(s.queue(ActionType.Run,"setComplete",roof,!0,(new Date).addDays(-2)),s.queue(ActionType.Run,"setComplete",chips,!0,(new Date).addMinutes(-10)),s.queue(ActionType.Run,"setComplete",present,!0,(new Date).addMinutes(-10)),s.queue(ActionType.Run,"setComplete",laptop,!0,(new Date).addDays(-11)),s.queue(ActionType.Run,"setComplete",app,!0,new Date)):5===index&&(s.queue(ActionType.Run,"appendText",yard," @later"),s.queue(ActionType.Run,"setPriority",roof,VMLIFlag.P1),s.queue(ActionType.Run,"appendText",vacation," @tomorrow"),s.queue(ActionType.Run,"appendText",chips," @today 6pm"),s.queue(ActionType.Run,"appendText",present," @today 3pm"),s.queue(ActionType.Run,"setPriority",present,VMLIFlag.P0),s.queue(ActionType.Run,"setPriority",shorts,VMLIFlag.P2),s.queue(ActionType.Run,"setComplete",laptop,!0,(new Date).addDays(-1)),s.queue(ActionType.Run,"setFlagged",app,!0),s.queue(ActionType.Run,"appendText",app," @now")),s},demoFocus:function demoFocusFn(id,index){var s=this.createScript(id);return 0===index?s.queue(ActionType.Run,"setSearch","#out",1):1===index?(s.queue(ActionType.Run,"setSearch","!",1),s.queue(ActionType.Run,"delay",2e3),s.queue(ActionType.Run,"setSearch","!!!",1)):2===index?s.queue(ActionType.Run,"setSearch","+Miller Harris",1):3===index?s.queue(ActionType.Run,"setSearch","-//",1):4===index?s.queue(ActionType.Run,"setSearch","Japan",1):5===index&&(s.queue(ActionType.Run,"setSearch","!",1),s.queue(ActionType.Run,"delay",1e3),s.queue(ActionType.Run,"setSearch","! todo",1),s.queue(ActionType.Run,"delay",1e3),s.queue(ActionType.Run,"setSearch","! todo ! app",1),s.queue(ActionType.Run,"delay",1e3),s.queue(ActionType.Run,"setSearch","! todo ! app -jap",1)),s}},AScript}),define("VMSetup",["ko","data","globals","util","platform","goog","AScript"],function(ko,d,g,util,platform,goog,AScript){function VMSetup(){this.loginState=ko.observable(LoginState.NONE),this.loginEnabled=ko.observable(!0);var normalText="Sign in with Google";this.loginStatus=ko.observable(normalText),goog.gapiLoaded||(this.loginDisableTimeout=setTimeout(function(){this.loginEnabled(!1),this.loginStatus("Must be online to login")}.bind(this),1e3),window.addEventListener("gapiLoaded",function(){clearTimeout(this.loginDisableTimeout),this.loginEnabled(!0),this.loginStatus(normalText)}.bind(this),!0))}return VMSetup.prototype={init:function initFn(){if(g.isDemoMode())return LoginState.LOGGED_OUT;var loginState=g.getLoginState();return this.setLoginState(loginState),g.applyBindings(this,"setup"),window.addEventListener("offline",function(evt){log("Browser going offline."),g.vmMain.setGDriveStatus(DriveStatus.Offline)}),window.addEventListener("online",function(evt){if(log("Browser going online."),g.getLoginState()==LoginState.LOGGED_IN&&!platform.offline){g.vmMain.setGDriveStatus(DriveStatus.Connecting);var alreadyOnline=goog.goOnline();log("Coming online. Already online:",alreadyOnline)}}),loginState},logoutButtonText:function logoutButtonTextFn(){return g.isDemoMode()?"Leave Introduction":"Logout"},setLoginState:function setLoginStateFn(state){state!=this.loginState()&&(g.setLoginState(state),this.loginState(state))},userLogin:function userLoginFn(){goog.runAuthenticate(goog.requiredScopes,!1,!0,function(token){token&&!token.error?(g.settings.set(Settings.localIntegrity,!0),this.setLoginState(LoginState.LOGGED_IN),gapi.load("drive-realtime",function(){goog.loadClientDefaultFile()})):log("Invalid token returned when calling userLogin")}.bind(this))},openLogin:function openLoginFn(){this.loginState(LoginState.NONE),g.StopSpinner()},logout:function logoutFn(){g.settings.reset(),this.setLoginState(LoginState.LOGGED_OUT),d.clearData(function(){util.hasURLParam("login")?util.removeURLParam("login"):platform.app?platform.app&&platform.sendToApp("logout"):g.reload()})},logoutClicked:function logoutClickedFn(){if(g.isDemoMode())util.removeURLParam("demo");else{var ok=!0;for(var itemID in d.pendingRemoteUpdates)if(d.pendingRemoteUpdates.hasOwnProperty(itemID)){platform.packagedApp||(ok=confirm("You have unsaved changes which will be lost if you log out. Are you sure?"));break}ok&&this.logout()}},isLocal:function isLocalFn(){return"localhost"==window.location.hostname},onlineStatusToggle:function onlineStatusToggleFn(){platform.offline?util.removeURLParam("offline"):util.insertURLParam("offline","true")},runScript:function runScriptFn(id){g.AScript||(g.AScript=new AScript),g.AScript.runScript(id,!0)},onTapLogin:function onTapLoginFn(){g.vmMain.isOnline()&&this.userLogin()},onTapInput:{onClick:function onClickFn(e){platform.ios&&(e.srcElement.focus(),g.enforceScroll())}},onTap:{onMove:function onMoveFn(e){e.preventDefault()}},onTapLanding:function onTapLandingFn(){window.location.pathname="/about/"},onPrivacyPolicy:{onClick:function onClickFn(e){open("/privacy")}}},VMSetup}),define("kos",[],function(){return null}),define("parse",["globals","VMLI","tracker","data"],function(g,VMLI,tracker,d){function parseHead(node){for(var props={},i=0;i<node.childElementCount;++i){var prop=node.children[i],propName=prop.nodeName;if(prop.firstChild){var propValue=prop.firstChild.textContent;props[propName]=propValue}}return props}function stripParents(item){if(item.parent=void 0,item.items)for(var i=0;i<item.items.length;i++)stripParents(item.items[i])}var self={};return self.parseOPML=function parseOPMLFn(data,filename){function visit(node,parentModel){var visitChildren=!0,nodeModel=void 0;switch(node.nodeName){case"#document":case"body":case"opml":break;case"head":visitChildren=!1;var ret=parseHead(node);ret&&ret.title&&!rootModel&&(rootModel=new VMLI({text:ret.title},{parent:d.getRootModel(),parse:!0,forceSave:!0}),d.getRootModel().insertItem(rootModel));break;case"outline":parentModel||(rootModel?parentModel=rootModel:(parentModel=rootModel=new VMLI({text:filename},{parent:d.getRootModel(),parse:!0,forceSave:!0}),d.getRootModel().insertItem(rootModel))),nodeModel=new VMLI({text:node.attributes.text.value},{parent:parentModel,parse:!0,forceSave:!0}),parentModel.insertItem(nodeModel);break;default:log("Unknown OPML Node: ",node)}if(visitChildren)for(var i=0;i<node.childElementCount;++i)visit(node.children[i],nodeModel);return nodeModel}var rootModel;return tracker.beginAction(),visit(data),tracker.endAction(),!0},self.parseJSON=function parseJSONFn(data,root){function visit(node,parentModel){var nodeParent=parentModel||root||d.getRootModel(),nodeData={text:node.text,dateCompleted:node.dateCompleted,priority:node.priority,isComplete:node.isComplete,isFlagged:node.isFlagged},nodeModel=new VMLI(nodeData,{parent:nodeParent,parse:!0,forceSave:!0});if(nodeParent.insertItem(nodeModel),node.items)for(var i=0;i<node.items.length;++i)visit(node.items[i],nodeModel)}var dataVersion;if(void 0!==data.moodoVer&&void 0!==data.moodoRoot)try{return dataVersion=parseInt(data.moodoVer),tracker.beginAction(),visit(data.moodoRoot),tracker.endAction(),!0}catch(err){}else if(void 0!==data.text&&void 0!==data.items)try{return tracker.beginAction(),visit(data),tracker.endAction(),!0}catch(err){}return!1},self.traverseDOM=function traverseDOMFn(options){function visit(node){if(node.nodeType===Node.TEXT_NODE){(reallyNeedsNewItem||needsNewItem)&&(currentLine.text=currentLine.text.trim(),""!==currentLine.text&&(newItem={text:"",parent:currentLine.parent},currentLine.parent.items.push(newItem),currentLine=newItem)),reallyNeedsNewItem=!1,needsNewItem=!1;var addText=node.nodeValue;""===currentLine.text&&(addText=node.nodeValue.replace(/^\s+/g,"")),currentLine.text+=addText}else node.nodeType===Node.COMMENT_NODE||("BR"==node.tagName||"P"==node.tagName||"LI"==node.tagName||"DIV"==node.tagName?needsNewItem=!0:("UL"==node.tagName||"OL"==node.tagName)&&(needsNewItem=!1,currentLine.text=currentLine.text.trim(),newItem={text:"",parent:currentLine},currentLine.items?currentLine.items.push(newItem):currentLine.items=[newItem],currentLine=newItem))}function end(node){node.nodeType!==Node.TEXT_NODE&&("UL"==node.tagName||"OL"==node.tagName?(currentLine=currentLine.parent,reallyNeedsNewItem=!0):("DIV"==node.tagName||"P"==node.tagName)&&(needsNewItem=!0))}function print(r,levelsDeep){isNaN(levelsDeep)&&(levelsDeep=0);for(var text="",i=0;levelsDeep>i;i++)text+="--";if(levelsDeep&&console.log(text,r.text),r.items)for(var i=0;i<r.items.length;i++)print(r.items[i],levelsDeep+1)}var root=options.root,doStripParents=options.stripParents,shouldPrint=options.shouldPrint,n=root.firstChild,rootNode={items:[]},currentLine={text:"",parent:rootNode};rootNode.items.push(currentLine);var newItem,needsNewItem=!1,reallyNeedsNewItem=!1;do if(visit(n),c=n.firstChild)n=c;else if(c=n.nextSibling)n=c;else{do c=n.parentNode.nextSibling,c?(end(n.parentNode),n=c):(n=n.parentNode,end(n));while(!c&&n&&n.parentNode);if(!c)break}while(n);return doStripParents&&stripParents(rootNode),shouldPrint&&print(rootNode),rootNode},self}),define("copypaste",["ko","globals","platform","edit","VMLI","tracker","parse"],function(ko,g,platform,edit,VMLI,tracker,parse){function insertDummyItem(parentItem,e,text){text||(text="");var item=new VMLI({text:text},{parent:parentItem,parse:!0,forceSave:!0});parentItem.items.unshift(item),tracker.performAction(TrackerType.Create,{itemID:item.id,parent:parentItem.id,position:0,text:text}),g.selectChildren(item,0,0);var selection=g.getSelectionInfo(),range=selection.selection.getRangeAt(0);return range}function killEvent(e){try{g.PAssert(1319,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1320,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}function handlepaste(e){e.srcElement||(e.srcElement=e.target);var clipData=e&&e.clipboardData?e.clipboardData:window.clipboardData,dataType=platform.ie?"Text":"text/plain",clipboardBuffer="",selection=g.getSelectionInfo();if(selection&&selection.selection){var range=selection.selection.getRangeAt(0),pane=g.getPaneForElement(e.srcElement);if(g.hasClass(e.srcElement,"search"))return(/text\/plain/.test(clipData.types)||platform.ie)&&(e.srcElement.textContent=clipData.getData(dataType).replace(/[\r\n\t]/g,""),g.selectElement(e.srcElement,!0)),e.preventDefault(),!1;if(pane){if(pane.mode()!==PaneMode.Normal)return!1;var startSpan=g.getSpanParent(range.startContainer),endSpan=g.getSpanParent(range.endContainer);if(!startSpan||!endSpan){if(range.startContainer!=pane.paneContent&&range.endContainer!=pane.paneContent){try{g.PAssert(1321,!1,"There should always be something to paste into")}catch(PERR){g.reportError(PERR)}return}var item=pane.addItemToPane("",0);startSpan=endSpan=item.getSpan(),g.selectChildren(item,0,0)}if(clipData&&clipData.getData){tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Paste,data:[{value:!0}]}),killEvent(e);var traversed;if(/text\/html/.test(clipData.types)){if(clipboardBuffer=clipData.getData("text/html"),!clipboardBuffer)return;var node=document.createElement("div"),replacedText=clipboardBuffer.replace(/[\n\t]/g," ").replace(/[\r]|<head(.|\s)*?\/head>|<script(.|\s)*?\/script>|<style(.|\s)*?\/style>/g,"").replace(/\s+/g," ").replace(/onload/gi,"never"),bodyRegex=/<body(.|\s)*?\/body>/g,bodyMatch;(bodyMatch=bodyRegex.exec(replacedText))&&(replacedText=bodyMatch[0]),node.innerHTML=replacedText,traversed=parse.traverseDOM({root:node,shouldPrint:!1,stripParents:!0}),1===traversed.items.length&&""===traversed.items[0].text&&(traversed=traversed.items[0])}else if(/text\/plain/.test(clipData.types)||platform.ie){clipboardBuffer=clipData.getData(dataType).trim();var isXML=clipboardBuffer.startsWith("<?xml "),isOPML=clipboardBuffer.startsWith("<?opml "),xml;if((isXML||isOPML)&&(xml=g.loadXML(clipboardBuffer)),xml){if(isXML)return g.messageQueue.pushMessage({text:"We currently do not support pasting generic XML documents, try convering to OPML. If you need to import XML send us a message and we will work through your scenario with you.",type:MessageType.Error}),!1;if(isOPML)return parse.parseOPML(xml,"OPML Import"),!1}else{var isJSON=!1;if(clipboardBuffer.startsWith("{")&&clipboardBuffer.endsWith("}"))try{var jsonData=JSON.parse(clipboardBuffer),root=ko.dataFor(startSpan.parentElement),res=parse.parseJSON(jsonData,root);if(res)return!1}catch(err){}var replacedText=clipboardBuffer.replace(/[\t]/g," "),traversedText=replacedText.split("\n");traversed={items:[]};for(var i=0;i<traversedText.length;i++)0!==traversedText[i].length&&traversed.items.push({text:g.trimString(traversedText[i]),parent:traversed})}}if(!traversed||0===traversed.items.length)return!1;try{g.PAssert(1322,void 0!==startSpan&&void 0!==endSpan,"Must have a valid selection to perform paste")}catch(PERR){g.reportError(PERR)}tracker.beginAction();var itemStart=ko.dataFor(startSpan.parentElement),itemEnd=ko.dataFor(endSpan.parentElement),sOffset=g.getSelectOffsetsInSpan(itemStart,startSpan,range),eOffset=g.getSelectOffsetsInSpan(itemEnd,endSpan,range),itemParent=itemStart.parent(),itemIndex=itemStart.getIndex(),sText=itemStart.getParsedText(),eText=itemEnd.getParsedText(),selItemSpan,selOffset;itemStart!=itemEnd&&edit.handleMultiselect({},startSpan,endSpan,range);var lastItem=itemStart;if(traversed&&1===traversed.items.length&&!traversed.items[0].items){var iText=traversed.items[0].text.trim(),str=sText.substring(0,sOffset.startText)+iText+eText.substring(eOffset.endText);selItemSpan=itemStart.getSpan(),tracker.performAction(TrackerType.Remove,{itemID:itemStart.id,position:0,text:itemStart.getParsedText()}),itemStart.setText(str,!0),tracker.performAction(TrackerType.Insert,{itemID:itemStart.id,position:0,text:str}),selOffset=sOffset.start+iText.length,g.selectChildren(itemStart,selOffset,0)
}else{for(var parentItems=itemParent.items(),mutations=[],i=0;traversed&&i<traversed.items.length;++i){var itemInfo=traversed.items[i];if(itemInfo.text=itemInfo.text.trim(),""!==itemInfo.text||itemInfo.items)if(0===i){if(itemInfo.text[0]==sText&&(itemInfo.text=itemInfo.text.substr(1)),itemInfo.text=sText.substring(0,sOffset.startText)+itemInfo.text,itemStart.setText(itemInfo.text,!0),tracker.performAction(TrackerType.Insert,{itemID:itemStart.id,position:0,text:itemInfo.text}),itemIndex++,itemInfo.items){for(var u=0;u<itemInfo.items.length;u++){var child=itemInfo.items[u];(""!==child.text||child.items)&&itemStart.insertItem(new VMLI(child,{parent:itemStart,parse:!0,forceSave:!0}))}-1==mutations.indexOf(itemStart)&&mutations.push(itemStart)}}else{var newItem=new VMLI(itemInfo,{parent:itemParent,parse:!0,forceSave:!0});itemParent.insertItem(newItem,itemIndex++,!0),-1==mutations.indexOf(itemParent)&&mutations.push(itemParent),tracker.performAction(TrackerType.Create,{itemID:newItem.id,parent:itemParent.id,position:itemIndex-1,text:newItem.getParsedText()})}}for(i=0;i<mutations.length;i++)mutations[i].items.valueHasMutated();for(lastItem=itemParent.getChild(itemIndex-1);lastItem.hasChildren();)lastItem=lastItem.getLastChild();selOffset=lastItem.getParsedText().length,lastItem.setRawText(lastItem.getParsedText()+eText.substring(eOffset.endText)),g.vmMain.runParseWorker(itemParent,function(){setTimeout(function(){g.selectChildren(lastItem,selOffset,0)},0)})}}return tracker.endAction(),g.scrollIntoView(lastItem.getSpan(),200),!1}}}function handlecut(e){var copySuccess=!handlecopy(e);return copySuccess?(edit.keydown(void 0,{normCode:KeyCode.BackSpace,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn}),killEvent(e),!1):!0}function handlecopy(e){var clipData=e&&e.clipboardData?e.clipboardData:window.clipboardData;if(clipData){e.srcElement||(e.srcElement=e.target);var selection=g.getSelectionInfo();if(!selection)return!0;var currentItem=selection.selection.getRangeAt(0).startContainer;if("#text"==currentItem.nodeName&&(currentItem=currentItem.parentNode),"exportedArea"===e.srcElement.id||"exportedContent"===e.srcElement.id){var dataType=platform.ie?"Text":"text/plain";clipData.setData(dataType,e.srcElement.textContent)}else{var inPane=g.elementInPane(currentItem);if(!inPane||"searchDiv"===selection.node.id||g.hasClass(selection.node,"search"))return!0;g.restrictSelectionToText(),selection=g.getSelectionInfo();var range=selection.selection.getRangeAt(0);try{g.PAssert(1323,"#text"==range.startContainer.nodeName,"Expected #text, Actual: "+range.startContainer.tagName)}catch(PERR){g.reportError(PERR)}var startSpan=g.getSpanParent(range.startContainer);try{g.PAssert(1324,"#text"==range.endContainer.nodeName||"SPAN"==range.endContainer.nodeName,"Expected #text or SPAN, Actual: "+range.endContainer.tagName)}catch(PERR){g.reportError(PERR)}var endSpan=g.getSpanParent(range.endContainer),startLI=startSpan.parentElement;try{g.PAssert(1325,"LI"==startLI.tagName,"Expected LI, Actual: ",startLI)}catch(PERR){g.reportError(PERR)}var endLI=endSpan.parentElement;try{g.PAssert(1326,"LI"==endLI.tagName,"Expected LI, Actual: ",endLI)}catch(PERR){g.reportError(PERR)}var item=ko.dataFor(startLI),endItem=ko.dataFor(endLI),offsets=g.getSelectOffsetsInSpan(item,startSpan,range),nextLI=startLI;try{g.PAssert(1327,item)}catch(PERR){g.reportError(PERR)}var createHTML=!platform.ie,html,plain,text=item.getParsedText().substring(offsets.startText);if(startLI==endLI)text=offsets.start==offsets.end?item.getParsedText():item.getParsedText().substr(offsets.startText,offsets.endText-offsets.startText),createHTML&&(html=text),plain=text;else{var deep=0;deep++,createHTML&&(html="<ul><li>"+text+"</li>"),plain=text;do{var nextOptions={numLevels:0};for(item=g.getNextItem(item,g.focusedPane,nextOptions),nextOptions.numLevels>0&&(createHTML&&(html+="<ul>"),deep++);nextOptions.numLevels<0&&deep>=0;)createHTML&&(html+="</ul>"),deep--,nextOptions.numLevels++;if(0>=deep&&(createHTML&&(html+="<ul>"),deep++),item!==endItem)text=item.getParsedText(),createHTML&&(html+="<li>"+text+"</li>");else{var endOffset=g.getSelectOffsetsInSpan(item,item.getSpan(),range);text=item.getParsedText().substring(0,endOffset.endText),createHTML&&(html+="<li>"+text+"</li></ul>"),deep--}plain+="\r\n"+text}while(item!==endItem);for(;deep>0;)createHTML&&(html+="</ul>"),deep--}createHTML&&html&&clipData.setData("text/html",html);var dataType=platform.ie?"Text":"text/plain";clipData.setData(dataType,plain)}}return killEvent(e),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Copy,data:[{value:!0}]}),!1}var self={};return self.init=function initFn(){try{g.PAssert(1318,"complete"===document.readyState||"interactive"===document.readyState,"Setting up copy/paste too early")}catch(PERR){g.reportError(PERR)}document.body.addEventListener("paste",handlepaste,!1),document.body.addEventListener("cut",handlecut,!1),document.body.addEventListener("copy",handlecopy,!1)},self}),define("VMSearch",["ko","globals","platform","data","VMLI","tracker"],function(ko,g,platform,d,VMLI,tracker){function VMSearch(pane,searchStr){this.elSearch=void 0,this.search=ko.observable(searchStr||""),this.isFocused=ko.observable(!1),this.placeholderActive=ko.observable(!0),this.searchLoaded=!1,this.pane=pane,this.searchArr=[],this.matches={},this.hiddenItems={},this.numMatches=ko.observable(0),this.previousSearch="",this.titles=ko.observableArray(),this.initialized=!1,this.isPaneTimeline=pane.mode()==PaneMode.Timeline,this.isSearchBoxSmall=ko.observable(),this.onUpdated=ko.observable()}return VMSearch.prototype={getSearchBox:function getSearchBoxFn(){return this.elSearch},init:function initFn(){try{g.PAssert(1328,!this.initialized)}catch(PERR){g.reportError(PERR)}if(!this.initialized){if(this.pane.showArchived.subscribe(function(newValue){this.updateSearch()}.bind(this)),this.pane.mode.subscribe(function(newValue){this.isPaneTimeline=this.pane.isTimeline()}.bind(this)),window.addEventListener("itemAdded",function(e){if(e.data.force||g.focusedPane.id!==this.pane.id){var match=this.checkItem(e.data.item);match===!0&&this.updateNumMatches(e.data.item,!0)}else g.focusedPane.id===this.pane.id&&this.updateNumMatches(e.data.item,!0)}.bind(this),!0),window.addEventListener("itemTextChanged",function(e){if(e.data.force||g.focusedPane.id!==this.pane.id){var item=e.data.item,oldValue=this.matches[item.id],newValue=this.checkItem(item);(newValue===!0&&oldValue!==!0||newValue!==!0&&oldValue===!0)&&this.updateNumMatches(item,newValue===!0),this.checkChildren(item,!1,!0)}}.bind(this),!0),platform.mobile||window.addEventListener("windowResize",this.checkSearchBoxSize.bind(this)),this.search())this.updateSearch();else{var num=0,includeArchived=this.isPaneTimeline&&this.pane.showArchived();g.searchVMLIs({item:this.pane.item(),includeArchived:includeArchived,each:function eachFn(item){var newNum=this.amountIncrementNumMatches(item,!0);newNum&&(num+=newNum)}.bind(this)}),this.setNumMatches(num)}this.initialized=!0}},onLoad:function onLoadFn(element){this.elSearch=element,this.elSearchWrap=element.parentNode,this.elAutocomplete=g.getElementByClassName("searchAutocomplete",this.elSearchWrap),this.elSearch.addEventListener("focus",this.onfocus.bind(this),!1),this.elSearch.addEventListener("blur",this.onblur.bind(this),!1),this.search()?setTimeout(function(){this.setDisplayText(this.search()),this.searchLoaded=!0}.bind(this),0):setTimeout(function(){this.searchLoaded=!0}.bind(this),0)},checkSearchBoxSize:function checkSearchBoxSizeFn(){try{g.PAssert(1329,!platform.mobile,"Only update search box size on non-mobile platforms")}catch(PERR){g.reportError(PERR)}if(this.isFocused()){var autocompleteBox=this.elAutocomplete.getBoundingClientRect(),box=this.elSearchWrap.getBoundingClientRect(),paneBox=this.pane.scrollElement.getBoundingClientRect();paneBox.right-box.left-10<autocompleteBox.width?(this.elAutocomplete.style.right=0,this.elAutocomplete.style.left="auto"):box.left<40?(this.elAutocomplete.style.left=0,this.elAutocomplete.style.right="auto"):(this.elAutocomplete.style.left="auto",this.elAutocomplete.style.right="auto")}},onfocus:function onfocusFn(){this.isFocused(!0),g.vmMain.setFocusedPane(this.pane),platform.phone?g.sendEvent("SearchFocus","Mobile"):(this.clearPlaceholder(),this.checkSearchBoxSize(),g.sendEvent("SearchFocus","Desktop"))},onblur:function onblurFn(){this.isFocused(!1),g.fireCustomEvent("closeKeyboard"),""===this.getDisplayText()?this.setDisplayText(TextSpace):this.getDisplayText()===TextSpace&&this.setDisplayToPlaceholder(),g.clearSavedSelection("StoredSearch")},focusBox:function focusBoxFn(){g.vmMain.setFocusedPane(this.pane),g.keyboardToolbar&&g.keyboardToolbar.preShow(),this.getSearchBox().focus(),g.enforceScroll(),g.keyboardToolbar&&g.keyboardToolbar.show()},blurBox:function blurBoxFn(){this.getSearchBox().blur()},focusAndSelectEnd:function focusAndSelectEndFn(){this.focusBox(),g.selectElement(this.elSearch,!0)},resetSearch:function resetSearchFn(){this.search(""),this.setDisplayText(TextSpace);for(var item in this.matches)this.updateMatchState(d.getModel(item),void 0,void 0);this.matches[this.pane.item().id]=!1,this.updateSearch()},setSearch:function setSearchFn(text){this.setDisplayText(text||TextSpace),this.search(text),this.updateSearch()},addToSearch:function addToSearchFn(text){if(text){var newText=this.search()+" "+text;this.setDisplayText(newText||TextSpace),this.search(newText),this.updateSearch()}},isSearching:function isSearchingFn(){return this.search().length>0},isShowing:function isShowingFn(){return this.isFocused()||this.isSearching()},isMatched:function isMatchedFn(item){return(void 0===this.matches[item.id]||!!this.matches[item.id])&&-1!==this.matches[item.id]},isVisible:function isVisibleFn(item){return!this.hiddenItems[item.id]},hideItem:function hideItemFn(item,outline){if(outline){var outlineElement=item.getOutlineElement(this.pane.id);outlineElement&&g.addClass(outlineElement,"hidden")}else{var element=item.getElement(this.pane.id);element&&(g.addClass(element,"hidden"),this.hiddenItems[item.id]=!0)}},showItem:function showItemFn(item,outline){if(outline){var outlineElement=item.getOutlineElement(this.pane.id);outlineElement&&g.removeClass(outlineElement,"hidden")}else{var element=item.getElement(this.pane.id);element&&(this.hiddenItems[item.id]=!1,g.removeClass(element,"hidden"))}},updateMatchState:function updateMatchStateFn(item,newValue,outline){var wasChanged=!1;if(item!=this.pane.item.peek()&&item!=g.vmMain.root.peek()){if(item){var oldValue=this.matches[item.id];this.matches[item.id]=newValue,oldValue===newValue||void 0===oldValue&&newValue===!0||(wasChanged=!0,this.isPaneTimeline&&this.pane.notifySearchStateChanged(item,newValue))}return wasChanged}},amountIncrementNumMatches:function amountIncrementNumMatchesFn(item,newValue){return item==this.pane.item.peek()||item==g.vmMain.root.peek()?0:newValue?1:-1},updateNumMatches:function updateNumMatchesFn(item,newValue){var newNum=this.amountIncrementNumMatches(item,newValue);newNum&&this.setNumMatches(this.numMatches()+newNum);try{g.PAssert(1330,this.numMatches()>=0)}catch(PERR){g.reportError(PERR)}},setNumMatches:function setNumMatchesFn(val){var oldValue=this.numMatches();oldValue!==val&&(this.numMatches(val),this.pane.paneContent&&!!oldValue!=!!val&&this.pane.setNoItems(!!val))},isMatch:function isMatchFn(item,lower,s){var found=!0;return s.indexOf("!")>=0&&(found=item.priority()>=VMLIFlag.P2,s.indexOf("!!")>=0&&(found=item.priority()>=VMLIFlag.P1,s.indexOf("!!!")>=0&&(found=item.priority()>=VMLIFlag.P0)),s=s.replace(/!/g,"")),s.indexOf("''")>=0&&found&&(found=item.isFlagged()&&!item.isComplete(),s=s.replace(/\'/g,"")),s.indexOf("//")>=0&&found&&(found=item.isComplete(),s=s.replace(/\//g,"")),s.length>0&&found&&(found=lower.indexOf(s)>=0),found},checkItem:function checkItemFn(item,outline,onLoad){for(var searchRoot=outline?g.vmMain.root.peek():this.pane.item.peek(),isMatch=!0,parent,lower=item.getSearchText(),i=0;i<this.searchArr.length;i++){var termEntry=this.searchArr[i],negate=termEntry.isNegated;if(negate){var s=termEntry.text;try{g.PAssert(1331,s,"Each value in the search array should be valid at this point")}catch(PERR){g.reportError(PERR)}var found=this.isMatch(item,lower,s);if(found){isMatch=-1;break}}}if(isMatch===!0)for(var i=0;i<this.searchArr.length;i++){var termEntry=this.searchArr[i],negate=termEntry.isNegated,s=termEntry.text;try{g.PAssert(1332,s,"Each value in the search array should be valid at this point")}catch(PERR){g.reportError(PERR)}if(!negate){var found=this.isMatch(item,lower,s);if(!found)for(parent=item;parent;){if(parent=parent.parent(),!parent||parent==d.getRootModel()){isMatch=!1;break}if(this.isMatch(parent,parent.getSearchText(),s))break}}if(isMatch!==!0)break}if(isMatch===!0&&item.isLoaded){for(var model=item,oldMatchState=this.matches[item.id],wasChanged=this.updateMatchState(item,!0,outline);model;){if(-1===this.matches[model.id]){this.matches[item.id]=!1;break}if(model.isLoaded&&this.showItem(model,outline),model==searchRoot)break;if(model=model.parent()){if(this.matches[model.id]===!0)break;oldMatchState=this.matches[model.id]}}onLoad&&!outline&&this.search()&&this.updateNumMatches(item,!0)}else if(item.isLoaded){var wasChanged=this.updateMatchState(item,isMatch,outline);this.hideItem(item,outline)}return this.matches[item.id]},checkChildren:function checkChildrenFn(item,countItems,countChanged){var num=this.numMatches();countItems&&(num=0);var includeArchived=this.isPaneTimeline&&this.pane.showArchived();g.searchVMLIs({item:item,includeArchived:includeArchived,each:function eachFn(item){var oldValue=this.matches[item.id],newValue=this.checkItem(item);if(countItems&&newValue===!0||countChanged&&(newValue===!0&&oldValue!==!0||newValue!==!0&&oldValue===!0)){var newNum=this.amountIncrementNumMatches(item,newValue===!0);newNum&&(num+=newNum)}}.bind(this)}),this.setNumMatches(num)},checkChildrenOutline:function checkChildrenOutlineFn(){var includeArchived=this.isPaneTimeline&&this.pane.showArchived();g.searchVMLIs({headers:!0,each:function eachFn(item){this.checkItem(item,!0)}.bind(this)})},updateSearch:function updateSearchFn(force){if(force===!0||this.search()!=this.previousSearch){this.searchLoaded&&g.vmMain.updatePaneState(this.pane);var textArray=this.search().toLowerCase().trim().split(/\s+/);textArray=textArray.filter(function(str){return!(!str||"-"===str)}),this.searchArr=[];for(var i=0;i<textArray.length;++i){var isNegated=textArray[i].startsWith("-"),itemText=isNegated?textArray[i].substr(1):textArray[i];this.searchArr.push({text:itemText,isNegated:isNegated})}this.search()?(this.pane.isSearching=!0,platform.mobile&&this.clearPlaceholder()):(this.pane.isSearching=!1,platform.mobile&&this.setDisplayToPlaceholder()),this.previousSearch=this.search(),this.matches[this.pane.item().id]=!1,this.initialized&&(this.checkChildren(this.pane.item(),!0),this.checkChildrenOutline()),this.onUpdated.valueHasMutated()}},keydown:function keydownFn(item,e){if(e.normCode===KeyCode.Enter)return!1;if(e.normCode===KeyCode.BackSpace){var text=this.getDisplayText();if(""===text||text===TextSpace)return!1;if(e.metaKey)this.setDisplayText(TextSpace);else{var range=g.getSelectionRange();0===range.startOffset&&range.endOffset===text.length&&this.setDisplayText(TextSpace)}}return!0},keyup:function keyupFn(item,e){var text=this.getDisplayText();if(platform.mobile||""!==text||this.setDisplayText(TextSpace),e.normCode===KeyCode.Escape)g.selectElement(this.elSearch,!1);else{var newText=text.replace(TextSpace,"").replace("\n","");this.search(newText),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:[{pane:this.pane.id,text:newText}]});var forceUpdate=e.normCode===KeyCode.Enter;if(this.updateSearch(forceUpdate),platform.mobile||this.checkSearchBoxSize(),e.normCode===KeyCode.Enter)if(platform.android&&g.keyboardToolbar)g.clearSavedSelection("StoredSearch"),g.clearSelection();else if(!g.restoreSavedSelection("StoredSearch",g.focusedPane)){var firstChild=g.focusedItem.getFirstChild();firstChild&&(g.selectChildren(firstChild,0,0),g.scrollIntoView(firstChild.getSpan(),0))}}return!0},insert:function insertFn(ch,withSpace){var range=g.getSelectionRange(),start=range.startOffset;1===start&&this.getDisplayText()===TextSpace&&start--;try{g.PAssert(1333,this.search().indexOf(TextSpace)<0,"TextSpace should never be in the search string")}catch(PERR){g.reportError(PERR)}var text=this.search().replace(TextSpace,"");if(withSpace&&text.length>0){var prevChar=text[start-1];" "!==prevChar&"-"!==prevChar&&(ch=" "+ch)}var len=ch.length,newSearch=text.substr(0,range.startOffset)+ch+text.substr(range.endOffset);this.search(newSearch),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:[{pane:this.pane.id,text:newSearch}]}),this.setDisplayText(newSearch),this.updateSearch(),g.setSelection(this.elSearch,start+len,start+len)},onTapAutocomplete:{onStart:function onStartFn(e){e.preventDefault()}},onTapSearchInsert:{onStart:function onStartFn(e){e.preventDefault()},onClick:function onClickFn(e){var className=e.srcElement.className;switch(0!==className.indexOf("search")&&(className=e.srcElement.parentNode.className),className){case"searchNegate":var range=g.getSelectionRange();if(range.startOffset!==range.endOffset){var start=range.startOffset,end=range.endOffset;this.getDisplayText[0]===TextSpace&&(start>0&&start--,end--);var sText=this.search();if("-"!==sText[start]){var newText=sText.substring(0,start)+"-"+sText.substring(start);this.setSearch(newText),g.setSelection(this.elSearch,start,end+1)}else{var newText=sText.substring(0,start)+sText.substring(start+1);this.setSearch(newText),g.setSelection(this.elSearch,start,Math.max(0,end-1))}}else this.insert("-",!0);break;case"searchP2":this.insert("!",!0);break;case"searchP1":this.insert("!!",!0);break;case"searchP0":this.insert("!!!",!0);break;case"searchFlagged":this.insert("''",!0);break;case"searchComplete":this.insert("//",!0)}g.sendEvent("Menu",className)}},requestFocusBoxForEvent:function requestFocusBoxForEventFn(e){var activeElement=document.activeElement;activeElement&&"searchPhone"==activeElement.id||(this.open(),e.preventDefault())},onTapBox:{onClick:function onClickFn(e){platform.mobile?(g.phoneMenu.activeScreen()!==Screens.Settings&&g.phoneMenu.mode()==g.phoneMenu.Modes.Normal&&this.open()&&e.stopImmediatePropagation(),e.preventDefault()):this.requestFocusBoxForEvent(e)}},onTapX:{onStart:function onStartFn(e){e.handled=!0,e.preventDefault()},onClick:function onClickFn(e){this.isSearchActive()?(this.resetSearch(),e.preventDefault(),g.sendEvent("Menu","ClearSearch")):(this.requestFocusBoxForEvent(e),g.sendEvent("Menu","FocusSearch"))}},isSearchActive:function isSearchActiveFn(){return 0!==this.search().length},getTitleText:function getTitleTextFn(){return this.isSearchActive()?"Clear Search":"Search"},getSearchIcon:function getSearchIconFn(){return this.isSearchActive()?"icon-remove":"icon-search"},open:function openFn(){return this.isFocused()?void 0:(platform.mobile?this.focusAndSelectEnd():this.focusBox(),!0)},getDisplayText:function getDisplayTextFn(){return this.elSearch.textContent},setDisplayText:function setDisplayTextFn(text){try{g.PAssert(1334,void 0!==text&&""!==text||platform.mobile,"Search text should always be defined, either with a TextSpace or actual text")}catch(PERR){g.reportError(PERR)}this.elSearch.textContent=text,this.placeholderActive(text===TextSpace&&platform.mobile?!0:!1)},setDisplayToPlaceholder:function setDisplayToPlaceholderFn(){this.placeholderActive(!0),this.elSearch.textContent=TextSpace},clearPlaceholder:function clearPlaceholderFn(){this.placeholderActive(!1)}},VMSearch}),define("VMTitle",["ko","globals","data","tracker","platform"],function(ko,g,d,tracker,platform){function VMTitle(p){this.text=p.text,this.item=p.item,this.home=p.home,this.isTruncated=ko.observable(!1),this.pane=p.pane,this.init(p)}return VMTitle.prototype={init:function initFn(){this.text=this.item.getParsedText(),this.text.length>25&&(this.text=this.text.substr(0,25),this.isTruncated(!0))},onTap:{onStart:function onStartFn(e){e.handled=!0,g.vmMain.setFocusedPane(this.pane)},onClick:function onClickFn(e){g.focusedPane.onTapTitle.onClick.call(g.focusedPane,e,this.item)}}},VMTitle}),define("VMTimelineBlock",["ko","globals","data","VMLI"],function(ko,g,d,VMLI){function VMTimelineBlock(p){this.owner=p.owner,this.date=p.date,this.dateKey=p.dateKey,this.text=p.text,this.name=p.name,this.searchProvider=void 0,this.items=ko.observableArray(),this.searchCount=ko.observable(0),this.hasDeferredUpdate=!1,this.element=void 0,this.timeCount=ko.observable(0),this.isFlagged=p.isFlagged,this.isImportant=p.isImportant,this.isToday=!1,this.init(p)}return VMTimelineBlock.prototype={showBlock:function showBlockFn(){return this.items().length>0&&this.searchCount()>0},specialClass:function specialClassFn(){return this.isFlagged?"flaggedBlock":this.isImportant?"importantBlock":this.isToday||this.isNow?"todayBlock":void 0},showTime:function showTimeFn(ctx){var item=ctx.$data,index=ctx.$index;if(this.isNow)return!1;var tempValue=this.searchProvider.onUpdated();if(0===this.timeCount()||this.isFlagged||this.isImportant||!this.searchProvider.isVisible(item))return!1;for(var previousVisible=index()-1;previousVisible>0&&!this.searchProvider.isVisible(this.items()[previousVisible]);)previousVisible--;if(0>previousVisible)return!0;var prevItem=this.items()[previousVisible];if(item.hasTime()){if(0===this.compareDate(prevItem,item))return!1}else if(!prevItem.hasTime())return!1;return!0},processDeferredUpdates:function processDeferredUpdatesFn(){this.hasDeferredUpdate&&(this.hasDeferredUpdate=!1)},init:function initFn(p){try{g.PAssert(1335,this.date)}catch(PERR){g.reportError(PERR)}if(this.dateKey||(this.dateKey=this.date.clone().clearTime().getTime(),p.name&&(this.dateKey=this.dateKey+p.name)),this.name)this.text=this.name.toUpperCase(),"NOW"==this.name&&(this.isNow=!0);else{if(this.text="",this.date){var timeDiff=Math.floor((this.date-Date.today())/864e5);switch(timeDiff){case-1:this.text="YESTERDAY ";break;case 0:this.text="TODAY ",this.isToday=!0;break;case 1:this.text="TOMORROW ";break;default:this.text=this.date.toString("dddd").toUpperCase()}}this.text=this.text+" "+this.date.toString("M/d")}},comparePriority:function comparePriorityFn(left,right){var lPri=left.priority(),rPri=right.priority();return lPri>rPri?-1:rPri>lPri?1:0},compareDate:function compareDateFn(left,right){if(left.isComplete()&&!right.isComplete())return-1;if(!left.isComplete()&&right.isComplete())return 1;if(left.isComplete()&&right.isComplete())return left.dateCompleted>right.dateCompleted?1:-1;if(left.date()&&!right.date())return-1;if(!left.date()&&right.date())return 1;var leftDate=new Date(left.date()),leftTime=leftDate.toString("h:mmtt"),rightDate=new Date(right.date()),rightTime=rightDate.toString("h:mmtt");return"12:00am"!=leftTime&&"12:00am"!=rightTime?isNaN(leftDate.getYear())||isNaN(rightDate.getYear())?0:Date.compare(leftDate,rightDate):"12:00am"!=leftTime?-1:"12:00am"!=rightTime?1:0},compareOrder:function compareOrderFn(left,right){var first=g.getFirstItem(left,right);try{g.PAssert(1336,void 0!==first)}catch(PERR){g.reportError(PERR)}return first.id==left.id?-1:1},compareItems:function compareItemsFn(left,right){var cDate=this.isFlagged||this.isImportant?0:this.compareDate(left,right);if(0===cDate){var cPriority=this.isFlagged?0:this.comparePriority(left,right);if(0===cPriority){var cOrder=this.compareOrder(left,right);try{g.PAssert(1337,0!==cOrder,"This should always result in a tie break")}catch(PERR){g.reportError(PERR)}return cOrder}return cPriority}return cDate},addItem:function addItemFn(item){return this.items.indexOf(item)>=0?void this.updateItem(item):(this.searchProvider.isMatched(item)&&(this.searchCount(this.searchCount()+1),item.hasTime()&&this.timeCount(this.timeCount()+1)),void(this.owner.deferModelUpdates?(this.items().insertSorted(item,this.compareItems.bind(this)),this.hasDeferredUpdate=!0):this.items.insertSorted(item,this.compareItems.bind(this))))},removeItem:function removeItemFn(item){this.searchProvider.isMatched(item)&&(this.searchCount(this.searchCount()-1),item.hasTime()&&this.timeCount(this.timeCount()-1)),this.owner.deferModelUpdates?(this.items().remove(item),this.hasDeferredUpdate=!0):this.items.remove(item)},updateItem:function updateItemFn(item){this.owner.deferModelUpdates?(this.items().remove(item),this.items().insertSorted(item,this.compareItems.bind(this)),this.hasDeferredUpdate=!0):(this.items.remove(item),this.items.insertSorted(item,this.compareItems.bind(this)));for(var timeCount=0,i=0;i<this.items().length;i++)this.items()[i].hasTime()&&timeCount++;this.timeCount(timeCount)},onLoad:function onLoadFn(element){this.element=element},notifySearchStateChanged:function notifySearchStateChangedFn(item,newValue){try{g.PAssert(1338,void 0!==newValue||this.searchProvider,"Must supply a value or a valid search provider")}catch(PERR){g.reportError(PERR)}void 0===newValue&&(newValue=this.searchProvider.isMatched(item)),newValue===!0?(this.searchCount(this.searchCount()+1),item.hasTime()&&this.timeCount(this.timeCount()+1)):(this.searchCount(this.searchCount()-1),item.hasTime()&&this.timeCount(this.timeCount()-1))},setSearchProvider:function setSearchProviderFn(vmSearch){this.searchProvider=vmSearch}},VMTimelineBlock}),define("VMPane_Timeline",["ko","globals","data","VMTimelineBlock"],function(ko,g,d,VMTimelineBlock){var VMPane_Timeline={initTimeline:function initTimelineFn(){this.blocks=ko.observableArray(),this.blockImportant=void 0,this.blockStarred=void 0,this.days={},this.updateNextTimeout=0,this.datesByItem={},this.flaggedItems={},this.priorityItems={},this.isLoading=!1,this.deferModelUpdates=0;var self=this;this.showArchived.subscribe(function(newValue){self.reloadTimeline()})},hasBlocks:function hasBlocksFn(){for(var count=0,i=0;i<this.blocks().length;i++)count+=this.blocks()[i].searchCount();return count>0},reasonEmpty:function reasonEmptyFn(){return this.vmSearch&&this.vmSearch.search().length>0?"No search results":"Nothing on the agenda"},blockCompare:function blockCompareFn(left,right){return left.isNow&&right.isToday?-1:left.isToday&&right.isNow?1:Date.compare(left.date,right.date)},removeDate:function removeDateFn(item){var vmDate=this.datesByItem[item.id];vmDate.removeItem(item),this.datesByItem[item.id]=void 0},addBlock:function addBlockFn(block){block.setSearchProvider(this.vmSearch),this.deferModelUpdates?this.blocks().insertSorted(block,this.blockCompare):this.blocks.insertSorted(block,this.blockCompare)},dumpBlocks:function dumpBlocksFn(){log("Dump Timeline Blocks:");for(var i=0;i<this.blocks().length;++i){var block=this.blocks()[i];log("  Block: ",block.text),log("  Count: ",block.searchCount);for(var j=0;j<block.items().length;++j){var item=block.items()[j];log("    Item: ",item.getParsedText())}}},findNextBlock:function findNextBlockFn(){for(var now=new Date,i=0;i<this.blocks().length;i++){var block=this.blocks()[i];if(block.isToday||block.isFlagged||block.isImportant||block.date>now)return block}},hideDescendants:function hideDescendantsFn(parent){for(var i=0;i<parent.items().length;i++){var item=parent.items()[i];this.datesByItem[item.id]&&this.removeDate(item),this.flaggedItems[item.id]&&(this.blockStarred.removeItem(item),this.flaggedItems[item.id]=void 0),this.priorityItems[item.id]&&(this.blockImportant.removeItem(item),this.priorityItems[item.id]=void 0),item.items().length>0&&this.hideDescendants(item)}},notifyDescendants:function notifyDescendantsFn(parent){for(var i=0;i<parent.items().length;i++){var item=parent.items()[i];this.notifyStateChanged(item),item.items().length>0&&this.notifyDescendants(item)}},notifyPositionChanged:function notifyPositionChangedFn(item){this.mode()===PaneMode.Timeline&&(this.isLoading||(this.datesByItem[item.id]&&this.datesByItem[item.id].updateItem(item),this.flaggedItems[item.id]&&this.blockStarred.updateItem(item),this.priorityItems[item.id]&&this.blockImportant.updateItem(item)))},notifySearchStateChanged:function notifySearchStateChangedFn(item,newValue){this.mode()===PaneMode.Timeline&&(this.isLoading||(this.datesByItem[item.id]&&this.datesByItem[item.id].notifySearchStateChanged(item,newValue),this.flaggedItems[item.id]&&this.blockStarred.notifySearchStateChanged(item,newValue),this.priorityItems[item.id]&&this.blockImportant.notifySearchStateChanged(item,newValue)))},notifyStateChanged:function notifyStateChangedFn(item,changeType){if(this.mode()===PaneMode.Timeline&&!this.isLoading&&!item.hasCompletedAncestor()){var dataItem=d.getItem(item.id);try{g.PAssert(1339,!dataItem||!!dataItem.isDeleted==!!item.isDeleted||g.isDemoMode(),"isDeleted should match loaded item and item info")}catch(PERR){g.reportError(PERR)}if(this.vmSearch.checkItem(item),dataItem&&dataItem.isDeleted){var block=this.datesByItem[item.id];block&&block.removeItem(item),item.isImportant()&&this.updateSpecialBlock(item,this.priorityItems,this.blockImportant,!1),item.isFlagged()&&this.updateSpecialBlock(item,this.flaggedItems,this.blockStarred,!1)}else{if(!changeType||g.isAtLeastOneFlagSet(changeType,PropChangeType.Date|PropChangeType.Complete|PropChangeType.Archive))if(item.date()||item.isComplete()){var date=item.date()?item.date():item.dateCompleted;this.dateUpdated(item,date)}else{var oldBlock=this.datesByItem[item.id];oldBlock&&this.removeDate(item)}g.isAtLeastOneFlagSet(changeType,PropChangeType.Complete|PropChangeType.Archive)&&(item.isComplete()||item.isArchived()?this.hideDescendants(item):this.notifyDescendants(item)),(!changeType||g.isAtLeastOneFlagSet(changeType,PropChangeType.Priority|PropChangeType.Complete|PropChangeType.Archive))&&this.updateSpecialBlock(item,this.priorityItems,this.blockImportant,item.isImportant()&&!item.isComplete()),(!changeType||g.isAtLeastOneFlagSet(changeType,PropChangeType.Flagged|PropChangeType.Complete|PropChangeType.Archive))&&this.updateSpecialBlock(item,this.flaggedItems,this.blockStarred,item.isFlagged()&&!item.isComplete())}}},updateSpecialBlock:function updateSpecialBlockFn(item,items,block,matches){!matches||item.isDeleted||item.isArchived()&&!this.showArchived()?items[item.id]&&(block.removeItem(item),items[item.id]=void 0):items[item.id]?block.updateItem(item):(block.addItem(item),items[item.id]=item)},dateUpdated:function dateUpdatedFn(item,date,skipSort){if(this.mode()===PaneMode.Timeline&&!this.isLoading){if(item.isArchived()&&!this.showArchived())return void(this.datesByItem[item.id]&&this.removeDate(item));if(this.vmSearch.checkItem(item),date){var dateKey,isSoft=g.isDateSoft(item.dateText);dateKey=isSoft?item.dateText.toUpperCase():date.clone().clearTime().getTime();var vmDate=this.days[dateKey];if(!vmDate&&!this.days[dateKey]){var options={owner:this,date:date.clone().clearTime(),dateKey:dateKey};isSoft&&(options.name=dateKey);var vmDate=new VMTimelineBlock(options);this.days[dateKey]=vmDate,this.addBlock(vmDate,skipSort)}if(vmDate){var oldEntry=this.datesByItem[item.id];oldEntry?oldEntry.dateKey!==dateKey&&(this.removeDate(item),this.datesByItem[item.id]=vmDate):this.datesByItem[item.id]=vmDate,this.days[dateKey].addItem(item)}}else this.datesByItem[item.id]&&this.removeDate(item)}},ensureSpecialBlocks:function ensureSpecialBlocksFn(){this.blockStarred||(this.blockStarred=new VMTimelineBlock({owner:this,name:"Flagged",date:Date.today().add({hour:1}),isFlagged:!0}),this.addBlock(this.blockStarred)),this.blockImportant||(this.blockImportant=new VMTimelineBlock({owner:this,name:"Important",date:Date.today().add({hour:2}),isImportant:!0}),this.addBlock(this.blockImportant))},loadTimeline:function loadTimelineFn(){try{g.PAssert(1340,this.mode()==PaneMode.Timeline)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1341,0===this.blocks().length,"When loading the timeline we expect it to be empty")}catch(PERR){g.reportError(PERR)
}this.setDeferUpdates(!0),this.ensureSpecialBlocks(),g.searchVMLIs({item:this.item(),includeArchived:this.showArchived(),each:this.notifyStateChanged.bind(this)}),this.setDeferUpdates(!1),this.vmSearch.onUpdated.valueHasMutated()},unloadTimeline:function unloadTimelineFn(){this.datesByItem={},this.flaggedItems={},this.priorityItems={},this.days={},this.deferModelUpdates?this.blocks().splice(0,this.blocks().length):this.blocks([]),this.blockStarred=void 0,this.blockImportant=void 0},reloadTimeline:function reloadTimelineFn(){this.mode()===PaneMode.Timeline&&(this.reloading=!0,this.unloadTimeline(),this.loadTimeline(),this.reloading=!1)},setDeferUpdates:function setDeferUpdatesFn(value){try{g.PAssert(1343,this.mode()==PaneMode.Timeline)}catch(PERR){g.reportError(PERR)}this.deferModelUpdates+=value?1:-1;try{g.PAssert(1344,this.deferModelUpdates>=0,"Mismatching defer update calls")}catch(PERR){g.reportError(PERR)}if(0===this.deferModelUpdates){for(var numBlocks=this.blocks().length,i=0;numBlocks>i;++i)this.blocks()[i].processDeferredUpdates();this.blocks.valueHasMutated()}},startLoading:function startLoadingFn(){if(this.mode()===PaneMode.Timeline){try{g.PAssert(1345,!this.isLoading,"Should only notify the timeline a single time when loading starts")}catch(PERR){g.reportError(PERR)}this.isLoading=!0}},endLoading:function endLoadingFn(){if(this.mode()===PaneMode.Timeline){try{g.PAssert(1346,this.isLoading,"Must have started loading the timeline to stop loading it")}catch(PERR){g.reportError(PERR)}this.isLoading=!1,this.setDeferUpdates(!0),this.reloadTimeline(),this.setDeferUpdates(!1)}}};return VMPane_Timeline}),define("VMOutline",["ko","globals","data","gdata","VMSearch","platform","tracker"],function(ko,g,d,gdata,VMSearch,platform,tracker){function VMOutline(pane){this.pane=pane,this.root=g.vmMain.root(),platform.mobile||(this.isVisible=ko.observable(!1)),this.init()}return VMOutline.prototype={init:function initFn(){g.outline=this,platform.mobile&&g.ScreenManager.addScreen(this,Screens.Outline)},getTopElement:function getTopElementFn(){return document.getElementsByClassName("paneOutline")[0]},onTap:{onStart:function onStartFn(e){g.ScreenManager.checkSwipeStart(e)},onMove:function onMoveFn(e){g.ScreenManager.checkSwipeMove(e)},onClick:function onClickFn(e){if(!(platform.mobile&&g.ScreenManager.checkSwipeClick(e)||!g.hasClass(e.srcElement,"outlineText")&&!g.hasClass(e.srcElement.parentElement,"outlineText"))){var item=ko.dataFor(e.srcElement);platform.mobile||g.vmMain.setFocusedPane(this.pane),g.vmMain.zoomin(item),platform.mobile?g.ScreenManager.scrollToScreen(Screens.List):g.focusedPane.toggleOutlineVisibility(),e.preventDefault(),g.sendEvent("Menu","OutlineZoom")}},onEnd:function onEndFn(e){g.ScreenManager.checkSwipeEnd(e)}},onTapCollapse:{onStart:function onStartFn(e){if(g.hasClass(e.srcElement,"outlineArrow")){var li=e.srcElement.parentNode;g.hasClass(li,"collapsed")?(g.removeClass(li,"collapsed"),g.sendEvent("Menu","OutlineMinimize")):(g.addClass(li,"collapsed"),g.sendEvent("Menu","OutlineMaximize")),e.handled=!0,e.preventDefault()}}},onScreenStartOpen:function onScreenStartOpenFn(){},onScreenOpen:function onScreenOpenFn(){g.isKeyboardOpen&&!g.vmSearchPhone.isFocused()&&g.blurActiveElement(),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOutline,data:{element:this.getTopElement(),value:!0}})},onScreenUpdate:function onScreenUpdateFn(diff){},onScreenClose:function onScreenCloseFn(){tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOutline,data:{element:this.getTopElement(),value:!1}})},toggleDesktop:function toggleDesktopFn(){var paneWidth=g.width(this.pane.element),time=150;this.isVisible()?(g.setTransform(this.pane.outlineElement,1*-paneWidth,0,time,"ease-out"),g.setTransform(this.pane.paneContent,0,0,time,"ease-out"),setTimeout(function(){this.isVisible(!this.isVisible()),this.pane.outlineElement.style.visibility="hidden"}.bind(this),time)):(this.isVisible(!this.isVisible()),this.pane.outlineElement.style.visibility="visible",g.setTransform(this.pane.outlineElement,1*-paneWidth,0),requestAnimationFrame(function(){g.setTransform(this.pane.outlineElement,0,0,time,"ease-in-out"),g.setTransform(this.pane.paneContent,paneWidth,0,time,"ease-in-out")}.bind(this))),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOutline,data:{element:this.getTopElement()}})}},g.VMOutline=VMOutline,VMOutline}),define("VMPane",["ko","globals","android","data","gdata","VMSearch","VMTitle","edit","VMLI","tracker","VMPane_Timeline","VMOutline","platform"],function(ko,g,android,d,gdata,VMSearch,VMTitle,edit,VMLI,tracker,VMPane_Timeline,VMOutline,platform){function VMPane(p){this.id=p.id,this.item=ko.observable(p.item),this.mode=ko.observable(p.mode||PaneMode.Normal),this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.titleMenu=void 0,this.vmSearch=void 0,this.titles=ko.observableArray(),this.showArchived=ko.observable(!1),this.reloading=!1,this.width=-1,this.initialOffset=p.offset,this.defaultOffset=platform.mobile?50:0,platform.mobile?(g.vmSearchPhone=this.vmSearch=new VMSearch(this,p.search),this.outline=g.vmMain.outline=new VMOutline(this)):(this.vmSearch=new VMSearch(this,p.search),this.outline=new VMOutline(this)),this.initTimeline(),this.init(p)}return VMPane.prototype={init:function initFn(p){this.vmSearch.init(),this.mode.subscribe(this.onModeChanged,this),platform.mobile&&g.ScreenManager.addScreen(this,Screens.List),this.updateContents()},getScroller:function getScrollerFn(){return platform.bodyscroll?document.body:this.scrollElement},getScrollOffset:function getScrollOffsetFn(){var sOffset=0;return platform.bodyscroll?sOffset=document.body.scrollTop:this.scrollElement&&(sOffset=this.scrollElement.scrollTop),sOffset},setScrollOffset:function setScrollOffsetFn(offset){try{g.PAssert(1347,this.scrollElement,"Pane must have loaded a scrollable element")}catch(PERR){g.reportError(PERR)}void 0===offset&&(offset=this.defaultOffset),g.scrollTo(offset,0,this.scrollElement)},setMode:function setModeFn(mode){this.mode(mode),g.sendEvent("Menu","PaneModeSwitchTo",mode),modeChanged=!0,g.vmMain.updatePaneState(this),this.vmSearch.updateSearch(!0)},getTopElement:function getTopElementFn(){return this.element},trackDOM:function trackDOMFn(){return!0},templateName:function templateNameFn(pane,b){return pane.mode()===PaneMode.Normal?"template-pane-normal":pane.mode()===PaneMode.Timeline?"template-pane-timeline":void 0},itemHasChildren:function itemHasChildrenFn(){return this.item().items().length>0},isTimeline:function isTimelineFn(){return this.mode()==PaneMode.Timeline},onModeChanged:function onModeChangedFn(newValue){newValue===PaneMode.Timeline?this.loadTimeline():this.unloadTimeline(),(platform.ios||platform.ie)&&this.setupFocusEvents()},setupFocusEvents:function setupFocusEventsFn(){if(platform.phone&&(log("setting up focus"),platform.ios)){try{g.PAssert(1348,!android.isEnabled(),"Android sets up its own focus/blur events in android.js")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1349,!platform.ie,"IE does not rely on focus/blur events to be fired")}catch(PERR){g.reportError(PERR)}this.paneContent.addEventListener("textInput",edit.onTextInput,!1)}},onLoad:function onLoadFn(e){if(g.hasClass(e,"pane"))this.element=e,platform.mobile&&(this.itemMenuPhone=g.element("itemMenuPhone"),this.rightMenuPhone=g.element("rightMenuPhone"));else{this.paneContent=e,this.rootElement=e.parentElement,this.scrollElement=this.rootElement.parentElement,this.outlineElement=this.scrollElement.previousElementSibling;try{g.PAssert(1351,g.hasClass(this.rootElement,"paneRoot"))}catch(PERR){g.reportError(PERR)}try{g.PAssert(1352,g.hasClass(this.paneContent,"paneContent"))}catch(PERR){g.reportError(PERR)}!platform.android&&!platform.mobileie||platform.script||android.setPaneRoot(this),window.addEventListener("windowResize",function(e){this.width=g.width(this.element)}.bind(this)),setTimeout(function(){if(this.width=g.width(this.element),(platform.ios||platform.ie)&&this.setupFocusEvents(),this.mode()===PaneMode.Normal&&isNaN(this.initialOffset))this.initialOffset=this.defaultOffset;else if(this.mode()===PaneMode.Timeline){var block=this.findNextBlock();this.initialOffset=block&&block.element?platform.mobile?block.element.getBoundingClientRect().top:block.element.getBoundingClientRect().top-this.scrollElement.getBoundingClientRect().top-25:0}0!==this.initialOffset&&this.setScrollOffset(this.initialOffset)}.bind(this),0),platform.ios&&(this.scrollElement.onscroll=function(e){return Math.abs(this.scrollElement.scrollTop-g.scrollAtTouchStart)>100&&(g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0),g.startDrag=void 0),0===this.scrollElement.scrollTop?(e.preventDefault(),e.stopImmediatePropagation(),!1):!0}.bind(this)),this.setNoItems(!!this.vmSearch.numMatches())}},setNoItems:function setNoItemsFn(turnOff){turnOff?g.removeClass(this.paneContent,"noItems"):g.addClass(this.paneContent,"noItems")},getWidth:function getWidthFn(){return this.width},toggleOutlineVisibility:function toggleOutlineVisibilityFn(){try{g.PAssert(1353,this.outline,"Outline must exist")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1354,this.outlineElement,"Outline element must be valid")}catch(PERR){g.reportError(PERR)}this.outline.toggleDesktop()},updateContents:function updateContentsFn(){this.mode()==PaneMode.Normal||this.mode()===PaneMode.Timeline&&this.reloadTimeline(),this.updateTitles()},notifyOfZoom:function notifyOfZoomFn(){this.updateContents(),this.vmSearch.updateSearch(!0)},updateTitles:function updateTitlesFn(){var parents=this.item().parents();this.titles.removeAll();for(var i=0;i<parents.length;i++){var title=new VMTitle({item:parents[i],pane:this});this.titles.push(title)}},keydown:function keydownFn(element,e){if(android.isEnabled()&&!android.passKeydown(e))return!0;if(g.autocomplete&&!g.autocomplete.onkeydown(e))return!1;try{return edit.keydown(element,e)}catch(err){g.reportError(err,e)}},keypress:function keypressFn(element,e){if(android.isEnabled()&&!android.passKeypress(e))return!0;try{return edit.keypress(element,e)}catch(err){g.reportError(err,e)}},keyup:function keyupFn(element,e){if(android.isEnabled())return android.checkAndroidBounds(),!0;try{return edit.keyup(element,e)}catch(err){g.reportError(err,e)}},addItemToPane:function addItemToPaneFn(text,index){var target=this.item();text||(text=""),tracker.beginAction();var item=new VMLI({text:text},{parent:target,forceSave:!0});return target.insertItem(item,index),tracker.performAction(TrackerType.Create,{itemID:item.id,parent:target.id,position:isNaN(index)?target.items().length-1:index,text:text}),tracker.endAction(),item},onTapTitle:{onClick:function onClickFn(e,item){var oldItem=g.focusedItem;return platform.ios||item==this.item()&&this.vmSearch.resetSearch(),this.titles().length<=1?void(this.outline.isVisible()&&this.toggleOutlineVisibility()):(g.vmMain.zoomout(item,oldItem),void g.sendEvent("Menu","Title"))}},onTap:{onStart:function onStartFn(e){if(!platform.mobile||!g.ScreenManager.checkSwipeStart(e)){if(platform.phone,g.menus&&g.phoneMenu&&(g.menus.startedInMultiSelectMode=g.phoneMenu.multiSelectMode()),g.vmMain.setFocusedPane(this),platform.isTouchDevice&&!platform.app&&(!platform.ie||platform.mobileie)&&!platform.bodyscroll){var ele=this.scrollElement;if(!g.preventScrollPropagation(ele))return e.preventDefault(),!1}if(!android.isEnabled()||!android.isTargetBox(e)){var target=ko.dataFor(e.srcElement);platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item())),target&&target.onStart&&target.onStart(e)}}},onMove:function onMoveFn(e){g.autocomplete&&platform.mobile&&g.autocomplete.hide(),g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0);var sendMove=!0;if(platform.mobile&&(g.menus.startedInMultiSelectMode||(sendMove=!g.ScreenManager.checkSwipeMove(e))),sendMove&&(!android.isEnabled()||!android.isTargetBox(e))){var target=ko.dataFor(e.startSrc);platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item())),target&&target.onMove&&target.onMove(e)}return!1},onClick:function onClickFn(e){if(!(platform.mobile&&g.ScreenManager.checkSwipeClick(e)||android.isEnabled()&&android.isTargetBox(e))){var target=ko.dataFor(e.startSrc);platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item())),target&&target.onClick?target.onClick(e):g.hasClass(this.paneContent,"noItems")&&!g.hasClass(this.paneContent,"loading")?this.addItem(e):e.preventDefault()}},onEnd:function onEndFn(e){if(!(platform.mobile&&g.ScreenManager.checkSwipeEnd(e)||android.isEnabled()&&android.isTargetBox(e))){var target=ko.dataFor(e.startSrc);if(platform.mobile&&target==this&&(target=g.getLastVisibleItem(g.focusedPane.item())),!target)return;"paneContent"===e.startSrc.id&&(e.preventDefault(),platform.ios&&g.preventClick()),target&&target.onEnd&&target.onEnd(e)}},onDblClick:function onDblClickFn(e){if(this.isTimeline()){var target=ko.dataFor(e.startSrc);target&&target.onDblClick&&target.onDblClick(e)}},onRightClick:function onRightClickFn(e){if(!g.isDisplayModeActive(DisplayMode.NoRightClick)){if(g.vmMain.setFocusedPaneFromElement(e.srcElement),!android.isEnabled()||!android.isTargetBox(e)){var target=ko.dataFor(e.srcElement);target&&target.onRightClick&&target.onRightClick(e)}tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.RightClick,data:{element:void 0}})}}},addItem:function addItemFn(e){var item=this.addItemToPane("",0);platform.mobileie&&android.isEnabled()?android.updateInput(item):g.selectChildren(item,0,0),platform.mobile&&g.openKeyboardOn(e,item.getSpan(),!0),g.sendEvent("Menu","AddItemButton")},onTapAddItem:{onStart:function onStartFn(e){e.preventDefault(),e.stopImmediatePropagation()},onClick:function onClickFn(e){this.addItem(e)}},onTapOutlineButton:function onTapOutlineButtonFn(e){this.toggleOutlineVisibility(),this.outline.isVisible()?g.sendEvent("Menu","OpenOutline"):g.sendEvent("Menu","CloseOutline")},onTapSwitchList:function onTapSwitchListFn(){var oldMode=this.setMode(PaneMode.Normal);tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.SwitchPaneMode,data:{from:oldMode,to:PaneMode.Normal}}),g.sendEvent("Menu","SwitchPaneMode")},onTapSwitchTimeline:function onTapSwitchTimelineFn(){var oldMode=this.setMode(PaneMode.Timeline);tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.SwitchPaneMode,data:{from:oldMode,to:PaneMode.Timeline}}),g.sendEvent("Menu","SwitchPaneMode")},onTapClosePane:function onTapClosePaneFn(){if(g.vmMain.panes().length>1){var index=g.vmMain.removePane(this);tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:index}),g.sendEvent("Menu","ClosePane"),g.tooltip.hideTip()}},onTapArchiveCompleted:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){this.archiveCompleted(),g.sendEvent("Menu","ArchiveCompleted")}},archiveCompleted:function archiveCompletedFn(){var archivedItems=[];g.searchVMLIs({item:this.item(),includeArchived:!1,comparator:function comparatorFn(item){return item.isComplete()},action:function actionFn(item){archivedItems.push(item)}}),tracker.beginAction();for(var i=archivedItems.length-1;i>=0;i--){var item=archivedItems[i];item.parent().archiveChild(item)}if(tracker.endAction(),archivedItems.length>0){var z=archivedItems.length>1?" items.":" item.";g.messageQueue.pushMessage({text:"Successfully archived "+archivedItems.length+z,type:MessageType.Info,action:MessageAction.Default,timeout:2e3})}g.sendEvent("Menu","ArchiveCompleted")},onTapViewArchived:function onTapViewArchivedFn(){if(this.mode()===PaneMode.Timeline)this.showArchived(!this.showArchived()),g.vmMain.updatePaneState(this),g.sendEvent("Menu","ShowArchivedTimeline");else if(this.mode()===PaneMode.Normal){var unarchivedItems=[];g.searchVMLIs({item:this.item(),includeArchived:!0,comparator:function comparatorFn(item){return item.isArchived()},action:function actionFn(item){unarchivedItems.push(item)}});for(var i=0;i<unarchivedItems.length;++i){var item=unarchivedItems[i];item.parent().unarchiveChild(item)}g.sendEvent("Menu","UnarchiveItems")}},onScreenOpen:function onScreenOpenFn(){},onScreenClose:function onScreenCloseFn(){}},g.extend(VMPane.prototype,VMPane_Timeline),VMPane}),define("VMMain_DragDrop",["ko","globals","platform","tracker","VMPane","VMLI"],function(ko,g,platform,tracker,VMPane,VMLI){var VMMain_DragDrop=function(self){function removePreviousDragEffect(){previousHighlightElement&&(g.removeClass(previousHighlightElement,"itemDraggingAbove"),g.removeClass(previousHighlightElement,"itemDraggingBelow"))}function handleReaderLoad(evt){log(evt.target.result)}function handleDropFiles(e){var file=e.dataTransfer.files[0],reader=new FileReader;reader.onload=handleReaderLoad,reader.readAsDataURL(file)}var activePane=void 0,previousEventTarget=void 0,previousDropTarget=void 0,previousHighlightElement=void 0,previousDragClass=void 0,previousWasPane=!1;self.handleDragOver=function handleDragOverFn(e){if(previousEventTarget!==e.srcElement){e.srcElement&&(activePane=g.getPaneForElement(e.srcElement));var eventTarget=e.srcElement;if(!eventTarget||!activePane||"SPAN"!==eventTarget.tagName&&"P"!==eventTarget.tagName&&"LI"!==eventTarget.tagName&&"UL"!==eventTarget.tagName);else{removePreviousDragEffect();var pane=g.getPaneForElement(eventTarget);try{g.PAssert(1357,pane,"Must have a valid pane to update our drag target on")}catch(PERR){g.reportError(PERR)}var currentDropTarget=ko.dataFor(eventTarget);try{g.PAssert(1358,currentDropTarget,"Should always have a valid drop target")}catch(PERR){g.reportError(PERR)}var highlightAbove=void 0,isPane=!1;currentDropTarget instanceof VMPane?(isPane=!0,currentDropTarget=previousDropTarget?previousDropTarget:g.getLastPaneItem(currentDropTarget),highLightAbove=e.diffY<0?!0:!1):currentDropTarget instanceof VMLI?pane.isTimeline()||!currentDropTarget.isFullscreen()&&"LI"!==eventTarget.tagName?highlightAbove=!0:previousDropTarget&&(currentDropTarget=previousDropTarget,highlightAbove=e.diffY<0||previousWasPane?!0:!1):currentDropTarget=self.getDropItem(e);try{g.PAssert(1359,currentDropTarget,"Should always have a valid drop target")}catch(PERR){g.reportError(PERR)}previousHighlightElement=pane.isTimeline()?void 0:currentDropTarget.getSpan(pane.id),previousDragClass=highlightAbove?"itemDraggingAbove":"itemDraggingBelow",pane.isTimeline()||g.addClass(previousHighlightElement,previousDragClass);try{g.PAssert(1360,!(currentDropTarget instanceof VMPane),"Drop target shouldnt be a pane")}catch(PERR){g.reportError(PERR)}previousDropTarget=currentDropTarget,previousEventTarget=eventTarget,previousWasPane=isPane}}if(activePane){var topMin=70,topMax=110,bottomMin=platform.windowHeight()-40,bottomMax=platform.windowHeight()+40;if(e.offsetY<topMax){var speed=-(1-g.computeScrollSpeed(topMin,topMax,e.offsetY));g.repeatScroll(speed,activePane)}else if(e.offsetY>bottomMin&&e.offsetY<bottomMax){var speed=g.computeScrollSpeed(bottomMin,bottomMax,e.offsetY);g.repeatScroll(speed,activePane)}else g.cancelRepeatScroll()}else g.cancelRepeatScroll();return!1},self.handleDropItem=function handleDropItemFn(movingItem,e){if(g.cancelRepeatScroll(),movingItem!==previousDropTarget){for(var parent=previousDropTarget.parent();parent;){if(parent===movingItem)return;parent=parent.parent()}if(g.getNextItem(movingItem,g.focusedPane)===previousDropTarget&&"itemDraggingAbove"===previousDragClass)return;var pane=g.getPaneForElement(previousEventTarget);if(!pane.isTimeline()){var previousParent=movingItem.parent(),previousIndex=movingItem.getIndex(),target=void 0,targetIndex=-1;previousDropTarget.isFullscreen()?(target=previousDropTarget,targetIndex=target.numChildren()):(target=previousDropTarget.parent(),targetIndex="itemDraggingAbove"===previousDragClass?previousDropTarget.getIndex():previousDropTarget.getIndex()+1),tracker.beginAction();try{g.PAssert(1361,target,"Trying to move without a target")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1362,!isNaN(targetIndex),"Trying to move without a target index")}catch(PERR){g.reportError(PERR)}movingItem.moveTo({parent:target,index:targetIndex}),tracker.performAction(TrackerType.Move,{itemID:movingItem.id,oldParent:previousParent.id,oldPosition:previousIndex,newParent:target.id,newPosition:targetIndex}),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DropItem,data:[{itemID:movingItem.id}]}),tracker.endAction(),g.timeline.reloadTimelines()}}},self.getDropItem=function getDropItemFn(e){try{g.PAssert(1365,e.dataTransfer.item,"We do not support HTML5 drag/drop")}catch(PERR){g.reportError(PERR)}return e.dataTransfer.item},self.handleDrop=function handleDropFn(e){if(e.stopPropagation(),previousEventTarget){removePreviousDragEffect();var item=self.getDropItem(e);if(item)self.handleDropItem(item,e);else{var id=e.dataTransfer.getData("itemid");if(id){var from=ko.dataFor(document.getElementById(id));self.handleDropItem(from,e)}else e.dataTransfer.files&&e.dataTransfer.files.length>0&&(handleDropFiles(e),e.stopPropagation(),e.preventDefault())}}}};return VMMain_DragDrop}),define("VMDocument",["ko","globals","platform","data","goog","tracker"],function(ko,g,platform,d,goog,tracker){function VMDocument(p){this.file=p,this.id=p&&p.id,this.title=ko.observable(p&&p.title||""),this.shared=p&&p.shared,this.isOpen=void 0,this.isOwned=ko.observable(!1),this.init()}return VMDocument.prototype={init:function initFn(){this.file&&"me"===this.file.userPermission.id&&"owner"===this.file.userPermission.role&&this.isOwned(!0)},onTapMenu:function onTapMenuFn(){this.openSharing(),g.sendEvent("Menu","OpenSharing"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocSharing,data:[{value:!0}]})},openSharing:function openSharingFn(callback){g.menus.openModal("shareDoc",this,callback)},closeMenu:function closeMenuFn(){g.menus.closeContextMenu(g.element("contextMenuDocument"))},onTapContextMenu:function onTapContextMenuFn(e){var id=e.srcElement.id;switch(id||(id=e.srcElement.parentNode.id),id){case"documentDelete":break;case"documentShare":}this.closeMenu()}},VMDocument}),define("VMMenus",["ko","globals","data","gdata","VMSearch","VMTitle","edit","VMLI","tracker","platform","VMDocument"],function(ko,g,d,gdata,VMSearch,VMTitle,edit,VMLI,tracker,platform,VMDocument){function VMMenus(){this.linkAddress=ko.observable(),this.linkTitle=ko.observable("temporary title"),this.itemMenuPhoneWidth=-240,this.rightMenuWidth=50,this.phoneLastTop=0,this.itemMenuPhone=void 0,this.itemMenuBG=void 0,this.itemMenuPhoneMode=ko.observable(0),this.rightMenuPhone=void 0,this.rightMenuPhoneBG=void 0,this.lastSwipeMove=0,this.lastSwipeMoveTime=0,this.canClosePane=ko.observable(!1),this.showArchivedMenuOption=ko.observable(!1),this.archivedMenuText=ko.observable(""),this.itemIsHeader=ko.observable(!1),this.itemHasChildren=ko.observable(!1),this.itemIsCollapsed=ko.observable(!1),this.itemIsArchived=ko.observable(!1),this.itemCanIndent=ko.observable(!1),this.itemCanUnindent=ko.observable(!1),this.itemCanZoom=ko.observable(!1),this.lastZIndex=37,this.contextMenuOpenedOn=ko.observable(void 0),this.isModalVisible=ko.observable(!1),this.isModalOpen=ko.observable(!1),this.modalOpened=void 0,this.modalOpenedBound=void 0,this.modalsBound=!1,this.menusBound=!1,this.init()}return VMMenus.prototype={init:function initFn(){window.addEventListener("closeKeyboard",this.onCloseKeyboard.bind(this)),g.addCustomEventListener("keyEscape",this.onEscapeKey.bind(this),100),platform.mobile||this.isModalOpen.subscribe(function(newValue){requestAnimationFrame(newValue?function(){requestAnimationFrame(function(){g.addClass(g.element("main"),"modalOpen"),g.addClass(g.element("desktopMenu"),"modalOpen"),g.addClass(g.element("desktopSidebar"),"modalOpen")})}:function(){g.removeClass(g.element("main"),"modalOpen"),g.removeClass(g.element("desktopMenu"),"modalOpen"),g.removeClass(g.element("desktopSidebar"),"modalOpen")})})},bind:function bindFn(){this.menusBound||(this.menusBound=!0,g.applyBindings(this,"contextMenus"),platform.mobile&&(this.itemMenuPhone=g.element("itemMenuPhone"),this.rightMenuPhoneBG=g.element("rightMenuPhoneBG"),this.rightMenuPhone=g.element("rightMenuPhone"),this.rightMenuPhoneItems=g.element("rightMenuPhoneItems"),this.itemMenuBG=g.element("itemMenuBG"),g.applyBindings(this,"itemMenuPhone"),g.applyBindings(this,"rightMenuPhoneItems")))},onEscapeKey:function onEscapeKeyFn(){return this.isModalOpen()?this.closeModalInternal(!1):void 0},itemMenuPhoneClass:function itemMenuPhoneClassFn(){var mode=this.itemMenuPhoneMode();return 0===mode?"complete completeDisabled":1==mode?"complete":2==mode?"notVisible":void 0},selectionHasChildren:function selectionHasChildrenFn(){for(var i=0;i<g.vmMain.selected().length;i++)if(g.vmMain.selected()[i].hasChildren())return!0;return!1},selectionIsHeader:function selectionIsHeaderFn(){return 1===g.vmMain.selected().length&&g.vmMain.selected()[0].isHeader()},openLinkMenu:function openLinkMenuFn(target,address,left,top){this.linkAddress(address),g.menuOnItem=target;var menuLink=document.getElementById("contextMenuLink");menuLink.style.left=left+"px",menuLink.style.top=top+"px",menuLink.style.display="block",g.vmMain.handleFullscreenClick(function(){this.closeLinkMenu()}.bind(this))},closeLinkMenu:function closeLinkMenuFn(){g.menuOnItem=void 0,this.linkAddress("");var menuLink=document.getElementById("contextMenuLink");menuLink.style.display="none",g.vmMain.cancelFullscreenClick()},onTapLink:{onClick:function onClickFn(e){this.closeLinkMenu()}},closeAllMenus:function closeAllMenusFn(){this.linkAddress("");var menuLink=document.getElementById("contextMenuLink");menuLink.style.display="none",g.menuOnItem=void 0},setupItemMenu:function setupItemMenuFn(target){g.element("menuGoto").style.display=g.focusedPane.isSearching?"block":"none"},onTapHover:{onStart:function onStartFn(e){e.preventDefault()},onClick:function onClickFn(e){var id=e.srcElement.id;g.sendEvent("Menu",id)}},multiSelect:function multiSelectFn(item){item.isSelected(!item.isSelected()),item.isSelected()?g.vmMain.selected.push(item):g.vmMain.selected.splice(g.vmMain.selected.indexOf(item),1)},revealGestureMenu:function revealGestureMenuFn(item,e){try{g.PAssert(1366,g.revealingMenu===!1,"Must not have already started a gesture")}catch(PERR){g.reportError(PERR)}g.revealingMenu=!0,this.startedInMultiSelectMode=g.phoneMenu.multiSelectMode(),g.menuOnItem=item;var menuSpan=item.getSpan(),height=40,offsetTop=g.offset(menuSpan).top,top=offsetTop-g.phoneMainY,spanHeight=g.height(menuSpan)+8;top+=(spanHeight-height)/2;var paneTop=top;this.phoneLastTop!==paneTop&&(this.phoneLastTop=paneTop),this.itemMenuPhone.style[platform.transition.style]="",g.setTransformStyle(this.itemMenuPhone,0,this.phoneLastTop),this.startedInMultiSelectMode||g.setTransformStyle(this.rightMenuPhone,0,0),this.rightMenuThresh=this.rightMenuWidth/200*platform.windowWidth.peek()},updateRevealGestureMenu:function updateRevealGestureMenuFn(e){try{g.PAssert(1367,g.revealingMenu===!0,"Must have already started a gesture to perform an update")}catch(PERR){g.reportError(PERR)}var xOffset=e.diffX;if(this.lastSwipeMove=e.xThisFrame,this.lastSwipeMoveTime=e.timeStamp,this.startedInMultiSelectMode){xOffset-=this.rightMenuWidth;var offset=g.clamp(xOffset,-this.rightMenuWidth,0);g.setTransformStyle(this.rightMenuPhone,offset,0)}else{var clampedOffset=g.clamp(xOffset,-this.rightMenuWidth,0);g.setTransformStyle(this.itemMenuPhone,platform.windowWidth.peek()+clampedOffset,this.phoneLastTop);var multPoint=-this.rightMenuWidth-this.rightMenuThresh,scalePerc=g.clamp((-xOffset-this.rightMenuWidth)/this.rightMenuThresh,0,1);this.itemMenuBG.style[platform.transform.style]="scale3d(1,"+scalePerc+", 1)";var offset=g.clamp(xOffset+this.rightMenuWidth+this.rightMenuThresh,-this.rightMenuWidth,0);g.setTransformStyle(this.rightMenuPhone,offset,0);var opacityPerc=g.clamp((-xOffset+multPoint)/(.75*this.rightMenuWidth),0,1);this.itemMenuPhone.style.opacity=1-opacityPerc,g.isKeyboardOpen||g.vmMain.setSelected([g.menuOnItem]),xOffset<=-this.rightMenuWidth?1!==this.itemMenuPhoneMode.peek()&&this.itemMenuPhoneMode(1):0!==this.itemMenuPhoneMode.peek()&&this.itemMenuPhoneMode(0)}},stopRevealGestureMenu:function stopRevealGestureMenuFn(e){try{g.PAssert(1368,g.revealingMenu===!0,"Must have already started a gesture")}catch(PERR){g.reportError(PERR)}var transitionTime=200,xOffset=e.diffX;g.revealingMenu=!1;var timeSinceMove=e.timeStamp-this.lastSwipeMoveTime;if(this.startedInMultiSelectMode){xOffset-=this.rightMenuWidth;var offset=g.clamp(xOffset,-this.rightMenuWidth,0);offset<=-this.rightMenuWidth/2?g.setTransform(this.rightMenuPhone,-this.rightMenuWidth,0,200,"ease-out"):(this.closeMultiSelect(),g.vmMain.clearSelected())}else xOffset<=-this.rightMenuWidth-this.rightMenuThresh?(g.setTransform(this.rightMenuPhone,-this.rightMenuWidth,0,200,"ease-out"),g.phoneMenu.multiSelectMode(!0),g.blurActiveElement(!0),g.vmMain.setSelected([g.menuOnItem])):(xOffset<=-this.rightMenuWidth&&g.menuOnItem.isComplete(!g.menuOnItem.isComplete()),g.setTransform(this.rightMenuPhone,0,0,200,"ease-out"),g.isKeyboardOpen||g.vmMain.clearSelected());this.closePhoneMenu(transitionTime)},closeMultiSelect:function closeMultiSelectFn(){g.setTransform(this.rightMenuPhone,0,0,200,"ease-out"),g.phoneMenu.multiSelectMode(!1),g.vmMain.clearSelected()},closePhoneMenu:function closePhoneMenuFn(){var transitionTime=200;g.setTransform(this.itemMenuPhone,platform.windowWidth(),this.phoneLastTop,transitionTime,"ease-out"),g.menuOnItem=void 0},onResize:function onResizeFn(){g.menuOnItem||g.setTransform(this.itemMenuPhone,platform.windowWidth(),this.phoneLastTop)},onTapMenuPhone:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){if(0!==g.vmMain.selected().length){var id=e.srcElement.id,fn,val;switch(id){case"phoneMenuComplete":fn="isComplete",val=!g.vmMain.getFirstSelectedItem().isComplete();break;case"phoneMenuFlag":fn="isFlagged",val=!g.vmMain.getFirstSelectedItem().isFlagged();break;case"phoneMenuPriorityNone":fn="priority",val=VMLIFlag.None;break;case"phoneMenuPriorityHigh":fn="priority",val=g.vmMain.getFirstSelectedItem().priority()==VMLIFlag.P0?VMLIFlag.None:VMLIFlag.P0;break;case"phoneMenuPriorityMed":fn="priority",val=g.vmMain.getFirstSelectedItem().priority()==VMLIFlag.P1?VMLIFlag.None:VMLIFlag.P1;break;case"phoneMenuPriorityLow":fn="priority",val=g.vmMain.getFirstSelectedItem().priority()==VMLIFlag.P2?VMLIFlag.None:VMLIFlag.P2;break;case"phoneMenuZoom":g.vmMain.zoomin(g.vmMain.getFirstSelectedItem()),this.closeMultiSelect();break;case"phoneMenuDelete":fn="deleteSelf";break;case"phoneMenuCollapse":if(this.selectionHasChildren())for(var i=0;i<g.vmMain.selected().length;i++)g.vmMain.selected()[i].hasChildren()&&(val||(val=!g.vmMain.selected()[i].isCollapsed()),g.vmMain.selected()[i].isCollapsed(val))}if(fn)for(var i=0;i<g.vmMain.selected().length;i++)g.vmMain.selected()[i][fn](val);"phoneMenuDelete"===id&&g.vmMain.clearSelected()}}},onTapComplete:{onClick:function onClickFn(e){g.menuOnItem.isComplete(!g.menuOnItem.isComplete())}},onTapPriority:{onClick:function onClickFn(e){var prevPri=g.menuOnItem.priority(),newPri=prevPri!==VMLIFlag.None?VMLIFlag.None:VMLIFlag.P0;g.menuOnItem.priority(newPri)}},onTapCollapse:{onClick:function onClickFn(e){g.menuOnItem.toggleCollapsed()}},onTapDelete:{onClick:function onClickFn(e){tracker.beginAction(),g.menuOnItem.deleteSelf(),tracker.endAction()}},paneTapped:function paneTappedFn(){g.menuOnItem&&this.closePhoneMenu(100)},openContextMenu:function openContextMenuFn(offset,menu,toLeft){g.autocomplete&&g.autocomplete.hide();var styles={visibility:"visible",top:offset.top},menuWidth=g.width(menu);toLeft||offset.left+menuWidth>platform.windowWidth()&&(toLeft=!0),styles.left=toLeft?offset.left-menuWidth-2:offset.left+2;var menuHeight=g.height(menu);offset.top+menuHeight>platform.windowHeight()&&(styles.top-=menuHeight),g.css(menu,styles);var windowBounds=document.documentElement.getBoundingClientRect(),rect=menu.getBoundingClientRect(),autoRect={left:rect.left,right:rect.right,top:rect.top,bottom:rect.bottom},origin=g.adjustOriginToBeInsideBounds(windowBounds,autoRect);
(origin.x!==autoRect.left||origin.y!==autoRect.top)&&(menu.style.left=origin.x+"px",menu.style.top=origin.y+"px"),g.vmMain.handleFullscreenClick(function(){this.closeContextMenu(menu)}.bind(this))},closeContextMenu:function closeContextMenuFn(menu){g.css(menu,{visibility:"hidden"}),g.vmMain.cancelFullscreenClick()},registerModal:function registerModalFn(menu,bind,openFn,closeFn){try{g.PAssert(1369,menu&&bind,"Must have a valid name and object to bind modal to")}catch(PERR){g.reportError(PERR)}this[menu+"Item"]=ko.observable(bind),this[menu+"Visible"]=ko.observable(!1),this[menu+"Loading"]=ko.observable(!1),openFn&&(this[menu+"OpenFn"]=openFn),closeFn&&(this[menu+"CloseFn"]=closeFn)},openModal:function openModalFn(menu){try{g.PAssert(1370,!this.modalOpened,"Only a single modal should be opened at a time")}catch(PERR){g.reportError(PERR)}this[menu+"OpenFn"]&&this[menu+"OpenFn"].apply(this[menu+"Item"](),Array.prototype.slice.call(arguments,1)),this.modalsBound||(g.applyBindings(this,"modals"),this.modalsBound=!0);var visibleVar=this[menu+"Visible"];try{g.PAssert(1371,visibleVar,"Visible variable does not exist")}catch(PERR){g.reportError(PERR)}this.modalOpened=menu,this.modalOpenedBound=this[menu+"Item"](),visibleVar(!0),this.isModalVisible(!0),this.isModalOpen(!0)},closeModal:function closeModalFn(menu){if(this.modalOpened){try{g.PAssert(1372,!menu||menu===this.modalOpened,"Tried to close the wrong modal")}catch(PERR){g.reportError(PERR)}arguments.length>1?this.closeModalInternal.apply(this,Array.prototype.slice.call(arguments,1)):this.closeModalInternal()}},closeModalInternal:function closeModalInternalFn(){if(this.modalOpened){try{g.PAssert(1373,this.modalOpened,"Tried to close when no modal was open")}catch(PERR){g.reportError(PERR)}var visibleVar=this[this.modalOpened+"Visible"];try{g.PAssert(1374,visibleVar,"Visible variable does not exist")}catch(PERR){g.reportError(PERR)}var currentModal=this.modalOpened;return visibleVar(!1),this.isModalOpen(!1),this.isModalVisible(!1),this.modalOpened=void 0,this.modalOpenedBound=void 0,this.modalInputOn=void 0,g.fireCustomEvent("closeKeyboard"),this[currentModal+"CloseFn"]&&this[currentModal+"CloseFn"].apply(this[currentModal+"Item"](),arguments),!1}},focusModalInputMobile:function focusModalInputMobileFn(e,element){try{g.PAssert(1375,platform.mobile,"Should not call this from non-mobile")}catch(PERR){g.reportError(PERR)}this.modalInputOn?this.modalInputOn!=element?(element.focus(),this.modalOpenedBound.onKeyboardOpened&&requestAnimationFrame(function(){this.modalOpenedBound.onKeyboardOpened(e)}.bind(this)),e.preventDefault(),e.stopPropagation(),g.enforceScroll()):g.enforceScroll():g.openKeyboardOn(e,element,!1,function(){platform.app?(this.modalOpenedBound.onKeyboardOpened(e),requestAnimationFrame(function(){requestAnimationFrame(function(){element.focus(),g.enforceScroll()})})):element.focus()}.bind(this))},onTapModal:{onStart:function onStartFn(e){platform.mobile&&e.srcElement!=this.modalInputOn&&(g.isKeyboardInputElement(e.srcElement)||g.hasClass(e.srcElement,"input"))&&(log("start",g.isKeyboardOpen),g.isKeyboardOpen||(e.preventDefault(),e.stopPropagation()))},onClick:function onClickFn(e){var prevent=!0;"modals"==e.srcElement.id?(this.closeModal(),this.modalInputOn=void 0):e.srcElement==this.modalInputOn?prevent=!1:g.isKeyboardInputElement(e.srcElement)||g.hasClass(e.srcElement,"input")?(platform.mobile&&this.focusModalInputMobile(e,e.srcElement),this.modalInputOn=e.srcElement):this.modalInputOn=void 0,prevent&&platform.mobile&&(e.preventDefault(),e.stopPropagation())}},onCloseKeyboard:function onCloseKeyboardFn(){this.modalInputOn=void 0},paneIsTimeline:function paneIsTimelineFn(){return this.contextMenuOpenedOn()?this.contextMenuOpenedOn().isTimeline&&this.contextMenuOpenedOn().isTimeline():!1},openItemMenu:function openItemMenuFn(item,e){this.openContextMenu({left:e.pageX,top:e.pageY},g.element("contextMenuItem"),!1),this.contextMenuOpenedOn(g.getPaneForElement(e.srcElement));var firstItem,foundZoomCandidate=!1;g.vmMain.applyToSelection(function(item,index,total){try{g.PAssert(1376,item,"Item must be defined")}catch(PERR){g.reportError(PERR)}return item&&0===index&&(firstItem=item,this.itemIsHeader(item.isHeader()),this.itemHasChildren(item.isHeader()||item.hasChildren()),this.itemIsCollapsed(item.isCollapsed()),this.itemIsArchived(item.isArchived()),this.itemCanIndent(0!==item.getIndex()),this.itemCanUnindent(item.parent()!==g.focusedItem)),foundZoomCandidate||item.canZoom()&&(foundZoomCandidate=!0,this.itemCanZoom(!0)),foundZoomCandidate||index!==total-1||this.itemCanZoom(!1),!foundZoomCandidate}.bind(this),{passExtraInfo:!0})},closeItemMenu:function closeItemMenuFn(){this.closeContextMenu(g.element("contextMenuItem")),this.contextMenuOpenedOn(void 0)},itemContextText:function itemContextTextFn(){return this.itemIsCollapsed()?"Expand":"Collapse"},itemArchivedText:function itemArchivedTextFn(){return this.itemIsArchived()?"Unarchive":"Archive"},hotkeyText:function hotkeyTextFn(key){return platform.windows?platform.cmdChar+"+"+key:platform.cmdChar+""+key},onTapItemMenu:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var id=e.srcElement.id;switch(id||(id=e.srcElement.parentNode.id),id){case"itemComplete":g.vmMain.applyFnToSelection("isComplete",!0);break;case"itemFlag":g.vmMain.applyFnToSelection("isFlagged",!0);break;case"itemIndent":g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1});break;case"itemUnindent":g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0});break;case"itemPriorityNone":g.vmMain.applyPriorityToSelection(VMLIFlag.None);break;case"itemPriorityLow":g.vmMain.applyPriorityToSelection(VMLIFlag.P2);break;case"itemPriorityMed":g.vmMain.applyPriorityToSelection(VMLIFlag.P1);break;case"itemPriorityHigh":g.vmMain.applyPriorityToSelection(VMLIFlag.P0);break;case"itemCollapse":g.vmMain.applyToSelection(function(item){item.toggleCollapsed()});break;case"itemZoom":g.vmMain.applyToSelection(function(item){return item.canZoom()?(g.vmMain.zoomin(item),!1):!0});break;case"itemCopy":break;case"itemPaste":break;case"itemUndo":break;case"itemRedo":break;case"itemArchive":var numChanged=0,numChecked=g.vmMain.applyToSelection(function(item){this.itemIsArchived()?item.parent().unarchiveChild(item)&&numChanged++:item.parent().archiveChild(item)&&numChanged++}.bind(this));if(numChanged>0){var z=numChanged>1?" items.":" item.",verb=this.itemIsArchived()?"unarchived":"archived";g.messageQueue.pushMessage({text:"Successfully "+verb+" "+numChanged+z,type:MessageType.Info,action:MessageAction.Default,timeout:2e3})}break;case"itemDelete":g.vmMain.applyToSelection(function(item){item.deleteSelf()});break;case"contextMenuItem":break;default:try{g.PAssert(1377,!1,"Unknown context menu item: ",id)}catch(PERR){g.reportError(PERR)}}g.sendEvent("ContextMenu",id),this.closeItemMenu()}}},VMMenus}),define("VMDocSharing",["ko","globals","platform","data","goog"],function(ko,g,platform,d,goog){function VMDocSharing(){this.doc=ko.observable({isOwned:function(){return!1}}),this.isLoading=ko.observable(!1),this.isCreating=ko.observable(!1),this.permissions=ko.observableArray(),this.permissionsNew=ko.observableArray(),this.permissionsRemove=[],this.newEmail=ko.observable(""),this.errorGlobal=ko.observable(!1),this.errorName=ko.observable(!1),this.errorInvite=ko.observable(!1),this.isSaving=ko.observable(!1),this.editing=ko.observable(""),this.closeCallback=void 0,this.justCreated=!1}return VMDocSharing.prototype={open:function openFn(doc,callback){this.doc(doc),this.closeCallback=callback,this.permissions.removeAll(),this.permissionsNew.removeAll(),this.permissionsRemove=[],this.newEmail(""),this.editing(""),this.isLoading(!0),this.errorGlobal(!1),this.errorName(!1),this.errorInvite(!1),this.isSaving(!1),this.isCreating(!this.doc().file),this.justCreated=!1,this.inputName=document.getElementById("shareNameInput"),this.inputName.value=this.doc().title(),this.shareLink=document.getElementById("shareLinkInput"),this.shareLink&&(this.shareLink.value="moo.do/#file="+this.doc().id),platform.mobile||setTimeout(function(){this.inputName.focus()}.bind(this),0),this.isCreating()?this.isLoading(!1):gapi.client.drive.permissions.list({fileId:this.doc().id}).execute(this.permissionHandler.bind(this))},permissionHandler:function permissionHandlerFn(response){if(!response.error){this.isLoading(!1);for(var permissions=[],i=0;i<response.items.length;++i){var item=response.items[i];item.emailAddress!==g.getUserIdentifier()&&(item.onRemove=this.onRemove.bind(this,item),"anyone"!=item.id&&(item.emailAddress||(item.emailAddress="owner"===item.role?"Owner":""),"owner"===item.role?permissions.splice(0,0,item):permissions.push(item)),item.emailDisplay="("+item.emailAddress+")")}this.permissions(permissions)}},isOwned:function isOwnedFn(){return this.doc().isOwned&&this.doc().isOwned()},saveText:function saveTextFn(){return this.isCreating()?this.isSaving()?"Creating...":"Create":platform.mobile&&this.editing()?"Close":this.newEmail().length>0?"Invite":this.isSaving()?"Saving...":"Save"},titleText:function titleTextFn(){return platform.mobile&&this.editing()?this.editing():this.isCreating()?"Create Document":"Edit Document"},onkeydown:function onkeydownFn(data,e){return platform.normalizeKeys(e),e.normCode==KeyCode.Escape?(this.newEmail(""),e.preventDefault(),e.stopImmediatePropagation(),!1):e.normCode==KeyCode.Enter?(this.inviteUser(),g.scrollIntoView(g.element("inputShareInvite"),0),e.preventDefault(),e.stopImmediatePropagation(),!1):!0},onKeyboardOpened:function onKeyboardOpenedFn(e){this.editing(e.srcElement.title)},inviteUser:function inviteUserFn(){if(0===this.newEmail().length)return void this.errorInvite("");if(!g.isEmail(this.newEmail()))return this.errorInvite("Please enter a valid email address."),!1;var user={emailAddress:this.newEmail(),error:ko.observable(!1)},contact=d.findContactByEmail(user.emailAddress.toLowerCase());return user.name=contact?contact.text:user.emailAddress,user.onRemove=this.onRemoveNew.bind(this,user),this.permissionsNew.push(user),this.newEmail(""),this.errorInvite(!1),!0},checkName:function checkNameFn(){var title=this.inputName.value.trim();return title.length>0&&title.length<255?(this.errorName(!1),!0):(this.errorName("Error: Document name must be >0 and <255 characters."),!1)},rename:function renameFn(){var title=this.inputName.value.trim();title!=this.doc().title()&&(this.doc().title(title),gapi.client.drive.files.patch({fileId:this.doc().id,resource:{title:title}}).execute(function(response){response.error?this.errorName("Error: Unable to update name on remote server."):log("File renamed to",title)}.bind(this)))},create:function createFn(callback){this.justCreated=!0,this.isSaving(!0);var title=this.inputName.value.trim();this.tooltip=title,this.isSaving(!0),gapi.client.drive.files.insert({resource:{mimeType:goog.REALTIME_MIMETYPE,title:title,writersCanShare:!1}}).execute(function(response){response.error?this.errorGlobal("Error: Unable to create new document."):(this.doc().id=response.id,this.doc().file=response,this.isCreating(!this.doc().file),this.isSaving(!1),callback&&callback())}.bind(this))},save:function saveFn(){function handleResponse(index,response){response.error?(console.error("UH OH",response),this.permissionsNew()[i].error(!0),this.errorInvite("Some people could not be invited."),this.isSaving(!1)):(count--,0>=count&&g.menus.closeModal("shareDoc",!1))}if(!this.isSaving()||this.justCreated){if(this.editing())return g.blurActiveElement(),void this.editing("");if(!goog.isDriveAPILoaded())return void this.errorGlobal("Error communicating with Google Drive. Please reconnect and try again.");if(this.checkName()){if(this.isCreating())return void this.create(this.save.bind(this));if(this.newEmail().length>0){if(!this.inviteUser())return}else this.errorInvite(!1);this.rename();for(var count=0,i=0;i<this.permissionsNew().length;i++){var newPermission=this.permissionsNew()[i];if(!newPermission.error()){count++;var body={value:newPermission.emailAddress,type:"user",role:"writer",withLink:!1},message="Come collaborate with me at Moo.do!\r\nhttp://www.moo.do/#login=true&file="+this.doc().id;gapi.client.drive.permissions.insert({fileId:this.doc().id,emailMessage:message,resource:body}).execute(handleResponse.bind(this,i))}}for(var i=0;i<this.permissionsRemove.length;i++){var permission=this.permissionsRemove[i];gapi.client.drive.permissions.delete({fileId:this.doc().id,permissionId:permission.id}).execute(function(response){})}this.errorInvite()||this.errorName()||(0===count?g.menus.closeModal("shareDoc",!0):(this.isSaving(!0),this.onClose(!0)))}}},onClose:function onCloseFn(isSave){this.closeCallback&&(this.closeCallback(isSave),this.closeCallback=void 0)},onTapInviteMessage:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var el=g.element("inputShareInvite");platform.mobile?g.menus.focusModalInputMobile(e,el):el.focus()}},onTapSave:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){this.save(),g.sendEvent("Menu","SharingSave")}},onTapCancel:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){g.menus.closeModal("shareDoc",!1),g.sendEvent("Menu","SharingCancel")}},onTapDelete:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){g.sendEvent("Menu","SharingDelete"),setTimeout(function(){var result=prompt("This will delete the file. Type DELETE to confirm.");result&&"delete"==result.trim().toLowerCase()&&(gapi.client.drive.files.delete({fileId:this.doc().id}).execute(function(response){log("Document Delete Response: ",response),response.error&&g.messageQueue.pushMessage({text:"Unable to delete document on the remote server.",type:MessageType.Error})}.bind(this)),g.vmMain.vmPicker.removeFile(this.doc()),g.menus.closeModal("shareDoc",!1))}.bind(this),0)}},onRemove:function onRemoveFn(user){this.permissionsRemove.push(user),this.permissions.remove(user),g.sendEvent("Menu","SharingRemoveUser")},onRemoveNew:function onRemoveNewFn(user){this.permissionsNew.remove(user)}},VMDocSharing}),define("VMPicker",["ko","globals","util","platform","data","goog","VMDocument","VMDocSharing","tracker"],function(ko,g,util,platform,d,goog,VMDocument,VMDocSharing,tracker){function VMPicker(){this.files=ko.observableArray(),this.permissions=ko.observableArray(),this.isPublic=ko.observable(),this.fileMap={},this.isLoading=ko.observable(!1),this.needPermission=ko.observable(!1),this.showError=ko.observable(!1),this.loadCallbacks=[],this.init()}return VMPicker.prototype={init:function initFn(){var docShare=new VMDocSharing;g.menus.registerModal("shareDoc",docShare,docShare.open.bind(docShare),docShare.onClose.bind(docShare))},refreshFiles:function refreshFilesFn(){this.runOnFileLoad(this.markFileProperties.bind(this)),this.loadFileList()},setFiles:function setFilesFn(files,selectedIndex){this.files.removeAll();for(var i=0;i<files.length;i++){var file=files[i],vmDoc=new VMDocument(file);vmDoc.isOpen=i===selectedIndex,this.files.push(vmDoc)}this.setMinHeight()},loadFileList:function loadFileListFn(cb){function runLoad(){gapi.client.drive.files.list({fields:"items(appDataContents,createdDate,description,editable,etag,exportLinks,iconLink,id,indexableText,kind,labels,md5Checksum,mimeType,ownerNames,owners,parents,permissions,properties,quotaBytesUsed,shared,sharedWithMeDate,sharingUser,title,userPermission,version,writersCanShare),kind,nextLink,nextPageToken",q:"trashed=false and mimeType='"+goog.REALTIME_MIMETYPE+"."+goog.APP_ID+"'"}).execute(function(results){if(!results.items||results.error)this.showError("Load Documents");else{for(var selectIndex=0,currentId=goog.getDocId(),i=0;i<results.items.length;++i){var item=results.items[i];this.fileMap[item.id]=item,currentId===item.id&&(selectIndex=i)}this.setFiles(results.items,selectIndex)}this.isLoading(!1),cb&&cb(results),this.onFilesLoaded(results)}.bind(this))}this.isLoading()||(this.isLoading(!0),this.showError(!1),gapi&&gapi.client.drive?runLoad.bind(this)():gapi.client.load("drive","v2",runLoad.bind(this)))},markFileProperties:function markFilePropertiesFn(res){if(res&&res.items)for(var i=0;i<res.items.length;++i){var fileInfo=res.items[i];if(!fileInfo.properties&&fileInfo.title===goog.LEGACY_DefaultDriveDocTitle&&"me"===fileInfo.userPermission.id&&"owner"===fileInfo.userPermission.role){gapi.client.drive.properties.insert({fileId:fileInfo.id,resource:{key:goog.DefaultProperty,value:goog.DefaultPropertyValue,visibility:"PRIVATE"}}).execute(function(result){(result.error||"drive#property"!==result.kind)&&ShouldLog(LogLevels.Error)&&log("Error adding default file property: ",result)});break}}},onFilesLoaded:function onFilesLoadedFn(res){if(this.loadCallbacks.length>0){for(var i=0;i<this.loadCallbacks.length;++i)this.loadCallbacks[i]&&this.loadCallbacks[i](res);this.loadCallbacks=[]}},runOnFileLoad:function runOnFileLoadFn(cb){this.loadCallbacks.push(cb)},requestOpenDocument:function requestOpenDocumentFn(id){var doc=this.getFile(id);doc?this.openDocument(doc):this.needPermission()?this.doRequestPermission(function(){this.openDocumentFromId(id)}.bind(this)):this.onFilesLoaded(function(){this.openDocumentFromId(id)}.bind(this))},openDocumentFromId:function openDocumentFromIdFn(id,title){var currentDoc=goog.getDocId();if(currentDoc!==id){var skipSettings=[Settings.docSharing,Settings.authScopes,Settings.shownTutorial,Settings.lastMessageSync];d.clearData(function(){goog.setDocInfo(id,title),util.hasURLParam("file")?util.removeURLParam("file",!0):util.hasURLParam("state")&&util.removeURLParam("state",!0),setTimeout(function(){g.reload()},500)},skipSettings)}},openDocument:function openDocumentFn(doc){g.localDocChangeRequested=!0,this.openDocumentFromId(doc.id,doc.title)},doRequestPermission:function doRequestPermissionFn(cb){},onRequestPermission:function onRequestPermissionFn(e){this.doRequestPermission()},onTapReloadDocuments:function onTapReloadDocumentsFn(e){this.loadFileList()},onTapDocument:{onClick:function onClickFn(e){var doc=ko.dataFor(e.srcElement);g.hasClass(e.srcElement,"documentTitle")?(this.openDocument(doc),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocument,data:[{value:!0}]})):doc instanceof VMDocument?(doc.onTapMenu(),e.stopImmediatePropagation()):g.reportError("Incorrect document type: "+g.elementToString(e.srcElement))}},onTapAdd:{onStart:g.handlerPreventStop,onClick:function onClickFn(){if(g.vmMain&&g.vmMain.isOnline()){var doc=new VMDocument;doc.isOwned(!0),this.files.push(doc),this.setMinHeight(),g.sendEvent("Menu","AddDocument"),doc.openSharing(function(saved){saved||(this.files.remove(doc),this.setMinHeight())}.bind(this)),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddDocument,data:[{value:!0}]})}else g.messageQueue.pushMessage({text:"You must be online to create a new document",type:MessageType.Warning,timeout:8e3})}},getFile:function getFileFn(id){return this.fileMap[id]},removeFile:function removeFileFn(doc){this.files.remove(doc),this.setMinHeight(),doc.isOpen&&d.clearData(function(){setTimeout(function(){g.reload()},0)})},setMinHeight:function setMinHeightFn(){if(!platform.mobile){var documentsList=document.getElementById("documentsList");if(!documentsList)return void setTimeout(this.setMinHeight.bind(this),0);var height=documentsList.clientHeight;g.element("sidebarDocumentContainer").style.minHeight=height+50+"px"}}},VMPicker}),define("VMSettings",["ko","data","globals","util","goog","platform","tracker","VMPicker"],function(ko,d,g,util,goog,platform,tracker,VMPicker){function VMSettings(vmMain){this.enabledSyncContacts=ko.observable(!1),this.enabledSounds=ko.observable(!1),this.enabledNotifications=ko.observable(!1),this.enabledMobileUI=ko.observable(!1),this.syncContactsEnabledOnOpen=ko.observable(!1),this.refreshingContacts=!1,this.refreshContactsSuccess=ko.observable(void 0),this.init()}return VMSettings.prototype={init:function initFn(){if(g.menus.registerModal("settings",this,this.open.bind(this),this.close.bind(this)),this.loadSettings(),platform.mobile){var saveFn=this.save.bind(this);this.enabledSyncContacts.subscribe(saveFn),this.enabledSounds.subscribe(saveFn),this.enabledNotifications.subscribe(saveFn),this.enabledMobileUI.subscribe(saveFn)}if(platform.isTouchDevice&&!platform.app){var paneSettings=document.getElementById("paneSettings");paneSettings&&paneSettings.addEventListener(platform.touchStartEvent,function(e){return g.preventScrollPropagation(paneSettings)||"paneSettings"!=e.srcElement.id?void 0:(e.preventDefault(),!1)})}platform.mobile&&g.ScreenManager.addScreen(this,Screens.Settings),window.addEventListener("settingsChange_"+Settings.syncContacts,this.onSyncContactsChange.bind(this))},isLocal:function isLocalFn(){return"localhost"===window.location.hostname},showMobileUIOptionOnDesktop:function showMobileUIOptionOnDesktopFn(){try{return!!util.storage.getItem("forceFullUI")}catch(err){return!1}},showMobileUIOptionOnMobile:function showMobileUIOptionOnMobileFn(){return parseInt(window.innerWidth)>767},onEnableNotificationsChange:function onEnableNotificationsChangeFn(){this.enabledNotifications()?g.timeline.updateNotifications():g.timeline.clearNotifications()},onSyncContactsChange:function onSyncContactsChangeFn(e){this.enabledSyncContacts(e.data)},getTopElement:function getTopElementFn(){return document.getElementById("paneSettings")},open:function openFn(){this.isClosing||(this.refreshContactsSuccess(void 0),this.loadSettings(),this.syncContactsEnabledOnOpen(this.enabledSyncContacts()))},close:function closeFn(save){if(save)this.save();else{var checkSyncContacts=!!g.settings.get(Settings.syncContacts);this.enabledSyncContacts(checkSyncContacts),this.enabledSounds(!g.settings.get(Settings.noSounds))}},onScreenStartOpen:function onScreenStartOpenFn(){this.loadSettings()},enableSyncContacts:function enableSyncContactsFn(){function handleContactsLoaded(numContacts){0>numContacts?g.messageQueue.pushMessage({text:'There was an error syncing your contacts, please try again using the "Refresh Contacts" button in settings.',type:MessageType.Error}):numContacts>0&&(g.messageQueue.pushMessage({text:"Your contacts were successfully synced with Moo.do.",type:MessageType.Info}),g.vmMain.runParseWorker())}g.sendEvent("Settings","EnableContacts"),goog.runAuthenticate([GScope.Contacts],!1,!1,function(token){token&&!token.error?(goog.loadContacts(handleContactsLoaded),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SyncContacts,data:[{value:!0}]}),this.enabledSyncContacts(!0),g.settings.set(Settings.syncContacts,!0)):(this.enabledSyncContacts(!1),g.settings.set(Settings.syncContacts,!1),g.messageQueue.pushMessage({text:"If you would like to sync your contacts we need permission to access them, please try again.",type:MessageType.Error,timeout:1e4}))}.bind(this))},loadSettings:function loadSettingsFn(){this.enabledSyncContacts(!!g.settings.get(Settings.syncContacts)),this.enabledSounds(!g.settings.get(Settings.noSounds)),this.enabledNotifications(!g.settings.get(Settings.disableNotifications));try{this.enabledMobileUI(!util.storage.getItem("forceFullUI"))}catch(err){this.enabledMobileUI(!1)}},save:function saveFn(){var changedContacts=this.enabledSyncContacts()!==!!g.settings.get(Settings.syncContacts),changedSounds=this.enabledSounds()!==!g.settings.get(Settings.noSounds),changedNotifications=this.enabledNotifications()!==!g.settings.get(Settings.disableNotifications),changedMobileUI;try{changedMobileUI=this.enabledMobileUI()!==!util.storage.getItem("forceFullUI")}catch(err){changedMobileUI=!1}changedContacts&&(g.settings.set(Settings.syncContacts,this.enabledSyncContacts()),this.enabledSyncContacts()?this.enableSyncContacts():(g.sendEvent("Settings","DisableContacts"),goog.loadedContacts=!1,d.clearContacts())),changedSounds&&g.settings.set(Settings.noSounds,!this.enabledSounds()),changedNotifications&&g.settings.set(Settings.disableNotifications,!this.enabledNotifications()),changedMobileUI&&g.shouldWriteLocal()&&(this.enabledMobileUI()?util.storage.removeItem("forceFullUI"):util.storage.setItem("forceFullUI",!0))},isDemo:function isDemoFn(){return g.isDemoMode()},onTapSave:function onTapSaveFn(e){g.menus.closeModal("settings",!0)},onTapCancel:function onTapCancelFn(e){g.menus.closeModal("settings",!1)},onScreenOpen:function onScreenOpenFn(){g.isKeyboardOpen&&g.blurActiveElement()},onScreenClose:function onScreenCloseFn(){this.save()},onTapLogout:function onTapLogoutFn(e){g.vmSetup.logoutClicked(),g.sendEvent("Menu","Logout"),e.preventDefault()},onTapRunPicker:function onTapRunPickerFn(e){},onTapFeedback:function onTapFeedbackFn(e){g.menus.openModal("reportBug"),g.sendEvent("Menu","GiveFeedback"),e.preventDefault()},onTapLeaveDemo:function onTapLeaveDemoFn(e){util.removeURLParam("demo")},onTapRestartClient:function onTapRestartClientFn(e){g.reload(),e.preventDefault()},onTapPromptResetClient:function onTapPromptResetClientFn(e){g.messageQueue.pushMessage(MessageID.CacheReset),e.preventDefault()},onTapResetClient:function onTapResetClientFn(e){d.clearData(function(){g.reload()}),g.sendEvent("Menu","ResetClient")},onForceReloadDoc:function onForceReloadDocFn(e){var skipSettings=[Settings.docSharing,Settings.authScopes,Settings.shownTutorial,Settings.gdocId,Settings.gdocTitle];d.clearData(function(){g.reload()},skipSettings),g.sendEvent("Menu","ReloadDoc")},onTapSettings:function onTapSettingsFn(e){g.menus.openModal("settings"),g.vmMain.cancelFullscreenClick(),g.sendEvent("Menu","Settings")},onTapHelp:function onTapHelpFn(e){g.vmMain.showHelp(HelpMode.Normal),g.sendEvent("Menu","HelpSidebar")},onlineStatusToggle:function onlineStatusToggleFn(){platform.offline?util.removeURLParam("offline"):util.insertURLParam("offline","true")},logoutButtonText:function logoutButtonTextFn(){return g.vmSetup.logoutButtonText()},isLoggedIn:function isLoggedInFn(){return g.vmSetup.loginState()==LoginState.LOGGED_IN},showAppDebugInfo:function showAppDebugInfoFn(){return platform.debugApp},getHostName:function getHostNameFn(){return"Host: "+window.location.host},getAppDebugText:function getAppDebugTextFn(){return"LowMem: "+(g.hasSentLowMemoryWarning()?"TRUE":"FALSE")},onTapRefreshContacts:function onTapRefreshContactsFn(){this.refreshingContacts||(this.refreshingContacts=!0,this.refreshContactsSuccess(void 0),d.clearLocalContacts(),goog.loadedContacts=!1,goog.authAndLoadContacts(function(success){this.refreshContactsSuccess(success),setTimeout(function(){this.refreshingContacts=!1}.bind(this),1e3)}.bind(this)),g.sendEvent("Menu","RefreshContacts"))},contactsRefreshSuccessTest:function contactsRefreshSuccessTestFn(){return void 0===this.refreshContactsSuccess()?"":this.refreshContactsSuccess()===!0?"Success!":this.refreshContactsSuccess()===!1?"Failure!":void 0},onTapImport:function onTapImportFn(e){g.menus.openModal("importData"),g.sendEvent("Menu","ImportData"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenImport,data:[{value:!0}]})},onTapExport:function onTapExportFn(e){g.menus.openModal("exportData"),g.sendEvent("Menu","ExportData"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenExport,data:[{value:!0}]})}},VMSettings}),define("VMPhoneMenu",["ko","globals","data","platform","tracker","gdata"],function(ko,g,d,platform,tracker,gdata){function VMPhoneMenu(){try{g.PAssert(1378,platform.mobile,"Should only initialize on mobile platforms")}catch(PERR){g.reportError(PERR)}this.searchScale="",this.searchTranslate="",this.search=g.vmSearchPhone,this.mode=ko.observable(this.Modes.Normal),this.multiSelected=g.vmMain.selected,this.activeScreen=ko.observable(Screens.List),this.init()}return VMPhoneMenu.prototype={Modes:{Normal:0,Multiselect:1,Contact:2,Date:3},init:function initFn(){try{g.PAssert(1379,g.vmSearchPhone,"Phone search must be initialized at this point")}catch(PERR){g.reportError(PERR)}g.applyBindings(this,"phoneMenu"),window.appEvents=this.appEvents,platform.app&&platform.sendToApp("kbsize"),this.mode.subscribe(function(newValue){newValue==this.Modes.Multiselect?(g.addClass(g.focusedPane.element,"multiSelectMode"),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenMultiselect})):(g.removeClass(g.focusedPane.element,"multiSelectMode"),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseMultiselect}))}.bind(this)),window.addEventListener("screenScroll",function(){this.activeScreen(g.ScreenManager.activeScreen)}.bind(this))},_modeHelper:function _modeHelperFn(val,mode){return void 0!==val&&this.mode(val?mode:this.Modes.Normal),this.mode()===mode},activeScreenClass:function activeScreenClassFn(){var scr=this.activeScreen(),name="";return scr==Screens.List?name="listActive":scr==Screens.Outline?name="outlineActive":scr==Screens.Settings&&(name="settingsActive"),this.search.isShowing()&&(name+=" searchShowing"),this.search.isFocused()&&(name+=" searchFocused"),name},normalMode:function normalModeFn(val){return this._modeHelper(val,this.Modes.Normal)},multiSelectMode:function multiSelectModeFn(val){return this._modeHelper(val,this.Modes.Multiselect)},contactMode:function contactModeFn(val){return this._modeHelper(val,this.Modes.Contact)},dateMode:function dateModeFn(val){return this._modeHelper(val,this.Modes.Date)},isSaved:function isSavedFn(){return log("IsSaved DriveStatus: ",g.vmMain.gdriveStatus()),platform.offline||g.vmMain.gdriveStatus()===DriveStatus.Saved},showSearchSeparator:function showSearchSeparatorFn(){return this.search.showSearchSeparator()},isTimeline:function isTimelineFn(){return g.focusedPane.mode()==PaneMode.Timeline},titleText:function titleTextFn(){var displayItem=g.focusedPane.item(),text=displayItem.getParsedText();return text},isMenuMain:function isMenuMainFn(){return g.ScreenManager.isScreenOpen(Screens.List)},isMenuContext:function isMenuContextFn(){return g.ScreenManager.isScreenOpen(Screens.Outline)},isMenuSettings:function isMenuSettingsFn(){return g.ScreenManager.isScreenOpen(Screens.Settings)},updateSearchDOM:function updateSearchDOMFn(){},onTapMultiSelectCancel:{onClick:function onClickFn(e){g.menus.closeMultiSelect(),g.handlerPreventStop(e)}},onTapAutocompleteClose:{onClick:function onClickFn(e){g.autocomplete.hide(),g.handlerPreventStop(e)}},onTapList:{onClick:function onClickFn(e){g.ScreenManager.scrollToScreen(Screens.List),g.handlerPreventStop(e),g.sendEvent("PhoneMenu","CloseOutline")}},onTapOutline:{onClick:function onClickFn(e){g.ScreenManager.scrollToScreen(Screens.Outline),g.handlerPreventStop(e),g.sendEvent("PhoneMenu","OpenOutline")}},onTapSettings:{onClick:function onClickFn(e){log("tap settings"),g.ScreenManager.scrollToScreen(g.ScreenManager.activeScreen==Screens.Settings?Screens.Outline:Screens.Settings),g.handlerPreventStop(e),g.sendEvent("PhoneMenu","OpenSettings")}},onTapMode:{onClick:function onClickFn(e){log("mode",e),this.toggleMode(),g.focusedPane.mode()==PaneMode.Timeline?tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.PaneAgenda}):g.focusedPane.mode()==PaneMode.Normal&&tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.PaneNormal}),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenKeyboard}),g.handlerPreventStop(e),g.sendEvent("PhoneMenu","SwitchMode")}},onTapArchive:{onClick:function onClickFn(e){g.focusedPane.archiveCompleted(),g.sendEvent("PhoneMenu","ArchiveCompleted"),g.handlerPreventStop(e)}},onTapHeader:{onStart:function onStartFn(e){g.ScreenManager.checkSwipeStart(e)},onMove:function onMoveFn(e){g.ScreenManager.checkSwipeMove(e)},onEnd:function onEndFn(e){g.ScreenManager.checkSwipeEnd(e)}},paneTapped:function paneTappedFn(){},updateSearchTransform:function updateSearchTransformFn(){g.element("searchDivPhone").style[platform.transform.style]=this.searchTranslate+" "+this.searchScale},toggleMode:function toggleModeFn(){g.blurActiveElement(),g.focusedPane.initialOffset=void 0,g.focusedPane.mode()==PaneMode.Normal?(g.vmMain.clearSelected(),g.focusedPane.mode(PaneMode.Timeline)):g.focusedPane.mode(PaneMode.Normal),g.focusedPane.vmSearch.updateSearch(!0),g.vmMain.updatePaneState(g.focusedPane)
},appEvents:{undo:function undoFn(e){log("shake to undo"),tracker.undoAction()},redo:function redoFn(){log("shake to redo"),tracker.redoAction()},kbsize:function kbsizeFn(e){platform.kbsize=e},enterBackground:function enterBackgroundFn(){g.onunload()},enterForeground:function enterForegroundFn(){gdata.poke(),g.checkForRemoteChanges()},reportLowMemory:function reportLowMemoryFn(msg){g.handleLowMemory(msg)},statusBarTap:function statusBarTapFn(){var firstItem=g.getFirstPaneItem(g.focusedPane);g.scrollToTop(firstItem.getSpan(),200)}}},VMPhoneMenu}),define("VMKeyboardToolbar",["ko","globals","data","edit","platform","tracker"],function(ko,g,d,edit,platform,tracker){function VMKeyboardToolbar(){this.buttons=ko.observableArray(),this.priorityVisible=ko.observable(),this.isVisible=ko.observable(!1),this.element=void 0,this.aboutToShow=void 0,this.bottomPosition=void 0,this.init()}return VMKeyboardToolbar.prototype={init:function initFn(){this.element=g.element("mobileKeyboardToolbar"),g.applyBindings(this,"mobileKeyboardToolbar"),window.addEventListener("closeKeyboard",this.hide.bind(this))},onTap:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var id=e.srcElement.id;if("mobileKeyboardToolbar"==id&&(e.preventDefault(),e.returnFalse=!0),"closeKeyboardButton"==id)g.blurActiveElement(),g.vmMain.clearSelected();else if(g.vmSearchPhone.isFocused()){var ch;"priorityButton"==id?ch="!":"dateButton"==id?ch="@":"contactButton"==id?ch="+":"tagButton"==id&&(ch="#"),g.vmSearchPhone.insert(ch)}else"outdentButton"==id?g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0}):"indentButton"==id?g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1}):"priorityButton"==id?this.priorityVisible(!this.priorityVisible()):"pNoneButton"==id?g.vmMain.applyPriorityToSelection(VMLIFlag.None,!1):"p0Button"==id?g.vmMain.applyPriorityToSelection(VMLIFlag.P0,!0):"p1Button"==id?g.vmMain.applyPriorityToSelection(VMLIFlag.P1,!0):"p2Button"==id?g.vmMain.applyPriorityToSelection(VMLIFlag.P2,!0):"pStarButton"==id?g.vmMain.applyFnToSelection("isFlagged",!0):"dateButton"==id?(g.vmMain.insertCharacter("@",!0),log("calling at action"),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.AtButton})):"contactButton"==id?g.settings.get(Settings.syncContacts)?g.vmMain.insertCharacter("+",!0):g.messageQueue.pushMessage(MessageID.SyncContacts):"tagButton"==id&&g.vmMain.insertCharacter("#",!0);g.handlerPreventStop(e)}},preShow:function preShowFn(){this.aboutToShow=!0,this.priorityVisible(!1),setTimeout(function(){this.aboutToShow=!1}.bind(this),100)},show:function showFn(){this.aboutToShow=!1,this.updatePosition(),g.isKeyboardOpen=!0,(!platform.ie||platform.ie&&(platform.mobro||platform.winphone))&&this.isVisible(!0),this.hideTopBarIfLandscape(),g.vmSearchPhone.isFocused()?g.addClass(this.element,"kbsearch"):g.removeClass(this.element,"kbsearch"),setTimeout(function(){tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenKeyboard}),g.fireCustomEvent("keyboardOpened")},0)},hide:function hideFn(){!this.aboutToShow&&g.isKeyboardOpen&&(this.priorityVisible(!1),g.isKeyboardOpen=!1,this.hideTopBarIfLandscape(),this.isVisible(!1),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseKeyboard}))},hideTopBarIfLandscape:function hideTopBarIfLandscapeFn(){if(platform.orientation===Orientation.Landscape&&g.isKeyboardOpen){if(g.setTransform(g.element("container"),0,-40),g.setTransform(g.element("phoneMenuTopWrapper"),0,-40),g.vmMain.selected().length>0){var item=g.vmMain.selected()[0];g.scrollToTop(item.getSpan())}}else g.setTransform(g.element("container"),0,0),g.setTransform(g.element("phoneMenuTopWrapper"),0,0)},updatePosition:function updatePositionFn(byResize){platform.app||(platform.kbsize=platform.orientation==Orientation.Portrait?platform.kbsizePortrait:platform.kbsizeLandscape);var bottom=platform.kbsize;bottom!=this.bottomPosition&&(this.bottomPosition=bottom,g.element("mobileKeyboardToolbar").style.bottom=this.bottomPosition+"px")}},VMKeyboardToolbar}),define("VMHelp",["ko","globals"],function(ko,g){function VMHelp(){this.isVisible=ko.observable(!1),this.helpContentEle=void 0,this.iframe=void 0,this.init()}return VMHelp.prototype={init:function initFn(){g.menus.registerModal("help",this)},onLoad:function onLoadFn(ele){this.helpContentEle=ele,this.iframe||(this.iframe=document.createElement("iframe"),this.iframe.id="helpContentFrame",this.iframe.src="help.html",this.iframe.setAttribute("seamless","seamless")),this.helpContentEle.insertBefore(this.iframe,this.helpContentEle.firstElementChild)},onTapClose:function onTapCloseFn(){g.menus.closeModal("help")}},VMHelp}),this.document||(importScripts("lib/date.js"),importScripts("DuchessHelpers.js")),this.document?window.parseWorkerWrapper=parseWorkerWrapper:parseWorkerWrapper(),define("parseWorker",function(){}),define("VMIntroSection",["ko","globals","platform","data"],function(ko,g,platform,d){function VMIntroSection(text,note){this.text=text,this.note=note,this.items=[],this.inOrder=!1,this.enforceOrder=!1,this.owner=void 0,this.numComplete=0,this.next=0,this.isComplete=ko.observable(!1)}return VMIntroSection.prototype={getHash:function getHashFn(){return g.introHash(this.text)},getStepHash:function getStepHashFn(index){return g.introHash(this.items[index].text)},defaultShow:function defaultShowFn(){this.isDisabled(!1)},loadFromSaveData:function loadFromSaveDataFn(data){if(data===!0){for(var i=0;i<this.items.length;++i)this.items[i].isComplete(!0);this.numComplete=this.items.length,this.isComplete(!0)}else{for(var i=0;i<data.length;++i)for(var j=0;j<this.items.length;++j)data[i]===this.getStepHash(j)&&(this.items[j].isComplete(!0),this.numComplete++);this.numComplete===this.items.length&&this.isComplete(!0)}},addStep:function addStepFn(item){try{g.PAssert(1381,item.text&&item.check,"Invalid help step")}catch(PERR){g.reportError(PERR)}return item.isComplete||(item.isComplete=ko.observable(!1)),this.inOrder?item.isDisabled||(item.isDisabled=ko.observable(this.items.length>0)):item.isDisabled=g.fFalse,item.show||(item.show=this.defaultShow.bind(item)),this.items.push(item),item},complete:function completeFn(item){item.isComplete(!0),this.owner.notifyOfChange(item)},check:function checkFn(e){for(var i=0;i<this.items.length&&(this.items[i].isComplete()||(this.items[i].check(e)&&(this.complete(this.items[i]),this.inOrder&&(this.numComplete++,i===this.next&&(this.next++,this.next<this.items.length&&this.items[this.next].show()))),!this.enforceOrder));i++);this.numComplete===this.items.length&&this.isComplete(!0)},showFirstIncomplete:function showFirstIncompleteFn(){for(var i=0;i<this.items.length;i++)if(!this.items[i].isComplete()){this.items[i].show();break}}},VMIntroSection}),define("VMIntro",["ko","globals","util","platform","data","VMIntroSection"],function(ko,g,util,platform,d,VMIntroSection){function VMIntro(initState){try{g.PAssert(1382,void 0!==initState,"Must pass in a valid display state")}catch(PERR){g.reportError(PERR)}this.mode=ko.observable(),this.sections=ko.observableArray(),this.introSection=void 0,this.needsKeyboardOpen=!1,this.init(initState),g.intro=this}return window.HelpMode={None:0,Normal:1,Intro:2},VMIntro.prototype={init:function initFn(initState){this.setMode(initState),platform.mobile?this.initMobile():(this.initItemsDesktop(),this.isIntroMode()?this.initIntro():this.initHelp()),this.loadState(),platform.mobile||this.isIntroMode()||!this.itemContactsEnable.isComplete()||g.settings.get(Settings.syncContacts)||this.checkContactsEnable(!1)},initItemsDesktop:function initItemsDesktopFn(){this.itemAddItem={text:"Write a list header and press enter to add a new item",check:this.checkAddItem},this.itemIndent={text:"Press the Tab key to add an item into a list",check:this.checkIndent},this.itemOutdent={text:"Press Shift+Tab to remove an item out of a list",check:this.checkOutdent},this.itemDateTime={text:"Add a date/time by typing @ in the text of an item",check:function checkFn(e){return e.type===TrackerType.Insert&&"@"===e.data[0].text}},this.itemRightClick={text:"Right click an item to explore more options",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick}},this.itemAddAgenda={text:'Click <i class="icon-calendar2 f22 gd"></i> in the top right to add an Agenda pane',check:function checkFn(e){if(e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane){var pane=g.vmMain.panes()[e.data[0].data];if(pane.mode()===PaneMode.Timeline)return!0}}},this.itemContactsEnable={text:'<div id="buttonHelpEnableContacts" class="button bBlue" style="margin-right: 3px;">Enable</div> syncing contacts with your Google account',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SyncContacts&&e.data[0].value}}},checkContactsEnable:function checkContactsEnableFn(value){this.itemContactsEnable.isComplete(value),this.saveState()},setMode:function setModeFn(mode){this.mode(mode),g.settings.set(Settings.helpPaneState,mode),g.vmMain.helpButtonHidden(mode===HelpMode.Intro)},isIntroMode:function isIntroModeFn(){return this.mode()===HelpMode.Intro},modeClass:function modeClassFn(){return this.isIntroMode()?"helpIntro":"helpNormal"},loadState:function loadStateFn(){if(g.shouldWriteLocal())try{var stateString=util.storage.getItem(this.modeClass());if(stateString){var state=JSON.parse(stateString);if(state)for(var i=0;i<this.sections().length;++i){var section=this.sections()[i],secHash=section.getHash();state[secHash]&&section.loadFromSaveData(state[secHash])}}else util.storage.setItem(this.modeClass(),"{}")}catch(err){g.reportError(err)}},saveState:function saveStateFn(){if(g.shouldWriteLocal())try{var state=this.getState();util.storage.setItem(this.modeClass(),JSON.stringify(state))}catch(err){g.reportError(err)}},getState:function getStateFn(){for(var saveData={},i=0;i<this.sections().length;++i){var section=this.sections()[i];if(section.isComplete())saveData[section.getHash()]=!0;else{for(var sectionData=[],j=0;j<section.items.length;++j){try{g.PAssert(1383,section.items[j],"Item entries must exist")}catch(PERR){g.reportError(PERR)}if(section.items[j].isComplete()){var entryData=section.getStepHash(j);sectionData.push(entryData)}}sectionData.length>0&&(saveData[section.getHash()]=sectionData)}}return saveData},notifyOfChange:function notifyOfChangeFn(change){this.saveState()},addSection:function addSectionFn(section){section.owner=this,this.sections.push(section)},initIntro:function initIntroFn(){this.introSection=new VMIntroSection("Welcome to Moo.do!","We'll walk you through the basics to get you started."),this.introSection.inOrder=!0,this.introSection.addStep(this.itemAddItem),this.introSection.addStep(this.itemIndent),this.introSection.addStep(this.itemOutdent),this.introSection.addStep(this.itemDateTime),this.introSection.addStep(this.itemRightClick),this.introSection.addStep(this.itemAddAgenda),this.addSection(this.introSection)},checkAddItem:function checkAddItemFn(e){if(e.type===TrackerType.Create){var item=d.itemsById[e.data[0].itemID].model;return item.parent()!=d.getRootModel()||0!==e.data[0].position?!0:!1}},checkIndent:function checkIndentFn(e){if(e.type===TrackerType.Move){var oldParentItem=d.itemsById[e.data[0].oldParent].data;if(oldParentItem.items.indexOf(e.data[0].newParent)>=0)return!0}},checkOutdent:function checkOutdentFn(e){if(e.type===TrackerType.Move){var newParentItem=d.itemsById[e.data[0].newParent].data;if(newParentItem.items.indexOf(e.data[0].oldParent)>=0)return!0}},checkSearch:function checkSearchFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged},checkComplete:function checkCompleteFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isComplete"===v.field&&v.newValue}},checkOutline:function checkOutlineFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleOutline},initHelp:function initHelpFn(){var org=new VMIntroSection("Organization","Moo.do works like a text editor so you can organize like you're writing a document.");org.addStep(this.itemAddItem),org.addStep(this.itemIndent),org.addStep(this.itemOutdent),org.addStep({text:"Click and drag on the left edge of an item to move it around",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&g.vmMain.isLoaded?!0:void 0}}),org.addStep({text:"Press "+platform.cmdCharP+"Z to undo and "+platform.cmdCharP+"Y to redo",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.UndoRedo?!0:void 0}}),org.addStep({text:"To collapse an item and hide its children press "+platform.cmdCharP+", or select collapse from the right click menu",check:function checkFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isCollapsed"===v.field&&v.newValue}}}),this.addSection(org);var dates=new VMIntroSection("Dates","Scheduling items automatically puts them on your Agenda.");dates.addStep(this.itemDateTime),dates.addStep({text:'Write dates in plain English like <span class="date">@tomorrow</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data[0].date;return!!date}}}),dates.addStep({text:'Schedule a full date and time like <span class="date">@today 2:30pm</span> or <span class="date">@5/25 6:00</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data[0].date;if(date)return date._explicitTime}}}),dates.addStep({text:'Describe urgency with <span class="date">@now</span>, <span class="date">@soon</span>, or <span class="date">@later</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var item=d.itemsById[e.data[0].itemID].model;return item?g.isDateSoft(item.dateText):!1}}}),this.addSection(dates);var priority=new VMIntroSection("Priority","Prioritizing items automatically puts them on your agenda and lets you manage what to do next.");priority.addStep(this.itemRightClick),priority.addStep({text:"Set a priority with the right click menu or "+platform.cmdCharP+"1/2/3",check:function checkFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"priority"===v.field&&v.newValue>0}}}),priority.addStep({text:"Click the left of an item or "+platform.cmdCharP+"/ to mark it complete",check:this.checkComplete}),priority.addStep({text:"Press "+platform.cmdCharP+"' to flag an item which highlights it in yellow",check:function checkFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isFlagged"===v.field&&v.newValue}}}),this.addSection(priority);var contacts=new VMIntroSection("Contacts","Add a contact to an item to easily start a call or email.");contacts.addStep(this.itemContactsEnable),g.waitForElement("buttonHelpEnableContacts",function(el){el.onclick=function(){g.vmSettings.enableSyncContacts()}},100),contacts.addStep({text:"Add a contact by typing + in the text of an item",check:function checkFn(e){return e.type===TrackerType.Insert&&"+"===e.data[0].text}}),contacts.addStep({text:"Select a contact's name from the list or start typing a name to narrow the search",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddContact}}),contacts.addStep({text:'Click on a <span class="contact">+contact</span> to start a call or email',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenContact}}),this.addSection(contacts);var panes=new VMIntroSection("Panes","There are two types of panes: List and Agenda. The List pane is where you write and organize while the Agenda pane is organized automatically by time and priority.");panes.addStep({text:'Click <i class="icon-align-left f22 gd"></i> in the top right to add a List pane',check:function checkFn(e){if(e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane){var pane=g.vmMain.panes()[e.data[0].data];if(pane.mode()===PaneMode.Normal)return!0}}}),panes.addStep(this.itemAddAgenda),panes.addStep({text:'Click <i class="icon-remove gd"></i> in the top right of a pane to close it',check:function checkFn(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.RemovePane}}),this.addSection(panes);var focus=new VMIntroSection("Focus","Focus on an item to show only the items under it");focus.addStep({text:"To focus on an item, right click on it and select zoom or press "+platform.cmdCharP+"Enter",check:function checkFn(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut}}),focus.addStep({text:'To bring focus back out, click the <span class="titleWrapper"><span class="titleOpen">title of the list</span></span> you want to focus on',check:function checkFn(e){return e.type===TrackerType.Zoom&&e.data[0].zoomOut}}),focus.addStep({text:'Press <i class="outlineButtonNormal icon-list"></i> in the top left of a pane to open the outline',check:this.checkOutline}),focus.addStep({text:"Click the title of a list in the outline to focus on it",check:function checkFn(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut&&g.focusedPane.outline.isVisible()}}),this.addSection(focus);var search=new VMIntroSection("Search","Filter for only the items you want to see right now");search.addStep({text:"Filter for a keyword by searching for that word",check:this.checkSearch}),search.addStep({text:'Mark similar items with a <span class="tag">#tag</span> to easily search for all items matching that tag',check:function checkFn(e){return e.type===TrackerType.Insert&&"#"===e.data[0].text}}),search.addStep({text:"Filter by priority by searching for !, !!, or !!!",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("!")>=0}}),search.addStep({text:"Show only flagged items by searching for '' (two apostrophes)",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("''")>=0}}),search.addStep({text:"Hide items you're not interested in by starting a search with - (dash)",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("-")>=0}}),search.addStep({text:"Hide completed items by searching for -// (dash, two slashes)",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("-//")>=0}}),this.addSection(search);var documents=new VMIntroSection("Collaboration","Collaborate with others by sharing documents with different groups of people");documents.addStep({text:'Click <i class="icon-reorder f22 gd"></i> in the top left to open the sidebar',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleSidebar&&e.data[0].value}}),documents.addStep({text:'Click <i class="icon-plus f18 g"></i> to create a new document',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddDocument&&e.data[0].value}}),documents.addStep({text:"Open your new document by clicking on it in the list of documents",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocument&&e.data[0].value}}),documents.addStep({text:'Click <i class="icon-user f18 c g"></i> to change the sharing settings',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocSharing&&e.data[0].value}}),this.addSection(documents);var data=new VMIntroSection("Data","Import data from another app to use in Moo.do or export your data out of Moo.do");data.addStep({text:"Paste into Moo.do by pressing "+platform.cmdCharP+"V or finding Paste in your browsers edit menu",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.Paste&&e.data[0].value}}),data.addStep({text:"Copy the selected text by pressing "+platform.cmdCharP+"C or finding Copy in your browsers edit menu",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.Copy&&e.data[0].value}}),data.addStep({text:'Click on Import Data in the sidebar, then choose the app to import from and follow the instructions. If you do not see your app, try using copy and paste to paste it in to Moo.do. If that does not work, please <a href="mailto:support@moo.do?subject=Import Request">contact us</a> and tell us what app you want to import from.',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenImport&&e.data[0].value}}),data.addStep({text:"Click on Export Data in the sidebar, then choose the format you'd like. You can see your data in a new tab so you may copy or download it.",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenExport&&e.data[0].value}}),this.addSection(data),!this.itemContactsEnable.isComplete()&&g.settings.get(Settings.syncContacts)&&this.checkContactsEnable(!0),window.addEventListener("settingsChange",function(e){"syncContacts"==e.data.property&&this.checkContactsEnable(e.data.value)}.bind(this))},initMobile:function initMobileFn(){var t=g.tooltip,intro=new VMIntroSection("Mobile Intro");intro.inOrder=!0,intro.enforceOrder=!0;var self=this;intro.addStep({text:"Open Keyboard",show:function showFn(e){},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.OpenKeyboard}}),intro.addStep({text:"Press return to add another item",show:function showFn(e){self.needsKeyboardOpen=!0,t.displayTip({text:this.text,element:g.element("mobileKeyboardToolbar"),above:!0,offset:{y:-10},maxWidth:240})},check:this.checkAddItem}),intro.addStep({text:"Indent items into lists",show:function showFn(e){t.displayTip({text:this.text,element:g.element("indentButton"),above:!0,offset:{y:-10},arrow:"arrowBottom",time:200})},check:function checkFn(e){return this.checkIndent(e)||this.checkOutdent(e)}.bind(this)}),intro.addStep({text:"Add a date to a task",show:function showFn(e){t.displayTip({text:this.text,element:g.element("dateButton"),above:!0,offset:{x:0,y:-10},arrow:"arrowBottom",time:200})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.AtButton&&t.hideTip(),e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.CloseAutocomplete}}),intro.addStep({text:"Open the Agenda",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,element:g.element("modeButton"),offset:{x:5,y:8},arrow:"arrowTop"})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.PaneAgenda}}),intro.addStep({text:"The agenda shows items with dates or priorities. Go back to the List view.",show:function showFn(e){t.displayTip({text:this.text,element:g.element("modeButton"),offset:{x:5,y:8},arrow:"arrowTop"})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.PaneNormal}}),intro.addStep({text:"Tap the title to search",show:function showFn(e){t.displayTip({text:this.text,element:g.element("searchPhone"),offset:{x:0,y:8},arrow:"arrowTop",time:200})},check:this.checkSearch}),intro.addStep({text:"Wait Swipes",show:function showFn(e){t.hideTip()},check:function checkFn(e){return e.type===TrackerType.Create&&g.vmMain.root().items().length>=3?!0:void 0}}),intro.addStep({text:"Swipe left on an item to complete it",show:function showFn(e){t.displayTip({text:this.text,element:g.element("searchPhone"),offset:{x:0,y:5}})},check:this.checkComplete}),intro.addStep({text:"Swipe left even farther to enter multiselect mode",show:function showFn(e){t.displayTip({text:this.text,element:g.element("searchPhone"),offset:{x:0,y:5},time:200})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.OpenMultiselect}}),intro.addStep({text:"Wait close multiselect",show:function showFn(e){t.hideTip()},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.CloseMultiselect}}),intro.addStep({text:"Swipe right to open the Outline",show:function showFn(e){t.displayTip({text:this.text,element:g.element("searchPhone"),offset:{right:10,y:5},time:200})},check:this.checkOutline}),intro.addStep({text:"Tap a list title to focus on it",show:function showFn(e){t.displayTip({text:this.text,element:g.element("searchPhone"),offset:{right:10,y:5},time:200})},check:function checkFn(e){return e.type===TrackerType.Zoom}}),intro.addStep({text:"Open the outline again and tap on Home to go back",show:function showFn(e){t.displayTip({text:this.text,element:g.element("searchPhone"),offset:{right:10,y:5},time:200})},check:function checkFn(e){return e.type===TrackerType.Zoom?e.data[0].itemID==g.vmMain.root().id:void 0}}),intro.addStep({text:"Intro Done",show:function showFn(e){t.hideTip(),self.setMode(HelpMode.None)},check:g.fTrue}),this.addSection(intro),window.addEventListener("closeKeyboard",function(e){this.needsKeyboardOpen&&g.tooltip.hideTip()}.bind(this)),window.addEventListener("keyboardOpened",function(e){try{g.PAssert(1384,this.sections().length>0,"Should have one section on mobile")}catch(PERR){g.reportError(PERR)}this.sections()[0].showFirstIncomplete(e)}.bind(this))},addMobileStep:function addMobileStepFn(step){this.sections.push(step)},onAction:function onActionFn(e){try{for(var i=0;i<this.sections().length;i++)this.sections()[i].check(e)}catch(err){g.reportError(err)}},onClosePane:function onClosePaneFn(e){g.tooltip.hideTip(),g.vmMain.closeHelp(),this.setMode(HelpMode.None)},introComplete:function introCompleteFn(){return this.introSection&&this.introSection.isComplete()},switchToHelp:function switchToHelpFn(){this.initHelp(),this.setMode(HelpMode.Normal),this.sections.splice(0,1),delete this.introSection,this.saveState()}},VMIntro}),define("VMMain",["ko","globals","util","android","data","gdata","goog","edit","copypaste","VMMain_DragDrop","VMLI","VMTitle","tracker","platform","VMSearch","VMPane","VMMenus","VMSettings","VMPicker","VMPhoneMenu","VMKeyboardToolbar","VMHelp","parseWorker","VMIntro"],function(ko,g,util,android,d,gdata,goog,edit,copypaste,VMMain_DragDrop,VMLI,VMTitle,tracker,platform,VMSearch,VMPane,VMMenus,VMSettings,VMPicker,VMPhoneMenu,VMKeyboardToolbar,VMHelp,parseWorker,VMIntro){var VMMain=function(){function createWorkerSource(callback){try{g.PAssert(1389,window.helperWrapper,"helperWrapper must be defined for worker to be created")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1390,window.dateWrapper,"dateWrapper must be defined for worker to be created")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1391,window.parseWorkerWrapper,"parseWorkerWrapper must be defined for worker to be created")}catch(PERR){g.reportError(PERR)}var workerSource;if(platform.ie)workerSource="js/parseWorker.js",window.helperWrapper=void 0,window.dateWrapper=void 0,window.parseWorkerWrapper=void 0,delete window.helperWrapper,delete window.dateWrapper,delete window.parseWorkerWrapper;else try{var helperString=window.helperWrapper.toString(),dateString=window.dateWrapper.toString(),workerString=window.parseWorkerWrapper.toString(),execString="parseWorkerWrapper();";window.URL=window.URL||window.webkitURL,workerSource=window.URL.createObjectURL(new Blob([helperString,dateString,workerString,execString],{type:"text/javascript"}))}catch(err){ShouldLog(LogLevels.Warning)&&log("---- WARNING: Blob URLs not supported, falling back to default web worker support! ----"),ShouldLog(LogLevels.Warning)&&log(JSON.stringify(err)),workerSource="js/parseWorker.js"}finally{window.helperWrapper=void 0,window.dateWrapper=void 0,window.parseWorkerWrapper=void 0,delete window.helperWrapper,delete window.dateWrapper,delete window.parseWorkerWrapper}return workerSource}function setupWorker(){if(!self.worker){if(!window.Worker)return ShouldLog(LogLevels.Warning)&&log("---- WARNING: Running without WebWorker support! ----"),self.supportWebWorker=!1,void(self.worker=void 0);var workerSource=createWorkerSource();try{self.worker=new Worker(workerSource)}catch(err){if(18===err.code)try{self.worker=new Worker("js/parseWorker.js")}catch(err2){g.reportError(err2)}else g.reportError(err)}self.worker?(self.worker.onmessage=function(e){if(g.isString(e.data))return void log("Message from worker: ",e.data);log("Worker Finished: ",e.data.end-e.data.start,"ms");for(var handlerIndex=-1,resHandler,i=0;i<pendingRequests.length;++i)pendingRequests[i].id===e.data.id&&(resHandler=pendingRequests[i],handlerIndex=i);try{g.PAssert(1392,resHandler,"Must have a valid response handler")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1393,resHandler.id===e.data.id,"Respose handler should match request")}catch(PERR){g.reportError(PERR)}if(pendingRequests.splice(handlerIndex,1),e.data.styles)for(var i=0;i<e.data.styles.length;++i){var styles=e.data.styles[i],model=d.getModel(resHandler.items[i].id);if(model){var changedStyles={};model.styleText(styles,!0,changedStyles)&&model.save(changedStyles,SaveFlag.None)}}e.data.done&&resHandler.cb&&resHandler.cb(),e.data.styles||e.data.done||log("Error in parse worker: ",e)},self.worker.onerror=function(e){log("Error in ParseWorker: ",e,e.message),g.reportError(new Error("Worker reported error"))}):self.supportWebWorker=!1}}function workerRun(arr,callback){try{g.PAssert(1394,self.worker,"Worker must exist")}catch(PERR){g.reportError(PERR)}if(self.supportWebWorker){var requestID=messageID++;pendingRequests.push({id:requestID,cb:callback,items:arr});var msgData={id:requestID,items:arr};sentContacts||(msgData.contacts=d.getContacts(),sentContacts=!0),self.worker.postMessage(msgData)}}function runRemoteLoad(rootItem){g.isLoadingRemote=!0;try{d.beginTransaction(),g.timeline.startLoading();var lastServerVersion=g.settings.get(Settings.lastServerVersion),currentServerVersion=gdata.getServerVersion();lastServerVersion===currentServerVersion&&log("Client and Server Versions Match!"),g.startTimeEvent("PageLoad","RemoteData","Load Remote Data"),tracker.beginAction();var previousLocalIntegrity=g.settings.get(Settings.localIntegrity);previousLocalIntegrity===!1&&(ShouldLog(LogLevels.Warning)&&log("Previous remote sync had an issue!"),g.reportError(new Error("Previous remote sync had an issue!"))),gdata.loadSeen={},REPORT_ACTIONS&&d.reportData(DataSnapshot.Before),g.settings.set(Settings.localIntegrity,!1),self.root().initFromGDrive(rootItem),g.settings.set(Settings.localIntegrity,!0),REPORT_ACTIONS&&d.reportData(DataSnapshot.After),gdata.loadSeen={},tracker.endAction(),self.flushParseItems(function(){for(var i=0;i<self.panes().length;i++)self.panes()[i].vmSearch.updateSearch(!0)}),self.flushModifiedItems(function(items){log("Flushing Modified: ",Object.keys(items).length)}),g.timeline.endLoading(),d.hasLocalData&&self.root().resetModified(),d.clearPendingUpdates(),g.endTimeEvent(),g.fireCustomEvent("remoteDataLoaded")}catch(err){g.reportError(err),g.messageQueue.pushMessage({text:"There was an error loading your data from the server, consider reloading the app.",type:MessageType.Error,action:MessageAction.Reload})}finally{d.endTransaction(),g.isLoadingRemote=!1,g.vmMain.isLoadingDoc(!1),g.StopSpinner()}}function restoreLoadSelection(){if(!platform.mobile){var setSelection=g.restoreSavedSelection("loadData");if(!setSelection&&g.focusedPane&&!g.focusedPane.isTimeline()){var firstItem=g.getFirstPaneItem(g.focusedPane);firstItem&&g.setSelection(firstItem.getSpan(),0,0)}}}var self={root:ko.observable(void 0),panes:ko.observableArray(),height:ko.observable(0),isHelpShowing:ko.observable(!1),isLoaded:!1,numCols:ko.observable(),hasResized:ko.observable(!1),isSidebarOpen:!1,helpButtonHidden:ko.observable(!1),gdriveStatus:ko.observable(-1),main:void 0,mainTransform:0,isPhone:platform.phone,outline:void 0,vmSettings:new VMSettings(this),supportWebWorker:!0,swipingScreens:!1,swipeDirection:0,lastSwipeMove:0,lastSwipeMoveTime:0,vmPicker:new VMPicker,vmHelp:new VMHelp,selected:ko.observableArray(),help:void 0};g.vmMain=self,platform.mobile&&(self.elPhoneMenu=g.element("phoneMenu")),g.vmSettings=self.vmSettings,self.isOnline=function isOnlineFn(){return self.gdriveStatus()!==DriveStatus.Offline},self.isLocal=function isLocalFn(){return"localhost"==window.location.hostname
},self.onlineText=function onlineTextFn(){if(self.isDemoMode())return"DEMO";switch(self.gdriveStatus()){case DriveStatus.Connecting:return"CONNECTING";case DriveStatus.Offline:return"OFFLINE";case DriveStatus.Saving:case DriveStatus.Saved:return"ONLINE";case DriveStatus.Reconnecting:return"RETRYING"}},VMMain_DragDrop(self);var worker,nextPaneId=0;self.maxWidth=ko.computed({read:function readFn(){if(self.isPhone)return platform.windowWidth()+"px";var width=800*self.panes().length+(self.isHelpShowing()?400:0);return width+"px"},deferEvaluation:!0}),self.needsPadTop=ko.computed({read:function readFn(){return self.isPhone?void 0:800*self.panes().length+(self.isHelpShowing()?400:0)+170>platform.windowWidth()}}),self.pinButtons=ko.computed({read:function readFn(){return platform.windowWidth()>800*self.panes().length},deferEvaluation:!0}),self.getUserName=ko.computed({read:function readFn(){var user=gdata.authenticatedUser();return user?user.displayName:self.gdriveStatus()===DriveStatus.Saved?"Connected":g.vmSetup.loginState()==LoginState.LOGGED_IN?"Connecting":"Demo"},deferEvaluation:!0}),self.getUserImage=function getUserImageFn(){var user=gdata.authenticatedUser();return user?user.photoUrl:void 0},self.isDemoMode=function isDemoModeFn(){return g.isDemoMode()},window.addEventListener("scriptLoadError",function(e){self.handleScriptLoadError(e)}),self.handleScriptLoadError=function handleScriptLoadErrorFn(e){"gapiScript"===e.data.id&&(log("Failed to load GAPI!"),self.setGDriveStatus(DriveStatus.Offline),self.failedGapiLoad=!0,setTimeout(goog.goOnline,3e4))},self.setGDriveStatus=function setGDriveStatusFn(status){var prevStatus=self.gdriveStatus();status!==prevStatus&&status!==DriveStatus.Saving&&(self.gdriveStatus(status),status===DriveStatus.Offline?(g.goOffline(),platform.mobile&&g.messageQueue.pushMessage(MessageID.MobileOffline)):prevStatus===DriveStatus.Offline&&(g.goOnline(),platform.mobile&&g.messageQueue.clearMessage(MessageID.MobileOffline)))},self.init=function initFn(){copypaste.init()},self.onLoad=function onLoadFn(element){if(platform.isTouchDevice&&!platform.app)for(var outlines=document.getElementsByClassName("paneOutline"),i=0;i<outlines.length;++i)outlines[i].addEventListener(platform.touchStartEvent,function(e){return g.preventScrollPropagation(ele)?void 0:(e.preventDefault(),!1)});platform.mobile&&setTimeout(function(){g.ScreenManager.computeSnapPoints(),platform.mobileie&&g.ScreenManager.scrollToScreen(window.Screens.List,0)}.bind(this),0)},self.addModifiedItem=function addModifiedItemFn(item){},self.flushModifiedItems=function flushModifiedItemsFn(callback){};var parseItems=[];self.addParseItem=function addParseItemFn(item,isRemoteLoad){self.addItemToArrayForWorker(item,isRemoteLoad,parseItems)},self.flushParseItems=function flushParseItemsFn(callback){try{g.PAssert(1386,callback,"Callback required")}catch(PERR){g.reportError(PERR)}parseItems.length>0&&!goog.loadingContacts&&self.runParseWorker(parseItems,callback),parseItems=[]},self.runParseWorkerNewContacts=function runParseWorkerNewContactsFn(){if(self.root()){var contactParseItems=[];self.parseWorkerNewContactsHelper(self.root(),contactParseItems),contactParseItems.length>0&&self.runParseWorker(contactParseItems)}},self.parseWorkerNewContactsHelper=function parseWorkerNewContactsHelperFn(item,array){try{g.PAssert(1387,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}var rawText=item.getRawText();rawText.indexOf(ContactPrefix)>=0&&array.push({id:item.id,text:item.getRawText(),isUpdate:!1,prevDate:item.getDateTime()});for(var items=item.items(),i=0;i<items.length;i++)self.parseWorkerNewContactsHelper(items[i],array)},self.addItemToArrayForWorker=function addItemToArrayForWorkerFn(item,isRemoteLoad,array){array.push({id:item.id,text:item.getRawText(),isUpdate:!isRemoteLoad&&item.isLoaded,prevDate:item.getDateTime()})},self.addChildrenToArrayForWorker=function addChildrenToArrayForWorkerFn(item,isRemoteLoad,array){try{g.PAssert(1388,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}array.push({id:item.id,text:item.getRawText(),isUpdate:!isRemoteLoad&&item.isLoaded,prevDate:item.getDateTime()});for(var items=item.items(),i=0;i<items.length;i++)self.addChildrenToArrayForWorker(items[i],isRemoteLoad,array)};var messageID=0,pendingRequests=[],sentContacts=!1;self.notifyContactsUpdated=function notifyContactsUpdatedFn(){sentContacts=!1},self.runParseWorker=function runParseWorkerFn(input,callback){var parseStart=performance.now(),arr;if(input&&input instanceof Array){try{g.PAssert(1395,input instanceof Array,"Inputs to runParseWorker must either be: undefined, single item or an array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1396,input.length>0,"Shouldnt run the parse worker with no items in the input array")}catch(PERR){g.reportError(PERR)}log("Running Parse Worker for Array: ",input.length),arr=input}else{arr=[];var item=input;input?log("Running Parse Worker for Item: ",input.id):(item=self.root(),log("Running Parse Worker for Root.")),item&&self.addChildrenToArrayForWorker(item,!1,arr)}setupWorker(),self.supportWebWorker?(log("Parsing Items Async: ",arr.length),workerRun(arr,callback)):setTimeout(function(){log("Parsing Items Sync: ",arr.length);for(var contacts=d.getContacts(),i=0;i<arr.length;++i){var entry=arr[i],styles=DuchessHelpers.parseText(entry.text,entry.prevDate,entry.isUpdate,contacts),model=d.getModel(entry.id);if(model){var changedStyles={};model.styleText(styles,!0,changedStyles)&&model.save(changedStyles,SaveFlag.None)}}},0)},self.createPane=function createPaneFn(index,mode){isNaN(index)&&(index=self.panes().length);var newPane=new VMPane({id:nextPaneId++,item:self.root(),mode:mode});return self.addPane(newPane,index),self.setFocusedPane(newPane),newPane},self.removePane=function removePaneFn(pane){for(var paneArr=self.panes(),i=0;i<paneArr.length;i++)if(pane==paneArr[i])return self.removePaneAtIndex(i),self.setFocusedPane(paneArr[0]),i;return-1},self.removeFocusPane=function removeFocusPaneFn(){if(g.focusedPane&&self.panes().length>1){var index=self.removePane(g.focusedPane);tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:index}),g.sendEvent("Hotkey","ClosePane"),g.tooltip.hideTip()}},self.paneCount=function paneCountFn(){return self.panes().length};var lastDateRollover=0;self.setupDateRollover=function setupDateRolloverFn(){var currentTime=new Date,nextRolloverTime=currentTime.clone().addDays(1).clearTime();try{g.PAssert(1397,nextRolloverTime>currentTime,"Rollover time must be in the future")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1398,nextRolloverTime>lastDateRollover,"Rollover time must be after the last rollover")}catch(PERR){g.reportError(PERR)}return log("Next Rollover Time: ",nextRolloverTime),setTimeout(function(){function runRolloverWork(){self.runParseWorker(),g.timeline.reloadTimelines(),log("-------------------------------")}try{g.PAssert(1399,self.isLoaded,"Expect that we have fully loaded the page before performing rollover")}catch(PERR){g.reportError(PERR)}log("---- Running Date Rollover ----"),lastDateRollver=new Date;var nextTime=self.setupDateRollover();g.settings.get(Settings.syncContacts)?(goog.loadedContacts=!1,goog.loadContacts(runRolloverWork)):runRolloverWork()},nextRolloverTime-currentTime),nextRolloverTime};var hasLoadedRemoteData=!1;self.notifyDriveDisconnect=function notifyDriveDisconnectFn(){hasLoadedRemoteData=!1},self.loadGDriveData=function loadGDriveDataFn(){if(!hasLoadedRemoteData){hasLoadedRemoteData=!0,platform.mobile||g.saveSelection("loadData");var rootItem=gdata.rootItem;self.root().linkToGDrive(rootItem);try{gdata.checkRemoteIntegrity()}catch(err){g.reportError(err)}var localRoot=d.getRootItem();localRoot.id!==rootItem.id?d.modifyItemId(localRoot.id,rootItem.id,function(){var item=d.getModel(rootItem.id);try{g.PAssert(1400,localRoot.id===rootItem.id,"IDs should have been modified in modifyItemId")}catch(PERR){g.reportError(PERR)}localRoot.id=rootItem.id,d.setRoot(rootItem.id),item.forceModifiedItems=!0,runRemoteLoad(rootItem),d.hasLocalData||item.items.valueHasMutated(),restoreLoadSelection()}):(runRemoteLoad(rootItem),restoreLoadSelection()),self.vmPicker.refreshFiles()}};var hasLoadedData=!1;self.loadData=function loadDataFn(){function addContact(name){var email="fake_"+name.replace(" ","");contacts.push({id:"contact_"+contactId++,name:name,isDemo:!0,emails:[{address:email+"@moo.do",primary:!0}],phoneNumbers:[{number:"(555) 123-4567",type:"mobile"}]})}if(!hasLoadedData&&d.localDataLoaded()){if(hasLoadedData=!0,g.startTimeEvent("PageLoad","LocalData","Load Local Data"),self.root(new VMLI(d.getRootItem())),g.checkpoint(Checkpoint.LocalDocLoad),g.endTimeEvent(),g.requireGDriveDataCallback&&self.loadGDriveData(),self.isDemoMode()){var contacts=[],contactId=0;addContact("Ramada"),addContact("Canyon Ranch"),addContact("Jim Joseph"),addContact("Miller Harris"),addContact("Bob Johnson"),addContact("Bill Wilson"),addContact("Emily Edwards"),addContact("Jane Johnson"),addContact("Mike Thomas"),addContact("Joe Lewis"),addContact("Grant"),addContact("Jay"),addContact("Steve"),addContact("Melissa"),addContact("Mikey"),addContact("Bart"),d.loadContacts(contacts,!0)}self.runParseWorker(void 0,function(){var testData=util.getURLParam("data");self.isDemoMode()&&(platform.script&&g.vmSetup.runScript(util.getURLParam("script")),window.parent.postMessage("loaded","*"))}),self.afterLoaded(),g.startTimeEvent("PageLoad","ApplyBindings","Apply Bindings"),g.applyBindings(self,"container");for(var i=0;i<self.panes().length;i++)self.panes()[i].vmSearch.onUpdated.valueHasMutated();self.isLoaded=!0,document.getElementById("container").style.display="block",g.endTimeEvent()}},self.changeRoot=function changeRootFn(rootId){try{g.PAssert(1401,rootId,"Cannot use to reset root to undefined")}catch(PERR){g.reportError(PERR)}var needsParse=!1,newRoot=d.getModel(rootId);newRoot||(newRoot=new VMLI(d.getItem(rootId)),needsParse=!0);try{g.PAssert(1402,newRoot,"Must have a new root VMLI at this point, otherwise failed creation")}catch(PERR){g.reportError(PERR)}if(newRoot){self.root(newRoot);for(var i=0;i<self.panes().length;i++)self.panes()[i].item(newRoot),self.panes()[i].notifyOfZoom();needsParse&&self.runParseWorker(void 0)}},self.resetScrollOffsets=function resetScrollOffsetsFn(){for(var i=0;i<self.panes().length;i++){var pane=self.panes()[i];pane.setScrollOffset(pane.defaultOffset)}},self.helpMessage=function helpMessageFn(){return platform.mobile?"Welcome to Moo.do! If this is your first time here take a minute to orient yourself, otherwise your data will be here shortly.":"Welcome to Moo.do! If this is your first time here take a minute to orient yourself and import your data, otherwise your data will be here shortly. You can access the introduction at a later time through the top-right menu."},self.onTapMain={onClick:function onClickFn(e){self.isDemoMode()&&platform.script&&window.parent.postMessage("click","*")}},self.addPane=function addPaneFn(pane,index){try{g.PAssert(1403,pane,"Must pass in a valid pane to update")}catch(PERR){g.reportError(PERR)}var paneState=g.settings.get(Settings.paneState);paneState||(paneState=[]);try{g.PAssert(1404,paneState.length===self.panes().length,"Pane state does not match currently loaded pane set")}catch(PERR){g.reportError(PERR)}void 0===index?self.panes.push(pane):self.panes.splice(index,0,pane),paneState.push({id:pane.id,focus:pane.item().id,mode:pane.mode(),showarch:pane.showArchived(),search:pane.vmSearch.search(),offset:0}),g.settings.set(Settings.paneState,paneState)},self.removePaneAtIndex=function removePaneAtIndexFn(index){try{g.PAssert(1405,void 0!==index,"Must pass in a valid index to remove")}catch(PERR){g.reportError(PERR)}var paneState=g.settings.get(Settings.paneState);try{g.PAssert(1406,paneState,"Pane state should always be valid when removing panes")}catch(PERR){g.reportError(PERR)}if(paneState){try{g.PAssert(1407,paneState.length===self.panes().length,"Pane state does not match currently loaded pane set")}catch(PERR){g.reportError(PERR)}paneState.splice(index,1)}self.panes.splice(index,1),g.settings.set(Settings.paneState,paneState)},self.afterLoaded=function afterLoadedFn(){var paneState;if(self.isDemoMode()?self.clearPaneState():paneState=g.settings.get(Settings.paneState),paneState){for(var i=0;i<paneState.length&&!(platform.mobile&&i>0);++i){var paneInfo=paneState[i];paneInfo.id=nextPaneId;var item=d.getModel(paneInfo.focus);item||(item=self.root(),paneInfo.focus=item.id,paneInfo.offset=0,paneInfo.search="");try{g.PAssert(1408,item,"Should always have a valid item at this point")}catch(PERR){g.reportError(PERR)}var pane=new VMPane({id:nextPaneId++,item:item,mode:paneInfo.mode,search:paneInfo.search,offset:paneInfo.offset});paneInfo.showarch&&pane.showArchived(!0),self.panes.push(pane),self.setFocusedPane(pane,!0),self.zoomin(item,!0)}1!==self.panes().length&&self.setFocusedPane(self.panes()[0],!0)}if(self.isDemoMode()&&g.demoPanes){for(var i=0;i<g.demoPanes.length;i++){var paneInfo=g.demoPanes[i].split(","),paneInit={id:nextPaneId++,item:self.root(),mode:+paneInfo[0]};if(paneInfo.length>1&&(paneInfo[1]&&(paneInit.search=paneInfo[1]),paneInfo[2])){var focusModel=d.getModel(paneInfo[2]);paneInit.item=focusModel||self.root()}self.addPane(new VMPane(paneInit))}var pane=self.panes()[0];g.focusedPaneID=pane.id,g.focusedPane=pane,g.focusedItem=pane.item(),self.zoomin(pane.item(),!0)}else if(0===self.panes().length){var pane=new VMPane({id:nextPaneId++,item:self.root()});if(self.addPane(pane),!platform.mobile&&g.activeDisplayMode&DisplayMode.ForceTwoPane){var pane2=new VMPane({id:nextPaneId++,item:self.root(),mode:PaneMode.Timeline});self.addPane(pane2)}g.focusedPaneID=pane.id,g.focusedPane=pane,g.focusedItem=self.root(),self.zoomin(self.root(),!0)}platform.mobile&&(g.phoneMenu=new VMPhoneMenu,g.keyboardToolbar=new VMKeyboardToolbar),g.timeline.updateNotifications()},self.clearPaneState=function clearPaneStateFn(){g.settings.reset(Settings.paneState)},self.updatePaneState=function updatePaneStateFn(pane){if(!g.isRunningScript()&&!platform.mobile){try{g.PAssert(1410,pane,"Must pass in a valid pane to update")}catch(PERR){g.reportError(PERR)}var paneState=g.settings.get(Settings.paneState);try{g.PAssert(1411,paneState,"Pane state should always be valid when updating state")}catch(PERR){g.reportError(PERR)}if(paneState){try{g.PAssert(1412,paneState.length===self.panes().length,"Pane state does not match currently loaded pane set")}catch(PERR){g.reportError(PERR)}for(var paneStateFound=!1,i=0;i<paneState.length;++i){var info=paneState[i];if(info.id===pane.id){info.focus=pane.item().id,info.mode=pane.mode(),info.showarch=pane.showArchived(),info.search=pane.vmSearch.search(),g.settings.set(Settings.paneState,paneState),paneStateFound=!0;break}}try{g.PAssert(1413,paneStateFound,"Pane state should always be found")}catch(PERR){g.reportError(PERR)}}}},self.updatePaneScrollState=function updatePaneScrollStateFn(){if(!g.isRunningScript()&&!platform.mobile){var paneState=g.settings.get(Settings.paneState);if(paneState&&self.panes().length>0){try{g.PAssert(1414,paneState.length===self.panes().length,"Pane state does not match currently loaded pane set")}catch(PERR){g.reportError(PERR)}for(var i=0;i<paneState.length;++i){var info=paneState[i],pane=self.panes()[i];info.offset=pane?pane.getScrollOffset():0}g.settings.set(Settings.paneState,paneState)}}};var prevRange;self.getFirstSelectedItem=function getFirstSelectedItemFn(){try{g.PAssert(1416,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}return self.selected().length>0?self.selected()[0]:void 0},self.setSelected=function setSelectedFn(selection){try{g.PAssert(1417,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}selection=selection||[],self._clearIsSelected(selection);for(var i=0;i<selection.length;i++)selection[i].isSelected(!0);self.selected(selection)},self._clearIsSelected=function _clearIsSelectedFn(newSelected){try{g.PAssert(1418,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}newSelected=newSelected||[];for(var i=0;i<self.selected().length;i++){var selectedItem=self.selected()[i];newSelected.indexOf(selectedItem)<0&&selectedItem.isSelected(!1)}},self.clearSelected=function clearSelectedFn(newSelected){try{g.PAssert(1419,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}self._clearIsSelected(newSelected),self.selected([])},platform.mobile&&(document.onselectionchange=function(e){var selection=g.getSelectionInfo(),itemsChanged=!0,arrToSelect;if(g.ignoreSelectionChange)return g.ignoreSelectionChange=!1,void(prevRange=void 0);if(selection){if(platform.android&&g.dragging)return void g.clearSelection();var range=selection.selection.getRangeAt(0);if(itemsChanged=!prevRange||range.startContainer!==prevRange.startContainer||range.endContainer!==prevRange.endContainer,prevRange&&!itemsChanged&&range.startOffset==prevRange.startOffset&&range.endOffset==prevRange.endOffset)return;if("itemOptions"===range.startContainer.id||"fullscreenClickGrabber"===range.startContainer.id)return;if(prevRange=range,g.focusedPane&&g.focusedPane.mode()===PaneMode.Normal){var origLIParent=g.getLIParent(range.startContainer),origStart=origLIParent?ko.dataFor(origLIParent):void 0,skipUpdates=!origStart||!origStart instanceof VMPane&&!origStart instanceof VMLI;if(skipUpdates);else{g.restrictSelectionToText(),selection=g.getSelectionInfo(),range=selection.selection.getRangeAt(0);var startLI=g.getLIParent(range.startContainer),endLI=g.getLIParent(range.endContainer);if(startLI&&endLI&&!g.hasClass(startLI,"emptyPaneItem")&&!g.hasClass(endLI,"emptyPaneItem")){var item=ko.dataFor(startLI);try{g.PAssert(1420,item,"Must have a valid item to set as selection")}catch(PERR){g.reportError(PERR)}if(itemsChanged)if(startLI!==endLI){try{g.PAssert(1421,!platform.android&&!platform.mobile,"Multi-select is not enabled in mobile android")}catch(PERR){g.reportError(PERR)}var endItem=ko.dataFor(endLI);arrToSelect=g.getItemsBetween(item,endItem,g.focusedPane)}else arrToSelect=[item],android.isEnabled()&&!platform.mobileie&&android.updateInput(item)}}}}else(platform.android||platform.mobileie||platform.ios&&(!platform.app||platform.ipad))&&(platform.mobileie&&android.isEnabled()&&android.isVisible()||g.fireCustomEvent("closeKeyboard"));selection||(prevRange=void 0),!itemsChanged||platform.android||platform.mobileie||self.setSelected(arrToSelect)}),self.setFocusedPaneFromElement=function setFocusedPaneFromElementFn(element){if(element){var paneEl=g.hasClass(element,"paneRoot")?element:g.getPaneForElement(element).rootElement,pane=ko.dataFor(paneEl);try{g.PAssert(1422,pane,"Could not find matching pane")}catch(PERR){g.reportError(PERR)}self.setFocusedPane(pane)}};var hasCalledNonLoad=!1;self.setFocusedPane=function setFocusedPaneFn(pane,forLoad){pane&&g.focusedPaneID!==pane.id&&(hasCalledNonLoad=!forLoad,g.focusedPaneID=pane.id,g.focusedPane=pane,g.focusedItem=g.focusedPane.item())},self.zoomin=function zoominFn(item,forLoad){try{g.PAssert(1423,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var oldItem=g.focusedItem;self._zoom(item,forLoad);var pane=g.focusedPane;forLoad||g.sendEvent("Menu","ZoomIn"),!platform.mobile&&pane.paneContent&&g.setSelection(pane.paneContent,0,0),pane.rootElement?pane.setScrollOffset():setTimeout(function(){pane.setScrollOffset()},0),item.isCollapsed()&&item.toggleCollapsed(),forLoad||tracker.performAction(TrackerType.Zoom,{itemID:item.id,oldItemID:oldItem.id,zoomOut:!1,time:g.zoomTime})},self.zoomout=function zoomoutFn(item,zoomedOutFrom){try{g.PAssert(1424,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var oldItem=g.focusedItem;self._zoom(item,!1),g.sendEvent("Menu","ZoomOut"),g.selectChildren(zoomedOutFrom,zoomedOutFrom.getParsedText().length,0),g.scrollToTop(zoomedOutFrom.getSpan(),0),tracker.performAction(TrackerType.Zoom,{itemID:item.id,oldItemID:oldItem.id,zoomOut:!0,time:g.zoomTime})},self._zoom=function _zoomFn(item,forLoad){try{g.PAssert(1425,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var oldItem=g.focusedItem;oldItem&&oldItem.id===item.id||(g.focusedPane.item(item),g.focusedPane.notifyOfZoom(),g.focusedItem=item,forLoad||self.updatePaneState(g.focusedPane))},self.onMenuButtonClick=function onMenuButtonClickFn(e){self.isSidebarOpen?(self.closeSidebar(),g.sendEvent("Menu","CloseSidebar")):(self.openSidebar(),g.sendEvent("Menu","OpenSidebar"))},self.onHelpButtonClick=function onHelpButtonClickFn(e){this.showHelp(HelpMode.Normal),g.sendEvent("Menu","HelpMain")},self.onHelpMouseOver=function onHelpMouseOverFn(e){},self.onHelpMouseOut=function onHelpMouseOutFn(e){};var cheatSheet=document.getElementById("cheatSheetContainer");self.openCheatSheet=function openCheatSheetFn(){var helpEle=document.getElementById("desktopHelpButton").getBoundingClientRect();cheatSheet.style.top=helpEle.bottom+5+"px",g.removeClass(cheatSheet,"none")},self.closeCheatSheet=function closeCheatSheetFn(){g.addClass(cheatSheet,"none")},self.closeSidebarEvent=function closeSidebarEventFn(e){return self.isSidebarOpen?(self.closeSidebar(),e.preventDefault(),!1):void 0},g.addCustomEventListener("keyEscape",self.closeSidebarEvent,200),self.openSidebar=function openSidebarFn(){self.isSidebarOpen=!0,g.autocomplete&&g.autocomplete.hide(),g.tooltip.hideTip(),g.setTransform(g.element("container"),250,0),setTimeout(function(){g.element("main").addEventListener("mouseup",self.closeSidebarEvent)},0),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleSidebar,data:[{value:!0}]})},self.closeSidebar=function closeSidebarFn(){self.isSidebarOpen=!1,g.setTransform(g.element("container"),0,0),g.element("main").removeEventListener("mouseup",self.closeSidebarEvent),g.hideHighlightElement(),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleSidebar,data:[{value:!1}]})};var grabber=document.getElementById("fullscreenClickGrabber"),fullscreenClickHandled=!1;self.handleFullscreenClick=function handleFullscreenClickFn(callback){fullscreenClickHandled||(g.setupClick(grabber,void 0,{onRightClick:function onRightClickFn(e){grabber.style.display="none";var realElem=document.elementFromPoint(e.clientX,e.clientY),pane=g.getPaneForElement(realElem);pane&&pane.onTap.onRightClick({srcElement:realElem,pageX:e.x,pageY:e.y,preventDefault:function preventDefaultFn(){e.preventDefault()},stopPropagation:function stopPropagationFn(){e.stopPropagation()},stopImmediatePropagation:function stopImmediatePropagationFn(){e.stopImmediatePropagation()}}),grabber.style.display=""},onEnd:function onEndFn(e){self.cancelFullscreenClick(),callback()}}),g.removeClass(grabber,"none"),fullscreenClickHandled=!0)},self.cancelFullscreenClick=function cancelFullscreenClickFn(){fullscreenClickHandled&&(g.addClass(grabber,"none"),g.menus.closeAllMenus(),fullscreenClickHandled=!1)},self.applyFnToSelection=function applyFnToSelectionFn(fn,params){var toggle=params&&params.toggle||params===!0,value=params&&void 0!==params.value?params.value:!0;if(self.applyToSelection(function(item){toggle&&item[fn]()!==value&&(toggle=!1),toggle||item[fn](value)}),toggle){var emptyValue=emptyValue=params&&void 0!==params.emptyValue?params.emptyValue:!1;self.applyToSelection(function(item){item[fn](emptyValue)})}},self.applyPriorityToSelection=function applyPriorityToSelectionFn(pri,toggle){toggle?self.applyFnToSelection("priority",{toggle:!0,value:pri,emptyValue:VMLIFlag.None}):self.applyFnToSelection("priority",{value:pri})},self.insertCharacter=function insertCharacterFn(character,withSpace){var text;if(android.isEnabled()){text=android.getInputText();var prevChar=text[android.getSelectionStart()-1];withSpace&&" "!==prevChar?android.insertText(android.getSelectionStart()," "+character):android.insertText(android.getSelectionStart(),character)}else{var range=g.getSelectionRange();if(range){var item=g.getItemForElement(range.startContainer);if(item){text=item.getRawText();var prevChar=text[range.startOffset-1];withSpace&&" "!==prevChar&&g.fireKeyEvent(void 0,{normCode:KeyCode.Space}),g.fireKeyEvent(void 0,{normCode:character.charCodeAt(0)})}}}},self.applyToSelection=function applyToSelectionFn(action,options){var passExtraInfo=options&&options.passExtraInfo;if(platform.mobile){var nextItem=android.getCurrentVMLI(),endItem=android.getCurrentVMLI();if(void 0===nextItem||void 0===endItem)return!0}else{var selection=g.getSelectionInfo();if(!selection||0===selection.rangeCount)return!0;if(selection.node&&g.hasClass(selection.node,"search"))return!0;var pane=g.getPaneForElement(selection.node);if(!pane)return!0;if(g.restrictSelectionToText(),selection=g.getSelectionInfo(),!selection||0===selection.rangeCount)return!0;var range=selection.selection.getRangeAt(0);if(g.hasClass(range.startContainer.parentNode,"timelineItemTime"))return!0;var nextItem=g.getItemForElement(range.startContainer),endItem=g.getItemForElement(range.endContainer);if(void 0===nextItem||void 0===endItem)return!0}tracker.beginAction(),nextItem!==endItem&&0===range.endOffset&&(endItem=g.getPreviousItem(endItem,g.focusedPane));for(var items=g.getItemsBetween(nextItem,endItem,g.focusedPane),tempPanes=self.panes(),tempNumPanes=tempPanes.length,i=0;i<items.length;++i){var actionRetVal=passExtraInfo?action(items[i],i,items.length):action(items[i]);if(actionRetVal===!1)break;for(var u=0;tempNumPanes>u;u++)tempPanes[u]!=g.focusedPane&&tempPanes[u].vmSearch.checkItem(items[i])}return tracker.endAction(),items.length};var prevMove={over:void 0,wasPointer:!1};self.updateCursor=function updateCursorFn(ctrlPressed){prevMove&&prevMove.over&&(ctrlPressed&&("A"===prevMove.over.tagName||g.hasClass(prevMove.over,"tag"))?(prevMove.wasPointer=!0,prevMove.over.style.cursor="pointer"):!ctrlPressed&&prevMove.wasPointer&&(prevMove.wasPointer=!1,prevMove.over.style.cursor="text"))},platform.touch||(self.mousemove=function mousemove(e){if(!g.disableMouseMove&&(e.pageX!==prevMove.pageX||e.pageY!==prevMove.pageY)){prevMove.pageX=e.pageX,prevMove.pageY=e.pageY;var to=e.srcElement||e.target;if(e.offsetX>=0&&e.offsetX<=18){var prevLI=g.getLIParent(prevMove.over),newLI=g.getLIParent(to);newLI&&g.addClass(newLI,"hoveredFormatter"),prevLI&&prevLI!==newLI&&g.removeClass(prevLI,"hoveredFormatter")}else{var prevLI=g.getLIParent(prevMove.over);prevLI&&g.removeClass(prevLI,"hoveredFormatter")}e.ctrlKey&&("A"===to.tagName||g.hasClass(to,"tag"))?(prevMove.wasPointer&&(prevMove.over.style.cursor="text"),prevMove.wasPointer=!0,to.style.cursor="pointer"):prevMove.wasPointer&&(prevMove.wasPointer=!1,prevMove.over.style.cursor="text"),prevMove.over=to}},g.element("container").addEventListener("mousemove",self.mousemove)),self.addPaneToRight=function addPaneToRightFn(mode){var index=self.panes().length,pane=self.createPane(index,mode);self.cancelFullscreenClick(),mode===PaneMode.Normal&&pane.vmSearch.focusBox(),tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.AddPane,data:index})},self.onTapAddNormal=function onTapAddNormalFn(){self.addPaneToRight(PaneMode.Normal),g.sendEvent("Menu","AddPaneNormal")},self.onTapAddTimeline=function onTapAddTimelineFn(){self.addPaneToRight(PaneMode.Timeline),g.sendEvent("Menu","AddPaneTimeline")},self.showSearchSeparator=function showSearchSeparatorFn(){return!platform.mobile||g.phoneMenu.showSearchSeparator()},self.onTapSettingsPhone={onStart:function onStartFn(e){g.ScreenManager.checkSwipeStart(e)},onMove:function onMoveFn(e){g.ScreenManager.checkSwipeMove(e)},onEnd:function onEndFn(e){g.ScreenManager.checkSwipeEnd(e)}},self.isLoadingDoc=function isLoadingDocFn(value){for(var i=0;i<self.panes().length;i++)value?g.addClass(self.panes()[i].paneContent,"loading"):g.removeClass(self.panes()[i].paneContent,"loading")},self.showHelp=function showHelpFn(helpState){var openState=helpState||HelpMode.Intro;this.help||(this.help=new VMIntro(openState),this.helpButtonHidden(openState===HelpMode.Intro)),platform.mobile||(openState===HelpMode.Normal&&this.help.mode()!==HelpMode.Normal&&this.help.switchToHelp(),this.isHelpShowing(!0))},self.closeHelp=function closeHelpFn(){self.isHelpShowing(!1),self.helpButtonHidden(!1)};var helpPaneState=util.storage.getItem("helpIntro")?g.settings.get(Settings.helpPaneState):HelpMode.Intro;return helpPaneState===HelpMode.None||g.isDemoMode()||self.showHelp(helpPaneState),self.init(),self};return VMMain});var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(view){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},URL=view.URL||view.webkitURL||view,save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=doc.createEvent("MouseEvents");event.initMouseEvent("click",!0,!1,view,0,0,0,0,0,!1,!1,!1,!1,0,null),node.dispatchEvent(event)},webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},force_saveable_type="application/octet-stream",fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){for(var i=deletion_queue.length;i--;){var file=deletion_queue[i];"string"==typeof file?URL.revokeObjectURL(file):file.remove()}deletion_queue.length=0},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},FileSaver=function(blob,name){var filesaver=this,type=blob.type,blob_changed=!1,object_url,target_view,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);return deletion_queue.push(object_url),object_url},dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){(blob_changed||!object_url)&&(object_url=get_object_url(blob)),target_view?target_view.location.href=object_url:window.open(object_url,"_blank"),filesaver.readyState=filesaver.DONE,dispatch_all()},abortable=function(func){return function(){return filesaver.readyState!==filesaver.DONE?func.apply(this,arguments):void 0}},create_if_not_found={create:!0,exclusive:!1},slice;return filesaver.readyState=filesaver.INIT,name||(name="download"),can_use_save_link?(object_url=get_object_url(blob),save_link.href=object_url,save_link.download=name,click(save_link),filesaver.readyState=filesaver.DONE,void dispatch_all()):(view.chrome&&type&&type!==force_saveable_type&&(slice=blob.slice||blob.webkitSlice,blob=slice.call(blob,0,blob.size,force_saveable_type),blob_changed=!0),webkit_req_fs&&"download"!==name&&(name+=".download"),(type===force_saveable_type||webkit_req_fs)&&(target_view=view),req_fs?(fs_min_size+=blob.size,void req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL(),deletion_queue.push(file),filesaver.readyState=filesaver.DONE,dispatch(filesaver,"writeend",event)},writer.onerror=function(){var error=writer.error;error.code!==error.ABORT_ERR&&fs_error()},"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]}),writer.write(blob),filesaver.abort=function(){writer.abort(),filesaver.readyState=filesaver.DONE},filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:!1},abortable(function(file){file.remove(),save()}),abortable(function(ex){ex.code===ex.NOT_FOUND_ERR?save():fs_error()
}))}),fs_error)}),fs_error)):void fs_error())},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name)};return FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE,dispatch(filesaver,"abort")},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,view.addEventListener("unload",process_deletion_queue,!1),saveAs}(self);define("FileSaver",function(){}),define("dimport",["globals","data","tracker","VMLI","parse","goog"],function(g,d,tracker,VMLI,parser,goog){function dimport(){this.workflowy={login:this.workflowyLogin.bind(this),"import":this.workflowyImport.bind(this),save:this.workflowySave.bind(this)},this.wunderlist={login:this.wunderlistLogin.bind(this),"import":this.wunderlistImport.bind(this),save:this.wunderlistSave.bind(this)},this.opml={login:this.opmlLogin.bind(this),"import":this.opmlImport.bind(this),save:this.opmlSave.bind(this)},this.json={login:this.jsonLogin.bind(this),"import":this.jsonImport.bind(this),save:this.jsonSave.bind(this)},this.text={login:this.textLogin.bind(this),"import":this.textImport.bind(this),save:this.textSave.bind(this)},this.gtasks={login:this.gtasksLogin.bind(this),"import":this.gtasksImport.bind(this),save:this.gtasksSave.bind(this)},this.trello={login:this.trelloLogin.bind(this),"import":this.trelloImport.bind(this),save:this.trelloSave.bind(this)},this.toodledo={login:this.toodledoLogin.bind(this),"import":this.toodledoImport.bind(this),save:this.toodledoSave.bind(this)}}var importData={};return dimport.prototype={workflowyLogin:function workflowyLoginFn(username,password,cb,error){try{g.PAssert(1426,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1427,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"POST",url:window.location.protocol+"//api.moo.do/oauth/workflowy",data:{username:username,password:password},cb:function cbFn(xhr){log("Login Response: ",xhr),200===xhr.status?(this.workflowy.data=JSON.parse(xhr.response),cb()):(log("XHR Status: "+xhr.status),error("Error contacting remote server."))}.bind(this)})},workflowyImport:function workflowyImportFn(cb,error){try{g.PAssert(1428,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1429,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}cb(this.workflowy.data)},workflowyIterateItem:function workflowyIterateItemFn(item,parentVMLI){var IS_COMPLETE_VALUE=673732,IS_DEFAULT_VALUE=139527,IS_UNKNOWN_VALUE0=139529,IS_UNKNOWN_VALUE1=204343,IS_UNKNOWN_VALUE2=673731;try{g.PAssert(1430,item&&void 0!==item.lm&&void 0!==item.nm,"All items must exist and have flags and text, children and notes are optional",item)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1431,item.lm===IS_COMPLETE_VALUE||item.lm===IS_DEFAULT_VALUE||item.lm===IS_UNKNOWN_VALUE0||item.lm===IS_UNKNOWN_VALUE1,"Unexpected lm value for workflowy import: "+item.lm)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1432,parentVMLI,"A valid parent must always be defined")}catch(PERR){g.reportError(PERR)}if(item&&parentVMLI){var isComplete=item.lm===IS_COMPLETE_VALUE,itemVMLI=new VMLI({text:item.nm,isComplete:isComplete},{parent:parentVMLI,parse:!0,forceSave:!0});if(parentVMLI.insertItem(itemVMLI),item.no){var noteVMLI=new VMLI({text:item.no},{parent:itemVMLI,parse:!0,forceSave:!0});itemVMLI.insertItem(noteVMLI)}if(item.ch)for(var i=0;i<item.ch.length;++i){var entry=item.ch[i];this.workflowyIterateItem(entry,itemVMLI)}}},workflowySave:function workflowySaveFn(data,cb,error){try{g.PAssert(1433,data,"Workflowy requires having valid data")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1434,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1435,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}var project=data.projectTreeData.mainProjectTreeInfo;try{tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(1436,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Workflowy Import:"},{parent:docRoot,parse:!0,forceSave:!0});docRoot.insertItem(impRoot);for(var i=0;i<project.rootProjectChildren.length;++i){var entry=project.rootProjectChildren[i];this.workflowyIterateItem(entry,impRoot)}g.vmMain.runParseWorker(impRoot),tracker.endAction(),cb()}catch(err){error(void 0,err)}},wunderlistLogin:function wunderlistLoginFn(username,password,cb,error){try{g.PAssert(1437,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1438,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"POST",url:"https://api.wunderlist.com/login",data:{email:username,password:password},cb:function cbFn(xhr){if(log("Login Response: ",xhr),200===xhr.status){var data=JSON.parse(xhr.response);this.wunderlist.token=data.token,cb(data)}else log("XHR Status: "+xhr.status),error("Error contacting remote server.")}.bind(this)})},wunderlistImport:function wunderlistImportFn(cb,error){try{g.PAssert(1439,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1440,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}this.wunderlistGetLists(function(lists){this.wunderlistGetTasks(function(tasks){for(var data={inbox:{title:"inbox",items:{},p:0}},i=0;i<lists.length;++i){var list=lists[i];data[list.id]={title:list.title,items:{},p:list.position}}for(var i=0;i<tasks.length;++i){var task=tasks[i];if(task.parent_id){var taskParent=data[task.list_id].items[task.parent_id];taskParent?(taskParent.items||(taskParent.items=[]),taskParent.items.push(task)):data[task.list_id].items[task.parent_id]={items:[task]}}else{var prevData=data[task.list_id].items[task.id];data[task.list_id].items[task.id]=task,prevData&&(data[task.list_id].items[task.id].items=prevData.items)}}cb(data)}.bind(this),error)}.bind(this),error)},wunderlistGetLists:function wunderlistGetListsFn(cb,error){try{g.PAssert(1441,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1442,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://api.wunderlist.com/me/lists",headers:{Authorization:this.wunderlist.token},cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);cb(data)}else log("XHR Status: "+xhr.status),error("Error contacting remote server.")}.bind(this)})},wunderlistGetTasks:function wunderlistGetTasksFn(cb,error){try{g.PAssert(1443,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1444,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://api.wunderlist.com/me/tasks",headers:{Authorization:this.wunderlist.token},cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);cb(data)}else log("XHR Status: "+xhr.status),error("Error contacting remote server.")}.bind(this)})},wunderlistSave:function wunderlistSaveFn(data,cb,error){try{g.PAssert(1445,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1446,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}try{tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(1447,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Wunderlist Import:"},{parent:docRoot,parse:!0,forceSave:!0});docRoot.insertItem(impRoot);for(var listId in data){var list=data[listId],listText=list.title+(":"!==list.title[list.title.length-1]?":":""),listVMLI=new VMLI({text:listText},{parent:impRoot,parse:!0,forceSave:!0});impRoot.insertItem(listVMLI);for(var taskId in list.items){var task=list.items[taskId],taskVMLI=new VMLI({text:task.title,isComplete:!!task.completed_at,dateCompleted:task.completed_at,isFlagged:task.starred},{parent:listVMLI,parse:!0,forceSave:!0});if(listVMLI.insertItem(taskVMLI),task.note){var noteVMLI=new VMLI({text:task.note},{parent:taskVMLI,parse:!0,forceSave:!0});taskVMLI.insertItem(noteVMLI)}if(task.items)for(var j=0;j<task.items.length;++j){var subtask=task.items[j],subtaskVMLI=new VMLI({text:subtask.title,isComplete:!!subtask.completed_at,dateCompleted:subtask.completed_at,isFlagged:subtask.starred},{parent:taskVMLI,parse:!0,forceSave:!0});taskVMLI.insertItem(subtaskVMLI)}}}g.vmMain.runParseWorker(impRoot),tracker.endAction(),cb()}catch(err){error(void 0,err)}},opmlLogin:function opmlLoginFn(user,pw,cb,error){try{g.PAssert(1448,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1449,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},opmlImport:function opmlImportFn(cb,error){try{g.PAssert(1450,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1451,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}try{var fReader=new FileReader,fileImport=document.forms.importFileUpload.importFile.files[0];fileImport?(fReader.onload=function(e){var data=e.target.result,xml;if((data.startsWith("<?xml ")||data.startsWith("<opml "))&&(xml=g.loadXML(data)),xml){var res=parser.parseOPML(xml,fileImport.name);res?cb():error("Error parsing OPML, please validate your data")}else error("Unable to load XML lib, please update or try another browser")},fReader.onerror=error,fReader.readAsText(fileImport)):error("You must select a file before importing")}catch(err){error(void 0,err)}},opmlSave:function opmlSaveFn(data,cb,error){try{g.PAssert(1452,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1453,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}log("OPML Save: ",data),cb()},jsonLogin:function jsonLoginFn(user,pw,cb,error){try{g.PAssert(1454,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1455,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},jsonImport:function jsonImportFn(cb,error){try{var fReader=new FileReader,fileImport=document.forms.importFileUpload.importFile.files[0];fileImport?(fReader.onload=function(e){var data=e.target.result;if(data)try{var parsedObj=JSON.parse(data),res=parser.parseJSON(parsedObj);res?cb():error("Error parsing JSON, please validate your data")}catch(errParse){error(void 0,errParse)}else error("Unable to import your requested file, please try agani")},fReader.onerror=error,fReader.readAsText(fileImport)):error("You must select a file before importing")}catch(err){error(void 0,err)}},jsonSave:function jsonSaveFn(data,cb,error){try{g.PAssert(1456,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1457,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}log("JSON Save: ",data),cb()},textLogin:function textLoginFn(user,pw,cb,error){try{g.PAssert(1458,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1459,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},textImport:function textImportFn(cb,error){var data=document.getElementById("importFileDataBox").textContent,xml;if(data.startsWith("<?xml ")||data.startsWith("<opml "))try{if(xml=g.loadXML(data)){var res=parser.parseOPML(xml,fileImport.name);if(res)return void cb()}}catch(errParse){}if(data.startsWith("{")&&data.endsWith("}"))try{var parsedObj=JSON.parse(data),res=parser.parseJSON(parsedObj);if(res)return void cb()}catch(errParse){}error("Text Import Not Supported")},textSave:function textSaveFn(data,cb,error){try{g.PAssert(1460,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1461,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}log("Text Save: ",data),cb()},gtasksLogin:function gtasksLoginFn(username,password,cb,error){try{g.PAssert(1462,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1463,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}goog.runAuthenticate([GScope.TasksRO],!1,!1,function(token){token&&!token.error?(this.gtasks.token=token,cb(token)):error("Unable to authenticate with Google, please try again",token)}.bind(this))},gtasksImport:function gtasksImportFn(cb,error){try{g.PAssert(1464,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1465,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var info={roots:[],remoteItems:{},unassigned:[]};this.gtasksGetLists(function(listData){try{g.PAssert(1466,g.isArray(listData),"List data must be an array")}catch(PERR){g.reportError(PERR)}for(var i=0;i<listData.length;++i){var list=listData[i];info.remoteItems[list.id]={id:list.id,text:list.title,isComplete:!1,dateCompleted:void 0,isArchived:!1,due:void 0,notes:void 0,parent:void 0,items:[]},info.roots.push(list.id),this.gtasksGetTasks(list,function(taskData){try{g.PAssert(1467,g.isArray(taskData),"List data must be an array")}catch(PERR){g.reportError(PERR)}for(var j=0;j<taskData.length;++j){var task=taskData[j];info.remoteItems[task.id]={id:task.id,text:task.title,isComplete:"completed"===task.status,dateCompleted:task.completed?new Date(task.completed):void 0,isArchived:task.hidden,due:task.due?new Date(task.due):void 0,notes:task.notes,parent:task.parent||list.id,items:[]};var parent=info.remoteItems[task.parent||list.id];parent?parent.items.push(task.id):info.unassigned.push(task.id)}cb(info)}.bind(this),error)}}.bind(this),error)},gtasksGetLists:function gtasksGetListsFn(cb,error){try{g.PAssert(1468,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1469,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var maxResults=2e3;g.XHR({type:"GET",url:"https://www.googleapis.com/tasks/v1/users/@me/lists?maxResults="+maxResults+"&key="+window.gapiKey+"&access_token="+goog.getAccessToken(),cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);try{g.PAssert(1470,data.items,"Must have a valid array of lists")}catch(PERR){g.reportError(PERR)}cb(data.items)}else log("XHR Status: "+xhr.status),error("Error contacting remote server.")}.bind(this)})},gtasksGetTasks:function gtasksGetTasksFn(list,cb,error){try{g.PAssert(1471,list,"GTasks requires a valid list to get tasks from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1472,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1473,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var maxResults=5e3;g.XHR({type:"GET",url:"https://www.googleapis.com/tasks/v1/lists/"+list.id+"/tasks?maxResults="+maxResults+"&key="+window.gapiKey+"&access_token="+goog.getAccessToken(),cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);try{g.PAssert(1474,data.items,"Must have a valid array of tasks")}catch(PERR){g.reportError(PERR)}cb(data.items)}else log("XHR Status: "+xhr.status),error("Error contacting remote server.")}.bind(this)})},gtasksSave:function gtasksSaveFn(data,cb,error){function traverse(node,parentVMLI){var itemText=node.text;node.due&&(itemText+=" @"+node.due.toString("MMM d"));var itemVMLI=new VMLI({text:itemText,isComplete:node.isComplete,dateCompleted:node.dateCompleted?node.dateCompleted.getTime():node.dateCompleted,isArchived:node.isArchived},{parent:parentVMLI,parse:!0,forceSave:!0});if(parentVMLI.insertItem(itemVMLI),node.notes){var notesVMLI=new VMLI({text:node.notes},{parent:itemVMLI,parse:!0,forceSave:!0});itemVMLI.insertItem(notesVMLI)}for(var i=0;i<node.items.length;++i)traverse(data.remoteItems[node.items[i]],itemVMLI)}try{g.PAssert(1475,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1476,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}try{try{g.PAssert(1477,0===data.unassigned.length,"We should never have unassigned tasks")}catch(PERR){g.reportError(PERR)}tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(1478,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Google Tasks Import:"},{parent:docRoot,parse:!0,forceSave:!0});docRoot.insertItem(impRoot);for(var i=0;i<data.roots.length;++i)traverse(data.remoteItems[data.roots[i]],impRoot);g.vmMain.runParseWorker(impRoot),tracker.endAction(),cb()}catch(err){error(void 0,err)}},trelloLogin:function trelloLoginFn(username,password,cb,error){function trelloAuthSuccess(){Trello.members("me",function(){},error)}function trelloAuthError(){error()}var appKey="667ecf0c3d3e029c51d205b7173f6c38";g.addScript("http://code.jquery.com/jquery-1.7.1.min.js","jqueryScript",function(){g.addScript("https://api.trello.com/1/client.js?key="+appKey,"trelloScript",function(){try{g.PAssert(1479,Trello,"The Trello client lib musthave been loaded correctly")}catch(PERR){g.reportError(PERR)}Trello.authorize({type:"popup",name:"Moo.do",persist:!1,expiration:"1hour",success:trelloAuthSuccess,error:trelloAuthError})}.bind(this))}.bind(this))},trelloImport:function trelloImportFn(cb,error){},trelloSave:function trelloSaveFn(data,cb,error){},toodledoLogin:function toodledoLoginFn(username,password,cb,error){var clientID="DuchessToodledoClientID",state="Dchs"+(new Date).getTime(),url="https://api.toodledo.com/3/account/authorize.php?response_type=code&client_id="+clientID+"&state="+state+"&scope=basic%20tasks%20notes%20outlines%20lists",popup=window.open(url,"toodledo","height=600,width=550"),handleRelayMessage=function(e){var validOrigin=e.origin===location.origin;validOrigin&&(window.removeEventListener("message",handleRelayMessage),e.data.error?error(e.data.error):(this.toodledo.token=e.data.access_token,cb()))}.bind(this);window.addEventListener("message",handleRelayMessage)},toodledoImport:function toodledoImportFn(cb,error){},toodledoSave:function toodledoSaveFn(data,cb,error){}},dimport}),define("VMDebug",["ko","globals","platform","data","FileSaver","goog","dimport"],function(ko,g,platform,d,FileSaver,goog,dimport){function VMDebug(){this.bugDescription=ko.observable(""),this.mode=ko.observable("html"),this.exportedContent="",this.exportedPreview=ko.observable(""),this.exportArchived=ko.observable(!0),this.importName=ko.observable("JSON"),this.importDisplayMessage=ko.observable(""),this.importing=!1,this.importer=new dimport,this.init()}return VMDebug.prototype={init:function initFn(){this.exportArchived.subscribe(this.exportData.bind(this)),g.menus.registerModal("reportBug",this,this.reportBug),g.menus.registerModal("importData",this),g.menus.registerModal("exportData",this,this.openExport.bind(this),this.closeExport.bind(this))},reportBug:function reportBugFn(){setTimeout(function(){document.getElementById("bugDescription").focus()})},onTapSaveBug:function onTapSaveBugFn(){var appInfo={};g.getAppInfo(appInfo);var notes=this.bugDescription()+"\r\n\r\n\r\n"+JSON.stringify(appInfo,void 0,3),indexOfNewline=this.bugDescription().indexOf("\n"),name=this.bugDescription().substr(0,indexOfNewline>=0?indexOfNewline:Math.min(this.bugDescription().length,120)),bug={name:name,notes:notes};bug.email=g.getUserIdentifier();var sendBug=function(){g.XHR({type:"POST",url:window.location.protocol+"//api.moo.do/debug/reportIssue",data:bug,cb:function cbFn(xhr){log("XHR Response: ",xhr.status,xhr),this.bugDescription("")}.bind(this)})}.bind(this);"Unknown"!==bug.email?sendBug():g.getClientInfo(function(info){info&&(bug.email=info.ip),sendBug()}),g.menus.closeModal("reportBug"),g.messageQueue.pushMessage({text:"Thanks for taking the time to send us feedback!",type:MessageType.Info,action:MessageAction.Default,timeout:1500}),g.blurActiveElement(),platform.mobile&&g.vmMain.clearSelected()},onTapCancelBug:function onTapCancelBugFn(){g.menus.closeModal("reportBug"),g.blurActiveElement(),platform.mobile&&g.vmMain.clearSelected()},openExport:function openExportFn(){this.exportData(),this.exportKeyHandler=this.onExportKeydown.bind(this),document.addEventListener("keydown",this.exportKeyHandler,!0)},closeExport:function closeExportFn(){document.removeEventListener("keydown",this.exportKeyHandler,!0),this.exportKeyHandler=void 0},onTapCloseExport:function onTapCloseExportFn(){g.menus.closeModal("exportData")},exportData:function exportDataFn(){var content,preview,root=d.getRootItem();if("html"==this.mode())content=d.toHtml(root,this.exportArchived()),preview=content;else if("plain"==this.mode()){var tab="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";content=d.toPlainText(root,0,this.exportArchived()),preview=content.replace(/\n/g,"<br>").replace(/\t/g,tab)}else"json"==this.mode()&&(content=d.toJSON(root,!1,this.exportArchived()),preview=content);this.exportedContent=content,this.exportedPreview(preview)},onTapHTML:function onTapHTMLFn(e){this.mode("html"),this.exportData(),this.highlightExportButton(e)},onTapPlain:function onTapPlainFn(e){this.mode("plain"),this.exportData(),this.highlightExportButton(e)},onTapJSON:function onTapJSONFn(e){this.mode("json"),this.exportData(),this.highlightExportButton(e)},highlightExportButton:function highlightExportButtonFn(e){e.srcElement||(e.srcElement=e.target);var btnParent=document.getElementById("exportTypes");if(btnParent)for(var i=0;i<btnParent.children.length;++i){var btn=btnParent.children[i];g.hasClass(btn,"button")&&(btn!==e.srcElement?g.removeClass(btn,"bSelected"):g.addClass(btn,"bSelected"))}},onTapOpen:function onTapOpenFn(){var content="plain"==this.mode()?this.exportedPreview():this.exportedContent,newWin=open("url");newWin.document.write(content)},onTapSelect:function onTapSelectFn(){var range=document.createRange();range.selectNodeContents(document.getElementById("exportedContent"));var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)},onTapSaveExport:function onTapSaveExportFn(){var ext;"html"==this.mode()?ext="html":"plain"==this.mode()?ext="txt":"json"==this.mode()&&(ext="json");try{var blob=new Blob([this.exportedContent],{type:"text/plain;charset=utf-8"});saveAs(blob,"moodo."+ext)}catch(err){g.reportError(err)}},onExportKeydown:function onExportKeydownFn(e){return platform.normalizeKeys(e),(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.normCode===KeyCode.A?(this.onTapSelect(),e.preventDefault(),e.stopPropagation(),!1):void 0},closeImport:function closeImportFn(){g.menus.closeModal("importData")},isAreaVisible:function isAreaVisibleFn(area){switch(this.importName()){case"Wunderlist":return"LoginArea"===area;case"Workflowy":return"LoginArea"===area;case"OPML":return"UploadArea"===area;case"JSON":return"UploadArea"===area;case"Text":return"TextArea"===area;case"Google Tasks":return"OAuthArea"===area;case"Trello":return"LoginArea"===area;case"Toodledo":return"OAuthArea"===area;default:try{g.PAssert(1480,!1,"Must add valid importer")}catch(PERR){g.reportError(PERR)}}return!1},highlightImportButton:function highlightImportButtonFn(e){e.srcElement||(e.srcElement=e.target);var btnParent=document.getElementById("importLocations");if(btnParent)for(var i=0;i<btnParent.children.length;++i){var btn=btnParent.children[i];btn!==e.srcElement?g.removeClass(btn,"bSelected"):g.addClass(btn,"bSelected")}},onTapRunImportWunderlist:function onTapRunImportWunderlistFn(e){this.importName("Wunderlist"),this.highlightImportButton(e)},onTapRunImportWorkflowy:function onTapRunImportWorkflowyFn(e){this.importName("Workflowy"),this.highlightImportButton(e)},onTapRunImportOPML:function onTapRunImportOPMLFn(e){this.importName("OPML"),this.highlightImportButton(e)},onTapRunImportJSON:function onTapRunImportJSONFn(e){this.importName("JSON"),this.highlightImportButton(e)},onTapRunImportText:function onTapRunImportTextFn(e){this.importName("Text"),this.highlightImportButton(e)},onTapRunImportGTasks:function onTapRunImportGTasksFn(e){this.importName("Google Tasks"),this.highlightImportButton(e)},onTapRunImportTrello:function onTapRunImportTrelloFn(e){this.importName("Trello"),this.highlightImportButton(e)},onTapRunImportToodledo:function onTapRunImportToodledoFn(e){this.importName("Toodledo"),this.highlightImportButton(e)},onTapRunImport:function onTapRunImportFn(){if(!this.importing){var onImportError=function(msg,err){try{var message=msg;message&&g.isString(message)||(message="There was an unexpected error, please double check your data"),this.importing=!1,this.importDisplayMessage(message),g.reportError(err||msg,msg)}catch(errErr){g.reportError(errErr)}}.bind(this),loginName=document.getElementById("importEmail").value,loginPW=document.getElementById("importPW").value,importFn=void 0;switch(this.importName()){case"Wunderlist":importFn=this.importer.wunderlist;break;case"Workflowy":importFn=this.importer.workflowy;break;case"OPML":importFn=this.importer.opml;break;case"JSON":importFn=this.importer.json;break;case"Text":importFn=this.importer.text;break;case"Google Tasks":importFn=this.importer.gtasks;break;case"Trello":importFn=this.importer.trello;break;case"Toodledo":importFn=this.importer.toodledo;break;default:try{g.PAssert(1481,!1,"Must add valid importer")}catch(PERR){g.reportError(PERR)}}importFn&&(this.importing=!0,importFn.login(loginName,loginPW,function(){importFn.import(function(data){importFn.save(data,function(){this.importDisplayMessage("Your data was imported successfully!"),this.importing=!1,setTimeout(function(){g.menus.closeModal("importData")}.bind(this),2e3)}.bind(this),onImportError)}.bind(this),onImportError)}.bind(this),onImportError))}},importTitle:function importTitleFn(){var name=this.importName();return"OPML"!==name&&"JSON"!==name&&"Text"!==name?"Importing data from "+this.importName():"Upload "+name+" File"},importMessage:function importMessageFn(){return this.importDisplayMessage()}},VMDebug}),define("VMTimeline",["ko","globals","platform","data"],function(ko,g,platform,d){function VMTimeline(p){this.itemsToSchedule={},this.scheduleTimeout=0}return VMTimeline.prototype={shouldNotify:function shouldNotifyFn(item,now){return now||(now=new Date),!item.isComplete()&&item.date()&&item.date()>now&&!item.allDayDate&&!item.isArchived()},updateNotifications:function updateNotificationsFn(item){if((platform.ios||platform.android)&&platform.app&&!g.isDemoMode()&&g.vmSettings.enabledNotifications()){var num=0,now=new Date;if(item)this.shouldNotify(item,now)&&(this.itemsToSchedule[item.id]=item,num=1);else{var self=this;g.searchVMLIs({item:g.vmMain.root(),includeArchived:!1,comparator:function comparatorFn(item){return self.shouldNotify(item,now)},action:function actionFn(item){num++,self.itemsToSchedule[item.id]=item}})}this.scheduleTimeout&&(clearTimeout(this.scheduleTimeout),this.scheduleTimeout=void 0),num>0&&(this.scheduleTimeout=setTimeout(this.sendNotifications.bind(this),500))}},clearNotifications:function clearNotificationsFn(){platform.sendToApp("scheduledItems","[]")},sendNotifications:function sendNotificationsFn(){var json="[",first=!0;for(var prop in this.itemsToSchedule)if(this.itemsToSchedule.hasOwnProperty(prop)){var item=this.itemsToSchedule[prop];item.date()&&(first||(json+=","),json+=item.getBasicJSON(),first=!1)}json+="]",platform.sendToApp("scheduledItems",json),this.itemsToSchedule={}},notifyPositionChanged:function notifyPositionChangedFn(item){for(var i=0;i<g.vmMain.panes().length;++i)g.vmMain.panes()[i].notifyPositionChanged(item)},notifyStateChanged:function notifyStateChangedFn(item,type){if(item.date()&&type==PropChangeType.Date)this.dateUpdated(item);else for(var i=0;i<g.vmMain.panes().length;++i)g.vmMain.panes()[i].notifyStateChanged(item,type)},dateUpdated:function dateUpdatedFn(item){g.vmMain.root()&&this.updateNotifications(item);for(var i=0;i<g.vmMain.panes().length;i++)g.vmMain.panes()[i].notifyStateChanged(item,PropChangeType.Date)},reloadTimelines:function reloadTimelinesFn(){for(var i=0;i<g.vmMain.panes().length;i++)g.vmMain.panes()[i].reloadTimeline()},load:function loadFn(){},startLoading:function startLoadingFn(){for(var i=0;i<g.vmMain.panes().length;i++)g.vmMain.panes()[i].startLoading()},endLoading:function endLoadingFn(){for(var i=0;i<g.vmMain.panes().length;i++)g.vmMain.panes()[i].endLoading()}},VMTimeline}),define("VMMessage",["ko","globals","util","data"],function(ko,g,util,d){function VMMessage(info,queue){try{g.PAssert(1483,info,"Must provide valid message info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1484,queue,"Must provide a valid message owner")}catch(PERR){g.reportError(PERR)}this.id=info.id,this.owner=queue,this.text=info.text,this.type=info.type||MessageType.Info,this.action=info.action||MessageAction.Default,this.block=info.block||!1,this.bottom=info.bottom||!1,this.onCloseFn=info.onClose,this.timeout=info.timeout,this.clearTimeout=void 0,this._isVisible=!1}return VMMessage.prototype={show:function showFn(){this._isVisible||(this._isVisible=!0,this.timeout&&(this.clearTimeout=setTimeout(this.hide.bind(this),this.timeout)),this.block&&g.removeClass(document.getElementById("overlayBlocker"),"none"),this.owner.onMessageShow(this))},hide:function hideFn(noNotify){this._isVisible&&(this._isVisible=!1,clearTimeout(this.clearTimeout),this.clearTimeout=void 0,this.onCloseFn&&this.onCloseFn(this),noNotify||this.owner.onMessageHide(this))},isVisible:function isVisibleFn(){return this._isVisible},getClass:function getClassFn(){var cls;switch(this.type){case MessageType.Info:cls="messageInfo";break;case MessageType.Intro:cls="messageIntro";break;case MessageType.Warning:cls="messageWarning";break;case MessageType.Error:cls="messageError";break;case MessageType.Fatal:cls="messageFatal";break;case MessageType.Subtitle:cls="messageSubtitle";break;case MessageType.RequiredUpdate:cls="messageRequiredUpdate";break;case MessageType.InfoGray:cls="messageInfoGray";break;case MessageType.MobileOffline:cls="messageMobileOffline";break;default:try{g.PAssert(1485,!1,"Invalid message type, add to globals.js")}catch(PERR){g.reportError(PERR)}cls="messageInfo"}return this.bottom&&(cls+=" bottom"),cls},doAction:function doActionFn(e){if(this.isVisible()){if(g.isFunction(this.action))this.action();else switch(this.action){case MessageAction.Default:this.hide();break;case MessageAction.Reload:g.reload(),this.hide();break;case MessageAction.Login:util.removeURLParam("demo"),this.hide();break;case MessageAction.Demo:util.insertURLParam("demo","true"),this.hide();break;case MessageAction.ResetClient:d.clearData(function(){g.reload()}),this.hide();break;case MessageAction.SyncContacts:break;case MessageAction.None:break;default:try{g.PAssert(1486,!1,"Invalid message action, add a new case here or pass in a function",this.action)}catch(PERR){g.reportError(PERR)}this.hide()}e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0}},onTapIgnore:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){this.isVisible()&&(this.hide(),e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0)}}},VMMessage}),define("VMMessageQueue",["ko","globals","util","platform","data","VMMessage"],function(ko,g,util,platform,d,VMMessage){function VMMessageQueue(){this.queue=ko.observableArray(),this.remoteMessages={},this.defaultMessages=[],this.defaultMessages[MessageID.Undefined]=void 0,this.hasConnectionError=!1,this.hasFatalError=!1,this.hasDocChange=!1,this.hasOfflineWarning=!1,this.hasOnlineInfo=!1,this.hasCacheReset=!1,this.hasRequiredUpdate=!1,this.currentFilter=0,this.FilterType={Mobile:1,Desktop:2,App:4},this.init()}return VMMessageQueue.prototype={init:function initFn(){g.applyBindings(this,"overlayArea"),platform.demo||platform.offline||setTimeout(this.updateRemoteMessages.bind(this),5e3),this.computeFilter()},getMessageById:function getMessageByIdFn(id){void 0===this.defaultMessages[id]&&this.initMessageByid(id);try{g.PAssert(1487,void 0!==this.defaultMessages[id],"After init message should always be defined")
}catch(PERR){g.reportError(PERR)}return this.defaultMessages[id]},testMessageById:function testMessageByIdFn(id){return!!this.defaultMessages[id]},initMessageByid:function initMessageByidFn(id){switch(id){case MessageID.ConnectionError:this.defaultMessages[id]=new VMMessage({text:"Connection error detected, "+platform.actionVerb()+" here to reconnect.",type:MessageType.Error,action:MessageAction.Reload},this);break;case MessageID.OfflineUndo:this.defaultMessages[id]=new VMMessage({text:"Offline undo/redo has been disabled temporarily",type:MessageType.Info},this);break;case MessageID.FatalError:this.defaultMessages[id]=new VMMessage({text:"There was a fatal error in the application, "+platform.actionVerb()+" here to restart.",type:MessageType.Error,action:MessageAction.Reload},this);break;case MessageID.DocChange:this.defaultMessages[id]=new VMMessage({text:"The active document was changed in another tab, "+platform.actionVerb()+" here to restart.",type:MessageType.Fatal,action:MessageAction.Reload,block:!0},this);break;case MessageID.OfflineWarn:this.defaultMessages[id]=new VMMessage({text:"You are offline and not saving your changes locally or remotely, you must reconnect before closing the window or you will lose your changes.",type:MessageType.Warning},this);break;case MessageID.OnlineInfo:this.defaultMessages[id]=new VMMessage({text:"You have gone back online, your changes have been saved.",type:MessageType.Info,timeout:1e4},this);break;case MessageID.CacheReset:this.defaultMessages[id]=new VMMessage({text:"To fix your issues we are going to clear the local cache. This will reload the page and your data, "+platform.actionVerb()+" here to continue.",type:MessageType.Info,action:MessageAction.ResetClient},this);break;case MessageID.RequiredUpdate:this.defaultMessages[id]=new VMMessage({text:"A software update is required to continue, "+platform.actionVerb()+" to update.",type:MessageType.RequiredUpdate,action:MessageAction.Reload,block:!0},this);break;case MessageID.Updated:this.defaultMessages[id]=new VMMessage({text:"An update was installed. "+platform.actionVerbCaps()+" to reload.",type:MessageType.RequiredUpdate,action:MessageAction.Reload,bottom:!0},this);break;case MessageID.MobileOffline:this.defaultMessages[id]=new VMMessage({text:"OFFLINE",type:MessageType.MobileOffline,action:MessageAction.None,bottom:!0},this);break;case MessageID.SyncContacts:this.defaultMessages[id]=new VMMessage({text:"Enable contact syncing to insert contacts into your document.",type:MessageType.Info,action:MessageAction.SyncContacts,timeout:1e4},this);break;default:try{g.PAssert(1488,!1,"Invalid MessageID")}catch(PERR){g.reportError(PERR)}}},pushMessage:function pushMessageFn(msg){var vmMsg;if(msg instanceof VMMessage)vmMsg=msg;else if(g.isObject(msg))vmMsg=new VMMessage(msg,this);else if(g.isString(msg))vmMsg=new VMMessage({text:msg},this);else if(vmMsg=this.getMessageById(msg),!vmMsg){try{g.PAssert(1489,!1,"Invalid data passed to message creation")}catch(PERR){g.reportError(PERR)}log("Message not created properly",msg)}return vmMsg&&vmMsg.show(),vmMsg},clearMessage:function clearMessageFn(msg){var vmMsg;return msg instanceof VMMessage?vmMsg=msg:this.testMessageById(msg)&&(vmMsg=this.getMessageById(msg)),vmMsg&&vmMsg.hide(),vmMsg},onMessageShow:function onMessageShowFn(msg){this.queue.push(msg)},onMessageHide:function onMessageHideFn(msg){try{g.PAssert(1490,msg,"Must pass in a valid message to be removed from the queue")}catch(PERR){g.reportError(PERR)}var index=this.queue.indexOf(msg);if(0>index)try{g.PAssert(1491,!1,"Trying to remove an invalid message from the queue")}catch(PERR){g.reportError(PERR)}else this.queue.splice(index,1)},computeFilter:function computeFilterFn(){platform.isMobile&&(this.currentFilter|=this.FilterType.Mobile),platform.isMobile||(this.currentFilter|=this.FilterType.Desktop),platform.app&&(this.currentFilter|=this.FilterType.App)},updateRemoteMessages:function updateRemoteMessagesFn(){if(!g.isDemoMode()){var lastMessageSync=g.settings.get(Settings.lastMessageSync),syncDateString="";lastMessageSync&&(syncDateString="?lastSync="+new Date(lastMessageSync).toString("yyyy-MM-ddTHH:mm:ss"));var newSyncTime=new Date;g.XHR({type:"GET",url:window.location.protocol+"//api.moo.do/debug/getMessages"+syncDateString,cb:function cbFn(xhr){if(200===xhr.status){g.settings.set(Settings.lastMessageSync,newSyncTime);var messageData=JSON.parse(xhr.responseText);if(messageData)for(var messages=messageData.m,i=0;messages&&i<messages.length;++i){var newMsg=messages[i],currentMessage=this.remoteMessages[newMsg.id];if(!currentMessage){var showMessage=!0;newMsg.filter&&(showMessage=0!==(newMsg.filter&this.currentFilter),log("Remote Message Filter: "+newMsg.filter+" "+this.currentFilter+" "+showMessage)),showMessage&&this.pushMessage({text:newMsg.data,type:newMsg.type,action:MessageAction.Default}),this.remoteMessages[newMsg.id]=newMsg}}}else log("Unable to get remote messages",xhr)}.bind(this)})}}},VMMessageQueue}),define("TemplateCache",["ko","globals"],function(ko,g){window.__TOTAL_TEMPLATES=0;var self={},cachedTemplatesDomDataKey="__cached_template__";self.templateSources=function templateSourcesFn(domElem){var templateSources={elem:domElem,__proto__:new ko.templateSources.domElement(domElem)};return templateSources.text=function(value){return 0===arguments.length?templateSources.elem.text:void(templateSources.elem.text=value)},templateSources.nodes=function(value){try{g.PAssert(1492,0===arguments.length)}catch(PERR){g.reportError(PERR)}if(0===arguments.length){var templateData=ko.utils.domData.get(templateSources.elem,cachedTemplatesDomDataKey);if(!templateData){for(var templateText=templateSources.text().replace(/(\r\n|\n|\r|\s*(?=<)|\s*$)/gm,""),parsedNodes=ko.utils.parseHtmlFragment(templateText),compiledNodes=document.createElement("div"),i=0;i<parsedNodes.length;i++)compiledNodes.appendChild(parsedNodes[i]);return ko.utils.domData.set(templateSources.elem,cachedTemplatesDomDataKey,{cachedNodes:compiledNodes}),compiledNodes}return templateData.cachedNodes}},templateSources},self.templateEngine=function templateEngineFn(){var templateEngine={__proto__:new ko.nativeTemplateEngine};return templateEngine.cachedDoc=void 0,templateEngine.makeTemplateSource=function(template,templateDocument){try{g.PAssert(1493,"string"==typeof template)}catch(PERR){g.reportError(PERR)}var incomingDoc=templateDocument||document,cachedDoc=templateEngine.cachedDoc;if(!templateEngine.cachedDoc){try{g.PAssert(1494,incomingDoc)}catch(PERR){g.reportError(PERR)}cachedDoc={doc:incomingDoc,cachedTemplates:{}},templateEngine.cachedDoc=cachedDoc}try{g.PAssert(1495,cachedDoc)}catch(PERR){g.reportError(PERR)}var elem=cachedDoc.cachedTemplates[template];if(!elem){var domElem=cachedDoc.doc.getElementById(template);try{g.PAssert(1496,domElem)}catch(PERR){g.reportError(PERR)}if(domElem)try{elem=new self.templateSources(domElem);try{g.PAssert(1497,elem)}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}else g.reportError(new Error('Unable to find element for template "'+template+'". '+domElem));cachedDoc.cachedTemplates[template]=elem,__TOTAL_TEMPLATES++}return elem},templateEngine};var engine=self.templateEngine();return engine instanceof ko.templateEngine&&ko.setTemplateEngine(engine),self}),define("VMContact",["ko","data","globals","goog","platform","tracker"],function(ko,d,g,goog,platform,tracker){function VMContact(p){this.templateName="template-contact",this.id=p.id,this.isSelected=ko.observable(!1),this.text=p.text||"",this.image=void 0,this.phoneNumbers=p.phoneNumbers||[],this.emails=p.emails||[],this.dbItem=p,this.phone=void 0,this.phoneLink=void 0,this.email=void 0,this.emailLink=void 0,this.item=void 0,this.init()}return VMContact.prototype={hasPreview:function hasPreviewFn(){return!0},init:function initFn(){for(var i=0;i<this.phoneNumbers.length;i++)this.phoneNumbers[i].link=this.formatPhone(this.phoneNumbers[i].number);for(var i=0;i<this.emails.length;i++)this.emails[i].link="mailto:"+this.emails[i].address},onLoad:function onLoadFn(element){this.element=element},formatPhone:function formatPhoneFn(phonenum){var regexObj=/^(?:\+?1[-. ]?)?(?:\(?([0-9]{3})\)?[-. ]?)?([0-9]{3})[-. ]?([0-9]{4})$/;if(regexObj.test(phonenum)){var parts=phonenum.match(regexObj),phone="";parts[1]&&(phone+="("+parts[1]+") "),phone+=parts[2]+"-"+parts[3];var phoneLink="";return parts[1]&&(phoneLink+="+1-"+parts[1]+"-"),phoneLink+=parts[2]+"-"+parts[3],platform.iphone?"tel:"+phoneLink:"callto:"+phoneLink}},onTapNumber:function onTapNumberFn(e){},onTapEmail:function onTapEmailFn(e){},onTap:{onClick:function onClickFn(e){log(e.srcElement,this.text),g.hasClass(e.srcElement,"contactPhone")||g.hasClass(e.srcElement,"contactEmail")||g.autocomplete.onTapped(this.text)}}},VMContact}),define("VMAutocompleteItem",["ko","data","globals","platform"],function(ko,d,g,platform){function VMAutocompleteItem(p){this.id=p.id,this.text=p.text||"",this.object=p.object,this.index=p.index,this.isSelected=ko.observable(!1),this.element=void 0,this.init()}return VMAutocompleteItem.prototype={init:function initFn(){},html:function htmlFn(){var searchText=g.autocomplete.text(),index=this.text.toLowerCase().indexOf(searchText.toLowerCase()),newText="";return index>=0&&(newText=this.text.substr(0,index)+"<b>"+this.text.substr(index,searchText.length)+"</b>"+this.text.substr(index+searchText.length)),newText},onLoad:function onLoadFn(element){this.element=element}},VMAutocompleteItem}),define("AutocompleteDates",["ko","data","globals","platform"],function(ko,d,g,platform){function AutocompleteDates(p){this.soft=["now","soon","later"],this.softDays=["today","tomorrow"],this.dayModifiers=["next"],this.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],this.months=["january","february","march","april","may","june","july","august","september","october","november","december"],this.dict=this.soft.concat(this.softDays).concat(this.dayModifiers).concat(this.days).concat(this.months),this.NextWordOptions={None:0,DayName:1,Days:2,Time:4},this.init()}return AutocompleteDates.prototype={init:function initFn(){},findDatesLike:function findDatesLikeFn(like){for(var lower=like.toLowerCase(),results=[],i=0;i<this.dict.length;++i)0===this.dict[i].indexOf(lower)&&results.push({index:0,object:{id:this.dict[i],text:this.dict[i]}});return results},findExact:function findExactFn(text){return this.dict.indexOf(text)>=0?this.nextWordOptions(text)==this.NextWordOptions.None:!1},nextWordOptions:function nextWordOptionsFn(text){var words=text.split(" "),lastWord=words[words.length-1];if(""==lastWord&&(lastWord=words[words.length-2]),this.soft.indexOf(lastWord)>=0)return this.NextWordOptions.None;if(this.softDays.indexOf(lastWord)>=0)return this.NextWordOptions.Time;if(this.dayModifiers.indexOf(lastWord)>=0)return this.NextWordOptions.DayName;if(this.days.indexOf(lastWord)>=0)return this.NextWordOptions.Time;if(this.months.indexOf(lastWord)>=0)return this.NextWordOptions.Days;var isInt=parseInt(lastWord,10);return isNaN(isInt)?lastWord.indexOf(":")>=0?this.NextWordOptions.Time:this.NextWordOptions.None:this.NextWordOptions.Time}},AutocompleteDates}),define("VMAutocomplete",["ko","data","globals","platform","android","VMContact","VMAutocompleteItem","AutocompleteDates","tracker"],function(ko,d,g,platform,android,VMContact,VMAutocompleteItem,AutocompleteDates,tracker){function VMAutocomplete(){this.items=ko.observableArray(),this.isVisible=ko.observable(!1),this.element=void 0,this.trackingItem=void 0,this.trackingTag=void 0,this.selectedIndex=ko.observable(-1),this.exactMatch=ko.observable(!1),this.text=ko.observable(""),this.autocompleteDates=new AutocompleteDates,this.nextDateWord=ko.observable(this.autocompleteDates.NextWordOptions.None),this.lastX=0,this.lastY=0,this.Modes={Contact:0,Date:1},this.mode=ko.observable(-1),this.init()}return VMAutocomplete.prototype={getDateText:function getDateTextFn(index){switch(index){case 1:return index+"st ";case 2:return index+"nd ";case 3:return index+"rd ";default:return index+"th "}},getMinWidth:function getMinWidthFn(){return this.mode()===this.Modes.Contact?"350px":"180px"},showAllDates:function showAllDatesFn(){return""===this.text()},showDate:function showDateFn(){return this.nextDateWord()==this.autocompleteDates.NextWordOptions.None||this.nextDateWord()==this.autocompleteDates.NextWordOptions.DayName},showDays:function showDaysFn(){return this.nextDateWord()==this.autocompleteDates.NextWordOptions.Days},showTime:function showTimeFn(){return this.nextDateWord()==this.autocompleteDates.NextWordOptions.Time},showDates:function showDatesFn(){return platform.mobile&&platform.app&&this.mode()==this.Modes.Date&&(""===this.text()||this.nextDateWord())},showList:function showListFn(){return!this.exactMatch()&&!this.showDates()},showPreview:function showPreviewFn(){return this.selectedItem()&&this.mode()==this.Modes.Contact&&(!platform.mobile||this.exactMatch)},hasContent:function hasContentFn(){return this.showDates()||this.showList()||this.showPreview()},templatePreview:function templatePreviewFn(self,b){return"template-contact"},selectedItem:function selectedItemFn(){return this.selectedIndex()<0?void 0:this.items()[this.selectedIndex()]},init:function initFn(){this.onkeydown=this.onkeydown.bind(this),this.onMouseover=this.onMouseover.bind(this),this.element=document.getElementById("autocomplete"),g.applyBindings(this,"autocomplete"),window.addEventListener("closeKeyboard",this.hide.bind(this))},setMode:function setModeFn(prefix){prefix==DatePrefix&&this.mode(this.Modes.Date),prefix==ContactPrefix&&this.mode(this.Modes.Contact)},show:function showFn(item,completionElement){if(!this.isVisible()){var sel;if(!completionElement&&(sel=document.getSelection(),sel&&sel.baseNode)){var isContact=g.findParent(sel.baseNode,"contact",2);completionElement=isContact||g.findParent(sel.baseNode,"date",2),isContact&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenContact,data:[{info:item}]})}var windowBounds=document.documentElement.getBoundingClientRect(),rect=this.element.getBoundingClientRect(),autoRect={left:rect.left,right:rect.right,top:rect.top,bottom:rect.bottom};if(0===rect.width&&0===rect.height&&(autoRect.right=350,autoRect.bottom=170),completionElement){var targetOrigin=completionElement.getBoundingClientRect();g.setOrigin(autoRect,targetOrigin.left,targetOrigin.bottom);var origin=g.adjustOriginToBeInsideBounds(windowBounds,autoRect,20,10,10,10);this.element.style.left=origin.x+"px",this.element.style.top=origin.y+"px"}else if(android.isEnabled()){var targetOrigin=item.getSpan().getBoundingClientRect();targetOrigin.left-=20,g.setOrigin(autoRect,targetOrigin.left,targetOrigin.bottom);var origin=g.adjustOriginToBeInsideBounds(windowBounds,autoRect,20,10,10,10);this.element.style.left=origin.x+"px",this.element.style.top=origin.y+"px"}else{if(!(sel.rangeCount>0))return;var targetOrigin=sel.getRangeAt(0).getClientRects()[0];targetOrigin.left-=20,g.setOrigin(autoRect,targetOrigin.left,targetOrigin.bottom);var origin=g.adjustOriginToBeInsideBounds(windowBounds,autoRect,20,10,10,10);this.element.style.left=origin.x+"px",this.element.style.top=origin.y+"px"}if(this.isVisible(!0),this.element.scrollTop=0,platform.mobile&&item){var time=150,amtMoved=g.scrollToTop(item.getSpan(),time),bounds=completionElement?completionElement.getBoundingClientRect():item.getSpan().getBoundingClientRect(),bottomOfItem=bounds.bottom-amtMoved;this.element.style.top=bottomOfItem-2+"px",this.mode()==this.Modes.Contact?g.phoneMenu.contactMode(!0):this.mode()==this.Modes.Date&&g.phoneMenu.dateMode(!0),g.keyboardToolbar.isVisible(!1);var trans=platform.windowHeight()-platform.kbsize-bottomOfItem;g.setTransform(this.element,0,trans),requestAnimationFrame(function(){g.setTransform(this.element,0,0,time,"ease-out")}.bind(this))}tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenAutocomplete})}},clear:function clearFn(){this.items.removeAll(),this.trackingTag=!1},hide:function hideFn(){if(this.isVisible()){var time=200;if(platform.mobile){var trans=platform.windowHeight()-platform.kbsize;g.setTransform(this.element,0,trans,time,"ease-out"),setTimeout(function(){this.isVisible(!1),g.phoneMenu.contactMode(!1),g.isKeyboardOpen&&g.keyboardToolbar.isVisible(!0),this.clear()}.bind(this),time)}else this.isVisible(!1);tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseAutocomplete})}},onkeydown:function onkeydownFn(e){if(0===this.items().length||!this.isVisible()||this.exactMatch()&&e.normCode!==KeyCode.Escape)return!0;if(e.normCode===KeyCode.UpArrow||e.normCode===KeyCode.DownArrow){if(this.items().length>1){this.selectedIndex()>=0&&this.items()[this.selectedIndex()].isSelected(!1);var newIndex=this.selectedIndex()+(e.normCode==KeyCode.DownArrow?1:-1);return this.selectedIndex(0>newIndex?this.items().length+newIndex:newIndex>=this.items().length?newIndex%this.items().length:newIndex),this.items()[this.selectedIndex()].isSelected(!0),!1}this.hide()}else{if(e.normCode===KeyCode.Enter){if(this.selectedIndex()>=0){var item=this.items()[this.selectedIndex()];this.onTapped(item.text,!0)}return this.hide(),!1}if(e.normCode===KeyCode.Escape)return this.hide(),!1}return!0},onTap:{onClick:function onClickFn(e){var item=ko.dataFor(e.srcElement);this.onTapped(item.text)}},onTapped:function onTappedFn(text,hide){this.text(text),this.trackingItem&&this.trackingItem.onAutocompleteTapped(text,this.trackingTag),(hide||this.mode()===this.Modes.Contact||!platform.mobile)&&this.hide()},find:function findFn(words,start,num){if(start+num>words.length-1)return!1;var text=words[start];isNaN(num)&&(num=0);for(var i=0;num>i&&words[start+i+1];i++)text+=" "+words[start+i+1];var compStr=-1!==text.indexOf(":",text.length-1)?text.substr(0,text.length-1):text,results;return this.mode()==this.Modes.Contact?results=this.findContact(compStr):this.mode()==this.Modes.Date&&(results=this.findDate(compStr)),results.length>0?this.find(words,start,num+1)||{start:start,num:num+1,text:compStr,results:results}:!1},findContact:function findContactFn(name){return d.findContactsLike(name)},findDate:function findDateFn(text){return this.autocompleteDates.findDatesLike(text)},findExact:function findExactFn(text){return this.mode()==this.Modes.Contact?this.findContactExact(text):this.mode()==this.Modes.Date?this.findDateExact(text):void 0},findContactExact:function findContactExactFn(name){return d.findContactsExact(name)},findDateExact:function findDateExactFn(text){return this.autocompleteDates.findExact(text)},objectFromResult:function objectFromResultFn(result){return this.mode()==this.Modes.Contact?new VMContact(result):this.mode()==this.Modes.Date?new VMContact(result):void 0},getMinWordLength:function getMinWordLengthFn(){return this.mode()==this.Modes.Contact?1:this.mode()==this.Modes.Date?1:void 0},getLineIndexFromWordIndex:function getLineIndexFromWordIndexFn(words,wordIndex){for(var lineIndex=0,i=0;wordIndex>i;i++)lineIndex+=words[i].length+1;return lineIndex},update:function updateFn(params){var item=params.item||this.trackingItem,text=android.isEnabled()?android.getInputText():item.getParsedText(),selectionStart=params.start,fromArrows=params.fromArrows;this.trackingItem=item,this.trackingTag=!1;var startOffset=0,i,lineIndex=0,startWord=-1,startChar=-1,words=text.split(" ");for(startOffset>0&&(words[0]=words[0].substr(startOffset)),i=0;i<words.length;i++)(words[i].startsWith(ContactPrefix)||words[i].startsWith(DatePrefix))&&selectionStart>=lineIndex&&(startWord=i,startChar=lineIndex,this.setMode(words[i][0])),lineIndex+=words[i].length+1;var minWordLength=this.getMinWordLength();if(startWord>=0){this.clear(),words[startWord]=words[startWord].substr(1);var result=this.find(words,startWord),addAmount=1;if(""===words[startWord+1]&&addAmount++,result&&startChar+addAmount+result.text.length>=selectionStart){var exactMatch=this.findExact(result.text);if(this.exactMatch(!!exactMatch),exactMatch){var options={index:-1,text:exactMatch.text};options.object=this.objectFromResult(exactMatch),item=new VMAutocompleteItem(options),this.items.push(item),this.selectedIndex(0),this.trackingTag=!0,fromArrows||platform.mobile||this.show(this.trackingItem)}else{if(result&&result.num>0){this.trackingTag={text:result.text,index:this.getLineIndexFromWordIndex(words,result.start)+1,length:result.text.length},this.text(result.text);var results=result.results,u,item,id;for(i=0;i<results.length;i++){var object=results[i].object,options={index:i,text:object.text};options.object=this.objectFromResult(object),item=new VMAutocompleteItem(options),this.items().push(item)}this.items.valueHasMutated(),this.selectedIndex(0),this.items()[0].isSelected(!0)}fromArrows||this.show(this.trackingItem)}}}this.nextDateWord(this.autocompleteDates.NextWordOptions.None),this.trackingTag||this.hide()},onMouseover:function onMouseoverFn(item){this.selectedIndex()>=0&&this.items()[this.selectedIndex()].isSelected(!1);var index=this.items.indexOf(item);index>=0&&(this.selectedIndex(index),item.isSelected(!0))},onTapDate:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var el=e.srcElement;if("SPAN"==el.nodeName){var parentDiv=el.parentNode;if(g.hasClass(parentDiv,"disabled"))return;var text=el.id?el.id+" ":el.textContent,next=this.autocompleteDates.nextWordOptions(text);this.nextDateWord(next);var hide=next==this.autocompleteDates.NextWordOptions.None;this.onTapped(text,hide),this.trackingTag.index+=text.length}}}},VMAutocomplete}),define("ScreenManager",["ko","globals","platform"],function(ko,g,platform){function ScreenManager(owner){this.snapPoints=[],this.screens=[],this.activeScreen=-1,this.screenAtSwipeStart=-1,this._isSwiping=!1,this.minOffset=0,this.maxOffset=0,this.owner=owner,this.useScroll=platform.mobileie,this.lastOffset=0,this.updateFunctions=[],this.paneWidth=.85,this.init()}return window.Screens=platform.mobile?{Settings:0,Outline:1,List:2,MAX:2}:{Outline:0,List:1,MAX:1},ScreenManager.prototype={init:function initFn(){this.activeScreen=Screens.MAX},getActiveScreen:function getActiveScreenFn(){return this.activeScreen},setOwner:function setOwnerFn(owner){this.owner=owner},isSwiping:function isSwipingFn(){return this._isSwiping},isScreenOpen:function isScreenOpenFn(index){return this.activeScreen===index},computeSnapPoints:function computeSnapPointsFn(){try{g.PAssert(1498,platform.mobile,"Should only be computing snappoints on mobile")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1499,this.owner,"Must have a valid owner to compute snap points")}catch(PERR){g.reportError(PERR)}for(var totalPercent=3*this.paneWidth,snapPercents=[0,this.paneWidth,2*this.paneWidth],scrollWidth=this.useScroll?this.owner.scrollWidth-100:parseInt(g.width(this.owner))*totalPercent,i=0;i<snapPercents.length;++i)this.snapPoints[i]=Math.round(snapPercents[i]*(scrollWidth/totalPercent));this.offsetMin=0,this.offsetMax=this.snapPoints[2],this.lastOffset=this.offsetMax},onResize:function onResizeFn(){if(platform.mobile){var index=this.activeScreen;this.computeSnapPoints();var screenOffset=this.snapPoints[index];this.updateScreenOffset(index,screenOffset,0),this.lastOffset=screenOffset}},scrollToScreen:function scrollToScreenFn(index,time){time=void 0===time?200:time;try{g.PAssert(1503,index<=Screens.MAX,"Must be a valid screen type")}catch(PERR){g.reportError(PERR)}this.activeScreen!==index&&(this.notifyScreenOfClose(this.activeScreen),this.notifyScreenOfOpen(index));var previousActiveScreen=this.activeScreen;this.activeScreen=index;var screenOffset=this.snapPoints[index];return this.notifyScreenOfScroll(previousActiveScreen,screenOffset,time),this.updateScreenOffset(index,screenOffset,time),this.lastOffset=screenOffset,screenOffset},updateScreenOffset:function updateScreenOffsetFn(index,offset,time){if(time=time||0,this.useScroll)if(time){var screenOffset=this.snapPoints[index];g.scrollTo(screenOffset,time,this.owner,!0)}else this.owner.scrollLeft=Math.round(offset);else for(var i=0;i<this.screens.length;++i){var topEle=this.screens[i].getTopElement();if(g.setTransform(topEle,-offset,0,time,"ease-out"),platform.ios){var offsetOnScreen=offset-(i-1)*platform.windowWidth()*this.paneWidth,perc=offsetOnScreen/(platform.windowWidth()*this.paneWidth);topEle.style.opacity=g.clamp(.4+.6*perc,0,1)}}g.setTransform(g.element("headers"),-offset*(1/this.paneWidth),0,time),this.lastOffset=offset},getCurrentScreenOffset:function getCurrentScreenOffsetFn(){return this.useScroll?this.owner.scrollLeft:this.lastOffset},addScreen:function addScreenFn(scr,index){try{g.PAssert(1504,index<=Screens.MAX,"Must be a valid screen type")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1505,void 0===this.screens[index],"Already have a screen at the given index")}catch(PERR){g.reportError(PERR)}this.screens[index]=scr},getScreen:function getScreenFn(index){var scr=this.screens[index];try{g.PAssert(1506,scr,"Must have a valid screen")}catch(PERR){g.reportError(PERR)}return scr},notifyScreenOfClose:function notifyScreenOfCloseFn(index){if(-1!==index){var scr=this.getScreen(index);scr.onScreenClose&&scr.onScreenClose()}},notifyScreenOfScroll:function notifyScreenOfScrollFn(index,offset,time){if(-1!==index)for(var i=0;i<this.screens.length;++i){var scr=this.getScreen(i);scr.onScreenScroll&&scr.onScreenScroll(offset,time)}g.fireCustomEvent("screenScroll")},notifyScreenOfStartOpen:function notifyScreenOfStartOpenFn(index){if(-1!==index){var scr=this.getScreen(index);scr.onScreenStartOpen&&scr.onScreenStartOpen()}},notifyScreenOfOpen:function notifyScreenOfOpenFn(index){if(-1!==index){var scr=this.getScreen(index);scr.onScreenOpen&&scr.onScreenOpen()}},startSwipe:function startSwipeFn(){this._isSwiping||(this._isSwiping=!0,0===this.activeScreen?this.notifyScreenOfStartOpen(1):this.activeScreen===Screens.MAX?this.notifyScreenOfStartOpen(Screens.MAX-1):(this.notifyScreenOfStartOpen(this.activeScreen-1),this.notifyScreenOfStartOpen(this.activeScreen+1)))},updateSwipe:function updateSwipeFn(diff){try{g.PAssert(1507,this.isSwiping(),"Must be swiping to perform an update")}catch(PERR){g.reportError(PERR)}if(platform.ios||platform.android||platform.mobileie){var offset=this.getCurrentScreenOffset(),newOffset=Math.max(Math.min(offset+diff,this.offsetMax),this.offsetMin);offset!==newOffset&&this.updateScreenOffset(this.activeScreen,newOffset)}},endSwipe:function endSwipeFn(){try{g.PAssert(1508,this.isSwiping(),"Must be swiping to end a swipe")}catch(PERR){g.reportError(PERR)}for(var currentOffset=this.getCurrentScreenOffset(this.activeScreen),snapIndex=-1,minDiff=1e5,i=0;i<this.snapPoints.length;++i){var snapDiff=Math.abs(this.snapPoints[i]-currentOffset);minDiff>snapDiff&&(snapIndex=i,minDiff=snapDiff)}this.scrollToScreen(snapIndex),platform.ios&&g.preventClick(),this._isSwiping&&(this._isSwiping=!1)},checkSwipeStart:function checkSwipeStartFn(e){var returnValue=!1;return this.screenAtSwipeStart=this.activeScreen,platform.ie&&!platform.mobile||platform.mobile&&this.activeScreen!==Screens.List&&e.eventX>this.paneWidth*platform.windowWidth()&&(e.preventDefault(),returnValue=!0),returnValue},checkSwipeMove:function checkSwipeMoveFn(e){var returnValue=!1;if(platform.ie&&!platform.mobile);else if(platform.mobile){var hasHoriz=this.activeScreen!==Screens.MAX&&Math.abs(e.diffX)>5||this.activeScreen===Screens.MAX&&e.diffX>5;(this.isSwiping()||Math.abs(e.distanceY)<5&&hasHoriz)&&(this.isSwiping()||this.startSwipe(),this.updateSwipe(-e.xThisFrame),e.preventDefault(),e.stopImmediatePropagation(),returnValue=!0)}return returnValue},checkSwipeClick:function checkSwipeClickFn(e){return this.activeScreen!==Screens.List&&e.eventX>this.paneWidth*platform.windowWidth()?(this._isSwiping=!1,this.scrollToScreen(this.activeScreen+1),!0):this._isSwiping},checkSwipeEnd:function checkSwipeEndFn(e){var returnValue=!1;return this.activeScreen==this.screenAtSwipeStart?platform.ie&&!platform.mobile||platform.mobile&&this.isSwiping()&&this.endSwipe():this.activeScreen!=this.screenAtSwipeStart&&(returnValue=!0),returnValue}},ScreenManager}),define("VMTooltip",["ko","globals","platform"],function(ko,g,platform){function VMTooltip(){this.listenerElement=void 0,this.displayElement=void 0,this.element=void 0,this.arrowElement=void 0,this.displayTimeout=void 0,this.extraTimeout=void 0,this.displayText=ko.observable(""),this.displayExtra=ko.observable(""),this.arrowClass=ko.observable("notVisible"),this.arrowX=ko.observable(0),this.overTooltip=ko.observable(!1),this.tipExtras={"#desktopMenuButton":"Access your settings and documents, view help",".addPaneNormal":"Open another editable view of your data",".addPaneTimeline":"View your agenda"},g.applyBindings(this,"tooltip"),this.init()}var displayDelay=300,extraDelay=1e3;return VMTooltip.prototype={init:function initFn(){},onLoad:function onLoadFn(){this.element=document.getElementById("tooltip"),this.tooltipArrow=document.getElementById("tooltipArrow"),this.element&&(this.element.addEventListener("mouseover",this.handleSelfOver.bind(this),!0),this.element.addEventListener("mouseout",this.handleSelfOut.bind(this),!0)),this.listenerElement=document.getElementById("outerWrapper"),this.listenerElement&&(this.listenerElement.addEventListener("mouseover",this.handleEleOver.bind(this),!0),this.listenerElement.addEventListener("mouseout",this.handleEleOut.bind(this),!0))},register:function registerFn(elem,text){this.update(elem,text)},update:function updateFn(elem,text){elem.setAttribute("tooltip",text)},tipIn:function tipInFn(e){this.displayElement!==e.srcElement&&(clearTimeout(this.displayTimeout),this.displayTimeout=setTimeout(this.displayTip.bind(this),displayDelay,{element:e.srcElement,offset:{y:5}}))},adjustBounds:function adjustBoundsFn(options){var arrowSize=40,maxTooltipWidth=200,horizAdjust=0,boundsSet=!1,time=0,windowBounds=document.documentElement.getBoundingClientRect(),targetBounds=this.displayElement.getBoundingClientRect(),boundsDiff=windowBounds.right-targetBounds.right,width=g.width(this.element),x=targetBounds.left+targetBounds.width/2-width/2;y=options&&options.above?targetBounds.top-g.height(this.element):targetBounds.bottom;var offset=options&&options.offset;offset?(offset.x?x+=offset.x:offset.right?x=windowBounds.right-width-offset.right:offset.left&&(x=offset.left),offset.y&&(y+=offset.y)):options&&options.above?y-=5:y+=5;var newX=x;x+width>windowBounds.right?newX=windowBounds.right-width-5:0>x&&(newX=5);var arrow=options&&options.arrow;if(arrow){var arrowX=(width-arrowSize)/2;newX!=x&&(arrowX+=x-newX),this.arrowClass(arrow),this.arrowX(arrowX+"px")}else this.arrowClass("notVisible");options&&options.time&&(time=options.time),g.setTransform(this.element,newX,y,time)},displayTip:function displayTipFn(options){try{g.PAssert(1509,options,"When display a tooltip, must pass in some info")}catch(PERR){g.reportError(PERR)}if(options){this.displayTimeout=void 0;var element=this.displayElement=options.element,text;options.text?text=options.text:element&&(text=element.getAttribute("tooltip"));try{g.PAssert(1510,text,"When display a tooltip, elements should always have valid data set")}catch(PERR){g.reportError(PERR)}text&&(this.displayText(text),this.element.style["max-width"]=options.maxWidth?options.maxWidth+"px":"",this.adjustBounds(options),platform.mobile||(this.extraTimeout=setTimeout(this.showExtra.bind(this),extraDelay)))}},tipOut:function tipOutFn(e){e.srcElement||(e.srcElement=e.target);var isAncestor=!1,newTarget=e.toElement||e.relatedTarget;newTarget&&(isAncestor=g.isAncestor(newTarget,e.srcElement)),isAncestor||e.srcElement===newTarget||newTarget===this.element||this.hideTip()},handleEleOver:function handleEleOverFn(e){e.srcElement||(e.srcElement=e.target);var infoText=e.srcElement.getAttribute("tooltip");infoText&&this.tipIn(e)},handleEleOut:function handleEleOutFn(e){e.srcElement||(e.srcElement=e.target);var infoText=e.srcElement.getAttribute("tooltip");infoText&&this.tipOut(e)},handleSelfOver:function handleSelfOverFn(e){this.displayElement&&(this.overTooltip(!0),this.showExtra())
},handleSelfOut:function handleSelfOutFn(e){e.srcElement||(e.srcElement=e.target);var isAncestor=!1,newTarget=e.toElement||e.relatedTarget;newTarget&&(isAncestor=g.isAncestor(newTarget,e.srcElement)),isAncestor||e.srcElement===newTarget||(this.overTooltip(!1),newTarget!==this.displayElement&&this.hideTip())},showExtra:function showExtraFn(){var extraString=void 0;try{g.PAssert(1511,this.displayElement,"There should be a display element when showing extra information")}catch(PERR){g.reportError(PERR)}if(this.displayElement){if(this.displayElement.id){var idString="#"+this.displayElement.id;this.tipExtras[idString]&&(extraString=idString)}if(!extraString)for(var i=0;i<this.displayElement.classList.length;++i){var classString="."+this.displayElement.classList[i];if(this.tipExtras[classString]){extraString=classString;break}}if(extraString){var extraInfo=this.tipExtras[extraString];extraInfo&&(this.displayExtra(extraInfo),this.adjustBounds())}clearTimeout(this.extraTimeout),this.extraTimeout=void 0}},hideTip:function hideTipFn(){this.displayElement=void 0,clearTimeout(this.displayTimeout),this.displayTimeout=void 0,clearTimeout(this.extraTimeout),this.extraTimeout=void 0,this.displayText(""),this.displayExtra("")}},VMTooltip}),define("AppCache",["ko","globals","platform"],function(ko,g,platform){function AppCache(){this.minTimeShowUpdate=2e3,this.timeToCancelButton=2e3,this.notifiedOfNew=!1,this.isFinished=!1,this.timeShownUpdatingMessage=void 0,this.showCancel=ko.observable(!1),this.downloadingTimeout=0,this.startStatus=window.applicationCache.status,this.continuedUpdate=!1,this.updateActionDone=!1,this.fnToRun=[],this.dynamicUpdateCheck=!1,this.requiredUpdate=!1,this.appUpdatePending=!1,this.isShowingProgress=!1,this.init()}return AppCache.prototype={init:function initFn(){log("Cache Status: "+this.startStatus),window.applicationCache.addEventListener("noupdate",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("cached",this.onFirstUpdateReady.bind(this)),window.applicationCache.addEventListener("downloading",this.onUpdateDownloading.bind(this)),window.applicationCache.addEventListener("updateready",this.onUpdateReady.bind(this)),window.applicationCache.addEventListener("obsolete",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("error",this.onUpdateError.bind(this)),window.applicationCache.status>=window.applicationCache.UPDATEREADY||document.documentElement.attributes.getNamedItem("manifest")||this.onCacheLoadFinished()},isVisible:function isVisibleFn(value){value&&(g.isDemoMode()?g.reload():g.messageQueue.pushMessage(MessageID.Updated))},update:function updateFn(){window.applicationCache.status===window.applicationCache.IDLE&&applicationCache.update()},checkForUpdate:function checkForUpdateFn(forceUpdate){this.requiredUpdate=!!forceUpdate,this.appUpdatePending||(this.dynamicUpdateCheck=!0,this.update())},runOnFinish:function runOnFinishFn(cb,isTerminal){try{g.PAssert(1512,0===this.fnToRun.length,"Only a single callback is allowed to be run at this point.")}catch(PERR){g.reportError(PERR)}this.isFinished?setTimeout(cb,0):this.fnToRun.push(cb)},onUpdateReady:function onUpdateReadyFn(){log("Cache: New version available"),this.appUpdatePending=!0,this.startStatus===window.applicationCache.UNCACHED&&log("Cache Update from UNCACHED state. ERROR."),this.onCacheLoadFinished(),this.updateAction()},onFirstUpdateReady:function onFirstUpdateReadyFn(){log("Cache: first update")},onUpdateError:function onUpdateErrorFn(ev){function pushMessage(){g.messageQueue&&g.messageQueue.pushMessage({text:"Error updating app, "+platform.actionVerb()+" to retry.",type:MessageType.Error,action:MessageAction.Reload})}platform.demo||g.vmMain&&!g.vmMain.isOnline()||(log("Update Error: ",ev),g.reportError(new Error("Error during app update"),ev),g.messageQueue?pushMessage():setTimeout(pushMessage,5e3)),this.isVisible(!1),this.onCacheLoadFinished()},onUpdateDownloading:function onUpdateDownloadingFn(){log("Cache: New version downloading")},onCacheLoadFinished:function onCacheLoadFinishedFn(){if(log("Cache: No update"),!this.isFinished){this.isFinished=!0;for(var i=0;i<this.fnToRun.length;++i)this.fnToRun[i]()}},notifyOfUpdate:function notifyOfUpdateFn(){this.notifiedOfNew||(this.notifiedOfNew=!0,g.setAppCacheUpdateState(!0),this.startStatus!==window.applicationCache.UNCACHED&&(g.StopSpinner(),this.isVisible(!0)))},updateAction:function updateActionFn(){this.requiredUpdate?g.messageQueue.pushMessage(MessageID.RequiredUpdate):this.isVisible(!0),g.sendEvent("AppCache","Update")}},AppCache}),"undefined"==typeof REPORT_ACTIONS&&(REPORT_ACTIONS=!1),Error.stackTraceLimit=150;try{window.__checkpoints|=1,window.__SESSION_ID=Math.round(1e4*Math.random())+"|"+Date.now(),window.appEvents=window.appEvents||{kbsize:function kbsizeFn(){},enterBackground:function enterBackgroundFn(){},enterForeground:function enterForegroundFn(){},statusBarTap:function statusBarTapFn(){},undo:function undoFn(){},redo:function redoFn(){},reportLowMemory:function reportLowMemoryFn(){}},window.log=console.log.bind(console),window.performance&&window.performance.now?(window.performance.start=window.performance.now(),window.log.now=function(){return window.performance.now()-window.performance.start}):(window.performance={now:function(){return Date.now()-window.performance.start}},window.performance.start=Date.now(),window.log.now=performance.now),console.timeStamp||(console.timeStamp=function(){}),console.time||(console.time=function(){}),console.timeEnd||(console.timeEnd=function(){}),console.trace||(console.trace=function(){}),window.LogLevels={Off:0,Error:1,Warning:2,Timing:4,Data:8,Status:16,Search:32,Timeline:64,Input:128,Tracker:256,Profile:512,PageLoad:1024,Toolbar:2048,Picker:4096,Intro:8192,Import:16384,Version:32768,Settings:65536,Selection:131072,ScrMgr:262144,Verbose:524288},window.LogLevel=LogLevels.Error|LogLevels.Warning,window.ShouldLog=function(mask){return window.DEBUG===mask},window.logIf=function(){var args=Array.prototype.slice.call(arguments);ShouldLog&&(args.splice(0,1),window.log.apply(this,args))};for(var i in LogLevels)makeLogger(i);window.inspectLocal=function(input){if(!input)return void log("Must specify either an item ID or item object to inspect");var item=input;return"string"==typeof input&&(item=window.getModel(input)),log("---- Inspecting Item:",item.id,"----"),log("  RawText:",item.getRawText()),log("  ParsedText:",item.getParsedText()),log("  StyledText:",item.getStyledText()),log('  Parent: "'+item.parent().id+'"'),log("  Date:",item.date()),log("  AllDayDate:",item.allDayDate),log("--------------------------------------------"),item}}catch(err){log("Error in main header"),window.__ERRORINMAINHEADER=err}!function(){var rqConfig,rqConfig,rqConfig={paths:{ko:"lib/knockout-2.3.0.custom",date:"lib/date",FileSaver:"lib/FileSaver",IndexedDBShim:"lib/IndexedDBShim.min",db:"lib/db"},waitSeconds:0};require.config(rqConfig)}(),window.gapiKey="AIzaSyB9HEdSJ-nhLJG_ssSSqhI2DX74GSiKSao",window.location.hash.indexOf("gtest=true")>=0&&(log("Loading DEBUG version of RealtimeAPI"),window.___gcfg={"drive-realtime":{server:"https://drive.sandbox.google.com/otservice"}});var gapiCalled=!1,gapiLoadError=!1;requirejs(["ko","kos","data","globals","util","gdata","goog","platform","android","edit","VMMain","VMSetup","VMDebug","VMTimeline","VMSearch","VMMessageQueue","TemplateCache","VMAutocomplete","VMMenus","ScreenManager","VMTooltip","AppCache","DuchessHelpers"],function(ko,kos,d,g,util,gdata,goog,platform,android,edit,VMMain,VMSetup,VMDebug,VMTimeline,VMSearch,VMMessageQueue,TemplateCache,VMAutocomplete,VMMenus,ScreenManager,VMTooltip,AppCache){g.checkpoint(Checkpoint.RequireLoaded),window.__ERRORINMAINHEADER&&g.reportError(window.__ERRORINMAINHEADER);var options;g.runOnLoad(function(){function setupEvent(name){document.documentElement.addEventListener(name,function(e){g.reportEvent(e)},!0),document.documentElement.addEventListener(name,function(e){},!1)}function submitFn(){return g.requestNotification(navigator.userAgent)}function refreshFn(){g.AppCache.runOnFinish(function(){g.reload()},!0)}function onorientationchange(){platform.updateOrientation(),platform.mobile&&(g.keyboardToolbar&&g.keyboardToolbar.isVisible()&&g.keyboardToolbar.updatePosition(!0),document.body.scrollTop=0),platform.mobile&&g.keyboardToolbar&&g.keyboardToolbar.hideTopBarIfLandscape()}function initialize(){initializeCalled||(initializeCalled=!0,g.checkpoint(Checkpoint.InitializeMain),g.openMainPage(),g.registerEvent("ItemCreated","ItemAction","Create"),g.registerEvent("ItemCompleted","ItemAction","Complete"),d.initData(onInitializedData),onInitializedData())}function onInitializedData(){try{if(initializeDataCalled||!initializeCalled||!d.localDataLoaded())return;initializeDataCalled=!0,g.checkpoint(Checkpoint.OnInitializedData),goog.loadClientDefaultFile(),g.isDemoMode()?g.isDisplayModeActive(DisplayMode.NoDemoSidebar)||platform.script||(g.vmMain.openSidebar(),setTimeout(function(){g.highlightElement(document.getElementById("logoutButton"),.6,1)},0)):g.vmMain.setupDateRollover(),g.vmMain.loadData(),g.timeline.load(),g.StopSpinner(),setTimeout(function(){g.menus&&g.menus.bind(),g.autocomplete||(g.autocomplete=new VMAutocomplete)})}catch(err){g.reportError(err)}}function ignoreKeyOnBody(e){return(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.normCode==KeyCode.A}try{g.checkpoint(Checkpoint.PageLoad);try{g.PAssert(1514,"loading"!==document.readyState,"Should only be calling mainjs after document is loaded"+document.readyState)}catch(PERR){g.reportError(PERR)}if("loading"===document.readyState){var errString="ERROR: MainJS running before document load! "+document.readyState;ShouldLog(LogLevels.Error)&&log(errString),g.reportError(new Error(errString))}for(var scriptError in window.scriptErrors)g.fireCustomEvent("scriptLoadError",{src:scriptError,id:window.scriptErrors[scriptError],firstChance:!0});if(window.handleLoadError=function handleLoadErrorSecondChanceFn(e){try{window.scriptErrors[e.target.src]=e.target.id,g.fireCustomEvent("scriptLoadError",{src:e.target.src,id:e.target.id,firstChance:!1})}catch(err){g.reportError(err)}},window.oncontextmenu=function(e){e.preventDefault()},platform.demo&&(g.messageQueue||(g.messageQueue=new VMMessageQueue),g.enableDemoMode()),g.isDemoMode()){var panesStart=util.getURLParam("panes");panesStart&&(g.demoPanes=panesStart.split(":"))}else g.removeDOM("preventInteraction");setTimeout(function(){g.sendEvent("PageLoad","NewPage")},0),setupEvent("keydown"),setupEvent("keyup"),setupEvent("keypress"),setupEvent("MSPointerDown"),setupEvent("MSPointerUp"),setupEvent("MSPointerHover"),setupEvent("MSPointerCancel"),setupEvent("mousedown"),setupEvent("mouseup"),setupEvent("touchstart"),setupEvent("touchend"),g.messageQueue||(g.messageQueue=new VMMessageQueue),g.tooltip=new VMTooltip,g.AppCache=new AppCache,g.StartSpinner();var erroredPlatform=platform.blockClient();if(void 0!==erroredPlatform){var text,showSignup=!1;return erroredPlatform.platform?erroredPlatform.update?"Firefox"==erroredPlatform.platform?text='Please update your Firefox browser to use Moo.do. Moo.do requires at least Firefox 16. See <a href="https://support.mozilla.org/en-US/kb/update-firefox-latest-version">https://support.mozilla.org/en-US/kb/update-firefox-latest-version</a> for more information.':"Chrome"==erroredPlatform.platform?text='Please update your Chrome browser to use Moo.do. Moo.do requires at least Chrome 26. See <a href="https://support.google.com/chrome/answer/95414">https://support.google.com/chrome/answer/95414</a> for more information.':"Native Android"==erroredPlatform.platform?text="Please update your Android device to use Moo.do. Moo.do requires at least Android 2.1.":"Internet Explorer"==erroredPlatform.platform?text='Please update your Internet Explorer browser to use Moo.do. Moo.do requires at least Internet Explorer 10. See <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">http://windows.microsoft.com/en-us/internet-explorer/download-ie</a> for more information.':"Safari"==erroredPlatform.platform?text=platform.mobile?"Please update your "+platform.OSName+" to use Moo.do. Moo.do requires at least iOS 6.":'Please update your Safari browser to use Moo.do. Moo.do requires at least Safari 6.1. See <a href="http://support.apple.com/kb/HT6103">http://support.apple.com/kb/HT6103</a> for more information.':(text="Please update your browser to use Moo.do. If you are unable to update your browser, please let us know. Thanks!",showSignup=!0):(showSignup=!0,text="Sorry, we don't support "+erroredPlatform.platform+" yet. Please let us know that you're interested in using "+erroredPlatform.platform+" and we will make it a higher priority. Thanks!"):erroredPlatform.version?text="Please update to the latest version of this app by opening the TestFlight app and installing the latest version. Thanks!":erroredPlatform.cacheUpdate&&(text="There was an issue while updating the app, "+platform.actionVerb()+" to try again.",g.AppCache.update(),erroredPlatform.error&&g.AppCache.runOnFinish(function(){util.insertURLParam("cacheError",!0)},!0)),text&&g.applyBindings({platformError:text,showSignup:showSignup,onTapRefresh:refreshFn,onTapSubmit:submitFn},"OSError"),g.StopSpinner(),g.removeDOM("outerWrapper"),g.removeDOM("setupWrapper"),void g.removeDOM("templates")}util.removeURLParam("cacheError",!0),g.removeDOM("OSError"),g.localDocChangeRequested=!1,g.settings.initEvents(function(e){if("localSettings"===e.key){var oldValue;e.oldValue&&(oldValue=JSON.parse(e.oldValue));var newValue;e.newValue&&(newValue=JSON.parse(e.newValue)),oldValue&&newValue&&!g.localDocChangeRequested&&oldValue.gdocId&&oldValue.gdocId!==newValue.gdocId&&(g.messageQueue.pushMessage(MessageID.DocChange),setTimeout(function(){g.reload()},1e4))}}),g.ScreenManager=new ScreenManager(document.getElementById("main")),g.menus=new VMMenus,g.vmDebug=new VMDebug,window.addEventListener("remoteDataLoaded",function(){var fileForceID=util.getURLParam("file"),stateInfo=util.getURLParam("state");if(fileForceID||stateInfo){if(!fileForceID)try{var stateObj=JSON.parse(stateInfo);"open"===stateObj.action&&stateObj.ids&&stateObj.ids.length>=0&&(fileForceID=stateObj.ids[0])}catch(err){g.reportError(err)}var currentDocID=goog.getDocId();fileForceID&&currentDocID!==fileForceID&&g.messageQueue.pushMessage({text:"You have requested to view another document, "+platform.actionVerb()+" here to open it.",type:MessageType.Info,action:function actionFn(){try{g.PAssert(1516,g.vmMain&&g.vmMain.vmPicker,"VMMain must be initialized before loading another doc")}catch(PERR){g.reportError(PERR)}g.vmMain.vmPicker.requestOpenDocument(fileForceID)}})}});var windowResize=function(e){var w=window.innerWidth,h=window.innerHeight,oldWidth=platform.windowWidth(),oldHeight=platform.windowHeight();if(platform.ipad&&!platform.app&&e!==!0&&e!==!1&&setTimeout(windowResize,0,!0),(w!=oldWidth||h!=oldHeight&&h!=oldHeight+60)&&(g.smallMode=480>=w,platform.windowWidth(w),platform.windowHeight(h),g.documentHeight=h,g.isMainPageOpen)){if((platform.android||platform.mobileie)&&h>oldHeight&&g.vmMain&&g.vmMain.isLoaded&&g.blurActiveElement(),platform.iphone&&!platform.bodyscroll&&!platform.standalone&&!platform.app&&!platform.ios7){var height=document.documentElement.clientHeight+60;document.documentElement.style.height=height+"px",setTimeout(g.enforceScroll,0)}g.autocomplete&&g.autocomplete.hide(),oldWidth!==w&&e&&platform.mobile&&(g.ScreenManager&&g.ScreenManager.onResize(),g.menus&&g.menus.onResize()),platform.mobile||g.fireCustomEvent("windowResize")}};if(windowResize(!1),onorientationchange(),g.isDemoMode()||(!platform.offline&&window.gapi&&window.gapi.auth&&!gapiCalled&&GoogleApiLoaded(),!platform.ios||platform.app||platform.standalone||g.settings.get(Settings.shownInstallInfo)||(g.messageQueue.pushMessage({text:'To add this app to the home screen: tap <span class="ath-action-icon">icon</span> then <strong>Add to Home Screen</strong>.',type:MessageType.InfoGray,bottom:!0}),g.settings.set(Settings.shownInstallInfo,!0))),platform.mobile?(g.removeDOM("desktopMenu"),g.removeDOM("desktopSidebar"),g.removeDOM("contextMenuItem"),g.removeDOM("contextMenuLink"),g.removeDOM("exportData")):(g.removeDOM("phoneMenu"),g.removeDOM("mobileKeyboardToolbar"),g.removeDOM("paneSettings"),platform.touch||(g.removeDOM("itemMenuPhone"),g.removeDOM("rightMenuPhone"))),window.onblur=function(){g.hasFocus=!1},window.onfocus=function(){g.hasFocus=!0,goog.onFocusHandler()},new VMMain,g.timeline=new VMTimeline,window.addEventListener("resize",windowResize),window.addEventListener("orientationchange",windowResize),window.addEventListener("orientationchange",onorientationchange),platform.mobileie){document.addEventListener("focusout",function(e){}),document.addEventListener("focusin",function(e){"HTML"===e.target.tagName&&(android.isEnabled()?android.isVisible()?android.finishInput(!1):g.vmSearchPhone&&g.vmSearchPhone.isFocused()&&g.vmSearchPhone.onblur():log("Skipping Close - Not Android"))});var lastScroll=0,preventScrollInterval;window.addEventListener("scroll",function(e){lastScroll=Date.now(),preventScrollInterval||(preventScrollInterval=setInterval(function(){Date.now()-lastScroll>5e3&&(clearInterval(preventScrollInterval),preventScrollInterval=void 0),window.scrollTo(0,0)},15))})}window.addEventListener("dragstart",function(dragEvent){return dragEvent.preventDefault(),!1}),window.addEventListener("drop",function(dragEvent){return dragEvent.preventDefault(),!1});var initializeCalled=!1,initializeDataCalled=!1;g.vmSetup=new VMSetup,g.vmSetup.loginState.subscribe(function(loginState){loginState==LoginState.LOGGED_IN?(initialize(),g.openMainPage()):loginState==LoginState.LOGGED_OUT&&(g.isSetupPageOpen||(g.isSetupPageOpen=!0,util.hasURLParam("login","true")||g.openSetupPage(),g.vmSetup.openLogin())),g.vmMain.setGDriveStatus(platform.offline||!navigator.onLine?DriveStatus.Offline:DriveStatus.Connecting)}),g.vmSetup.init(),g.isDemoMode()&&initialize();var loginState=g.getLoginState();if(loginState!=LoginState.LOGGED_OUT&&d.initData(initialize),!platform.mobile){var hotkeys={},hotkeySearch=function(){g.focusedPane.vmSearch.isFocused()||g.saveSelection("StoredSearch"),g.selectElement(g.focusedPane.vmSearch.elSearch,!1),g.sendEvent("Hotkey","Search")},hotkeyOutline=function(){g.focusedPane.toggleOutlineVisibility(),g.sendEvent("Hotkey","Outline")},hotkeyGoto=function(){var item=g.getSelectedItem();if(item){for(var i=0;i<item.elements.length;++i)g.scrollIntoView(item.getSpan(i),200);item.highlight()}g.sendEvent("Hotkey","GoTo")},hotkeyP0=function(){g.vmMain.applyPriorityToSelection(VMLIFlag.P0,!0),g.sendEvent("Hotkey","Important")},hotkeyP1=function(){g.vmMain.applyPriorityToSelection(VMLIFlag.P1,!0),g.sendEvent("Hotkey","Important")},hotkeyP2=function(){g.vmMain.applyPriorityToSelection(VMLIFlag.P2,!0),g.sendEvent("Hotkey","Important")},hotkeyStar=function(){g.vmMain.applyFnToSelection("isFlagged",!0),g.sendEvent("Hotkey","Star")},hotkeyComplete=function(){g.vmMain.applyFnToSelection("isComplete",!0),g.sendEvent("Hotkey","Complete")},hotkeyZoomIn=function(){g.vmMain.applyToSelection(function(item){return g.vmMain.zoomin(item),!1}),g.sendEvent("Hotkey","ZoomIn")},hotkeyZoomOut=function(){if(g.focusedItem&&g.focusedItem.parent()){var item=g.focusedItem;g.vmMain.zoomout(item.parent(),item)}g.sendEvent("Hotkey","ZoomOut")},hotkeyCollapse=function(){g.vmMain.applyToSelection(function(item){item.toggleCollapsed()}),g.sendEvent("Hotkey","Collapse")},hotkeyIndent=function(e){e.target!=document.body&&(g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1}),g.sendEvent("Hotkey","Indent"))},hotkeyUnindent=function(e){e.target!=document.body&&(g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0}),g.sendEvent("Hotkey","Unindent"))},hotkeyNOP=function(e){},hotkeyBackspace=function(e){return e.target!=document.body?!1:void 0},hotkeyFireEvent=function(e){var name=g.enumToString(KeyCode,e.normCode);return name?g.fireCustomEvent("key"+name):void g.sendEvent("Hotkey","FireEvent_"+name)},hotkeyClosePane=function(e){g.vmMain.removeFocusPane()};hotkeys[KeyCode.E]=hotkeys[KeyCode.F]=[{mods:{0:!0},call:hotkeySearch},{mods:{2:!0},call:hotkeySearch}],hotkeys[KeyCode.G]=[{mods:{0:!0},call:hotkeyGoto},{mods:{2:!0},call:hotkeyGoto}],hotkeys[KeyCode.O]=[{mods:{0:!0},call:hotkeyOutline},{mods:{2:!0},call:hotkeyOutline}],hotkeys[KeyCode.Slash]=[{mods:{0:!0},call:hotkeyComplete},{mods:{2:!0},call:hotkeyComplete}],hotkeys[KeyCode.D1]=[{mods:{0:!0},call:hotkeyP0},{mods:{2:!0},call:hotkeyP0}],hotkeys[KeyCode.D2]=[{mods:{0:!0},call:hotkeyP1},{mods:{2:!0},call:hotkeyP1}],hotkeys[KeyCode.D3]=[{mods:{0:!0},call:hotkeyP2},{mods:{2:!0},call:hotkeyP2}],hotkeys[KeyCode.Apos]=[{mods:{0:!0},call:hotkeyStar},{mods:{2:!0},call:hotkeyStar}],hotkeys[KeyCode.S]=[{mods:{0:!0},call:hotkeyNOP},{mods:{2:!0},call:hotkeyNOP}],hotkeys[KeyCode.Enter]=[{mods:{0:!0,4:!0},call:hotkeyZoomOut},{mods:{2:!0,4:!0},call:hotkeyZoomOut},{mods:{0:!0},call:hotkeyZoomIn},{mods:{2:!0},call:hotkeyZoomIn}],hotkeys[KeyCode.Comma]=[{mods:{0:!0},call:hotkeyCollapse},{mods:{2:!0},call:hotkeyCollapse}],hotkeys[KeyCode.Period]=[{mods:{0:!0},call:hotkeyCollapse},{mods:{2:!0},call:hotkeyCollapse}],hotkeys[KeyCode.LBracket]=[{mods:{0:!0},call:hotkeyUnindent},{mods:{2:!0},call:hotkeyUnindent}],hotkeys[KeyCode.RBracket]=[{mods:{0:!0},call:hotkeyIndent},{mods:{2:!0},call:hotkeyIndent}],hotkeys[KeyCode.Escape]=[{call:hotkeyFireEvent}],hotkeys[KeyCode.F4]=[{mods:{4:!0},call:hotkeyClosePane}],hotkeys[KeyCode.BackSpace]=[{call:hotkeyBackspace}],g.globalKeyDown=function(e){var result=hotkeys[e.normCode];if(result)if(g.isFunction(result))result(e);else{for(var valid,i=0;i<result.length;i++)if(!(result[i].mods&&(result[i].mods[0]&&!e.ctrlKey||result[i].mods[1]&&!e.optKey||result[i].mods[2]&&!e.metaKey||result[i].mods[3]&&!e.altKey||result[i].mods[4]&&!e.shiftKey))){valid=result[i];break}if(valid){var ret=valid.call(e);if(ret!==!1)return e.handled=!0,e.preventDefault(),!1}}else e.normCode===KeyCode.Ctrl&&g.vmMain.updateCursor(!0);if(platform.android&&e.srcElement===document.body){if(ignoreKeyOnBody(e))return e.preventDefault(),!1;edit.keydown(null,e)}},g.globalKeyUp=function(e){platform.normalizeKeys(e),e.normCode===KeyCode.Ctrl&&g.vmMain.updateCursor(!1)},document.addEventListener("keydown",g.globalKeyDown),document.addEventListener("keyup",g.globalKeyUp,!0)}var testFn,liveReloadAddress}catch(mainErr){g.reportError(mainErr),g.handleCriticalError()}})}),define("main",function(){});
//# sourceMappingURL=main-min.js.map