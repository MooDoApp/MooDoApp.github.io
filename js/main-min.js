function GoogleApiLoaded(){if(!gapiCalled){if(gapiCalled=!0,gapi.auth.init(),window.location.hash.indexOf("offline=true")>=0||window.location.hash.indexOf("offline%22:true")>=0||window.location.hash.indexOf('offline":true')>=0||window.location.hash.indexOf("demo=true")>=0)return void log("%cOffline","color: pink");gapi.client.setApiKey(window.gapiKey),gapi.client.load("drive","v2",function(){require(["globals"],function(g){g.vmMain&&g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.DriveAPI)})}),require(["globals"],function(g){g.vmMain&&g.vmMain.pluginManager&&g.vmMain.pluginManager.isAuthorized(PluginID.Gmail)&&gapi.client.load("gmail","v1",function(){g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GmailAPI)})}),gapi.load("drive-realtime",function(){gapi&&gapi.drive&&gapi.drive.realtime?require(["globals","goog"],function(g,goog){goog.loadClientDefaultFile(),g.removeDOM("blockedError")}):require(["globals","platform"],function(g,platform){var errorString;errorString=gapi?gapi.drive?gapi.drive.realtime?"all exist":"gapi.drive.realtime":"gapi.drive":"gapi",gapiCalled=!1,gapiLoadError=!0,g.reportError(new Error("Drive returned load, but unable to load "+errorString));var msgEle=document.getElementById("blockedMessage");msgEle.innerText=platform.app?"There was an error loading the Google APIs, "+platform.actionVerb()+" to try again.":"You may be running an extension that blocked drive.google.com from loading, Moo.do requires access to function correctly. Please re-load the page if you are not using an extension and the issue will resolve itself.";var errEle=document.getElementById("blockedError");g.removeClass(errEle,"none"),errEle.addEventListener("mousedown",function(){g.reload()}),g.vmMain&&g.vmMain.gdriveStatus(DriveStatus.Offline)}),require(["globals"],function(g){g.fireCustomEvent("gapiDriveLoaded")})}),require(["globals","util","platform","goog","VMSetup","data"],function(g,util,platform,goog,VMSetup,d){g.fireCustomEvent("gapiLoaded");var setTokenFromHash=!1;(!platform.ie||platform.mobile)&&(setTokenFromHash=goog.checkTokenInHash());var hasLoginParam=util.hasURLParam("login","true"),hasUserParam=util.hasURLParam("user"),doLogin=setTokenFromHash||hasLoginParam||hasUserParam||g.getLoginState()==LoginState.LOGGED_IN,skipLogin=!1;if(hasUserParam){var forceUser=util.getURLParam("user"),activeUser=g.settings.get(Settings.activeUser);util.removeURLParam("user",!0),forceUser!==activeUser&&(g.settings.set(Settings.activeUser,forceUser),void 0!==activeUser&&(d.clearData(function(){g.reload()},[Settings.activeUser]),skipLogin=!0))}skipLogin||goog.runAuthenticate(goog.requestScopes,!0,!1,function(token){hasLoginParam&&util.removeURLParam("login",!0),token&&!token.error?(doLogin&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),goog.loadClientDefaultFile(),g.openMainPage()),goog.ensureRequiredScopesAreRequested()):goog.requiredScopes!==goog.requestScopes?(g.settings.reset(Settings.authScopes),goog.runAuthenticate(goog.requiredScopes,!0,!1,function(token2){token2&&!token2.error?doLogin&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),goog.loadClientDefaultFile(),g.runOnLoad(function(){g.openMainPage()})):(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_OUT):g.setLoginState(LoginState.LOGGED_OUT),g.runOnLoad(function(){g.openSetupPage()}))})):(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_OUT):g.setLoginState(LoginState.LOGGED_OUT),g.runOnLoad(function(){g.openSetupPage()}))})})}}var requirejs,require,define;!function(undef){function hasProp(obj,prop){return hasOwn.call(obj,prop)}function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,lastIndex,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&"."===name.charAt(0))if(baseName){for(baseParts=baseParts.slice(0,baseParts.length-1),name=name.split("/"),lastIndex=name.length-1,config.nodeIdCompat&&jsSuffixRegExp.test(name[lastIndex])&&(name[lastIndex]=name[lastIndex].replace(jsSuffixRegExp,"")),name=baseParts.concat(name),i=0;i<name.length;i+=1)if(part=name[i],"."===part)name.splice(i,1),i-=1;else if(".."===part){if(1===i&&(".."===name[2]||".."===name[0]))break;i>0&&(name.splice(i-1,2),i-=2)}name=name.join("/")}else 0===name.indexOf("./")&&(name=name.substring(2));if((baseParts||starMap)&&map){for(nameParts=name.split("/"),i=nameParts.length;i>0;i-=1){if(nameSegment=nameParts.slice(0,i).join("/"),baseParts)for(j=baseParts.length;j>0;j-=1)if(mapValue=map[baseParts.slice(0,j).join("/")],mapValue&&(mapValue=mapValue[nameSegment])){foundMap=mapValue,foundI=i;break}if(foundMap)break;!foundStarMap&&starMap&&starMap[nameSegment]&&(foundStarMap=starMap[nameSegment],starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return name}function makeRequire(relName,forceSync){return function(){var args=aps.call(arguments,0);return"string"!=typeof args[0]&&1===args.length&&args.push(null),req.apply(undef,args.concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(hasProp(waiting,name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!hasProp(defined,name)&&!hasProp(defining,name))throw new Error("No "+name);return defined[name]}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;return index>-1&&(prefix=name.substring(0,index),name=name.substring(index+1,name.length)),[prefix,name]}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var main,req,makeMap,handlers,defined={},waiting={},config={},defining={},hasOwn=Object.prototype.hasOwnProperty,aps=[].slice,jsSuffixRegExp=/\.js$/;makeMap=function(name,relName){var plugin,parts=splitPrefix(name),prefix=parts[0];return name=parts[1],prefix&&(prefix=normalize(prefix,relName),plugin=callDep(prefix)),prefix?name=plugin&&plugin.normalize?plugin.normalize(name,makeNormalize(relName)):normalize(name,relName):(name=normalize(name,relName),parts=splitPrefix(name),prefix=parts[0],name=parts[1],prefix&&(plugin=callDep(prefix))),{f:prefix?prefix+"!"+name:name,n:name,pr:prefix,p:plugin}},handlers={require:function(name){return makeRequire(name)},exports:function(name){var e=defined[name];return"undefined"!=typeof e?e:defined[name]={}},module:function(name){return{id:name,uri:"",exports:defined[name],config:makeConfig(name)}}},main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,args=[],callbackType=typeof callback,usingExports;if(relName=relName||name,"undefined"===callbackType||"function"===callbackType){for(deps=!deps.length&&callback.length?["require","exports","module"]:deps,i=0;i<deps.length;i+=1)if(map=makeMap(deps[i],relName),depName=map.f,"require"===depName)args[i]=handlers.require(name);else if("exports"===depName)args[i]=handlers.exports(name),usingExports=!0;else if("module"===depName)cjsModule=args[i]=handlers.module(name);else if(hasProp(defined,depName)||hasProp(waiting,depName)||hasProp(defining,depName))args[i]=callDep(depName);else{if(!map.p)throw new Error(name+" missing "+depName);map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName]}ret=callback?callback.apply(defined[name],args):void 0,name&&(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name]?defined[name]=cjsModule.exports:ret===undef&&usingExports||(defined[name]=ret))}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync,alt){if("string"==typeof deps)return handlers[deps]?handlers[deps](callback):callDep(makeMap(deps,callback).f);if(!deps.splice){if(config=deps,config.deps&&req(config.deps,config.callback),!callback)return;callback.splice?(deps=callback,callback=relName,relName=null):deps=undef}return callback=callback||function(){},"function"==typeof relName&&(relName=forceSync,forceSync=alt),forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},4),req},req.config=function(cfg){return req(cfg)},requirejs._defined=defined,define=function(name,deps,callback){deps.splice||(callback=deps,deps=[]),hasProp(defined,name)||hasProp(waiting,name)||(waiting[name]=[name,deps,callback])},define.amd={jQuery:!0}}(),define("lib/almond",function(){}),function(){!function(p){var s=this||(0,eval)("this"),v=s.document,L=s.navigator,w=s.jQuery,D=s.JSON;!function(p){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?p(module.exports||exports,require):"function"==typeof define&&define.amd?define("ko",["exports","require"],p):p(s.ko={})}(function(M,N){function H(a,d){return null===a||typeof a in R?a===d:!1}function S(a,d){var c;return function(){c||(c=setTimeout(function(){c=p,a()},d))}}function T(a,d){var c;return function(){clearTimeout(c),c=setTimeout(a,d)}}function I(b,d,c,e){a.d[b]={init:function(b,h,k,f,m){var l,q;return a.s(function(){var f=a.a.c(h()),k=!c!=!f,z=!q;(z||d||k!==l)&&(z&&a.Y.la()&&(q=a.a.ia(a.f.childNodes(b),!0)),k?(z||a.f.T(b,a.a.ia(q)),a.Ca(e?e(m,f):m,b)):a.f.ja(b),l=k)},null,{o:b}),{controlsDescendantBindings:!0}}},a.h.ha[b]=!1,a.f.Q[b]=!0}var a="undefined"!=typeof M?M:{};a.b=function(b,d){for(var c=b.split("."),e=a,g=0;g<c.length-1;g++)e=e[c[g]];e[c[c.length-1]]=d},a.A=function(a,d,c){a[d]=c},a.version="3.2.0",a.b("version",a.version),a.a=function(){function b(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c])}function d(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function c(a,b){return a.__proto__=b,a}var e={__proto__:[]}instanceof Array,g={},h={};g[L&&/Firefox\/2/i.test(L.userAgent)?"KeyboardEvent":"UIEvents"]=["keyup","keydown","keypress"],g.MouseEvents="click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave".split(" "),b(g,function(a,b){if(b.length)for(var c=0,d=b.length;d>c;c++)h[b[c]]=a});var k={propertychange:!0},f=v&&function(){for(var a=3,b=v.createElement("div"),c=b.getElementsByTagName("i");b.innerHTML="<!--[if gt IE "+ ++a+"]><i></i><![endif]-->",c[0];);return a>4?a:p}();return{vb:["authenticity_token",/^__RequestVerificationToken(_.*)?$/],u:function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)},m:function(a,b){if("function"==typeof Array.prototype.indexOf)return Array.prototype.indexOf.call(a,b);for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},qb:function(a,b,c){for(var d=0,f=a.length;f>d;d++)if(b.call(c,a[d],d))return a[d];return null},ua:function(m,b){var c=a.a.m(m,b);c>0?m.splice(c,1):0===c&&m.shift()},rb:function(m){m=m||[];for(var b=[],c=0,d=m.length;d>c;c++)0>a.a.m(b,m[c])&&b.push(m[c]);return b},Da:function(a,b){a=a||[];for(var c=[],d=0,f=a.length;f>d;d++)c.push(b(a[d],d));return c},ta:function(a,b){a=a||[];for(var c=[],d=0,f=a.length;f>d;d++)b(a[d],d)&&c.push(a[d]);return c},ga:function(a,b){if(b instanceof Array)a.push.apply(a,b);else for(var c=0,d=b.length;d>c;c++)a.push(b[c]);return a},ea:function(b,c,d){var f=a.a.m(a.a.Xa(b),c);0>f?d&&b.push(c):d||b.splice(f,1)},xa:e,extend:d,za:c,Aa:e?c:d,G:b,na:function(a,b){if(!a)return a;var c={},d;for(d in a)a.hasOwnProperty(d)&&(c[d]=b(a[d],d,a));return c},Ka:function(b){for(;b.firstChild;)a.removeNode(b.firstChild)},oc:function(b){b=a.a.S(b);for(var c=v.createElement("div"),d=0,f=b.length;f>d;d++)c.appendChild(a.R(b[d]));return c},ia:function(b,c){for(var d=0,f=b.length,e=[];f>d;d++){var k=b[d].cloneNode(!0);e.push(c?a.R(k):k)}return e},T:function(b,c){if(a.a.Ka(b),c)for(var d=0,f=c.length;f>d;d++)b.appendChild(c[d])},Lb:function(b,c){var d=b.nodeType?[b]:b;if(0<d.length){for(var f=d[0],e=f.parentNode,k=0,g=c.length;g>k;k++)e.insertBefore(c[k],f);for(k=0,g=d.length;g>k;k++)a.removeNode(d[k])}},ka:function(a,b){if(a.length){for(b=8===b.nodeType&&b.parentNode||b;a.length&&a[0].parentNode!==b;)a.shift();if(1<a.length){var c=a[0],d=a[a.length-1];for(a.length=0;c!==d;)if(a.push(c),c=c.nextSibling,!c)return;a.push(d)}}return a},Nb:function(a,b){7>f?a.setAttribute("selected",b):a.selected=b},cb:function(a){return null===a||a===p?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")},vc:function(a,b){return a=a||"",b.length>a.length?!1:a.substring(0,b.length)===b},cc:function(a,b){if(a===b)return!0;if(11===a.nodeType)return!1;if(b.contains)return b.contains(3===a.nodeType?a.parentNode:a);if(b.compareDocumentPosition)return 16==(16&b.compareDocumentPosition(a));for(;a&&a!=b;)a=a.parentNode;return!!a},Ja:function(b){return a.a.cc(b,b.ownerDocument.documentElement)},ob:function(b){return!!a.a.qb(b,a.a.Ja)},t:function(a){return a&&a.tagName&&a.tagName.toLowerCase()},n:function(b,c,d){var e=f&&k[c];if(!e&&w)w(b).bind(c,d);else if(e||"function"!=typeof b.addEventListener){if("undefined"==typeof b.attachEvent)throw Error("Browser doesn't support addEventListener or attachEvent");var g=function(a){d.call(b,a)},h="on"+c;b.attachEvent(h,g),a.a.w.da(b,function(){b.detachEvent(h,g)})}else b.addEventListener(c,d,!1)},oa:function(b,c){if(!b||!b.nodeType)throw Error("element must be a DOM node when calling triggerEvent");var d;if("input"===a.a.t(b)&&b.type&&"click"==c.toLowerCase()?(d=b.type,d="checkbox"==d||"radio"==d):d=!1,w&&!d)w(b).trigger(c);else if("function"==typeof v.createEvent){if("function"!=typeof b.dispatchEvent)throw Error("The supplied element doesn't support dispatchEvent");d=v.createEvent(h[c]||"HTMLEvents"),d.initEvent(c,!0,!0,s,0,0,0,0,0,!1,!1,!1,!1,0,b),b.dispatchEvent(d)}else if(d&&b.click)b.click();else{if("undefined"==typeof b.fireEvent)throw Error("Browser doesn't support triggering events");b.fireEvent("on"+c)}},c:function(b){return a.C(b)?b():b},Xa:function(b){return a.C(b)?b.v():b},Ba:function(b,c,d){if(c){var f=/\S+/g,e=b.className.match(f)||[];a.a.u(c.match(f),function(b){a.a.ea(e,b,d)}),b.className=e.join(" ")}},bb:function(b,c){var d=a.a.c(c);(null===d||d===p)&&(d="");var f=a.f.firstChild(b);!f||3!=f.nodeType||a.f.nextSibling(f)?a.f.T(b,[b.ownerDocument.createTextNode(d)]):f.data=d,a.a.fc(b)},Mb:function(a,b){if(a.name=b,7>=f)try{a.mergeAttributes(v.createElement("<input name='"+a.name+"'/>"),!1)}catch(c){}},fc:function(a){f>=9&&(a=1==a.nodeType?a:a.parentNode,a.style&&(a.style.zoom=a.style.zoom))},dc:function(a){if(f){var b=a.style.width;a.style.width=0,a.style.width=b}},sc:function(b,c){b=a.a.c(b),c=a.a.c(c);for(var d=[],f=b;c>=f;f++)d.push(f);return d},S:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c]);return b},yc:6===f,zc:7===f,L:f,xb:function(b,c){for(var d=a.a.S(b.getElementsByTagName("input")).concat(a.a.S(b.getElementsByTagName("textarea"))),f="string"==typeof c?function(a){return a.name===c}:function(a){return c.test(a.name)},e=[],k=d.length-1;k>=0;k--)f(d[k])&&e.push(d[k]);return e},pc:function(b){return"string"==typeof b&&(b=a.a.cb(b))?D&&D.parse?D.parse(b):new Function("return "+b)():null},eb:function(b,c,d){if(!D||!D.stringify)throw Error("Cannot find JSON.stringify(). Some browsers (e.g., IE < 8) don't support it natively, but you can overcome this by adding a script reference to json2.js, downloadable from http://www.json.org/json2.js");return D.stringify(a.a.c(b),c,d)},qc:function(c,d,f){f=f||{};var e=f.params||{},k=f.includeFields||this.vb,g=c;if("object"==typeof c&&"form"===a.a.t(c))for(var g=c.action,h=k.length-1;h>=0;h--)for(var r=a.a.xb(c,k[h]),E=r.length-1;E>=0;E--)e[r[E].name]=r[E].value;d=a.a.c(d);var y=v.createElement("form");y.style.display="none",y.action=g,y.method="post";for(var p in d)c=v.createElement("input"),c.type="hidden",c.name=p,c.value=a.a.eb(a.a.c(d[p])),y.appendChild(c);b(e,function(a,b){var c=v.createElement("input");c.type="hidden",c.name=a,c.value=b,y.appendChild(c)}),v.body.appendChild(y),f.submitter?f.submitter(y):y.submit(),setTimeout(function(){y.parentNode.removeChild(y)},0)}}}(),a.b("utils",a.a),a.b("utils.arrayForEach",a.a.u),a.b("utils.arrayFirst",a.a.qb),a.b("utils.arrayFilter",a.a.ta),a.b("utils.arrayGetDistinctValues",a.a.rb),a.b("utils.arrayIndexOf",a.a.m),a.b("utils.arrayMap",a.a.Da),a.b("utils.arrayPushAll",a.a.ga),a.b("utils.arrayRemoveItem",a.a.ua),a.b("utils.extend",a.a.extend),a.b("utils.fieldsIncludedWithJsonPost",a.a.vb),a.b("utils.getFormFields",a.a.xb),a.b("utils.peekObservable",a.a.Xa),a.b("utils.postJson",a.a.qc),a.b("utils.parseJson",a.a.pc),a.b("utils.registerEventHandler",a.a.n),a.b("utils.stringifyJson",a.a.eb),a.b("utils.range",a.a.sc),a.b("utils.toggleDomNodeCssClass",a.a.Ba),a.b("utils.triggerEvent",a.a.oa),a.b("utils.unwrapObservable",a.a.c),a.b("utils.objectForEach",a.a.G),a.b("utils.addOrRemoveItem",a.a.ea),a.b("unwrap",a.a.c),Function.prototype.bind||(Function.prototype.bind=function(a){var d=this,c=Array.prototype.slice.call(arguments);return a=c.shift(),function(){return d.apply(a,c.concat(Array.prototype.slice.call(arguments)))}}),a.a.e=new function(){function a(b,h){var k=b[c];if(!k||"null"===k||!e[k]){if(!h)return p;k=b[c]="ko"+d++,e[k]={}}return e[k]}var d=0,c="__ko__"+(new Date).getTime(),e={};return{get:function(c,d){var e=a(c,!1);return e===p?p:e[d]},set:function(c,d,e){(e!==p||a(c,!1)!==p)&&(a(c,!0)[d]=e)},clear:function(a){var b=a[c];return b?(delete e[b],a[c]=null,!0):!1},F:function(){return d++ +c}}},a.b("utils.domData",a.a.e),a.b("utils.domData.clear",a.a.e.clear),a.a.w=new function(){function b(b,d){var f=a.a.e.get(b,c);return f===p&&d&&(f=[],a.a.e.set(b,c,f)),f}function d(c){var e=b(c,!1);if(e)for(var e=e.slice(0),f=0;f<e.length;f++)e[f](c);if(a.a.e.clear(c),a.a.w.cleanExternalData(c),g[c.nodeType])for(e=c.firstChild;c=e;)e=c.nextSibling,8===c.nodeType&&d(c)}var c=a.a.e.F(),e={1:!0,8:!0,9:!0},g={1:!0,9:!0};return{da:function(a,c){if("function"!=typeof c)throw Error("Callback must be a function");b(a,!0).push(c)},Kb:function(d,e){var f=b(d,!1);f&&(a.a.ua(f,e),0==f.length&&a.a.e.set(d,c,p))},R:function(b){if(e[b.nodeType]&&(d(b),g[b.nodeType])){var c=[];a.a.ga(c,b.getElementsByTagName("*"));for(var f=0,m=c.length;m>f;f++)d(c[f])}return b},removeNode:function(b){a.R(b),b.parentNode&&b.parentNode.removeChild(b)},cleanExternalData:function(a){w&&"function"==typeof w.cleanData&&w.cleanData([a])}}},a.R=a.a.w.R,a.removeNode=a.a.w.removeNode,a.b("cleanNode",a.R),a.b("removeNode",a.removeNode),a.b("utils.domNodeDisposal",a.a.w),a.b("utils.domNodeDisposal.addDisposeCallback",a.a.w.da),a.b("utils.domNodeDisposal.removeDisposeCallback",a.a.w.Kb),function(){a.a.ba=function(b){var d;if(w){if(w.parseHTML)d=w.parseHTML(b)||[];else if((d=w.clean([b]))&&d[0]){for(b=d[0];b.parentNode&&11!==b.parentNode.nodeType;)b=b.parentNode;b.parentNode&&b.parentNode.removeChild(b)}}else{var c=a.a.cb(b).toLowerCase();for(d=v.createElement("div"),c=c.match(/^<(thead|tbody|tfoot)/)&&[1,"<table>","</table>"]||!c.indexOf("<tr")&&[2,"<table><tbody>","</tbody></table>"]||(!c.indexOf("<td")||!c.indexOf("<th"))&&[3,"<table><tbody><tr>","</tr></tbody></table>"]||[0,"",""],b="ignored<div>"+c[1]+b+c[2]+"</div>","function"==typeof s.innerShiv?d.appendChild(s.innerShiv(b)):d.innerHTML=b;c[0]--;)d=d.lastChild;d=a.a.S(d.lastChild.childNodes)}return d},a.a.$a=function(b,d){if(a.a.Ka(b),d=a.a.c(d),null!==d&&d!==p)if("string"!=typeof d&&(d=d.toString()),w)w(b).html(d);else for(var c=a.a.ba(d),e=0;e<c.length;e++)b.appendChild(c[e])}}(),a.b("utils.parseHtmlFragment",a.a.ba),a.b("utils.setHtml",a.a.$a),a.D=function(){function b(c,d){if(c)if(8==c.nodeType){var g=a.D.Gb(c.nodeValue);null!=g&&d.push({bc:c,mc:g})}else if(1==c.nodeType)for(var g=0,h=c.childNodes,k=h.length;k>g;g++)b(h[g],d)}var d={};return{Ua:function(a){if("function"!=typeof a)throw Error("You can only pass a function to ko.memoization.memoize()");var b=(4294967296*(1+Math.random())|0).toString(16).substring(1)+(4294967296*(1+Math.random())|0).toString(16).substring(1);return d[b]=a,"<!--[ko_memo:"+b+"]-->"},Rb:function(a,b){var g=d[a];if(g===p)throw Error("Couldn't find any memo with ID "+a+". Perhaps it's already been unmemoized.");try{return g.apply(null,b||[]),!0}finally{delete d[a]}},Sb:function(c,d){var g=[];b(c,g);for(var h=0,k=g.length;k>h;h++){var f=g[h].bc,m=[f];d&&a.a.ga(m,d),a.D.Rb(g[h].mc,m),f.nodeValue="",f.parentNode&&f.parentNode.removeChild(f)}},Gb:function(a){return(a=a.match(/^\[ko_memo\:(.*?)\]$/))?a[1]:null}}}(),a.b("memoization",a.D),a.b("memoization.memoize",a.D.Ua),a.b("memoization.unmemoize",a.D.Rb),a.b("memoization.parseMemoText",a.D.Gb),a.b("memoization.unmemoizeDomNodeAndDescendants",a.D.Sb),a.La={throttle:function(b,d){b.throttleEvaluation=d;var c=null;return a.j({read:b,write:function(a){clearTimeout(c),c=setTimeout(function(){b(a)},d)}})},rateLimit:function(a,d){var c,e,g;"number"==typeof d?c=d:(c=d.timeout,e=d.method),g="notifyWhenChangesStop"==e?T:S,a.Ta(function(a){return g(a,c)})},notify:function(a,d){a.equalityComparer="always"==d?null:H}};var R={undefined:1,"boolean":1,number:1,string:1};a.b("extenders",a.La),a.Pb=function(b,d,c){this.target=b,this.wa=d,this.ac=c,this.Cb=!1,a.A(this,"dispose",this.K)},a.Pb.prototype.K=function(){this.Cb=!0,this.ac()},a.P=function(){a.a.Aa(this,a.P.fn),this.M={}};var G="change",A={U:function(b,d,c){var e=this;c=c||G;var g=new a.Pb(e,d?b.bind(d):b,function(){a.a.ua(e.M[c],g),e.nb&&e.nb()});return e.va&&e.va(c),e.M[c]||(e.M[c]=[]),e.M[c].push(g),g},notifySubscribers:function(b,d){if(d=d||G,this.Ab(d))try{a.k.Ea();for(var c=this.M[d].slice(0),e=0,g;g=c[e];++e)g.Cb||g.wa(b)}finally{a.k.end()}},Ta:function(b){var d=this,c=a.C(d),e,g,h;d.qa||(d.qa=d.notifySubscribers,d.notifySubscribers=function(a,b){b&&b!==G?"beforeChange"===b?d.kb(a):d.qa(a,b):d.lb(a)});var k=b(function(){c&&h===d&&(h=d()),e=!1,d.Pa(g,h)&&d.qa(g=h)});d.lb=function(a){e=!0,h=a,k()},d.kb=function(a){e||(g=a,d.qa(a,"beforeChange"))}},Ab:function(a){return this.M[a]&&this.M[a].length},yb:function(){var b=0;return a.a.G(this.M,function(a,c){b+=c.length}),b},Pa:function(a,d){return!this.equalityComparer||!this.equalityComparer(a,d)},extend:function(b){var d=this;return b&&a.a.G(b,function(b,e){var g=a.La[b];"function"==typeof g&&(d=g(d,e)||d)}),d}};a.A(A,"subscribe",A.U),a.A(A,"extend",A.extend),a.A(A,"getSubscriptionsCount",A.yb),a.a.xa&&a.a.za(A,Function.prototype),a.P.fn=A,a.Db=function(a){return null!=a&&"function"==typeof a.U&&"function"==typeof a.notifySubscribers},a.b("subscribable",a.P),a.b("isSubscribable",a.Db),a.Y=a.k=function(){function b(a){c.push(e),e=a}function d(){e=c.pop()}var c=[],e,g=0;return{Ea:b,end:d,Jb:function(b){if(e){if(!a.Db(b))throw Error("Only subscribable things can act as dependencies");e.wa(b,b.Vb||(b.Vb=++g))}},B:function(a,c,f){try{return b(),a.apply(c,f||[])}finally{d()}},la:function(){return e?e.s.la():void 0},ma:function(){return e?e.ma:void 0}}}(),a.b("computedContext",a.Y),a.b("computedContext.getDependenciesCount",a.Y.la),a.b("computedContext.isInitial",a.Y.ma),a.b("computedContext.isSleeping",a.Y.Ac),a.p=function(b){function d(){return 0<arguments.length?(d.Pa(c,arguments[0])&&(d.X(),c=arguments[0],d.W()),this):(a.k.Jb(d),c)}var c=b;return a.P.call(d),a.a.Aa(d,a.p.fn),d.v=function(){return c},d.W=function(){d.notifySubscribers(c)},d.X=function(){d.notifySubscribers(c,"beforeChange")},a.A(d,"peek",d.v),a.A(d,"valueHasMutated",d.W),a.A(d,"valueWillMutate",d.X),d},a.p.fn={equalityComparer:H};var F=a.p.rc="__ko_proto__";a.p.fn[F]=a.p,a.a.xa&&a.a.za(a.p.fn,a.P.fn),a.Ma=function(b,d){return null===b||b===p||b[F]===p?!1:b[F]===d?!0:a.Ma(b[F],d)},a.C=function(b){return a.Ma(b,a.p)},a.Ra=function(b){return"function"==typeof b&&b[F]===a.p||"function"==typeof b&&b[F]===a.j&&b.hc?!0:!1},a.b("observable",a.p),a.b("isObservable",a.C),a.b("isWriteableObservable",a.Ra),a.b("isWritableObservable",a.Ra),a.aa=function(b){if(b=b||[],"object"!=typeof b||!("length"in b))throw Error("The argument passed when initializing an observable array must be an array, or null, or undefined.");return b=a.p(b),a.a.Aa(b,a.aa.fn),b.extend({trackArrayChanges:!0})},a.aa.fn={remove:function(b){for(var d=this.v(),c=[],e="function"!=typeof b||a.C(b)?function(a){return a===b}:b,g=0;g<d.length;g++){var h=d[g];e(h)&&(0===c.length&&this.X(),c.push(h),d.splice(g,1),g--)}return c.length&&this.W(),c},removeAll:function(b){if(b===p){var d=this.v(),c=d.slice(0);return this.X(),d.splice(0,d.length),this.W(),c}return b?this.remove(function(c){return 0<=a.a.m(b,c)}):[]},destroy:function(b){var d=this.v(),c="function"!=typeof b||a.C(b)?function(a){return a===b}:b;this.X();for(var e=d.length-1;e>=0;e--)c(d[e])&&(d[e]._destroy=!0);this.W()},destroyAll:function(b){return b===p?this.destroy(function(){return!0}):b?this.destroy(function(d){return 0<=a.a.m(b,d)}):[]},indexOf:function(b){var d=this();return a.a.m(d,b)},replace:function(a,d){var c=this.indexOf(a);c>=0&&(this.X(),this.v()[c]=d,this.W())}},a.a.u("pop push reverse shift sort splice unshift".split(" "),function(b){a.aa.fn[b]=function(){var a=this.v();return this.X(),this.sb(a,b,arguments),a=a[b].apply(a,arguments),this.W(),a}}),a.a.u(["slice"],function(b){a.aa.fn[b]=function(){var a=this();return a[b].apply(a,arguments)}}),a.a.xa&&a.a.za(a.aa.fn,a.p.fn),a.b("observableArray",a.aa);var J="arrayChange";a.La.trackArrayChanges=function(b){function d(){if(!c){c=!0;var d=b.notifySubscribers;b.notifySubscribers=function(a,b){return b&&b!==G||++g,d.apply(this,arguments)};var f=[].concat(b.v()||[]);e=null,b.U(function(c){if(c=[].concat(c||[]),b.Ab(J)){var d;(!e||g>1)&&(e=a.a.Fa(f,c,{sparse:!0})),d=e,d.length&&b.notifySubscribers(d,J)}f=c,e=null,g=0})}}if(!b.sb){var c=!1,e=null,g=0,h=b.U;b.U=b.subscribe=function(a,b,c){return c===J&&d(),h.apply(this,arguments)},b.sb=function(b,d,m){function l(a,b,c){return q[q.length]={status:a,value:b,index:c}}if(c&&!g){var q=[],h=b.length,t=m.length,z=0;switch(d){case"push":z=h;case"unshift":for(d=0;t>d;d++)l("added",m[d],z+d);break;case"pop":z=h-1;case"shift":h&&l("deleted",b[z],z);break;case"splice":d=Math.min(Math.max(0,0>m[0]?h+m[0]:m[0]),h);for(var h=1===t?h:Math.min(d+(m[1]||0),h),t=d+t-2,z=Math.max(h,t),u=[],r=[],E=2;z>d;++d,++E)h>d&&r.push(l("deleted",b[d],d)),t>d&&u.push(l("added",m[E],d));a.a.wb(r,u);break;default:return}e=q}}}},a.s=a.j=function(b,d,c){function e(){a.a.G(v,function(a,b){b.K()}),v={}}function g(){e(),C=0,u=!0,n=!1}function h(){var a=f.throttleEvaluation;a&&a>=0?(clearTimeout(P),P=setTimeout(k,a)):f.ib?f.ib():k()}function k(b){if(t){if(E)throw Error("A 'pure' computed must not be called recursively")}else if(!u){if(w&&w()){if(!z)return void s()}else z=!1;if(t=!0,y)try{var c={};a.k.Ea({wa:function(a,b){c[b]||(c[b]=1,++C)},s:f,ma:p}),C=0,q=r.call(d)}finally{a.k.end(),t=!1}else try{var e=v,m=C;a.k.Ea({wa:function(a,b){u||(m&&e[b]?(v[b]=e[b],++C,delete e[b],--m):v[b]||(v[b]=a.U(h),++C))},s:f,ma:E?p:!C}),v={},C=0;try{var l=d?r.call(d):r()}finally{a.k.end(),m&&a.a.G(e,function(a,b){b.K()}),n=!1}f.Pa(q,l)&&(f.notifySubscribers(q,"beforeChange"),q=l,!0!==b&&f.notifySubscribers(q))}finally{t=!1}C||s()}}function f(){if(0<arguments.length){if("function"!=typeof O)throw Error("Cannot write a value to a ko.computed unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters.");return O.apply(d,arguments),this}return a.k.Jb(f),n&&k(!0),q}function m(){return n&&!C&&k(!0),q}function l(){return n||C>0}var q,n=!0,t=!1,z=!1,u=!1,r=b,E=!1,y=!1;if(r&&"object"==typeof r?(c=r,r=c.read):(c=c||{},r||(r=c.read)),"function"!=typeof r)throw Error("Pass a function that returns the value of the ko.computed");var O=c.write,x=c.disposeWhenNodeIsRemoved||c.o||null,B=c.disposeWhen||c.Ia,w=B,s=g,v={},C=0,P=null;d||(d=c.owner),a.P.call(f),a.a.Aa(f,a.j.fn),f.v=m,f.la=function(){return C},f.hc="function"==typeof c.write,f.K=function(){s()},f.Z=l;var A=f.Ta;return f.Ta=function(a){A.call(f,a),f.ib=function(){f.kb(q),n=!0,f.lb(f)}},c.pure?(y=E=!0,f.va=function(){y&&(y=!1,k(!0))},f.nb=function(){f.yb()||(e(),y=n=!0)}):c.deferEvaluation&&(f.va=function(){m(),delete f.va}),a.A(f,"peek",f.v),a.A(f,"dispose",f.K),a.A(f,"isActive",f.Z),a.A(f,"getDependenciesCount",f.la),x&&(z=!0,x.nodeType&&(w=function(){return!a.a.Ja(x)||B&&B()})),y||c.deferEvaluation||k(),x&&l()&&x.nodeType&&(s=function(){a.a.w.Kb(x,s),g()},a.a.w.da(x,s)),f},a.jc=function(b){return a.Ma(b,a.j)},A=a.p.rc,a.j[A]=a.p,a.j.fn={equalityComparer:H},a.j.fn[A]=a.j,a.a.xa&&a.a.za(a.j.fn,a.P.fn),a.b("dependentObservable",a.j),a.b("computed",a.j),a.b("isComputed",a.jc),a.Ib=function(b,d){return"function"==typeof b?a.s(b,d,{pure:!0}):(b=a.a.extend({},b),b.pure=!0,a.s(b,d))},a.b("pureComputed",a.Ib),function(){function b(a,g,h){if(h=h||new c,a=g(a),"object"!=typeof a||null===a||a===p||a instanceof Date||a instanceof String||a instanceof Number||a instanceof Boolean)return a;var k=a instanceof Array?[]:{};return h.save(a,k),d(a,function(c){var d=g(a[c]);switch(typeof d){case"boolean":case"number":case"string":case"function":k[c]=d;break;case"object":case"undefined":var l=h.get(d);k[c]=l!==p?l:b(d,g,h)}}),k}function d(a,b){if(a instanceof Array){for(var c=0;c<a.length;c++)b(c);"function"==typeof a.toJSON&&b("toJSON")}else for(c in a)b(c)}function c(){this.keys=[],this.hb=[]}a.Qb=function(c){if(0==arguments.length)throw Error("When calling ko.toJS, pass the object you want to convert.");return b(c,function(b){for(var c=0;a.C(b)&&10>c;c++)b=b();return b})},a.toJSON=function(b,c,d){return b=a.Qb(b),a.a.eb(b,c,d)},c.prototype={save:function(b,c){var d=a.a.m(this.keys,b);d>=0?this.hb[d]=c:(this.keys.push(b),this.hb.push(c))},get:function(b){return b=a.a.m(this.keys,b),b>=0?this.hb[b]:p}}}(),a.b("toJS",a.Qb),a.b("toJSON",a.toJSON),function(){a.i={q:function(b){switch(a.a.t(b)){case"option":return!0===b.__ko__hasDomDataOptionValue__?a.a.e.get(b,a.d.options.Va):7>=a.a.L?b.getAttributeNode("value")&&b.getAttributeNode("value").specified?b.value:b.text:b.value;case"select":return 0<=b.selectedIndex?a.i.q(b.options[b.selectedIndex]):p;default:return b.value}},ca:function(b,d,c){switch(a.a.t(b)){case"option":switch(typeof d){case"string":a.a.e.set(b,a.d.options.Va,p),"__ko__hasDomDataOptionValue__"in b&&delete b.__ko__hasDomDataOptionValue__,b.value=d;break;default:a.a.e.set(b,a.d.options.Va,d),b.__ko__hasDomDataOptionValue__=!0,b.value="number"==typeof d?d:""}break;case"select":(""===d||null===d)&&(d=p);for(var e=-1,g=0,h=b.options.length,k;h>g;++g)if(k=a.i.q(b.options[g]),k==d||""==k&&d===p){e=g;break}(c||e>=0||d===p&&1<b.size)&&(b.selectedIndex=e);break;default:(null===d||d===p)&&(d=""),b.value=d}}}}(),a.b("selectExtensions",a.i),a.b("selectExtensions.readValue",a.i.q),a.b("selectExtensions.writeValue",a.i.ca),a.h=function(){function b(b){b=a.a.cb(b),123===b.charCodeAt(0)&&(b=b.slice(1,-1));var c=[],d=b.match(e),k,n,t=0;if(d){d.push(",");for(var z=0,u;u=d[z];++z){var r=u.charCodeAt(0);if(44===r){if(0>=t){k&&c.push(n?{key:k,value:n.join("")}:{unknown:k}),k=n=t=0;continue}}else if(58===r){if(!n)continue}else if(47===r&&z&&1<u.length)(r=d[z-1].match(g))&&!h[r[0]]&&(b=b.substr(b.indexOf(u)+1),d=b.match(e),d.push(","),z=-1,u="/");else if(40===r||123===r||91===r)++t;else if(41===r||125===r||93===r)--t;else if(!k&&!n){k=34===r||39===r?u.slice(1,-1):u;continue}n?n.push(u):n=[u]}}return c}var d=["true","false","null","undefined"],c=/^(?:[$_a-z][$\w]*|(.+)(\.\s*[$_a-z][$\w]*|\[.+\]))$/i,e=RegExp("\"(?:[^\"\\\\]|\\\\.)*\"|'(?:[^'\\\\]|\\\\.)*'|/(?:[^/\\\\]|\\\\.)*/w*|[^\\s:,/][^,\"'{}()/:[\\]]*[^\\s,\"'{}()/:[\\]]|[^\\s]","g"),g=/[\])"'A-Za-z0-9_$]+$/,h={"in":1,"return":1,"typeof":1},k={};return{ha:[],V:k,Wa:b,ya:function(f,m){function e(b,m){var f;if(!z){var u=a.getBindingHandler(b);if(u&&u.preprocess&&!(m=u.preprocess(m,b,e)))return;(u=k[b])&&(f=m,0<=a.a.m(d,f)?f=!1:(u=f.match(c),f=null===u?!1:u[1]?"Object("+u[1]+")"+u[2]:f),u=f),u&&h.push("'"+b+"':function(_z){"+f+"=_z}")}t&&(m="function(){return "+m+" }"),g.push("'"+b+"':"+m)}m=m||{};var g=[],h=[],t=m.valueAccessors,z=m.bindingParams,u="string"==typeof f?b(f):f;return a.a.u(u,function(a){e(a.key||a.unknown,a.value)}),h.length&&e("_ko_property_writers","{"+h.join(",")+" }"),g.join(",")
},lc:function(a,b){for(var c=0;c<a.length;c++)if(a[c].key==b)return!0;return!1},pa:function(b,c,d,e,k){b&&a.C(b)?!a.Ra(b)||k&&b.v()===e||b(e):(b=c.get("_ko_property_writers"))&&b[d]&&b[d](e)}}}(),a.b("expressionRewriting",a.h),a.b("expressionRewriting.bindingRewriteValidators",a.h.ha),a.b("expressionRewriting.parseObjectLiteral",a.h.Wa),a.b("expressionRewriting.preProcessBindings",a.h.ya),a.b("expressionRewriting._twoWayBindings",a.h.V),a.b("jsonExpressionRewriting",a.h),a.b("jsonExpressionRewriting.insertPropertyAccessorsIntoJson",a.h.ya),function(){function b(a){return 8==a.nodeType&&h.test(g?a.text:a.nodeValue)}function d(a){return 8==a.nodeType&&k.test(g?a.text:a.nodeValue)}function c(a,c){for(var f=a,e=1,k=[];f=f.nextSibling;){if(d(f)&&(e--,0===e))return k;k.push(f),b(f)&&e++}if(!c)throw Error("Cannot find closing comment tag to match: "+a.nodeValue);return null}function e(a,b){var d=c(a,b);return d?0<d.length?d[d.length-1].nextSibling:a.nextSibling:null}var g=v&&"<!--test-->"===v.createComment("test").text,h=g?/^\x3c!--\s*ko(?:\s+([\s\S]+))?\s*--\x3e$/:/^\s*ko(?:\s+([\s\S]+))?\s*$/,k=g?/^\x3c!--\s*\/ko\s*--\x3e$/:/^\s*\/ko\s*$/,f={ul:!0,ol:!0};a.f={Q:{},childNodes:function(a){return b(a)?c(a):a.childNodes},ja:function(c){if(b(c)){c=a.f.childNodes(c);for(var d=0,f=c.length;f>d;d++)a.removeNode(c[d])}else a.a.Ka(c)},T:function(c,d){if(b(c)){a.f.ja(c);for(var f=c.nextSibling,e=0,k=d.length;k>e;e++)f.parentNode.insertBefore(d[e],f)}else a.a.T(c,d)},Hb:function(a,c){b(a)?a.parentNode.insertBefore(c,a.nextSibling):a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)},Bb:function(c,d,f){f?b(c)?c.parentNode.insertBefore(d,f.nextSibling):f.nextSibling?c.insertBefore(d,f.nextSibling):c.appendChild(d):a.f.Hb(c,d)},firstChild:function(a){return b(a)?!a.nextSibling||d(a.nextSibling)?null:a.nextSibling:a.firstChild},nextSibling:function(a){return b(a)&&(a=e(a)),a.nextSibling&&d(a.nextSibling)?null:a.nextSibling},gc:b,xc:function(a){return(a=(g?a.text:a.nodeValue).match(h))?a[1]:null},Fb:function(c){if(f[a.a.t(c)]){var k=c.firstChild;if(k)do if(1===k.nodeType){var g;g=k.firstChild;var h=null;if(g)do if(h)h.push(g);else if(b(g)){var t=e(g,!0);t?g=t:h=[g]}else d(g)&&(h=[g]);while(g=g.nextSibling);if(g=h)for(h=k.nextSibling,t=0;t<g.length;t++)h?c.insertBefore(g[t],h):c.appendChild(g[t])}while(k=k.nextSibling)}}}}(),a.b("virtualElements",a.f),a.b("virtualElements.allowedBindings",a.f.Q),a.b("virtualElements.emptyNode",a.f.ja),a.b("virtualElements.insertAfter",a.f.Bb),a.b("virtualElements.prepend",a.f.Hb),a.b("virtualElements.setDomNodeChildren",a.f.T),function(){a.J=function(){this.Yb={}},a.a.extend(a.J.prototype,{nodeHasBindings:function(b){switch(b.nodeType){case 1:return null!=b.getAttribute("data-bind")||a.g.getComponentNameForNode(b);case 8:return a.f.gc(b);default:return!1}},getBindings:function(b,d){var c=this.getBindingsString(b,d),c=c?this.parseBindingsString(c,d,b):null;return a.g.mb(c,b,d,!1)},getBindingAccessors:function(b,d){var c=this.getBindingsString(b,d),c=c?this.parseBindingsString(c,d,b,{valueAccessors:!0}):null;return a.g.mb(c,b,d,!0)},getBindingsString:function(b){switch(b.nodeType){case 1:return b.getAttribute("data-bind");case 8:return a.f.xc(b);default:return null}},parseBindingsString:function(b,d,c,e){try{var g=this.Yb,h=b+(e&&e.valueAccessors||""),k;if(!(k=g[h])){var f,m="with($context){with($data||{}){return{"+a.h.ya(b,e)+"}}}";f=new Function("$context","$element",m),k=g[h]=f}return k(d,c)}catch(l){throw l.message="Unable to parse bindings.\nBindings value: "+b+"\nMessage: "+l.message,l}}}),a.J.instance=new a.J}(),a.b("bindingProvider",a.J),function(){function b(a){return function(){return a}}function d(a){return a()}function c(b){return a.a.na(a.k.B(b),function(a,c){return function(){return b()[c]}})}function e(a,b){return c(this.getBindings.bind(this,a,b))}function g(b,c,d){var f,e=a.f.firstChild(c),k=a.J.instance,g=k.preprocessNode;if(g){for(;f=e;)e=a.f.nextSibling(f),g.call(k,f);e=a.f.firstChild(c)}for(;f=e;)e=a.f.nextSibling(f),h(b,f,d)}function h(b,c,d){var e=!0,k=1===c.nodeType;k&&a.f.Fb(c),(k&&d||a.J.instance.nodeHasBindings(c))&&(e=f(c,null,b,d).shouldBindDescendants),e&&!l[a.a.t(c)]&&g(b,c,!k)}function k(b){var c=[],d={},f=[];return a.a.G(b,function y(e){if(!d[e]){var k=a.getBindingHandler(e);k&&(k.after&&(f.push(e),a.a.u(k.after,function(c){if(b[c]){if(-1!==a.a.m(f,c))throw Error("Cannot combine the following bindings, because they have a cyclic dependency: "+f.join(", "));y(c)}}),f.length--),c.push({key:e,zb:k})),d[e]=!0}}),c}function f(b,c,f,g){var m=a.a.e.get(b,q);if(!c){if(m)throw Error("You cannot apply bindings multiple times to the same element.");a.a.e.set(b,q,!0)}!m&&g&&a.Ob(b,f);var l;if(c&&"function"!=typeof c)l=c;else{var h=a.J.instance,n=h.getBindingAccessors||e,s=a.j(function(){return(l=c?c(f,b):n.call(h,b,f))&&f.I&&f.I(),l},null,{o:b});l&&s.Z()||(s=null)}var v;if(l){var w=s?function(a){return function(){return d(s()[a])}}:function(a){return l[a]},A=function(){return a.a.na(s?s():l,d)};A.get=function(a){return l[a]&&d(w(a))},A.has=function(a){return a in l},g=k(l),a.a.u(g,function(c){var d=c.zb.init,e=c.zb.update,k=c.key;if(8===b.nodeType&&!a.f.Q[k])throw Error("The binding '"+k+"' cannot be used with virtual elements");try{"function"==typeof d&&a.k.B(function(){var a=d(b,w(k),A,f.$data,f);if(a&&a.controlsDescendantBindings){if(v!==p)throw Error("Multiple bindings ("+v+" and "+k+") are trying to control descendant bindings of the same element. You cannot use these bindings together on the same element.");v=k}}),"function"==typeof e&&a.j(function(){e(b,w(k),A,f.$data,f)},null,{o:b})}catch(g){throw g.message='Unable to process binding "'+k+": "+l[k]+'"\nMessage: '+g.message,g}})}return{shouldBindDescendants:v===p}}function m(b){return b&&b instanceof a.N?b:new a.N(b)}a.d={};var l={script:!0};a.getBindingHandler=function(b){return a.d[b]},a.N=function(b,c,d,f){var e=this,k="function"==typeof b&&!a.C(b),g,m=a.j(function(){var g=k?b():b,l=a.a.c(g);return c?(c.I&&c.I(),a.a.extend(e,c),m&&(e.I=m)):(e.$parents=[],e.$root=l,e.ko=a),e.$rawData=g,e.$data=l,d&&(e[d]=l),f&&f(e,c,l),e.$data},null,{Ia:function(){return g&&!a.a.ob(g)},o:!0});m.Z()&&(e.I=m,m.equalityComparer=null,g=[],m.Tb=function(b){g.push(b),a.a.w.da(b,function(b){a.a.ua(g,b),g.length||(m.K(),e.I=m=p)})})},a.N.prototype.createChildContext=function(b,c,d){return new a.N(b,this,c,function(a,b){a.$parentContext=b,a.$parent=b.$data,a.$parents=(b.$parents||[]).slice(0),a.$parents.unshift(a.$parent),d&&d(a)})},a.N.prototype.extend=function(b){return new a.N(this.I||this.$data,this,null,function(c,d){c.$rawData=d.$rawData,a.a.extend(c,"function"==typeof b?b():b)})};var q=a.a.e.F(),n=a.a.e.F();a.Ob=function(b,c){return 2!=arguments.length?a.a.e.get(b,n):(a.a.e.set(b,n,c),void(c.I&&c.I.Tb(b)))},a.ra=function(b,c,d){return 1===b.nodeType&&a.f.Fb(b),f(b,c,m(d),!0)},a.Wb=function(d,f,e){return e=m(e),a.ra(d,"function"==typeof f?c(f.bind(null,e,d)):a.a.na(f,b),e)},a.Ca=function(a,b){1!==b.nodeType&&8!==b.nodeType||g(m(a),b,!0)},a.pb=function(a,b){if(!w&&s.jQuery&&(w=s.jQuery),b&&1!==b.nodeType&&8!==b.nodeType)throw Error("ko.applyBindings: first parameter should be your view model; second parameter should be a DOM node");b=b||s.document.body,h(m(a),b,!0)},a.Ha=function(b){switch(b.nodeType){case 1:case 8:var c=a.Ob(b);if(c)return c;if(b.parentNode)return a.Ha(b.parentNode)}return p},a.$b=function(b){return(b=a.Ha(b))?b.$data:p},a.b("bindingHandlers",a.d),a.b("applyBindings",a.pb),a.b("applyBindingsToDescendants",a.Ca),a.b("applyBindingAccessorsToNode",a.ra),a.b("applyBindingsToNode",a.Wb),a.b("contextFor",a.Ha),a.b("dataFor",a.$b)}(),function(b){function d(d,f){var e=g.hasOwnProperty(d)?g[d]:b,l;e||(e=g[d]=new a.P,c(d,function(a){h[d]=a,delete g[d],l?e.notifySubscribers(a):setTimeout(function(){e.notifySubscribers(a)},0)}),l=!0),e.U(f)}function c(a,b){e("getConfig",[a],function(c){c?e("loadComponent",[a,c],function(a){b(a)}):b(null)})}function e(c,d,g,l){l||(l=a.g.loaders.slice(0));var h=l.shift();if(h){var n=h[c];if(n){var t=!1;if(n.apply(h,d.concat(function(a){t?g(null):null!==a?g(a):e(c,d,g,l)}))!==b&&(t=!0,!h.suppressLoaderExceptions))throw Error("Component loaders must supply values by invoking the callback, not by returning values synchronously.")}else e(c,d,g,l)}else g(null)}var g={},h={};a.g={get:function(a,c){var e=h.hasOwnProperty(a)?h[a]:b;e?setTimeout(function(){c(e)},0):d(a,c)},tb:function(a){delete h[a]},jb:e},a.g.loaders=[],a.b("components",a.g),a.b("components.get",a.g.get),a.b("components.clearCachedDefinition",a.g.tb)}(),function(){function b(b,c,d,e){function k(){0===--u&&e(h)}var h={},u=2,r=d.template;d=d.viewModel,r?g(c,r,function(c){a.g.jb("loadTemplate",[b,c],function(a){h.template=a,k()})}):k(),d?g(c,d,function(c){a.g.jb("loadViewModel",[b,c],function(a){h[f]=a,k()})}):k()}function d(a,b,c){if("function"==typeof b)c(function(a){return new b(a)});else if("function"==typeof b[f])c(b[f]);else if("instance"in b){var e=b.instance;c(function(){return e})}else"viewModel"in b?d(a,b.viewModel,c):a("Unknown viewModel value: "+b)}function c(b){switch(a.a.t(b)){case"script":return a.a.ba(b.text);case"textarea":return a.a.ba(b.value);case"template":if(e(b.content))return a.a.ia(b.content.childNodes)}return a.a.ia(b.childNodes)}function e(a){return s.DocumentFragment?a instanceof DocumentFragment:a&&11===a.nodeType}function g(a,b,c){"string"==typeof b.require?N||s.require?(N||s.require)([b.require],c):a("Uses require, but no AMD loader is present"):c(b)}function h(a){return function(b){throw Error("Component '"+a+"': "+b)}}var k={};a.g.tc=function(b,c){if(!c)throw Error("Invalid configuration for "+b);if(a.g.Qa(b))throw Error("Component "+b+" is already registered");k[b]=c},a.g.Qa=function(a){return a in k},a.g.wc=function(b){delete k[b],a.g.tb(b)},a.g.ub={getConfig:function(a,b){b(k.hasOwnProperty(a)?k[a]:null)},loadComponent:function(a,c,d){var e=h(a);g(e,c,function(c){b(a,e,c,d)})},loadTemplate:function(b,d,f){if(b=h(b),"string"==typeof d)f(a.a.ba(d));else if(d instanceof Array)f(d);else if(e(d))f(a.a.S(d.childNodes));else if(d.element)if(d=d.element,s.HTMLElement?d instanceof HTMLElement:d&&d.tagName&&1===d.nodeType)f(c(d));else if("string"==typeof d){var k=v.getElementById(d);k?f(c(k)):b("Cannot find element with ID "+d)}else b("Unknown element type: "+d);else b("Unknown template value: "+d)},loadViewModel:function(a,b,c){d(h(a),b,c)}};var f="createViewModel";a.b("components.register",a.g.tc),a.b("components.isRegistered",a.g.Qa),a.b("components.unregister",a.g.wc),a.b("components.defaultLoader",a.g.ub),a.g.loaders.push(a.g.ub),a.g.Ub=k}(),function(){function b(b,e){var g=b.getAttribute("params");if(g){var g=d.parseBindingsString(g,e,b,{valueAccessors:!0,bindingParams:!0}),g=a.a.na(g,function(d){return a.s(d,null,{o:b})}),h=a.a.na(g,function(d){return d.Z()?a.s(function(){return a.a.c(d())},null,{o:b}):d.v()});return h.hasOwnProperty("$raw")||(h.$raw=g),h}return{$raw:{}}}a.g.getComponentNameForNode=function(b){return b=a.a.t(b),a.g.Qa(b)&&b},a.g.mb=function(c,d,g,h){if(1===d.nodeType){var k=a.g.getComponentNameForNode(d);if(k){if(c=c||{},c.component)throw Error('Cannot use the "component" binding on a custom element matching a component');var f={name:k,params:b(d,g)};c.component=h?function(){return f}:f}}return c};var d=new a.J;9>a.a.L&&(a.g.register=function(a){return function(b){return v.createElement(b),a.apply(this,arguments)}}(a.g.register),v.createDocumentFragment=function(b){return function(){var d=b(),g=a.g.Ub,h;for(h in g)g.hasOwnProperty(h)&&d.createElement(h);return d}}(v.createDocumentFragment))}(),function(){var b=0;a.d.component={init:function(d,c,e,g,h){function k(){var a=f&&f.dispose;"function"==typeof a&&a.call(f),m=null}var f,m;return a.a.w.da(d,k),a.s(function(){var e=a.a.c(c()),g,n;if("string"==typeof e?g=e:(g=a.a.c(e.name),n=a.a.c(e.params)),!g)throw Error("No component name specified");var t=m=++b;a.g.get(g,function(b){if(m===t){if(k(),!b)throw Error("Unknown component '"+g+"'");var c=b.template;if(!c)throw Error("Component '"+g+"' has no template");c=a.a.ia(c),a.f.T(d,c);var c=n,e=b.createViewModel;b=e?e.call(b,c,{element:d}):c,c=h.createChildContext(b),f=b,a.Ca(c,d)}})},null,{o:d}),{controlsDescendantBindings:!0}}},a.f.Q.component=!0}();var Q={"class":"className","for":"htmlFor"};a.d.attr={update:function(b,d){var c=a.a.c(d())||{};a.a.G(c,function(c,d){d=a.a.c(d);var h=!1===d||null===d||d===p;h&&b.removeAttribute(c),8>=a.a.L&&c in Q?(c=Q[c],h?b.removeAttribute(c):b[c]=d):h||b.setAttribute(c,d.toString()),"name"===c&&a.a.Mb(b,h?"":d.toString())})}},function(){a.d.checked={after:["value","attr"],init:function(b,d,c){function e(){var e=b.checked,k=q?h():e;if(!a.Y.ma()&&(!f||e)){var g=a.k.B(d);m?l!==k?(e&&(a.a.ea(g,k,!0),a.a.ea(g,l,!1)),l=k):a.a.ea(g,k,e):a.h.pa(g,c,"checked",k,!0)}}function g(){var c=a.a.c(d());b.checked=m?0<=a.a.m(c,h()):k?c:h()===c}var h=a.Ib(function(){return c.has("checkedValue")?a.a.c(c.get("checkedValue")):c.has("value")?a.a.c(c.get("value")):b.value}),k="checkbox"==b.type,f="radio"==b.type;if(k||f){var m=k&&a.a.c(d())instanceof Array,l=m?h():p,q=f||m;f&&!b.name&&a.d.uniqueName.init(b,function(){return!0}),a.s(e,null,{o:b}),a.a.n(b,"click",e),a.s(g,null,{o:b})}}},a.h.V.checked=!0,a.d.checkedValue={update:function(b,d){b.value=a.a.c(d())}}}(),a.d.css={update:function(b,d){var c=a.a.c(d());"object"==typeof c?a.a.G(c,function(c,d){d=a.a.c(d),a.a.Ba(b,c,d)}):(c=String(c||""),a.a.Ba(b,b.__ko__cssValue,!1),b.__ko__cssValue=c,a.a.Ba(b,c,!0))}},a.d.enable={update:function(b,d){var c=a.a.c(d());c&&b.disabled?b.removeAttribute("disabled"):c||b.disabled||(b.disabled=!0)}},a.d.disable={update:function(b,d){a.d.enable.update(b,function(){return!a.a.c(d())})}},a.d.event={init:function(b,d,c,e,g){var h=d()||{};a.a.G(h,function(k){"string"==typeof k&&a.a.n(b,k,function(b){var h,l=d()[k];if(l){try{var q=a.a.S(arguments);e=g.$data,q.unshift(e),h=l.apply(e,q)}finally{!0!==h&&(b.preventDefault?b.preventDefault():b.returnValue=!1)}!1===c.get(k+"Bubble")&&(b.cancelBubble=!0,b.stopPropagation&&b.stopPropagation())}})})}},a.d.foreach={Eb:function(b){return function(){var d=b(),c=a.a.Xa(d);return c&&"number"!=typeof c.length?(a.a.c(d),{foreach:c.data,as:c.as,includeDestroyed:c.includeDestroyed,afterAdd:c.afterAdd,beforeRemove:c.beforeRemove,afterRender:c.afterRender,beforeMove:c.beforeMove,afterMove:c.afterMove,templateEngine:a.O.Oa}):{foreach:d,templateEngine:a.O.Oa}}},init:function(b,d){return a.d.template.init(b,a.d.foreach.Eb(d))},update:function(b,d,c,e,g){return a.d.template.update(b,a.d.foreach.Eb(d),c,e,g)}},a.h.ha.foreach=!1,a.f.Q.foreach=!0,a.d.hasfocus={init:function(b,d,c){function e(e){b.__ko_hasfocusUpdating=!0;var f=b.ownerDocument;if("activeElement"in f){var g;try{g=f.activeElement}catch(h){g=f.body}e=g===b}f=d(),a.h.pa(f,c,"hasfocus",e,!0),b.__ko_hasfocusLastValue=e,b.__ko_hasfocusUpdating=!1}var g=e.bind(null,!0),h=e.bind(null,!1);a.a.n(b,"focus",g),a.a.n(b,"focusin",g),a.a.n(b,"blur",h),a.a.n(b,"focusout",h)},update:function(b,d){var c=!!a.a.c(d());b.__ko_hasfocusUpdating||b.__ko_hasfocusLastValue===c||(c?b.focus():b.blur(),a.k.B(a.a.oa,null,[b,c?"focusin":"focusout"]))}},a.h.V.hasfocus=!0,a.d.hasFocus=a.d.hasfocus,a.h.V.hasFocus=!0,a.d.html={init:function(){return{controlsDescendantBindings:!0}},update:function(b,d){a.a.$a(b,d())}},I("if"),I("ifnot",!1,!0),I("with",!0,!1,function(a,d){return a.createChildContext(d)});var K={};a.d.options={init:function(b){if("select"!==a.a.t(b))throw Error("options binding applies only to SELECT elements");for(;0<b.length;)b.remove(0);return{controlsDescendantBindings:!0}},update:function(b,d,c){function e(){return a.a.ta(b.options,function(a){return a.selected})}function g(a,b,c){var d=typeof b;return"function"==d?b(a):"string"==d?a[b]:c}function h(c,d){if(q.length){var e=0<=a.a.m(q,a.i.q(d[0]));a.a.Nb(d[0],e),n&&!e&&a.k.B(a.a.oa,null,[b,"change"])}}var k=0!=b.length&&b.multiple?b.scrollTop:null,f=a.a.c(d()),m=c.get("optionsIncludeDestroyed");d={};var l,q;q=b.multiple?a.a.Da(e(),a.i.q):0<=b.selectedIndex?[a.i.q(b.options[b.selectedIndex])]:[],f&&("undefined"==typeof f.length&&(f=[f]),l=a.a.ta(f,function(b){return m||b===p||null===b||!a.a.c(b._destroy)}),c.has("optionsCaption")&&(f=a.a.c(c.get("optionsCaption")),null!==f&&f!==p&&l.unshift(K)));var n=!1;d.beforeRemove=function(a){b.removeChild(a)},f=h,c.has("optionsAfterRender")&&(f=function(b,d){h(0,d),a.k.B(c.get("optionsAfterRender"),null,[d[0],b!==K?b:p])}),a.a.Za(b,l,function(d,e,f){return f.length&&(q=f[0].selected?[a.i.q(f[0])]:[],n=!0),e=b.ownerDocument.createElement("option"),d===K?(a.a.bb(e,c.get("optionsCaption")),a.i.ca(e,p)):(f=g(d,c.get("optionsValue"),d),a.i.ca(e,a.a.c(f)),d=g(d,c.get("optionsText"),f),a.a.bb(e,d)),[e]},d,f),a.k.B(function(){c.get("valueAllowUnset")&&c.has("value")?a.i.ca(b,a.a.c(c.get("value")),!0):(b.multiple?q.length&&e().length<q.length:q.length&&0<=b.selectedIndex?a.i.q(b.options[b.selectedIndex])!==q[0]:q.length||0<=b.selectedIndex)&&a.a.oa(b,"change")}),a.a.dc(b),k&&20<Math.abs(k-b.scrollTop)&&(b.scrollTop=k)}},a.d.options.Va=a.a.e.F(),a.d.selectedOptions={after:["options","foreach"],init:function(b,d,c){a.a.n(b,"change",function(){var e=d(),g=[];a.a.u(b.getElementsByTagName("option"),function(b){b.selected&&g.push(a.i.q(b))}),a.h.pa(e,c,"selectedOptions",g)})},update:function(b,d){if("select"!=a.a.t(b))throw Error("values binding applies only to SELECT elements");var c=a.a.c(d());c&&"number"==typeof c.length&&a.a.u(b.getElementsByTagName("option"),function(b){var d=0<=a.a.m(c,a.i.q(b));a.a.Nb(b,d)})}},a.h.V.selectedOptions=!0,a.d.style={update:function(b,d){var c=a.a.c(d()||{});a.a.G(c,function(c,d){d=a.a.c(d),(null===d||d===p||!1===d)&&(d=""),b.style[c]=d})}},a.d.submit={init:function(b,d,c,e,g){if("function"!=typeof d())throw Error("The value for a submit binding must be a function");a.a.n(b,"submit",function(a){var c,e=d();try{c=e.call(g.$data,b)}finally{!0!==c&&(a.preventDefault?a.preventDefault():a.returnValue=!1)}})}},a.d.text={init:function(){return{controlsDescendantBindings:!0}},update:function(b,d){a.a.bb(b,d())}},a.f.Q.text=!0,function(){if(s&&s.navigator)var b=function(a){return a?parseFloat(a[1]):void 0},d=s.opera&&s.opera.version&&parseInt(s.opera.version()),c=s.navigator.userAgent,e=b(c.match(/^(?:(?!chrome).)*version\/([^ ]*) safari/i)),g=b(c.match(/Firefox\/([^ ]*)/));if(10>a.a.L)var h=a.a.e.F(),k=a.a.e.F(),f=function(b){var c=this.activeElement;(c=c&&a.a.e.get(c,k))&&c(b)},m=function(b,c){var d=b.ownerDocument;a.a.e.get(d,h)||(a.a.e.set(d,h,!0),a.a.n(d,"selectionchange",f)),a.a.e.set(b,k,c)};a.d.textInput={init:function(b,c,f){function k(c,d){a.a.n(b,c,d)}function h(){var d=a.a.c(c());(null===d||d===p)&&(d=""),v!==p&&d===v?setTimeout(h,4):b.value!==d&&(s=d,b.value=d)}function u(){y||(v=b.value,y=setTimeout(r,4))}function r(){clearTimeout(y),v=y=p;var d=b.value;s!==d&&(s=d,a.h.pa(c(),f,"textInput",d))}var s=b.value,y,v;10>a.a.L?(k("propertychange",function(a){"value"===a.propertyName&&r()}),8==a.a.L&&(k("keyup",r),k("keydown",r)),8<=a.a.L&&(m(b,r),k("dragend",u))):(k("input",r),5>e&&"textarea"===a.a.t(b)?(k("keydown",u),k("paste",u),k("cut",u)):11>d?k("keydown",u):4>g&&(k("DOMAutoComplete",r),k("dragdrop",r),k("drop",r))),k("change",r),a.s(h,null,{o:b})}},a.h.V.textInput=!0,a.d.textinput={preprocess:function(a,b,c){c("textInput",a)}}}(),a.d.uniqueName={init:function(b,d){if(d()){var c="ko_unique_"+ ++a.d.uniqueName.Zb;a.a.Mb(b,c)}}},a.d.uniqueName.Zb=0,a.d.value={after:["options","foreach"],init:function(b,d,c){if("input"!=b.tagName.toLowerCase()||"checkbox"!=b.type&&"radio"!=b.type){var e=["change"],g=c.get("valueUpdate"),h=!1,k=null;g&&("string"==typeof g&&(g=[g]),a.a.ga(e,g),e=a.a.rb(e));var f=function(){k=null,h=!1;var e=d(),f=a.i.q(b);a.h.pa(e,c,"value",f)};!a.a.L||"input"!=b.tagName.toLowerCase()||"text"!=b.type||"off"==b.autocomplete||b.form&&"off"==b.form.autocomplete||-1!=a.a.m(e,"propertychange")||(a.a.n(b,"propertychange",function(){h=!0}),a.a.n(b,"focus",function(){h=!1}),a.a.n(b,"blur",function(){h&&f()})),a.a.u(e,function(c){var d=f;a.a.vc(c,"after")&&(d=function(){k=a.i.q(b),setTimeout(f,0)},c=c.substring(5)),a.a.n(b,c,d)});var m=function(){var e=a.a.c(d()),f=a.i.q(b);if(null!==k&&e===k)setTimeout(m,0);else if(e!==f)if("select"===a.a.t(b)){var g=c.get("valueAllowUnset"),f=function(){a.i.ca(b,e,g)};f(),g||e===a.i.q(b)?setTimeout(f,0):a.k.B(a.a.oa,null,[b,"change"])}else a.i.ca(b,e)};a.s(m,null,{o:b})}else a.ra(b,{checkedValue:d})},update:function(){}},a.h.V.value=!0,a.d.visible={update:function(b,d){var c=a.a.c(d()),e="none"!=b.style.display;c&&!e?b.style.display="":!c&&e&&(b.style.display="none")}},function(b){a.d[b]={init:function(d,c,e,g,h){return a.d.event.init.call(this,d,function(){var a={};return a[b]=c(),a},e,g,h)}}}("click"),a.H=function(){},a.H.prototype.renderTemplateSource=function(){throw Error("Override renderTemplateSource")},a.H.prototype.createJavaScriptEvaluatorBlock=function(){throw Error("Override createJavaScriptEvaluatorBlock")},a.H.prototype.makeTemplateSource=function(b,d){if("string"==typeof b){d=d||v;var c=d.getElementById(b);if(!c)throw Error("Cannot find template with ID "+b);return new a.r.l(c)}if(1==b.nodeType||8==b.nodeType)return new a.r.fa(b);throw Error("Unknown template type: "+b)},a.H.prototype.renderTemplate=function(a,d,c,e){return a=this.makeTemplateSource(a,e),this.renderTemplateSource(a,d,c)},a.H.prototype.isTemplateRewritten=function(a,d){return!1===this.allowTemplateRewriting?!0:this.makeTemplateSource(a,d).data("isRewritten")},a.H.prototype.rewriteTemplate=function(a,d,c){a=this.makeTemplateSource(a,c),d=d(a.text()),a.text(d),a.data("isRewritten",!0)},a.b("templateEngine",a.H),a.fb=function(){function b(b,c,d,k){b=a.h.Wa(b);for(var f=a.h.ha,m=0;m<b.length;m++){var l=b[m].key;if(f.hasOwnProperty(l)){var q=f[l];if("function"==typeof q){if(l=q(b[m].value))throw Error(l)}else if(!q)throw Error("This template engine does not support the '"+l+"' binding within its templates")}}return d="ko.__tr_ambtns(function($context,$element){return(function(){return{ "+a.h.ya(b,{valueAccessors:!0})+" } })()},'"+d.toLowerCase()+"')",k.createJavaScriptEvaluatorBlock(d)+c}var d=/(<([a-z]+\d*)(?:\s+(?!data-bind\s*=\s*)[a-z0-9\-]+(?:=(?:\"[^\"]*\"|\'[^\']*\'))?)*\s+)data-bind\s*=\s*(["'])([\s\S]*?)\3/gi,c=/\x3c!--\s*ko\b\s*([\s\S]*?)\s*--\x3e/g;return{ec:function(b,c,d){c.isTemplateRewritten(b,d)||c.rewriteTemplate(b,function(b){return a.fb.nc(b,c)},d)},nc:function(a,g){return a.replace(d,function(a,c,d,e,l){return b(l,c,d,g)}).replace(c,function(a,c){return b(c,"<!-- ko -->","#comment",g)})},Xb:function(b,c){return a.D.Ua(function(d,k){var f=d.nextSibling;f&&f.nodeName.toLowerCase()===c&&a.ra(f,b,k)})}}}(),a.b("__tr_ambtns",a.fb.Xb),function(){a.r={},a.r.l=function(a){this.l=a},a.r.l.prototype.text=function(){var b=a.a.t(this.l),b="script"===b?"text":"textarea"===b?"value":"innerHTML";if(0==arguments.length)return this.l[b];var d=arguments[0];"innerHTML"===b?a.a.$a(this.l,d):this.l[b]=d};var b=a.a.e.F()+"_";a.r.l.prototype.data=function(c){return 1===arguments.length?a.a.e.get(this.l,b+c):void a.a.e.set(this.l,b+c,arguments[1])};var d=a.a.e.F();a.r.fa=function(a){this.l=a},a.r.fa.prototype=new a.r.l,a.r.fa.prototype.text=function(){if(0==arguments.length){var b=a.a.e.get(this.l,d)||{};return b.gb===p&&b.Ga&&(b.gb=b.Ga.innerHTML),b.gb}a.a.e.set(this.l,d,{gb:arguments[0]})},a.r.l.prototype.nodes=function(){return 0==arguments.length?(a.a.e.get(this.l,d)||{}).Ga:void a.a.e.set(this.l,d,{Ga:arguments[0]})},a.b("templateSources",a.r),a.b("templateSources.domElement",a.r.l),a.b("templateSources.anonymousTemplate",a.r.fa)}(),function(){function b(b,c,d){var e;for(c=a.f.nextSibling(c);b&&(e=b)!==c;)b=a.f.nextSibling(e),d(e,b)}function d(c,d){if(c.length){var e=c[0],g=c[c.length-1],h=e.parentNode,n=a.J.instance,t=n.preprocessNode;if(t){if(b(e,g,function(a,b){var c=a.previousSibling,d=t.call(n,a);d&&(a===e&&(e=d[0]||b),a===g&&(g=d[d.length-1]||c))}),c.length=0,!e)return;e===g?c.push(e):(c.push(e,g),a.a.ka(c,h))}b(e,g,function(b){1!==b.nodeType&&8!==b.nodeType||a.pb(d,b)}),b(e,g,function(b){1!==b.nodeType&&8!==b.nodeType||a.D.Sb(b,[d])}),a.a.ka(c,h)}}function c(a){return a.nodeType?a:0<a.length?a[0]:null}function e(b,e,h,l,q){q=q||{};var n=b&&c(b),n=n&&n.ownerDocument,t=q.templateEngine||g;if(a.fb.ec(h,t,n),h=t.renderTemplate(h,l,q,n),"number"!=typeof h.length||0<h.length&&"number"!=typeof h[0].nodeType)throw Error("Template engine must return an array of DOM nodes");switch(n=!1,e){case"replaceChildren":a.f.T(b,h),n=!0;break;case"replaceNode":a.a.Lb(b,h),n=!0;break;case"ignoreTargetNode":break;default:throw Error("Unknown renderMode: "+e)}return n&&(d(h,l),q.afterRender&&a.k.B(q.afterRender,null,[h,l.$data])),h}var g;a.ab=function(b){if(b!=p&&!(b instanceof a.H))throw Error("templateEngine must inherit from ko.templateEngine");g=b},a.Ya=function(b,d,h,l,q){if(h=h||{},(h.templateEngine||g)==p)throw Error("Set a template engine before calling renderTemplate");if(q=q||"replaceChildren",l){var n=c(l);return a.j(function(){var g=d&&d instanceof a.N?d:new a.N(a.a.c(d)),p=a.C(b)?b():"function"==typeof b?b(g.$data,g):b,g=e(l,q,p,g,h);"replaceNode"==q&&(l=g,n=c(l))},null,{Ia:function(){return!n||!a.a.Ja(n)},o:n&&"replaceNode"==q?n.parentNode:n})}return a.D.Ua(function(c){a.Ya(b,d,h,c,"replaceNode")})},a.uc=function(b,c,g,h,q){function n(a,b){d(b,s),g.afterRender&&g.afterRender(b,a)}function t(c,d){s=q.createChildContext(c,g.as,function(a){a.$index=d});var f=a.C(b)?b():"function"==typeof b?b(c,s):b;return e(null,"ignoreTargetNode",f,s,g)}var s;return a.j(function(){var b=a.a.c(c)||[];"undefined"==typeof b.length&&(b=[b]),b=a.a.ta(b,function(b){return g.includeDestroyed||b===p||null===b||!a.a.c(b._destroy)}),a.k.B(a.a.Za,null,[h,b,t,g,n])},null,{o:h})};var h=a.a.e.F();a.d.template={init:function(b,c){var d=a.a.c(c());return"string"==typeof d||d.name?a.f.ja(b):(d=a.f.childNodes(b),d=a.a.oc(d),new a.r.fa(b).nodes(d)),{controlsDescendantBindings:!0}},update:function(b,c,d,e,g){var n=c(),t;c=a.a.c(n),d=!0,e=null,"string"==typeof c?c={}:(n=c.name,"if"in c&&(d=a.a.c(c["if"])),d&&"ifnot"in c&&(d=!a.a.c(c.ifnot)),t=a.a.c(c.data)),"foreach"in c?e=a.uc(n||b,d&&c.foreach||[],c,b,g):d?(g="data"in c?g.createChildContext(t,c.as):g,e=a.Ya(n||b,g,c,b)):a.f.ja(b),g=e,(t=a.a.e.get(b,h))&&"function"==typeof t.K&&t.K(),a.a.e.set(b,h,g&&g.Z()?g:p)}},a.h.ha.template=function(b){return b=a.h.Wa(b),1==b.length&&b[0].unknown||a.h.lc(b,"name")?null:"This template engine does not support anonymous templates nested within its templates"},a.f.Q.template=!0}(),a.b("setTemplateEngine",a.ab),a.b("renderTemplate",a.Ya),a.a.wb=function(a,d,c){if(a.length&&d.length){var e,g,h,k,f;for(e=g=0;(!c||c>e)&&(k=a[g]);++g){for(h=0;f=d[h];++h)if(k.value===f.value){k.moved=f.index,f.moved=k.index,d.splice(h,1),e=h=0;break}e+=h}}},a.a.Fa=function(){function b(b,c,e,g,h){var k=Math.min,f=Math.max,m=[],l,q=b.length,n,p=c.length,s=p-q||1,u=q+p+1,r,v,w;for(l=0;q>=l;l++)for(v=r,m.push(r=[]),w=k(p,l+s),n=f(0,l-1);w>=n;n++)r[n]=n?l?b[l-1]===c[n-1]?v[n-1]:k(v[n]||u,r[n-1]||u)+1:n+1:l+1;for(k=[],f=[],s=[],l=q,n=p;l||n;)p=m[l][n]-1,n&&p===m[l][n-1]?f.push(k[k.length]={status:e,value:c[--n],index:n}):l&&p===m[l-1][n]?s.push(k[k.length]={status:g,value:b[--l],index:l}):(--n,--l,h.sparse||k.push({status:"retained",value:c[n]}));return a.a.wb(f,s,10*q),k.reverse()}return function(a,c,e){return e="boolean"==typeof e?{dontLimitMoves:e}:e||{},a=a||[],c=c||[],a.length<=c.length?b(a,c,"added","deleted",e):b(c,a,"deleted","added",e)}}(),a.b("utils.compareArrays",a.a.Fa),function(){function b(b,d,g,h,k){var f=[],m=a.j(function(){var l=d(g,k,a.a.ka(f,b))||[];0<f.length&&(a.a.Lb(f,l),h&&a.k.B(h,null,[g,l,k])),f.length=0,a.a.ga(f,l)},null,{o:b,Ia:function(){return!a.a.ob(f)}});return{$:f,j:m.Z()?m:p}}var d=a.a.e.F();a.a.Za=function(c,e,g,h,k){function f(b,d){x=q[d],r!==d&&(A[b]=x),x.Na(r++),a.a.ka(x.$,c),s.push(x),w.push(x)}function m(b,c){if(b)for(var d=0,e=c.length;e>d;d++)c[d]&&a.a.u(c[d].$,function(a){b(a,d,c[d].sa)})}e=e||[],h=h||{};var l=a.a.e.get(c,d)===p,q=a.a.e.get(c,d)||[],n=a.a.Da(q,function(a){return a.sa}),t=a.a.Fa(n,e,h.dontLimitMoves),s=[],u=0,r=0,v=[],w=[];e=[];for(var A=[],n=[],x,B=0,D,F;D=t[B];B++)switch(F=D.moved,D.status){case"deleted":F===p&&(x=q[u],x.j&&x.j.K(),v.push.apply(v,a.a.ka(x.$,c)),h.beforeRemove&&(e[B]=x,w.push(x))),u++;break;case"retained":f(B,u++);break;case"added":F!==p?f(B,F):(x={sa:D.value,Na:a.p(r++)},s.push(x),w.push(x),l||(n[B]=x))}m(h.beforeMove,A),a.a.u(v,h.beforeRemove?a.R:a.removeNode);for(var B=0,l=a.f.firstChild(c),G;x=w[B];B++){for(x.$||a.a.extend(x,b(c,g,x.sa,k,x.Na)),u=0;t=x.$[u];l=t.nextSibling,G=t,u++)t!==l&&a.f.Bb(c,t,G);!x.ic&&k&&(k(x.sa,x.$,x.Na),x.ic=!0)}m(h.beforeRemove,e),m(h.afterMove,A),m(h.afterAdd,n),a.a.e.set(c,d,s)}}(),a.b("utils.setDomNodeChildrenFromArrayMapping",a.a.Za),a.O=function(){this.allowTemplateRewriting=!1},a.O.prototype=new a.H,a.O.prototype.renderTemplateSource=function(b){var d=(9>a.a.L?0:b.nodes)?b.nodes():null;return d?a.a.S(d.cloneNode(!0).childNodes):(b=b.text(),a.a.ba(b))},a.O.Oa=new a.O,a.ab(a.O.Oa),a.b("nativeTemplateEngine",a.O),function(){a.Sa=function(){var a=this.kc=function(){if(!w||!w.tmpl)return 0;try{if(0<=w.tmpl.tag.tmpl.open.toString().indexOf("__"))return 2}catch(a){}return 1}();this.renderTemplateSource=function(b,e,g){if(g=g||{},2>a)throw Error("Your version of jQuery.tmpl is too old. Please upgrade to jQuery.tmpl 1.0.0pre or later.");var h=b.data("precompiled");return h||(h=b.text()||"",h=w.template(null,"{{ko_with $item.koBindingContext}}"+h+"{{/ko_with}}"),b.data("precompiled",h)),b=[e.$data],e=w.extend({koBindingContext:e},g.templateOptions),e=w.tmpl(h,b,e),e.appendTo(v.createElement("div")),w.fragments={},e},this.createJavaScriptEvaluatorBlock=function(a){return"{{ko_code ((function() { return "+a+" })()) }}"},this.addTemplate=function(a,b){v.write("<script type='text/html' id='"+a+"'>"+b+"</script>")},a>0&&(w.tmpl.tag.ko_code={open:"__.push($1 || '');"},w.tmpl.tag.ko_with={open:"with($1) {",close:"} "})},a.Sa.prototype=new a.H;var b=new a.Sa;0<b.kc&&a.ab(b),a.b("jqueryTmplTemplateEngine",a.Sa)}()})}()}(),define("util",[],function(){function setURLPart(part,str){part===URLPart.Search?window.location.search=str:part===URLPart.Hash&&(window.location.hash=str)}function getStringForPart(part){return part===URLPart.Search?window.location.search:part===URLPart.Hash?window.location.hash:void 0}function getURLPartForParam(param){return URLParamMap[param]}function dummyStorageGetFn(){}var self={};window.URLPart={Search:1,Hash:2};var URLParamMap={demo:URLPart.Hash,login:URLPart.Hash,user:URLPart.Hash,access_token:URLPart.Hash,error:URLPart.Hash,expires_in:URLPart.Hash,scope:URLPart.Hash,token_type:URLPart.Hash,data:URLPart.Hash,script:URLPart.Hash,dmode:URLPart.Hash,jasmine:URLPart.Hash,touch:URLPart.Hash,file:URLPart.Hash,panes:URLPart.Hash,offline:URLPart.Hash,live:URLPart.Hash,test:URLPart.Hash,nolocal:URLPart.Hash,nosync:URLPart.Hash,rdebug:URLPart.Hash,rsession:URLPart.Hash,cacheError:URLPart.Hash,state:URLPart.Search};self.hasURLParam=function hasURLParamFn(key,value){var str=key+"=";value&&(str+=value);var part=getURLPartForParam(key);part||log("Invalid URL Part");var rawString=getStringForPart(part);return rawString.indexOf(str)>=0},self.getURLParam=function getURLParamFn(key,forcePart){var part=forcePart?forcePart:getURLPartForParam(key);if(part===URLPart.Search){key=key.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+key+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(window.location.href);return null===results?void 0:decodeURIComponent(results[1].replace(/\+/g," "))}if(part===URLPart.Hash){for(var queryString=window.location.hash.substring(1),regex=/([^&=]+)=([^&]*)/g,m;m=regex.exec(queryString);)if(decodeURIComponent(m[1])===key)return decodeURIComponent(m[2]);return void 0}log("Invalid URL part")},self.insertURLParam=function insertURLParamFn(key,value,noReload){key=encodeURIComponent(key),value=encodeURIComponent(value);
for(var part=getURLPartForParam(key),rawString=getStringForPart(part),params=rawString.substr(1).split("&"),i=params.length-1;i>=0;i--){var param=params[i].split("=");if(param[0]==key){param[1]=value,params[i]=param.join("=");break}}0>i&&(params[params.length]=[key,value].join("=")),setURLPart(part,params.join("&")),part!==URLPart.Hash||noReload||window.location.reload()},self.removeURLParam=function removeURLParamFn(key,noReload){key=encodeURIComponent(key);for(var part=getURLPartForParam(key),rawString=getStringForPart(part),params=rawString.substr(1).split("&"),i=params.length-1;i>=0;i--){var param=params[i].split("=");if(param[0]==key){params.splice(i,1);break}}setURLPart(part,params.join("&")),part!==URLPart.Hash||noReload||window.location.reload()};var __bindMap;self.forceBind=function forceBindFn(fnName,obj){var hasEntry,bindFn=obj[fnName].bind(obj);return obj[fnName]=bindFn,bindFn},self.destroy=function destroyFn(obj){},self.extend=function extendFn(target,source){if(source)for(var prop in source)source.hasOwnProperty(prop)&&(target[prop]=source[prop]);return target},self.inherit=function inheritFn(base,sub){sub.prototype=Object.create(base.prototype),sub.prototype.constructor=sub,sub.prototype._super=base.prototype},self.defineBase=function defineBaseFn(base){base.prototype.constructor=base};var dummyStorage={getItem:function(){},setItem:function(){},removeItem:function(){}};try{self.__storage=window.localStorage||dummyStorage}catch(err){self.__storage=dummyStorage}return self.storage={getItem:(self.__storage.getItem||function(key,cb){return this.get(key,cb||dummyStorageGetFn)}).bind(self.__storage),setItem:(self.__storage.setItem||function(key,value){var obj={};obj[key]=value,self.__storage.set(obj)}).bind(self.__storage),removeItem:(self.__storage.removeItem||function(key,cb){this.remove(key,cb)}).bind(self.__storage)},self}),define("platform",["ko","util"],function(ko,util){function platform(){this.versionRequired=[],this.versionRequired[AppPlatform.iOS]=4,this.versionRequired[AppPlatform.Android]=4,this.versionRequired[AppPlatform.WinPhone]=1,this.versionRequired[AppPlatform.Chrome]=1,this.versionMobile=1,this.versionDesktop=3,this.versionMobileMessages={1:"New features: Tap the right edge of an item to complete it. Tap the left edge of a list to collapse its items."},this.versionDesktopMessages={1:"New features: Click the right edge of an item to complete it. Click the left edge of a list to collapse its items. See our blog for more details.",2:"Update: Hotkeys have been changed. See the Help for the list of hotkeys.",3:"Update: Documents have been moved to the folder menu in the top left and options have been moved to the cog menu in the top right."},this.setDeployEnvironments(),this.appStoreLinks=[],this.appStoreLinks[AppPlatform.iOS]="https://itunes.apple.com/us/app/moo.do-organize-your-way/id889830074?ls=1&mt=8",this.appStoreLinks[AppPlatform.Android]="https://play.google.com/store/apps/details?id=moo.do",this.appStoreLinks[AppPlatform.WinPhone]=void 0,this.appStoreLinks[AppPlatform.Chrome]="https://chrome.google.com/webstore/detail/moodo/iffimmolghilclfndeiebgppddmagofk",this.appReviewLinks=[],this.appReviewLinks[AppPlatform.iOS]=void 0,this.appReviewLinks[AppPlatform.Android]=void 0,this.appReviewLinks[AppPlatform.WinPhone]=void 0,this.appReviewLinks[AppPlatform.Chrome]=void 0,this.appPlatform=void 0,this.appStoreLink=void 0,this.appReviewLink=void 0,this.requireCustomRedirect=!1,this.b=document.documentElement,this.orientation=Orientation.Portrait,this.windowWidth=ko.observable(0),this.windowHeight=ko.observable(0),this.kbsize=void 0,this.kbsizePortrait=void 0,this.kbsizeLandscape=void 0,this.hasBeenPortrait=!1,this.appState=void 0,this.forceNotifications=void 0,this.isHosted=!1,this.hostedBy=void 0,this.pageVisibilityHidden=void 0,this.pageVisibilityChange=void 0,this.isPhantom=!1,this.isDevURL="dev.moo.do"===window.location.hostname||"beta.moo.do"===window.location.hostname,this.init();var useLocationHost=!1||this.isDevURL||this.app&&this.debugApp||!this.app&&this.standalone;this.customRedirectString=window.location.protocol+"//"+(useLocationHost?window.location.host:"www.moo.do")+"/app/",this.app&&(this.customRedirectState={app:!0,appv:this.versionRequired[this.appPlatform],webview:this.appState&&this.appState.webview}),this.keyboardOpenTime=this.app||this.android?200:this.winphone?200:this.mobileie?600:0}return window.Orientation={Portrait:0,Landscape:1},window.PlatformConfig={DesktopWindows:0,DesktopMac:1,DesktopOther:2,ChromeApp:3,AndroidBrowser:4,AndroidApp:5,iOSBrowser:6,iOSApp:7,WinPhoneBrowser:8,WinPhoneApp:9,MobileOther:10,Unknown:11},window.AppPlatform={iOS:0,Android:1,WinPhone:2,Chrome:3},window.DeployVariable={Environment:"Environment",APIHost:"APIHost",APIProtocol:"APIProtocol"},platform.prototype={getDeployVar:function getDeployVarFn(key){return this.deployEnvironment[key]},setDeployEnvironments:function setDeployEnvironmentsFn(){this.deployEnvironment={},"dev.moo.do"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="dev",this.deployEnvironment[DeployVariable.APIProtocol]="http:",this.deployEnvironment[DeployVariable.APIHost]="//api-dev.moo.do"):"beta.moo.do"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="beta",this.deployEnvironment[DeployVariable.APIProtocol]="http:",this.deployEnvironment[DeployVariable.APIHost]="//api-beta.moo.do"):"localhost"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="local",this.deployEnvironment[DeployVariable.APIProtocol]="http:",this.deployEnvironment[DeployVariable.APIHost]="//localhost:9024"):(this.deployEnvironment[DeployVariable.Environment]="production",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api.moo.do")},getKBTop:function getKBTopFn(){return!this.app&&this.android?0:this.getKBSize()},getKBSize:function getKBSizeFn(){return this.kbsize?this.kbsize:Math.ceil(window.innerHeight/2)},setKBSize:function setKBSizeFn(size){this.kbsize=parseInt(size)},getLocaleInfo:function getLocaleInfoFn(obj){try{obj.lang=navigator.language||navigator.userLanguage}catch(err){obj.lang="EXCEPTION"}},getPlatformInfo:function getPlatformInfoFn(obj){obj.os=this.OSName,obj.browser=this.browser,obj.majorVersion=this.majorVersion,obj.minorVersion=this.minorVersion,obj.appVersionRequired=this.versionRequired[this.appPlatform],obj.app=this.app,obj.appPlatform=this.appPlatform,obj.standalone=this.standalone,obj.packagedApp=this.packagedApp,obj.requireCustomRedirect=this.requireCustomRedirect,obj.isMobile=this.mobile,obj.isMobileBrowser=this.isMobileBrowser,obj.isPhone=this.phone,obj.isTouch=this.touch,obj.isTouchDevice=this.isTouchDevice,obj.usePointerEvents=this.usePointerEvents,obj.kbsize=this.kbsize,obj.appState=this.appState,obj.isHosted=this.isHosted,obj.hostedBy=this.hostedBy,obj.bodyClass=this.b.className,obj.rawUA=navigator.userAgent,obj.referrer=document.referrer,this.getLocaleInfo(obj)},getUserPlatformConfig:function getUserPlatformConfigFn(obj){var pConfig=PlatformConfig.Unknown;if(this.app)switch(this.appPlatform){case AppPlatform.iOS:pConfig=PlatformConfig.iOSApp;break;case AppPlatform.Android:pConfig=PlatformConfig.AndroidApp;break;case AppPlatform.WinPhone:pConfig=PlatformConfig.WinPhoneApp;break;case AppPlatform.Chrome:pConfig=PlatformConfig.ChromeApp}else switch(this.OSName){case"Windows":pConfig=this.phone?PlatformConfig.WinPhoneBrowser:PlatformConfig.DesktopWindows;break;case"iPad":case"iPod":case"iPhone":pConfig=PlatformConfig.iOSBrowser;break;case"MacOS":pConfig=PlatformConfig.DesktopMac;break;case"Android":pConfig=PlatformConfig.AndroidBrowser;break;case"Linux":default:pConfig=this.phone?PlatformConfig.MobileOther:PlatformConfig.DesktopOther}obj.platformConfig=pConfig},init:function initFn(){this.initAppState(),this.initHostState();var userAgent=navigator.userAgent,bodyClass="";if(this.OSName="Unknown OS",this.app&&(bodyClass+=" app"),-1!==userAgent.indexOf("Win")?(this.OSName="Windows",this.windows=!0,-1!==userAgent.indexOf("Windows Phone")&&(this.phone=!0,this.touch=!0,this.mobile=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.WinPhone],this.app&&(this.appPlatform=AppPlatform.WinPhone))):-1!==userAgent.indexOf("iPad")?(this.OSName="iPad",this.ios=!0,this.ipad=!0,this.phone=!0,this.touch=!0,this.mobile=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("iPhone")?(this.OSName="iPhone",this.ios=!0,this.iphone=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("iPod")?(this.OSName="iPod",this.ios=!0,this.ipod=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("Mac")?(this.OSName="MacOS",this.mac=!0):-1!==userAgent.indexOf("X11")?(this.OSName="UNIX",this.unix=!0):-1!==userAgent.indexOf("Android")?(this.OSName="Android",this.android=!0,this.touch=!0,this.mobile=!0,this.phone=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.Android],this.app&&(this.appPlatform=AppPlatform.Android),bodyClass+=" android"):-1!==userAgent.indexOf("Linux")&&(this.OSName="Linux",this.linux=!0),this.ios){this.ios7=-1!==userAgent.indexOf("OS 7"),this.ios70=-1!==userAgent.indexOf("OS 7_0"),this.ios71=-1!==userAgent.indexOf("OS 7_1");var webview=this.appState&&this.appState.webview;"ioswk"===webview?this.ioswk=!0:this.iosui=!0,this.ios7&&(bodyClass+=" ios7")}if(this.majorVersion=1e3,this.minorVersion=1e3,-1!==userAgent.indexOf("MSIE")||-1!==userAgent.indexOf("Trident")){this.browser="Trident",this.ie=!0,this.winphone=!!userAgent.match(/IEMobile/i);var re;if(re=new RegExp(this.winphone||"Microsoft Internet Explorer"===navigator.appName?"MSIE ([0-9]{1,}[.0-9]{0,})":"Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),null!==re.exec(userAgent))this.majorVersion=parseFloat(RegExp.$1);else{var take2=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})");null!==take2.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}}else if(-1!==userAgent.indexOf("Chrome")||-1!==userAgent.indexOf("CriOS")){this.browser="Chrome",this.isChrome=!0;var re=new RegExp("Chrome/([0-9]{1,}).");null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1)),this.app&&this.appPlatform!==AppPlatform.Android&&(this.appPlatform=AppPlatform.Chrome)}else if(-1!==userAgent.indexOf("Android")){this.browser="Native Android";var re=new RegExp("Linux; Android ([0-9]{1,}).([0-9]{1,}).");null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else if(-1!==userAgent.indexOf("Firefox")){this.browser="Firefox",this.isFirefox=!0;var re=new RegExp("Firefox/([0-9]{1,}).");null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}else if(-1!==userAgent.indexOf("Safari")||"iPad"===this.OSName||"iPhone"===this.OSName||"iPod"===this.OSName){this.browser="Safari";var re;re=new RegExp(this.mobile?"OS ([0-9]{1,})_([0-9]{1,})":"Version/([0-9]{1,}).([0-9]{1,})."),null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else-1!==userAgent.indexOf("Opera")&&(this.browser="Opera");this.appReviewLink=this.appReviewLinks[this.appPlatform],this.isTouchDevice=!!("ontouchstart"in window||window.navigator.msMaxTouchPoints),this.isMobileBrowser=this.checkMobileBrowser(),this.usePointerEvents=!!window.navigator.msPointerEnabled,this.isTouchDevice&&this.isMobileBrowser&&(this.usePointerEvents?(this.touchStartEvent="MSPointerDown",this.touchMoveEvent="MSPointerMove",this.touchEndEvent="MSPointerUp",this.touchCancelEvent="MSPointerCancel"):(this.touchStartEvent="touchstart",this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",this.touchCancelEvent="touchcancel")),this.usePointerEvents?(this.downEvent="MSPointerDown",this.moveEvent="MSPointerMove",this.upEvent="MSPointerUp"):(this.downEvent="mousedown",this.moveEvent="mousemove",this.upEvent="mouseup"),util.hasURLParam("touch","false")?(this.touch=!1,this.phone=!1,this.mobile=!1,this.ios=!1,this.android=!1):(this.isTouchDevice&&this.isMobileBrowser||util.hasURLParam("touch","true"))&&(this.touch=!0,this.phone=!0,this.mobile=!0),this.windows&&(bodyClass+=" windows",this.ie?(bodyClass+=" ie",this.demo||(this.mobro=this.isMobro())):"Firefox"===this.browser&&(bodyClass+=" firefox")),this.phone&&(bodyClass+=" phone"),this.ipad&&(bodyClass+=" ipad"),"mailbird"===this.embed&&(bodyClass+=" mailbird"),this.demo&&(bodyClass+=" demoMode"),this.mobileie=this.ie&&this.mobile,this.mobile&&!this.app&&this.calcKeyboardSize(),this.isChrome&&this.app&&(this.isPackagedApp=!0),this.cmdChar=this.mac?"⌘":"ctrl",this.priModKey=this.mac?"⌘":"Ctrl",this.secModKey=this.app?this.priModKey:this.mac?"Ctrl":"Alt",this.noErrorStacks="iPad"===platform.OSName||"iPhone"===platform.OSName||"iPod"===platform.OSName,this.standalone=!!window.navigator.standalone||window.navigator.userAgent.indexOf("FluidApp")>=0,(this.standalone||this.app||this.mobro)&&(this.requireCustomRedirect=!0),bodyClass&&bodyClass.length>0&&(this.b.className+=bodyClass),this.transition=this.addPrefix("transition"),this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin"),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)},this.ie&&(document.documentElement.addEventListener("MSHoldVisual",function(e){e.preventDefault()},!1),document.documentElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1)),document.documentElement.addEventListener("keydown",this.normalizeKeys,!0),document.documentElement.addEventListener("keypress",this.normalizeKeys,!0),document.documentElement.addEventListener("keyup",this.normalizeKeys,!0),document.documentElement.addEventListener(this.downEvent,this.normalizeMouse,!0),document.documentElement.addEventListener(this.moveEvent,this.normalizeMouse,!0),document.documentElement.addEventListener(this.upEvent,this.normalizeMouse,!0);var hidden,visibilitychange;"undefined"!=typeof document.hidden?(hidden="hidden",visibilitychange="visibilitychange"):["moz","ms","webkit"].forEach(function(v){return"undefined"!==document[v+"Hidden"]?(hidden=v+"Hidden",visibilitychange=v+"visibilitychange",!1):void 0}),void 0!==hidden&&(this.pageVisibilityHidden=hidden,this.pageVisibilityChange=visibilitychange)},forceEnableNotifications:function forceEnableNotificationsFn(){this.forceNotifications=!0},forceDisableNotifications:function forceDisableNotificationsFn(){this.forceNotifications=!1},supportsNotifications:function supportsNotificationsFn(){return this.forceNotifications===!0||this.forceNotifications!==!1&&(this.ios||this.android||this.isChrome)&&this.app},isMobro:function isMobroFn(){var supported=null,errorName;try{new ActiveXObject("")}catch(e){errorName=e.name}try{supported=!!new ActiveXObject("htmlfile")}catch(e){supported=!1}return supported="ReferenceError"!==errorName&&supported===!1?!1:!0,!supported},calcKeyboardSize:function calcKeyboardSizeFn(){this.ios?this.iphone||this.ipod?(this.kbsizePortrait=216,this.kbsizeLandscape=162,this.ios71&&(this.kbsizePortrait+=44,this.kbsizeLandscape+=44)):this.ipad&&(this.kbsizePortrait=264,this.kbsizeLandscape=352,this.kbsizePortrait+=44,this.kbsizeLandscape+=44):this.android?(this.kbsizePortrait=Math.ceil(window.innerHeight/2.5),this.kbsizeLandscape=Math.ceil(window.innerWidth/2)):this.mobileie&&(this.kbsizePortrait=226,this.kbsizeLandscape=200)},normalizeKeys:function normalizeKeysFn(ev){void 0===ev.normCode&&(ev.normCode=null===ev.keyCode||0===ev.keyCode?null!==ev.charCode?ev.charCode:ev.which:ev.keyCode,46===ev.normCode&&"keypress"===ev.type&&(ev.normCode=190))},normalizeMouse:function normalizeMouseFn(ev){ev.hasOwnProperty("srcElement")||(ev.srcElement=ev.target)},initAppState:function initAppStateFn(){var appState=location.hash.substring(1);if(appState)for(var regex=/([^&=]+)=([^&]*)/g,m;null!==(m=regex.exec(appState));)if("state"===decodeURIComponent(m[1])){var uri=decodeURIComponent(m[2]);if(uri){try{appState=JSON.parse(uri)}catch(err){log("Error parsing AppState: ",uri),appState=void 0}appState&&(this.app=appState.app===!0,this.appv=appState.appv,this.debugApp=appState.debug,this.live=appState.live,this.offline=appState.offline,this.syncContacts=appState.syncContacts,this.test=appState.test,this.embed=appState.embed,this.appState=appState)}break}this.live=this.live||util.hasURLParam("live","true"),this.test=!1,this.offline=this.offline||this.test||util.hasURLParam("offline","true")||!1,this.demo=util.hasURLParam("demo","true")||!1,this.script=util.hasURLParam("script")},checkMobileBrowser:function checkMobileBrowserFn(){var check=!1;if(!this.embed&&(function(a){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))&&(check=!0)}(navigator.userAgent||navigator.vendor||window.opera),!check)){var mediaQuery="(max-device-width: 620px)";window.matchMedia&&window.matchMedia(mediaQuery).matches&&(check=!0)}return check},initHostState:function initHostStateFn(){try{this.isHosted=window.self!==window.top}catch(e){this.isHosted=!0}this.isHosted&&(this.hostedBy=document.referrer)},addPrefix:function addPrefixFn(p){var prefix="",v=["ms","webkit","moz","o"],s=this.b.style;if("string"==typeof s[p])prefix="";else for(var i=0;i<v.length;i++)if("string"==typeof s["-"+v[i]+"-"+p]){prefix=v[i];break}var styleString=prefix.length>0?p.charAt(0).toUpperCase()+p.slice(1):p;return prefix?{prop:"-"+prefix+"-"+p,style:prefix+styleString}:{prop:p,style:styleString}},blockClient:function blockClientFn(){switch(this.browser){case"Firefox":if(this.majorVersion<16)return{platform:"Firefox",browser:this.browser,update:!0};break;case"Chrome":if(this.majorVersion<26)return{platform:"Chrome",browser:this.browser,update:!0};break;case"Native Android":if(this.majorVersion<4)return{platform:"Native Android",browser:"NativeAndroid",update:!0};break;case"Opera":return{platform:this.browser,browser:this.browser,update:!1};case"Trident":if(this.majorVersion<10)return{platform:"Internet Explorer",browser:this.browser,update:!0};break;case"Safari":if(this.mobile&&this.majorVersion<6)return{platform:"Safari",browser:this.browser,update:!0};if(!this.mobile&&(6===this.majorVersion&&this.minorVersion<1||this.majorVersion<6))return{platform:"Safari",browser:this.browser,update:!0}}if(this.app){if(this.appv<this.versionRequired[this.appPlatform])return log("App Version out of date."),{version:this.versionRequired[this.appPlatform]};if(this.appv>this.versionRequired[this.appPlatform])return log("App is newer than the javascript, forcing an app cache update: "+this.appv+" vs. "+this.versionRequired[this.appPlatform]),{cacheUpdate:!0,error:!1}}if("1425962929343"!==document.body.getAttribute("ver")){var cErr=util.hasURLParam("cacheError");if(require(["globals"],function(g){g.reportError(new Error("VersionMismatch, CacheError: "+cErr)),!cErr&&this.app&&g.nativeBridge.sendToApp("resetCache")}),!cErr)return{cacheUpdate:!0,error:!0}}},actionVerb:function actionVerbFn(){return this.touch?"tap":"click"},actionVerbCaps:function actionVerbCapsFn(){return this.touch?"Tap":"Click"},updateOrientation:function updateOrientationFn(){var orientation=90===Math.abs(window.orientation)?Orientation.Landscape:Orientation.Portrait;return this.orientation===Orientation.Portrait&&(this.hasBeenPortrait=!0),this.orientation=orientation,this.app||(this.kbsize=this.orientation===Orientation.Portrait?this.kbsizePortrait:this.kbsizeLandscape),this.orientation},isPageVisible:function isPageVisibleFn(){return!this.pageVisibilityHidden||!document[this.pageVisibilityHidden]},getUpdateMessages:function getUpdateMessagesFn(prevVersion){for(var ret=[],versionName=this.mobile?"versionMobile":"versionDesktop",i=(prevVersion||0)+1;i<=this[versionName];i++)ret.push(this[versionName+"Messages"][i]);return ret}},new platform}),function(){var $D=Date,lang=Date.CultureStrings?Date.CultureStrings.lang:null,loggedKeys={},getText={getFromKey:function(key,countryCode){var output;return output=Date.CultureStrings&&Date.CultureStrings[countryCode]&&Date.CultureStrings[countryCode][key]?Date.CultureStrings[countryCode][key]:getText.buildFromDefault(key),"/"===key.charAt(0)&&(output=getText.buildFromRegex(key,countryCode)),output},getFromObjectValues:function(obj,countryCode){var key,output={};for(key in obj)obj.hasOwnProperty(key)&&(output[key]=getText.getFromKey(obj[key],countryCode));return output},getFromObjectKeys:function(obj,countryCode){var key,output={};for(key in obj)obj.hasOwnProperty(key)&&(output[getText.getFromKey(key,countryCode)]=obj[key]);return output},getFromArray:function(arr,countryCode){for(var output=[],i=0;i<arr.length;i++)i in arr&&(output[i]=getText.getFromKey(arr[i],countryCode));return output},buildFromDefault:function(key){var output,length,split,last;switch(key){case"name":output="en-US";break;case"englishName":output="English (United States)";break;case"nativeName":output="English (United States)";break;case"twoDigitYearMax":output=2049;break;case"firstDayOfWeek":output=0;break;default:output=key,split=key.split("_"),length=split.length,length>1&&"/"!==key.charAt(0)&&(last=split[length-1].toLowerCase(),("initial"===last||"abbr"===last)&&(output=split[0]))}return output},buildFromRegex:function(key,countryCode){var output;return output=Date.CultureStrings&&Date.CultureStrings[countryCode]&&Date.CultureStrings[countryCode][key]?new RegExp(Date.CultureStrings[countryCode][key],"i"):new RegExp(key.replace(new RegExp("/","g"),""),"i")}},shallowMerge=function(obj1,obj2){for(var attrname in obj2)obj2.hasOwnProperty(attrname)&&(obj1[attrname]=obj2[attrname])},__=function(key,language){var countryCode=language?language:lang;return loggedKeys[key]=key,"object"==typeof key?key instanceof Array?getText.getFromArray(key,countryCode):getText.getFromObjectKeys(key,countryCode):getText.getFromKey(key,countryCode)},buildInfo={buildFromMethodHash:function(obj){var key;for(key in obj)obj.hasOwnProperty(key)&&(obj[key]=buildInfo[obj[key]]());return obj},timeZoneDST:function(){var DST={CHADT:"+1345",NZDT:"+1300",AEDT:"+1100",ACDT:"+1030",AZST:"+0500",IRDT:"+0430",EEST:"+0300",CEST:"+0200",BST:"+0100",PMDT:"-0200",ADT:"-0300",NDT:"-0230",EDT:"-0400",CDT:"-0500",MDT:"-0600",PDT:"-0700",AKDT:"-0800",HADT:"-0900"};return __(DST)},timeZoneStandard:function(){var standard={LINT:"+1400",TOT:"+1300",CHAST:"+1245",NZST:"+1200",NFT:"+1130",SBT:"+1100",AEST:"+1000",ACST:"+0930",JST:"+0900",CWST:"+0845",CT:"+0800",ICT:"+0700",MMT:"+0630",BST:"+0600",NPT:"+0545",IST:"+0530",PKT:"+0500",AFT:"+0430",MSK:"+0400",IRST:"+0330",FET:"+0300",EET:"+0200",CET:"+0100",GMT:"+0000",UTC:"+0000",CVT:"-0100",GST:"-0200",BRT:"-0300",NST:"-0330",AST:"-0400",EST:"-0500",CST:"-0600",MST:"-0700",PST:"-0800",AKST:"-0900",MIT:"-0930",HST:"-1000",SST:"-1100",BIT:"-1200"};return __(standard)},timeZones:function(data){var zone;data.timezones=[];for(zone in data.abbreviatedTimeZoneStandard)data.abbreviatedTimeZoneStandard.hasOwnProperty(zone)&&data.timezones.push({name:zone,offset:data.abbreviatedTimeZoneStandard[zone]});for(zone in data.abbreviatedTimeZoneDST)data.abbreviatedTimeZoneDST.hasOwnProperty(zone)&&data.timezones.push({name:zone,offset:data.abbreviatedTimeZoneDST[zone],dst:!0});return data.timezones},days:function(){return __(["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"])},dayAbbr:function(){return __(["Sun","Mon","Tue","Wed","Thu","Fri","Sat"])},dayShortNames:function(){return __(["Su","Mo","Tu","We","Th","Fr","Sa"])},dayFirstLetters:function(){return __(["S_Sun_Initial","M_Mon_Initial","T_Tues_Initial","W_Wed_Initial","T_Thu_Initial","F_Fri_Initial","S_Sat_Initial"])},months:function(){return __(["January","February","March","April","May","June","July","August","September","October","November","December"])},monthAbbr:function(){return __(["Jan_Abbr","Feb_Abbr","Mar_Abbr","Apr_Abbr","May_Abbr","Jun_Abbr","Jul_Abbr","Aug_Abbr","Sep_Abbr","Oct_Abbr","Nov_Abbr","Dec_Abbr"])},formatPatterns:function(){return getText.getFromObjectValues({shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss",monthDay:"MMMM dd",monthDayShortTime:"MM/dd",monthDayYear:"MM/dd/yy",yearMonth:"MMMM, yyyy"},Date.i18n.currentLanguage())},regex:function(){return getText.getFromObjectValues({thisMorning:"/(this )(morn(ing)?)\\b/",thisEvening:"/(this )(even(ing)?)\\b/",jan:"/jan(uary)?/",feb:"/feb(ruary)?/",mar:"/mar(ch)?/",apr:"/apr(il)?/",may:"/may/",jun:"/jun(e)?/",jul:"/jul(y)?/",aug:"/aug(ust)?/",sep:"/sep(t(ember)?)?/",oct:"/oct(ober)?/",nov:"/nov(ember)?/",dec:"/dec(ember)?/",sun:"/^sun(day)?/",mon:"/^mon(day)?/",tue:"/^tue(s(day)?)?/",wed:"/^wed(nesday)?/",thu:"/^thu(rsday)?/",fri:"/^fri(day)?/",sat:"/^sat(urday)?/",future:"/^next/",past:"/^last|past|prev(ious)?/",yesterday:"/^yesterday/",today:"/^today/",tomorrow:"/^tom(orrow)?/",soon:"/^soon/",later:"/^later/",someday:"/^someday/",now:"/^now/",shortMeridian:"/^(a|p)/",longMeridian:"/^(a\\.?m?\\.?|p\\.?m?\\.?)/",timezone:"/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\\s*(\\+|\\-)\\s*\\d\\d\\d\\d?)|gmt|utc)/",ordinalSuffix:"/^\\s*(st|nd|rd|th)/",timeContext:"/^\\s*(\\:|a(?!u|p)|p)/"},Date.i18n.currentLanguage())}},CultureInfo=function(){var info=getText.getFromObjectValues({name:"name",englishName:"englishName",nativeName:"nativeName",amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:"firstDayOfWeek",twoDigitYearMax:"twoDigitYearMax",dateElementOrder:"mdy"},Date.i18n.currentLanguage()),constructedInfo=buildInfo.buildFromMethodHash({dayNames:"days",abbreviatedDayNames:"dayAbbr",shortestDayNames:"dayShortNames",firstLetterDayNames:"dayFirstLetters",monthNames:"months",abbreviatedMonthNames:"monthAbbr",formatPatterns:"formatPatterns",regexPatterns:"regex",abbreviatedTimeZoneDST:"timeZoneDST",abbreviatedTimeZoneStandard:"timeZoneStandard"});return shallowMerge(info,constructedInfo),buildInfo.timeZones(info),info};$D.i18n={__:function(key,lang){return __(key,lang)},currentLanguage:function(){return lang||"en-US"},setLanguage:function(code,force,cb){if(force||"en-US"===code||Date.CultureStrings&&Date.CultureStrings[code])lang=code,Date.CultureStrings=Date.CultureStrings||{},Date.CultureStrings.lang=code,Date.CultureInfo=new CultureInfo;else if(!Date.CultureStrings||!Date.CultureStrings[code])return!1;$D.Parsing.Normalizer.buildReplaceData(),$D.Grammar&&$D.Grammar.buildGrammarFormats(),cb&&cb()},getLoggedKeys:function(){return loggedKeys},updateCultureInfo:function(){Date.CultureInfo=new CultureInfo}},$D.i18n.updateCultureInfo()}(),function(){var $D=Date,$P=$D.prototype,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)};$D.console="undefined"!=typeof window&&"undefined"!=typeof window.console&&"undefined"!=typeof window.console.log?console:{log:function(){},error:function(){}},$D.Config=$D.Config||{},$D.initOverloads=function(){$D.now?$D._now||($D._now=$D.now):$D._now=function now(){return(new Date).getTime()},$D.now=function(returnObj){return returnObj?$D.present():$D._now()},$P.toISOString||($P.toISOString=function(){return this.getUTCFullYear()+"-"+p(this.getUTCMonth()+1)+"-"+p(this.getUTCDate())+"T"+p(this.getUTCHours())+":"+p(this.getUTCMinutes())+":"+p(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}),void 0===$P._toString&&($P._toString=$P.toString)},$D.initOverloads(),$D.today=function(){return(new Date).clearTime()},$D.present=function(){return new Date},$D.compare=function(date1,date2){if(isNaN(date1)||isNaN(date2))throw new Error(date1+" - "+date2);if(date1 instanceof Date&&date2 instanceof Date)return date2>date1?-1:date1>date2?1:0;throw new TypeError(date1+" - "+date2)},$D.equals=function(date1,date2){return 0===date1.compareTo(date2)},$D.getDayName=function(n){return Date.CultureInfo.dayNames[n]},$D.getDayNumberFromName=function(name){for(var n=Date.CultureInfo.dayNames,m=Date.CultureInfo.abbreviatedDayNames,o=Date.CultureInfo.shortestDayNames,s=name.toLowerCase(),i=0;i<n.length;i++)if(n[i].toLowerCase()===s||m[i].toLowerCase()===s||o[i].toLowerCase()===s)return i;return-1},$D.getMonthNumberFromName=function(name){for(var n=Date.CultureInfo.monthNames,m=Date.CultureInfo.abbreviatedMonthNames,s=name.toLowerCase(),i=0;i<n.length;i++)if(n[i].toLowerCase()===s||m[i].toLowerCase()===s)return i;return-1},$D.getMonthName=function(n){return Date.CultureInfo.monthNames[n]},$D.isLeapYear=function(year){return year%4===0&&year%100!==0||year%400===0},$D.getDaysInMonth=function(year,month){return!month&&$D.validateMonth(year)&&(month=year,year=Date.today().getFullYear()),[31,$D.isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month]},$P.getDaysInMonth=function(){return $D.getDaysInMonth(this.getFullYear(),this.getMonth())},$D.getTimezoneAbbreviation=function(offset,dst){var p,n=dst?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard;for(p in n)if(n.hasOwnProperty(p)&&n[p]===offset)return p;return null},$D.getTimezoneOffset=function(name,dst){var i,a=[],z=Date.CultureInfo.timezones;for(name||(name=(new Date).getTimezone()),i=0;i<z.length;i++)z[i].name===name.toUpperCase()&&a.push(i);if(!z[a[0]])return null;if(1===a.length||!dst)return z[a[0]].offset;for(i=0;i<a.length;i++)if(z[a[i]].dst)return z[a[i]].offset},$D.getQuarter=function(d){d=d||new Date;var q=[1,2,3,4];return q[Math.floor(d.getMonth()/3)]},$D.getDaysLeftInQuarter=function(d){d=d||new Date;var qEnd=new Date(d);return qEnd.setMonth(qEnd.getMonth()+3-qEnd.getMonth()%3,0),Math.floor((qEnd-d)/864e5)},$P.ensureTimeOfDay=function(){0===this.getMilliseconds()&&this.setTime(this.getTime()+1)
};var validate=function(n,min,max,name){if(name=name?name:"Object","undefined"==typeof n)return!1;if("number"!=typeof n)throw new TypeError(n+" is not a Number.");return min>n||n>max?!1:!0};$D.validateMillisecond=function(value){return validate(value,0,999,"millisecond")},$D.validateSecond=function(value){return validate(value,0,59,"second")},$D.validateMinute=function(value){return validate(value,0,59,"minute")},$D.validateHour=function(value){return validate(value,0,23,"hour")},$D.validateDay=function(value,year,month){return void 0===year||null===year||void 0===month||null===month?!1:validate(value,1,$D.getDaysInMonth(year,month),"day")},$D.validateWeek=function(value){return validate(value,0,53,"week")},$D.validateMonth=function(value){return validate(value,0,11,"month")},$D.validateYear=function(value){return validate(value,-271822,275760,"year")},$D.validateTimezone=function(value){var timezones={ACDT:1,ACST:1,ACT:1,ADT:1,AEDT:1,AEST:1,AFT:1,AKDT:1,AKST:1,AMST:1,AMT:1,ART:1,AST:1,AWDT:1,AWST:1,AZOST:1,AZT:1,BDT:1,BIOT:1,BIT:1,BOT:1,BRT:1,BST:1,BTT:1,CAT:1,CCT:1,CDT:1,CEDT:1,CEST:1,CET:1,CHADT:1,CHAST:1,CHOT:1,ChST:1,CHUT:1,CIST:1,CIT:1,CKT:1,CLST:1,CLT:1,COST:1,COT:1,CST:1,CT:1,CVT:1,CWST:1,CXT:1,DAVT:1,DDUT:1,DFT:1,EASST:1,EAST:1,EAT:1,ECT:1,EDT:1,EEDT:1,EEST:1,EET:1,EGST:1,EGT:1,EIT:1,EST:1,FET:1,FJT:1,FKST:1,FKT:1,FNT:1,GALT:1,GAMT:1,GET:1,GFT:1,GILT:1,GIT:1,GMT:1,GST:1,GYT:1,HADT:1,HAEC:1,HAST:1,HKT:1,HMT:1,HOVT:1,HST:1,ICT:1,IDT:1,IOT:1,IRDT:1,IRKT:1,IRST:1,IST:1,JST:1,KGT:1,KOST:1,KRAT:1,KST:1,LHST:1,LINT:1,MAGT:1,MART:1,MAWT:1,MDT:1,MET:1,MEST:1,MHT:1,MIST:1,MIT:1,MMT:1,MSK:1,MST:1,MUT:1,MVT:1,MYT:1,NCT:1,NDT:1,NFT:1,NPT:1,NST:1,NT:1,NUT:1,NZDT:1,NZST:1,OMST:1,ORAT:1,PDT:1,PET:1,PETT:1,PGT:1,PHOT:1,PHT:1,PKT:1,PMDT:1,PMST:1,PONT:1,PST:1,PYST:1,PYT:1,RET:1,ROTT:1,SAKT:1,SAMT:1,SAST:1,SBT:1,SCT:1,SGT:1,SLST:1,SRT:1,SST:1,SYOT:1,TAHT:1,THA:1,TFT:1,TJT:1,TKT:1,TLT:1,TMT:1,TOT:1,TVT:1,UCT:1,ULAT:1,UTC:1,UYST:1,UYT:1,UZT:1,VET:1,VLAT:1,VOLT:1,VOST:1,VUT:1,WAKT:1,WAST:1,WAT:1,WEDT:1,WEST:1,WET:1,WST:1,YAKT:1,YEKT:1,Z:1};return 1===timezones[value]},$D.validateTimezoneOffset=function(value){return value>-841&&721>value},$D.validateSetExplicitTime=function(value){return!0}}(),function(){var $D=Date,$P=$D.prototype,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)},validateConfigObject=function(obj){var result={},self=this,prop,testFunc;testFunc=function(prop,func,value){if("day"===prop){var month=void 0!==obj.month?obj.month:self.getMonth(),year=void 0!==obj.year?obj.year:self.getFullYear();return $D[func](value,year,month)}return $D[func](value)};for(prop in obj)if(hasOwnProperty.call(obj,prop)){var func="validate"+prop.charAt(0).toUpperCase()+prop.slice(1);$D[func]&&null!==obj[prop]&&testFunc(prop,func,obj[prop])&&(result[prop]=obj[prop])}return result};$P.clearTime=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},$P.setTimeToNow=function(){var n=new Date;return this.setHours(n.getHours()),this.setMinutes(n.getMinutes()),this.setSeconds(n.getSeconds()),this.setMilliseconds(n.getMilliseconds()),this},$P.clone=function(){return new Date(this.getTime())},$P.compareTo=function(date){return Date.compare(this,date)},$P.equals=function(date){return Date.equals(this,void 0!==date?date:new Date)},$P.between=function(start,end){return this.getTime()>=start.getTime()&&this.getTime()<=end.getTime()},$P.isAfter=function(date){return 1===this.compareTo(date||new Date)},$P.isBefore=function(date){return-1===this.compareTo(date||new Date)},$P.isToday=$P.isSameDay=function(date){return this.clone().clearTime().equals((date||new Date).clone().clearTime())},$P.addMilliseconds=function(value){return value?(this.setTime(this.getTime()+1*value),this):this},$P.addSeconds=function(value){return value?this.addMilliseconds(1e3*value):this},$P.addMinutes=function(value){return value?this.addMilliseconds(6e4*value):this},$P.addHours=function(value){return value?this.addMilliseconds(36e5*value):this},$P.addDays=function(value){return value?(this.setDate(this.getDate()+1*value),this):this},$P.addWeekdays=function(value){if(!value)return this;var day=this.getDay(),weeks=Math.ceil(Math.abs(value)/7);if((0===day||6===day)&&value>0&&(this.next().monday(),this.addDays(-1),day=this.getDay()),0>value){for(;0>value;)this.addDays(-1),day=this.getDay(),0!==day&&6!==day&&value++;return this}return(value>5||value>=6-day)&&(value+=2*weeks),this.addDays(value)},$P.addWeeks=function(value){return value?this.addDays(7*value):this},$P.addMonths=function(value){if(!value)return this;var n=this.getDate();return this.setDate(1),this.setMonth(this.getMonth()+1*value),this.setDate(Math.min(n,$D.getDaysInMonth(this.getFullYear(),this.getMonth()))),this},$P.addQuarters=function(value){return value?this.addMonths(3*value):this},$P.addYears=function(value){return value?this.addMonths(12*value):this},$P.add=function(config){if("number"==typeof config)return this._orient=config,this;var x=config;return x.day&&x.day-this.getDate()!==0&&this.setDate(x.day),x.milliseconds&&this.addMilliseconds(x.milliseconds),x.seconds&&this.addSeconds(x.seconds),x.minutes&&this.addMinutes(x.minutes),x.hours&&this.addHours(x.hours),x.weeks&&this.addWeeks(x.weeks),x.months&&this.addMonths(x.months),x.years&&this.addYears(x.years),x.days&&this.addDays(x.days),x.setExplicitTime&&this.ensureTimeOfDay(),this},$P.getWeek=function(utc){var self,target=new Date(this.valueOf());utc?(target.addMinutes(target.getTimezoneOffset()),self=target.clone()):self=this;var dayNr=(self.getDay()+6)%7;target.setDate(target.getDate()-dayNr+3);var firstThursday=target.valueOf();return target.setMonth(0,1),4!==target.getDay()&&target.setMonth(0,1+(4-target.getDay()+7)%7),1+Math.ceil((firstThursday-target)/6048e5)},$P.getISOWeek=function(){return p(this.getWeek(!0))},$P.setWeek=function(n){return n-this.getWeek()===0?1!==this.getDay()?this.moveToDayOfWeek(1,this.getDay()>1?-1:1):this:this.moveToDayOfWeek(1,this.getDay()>1?-1:1).addWeeks(n-this.getWeek())},$P.setQuarter=function(qtr){var month=Math.abs(3*(qtr-1)+1);return this.setMonth(month,1)},$P.getQuarter=function(){return Date.getQuarter(this)},$P.getDaysLeftInQuarter=function(){return Date.getDaysLeftInQuarter(this)},$P.moveToNthOccurrence=function(dayOfWeek,occurrence){if("Weekday"===dayOfWeek){if(occurrence>0)this.moveToFirstDayOfMonth(),this.is().weekday()&&(occurrence-=1);else{if(!(0>occurrence))return this;this.moveToLastDayOfMonth(),this.is().weekday()&&(occurrence+=1)}return this.addWeekdays(occurrence)}var shift=0;if(occurrence>0)shift=occurrence-1;else if(-1===occurrence)return this.moveToLastDayOfMonth(),this.getDay()!==dayOfWeek&&this.moveToDayOfWeek(dayOfWeek,-1),this;return this.moveToFirstDayOfMonth().addDays(-1).moveToDayOfWeek(dayOfWeek,1).addWeeks(shift)};var moveToN=function(getFunc,addFunc,nVal){return function(value,orient){var diff=(value-this[getFunc]()+nVal*(orient||1))%nVal;return this[addFunc](0===diff?diff+=nVal*(orient||1):diff)}};$P.moveToDayOfWeek=moveToN("getDay","addDays",7),$P.moveToMonth=moveToN("getMonth","addMonths",12),$P.getOrdinate=function(){var num=this.getDate();return ord(num)},$P.getOrdinalNumber=function(){return Math.ceil((this.clone().clearTime()-new Date(this.getFullYear(),0,1))/864e5)+1},$P.getTimezone=function(){return $D.getTimezoneAbbreviation(this.getUTCOffset(),this.isDaylightSavingTime())},$P.setTimezoneOffset=function(offset){var here=this.getTimezoneOffset(),there=-6*Number(offset)/10;return there||0===there?this.addMinutes(there-here):this},$P.setTimezone=function(offset){return this.setTimezoneOffset($D.getTimezoneOffset(offset))},$P.hasDaylightSavingTime=function(){return Date.today().set({month:0,day:1}).getTimezoneOffset()!==Date.today().set({month:6,day:1}).getTimezoneOffset()},$P.isDaylightSavingTime=function(){return Date.today().set({month:0,day:1}).getTimezoneOffset()!==this.getTimezoneOffset()},$P.getUTCOffset=function(offset){var n=-10*(offset||this.getTimezoneOffset())/6,r;return 0>n?(r=(n-1e4).toString(),r.charAt(0)+r.substr(2)):(r=(n+1e4).toString(),"+"+r.substr(1))},$P.getElapsed=function(date){return(date||new Date)-this},$P.set=function(config){config=validateConfigObject.call(this,config);var key;for(key in config)if(hasOwnProperty.call(config,key)){var name=key.charAt(0).toUpperCase()+key.slice(1),addFunc,getFunc;"week"!==key&&"month"!==key&&"timezone"!==key&&"timezoneOffset"!==key&&(name+="s"),addFunc="add"+name,getFunc="get"+name,"month"===key?addFunc+="s":"year"===key&&(getFunc="getFullYear"),"day"!==key&&"timezone"!==key&&"timezoneOffset"!==key&&"week"!==key&&"hour"!==key&&"setExplicitTime"!==key?this[addFunc](config[key]-this[getFunc]()):("timezone"===key||"timezoneOffset"===key||"week"===key||"hour"===key)&&this["set"+name](config[key])}return config.day&&this.addDays(config.day-this.getDate()),this},$P.moveToFirstDayOfMonth=function(){return this.set({day:1})},$P.moveToLastDayOfMonth=function(){return this.set({day:$D.getDaysInMonth(this.getFullYear(),this.getMonth())})};var ord=function(n){switch(1*n){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}},parseStandardFormats=function(format){var y,c=Date.CultureInfo.formatPatterns;switch(format){case"d":return this.toString(c.shortDate);case"D":return this.toString(c.longDate);case"F":return this.toString(c.fullDateTime);case"m":return this.toString(c.monthDay);case"r":case"R":return y=this.clone().addMinutes(this.getTimezoneOffset()),y.toString(c.rfc1123)+" GMT";case"s":return this.toString(c.sortableDateTime);case"t":return this.toString(c.shortTime);case"T":return this.toString(c.longTime);case"u":return y=this.clone().addMinutes(this.getTimezoneOffset()),y.toString(c.universalSortableDateTime);case"y":return this.toString(c.yearMonth);default:return!1}},parseFormatStringsClosure=function(context){return function(m){if("\\"===m.charAt(0))return m.replace("\\","");switch(m){case"hh":return p(context.getHours()<13?0===context.getHours()?12:context.getHours():context.getHours()-12);case"h":return context.getHours()<13?0===context.getHours()?12:context.getHours():context.getHours()-12;case"HH":return p(context.getHours());case"H":return context.getHours();case"mm":return p(context.getMinutes());case"m":return context.getMinutes();case"ss":return p(context.getSeconds());case"s":return context.getSeconds();case"yyyy":return p(context.getFullYear(),4);case"yy":return p(context.getFullYear());case"y":return context.getFullYear();case"E":case"dddd":return Date.CultureInfo.dayNames[context.getDay()];case"ddd":return Date.CultureInfo.abbreviatedDayNames[context.getDay()];case"dd":return p(context.getDate());case"d":return context.getDate();case"MMMM":return Date.CultureInfo.monthNames[context.getMonth()];case"MMM":return Date.CultureInfo.abbreviatedMonthNames[context.getMonth()];case"MM":return p(context.getMonth()+1);case"M":return context.getMonth()+1;case"t":return context.getHours()<12?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return context.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"S":return ord(context.getDate());case"W":return context.getWeek();case"WW":return context.getISOWeek();case"Q":return"Q"+context.getQuarter();case"q":return String(context.getQuarter());case"z":return context.getTimezone();case"Z":case"X":return Date.getTimezoneOffset(context.getTimezone());case"ZZ":return-60*context.getTimezoneOffset();case"u":return context.getDay();case"L":return $D.isLeapYear(context.getFullYear())?1:0;case"B":return"@"+(context.getUTCSeconds()+60*context.getUTCMinutes()+3600*(context.getUTCHours()+1))/86.4;default:return m}}};$P.toString=function(format,ignoreStandards){if(!ignoreStandards&&format&&1===format.length&&(output=parseStandardFormats.call(this,format)))return output;var parseFormatStrings=parseFormatStringsClosure(this);return format?format.replace(/((\\)?(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|S|q|Q|WW?W?W?)(?![^\[]*\]))/g,parseFormatStrings).replace(/\[|\]/g,""):this._toString()}}(),function(){var $D=Date,$P=$D.prototype,$N=Number.prototype;$P._orient=1,$P._nth=null,$P._is=!1,$P._same=!1,$P._isSecond=!1,$N._dateElement="days",$P.next=function(){return this._move=!0,this._orient=1,this},$D.next=function(){return $D.today().next()},$P.last=$P.prev=$P.previous=function(){return this._move=!0,this._orient=-1,this},$D.last=$D.prev=$D.previous=function(){return $D.today().last()},$P.is=function(){return this._is=!0,this},$P.same=function(){return this._same=!0,this._isSecond=!1,this},$P.today=function(){return this.same().day()},$P.weekday=function(){return this._nth?df("Weekday").call(this):this._move?this.addWeekdays(this._orient):this._is?(this._is=!1,!this.is().sat()&&!this.is().sun()):!1},$P.weekend=function(){return this._is?(this._is=!1,this.is().sat()||this.is().sun()):!1},$P.at=function(time){return"string"==typeof time?$D.parse(this.toString("d")+" "+time):this.set(time)},$N.fromNow=$N.after=function(date){var c={};return c[this._dateElement]=this,(date?date.clone():new Date).add(c)},$N.ago=$N.before=function(date){var c={},s="s"!==this._dateElement[this._dateElement.length-1]?this._dateElement+"s":this._dateElement;return c[s]=-1*this,(date?date.clone():new Date).add(c)};var dx="sunday monday tuesday wednesday thursday friday saturday".split(/\s/),mx="january february march april may june july august september october november december".split(/\s/),px=[],pxf=[],nth="final first second third fourth fifth".split(/\s/),de;$P.toObject=function(){for(var o={},i=0;i<px.length;i++)this["get"+pxf[i]]&&(o[px[i].toLowerCase()]=this["get"+pxf[i]]());return o},$D.fromObject=function(config){return config.week=null,Date.today().set(config)};var df=function(n){return function(){if(this._is)return this._is=!1,this.getDay()===n;if(this._move&&(this._move=null),null!==this._nth){this._isSecond&&this.addSeconds(-1*this._orient),this._isSecond=!1;var ntemp=this._nth;this._nth=null;var temp=this.clone().moveToLastDayOfMonth();if(this.moveToNthOccurrence(n,ntemp),this>temp)throw new RangeError($D.getDayName(n)+" does not occur "+ntemp+" times in the month of "+$D.getMonthName(temp.getMonth())+" "+temp.getFullYear()+".");return this}return this.moveToDayOfWeek(n,this._orient)}},sdf=function(n){return function(){var t=$D.today(),shift=n-t.getDay();return(0===n&&1===Date.CultureInfo.firstDayOfWeek&&0!==t.getDay()||0>shift)&&(shift+=7),t.addDays(shift)}},month_instance_functions=function(n){return function(){return this._is?(this._is=!1,this.getMonth()===n):this.moveToMonth(n,this._orient)}},month_static_functions=function(n){return function(){return $D.today().set({month:n,day:1})}},processTerms=function(names,staticFunc,instanceFunc){for(var i=0;i<names.length;i++)$D[names[i].toUpperCase()]=$D[names[i].toUpperCase().substring(0,3)]=i,$D[names[i]]=$D[names[i].substring(0,3)]=staticFunc(i),$P[names[i]]=$P[names[i].substring(0,3)]=instanceFunc(i)};processTerms(dx,sdf,df),processTerms(mx,month_static_functions,month_instance_functions);for(var ef=function(j){return function(){if(this._isSecond)return this._isSecond=!1,this;if(this._same){this._same=this._is=!1;var o1=this.toObject(),o2=(arguments[0]||new Date).toObject(),v="",k=j.toLowerCase();k="s"===k[k.length-1]?k.substring(0,k.length-1):k;for(var m=px.length-1;m>-1;m--){if(v=px[m].toLowerCase(),o1[v]!==o2[v])return!1;if(k===v)break}return!0}return"s"!==j.substring(j.length-1)&&(j+="s"),this._move&&(this._move=null),this["add"+j](this._orient)}},nf=function(n){return function(){return this._dateElement=n,this}},k=0;k<px.length;k++)de=px[k].toLowerCase(),"weekday"!==de&&($P[de]=$P[de+"s"]=ef(px[k]),$N[de]=$N[de+"s"]=nf(de+"s"));$P._ss=ef("Second");for(var nthfn=function(n){return function(dayOfWeek){return this._same?this._ss(arguments[0]):dayOfWeek||0===dayOfWeek?this.moveToNthOccurrence(dayOfWeek,n):(this._nth=n,2!==n||void 0!==dayOfWeek&&null!==dayOfWeek?this:(this._isSecond=!0,this.addSeconds(this._orient)))}},l=0;l<nth.length;l++)$P[nth[l]]=nthfn(0===l?-1:l)}(),function(){Date.Parsing={Exception:function(s){this.message="Parse error at '"+s.substring(0,10)+" ...'"}};var $P=Date.Parsing,dayOffsets={standard:[0,31,59,90,120,151,181,212,243,273,304,334],leap:[0,31,60,91,121,152,182,213,244,274,305,335]};$P.isLeapYear=function(year){return year%4===0&&year%100!==0||year%400===0};var utils={multiReplace:function(str,hash){var key;for(key in hash)if(Object.prototype.hasOwnProperty.call(hash,key)){var regex;"function"==typeof hash[key]||(regex=hash[key]instanceof RegExp?hash[key]:new RegExp(hash[key],"g")),str=str.replace(regex,key)}return str},getDayOfYearFromWeek:function(obj){var d,jan4,offset;return obj.weekDay=obj.weekDay||0===obj.weekDay?obj.weekDay:1,d=new Date(obj.year,0,4),jan4=0===d.getDay()?7:d.getDay(),offset=jan4+3,obj.dayOfYear=7*obj.week+(0===obj.weekDay?7:obj.weekDay)-offset,obj},getDayOfYear:function(obj,dayOffset){obj.dayOfYear||(obj=utils.getDayOfYearFromWeek(obj));for(var i=0;i<=dayOffset.length;i++){if(obj.dayOfYear<dayOffset[i]||i===dayOffset.length){obj.day=obj.day?obj.day:obj.dayOfYear-dayOffset[i-1];break}obj.month=i}return obj},adjustForTimeZone:function(obj,date){var offset;return"Z"===obj.zone.toUpperCase()||0===obj.zone_hours&&0===obj.zone_minutes?offset=-date.getTimezoneOffset():(offset=60*obj.zone_hours+(obj.zone_minutes||0),"+"===obj.zone_sign&&(offset*=-1),offset-=date.getTimezoneOffset()),date.setMinutes(date.getMinutes()+offset),date},setDefaults:function(obj){return obj.year=obj.year||Date.today().getFullYear(),obj.hours=obj.hours||0,obj.minutes=obj.minutes||0,obj.seconds=obj.seconds||0,obj.milliseconds=obj.milliseconds||0,(obj.month||!obj.week&&!obj.dayOfYear)&&(obj.month=obj.month||0,obj.day=obj.day||1),obj},dataNum:function(data,mod,explict,postProcess){var dataNum=1*data;return mod?postProcess?data?1*mod(data):data:data?mod(dataNum):data:explict?data&&"undefined"!=typeof data?dataNum:data:data?dataNum:data},timeDataProcess:function(obj){var timeObj={};for(var x in obj.data)obj.data.hasOwnProperty(x)&&(timeObj[x]=obj.ignore[x]?obj.data[x]:utils.dataNum(obj.data[x],obj.mods[x],obj.explict[x],obj.postProcess[x]));return obj.data.secmins&&(obj.data.secmins=60*obj.data.secmins.replace(",","."),timeObj.minutes?timeObj.seconds||(timeObj.seconds=obj.data.secmins):timeObj.minutes=obj.data.secmins,delete obj.secmins),timeObj},buildTimeObjectFromData:function(data){var time=utils.timeDataProcess({data:{year:data[1],month:data[5],day:data[7],week:data[8],dayOfYear:data[10],hours:data[15],zone_hours:data[23],zone_minutes:data[24],zone:data[21],zone_sign:data[22],weekDay:data[9],minutes:data[16],seconds:data[19],milliseconds:data[20],secmins:data[18]},mods:{month:function(data){return data-1},weekDay:function(data){return data=Math.abs(data),7===data?0:data},minutes:function(data){return data.replace(":","")},seconds:function(data){return Math.floor(1*data.replace(":","").replace(",","."))},milliseconds:function(data){return 1e3*data.replace(",",".")}},postProcess:{minutes:!0,seconds:!0,milliseconds:!0},explict:{zone_hours:!0,zone_minutes:!0},ignore:{zone:!0,zone_sign:!0,secmins:!0}});return time},addToHash:function(hash,keys,data){keys=keys,data=data;for(var len=keys.length,i=0;len>i;i++)hash[keys[i]]=data[i];return hash},combineRegex:function(r1,r2){return new RegExp("(("+r1.source+")\\s("+r2.source+"))")},getDateNthString:function(add,last,inc){return add?Date.today().addDays(inc).toString("d"):last?Date.today().last()[inc]().toString("d"):void 0},buildRegexData:function(array){for(var arr=[],len=array.length,i=0;len>i;i++)arr.push(Array.isArray(array[i])?this.combineRegex(array[i][0],array[i][1]):array[i]);return arr}};$P.processTimeObject=function(obj){var date,dayOffset;return utils.setDefaults(obj),dayOffset=$P.isLeapYear(obj.year)?dayOffsets.leap:dayOffsets.standard,obj.month||!obj.week&&!obj.dayOfYear?obj.dayOfYear=dayOffset[obj.month]+obj.day:utils.getDayOfYear(obj,dayOffset),date=new Date(obj.year,obj.month,obj.day,obj.hours,obj.minutes,obj.seconds,obj.milliseconds),obj.zone&&utils.adjustForTimeZone(obj,date),date},$P.Numeric={isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},regex:/\b([0-1]?[0-9])([0-3]?[0-9])([0-2]?[0-9]?[0-9][0-9])\b/i,parse:function(s){var data,i,time={},order=Date.CultureInfo.dateElementOrder.split("");if(!this.isNumeric(s)||"+"===s[0]&&"-"===s[0])return null;if(s.length<5&&s.indexOf(".")<0&&s.indexOf("/")<0)return time.year=s,$P.processTimeObject(time);if(data=s.match(this.regex),!data||!data.length)return null;for(i=0;i<order.length;i++)switch(order[i]){case"d":time.day=data[i+1];break;case"m":time.month=data[i+1]-1;break;case"y":time.year=data[i+1]}return $P.processTimeObject(time)}},$P.Normalizer={regexData:function(){var $R=Date.CultureInfo.regexPatterns;return utils.buildRegexData([$R.tomorrow,$R.yesterday,[$R.past,$R.mon],[$R.past,$R.tue],[$R.past,$R.wed],[$R.past,$R.thu],[$R.past,$R.fri],[$R.past,$R.sat],[$R.past,$R.sun]])},basicReplaceHash:function(){var $R=Date.CultureInfo.regexPatterns;return{January:$R.jan,February:$R.feb,March:$R.mar,April:$R.apr,May:$R.may,June:$R.jun,July:$R.jul,August:$R.aug,September:$R.sep,October:$R.oct,November:$R.nov,December:$R.dec,"":/\bat\b/gi," ":/\s{2,}/,"9am":$R.thisMorning,"7pm":$R.thisEvening}},keys:function(){return[utils.getDateNthString(!0,!1,1),utils.getDateNthString(!0,!1,-1),utils.getDateNthString(!1,!0,"monday"),utils.getDateNthString(!1,!0,"tuesday"),utils.getDateNthString(!1,!0,"wednesday"),utils.getDateNthString(!1,!0,"thursday"),utils.getDateNthString(!1,!0,"friday"),utils.getDateNthString(!1,!0,"saturday"),utils.getDateNthString(!1,!0,"sunday")]},buildRegexFunctions:function(){var $R=Date.CultureInfo.regexPatterns,__=Date.i18n.__,tomorrowRE=new RegExp("(\\b\\d\\d?("+__("AM")+"|"+__("PM")+")? )("+$R.tomorrow.source.slice(1)+")","i"),todayRE=new RegExp($R.today.source+"(?!\\s*([+-]))\\b");this.replaceFuncs=[[todayRE,function(full){return full.length>1?Date.today().toString("d"):full}],[tomorrowRE,function(full,m1){var t=Date.today().addDays(1).toString("d");return t+" "+m1}]]},buildReplaceData:function(){this.buildRegexFunctions(),this.replaceHash=utils.addToHash(this.basicReplaceHash(),this.keys(),this.regexData())},stringReplaceFuncs:function(s){for(var i=0;i<this.replaceFuncs.length;i++)s=s.replace(this.replaceFuncs[i][0],this.replaceFuncs[i][1]);return s},parse:function(s){s=this.stringReplaceFuncs(s),s=utils.multiReplace(s,this.replaceHash);try{var n=s.split(/([\s\-\.\,\/\x27]+)/);3===n.length&&$P.Numeric.isNumeric(n[0])&&$P.Numeric.isNumeric(n[2])&&n[2].length>=4&&"d"===Date.CultureInfo.dateElementOrder[0]&&(s="1/"+n[0]+"/"+n[2])}catch(e){}return s}},$P.Normalizer.buildReplaceData()}(),function(){for(var $P=Date.Parsing,_=$P.Operators={rtoken:function(r){return function(s){var mx=s.match(r);if(mx)return[mx[0],s.substring(mx[0].length)];throw new $P.Exception(s)}},token:function(){return function(s){return _.rtoken(new RegExp("^\\s*"+s+"\\s*"))(s)}},stoken:function(s){return _.rtoken(new RegExp("^"+s))},until:function(p){return function(s){for(var qx=[],rx=null;s.length;){try{rx=p.call(this,s)}catch(e){qx.push(rx[0]),s=rx[1];continue}break}return[qx,s]}},many:function(p){return function(s){for(var rx=[],r=null;s.length;){try{r=p.call(this,s)}catch(e){return[rx,s]}rx.push(r[0]),s=r[1]}return[rx,s]}},optional:function(p){return function(s){var r=null;try{r=p.call(this,s)}catch(e){return[null,s]}return[r[0],r[1]]}},not:function(p){return function(s){try{p.call(this,s)}catch(e){return[null,s]}throw new $P.Exception(s)}},ignore:function(p){return p?function(s){var r=null;return r=p.call(this,s),[null,r[1]]}:null},product:function(){for(var px=arguments[0],qx=Array.prototype.slice.call(arguments,1),rx=[],i=0;i<px.length;i++)rx.push(_.each(px[i],qx));return rx},cache:function(rule){var cache={},cache_length=0,cache_keys=[],CACHE_MAX=Date.Config.CACHE_MAX||500,r=null,cacheCheck=function(){if(cache_length===CACHE_MAX)for(var i=0;10>i;i++){var key=cache_keys.shift();key&&(delete cache[key],cache_length--)}};return function(s){cacheCheck();try{r=cache[s]=cache[s]||rule.call(this,s)}catch(e){r=cache[s]=e}if(cache_length++,cache_keys.push(s),r instanceof $P.Exception)throw r;return r}},any:function(){var px=arguments;return function(s){for(var r=null,i=0;i<px.length;i++)if(null!=px[i]){try{r=px[i].call(this,s)}catch(e){r=null}if(r)return r}throw new $P.Exception(s)}},each:function(){var px=arguments;return function(s){for(var rx=[],r=null,i=0;i<px.length;i++)if(null!=px[i]){try{r=px[i].call(this,s)}catch(e){throw new $P.Exception(s)}rx.push(r[0]),s=r[1]}return[rx,s]}},all:function(){var px=arguments,_=_;return _.each(_.optional(px))},sequence:function(px,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,1===px.length?px[0]:function(s){for(var r=null,q=null,rx=[],i=0;i<px.length;i++){try{r=px[i].call(this,s)}catch(e){break}rx.push(r[0]);try{q=d.call(this,r[1])}catch(ex){q=null;break}s=q[1]}if(!r)throw new $P.Exception(s);if(q)throw new $P.Exception(q[1]);if(c)try{r=c.call(this,r[1])}catch(ey){throw new $P.Exception(r[1])}return[rx,r?r[1]:s]}},between:function(d1,p,d2){d2=d2||d1;var _fn=_.each(_.ignore(d1),p,_.ignore(d2));return function(s){var rx=_fn.call(this,s);return[[rx[0][0],r[0][2]],rx[1]]}},list:function(p,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,p instanceof Array?_.each(_.product(p.slice(0,-1),_.ignore(d)),p.slice(-1),_.ignore(c)):_.each(_.many(_.each(p,_.ignore(d))),px,_.ignore(c))},set:function(px,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,function(s){for(var r=null,p=null,q=null,rx=null,best=[[],s],last=!1,i=0;i<px.length;i++){q=null,p=null,r=null,last=1===px.length;try{r=px[i].call(this,s)}catch(e){continue}if(rx=[[r[0]],r[1]],r[1].length>0&&!last)try{q=d.call(this,r[1])}catch(ex){last=!0}else last=!0;if(last||0!==q[1].length||(last=!0),!last){for(var qx=[],j=0;j<px.length;j++)i!==j&&qx.push(px[j]);p=_.set(qx,d).call(this,q[1]),p[0].length>0&&(rx[0]=rx[0].concat(p[0]),rx[1]=p[1])}if(rx[1].length<best[1].length&&(best=rx),0===best[1].length)break}if(0===best[0].length)return best;if(c){try{q=c.call(this,best[1])}catch(ey){throw new $P.Exception(best[1])}best[1]=q[1]}return best}},forward:function(gr,fname){return function(s){return gr[fname].call(this,s)}},replace:function(rule,repl){return function(s){var r=rule.call(this,s);return[repl,r[1]]}},process:function(rule,fn){return function(s){var r=rule.call(this,s);return[fn.call(this,r[0]),r[1]]}},min:function(min,rule){return function(s){var rx=rule.call(this,s);if(rx[0].length<min)throw new $P.Exception(s);return rx}}},_generator=function(op){function gen(){var args=null,rx=[],px,i;return arguments.length>1?args=Array.prototype.slice.call(arguments):arguments[0]instanceof Array&&(args=arguments[0]),args?(px=args.shift(),px.length>0?(args.unshift(px[i]),rx.push(op.apply(null,args)),args.shift(),rx):void 0):op.apply(null,arguments)}return gen},gx="optional not ignore cache".split(/\s/),i=0;i<gx.length;i++)_[gx[i]]=_generator(_[gx[i]]);for(var _vector=function(op){return function(){return arguments[0]instanceof Array?op.apply(null,arguments[0]):op.apply(null,arguments)}},vx="each any all".split(/\s/),j=0;j<vx.length;j++)_[vx[j]]=_vector(_[vx[j]])}(),function(){var $D=Date,flattenAndCompact=function(ax){for(var rx=[],i=0;i<ax.length;i++)ax[i]instanceof Array?rx=rx.concat(flattenAndCompact(ax[i])):ax[i]&&rx.push(ax[i]);return rx},parseMeridian=function(){if(this.meridian&&(this.hour||0===this.hour)){if("a"===this.meridian&&this.hour>11&&Date.Config.strict24hr)throw"Invalid hour and meridian combination";if("p"===this.meridian&&this.hour<12&&Date.Config.strict24hr)throw"Invalid hour and meridian combination";"p"===this.meridian&&this.hour<12?this.hour=this.hour+12:"a"===this.meridian&&12===this.hour&&(this.hour=0)}else this.meridian||!this.hour&&0!==this.hour||this.hour<8&&(this.hour=this.hour+12)},setDefaults=function(){var now=new Date;!this.hour&&!this.minute||this.month||this.year||this.day||(this.day=now.getDate()),this.year||(this.year=now.getFullYear(),this.month<now.getMonth()&&this.year++),this.month||0===this.month||(this.month=now.getMonth()),this.day||(this.day=1),this.hour||(this.hour=0),this.minute||(this.minute=0),this.second||(this.second=0),this.millisecond||(this.millisecond=0)},finishUtils={getToday:function(){return this.now||-1!=="hour minute second".indexOf(this.unit)?new Date:$D.today()},setDaysFromWeekday:function(today,orient){var gap;return orient=orient||1,this.unit="day",gap=$D.getDayNumberFromName(this.weekday)-today.getDay(),this.days=gap?gap+7*orient:7*orient,this},setMonthsFromMonth:function(today,orient){var gap;return orient=orient||1,this.unit="month",gap=this.month-today.getMonth(),this.months=gap?(gap+12*orient)%12:12*orient,this.month=null,this},setDMYFromWeekday:function(){var d=Date[this.weekday]();return this.day=d.getDate(),this.month||(this.month=d.getMonth()),this.year=d.getFullYear(),this},setUnitValue:function(orient){!this.value&&this.operator&&null!==this.operator&&this[this.unit+"s"]&&null!==this[this.unit+"s"]?this[this.unit+"s"]=this[this.unit+"s"]+("add"===this.operator?1:-1)+(this.value||0)*orient:(null==this[this.unit+"s"]||null!=this.operator)&&(this.value||(this.value=1),this[this.unit+"s"]=this.value*orient)},generateDateFromWeeks:function(){var weekday=void 0!==this.weekday?this.weekday:"today",d=Date[weekday]().addWeeks(this.weeks);return this.now&&d.setTimeToNow(),d}};$D.Translator={hour:function(s){return function(){this.hour=Number(s),this.setExplicitTime=!0}},minute:function(s){return function(){this.minute=Number(s),this.setExplicitTime=!0}},second:function(s){return function(){this.second=Number(s),this.setExplicitTime=!0}},secondAndMillisecond:function(s){return function(){var mx=s.match(/^([0-5][0-9])\.([0-9]{1,3})/);this.second=Number(mx[1]),this.millisecond=Number(mx[2]),this.setExplicitTime=!0}},meridian:function(s){return function(){this.meridian=s.slice(0,1).toLowerCase(),this.setExplicitTime=!0}},timezone:function(s){return function(){var n=s.replace(/[^\d\+\-]/g,"");n.length?this.timezoneOffset=Number(n):this.timezone=s.toLowerCase()}},day:function(x){var s=x[0];return function(){if(this.day=Number(s.match(/\d+/)[0]),this.day<1)throw"invalid day"}},month:function(s){return function(){if(this.month=3===s.length?"jan feb mar apr may jun jul aug sep oct nov dec".indexOf(s)/4:Number(s)-1,this.month<0)throw"invalid month"}},year:function(s){return function(){var n=Number(s);this.year=s.length>2?n:n+(n+2e3<Date.CultureInfo.twoDigitYearMax?2e3:1900)}},rday:function(s){return function(){switch(s){case"yesterday":this.days=-1;break;case"someday":this.days=14;break;case"later":this.days=5;break;case"soon":this.days=2;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0,this.now=!0}}},finishExact:function(x){var d;x=x instanceof Array?x:[x];for(var i=0;i<x.length;i++)x[i]&&x[i].call(this);if(setDefaults.call(this),parseMeridian.call(this),this.day>$D.getDaysInMonth(this.year,this.month))throw new RangeError(this.day+" is not a valid value for days.");return d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond),this.setExplicitTime&&d.ensureTimeOfDay(),this.year<100&&d.setFullYear(this.year),this.timezone?d.set({timezone:this.timezone}):this.timezoneOffset&&d.set({timezoneOffset:this.timezoneOffset}),d},finish:function(x){var today,expression,orient,givenYean,temp;if(x=x instanceof Array?flattenAndCompact(x):[x],0===x.length)return null;for(var i=0;i<x.length;i++)"function"==typeof x[i]&&x[i].call(this);if(this.now&&!this.unit&&!this.operator)return new Date;if(today=finishUtils.getToday.call(this),givenYear=!!this.year,expression=!!(this.days&&null!==this.days||this.orient||this.operator),orient="past"===this.orient||"subtract"===this.operator?-1:1,this.month&&"week"===this.unit&&(this.value=this.month+1,delete this.month,delete this.day),!this.month&&0!==this.month||-1==="year day hour minute second".indexOf(this.unit)||(this.value||(this.value=this.month+1),this.month=null,expression=!0),expression||!this.weekday||this.day||this.days||finishUtils.setDMYFromWeekday.call(this),expression&&this.weekday&&"month"!==this.unit&&"week"!==this.unit&&finishUtils.setDaysFromWeekday.call(this,today,orient),!this.weekday||"week"===this.unit||this.day||this.days||(temp=Date[this.weekday](),this.day=temp.getDate(),temp.getMonth()!==today.getMonth()&&(this.month=temp.getMonth())),this.month&&"day"===this.unit&&this.operator&&(this.value||(this.value=this.month+1),this.month=null),null!=this.value&&null!=this.month&&null!=this.year&&(this.day=1*this.value),this.month&&!this.day&&this.value&&(today.set({day:1*this.value}),expression||(this.day=1*this.value)),this.month||!this.value||"month"!==this.unit||this.now||(this.month=this.value,expression=!0),expression&&(this.month||0===this.month)&&"year"!==this.unit&&finishUtils.setMonthsFromMonth.call(this,today,orient),this.unit||(this.unit="day"),finishUtils.setUnitValue.call(this,orient),parseMeridian.call(this),!this.month&&0!==this.month||this.day||(this.day=1),!this.orient&&!this.operator&&"week"===this.unit&&this.value&&!this.day&&!this.month)return Date.today().setWeek(this.value);
if("week"===this.unit&&this.weeks&&!this.day&&!this.month)return finishUtils.generateDateFromWeeks.call(this);if(expression&&this.timezone&&this.day&&this.days&&(this.day=this.days),!givenYear&&this.month<today.getMonth()&&(this.year=today.getFullYear()+1),expression&&(this.hour||this.minute||this.second)&&(this.hours=this.hour,this.minutes=this.minute,this.seconds=this.second),expression?today.add(this):today.set(this),this.timezone){this.timezone=this.timezone.toUpperCase();var offset=$D.getTimezoneOffset(this.timezone),timezone;today.hasDaylightSavingTime()&&(timezone=$D.getTimezoneAbbreviation(offset,today.isDaylightSavingTime()),timezone!==this.timezone&&today.addHours(today.isDaylightSavingTime()?-1:1)),today.setTimezoneOffset(offset)}return today}}}(),function(){var $D=Date;$D.Grammar={};var _=$D.Parsing.Operators,g=$D.Grammar,t=$D.Translator,_fn;_fn=function(){return _.each(_.any.apply(null,arguments),_.not(g.ctoken2("timeContext")))},g.datePartDelimiter=_.rtoken(/^([\s\-\.\,\/\x27]+)/),g.timePartDelimiter=_.stoken(":"),g.whiteSpace=_.rtoken(/^\s*/),g.generalDelimiter=_.rtoken(/^(([\s\,]|at|@|on)+)/);var _C={};g.ctoken=function(keys){var fn=_C[keys];if(!fn){for(var c=Date.CultureInfo.regexPatterns,kx=keys.split(/\s+/),px=[],i=0;i<kx.length;i++)px.push(_.replace(_.rtoken(c[kx[i]]),kx[i]));fn=_C[keys]=_.any.apply(null,px)}return fn},g.ctoken2=function(key){return _.rtoken(Date.CultureInfo.regexPatterns[key])};var cacheProcessRtoken=function(key,token,type,eachToken){g[key]=_.cache(eachToken?_.process(_.each(_.rtoken(token),_.optional(g.ctoken2(eachToken))),type):_.process(_.rtoken(token),type))},cacheProcessCtoken=function(token,type){return _.cache(_.process(g.ctoken2(token),type))},_F={},_get=function(f){return _F[f]=_F[f]||g.format(f)[0],_F[f]};g.allformats=function(fx){var rx=[];if(fx instanceof Array)for(var i=0;i<fx.length;i++)rx.push(_get(fx[i]));else rx.push(_get(fx));return rx},g.formats=function(fx){if(fx instanceof Array){for(var rx=[],i=0;i<fx.length;i++)rx.push(_get(fx[i]));return _.any.apply(null,rx)}return _get(fx)};var grammarFormats={timeFormats:function(){var i,RTokenKeys=["h","hh","H","HH","m","mm","s","ss","ss.s","z","zz"],RToken=[/^(0[0-9]|1[0-2]|[1-9])/,/^(0[0-9]|1[0-2])/,/^([0-1][0-9]|2[0-3]|[0-9])/,/^([0-1][0-9]|2[0-3])/,/^([0-5][0-9]|[0-9])/,/^[0-5][0-9]/,/^([0-5][0-9]|[0-9])/,/^[0-5][0-9]/,/^[0-5][0-9]\.[0-9]{1,3}/,/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/,/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/],tokens=[t.hour,t.hour,t.hour,t.minute,t.minute,t.second,t.second,t.secondAndMillisecond,t.timezone,t.timezone,t.timezone];for(i=0;i<RTokenKeys.length;i++)cacheProcessRtoken(RTokenKeys[i],RToken[i],tokens[i]);g.hms=_.cache(_.sequence([g.H,g.m,g.s],g.timePartDelimiter)),g.t=cacheProcessCtoken("shortMeridian",t.meridian),g.tt=cacheProcessCtoken("longMeridian",t.meridian),g.zzz=cacheProcessCtoken("timezone",t.timezone),g.timeSuffix=_.each(_.ignore(g.whiteSpace),_.set([g.tt,g.zzz])),g.time=_.each(_.optional(_.ignore(_.stoken("T"))),g.hms,g.timeSuffix)},dateFormats:function(){cacheProcessRtoken("d",/^([0-2]\d|3[0-1]|\d)/,t.day,"ordinalSuffix"),cacheProcessRtoken("dd",/^([0-2]\d|3[0-1])/,t.day,"ordinalSuffix"),g.rday=_.cache(_.process(g.ctoken("yesterday tomorrow soon later someday today now"),t.rday)),g.ddd=g.dddd=_.cache(_.process(g.ctoken("sun mon tue wed thu fri sat"),function(s){return function(){this.weekday=s}})),cacheProcessRtoken("M",/^(1[0-2]|0\d|\d)/,t.month),cacheProcessRtoken("MM",/^(1[0-2]|0\d)/,t.month),g.MMM=g.MMMM=_.cache(_.process(g.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),t.month)),cacheProcessRtoken("y",/^(\d+)/,t.year),cacheProcessRtoken("yy",/^(\d\d)/,t.year),cacheProcessRtoken("yyy",/^(\d\d?\d?\d?)/,t.year),cacheProcessRtoken("yyyy",/^(\d\d\d\d)/,t.year),g.day=_fn(g.d,g.dd),g.month=_fn(g.M,g.MMM),g.year=_fn(g.yyyy,g.yy);var _setfn=function(){return _.set(arguments,g.datePartDelimiter)};g.mdy=_setfn(g.ddd,g.month,g.day,g.year),g.ymd=_setfn(g.ddd,g.year,g.month,g.day),g.dmy=_setfn(g.ddd,g.day,g.month,g.year),g.date=function(s){return(g[Date.CultureInfo.dateElementOrder]||g.mdy).call(this,s)}},relative:function(){g.orientation=_.process(g.ctoken("past future"),function(s){return function(){this.orient=s}}),g.operator=_.process(g.ctoken("add subtract"),function(s){return function(){this.operator=s}})}};g.buildGrammarFormats=function(){_C={},grammarFormats.timeFormats(),grammarFormats.dateFormats(),grammarFormats.relative(),g.value=_.process(_.rtoken(/^([-+]?\d+)?(st|nd|rd|th)?/),function(s){return function(){this.value=s.replace(/\D/g,"")}}),g.expression=_.set([g.rday,g.time,g.value,g.orientation,g.ddd,g.MMM]),g.format=_.process(_.many(_.any(_.process(_.rtoken(/^(dd?d?d?(?!e)|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(fmt){if(g[fmt])return g[fmt];throw $D.Parsing.Exception(fmt)}),_.process(_.rtoken(/^[^dMyhHmstz]+/),function(s){return _.ignore(_.stoken(s))}))),function(rules){return _.process(_.each.apply(null,rules),t.finishExact)}),g._start=_.process(_.set([g.date,g.expression,g.time],g.generalDelimiter,g.whiteSpace),t.finish)},g.buildGrammarFormats(),g._formats=g.formats(["M-d H","ddd H"]),g.start=function(s){try{var r=g._formats.call({},s);if(0===r[1].length)return r}catch(e){}return g._start.call({},s)}}(),function(){function parse(s){var d;return s?s instanceof Date?s.clone():(s.length>=4&&"0"!==s.charAt(0)&&"+"!==s.charAt(0)&&"-"!==s.charAt(0)&&(d=$D.Parsing.Numeric.parse(s)),d instanceof Date&&!isNaN(d.getTime())?d:(s=$D.Parsing.Normalizer.parse(parseUtils.removeOrds(s)),d=parseUtils.grammarParser(s))):null}var $D=Date,parseUtils={removeOrds:function(s){var ords=s.match(/\b(\d+)(?:st|nd|rd|th)\b/);return s=ords&&2===ords.length?s.replace(ords[0],ords[1]):s},grammarParser:function(s){var r=null;try{r=$D.Grammar.start.call({},s.replace(/^\s*(\S*(\s+\S+)*)\s*$/,"$1"))}catch(e){return null}return 0===r[1].length?r[0]:null}};$D._parse||($D._parse=$D.parse),$D.parse=parse,Date.getParseFunction=function(fx){var fns=Date.Grammar.allformats(fx);return function(s){for(var r=null,i=0;i<fns.length;i++){try{r=fns[i].call({},s)}catch(e){continue}if(0===r[1].length)return r[0]}return null}},$D.parseExact=function(s,fx){return $D.getParseFunction(fx)(s)}}(),function(){var $D=Date,$P=$D.prototype,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)},normalizer={substitutes:function(m){switch(m){case"d":case"%d":return"dd";case"D":case"%a":return"ddd";case"j":case"l":case"%A":return"dddd";case"S":return"S";case"F":case"%B":return"MMMM";case"m":case"%m":return"MM";case"M":case"%b":case"%h":return"MMM";case"n":return"M";case"Y":case"%Y":return"yyyy";case"y":case"%y":return"yy";case"g":case"%I":return"h";case"G":return"H";case"h":return"hh";case"H":case"%H":return"HH";case"i":case"%M":return"mm";case"s":case"%S":return"ss";case"%r":return"hh:mm tt";case"%R":return"H:mm";case"%T":return"H:mm:ss";case"%X":return"t";case"%x":case"%e":return"d";case"%D":return"MM/dd/yy";case"%n":return"\\n";case"%t":return"\\t";case"e":case"T":case"%z":case"%Z":return"z";case"Z":return"ZZ";case"N":case"w":case"%w":return"u";case"W":case"%V":return"W"}},interpreted:function(m,x){var y;switch(m){case"%u":return x.getDay()+1;case"z":return x.getOrdinalNumber();case"%j":return p(x.getOrdinalNumber(),3);case"%U":var d1=x.clone().set({month:0,day:1}).addDays(-1).moveToDayOfWeek(0),d2=x.clone().addDays(1).moveToDayOfWeek(0,-1);return d1>d2?"00":p((d2.getOrdinalNumber()-d1.getOrdinalNumber())/7+1);case"%W":return p(x.getWeek());case"t":return $D.getDaysInMonth(x.getFullYear(),x.getMonth());case"o":case"%G":return x.setWeek(x.getISOWeek()).toString("yyyy");case"%g":return x._format("%G").slice(-2);case"a":case"%p":return t("tt").toLowerCase();case"A":return t("tt").toUpperCase();case"u":return p(x.getMilliseconds(),3);case"I":return x.isDaylightSavingTime()?1:0;case"O":return x.getUTCOffset();case"P":return y=x.getUTCOffset(),y.substring(0,y.length-2)+":"+y.substring(y.length-2);case"B":var now=new Date;return Math.floor((3600*now.getHours()+60*now.getMinutes()+now.getSeconds()+60*(now.getTimezoneOffset()+60))/86.4);case"c":return x.toISOString().replace(/\"/g,"");case"U":return $D.strtotime("now");case"%c":return t("d")+" "+t("t");case"%C":return Math.floor(x.getFullYear()/100+1)}},shouldOverrideDefaults:function(m){switch(m){case"%e":return!0;default:return!1}},parse:function(m,context){var formatString,c=context||new Date;return(formatString=normalizer.substitutes(m))?formatString:(formatString=normalizer.interpreted(m,c),formatString?formatString:m)}};$D.normalizeFormat=function(format,context){return format.replace(/(%|\\)?.|%%/g,function(t){return normalizer.parse(t,context)})},$D.strftime=function(format,time){var d=Date.parse(time);return d._format(format)},$D.strtotime=function(time){var d=$D.parse(time);return Math.round($D.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds(),d.getUTCMilliseconds())/1e3)};var formatReplace=function(context){return function(m){var formatString,override=!1;return"\\"===m.charAt(0)||"%%"===m.substring(0,2)?m.replace("\\","").replace("%%","%"):(override=normalizer.shouldOverrideDefaults(m),formatString=$D.normalizeFormat(m,context),formatString?context.toString(formatString,override):void 0)}};$P._format=function(format){var formatter=formatReplace(this);return format?format.replace(/(%|\\)?.|%%/g,formatter):this._toString()},$P.format||($P.format=$P._format)}(),function(){var gFn=function(attr){return function(){return this[attr]}},sFn=function(attr){return function(val){return this[attr]=val,this}},attrs=["years","months","days","hours","minutes","seconds","milliseconds"],addSetFuncs=function(context,attrs){for(var i=0;i<attrs.length;i++){var $a=attrs[i],$b=$a.slice(0,1).toUpperCase()+$a.slice(1);context.prototype[$a]=0,context.prototype["get"+$b]=gFn($a),context.prototype["set"+$b]=sFn($a)}},TimeSpan=function(days,hours,minutes,seconds,milliseconds){if(1===arguments.length&&"number"==typeof days){var orient=0>days?-1:1,millsLeft=Math.abs(days);this.setDays(Math.floor(millsLeft/864e5)*orient),millsLeft%=864e5,this.setHours(Math.floor(millsLeft/36e5)*orient),millsLeft%=36e5,this.setMinutes(Math.floor(millsLeft/6e4)*orient),millsLeft%=6e4,this.setSeconds(Math.floor(millsLeft/1e3)*orient),millsLeft%=1e3,this.setMilliseconds(millsLeft*orient)}else this.set(days,hours,minutes,seconds,milliseconds);return this.getTotalMilliseconds=function(){return 864e5*this.getDays()+36e5*this.getHours()+6e4*this.getMinutes()+1e3*this.getSeconds()},this.compareTo=function(time){var t1=new Date(1970,1,1,this.getHours(),this.getMinutes(),this.getSeconds()),t2;return t2=null===time?new Date(1970,1,1,0,0,0):new Date(1970,1,1,time.getHours(),time.getMinutes(),time.getSeconds()),t2>t1?-1:t1>t2?1:0},this.equals=function(time){return 0===this.compareTo(time)},this.add=function(time){return null===time?this:this.addSeconds(time.getTotalMilliseconds()/1e3)},this.subtract=function(time){return null===time?this:this.addSeconds(-time.getTotalMilliseconds()/1e3)},this.addDays=function(n){return new TimeSpan(this.getTotalMilliseconds()+864e5*n)},this.addHours=function(n){return new TimeSpan(this.getTotalMilliseconds()+36e5*n)},this.addMinutes=function(n){return new TimeSpan(this.getTotalMilliseconds()+6e4*n)},this.addSeconds=function(n){return new TimeSpan(this.getTotalMilliseconds()+1e3*n)},this.addMilliseconds=function(n){return new TimeSpan(this.getTotalMilliseconds()+n)},this.get12HourHour=function(){return this.getHours()>12?this.getHours()-12:0===this.getHours()?12:this.getHours()},this.getDesignator=function(){return this.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator},this.toString=function(format){this._toString=function(){return null!==this.getDays()&&this.getDays()>0?this.getDays()+"."+this.getHours()+":"+this.p(this.getMinutes())+":"+this.p(this.getSeconds()):this.getHours()+":"+this.p(this.getMinutes())+":"+this.p(this.getSeconds())},this.p=function(s){return s.toString().length<2?"0"+s:s};var me=this;return format?format.replace(/dd?|HH?|hh?|mm?|ss?|tt?/g,function(format){switch(format){case"d":return me.getDays();case"dd":return me.p(me.getDays());case"H":return me.getHours();case"HH":return me.p(me.getHours());case"h":return me.get12HourHour();case"hh":return me.p(me.get12HourHour());case"m":return me.getMinutes();case"mm":return me.p(me.getMinutes());case"s":return me.getSeconds();case"ss":return me.p(me.getSeconds());case"t":return(me.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator).substring(0,1);case"tt":return me.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator}}):this._toString()},this};addSetFuncs(TimeSpan,attrs.slice(2)),TimeSpan.prototype.set=function(days,hours,minutes,seconds,milliseconds){this.setDays(days||this.getDays()),this.setHours(hours||this.getHours()),this.setMinutes(minutes||this.getMinutes()),this.setSeconds(seconds||this.getSeconds()),this.setMilliseconds(milliseconds||this.getMilliseconds())},Date.prototype.getTimeOfDay=function(){return this.getMilliseconds()+1e3*this.getSeconds()+6e4*this.getMinutes()+36e5*this.getHours()},Date.prototype.hasTimeOfDay=function(){return 0!==this.getHours()||0!==this.getMinutes()||0!==this.getSeconds()||0!==this.getMilliseconds()},Date.prototype.isRepeatDate=function(){return!1},Date.TimeSpan=TimeSpan,"undefined"!=typeof window&&(window.TimeSpan=TimeSpan)}(),function(){var attrs=["years","months","days","hours","minutes","seconds","milliseconds"],gFn=function(attr){return function(){return this[attr]}},sFn=function(attr){return function(val){return this[attr]=val,this}},addSetFuncs=function(context,attrs){for(var i=0;i<attrs.length;i++){var $a=attrs[i],$b=$a.slice(0,1).toUpperCase()+$a.slice(1);context.prototype[$a]=0,context.prototype["get"+$b]=gFn($a),context.prototype["set"+$b]=sFn($a)}},setMonthsAndYears=function(orient,d1,d2,context){function inc(){d1.addMonths(-orient),context.months++,12===context.months&&(context.years++,context.months=0)}if(1===orient)for(;d1>d2;)inc();else for(;d2>d1;)inc();context.months--,context.months*=orient,context.years*=orient},adjustForDST=function(orient,startDate,endDate){var hasDSTMismatch=!1==(startDate.isDaylightSavingTime()===endDate.isDaylightSavingTime());hasDSTMismatch&&1===orient?startDate.addHours(-1):hasDSTMismatch&&startDate.addHours(1)},TimePeriod=function(years,months,days,hours,minutes,seconds,milliseconds){if(7===arguments.length)this.set(years,months,days,hours,minutes,seconds,milliseconds);else if(2===arguments.length&&arguments[0]instanceof Date&&arguments[1]instanceof Date){var startDate=arguments[0].clone(),endDate=arguments[1].clone(),orient=startDate>endDate?1:-1;this.dates={start:arguments[0].clone(),end:arguments[1].clone()},setMonthsAndYears(orient,startDate,endDate,this),adjustForDST(orient,startDate,endDate);var diff=endDate-startDate;if(0!==diff){var ts=new TimeSpan(diff);this.set(this.years,this.months,ts.getDays(),ts.getHours(),ts.getMinutes(),ts.getSeconds(),ts.getMilliseconds())}}return this};addSetFuncs(TimePeriod,attrs),TimePeriod.prototype.set=function(years,months,days,hours,minutes,seconds,milliseconds){this.setYears(years||this.getYears()),this.setMonths(months||this.getMonths()),this.setDays(days||this.getDays()),this.setHours(hours||this.getHours()),this.setMinutes(minutes||this.getMinutes()),this.setSeconds(seconds||this.getSeconds()),this.setMilliseconds(milliseconds||this.getMilliseconds())},Date.TimePeriod=TimePeriod,"undefined"!=typeof window&&(window.TimePeriod=TimePeriod)}(),define("date",function(){}),define("globals",["ko","platform","util","date"],function(ko,platform,util){function murmurhash3_32_gc(key,seed){var remainder,bytes,h1,h1b,c1,c2,k1,i;for(remainder=3&key.length,bytes=key.length-remainder,h1=seed,c1=3432918353,c2=461845907,i=0;bytes>i;)k1=255&key.charCodeAt(i)|(255&key.charCodeAt(++i))<<8|(255&key.charCodeAt(++i))<<16|(255&key.charCodeAt(++i))<<24,++i,k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1,h1=h1<<13|h1>>>19,h1b=5*(65535&h1)+((5*(h1>>>16)&65535)<<16)&4294967295,h1=(65535&h1b)+27492+(((h1b>>>16)+58964&65535)<<16);switch(k1=0,remainder){case 3:k1^=(255&key.charCodeAt(i+2))<<16;case 2:k1^=(255&key.charCodeAt(i+1))<<8;case 1:k1^=255&key.charCodeAt(i),k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1}return h1^=key.length,h1^=h1>>>16,h1=2246822507*(65535&h1)+((2246822507*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>13,h1=3266489909*(65535&h1)+((3266489909*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>16,h1>>>0}function sanitizePaneState(stateObj){try{for(var stateOut=JSON.parse(JSON.stringify(stateObj)),i=0;i<stateOut.length;++i)""!==stateOut[i].search&&(stateOut[i].search="HasSearch");return JSON.stringify(stateOut)}catch(err){return"Failed to sanitize pane state"}}function sanitizeLocalSettings(settingsIn){try{var settingsOut=JSON.parse(settingsIn);return delete settingsOut.paneState,delete settingsOut.gdocTitle,settingsOut}catch(err){return"Failed to parse settings"}}function sanitizeKey(keyIn){switch(keyIn){case KeyCode.BackSpace:return"BACKSPACE";case KeyCode.Delete:return"DELETE";case KeyCode.Enter:return"ENTER";case KeyCode.Escape:return"ESCAPE";default:return"CHAR"}}function sanitizeURL(url){return url.replace(/&?access_token=[^&]*/g,"")}function getExtraReportData(info){platform.getUserPlatformConfig(info)}function rollbarIgnoreFn(isUncaught,args,payload){return rollbarIgnoreFiles.indexOf(payload.data.body.trace.frames[0].filename)>=0?!0:!1}function generateRemoteDebugKey(){var user=self.settings.get(Settings.activeUser);return user?"MooDoRDebug"+(new Date).getTime()+"_"+user:"Unknown"}function wrapFn(func){function wrapper(){try{return func.apply(this,arguments)}catch(err){self.reportError(err)}}return wrapper}function tagEvent(e,info,handlers){e.id||(e.id=eventID++)}function fnCatch(cb){try{self.PAssert(1534,cb,"Must specify a callback")}catch(PERR){g.reportError(PERR)}return function dbgCatch(){try{if(cb)return cb.apply(void 0,arguments)}catch(err){self.reportError(err,arguments)}}}function readyStateCallback(e,callback,error){e.onloadDone=!1,e.onload=function(){e.onloadDone=!0,callback&&callback()},e.onreadystatechange=function(){"loaded"!==e.readyState||e.onloadDone||(e.onloadDone=!0,callback&&callback())},error&&(e.onrror=error)}function makeString(args){for(var str="",i=0;i<args.length;++i)str+=" "+self.safeStringify(args[i]);return str}function selectBeforeComponent(range,node,fnName){var prevComponent=getPrevComponent(node),isPrevSelectable=isComponentSelectable(prevComponent);if(isPrevSelectable)range[fnName](prevComponent,getComponentNodeLength(prevComponent));else{var newTarget=document.createTextNode("");node.parentNode.insertBefore(newTarget,node),range[fnName](newTarget,0)}}function selectAfterComponent(range,node,fnName){var nextComponent=getNextComponent(node),isNextSelectable=isComponentSelectable(nextComponent);if(isNextSelectable)range[fnName](nextComponent,0);else{var newTarget=document.createTextNode("");node.parentNode.insertBefore(newTarget,void 0),range[fnName](newTarget,0)}}function getComponentNodeLength(node){try{self.PAssert(1554,isComponentNode(node),"Supplied node must be a valid component")}catch(PERR){g.reportError(PERR)}return self.hasClass(node,"plugin")?1:1===node.length&&node.textContent===TextSpace?0:node.length}function _getComponentNodes(arr,node){if(node)if(isComponentNode(node))arr.push(node);else if(node.childNodes)for(var i=0;i<node.childNodes.length;++i){var el=node.childNodes[i];_getComponentNodes(arr,el)}}function getComponentNodesIn(element){if(isComponentNode(element))return[element];var nodes=[];return _getComponentNodes(nodes,element),nodes}function isComponentNode(node){var isComponent=!1;return node&&(node.nodeType===Node.TEXT_NODE||self.hasClass(node,"plugin"))&&(isComponent=!0),isComponent}function isComponentSelectable(node){try{self.PAssert(1555,!node||isComponentNode(node),"Must either be an invalid node (not-selectable) or a component")}catch(PERR){g.reportError(PERR)}var isSelectable=!1;return node&&node.nodeType===Node.TEXT_NODE&&(isSelectable=!0),isSelectable}function getPrevComponent(node){try{self.PAssert(1556,node,"Must supply a valid node")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1557,isComponentNode(node),"Supplied node must be a valid component itself")}catch(PERR){g.reportError(PERR)}var prevNode=node.previousSibling;try{self.PAssert(1558,!prevNode||isComponentNode(prevNode),"Siblings must always be valid components")}catch(PERR){g.reportError(PERR)}return prevNode}function getNextComponent(node){try{self.PAssert(1559,node,"Must supply a valid node")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1560,isComponentNode(node),"Supplied node must be a valid component itself")}catch(PERR){g.reportError(PERR)}var nextNode=node.nextSibling;try{self.PAssert(1561,!nextNode||isComponentNode(nextNode),"Siblings must always be valid components")}catch(PERR){g.reportError(PERR)}return nextNode}function getFirstComponentNodeIn(cNode){if(cNode){if(isComponentNode(cNode))return cNode;for(var i=0;i<cNode.childNodes.length;++i){var tNode=getFirstComponentNodeIn(cNode.childNodes[i]);if(tNode)return tNode}}}function getLastComponentNodeIn(cNode){if(cNode){if(isComponentNode(cNode))return cNode;for(var i=cNode.childNodes.length-1;i>=0;--i){var tNode=getLastComponentNodeIn(cNode.childNodes[i]);if(tNode)return tNode}}}function notifyPTNInsert(ptn){try{self.PAssert(1562,ptn,"Must have a valid PTN to insert")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1563,ptn.nodeType===Node.TEXT_NODE,"Must be correct node type")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1564,ptn.nodeValue===TextSpace,"Must have valid text content for a PTN")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1565,activePTNList.indexOf(ptn)<0,"Should not insert the same PTN multiple times")}catch(PERR){g.reportError(PERR)}activePTNList.push(ptn);try{self.PAssert(1566,activePTNList.length<=2,"Should only have a single PTN active/inserted at any given point in time",activePTNList.length)}catch(PERR){g.reportError(PERR)}}function notifyPTNRemove(ptn){try{self.PAssert(1567,ptn,"Must have a valid PTN to remove")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1568,ptn.nodeType===Node.TEXT_NODE,"Must be correct node type")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1569,!ptn.parentNode||ptn.nodeValue.indexOf(TextSpace)>=0,"Must have an instance of TextSpace present or have been removed from the DOM")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1570,activePTNList.indexOf(ptn)>=0,"Should always supply a valid PTN")}catch(PERR){g.reportError(PERR)}activePTNList.remove(ptn);try{self.PAssert(1571,activePTNList.length<=1,"After removal should have no nodes left in active list",activePTNList.length)}catch(PERR){g.reportError(PERR)}}function verifyValidPTN(ptn){try{self.PAssert(1572,ptn,"Must have a valid PTN to verify")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1573,ptn.nodeType===Node.TEXT_NODE,"Must be correct node type")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1574,ptn.nodeValue===TextSpace,"Must have valid text content for a PTN")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1575,activePTNList.indexOf(ptn)>=0,"PTN must be in the valid list")}catch(PERR){g.reportError(PERR)}}function setCurrentPTN(ptn){try{self.PAssert(1576,!ptn||!currentPlaceholderTextNode,"Should never be overwriting the PTN")}catch(PERR){g.reportError(PERR)}currentPlaceholderTextNode=ptn}function getPTN(){return currentPlaceholderTextNode}function isPTNActive(){return!platform.isFirefox}function getOffsetChildElement(element,offset){if(isComponentNode(element)){try{self.PAssert(1596,isComponentSelectable(element),"Component must be selectable")}catch(PERR){g.reportError(PERR)}return{element:element,offset:offset}}for(var totalOffset=0,children=getComponentNodesIn(element),i=0;i<children.length;++i){var childLength=getComponentNodeLength(children[i]);if(totalOffset+childLength>=offset)return{element:children[i],offset:offset-totalOffset};totalOffset+=childLength}try{self.PAssert(1595,!1,"Unable to find offset child element")}catch(PERR){g.reportError(PERR)}return void 0}function getElementLength(element){for(var children=getComponentNodesIn(element),total=0,i=0;i<children.length;++i)total+=getComponentNodeLength(children[i]);return total}function hasValidClass(el){return self.hasClass(el,"text")||"androidInput"===el.id&&android.isEnabled()}function isItemValidForPass(item,isTest){return item?isTest?item.lastFindPass===currentFindPass:item.lastFindPass<currentFindPass:!1}function markItemForPass(item,isTest){if(item){var isItemValid=isItemValidForPass(item,isTest);try{self.PAssert(1616,isItemValid,"Item should always be valid")}catch(PERR){g.reportError(PERR)}return item.lastFindPass=currentFindPass,isItemValid}return!1}function _getPreviousItem(item,pane,options){var found,isTest=options&&options.isTest,ignoreSearch=options&&options.ignoreSearch,sameLevel=options&&options.sameLevel,includeNotes=options&&options.includeNotes;if(!markItemForPass(item,isTest))return void 0;var prev=item.parent();if(!prev)return void 0;if(item.isNote())return item.parent();var index=prev.getChildIndex(item);if(index>0){for(;!found;){for(var newChild=!1,i=index-1;i>=0;i--){var prevChild=prev.getChild(i),isChildValid=markItemForPass(prevChild,isTest);if(!isChildValid){try{self.PAssert(1618,!1,"Invalid child found during findPreviousItem")}catch(PERR){g.reportError(PERR)}return void 0}if(sameLevel||!prevChild.hasChildren()||prevChild.isCollapsed()){if(ignoreSearch||!pane||!self.hasClass(prevChild.getElement(pane.id),"hidden")){found=prevChild,newChild=!0;break}}else if(ignoreSearch||!pane||!self.hasClass(prevChild.getElement(pane.id),"hidden")){prev=prevChild,index=prevChild.numChildren(),newChild=!0;break}}newChild||(found=prev)}try{self.PAssert(1619,isTest||!found||found.isCollapsed()||item===_getNextItem(found,pane,{isTest:!0,ignoreSearch:ignoreSearch,sameLevel:sameLevel}),"Previous/Next should always match")}catch(PERR){g.reportError(PERR)}}else sameLevel||(found=item.parent());return includeNotes&&found&&found.hasNote()&&(found=found.getNote()),found}function _getNextItem(item,pane,options){var next,isTest=options&&options.isTest,ignoreSearch=options&&options.ignoreSearch,sameLevel=options&&options.sameLevel,includeNotes=options&&options.includeNotes;if(!item)return void 0;if(includeNotes&&item.hasNote())return item.getNote();if(item.isNote()&&(item=item.parent()),!sameLevel&&item.hasChildren()&&!item.isCollapsed())for(var numChildren=item.numChildren(),i=0;numChildren>i;++i){var candidate=item.getChild(i),isChildValid=markItemForPass(candidate,isTest);if(!isChildValid){try{self.PAssert(1621,!1,"Invalid child found during findNextItem A")}catch(PERR){g.reportError(PERR)}return void 0}if(ignoreSearch||!pane||!self.hasClass(candidate.getElement(pane.id),"hidden")){next=candidate,options&&options.numLevels++;break}}for(var cItem=item;!next;){var isParentValid=markItemForPass(cItem,isTest);if(!isParentValid){try{self.PAssert(1622,!1,"Invalid parent found during findNextItem B")}catch(PERR){g.reportError(PERR)}break}var parent=cItem.parent();if(!parent)break;var index=parent.getChildIndex(cItem),numChildren=parent.numChildren();if(!parent.isCollapsed())for(var i=index+1;numChildren>i;++i){var candidate=parent.getChild(i);try{self.PAssert(1623,!pane||candidate.getElement(pane.id),"next element should be visible in pane")}catch(PERR){g.reportError(PERR)}var isChildValid=markItemForPass(candidate,isTest);if(!isChildValid){try{self.PAssert(1624,!1,"Invalid child found during findNextItem C")}catch(PERR){g.reportError(PERR)}return void 0}if(ignoreSearch||!pane||!self.hasClass(candidate.getElement(pane.id),"hidden")){next=candidate;break}}if(cItem=parent,options&&!next&&options.numLevels--,sameLevel||pane&&cItem===pane.item())break}try{self.PAssert(1625,isTest||!next||item===_getPreviousItem(next,pane,{isTest:!0,ignoreSearch:ignoreSearch,sameLevel:sameLevel}),"Previous/Next should always match")}catch(PERR){g.reportError(PERR)}return next}function performScroll(){var minSpeed=0,maxSpeedAdd=6,scroller=lastState.pane.getScroller(),diff=minSpeed+maxSpeedAdd*lastState.speed;scroller.scrollTop+=diff,runScroll&&requestAnimationFrame(performScroll)}function safeSelectMultiline(startContainer,startOffset,endContainer,endOffset){var safeStartContainer,safeStartOffset=0,safeEndContainer,safeEndOffset=0;try{self.PAssert(1650,startContainer.nodeType!==Node.COMMENT_NODE,"Should never have start selection in comment node")}catch(PERR){g.reportError(PERR)}if(isComponentNode(startContainer))safeStartContainer=startContainer,safeStartOffset=startOffset;else{try{self.PAssert(1651,startContainer.childNodes.length>0,"Must be able to have a valid text node as an ancestor")}catch(PERR){g.reportError(PERR)}0===startContainer.childNodes.length?isPTNActive()?(safeStartContainer=document.createTextNode(TextSpace),startContainer.appendChild(safeStartContainer),notifyPTNInsert(safeStartContainer)):(safeStartContainer=document.createTextNode(""),startContainer.appendChild(safeStartContainer)):startOffset<startContainer.childNodes.length?(safeStartContainer=getFirstComponentNodeIn(startContainer.childNodes[startOffset]),safeStartOffset=0):(safeStartContainer=getFirstComponentNodeIn(startContainer.childNodes[startOffset-1]),safeStartOffset=getComponentNodeLength(safeStartContainer))}try{self.PAssert(1652,endContainer.nodeType!==Node.COMMENT_NODE,"Should never have end selection in comment node")}catch(PERR){g.reportError(PERR)}if(isComponentNode(endContainer))safeEndContainer=endContainer,safeEndOffset=endOffset;else{try{self.PAssert(1653,endContainer.childNodes.length>0,"Must be able to have a valid text node as an ancestor")}catch(PERR){g.reportError(PERR)}0===endContainer.childNodes.length?isPTNActive()?(safeEndContainer=document.createTextNode(TextSpace),endContainer.appendChild(safeEndContainer),notifyPTNInsert(safeEndContainer)):(safeEndContainer=document.createTextNode(""),endContainer.appendChild(safeEndContainer)):endOffset<endContainer.childNodes.length?(safeEndContainer=getFirstComponentNodeIn(endContainer.childNodes[endOffset]),safeEndOffset=0):(safeEndContainer=getFirstComponentNodeIn(endContainer.childNodes[endOffset-1]),safeEndOffset=getComponentNodeLength(safeEndContainer))}try{self.PAssert(1654,isComponentNode(safeStartContainer),"Must have a valid component to select to start at")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1655,isComponentNode(safeEndContainer),"Must have a valid component for select to end at")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1656,isComponentSelectable(safeStartContainer),"Must have a selectable component to start at")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1657,isComponentSelectable(safeEndContainer),"Must have a selectable component to end at")}catch(PERR){g.reportError(PERR)}self.selectMultiline(safeStartContainer,safeStartOffset,safeEndContainer,safeEndOffset)}function searchVMLIArray(options,array){for(var i=0;i<array.length;++i)options.comparator?options.comparator(array[i])&&options.action(array[i]):options.each&&options.each(array[i]),options.item=array[i],self.searchVMLIs(options)}function getMapping(obj,map){try{self.PAssert(1678,"string"!=typeof obj,"Should only pass objects to the obj mapping function",obj)}catch(PERR){g.reportError(PERR)}var target={};for(var i in obj){try{self.PAssert(1679,obj.hasOwnProperty(i),"This should always be the case, the prototype shouldn't be extended")}catch(PERR){g.reportError(PERR)}if(void 0!==obj[i]&&null!==obj[i]){var mappedField=map[i];if(mappedField)target[mappedField]=obj[i];else{try{self.PAssert(1680,!1,"Incoming field should be added to the field map",i)}catch(PERR){g.reportError(PERR)}target[i]=obj[i]
}}}return target}function fireKeyEventInternal(ele,etype,key){try{self.PAssert(1691,void 0!==key,"Must pass in valid key data to type")}catch(PERR){g.reportError(PERR)}if(ele||(ele=self.getSelectionNode(),!ele&&android.isEnabled()&&(ele=android.getCurrentSpan())),document.createEvent&&ele){var eventObj=document.createEvent("Event");eventObj.normCode=key.normCode,eventObj.shiftKey=!!key.shiftKey,eventObj.synthetic=!0,eventObj.initEvent(etype,!0,!0),ele.dispatchEvent(eventObj)}else if(ele)try{self.PAssert(1692,!1,"Unable to fire key event")}catch(PERR){g.reportError(PERR)}else try{self.PAssert(1693,!1,"No element available to fire key event on")}catch(PERR){g.reportError(PERR)}}function fireClickEventInternal(ele,etype,button,optData){try{self.PAssert(1694,void 0!==button,"Must pass in a valid button to click with")}catch(PERR){g.reportError(PERR)}if(ele||(ele=self.getSelectionNode(),!ele&&android.isEnabled()&&(ele=android.getCurrentSpan())),document.createEvent&&ele){var evObj=document.createEvent("Event");if(evObj.button=button,evObj.synthetic=!0,optData)for(var id in optData)evObj[id]=optData[id];evObj.initEvent(etype,!0,!0),ele.dispatchEvent(evObj)}else if(ele)try{self.PAssert(1695,!1,"Unable to fire click event")}catch(PERR){g.reportError(PERR)}else try{self.PAssert(1696,!1,"No element available to fire click event on")}catch(PERR){g.reportError(PERR)}}function loadDone(){document.removeEventListener("DOMContentLoaded",loadDone,!1),window.removeEventListener("load",loadDone,!1);for(var i=0;i<onLoadCallbacks.length;++i)onLoadCallbacks[i]();onLoadCallbacks=void 0}function generateQueryString(data){var queryString="";if("object"==typeof data){var queryArr=[];for(var key in data)queryArr[queryArr.length]=encodeURIComponent(key)+"="+encodeURIComponent(data[key]);queryString=queryArr.join("&").replace(/%20/g,"+")}else{try{self.PAssert(1728,"string"==typeof data,"Only Objects or Strings are currently supported")}catch(PERR){g.reportError(PERR)}queryString=data}return queryString}function ensureStatsXHR(url){var sanitizedURL=sanitizeURL(url);return __xhrRequests[sanitizedURL]||(__xhrRequests[sanitizedURL]={requests:0,retries:0,failures:0}),__xhrRequests[sanitizedURL]}function notifyStatsXHRRequest(url){var stats=ensureStatsXHR(url);stats.requests++}function notifyStatsXHRRetry(url){var stats=ensureStatsXHR(url);stats.retries++}function notifyStatsXHRFailure(url){var stats=ensureStatsXHR(url);stats.failures++}function notifyXHR(xhr){var notifier;if(notifier=shouldNotifyXHR(xhr.url)){xhr.iid=idXHR++;var _rsc=xhr.onreadystatechange;xhr.onreadystatechange=function(){_rsc&&_rsc(),notifier(this)}}}function shouldNotifyXHR(url){return notifyURLs[url.split("?")[0]]}var self={vmMain:void 0,vmDebug:void 0,topBarHeight:platform.android?48:44,topBoxHeight:platform.phone?48:150,keyboardToolbarHeight:40,itemTextPadding:5,hasFocus:!0,zoomTime:0,demoMode:!1,intro:void 0,focusedPane:void 0,focusedItem:void 0,isScrolling:!1,ClickThreshold:5,isFirstRun:!1,topLevelInitId:void 0,isReconnected:!1,noLocalWrites:!1,isLoadingRemote:!1,canRevealMenu:!0,revealingMenu:!1,isKeyboardOpen:!1,dragging:void 0,draggingHidden:void 0,dragStartInfo:{x:0,y:0},dragStartTimeout:void 0,startDrag:void 0,itemMenuOpenedOn:void 0,errorPlatformInfo:void 0,nativeBacklog:[],nativeBridge:{sendToApp:function(method,data){self.nativeBacklog.push({method:method,data:data})}},elements:{},SPThresholdLeft:8,SPThresholdRight:32,MobileSideTapThreshold:40,MobileSideTapThresholdKeyboardOpen:15};self.paneTop=platform.mobile?self.topBarHeight:98,self.itemPaddingStart=platform.phone?24:30,self.itemPaddingIncrement=20,self.outlinePaddingStart=platform.phone?34:30,self.outlinePaddingIncrement=18;var android={isEnabled:function(){return!!platform.android}};require(["android"],function(droidLoad){android=droidLoad});var VMLI;require(["VMLI"],function(VMLILoad){VMLI=VMLILoad});var VMPane;require(["VMPane"],function(VMPaneLoad){VMPane=VMPaneLoad}),window.KeyCode={BackSpace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Escape:27,Space:32,PageUp:33,PageDown:34,Hash:35,Home:36,LeftArrow:37,UpArrow:38,RightArrow:39,DownArrow:40,Delete:46,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D8:56,Colon:58,LAngle:60,RAngle:62,At:64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,I:73,L:76,N:78,O:79,S:83,U:85,V:86,Y:89,Z:90,LeftMeta:91,RightMeta:93,NumPlus:107,F4:115,Equals:187,Comma:188,Dash:189,Period:190,Slash:191,Tilde:192,LBracket:219,RBracket:221,Apos:222},window.ButtonCode={None:-1,Left:0,Middle:1,Right:2},window.TextSpace="﻿",window.AttachChar=" ",window.EmbedAttachChar=" ",self.PhoneWidth=480,window.DriveStatus={Offline:0,Connecting:1,Saving:2,Saved:3,Reconnecting:4},window.PaneMode={Normal:"PaneNormal",Timeline:"PaneTimeline"},window.MessageAction={Default:0,Reload:1,LoginScreen:2,Demo:3,ResetClient:4,None:5,SyncContacts:6,OpenURL:7,Okay:8,Blog:9,Undo:10,Contact:11,OpenSettings:12},window.MessageType={Info:0,Warning:1,Error:2,Fatal:3,Subtitle:4,Intro:5,RequiredUpdate:6,InfoGray:7},window.MessageID={Undefined:0,ConnectionError:1,OfflineUndo:2,FatalError:3,DocChange:4,OfflineWarn:5,OnlineInfo:6,CacheReset:7,RequiredUpdate:8,Updated:9,SyncContacts:10,ExitDemo:11,Reauthorize:12,ShareFailure:13,ThisIsDemo:14},window.VMLIFlag={None:0,Header:1,Collapsed:2,Selected:4,Highlighted:8,NumList:16,Note:32,Multiline:64,Complete:4096,P2:8192,P1:16384,P0:32768,Starred:65536,HasPageToken:131072},window.UninitializedVersion=-1,window.VersionType={Structure:1,Text:2},window.SaveFlag={None:0,Prop:1,Text:2,All:3},window.RepeatFreq={Once:0,Daily:1,Weekly:2,Monthly:3,DayOfMonth:4,Yearly:5,EndOfMonthOffset:6,NthMonthInst:7},window.DateType={Once:1,Repeat:2},window.ChangeType={None:0,Local:1,Remote:2,Auto:4,Text:1073741824,Property:2147483648,All:3221225472,AllLocal:3221225473},window.PropChangeType={None:0,Date:2,Complete:4,Archive:8,Starred:16,Priority:32,All:63},window.LoginState={NONE:0,LOGGED_OUT:1,LOGGED_IN:2},window.ReturnValue={Success:0,Error:1,FatalError:2},window.OAuthSchemeType={Invalid:-1,None:0,Web:1,Native:2,Count:2},window.ACProvider={None:0,Contact:1,DatePicker:2,DateList:3,Tag:4,Search:5},window.DataSource={Paste:1,Drop:2,Plugin:3},window.DropEffect={Copy:"copy",Move:"move"},window.PluginID={Contacts:"Contacts",Drive:"Drive",Mailbird:"Mailbird",Gmail:"Gmail"},window.PluginLoad={Preview:1,Full:2,Runtime:4},window.PluginDependency={DriveAPI:"DriveAPI",GmailAPI:"GmailAPI",GoogleLogin:"GoogleLogin",PremiumSub:"PremiumSub"},window.PluginRenderTypes={Generic:0,StyledText:1,UnstyledText:2,AutocompleteText:3},window.PluginRenderers={DriveFile:0,EmailThread:1},window.PerPaneStateField={Element:"element",OutlineElement:"oelement",Collapsed:"collapsed",Hidden:"hidden",HiddenOutline:"hiddenOutline"},window.Modals={ReportBug:"reportBug",ImportData:"importData",ExportData:"exportData",ShareDoc:"shareDoc",MobileSettings:"mobileSettings",Settings:"settings",Confirm:"confirm",Alert:"alert"},window.PremiumStatus={Unknown:0,Never:1,Trial:2,TrialOver:3,Active:4,PastDue:5,CanceledUser:6,CanceledPastDue:7},window.DataChangeType={Add:1,Remove:2,Change:3},self.isFlagSet=function isFlagSetFn(data,mask){return(data&mask)===mask},self.isOneFlagSet=function isOneFlagSetFn(data,mask){var mmv=data&mask;return 0!==mmv&&0===(mmv&mmv-1)},self.isAtLeastOneFlagSet=function isAtLeastOneFlagSetFn(data,mask){return 0!==(data&mask)},self.PCFMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Complete|VMLIFlag.Starred,self.PCMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Complete,self.PFMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Starred,self.PMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2,self.fieldMapIn={id:"id",items:"i",archivedItems:"ai",text:"t",modifiedOffline:"l",modifiedOfflineText:"o",versionText:"u",version:"v",formats:"f",isArchived:"a",isDeleted:"x",isCollapsed:"m",note:"n",isNote:"k",date:"d",dateText:"s",allDayDate:"ad",repeatDate:"r",dateCreated:"c",dateCompleted:"^",priority:"p",isComplete:"z",isStarred:"*"},self.priorityMapOut={},self.priorityMapOut[VMLIFlag.None]=" ",self.priorityMapOut[VMLIFlag.P0]=" p0",self.priorityMapOut[VMLIFlag.P1]=" p1",self.priorityMapOut[VMLIFlag.P2]=" p2",window.NumListPrefix="#.",window.NumListPrefixOther="1.",window.DatePrefix="@",window.ContactPrefix="+",window.TagPrefix="#";var charMapHTML={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};self.escape=function escapeFn(text){return String(text).replace(/[&\"<>]/g,function(c){return charMapHTML[c]})},self.trimPunc=function trimPuncFn(str){return str.replace(/[:,\.\'\"\)\]]$/g,"")},self.getTransitionClass=function getTransitionClassFn(time){var trans;switch(time){case 50:trans="trans05";break;case 100:trans="trans1";break;case 200:trans="trans2";break;case 300:trans="trans3";break;case 400:trans="trans4";break;case 500:trans="trans5";break;case 1e3:trans="trans10";break;default:console.log("ERROR: no time for ",time)}return trans},self.setTransformStyle=function setTransformStyleFn(element,x,y){try{self.PAssert(1487,element,"Must provide a valid element")}catch(PERR){g.reportError(PERR)}if(element){try{self.PAssert(1488,void 0!==x,"Must supply a valid X offset")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1489,void 0!==y,"Must supply a valid Y offset")}catch(PERR){g.reportError(PERR)}element.style[platform.transform.style]=platform.ie?"translate("+x+"px, "+y+"px)":"translate3d("+x+"px, "+y+"px, 0px)"}},self.setTransitionStyle=function setTransitionStyleFn(element,property,time,easing){try{self.PAssert(1490,element,"Must provide a valid element")}catch(PERR){g.reportError(PERR)}element&&(easing=easing||"ease",element.style[platform.transition.style]=property+" "+time+"ms "+easing,setTimeout(function(){element.style[platform.transition.style]=""},time))};var IE_ANIM_WORKAROUND=!1;self.setTransform=function setTransformFn(element,x,y,time,easing){time>0?IE_ANIM_WORKAROUND?self.setTransformStyle(element,x,y):(self.setTransitionStyle(element,platform.transform.prop,time,easing),self.setTransformStyle(element,x,y)):x||y?self.setTransformStyle(element,x,y):element.style[platform.transform.style]="none"},self.reload=function reloadFn(){try{self.PAssert(1491,!appCacheUpdating,"Page should not be reloaded while waiting for an appcache update to finish.")}catch(PERR){g.reportError(PERR)}appCacheUpdating&&self.reportError(new Error("Page requesting reload while waiting for AppCache update.")),window.location.reload()},self.isSetupPageOpen=!1,self.isMainPageOpen=!1,self.openMainPage=function openMainPageFn(){self.isSetupPageOpen&&(self.isSetupPageOpen=!1),self.isMainPageOpen||(self.isMainPageOpen=!0);var outer=document.getElementById("outerWrapper"),setup=document.getElementById("setupWrapper");outer&&setup&&(self.removeClass(outer,"none"),self.addClass(setup,"none"))},self.openSetupPage=function openSetupPageFn(){self.isMainPageOpen&&(self.isMainPageOpen=!1),self.addClass(document.getElementById("outerWrapper"),"none"),self.removeClass(document.getElementById("setupWrapper"),"none")};var wasAppCacheUpdated=!1,appCacheUpdating=!1;self.setAppCacheUpdateState=function setAppCacheUpdateStateFn(state){appCacheUpdating=state,state&&(wasAppCacheUpdated=!0)},self.isEmpty=function isEmptyFn(object){for(var i in object)return!1;return!0},self.isEmail=function isEmailFn(string){var regex=new RegExp(/.+@.+\..+/i),results=regex.exec(string);return!!results},self.removeDOM=function removeDOMFn(id){var domElem=document.getElementById(id);try{self.PAssert(1492,domElem,"DOM Element must exist to remove it")}catch(PERR){g.reportError(PERR)}domElem&&domElem.parentNode.removeChild(domElem)},self.isRunningScript=function isRunningScriptFn(){return self.AScript&&self.AScript.isRunning};var isOffline=!1;self.goOnline=function goOnlineFn(){isOffline=!1},self.goOffline=function goOfflineFn(){isOffline=!0},self.isOffline=function isOfflineFn(){return isOffline},self.preventLocalWrites=function preventLocalWritesFn(){ShouldLog(LogLevels.Warning)&&log("---- WARNING: Local Writes Disabled ----"),self.noLocalWrites=!0},self.shouldWriteLocal=function shouldWriteLocalFn(){return!self.noLocalWrites},self.enableDemoMode=function enableDemoModeFn(){self.demoMode=!0;var dmode=util.getURLParam("dmode");dmode&&self.enableMinMode(dmode),self.preventLocalWrites()},self.isDemoMode=function isDemoModeFn(){return self.demoMode},window.DisplayMode={Default:0,NoTopBar:1,NoPaneHeaders:2,ForceTwoPane:4,NoScrollbars:8,NoBackground:16,NoPaneTop:32,NoInteraction:64,NoPanePadding:128,NoPaneStyle:256,NoRightClick:512,ShowDemoExit:1024,FullMin:4095},self.activeDisplayMode=DisplayMode.Default,self.isDisplayModeActive=function isDisplayModeActiveFn(mode){return(self.activeDisplayMode&mode)===mode},self.enableMinMode=function enableMinModeFn(mode){try{if(self.addClass(document.body,"minMode"),mode=parseInt(mode),platform.touch||(mode&DisplayMode.NoTopBar&&self.addClass(document.documentElement,"noTopBar"),mode&DisplayMode.NoPaneHeaders&&self.addClass(document.body,"noPaneHeaders"),mode&DisplayMode.NoPaneTop&&self.addClass(document.body,"noPaneTopBox"),mode&DisplayMode.NoPaneStyle&&self.addClass(document.body,"noPaneStyle")),mode&DisplayMode.NoPanePadding&&self.addClass(document.body,"noPanePadding"),mode&DisplayMode.NoScrollbars&&self.addClass(document.body,"noScrollbars"),mode&DisplayMode.NoBackground){var html=document.getElementsByTagName("html")[0];try{self.PAssert(1493,html,"Must have a valid HTML element")}catch(PERR){g.reportError(PERR)}html&&self.addClass(html,"noBackground")}if(mode&DisplayMode.NoInteraction){var grabber=document.getElementById("preventInteraction");grabber&&(self.removeClass(grabber,"none"),grabber.addEventListener("mousewheel",function(e){return e.stopImmediatePropagation(),!1},!0),grabber.addEventListener("mousedown",function(e){return e.preventDefault(),e.stopImmediatePropagation(),!1},!0),grabber.addEventListener("keydown",function(e){return e.preventDefault(),e.stopImmediatePropagation(),!1},!0))}mode&DisplayMode.ShowDemoExit&&setTimeout(function(){self.messageQueue.pushMessage(MessageID.ExitDemo)},0),self.activeDisplayMode=parseInt(mode)}catch(err){self.reportError(err)}},self.sendEvent=function sendEventFn(category,action,value){try{self.PAssert(1494,void 0===value||self.isNumber(value),"Values must be numeric")}catch(PERR){g.reportError(PERR)}if(window.ga&&!self.isDemoMode())try{ga("send","event",category,action,self.getAnonUserIdentifier(),value)}catch(err){self.reportError(err,"Category: "+category+" Action: "+action+" Value: "+value)}},self.sendTimeEvent=function sendTimeEventFn(category,variable,value){try{self.PAssert(1495,self.isNumber(value),"Values must be numeric")}catch(PERR){g.reportError(PERR)}if(window.ga&&!self.isDemoMode())try{ga("send","timing",category,variable,value,self.getAnonUserIdentifier())}catch(err){self.reportError(err,"Category: "+category+" Variable: "+variable+" Value: "+value)}};var currentTimeEvent;self.startTimeEvent=function startTimeEventFn(category,variable){if(window.log&&window.log.now){try{self.PAssert(1496,void 0===currentTimeEvent,"This function needs to be updated to allow nested timing events")}catch(PERR){g.reportError(PERR)}currentTimeEvent={startTime:log.now(),category:category,variable:variable}}},self.endTimeEvent=function endTimeEventFn(){if(window.log&&window.log.now){try{self.PAssert(1497,void 0!==currentTimeEvent,"Must have started a timing event")}catch(PERR){g.reportError(PERR)}if(currentTimeEvent){var elapsedTime=log.now()-currentTimeEvent.startTime;self.sendTimeEvent(currentTimeEvent.category,currentTimeEvent.variable,elapsedTime),currentTimeEvent=void 0}}};var aggregateEvents={};self.registerEvent=function registerEventFn(name,category,action){try{self.PAssert(1498,!aggregateEvents.hasOwnProperty(name),"Should only register an event once")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1499,void 0!==name,"Must specify a name for the event")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1500,void 0!==category,"Must specify a category for the event")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1501,void 0!==action,"Must specify an action for the event")}catch(PERR){g.reportError(PERR)}var registerEvent={category:category,action:action,label:self.getAnonUserIdentifier(),count:0};aggregateEvents[name]=registerEvent},self.aggregateEvent=function aggregateEventFn(name,count){try{self.PAssert(1502,aggregateEvents.hasOwnProperty(name),"Must register an event before using it")}catch(PERR){g.reportError(PERR)}void 0===count&&(count=1),aggregateEvents[name]&&(aggregateEvents[name].count+=count)};var isPageDataCleared=!1;self.pageDataCleared=function pageDataClearedFn(){isPageDataCleared=!0},self.onunload=function onunloadFn(){log("Unloading the page");try{for(var evName in aggregateEvents){var ev=aggregateEvents[evName];self.sendEvent(ev.category,ev.action,ev.count),ev.count=0}if(self.vmMain&&self.vmMain.failedGapiLoad?self.sendEvent("ScriptLoad","GapiFailed"):gapiCalled||self.sendEvent("ScriptLoad","GapiNotLoaded"),self.vmMain&&self.vmMain.paneManager.updatePaneScrollState(),isPageDataCleared)self.vmMain&&self.vmMain.pluginManager&&self.vmMain.pluginManager.onShutdown(!1);else{self.vmMain&&self.vmMain.pluginManager&&self.vmMain.pluginManager.onShutdown(!0);try{var gdata=require("gdata");gdata&&self.settings.set(Settings.lastServerVersion,gdata.getServerVersion())}catch(err){}}if(self.isLoadingRemote)return"We are still syncing your changes, are you sure you want to exit?"}catch(errOutside){self.reportError(errOutside)}},platform.demo||(window.onbeforeunload=self.onunload);var lastSetLoginState=LoginState.LOGGED_OUT;self.getLoginState=function getLoginStateFn(){var state=lastSetLoginState;if(self.shouldWriteLocal())try{var savedState=util.storage.getItem("loginState");null!==savedState&&void 0!==savedState&&(state=parseInt(savedState))}catch(err){self.reportError(err)}try{self.PAssert(1503,state===LoginState.NONE||state===LoginState.LOGGED_OUT||state===LoginState.LOGGED_IN,"Invalid login state set")}catch(PERR){g.reportError(PERR)}return state},self.setLoginState=function setLoginStateFn(value){try{self.PAssert(1504,null!==value&&void 0!==value&&!isNaN(value),"Should always be a valid LoginState enum value")}catch(PERR){g.reportError(PERR)}if(lastSetLoginState=value,self.shouldWriteLocal())try{(isNaN(value)||null===value||void 0===value)&&(value=LoginState.LOGGED_OUT);try{self.PAssert(1505,value===LoginState.NONE||value===LoginState.LOGGED_OUT||value===LoginState.LOGGED_IN,"Invalid login state set")}catch(PERR){g.reportError(PERR)}util.storage.setItem("loginState",value)}catch(err){self.reportError(err)}};var noSync,syncReport,snapshots;self.applyBindings=function applyBindingsFn(model,eleID){var elem=document.getElementById(eleID);try{self.PAssert(1521,model,"A valid model must be defined when apply bindings")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1522,elem,"A valid element must be defined when apply bindings")}catch(PERR){g.reportError(PERR)}if(elem&&model)try{ko.applyBindings(model,elem)}catch(err){throw err.message+=" | Binding on: "+self.elementToString(elem),self.reportError(err),err}else{var errStr="Invalid model or element passed to applyBindings | ";errStr+=elem?"NoModel - Elem: "+self.elementToString(elem):model?"NoElem - Elem: #"+eleID:"NoModelNoElem - Elem: #"+eleID,self.reportError(new Error(errStr))}},ko.bindingHandlers.load={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel,context){try{self.PAssert(1523,viewModel,"Must always be passing in a valid view model to load - "+self.elementToString(element))}catch(PERR){g.reportError(PERR)}try{self.PAssert(1524,viewModel.onLoad,"If no load function is specified, remove the binding from the template - "+self.elementToString(element))}catch(PERR){g.reportError(PERR)}var pIndex=context.$parents.length-2,paneRoot;pIndex>=0&&(paneRoot=context.$parents[pIndex]),viewModel&&viewModel.onLoad&&viewModel.onLoad(element,paneRoot)}},ko.bindingHandlers.check={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){var obs=valueAccessor();obs()&&self.addClass(element,"checked"),self.setupClick(element,viewModel,{onClick:function onClickFn(e){obs(!obs()),obs()?self.addClass(element,"checked"):self.removeClass(element,"checked"),e.preventDefault(),e.stopPropagation()}})},update:function updateFn(element,valueAccessor){var obs=valueAccessor();obs()?self.addClass(element,"checked"):self.removeClass(element,"checked")}};var onRippleTap={timeout:0,onStart:function onStartFn(e){e.pressedAlready||(this.pressed=!0,e.pressedAlready=!0,this.timeout=setTimeout(function(){self.addClass(this,"pressed"),this.pressed||setTimeout(function(){self.removeClass(this,"pressed")}.bind(this),60)}.bind(this),120))},onFirstMove:function onFirstMoveFn(){this.pressed&&(clearTimeout(this.timeout),self.removeClass(this,"pressed"),this.pressed=!1)},onEnd:function onEndFn(){this.pressed&&(self.removeClass(this,"pressed"),this.pressed=!1)}};ko.bindingHandlers.ripple={init:function initFn(element){self.setupClick(element,void 0,onRippleTap)}},ko.bindingHandlers.tap={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){self.setupClick(element,viewModel,valueAccessor())}},ko.bindingHandlers.stopBinding={init:function initFn(){return{controlsDescendantBindings:!0}}},ko.bindingHandlers.possHTML={init:function initFn(){return{controlsDescendantBindings:!0}},update:function updateFn(element,valueAccessor,allBindingsAccessor,viewModel){viewModel.isStyled?element.innerHTML=ko.utils.unwrapObservable(valueAccessor()):element.textContent=ko.utils.unwrapObservable(valueAccessor())}},ko.bindingHandlers.tooltip={init:function initFn(element,valueAccessor){platform.mobile||self.setupMouseOver(element,ko.utils.unwrapObservable(valueAccessor()),!1)},update:function updateFn(element,valueAccessor){platform.mobile||self.setupMouseOver(element,ko.utils.unwrapObservable(valueAccessor()),!0)}},self.setupMouseOver=function setupMouseOverFn(element,value,isUpdate){try{self.PAssert(1525,!platform.mobile)}catch(PERR){g.reportError(PERR)}self.tooltip?isUpdate?self.tooltip.update(element,value):self.tooltip.register(element,value):self.reportError(new Error("Tooltips registered before VMTooltip created"))},"function"!=typeof String.prototype.startsWith&&(Object.defineProperty?Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function valueFn(searchString,position){return position=position||0,this.lastIndexOf(searchString,position)===position}}):String.prototype.startsWith=function(str){return 0===this.lastIndexOf(str,0)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(str){return-1!==this.indexOf(str,this.length-str.length)}),"function"!=typeof String.prototype.prevIndexOf&&(String.prototype.prevIndexOf=function(ch,offset){for(var idx=-1,i=offset-1;i>=0;--i)if(this[i]===ch){idx=i;break}return idx}),ko.bindingHandlers.css2=ko.bindingHandlers.css,self.findFirstDiff=function findFirstDiffFn(str1,str2,ignoreCase){if(!str1)return str2.length;if(!str2)return str1.length;for(var minLen=Math.min(str1.length,str2.length),i=0;minLen>i;++i)if(ignoreCase){if(str1.charAt(i).toLowerCase()!==str2.charAt(i).toLowerCase())return i}else if(str1.charAt(i)!==str2.charAt(i))return i;return Math.max(str1.length,str2.length)},self.findMatchingLength=function findMatchingLengthFn(str1,str2,ignoreCase){if(!str1||!str2)return 0;for(var minLen=Math.min(str1.length,str2.length),i=0;minLen>i;++i)if(ignoreCase){if(str1.charAt(i).toLowerCase()!==str2.charAt(i).toLowerCase())return i}else if(str1.charAt(i)!==str2.charAt(i))return i;return minLen},self.TEMP_PREFIX="~T^";var idx=0;self.generateTempId=function generateTempIdFn(){return self.TEMP_PREFIX+Date.now()+ ++idx},self.isTempId=function isTempIdFn(id){return id[0]===self.TEMP_PREFIX[0]&&id[1]===self.TEMP_PREFIX[1]&&id[2]===self.TEMP_PREFIX[2]},self.isLocalItem=function isLocalItemFn(item){try{self.PAssert(1526,item.id,"All items should have an ID even if it is a temp one")}catch(PERR){g.reportError(PERR)}return self.isTempId(item.id)},self.getClientInfo=function getClientInfoFn(cb){self.XHR({type:"GET",url:"http://api.hostip.info/get_json.php",cb:function cbFn(xhr){if(200===xhr.status){var clientInfo=JSON.parse(xhr.responseText);cb(clientInfo)}else cb({ip:"Unknown"})}})},self.requestNotification=function requestNotificationFn(platform){var reqForm=document.forms.requestNotification,reqResult=document.getElementById("notificationResult"),email=reqForm.email.value;return void 0===email||null===email||email.length<5?reqResult.innerText="Please enter a valid email address.":self.XHR_PrivateAPI({type:"POST",path:"/feedback/notification",data:{email:email,platform:platform},cb:function cbFn(xhr){200===xhr.status?(reqForm.email.value="",reqResult.innerText="Thanks for your interest!"):reqResult.innerText="There was an error processing your request, please try again in a few minutes."}}),!1};var cachedID;self.getUserIdentifier=function getUserIdentifierFn(){if(!cachedID){var goog=require("goog"),user=goog.getCurrentUserEmail()||self.settings.get(Settings.activeUser);if(!user)return"Unknown";cachedID=user}return cachedID};var anonID;self.getAnonUserIdentifier=function getAnonUserIdentifierFn(){if(!anonID){var userID=self.getUserIdentifier();anonID=userID[0]+userID[1]+userID[2]+murmurhash3_32_gc(userID,17124123)}return anonID},self.introHash=function introHashFn(str){return murmurhash3_32_gc(str,347236113)},self.getAppStats=function getAppStatsFn(obj){obj.numItems=window.__TOTAL_ITEMS,obj.numArchivedItems=window.__TOTAL_ARCHIVED_ITEMS,obj.numArchiveParents=window.__TOTAL_ARCHIVE_PARENTS,obj.parseTextCalls=window.__PARSE_TEXT_TOTAL_CALLS,obj.notificationUpdatesFull=window.__FULL_NOTIFICATION_UPDATES,obj.notificationUpdatesSingle=window.__SINGLE_NOTIFICATION_UPDATES,obj.XHRStats=self.getXHRStats(),self.vmMain&&self.vmMain.pluginManager&&(obj.pluginStats=self.vmMain.pluginManager.getStats()),DETAILED_STATS&&(obj.previewCacheStats=gdata.getPreviewCacheStats())},self.getRunningState=function getRunningStateFn(obj){var paneState;try{paneState=self.vmMain.paneManager.getPaneState()}catch(err){log("Failed to get paneState")}obj.isDebug=!1,obj.isDemo=self.isDemoMode(),obj.localWrites=self.shouldWriteLocal(),obj.isReconnected=self.isReconnected,obj.url=sanitizeURL(window.location.href),obj.paneState=sanitizePaneState(paneState),obj.localSettings=sanitizeLocalSettings(self.settings.getRawSettings()),obj.loginState=self.getLoginState(),obj.checkpoints=window.__checkpoints,obj.gapiLoadError=gapiLoadError,obj.jsVersion=window.__jsVersion,obj.htmlVersion=document.body.getAttribute("ver"),obj.windowWidth=window.innerWidth,obj.windowHeight=window.innerHeight,obj.selection=self.parseExtra(window.getSelection()),obj.eventStream=self.getEventStream(),obj.trackerStream=self.getTrackerStream(),obj.screenManager=self.ScreenManager?self.ScreenManager.activeScreen:"UNDEFINED",obj.criticalErrorReported=self.criticalErrorReported();try{obj.errorPlatformInfo=JSON.stringify(self.errorPlatformInfo)}catch(err){obj.errorPlatformInfo="ERROR"}try{android&&android.isEnabled()&&(obj.currentKeyboard=android.getActiveKeyboard())}catch(err){obj.currentKeyboard="ERROR"}try{obj.validScreens=JSON.stringify(window.Screens)}catch(err){obj.validScreens="ERROR"}obj.rootId=self.vmMain?self.vmMain.root()?self.vmMain.root().id:"Undefined Root":"VMMain Not Initialized"},self.getPremiumInfo=function getPremiumInfoFn(obj){if(self.billingManager){var premiumInfo={isEnabled:self.billingManager.isPremiumEnabled(),premiumStatus:self.billingManager.getPremiumStatus(),billingIdentifier:self.billingManager.getBillingIdentifier(),btRequested:self.billingManager._braintreeRequested,btLoaded:self.billingManager._braintreeLoaded,ctRequested:self.billingManager._clientTokenRequested,ctLoaded:self.billingManager._clientTokenLoaded};obj.premiumInfo=premiumInfo}else obj.premiumInfo="Billing Manager Not Loaded"},self.getAppInfo=function getAppInfoFn(obj){var gapiStatus="Loaded";self.vmMain&&self.vmMain.failedGapiLoad?gapiStatus="ErrorLoading":gapiCalled||(gapiStatus="NotLoaded"),obj.gapiStatus=gapiStatus,obj.sessionID=window.__SESSION_ID,obj.appCacheUpdated=wasAppCacheUpdated,platform.getPlatformInfo(obj),self.getRunningState(obj),self.getAppStats(obj),self.getPremiumInfo(obj),require("gdata").getState(obj),require("goog").getUserName(obj)},self.reportSignup=function reportSignupFn(email,info){try{self.PAssert(1527,email,"Must specify a valid email address to signup with")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1528,info,"Must provide valid signup info in addition to an email address")}catch(PERR){g.reportError(PERR)}email&&info&&(info.email=email,getExtraReportData(info),self.XHR_PrivateAPI({type:"POST",path:"/tracking/signup",data:info,cb:function cbFn(xhr){200!==xhr.status&&ShouldLog(LogLevels.Error)&&log("Failed to report signup",xhr.responseText,xhr)}}))},self.reportLogin=function reportLoginFn(email){try{self.PAssert(1529,email,"Must specify a valid email address to login with")}catch(PERR){g.reportError(PERR)}if(email){var info={email:email};getExtraReportData(info),self.XHR_PrivateAPI({type:"POST",path:"/tracking/login",data:info,cb:function cbFn(xhr){200!==xhr.status&&ShouldLog(LogLevels.Error)&&log("Failed to report login",xhr.responseText,xhr)}})}};var hasCriticalError=!1;self.criticalErrorReported=function criticalErrorReportedFn(){return hasCriticalError},self.handleCriticalError=function handleCriticalErrorFn(){hasCriticalError=!0;try{if(self.isDemoMode())self.reload();else{var errorNode=document.createElement("div");errorNode.id="criticalError",errorNode.textContent="There was a critical error while loading the app, "+platform.actionVerb()+" to reload.",platform.isTouchDevice?errorNode.addEventListener(platform.touchStartEvent,function(){self.reload()},!0):errorNode.addEventListener(platform.upEvent,function(){self.reload()},!0),self.prependChild(document.body,errorNode),self.removeDOM("outerWrapper"),self.removeDOM("setupWrapper"),self.removeDOM("templates")}}catch(err){self.reportError(err)}},self.safeStringify=function safeStringifyFn(obj){try{return JSON.stringify(obj)}catch(err){}},self.reportEvent=function reportEventFn(e){if(!self.isDemoMode()){var eventString=self.parseExtra(e);eventString&&self.eventStream.push(eventString)}},self.getEventStream=function getEventStreamFn(){return self.eventStream.ordered()},window.__getEventStream=self.getEventStream,self.getTrackerStream=function getTrackerStreamFn(){try{var tracker=require("tracker");return tracker.stringifyGroups()}catch(err){log("Error getting tracker stream: ",err.message)}},self.parseExtra=function parseExtraFn(extra){var extraString;if(extra)try{var info;if(extra instanceof window.KeyboardEvent){var targetEle=self.elementToString(extra.target||extra.srcElement),skipElements=["[INPUT#importPW]","[INPUT#importEmail]","[TEXTAREA#bugDescription.bugDescription editable]"];skipElements.indexOf(targetEle)<0&&(info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),target:targetEle,keyCode:sanitizeKey(extra.keyCode),normCode:sanitizeKey(extra.normCode),ctrlKey:extra.ctrlKey,shiftKey:extra.shiftKey,metaKey:extra.metaKey,altKey:extra.altKey,tstamp:Date.now()})}else if(extra instanceof window.MouseEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),clientX:extra.clientX,clientY:extra.clientY,ctrlKey:extra.ctrlKey,shiftKey:extra.shiftKey,metaKey:extra.metaKey,altKey:extra.altKey,which:extra.which,button:extra.button,tstamp:Date.now()};else if(window.TouchEvent&&extra instanceof window.TouchEvent){info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),tstamp:Date.now()};var touch=extra.touches[0];touch&&(info.clientX=touch.clientX,info.clientY=touch.clientY)
}else if(window.PointerEvent&&extra instanceof window.PointerEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),clientX:extra.clientX,clientY:extra.clientY,tstamp:Date.now()};else if(extra instanceof window.Event)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),tstamp:Date.now()};else if(extra instanceof window.Selection)if(0===extra.rangeCount)info={rangeCount:0};else{var range=self.getSelectionRange(),startElement=range.startContainer,startWasTextNode=!1,startElementLength=0,endElement=range.endContainer,endWasTextNode=!1,endElementLength=0;startElement.nodeType===Node.TEXT_NODE&&(startElementLength=startElement.length,startElement=startElement.parentNode,startWasTextNode=!0),startElement&&self.hasClass(startElement,"text")&&(startElementLength=getElementLength(startElement)),endElement.nodeType===Node.TEXT_NODE&&(endElementLength=endElement.length,endElement=endElement.parentNode,endWasTextNode=!0),endElement&&self.hasClass(endElement,"text")&&(startElementLength=getElementLength(endElement)),info={rangeCount:extra.rangeCount,startContainer:self.getElementPath(startElement),startWasTextNode:startWasTextNode,startOffset:range.startOffset,startElementLength:startElementLength,endContainer:self.getElementPath(endElement),endWasTextNode:endWasTextNode,endOffset:range.endOffset,endElementLength:endElementLength}}else info=extra;extraString=info?self.safeStringify(info):void 0}catch(err){log("Error parsing extra "+err.message)}return extraString},window.__jsVersion="1425962929343";var rollbarIgnoreFiles=["http://a.visadd.com/script/layer"];require(["goog"],function(){Rollbar.configure({payload:{environment:platform.getDeployVar(DeployVariable.Environment),person:{id:self.getUserIdentifier()},client:{javascript:{source_map_enabled:!0,code_version:__jsVersion,guess_uncaught_frames:!0}}},checkIgnore:rollbarIgnoreFn})}),window.__MAX_ERRORS_REPORTED=40;var numReported=0,isRollbarConfigured=!1;self.handleJSError=function handleJSErrorFn(msg,stack,extra,noMsg,errorLevel){function reportError(){if(numReported++,numReported<=window.__MAX_ERRORS_REPORTED){var appInfo={};self.getAppInfo(appInfo),appInfo.numReported=numReported;var data={url:sanitizeURL(window.location.href),logs:logs,info:appInfo,user:user,extra:extraString,jsVersion:window.__jsVersion,htmlVersion:document.body.getAttribute("ver")};if(window.Rollbar){var errObj={message:msg,stack:stack};errorLevel===LogLevels.Error?Rollbar.error(errObj,data):errorLevel===LogLevels.Warning&&Rollbar.warning(errObj,data)}else data.msg=msg,data.stack=stack,self.XHR_PrivateAPI({type:"POST",path:"/feedback/error",data:data,cb:function cbFn(xhr){200!==xhr.status?log("Failed to report remote error",xhr.responseText,xhr):log("Reported Remote Error: ",xhr.responseText)}})}}if(noMsg||console.error("JS Error: "+msg,"  Stack: ",stack,"  Extra: ",extra),msg||stack){errorLevel||(errorLevel=LogLevels.Error);try{var logs=window.__LOG_BUFFER.ordered().join("\r\n"),user=self.getUserIdentifier();isRollbarConfigured||("Unknown"!==user&&(isRollbarConfigured=!0),Rollbar.configure({payload:{person:{id:user}},checkIgnore:rollbarIgnoreFn}));var extraString=self.parseExtra(extra);"Unknown"!==user?reportError():self.getClientInfo(function(info){info&&(user=info.ip),reportError()})}catch(err){log("Badness happened reporting errors to server: ",err)}}else;},window.onerror=function(errorMsg,url,lineNumber,colNumber,errorObj){errorObj?(log("Reported Global OnError: "+errorMsg+" Script: "+url+" Line: "+lineNumber+" Column: "+colNumber),self.reportError(errorObj)):(log("Unreported Global OnError: "+errorMsg+" Script: "+url+" Line: "+lineNumber+" Column: "+colNumber),self.reportError(errorMsg))},self.reportError=function reportErrorFn(err,extra,errorLevel){!err||extra||err.message||err.stack?err&&err.e&&self.isString(err.e)&&(err={message:err.e,stack:self.getCurrentStack("")}):(extra=err,err=void 0),err||(err={message:"Undefined error passed to reporter",stack:self.getCurrentStack("")}),self.handleJSError(err.message,err.stack,extra,!1,errorLevel)},window.__SendInfo=function(text){return self.handleJSError("Remote Client Info",void 0,text,!0),"Thank you for providing your client info!"},window.__CreateDebugSession=function(key){if(window.remote)return"Debug session already started";var debugKey=key||generateRemoteDebugKey();window.rcon=window.console,self.handleJSError("Remote Debug Session",void 0,debugKey,!0),self.addScript("http://jsconsole.com/remote.js?"+debugKey,"rDebugScript");var profileRunning=!1,profileIndex=0,profileName="";return window.rdbg={startProfile:function startProfileFn(forceName){try{return profileRunning?"Profiler already running":(profileName=forceName?forceName:"RDBGProfile_"+profileIndex,window.rcon.profile(profileName),profileRunning=!0,"Profiler Started: "+profileName)}catch(err){return"Error starting profile: "+err.message}},stopProfile:function stopProfileFn(){try{if(profileRunning){window.rcon.profileEnd(profileName),profileRunning=!1;var retString="Profile Completed: "+profileName;return profileName="",profileIndex++,retString}return"Profiler not running, use startProfile()"}catch(err){return"Error stopping profile: "+err.message}}},"Your remote debug session has started: "+debugKey},(util.hasURLParam("rsession")||util.hasURLParam("rdebug","true"))&&setTimeout(function(){var useKey=util.getURLParam("rsession")||generateRemoteDebugKey();window.__CreateDebugSession(useKey),log("%c---- REMOTE DEBUGGING ENABLED: "+useKey+" ----","color: green")},2e3),window.Checkpoint={MainRun:1,RequireLoaded:2,PageLoad:4,LocalDocLoad:8,InitData:16,DBLoaded:32,OnInitializedData:64,InitializeMain:128,LoadDefaultFile:256,MaskRequired:511},self.checkpoint=function checkpointFn(chk){window.__checkpoints|=chk},self.hasSentLowMemoryWarning=ko.observable(!1),self.handleLowMemory=function handleLowMemoryFn(e){self.hasSentLowMemoryWarning()||(self.hasSentLowMemoryWarning(!0),log("Low Memory Event: ",e),self.isNumber(e)&&(e=Math.round(e/1024/1024)+"MB"))};var fnRegex=/function\s+([^(]*?)\s*\(([^)]*)\)/,supportSimpleStack=!0;self.getCurrentStack=function getCurrentStackFn(message){var msg;if(supportSimpleStack||platform.noErrorStacks)try{msg=JSON.stringify(message)}catch(err){log("Error stringifying stack message",err,message)}if(supportSimpleStack){var err=new Error(msg||message);if(err.stack)return err.stack}supportSimpleStack=!1;try{for(var callstack=["GenError: "+(msg||message)],currentFunction=arguments.callee.caller,DEPTH_LIMIT=75,depth=0;currentFunction&&depth++<DEPTH_LIMIT;){var fn=currentFunction.toString(),fnMatch=fnRegex.exec(fn),fnName;fnName=fnMatch&&3===fnMatch.length&&""!==fnMatch[1]&&void 0!==fnMatch[1]?"at "+fnMatch[1]+"("+fnMatch[2].replace(/[\r\n]/g,"")+")":fnMatch&&3===fnMatch.length?"at <anonymous> ("+fnMatch[2].replace(/[\r\n]/g,"")+")":"at <anonymous> (<unknown>)",callstack.push(fnName),currentFunction=currentFunction.caller}return callstack.join("\n")}catch(err2){log("Error generating stack trace",err2)}return""};var remoteUpdateWait=12e5,lastUpdateTime=0;self.checkForRemoteChanges=function checkForRemoteChangesFn(){var currentTime=Date.now();if(lastUpdateTime-currentTime>=remoteUpdateWait)try{self.AppCache&&self.AppCache.checkForUpdate(),self.vmMain&&self.vmMain.vmPicker&&self.vmMain.vmPicker.refreshFiles()}catch(err){self.reportError(err)}finally{lastUpdateTime=currentTime}},self.createRingBuffer=function createRingBufferFn(len){var p=0,b=[],limit=len;return{get:function getFn(i){return b[i]},push:function pushFn(e){b[p]=e,p=(limit+p+1)%limit},count:function countFn(){return p},reset:function resetFn(){p=0,b=[]},buffer:function bufferFn(){return b},limit:function limitFn(lim){limit=lim},ordered:function orderedFn(){return b.slice(p).concat(b.slice(0,p))},entries:function entriesFn(){for(var arr=this.ordered(),i=0;i<arr.length;++i)console.log("---- Entry ["+i+"] ----"),console.log(arr[i])}}},function wrapAsyncCallbacks(){var _helper=function _helperFn(fnName){var originalFn=window[fnName];window[fnName]=function wrapAsyncFn(){var args=Array.prototype.slice.call(arguments),originalCallback=args[0];return"function"==typeof originalCallback&&(args[0]=wrapFn(originalCallback)),originalFn.apply?originalFn.apply(this,args):originalFn(args[0],args[1])}};_helper("setTimeout"),_helper("setInterval")}();var logBufferLength=platform.mobile?30:50;window.__LOG_BUFFER=self.createRingBuffer(logBufferLength);var oldLog=window.log,logErrorReported;self.isDemoMode()||(window.log=function(){try{window.__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," "))}catch(err){window.__LOG_BUFFER.push(Date.now()+": Invalid Log Arguments")}console.log.apply(console,arguments)},window.__log=function(){try{window.__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," "))}catch(err){window.__LOG_BUFFER.push(Date.now()+": Invalid Log Arguments")}});for(var i in oldLog)window.log[i]=oldLog[i];self.isFunction=function isFunctionFn(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)},self.isArray=function isArrayFn(obj){return"[object Array]"===Object.prototype.toString.call(obj)},self.isString=function isStringFn(obj){return"string"==typeof obj},self.isObject=function isObjectFn(obj){return"object"==typeof obj&&null!==obj},self.isNumber=function isNumberFn(obj){return"number"==typeof obj},self.isBoolean=function isBooleanFn(obj){return obj===!0||obj===!1},self.isValidChangeType=function isValidChangeTypeFn(changeType){if(void 0!==changeType&&null!==changeType){var type=changeType&~ChangeType.All;return type===ChangeType.None||self.isOneFlagSet(type,ChangeType.Local|ChangeType.Remote|ChangeType.Auto)}return!1},self.isRemoteChange=function isRemoteChangeFn(changeType){var type=changeType&~ChangeType.All;return self.isOneFlagSet(type,ChangeType.Remote)},self.isLocalChange=function isLocalChangeFn(changeType){var type=changeType&~ChangeType.All;return self.isFlagSet(type,ChangeType.Local)},self.enumToString=function enumToStringFn(en,value){for(var k in en)if(en[k]===value)return k;return null},self.elementToString=function elementToStringFn(ele,includeLength){if(ele){var nodeString=ele.nodeName;return ele.id&&(nodeString+="#"+ele.id),ele.className&&(nodeString+="."+ele.className.replace(/ /g,".")),includeLength&&ele.innerText&&(nodeString+=":"+ele.innerText.length),nodeString}return"UNDEFINED"},self.getElementPath=function getElementPathFn(ele,includeLength){var isFirst=!0,path="";try{for(;ele!==document.documentElement&&ele!==document.body;)path+=isFirst?self.elementToString(ele,includeLength)+" ":self.elementToString(ele)+" ",isFirst=!1,ele=ele.nodeType===Node.TEXT_NODE?ele.parentNode:ele.parentElement}catch(err){path+=err.message}return path},self.highlightElement=function highlightElementFn(ele,horizOffset,vertOffset){try{self.PAssert(1530,ele,"Must have a valid element to highlight")}catch(PERR){g.reportError(PERR)}if(ele){var horizP=horizOffset||.5,vertP=vertOffset||1,box=ele.getBoundingClientRect(),topOffset=box.top+box.height*vertP,leftOffset=box.left+box.width*horizP;self.showArrowAt(topOffset,leftOffset)}},self.showArrowAt=function showArrowAtFn(top,left){var arrow=document.getElementById("iarrow");try{self.PAssert(1532,arrow,"Must have a valid highlight arrow")}catch(PERR){g.reportError(PERR)}arrow.style.display="block";var extraOffset=platform.mobile?-35:0;arrow.style.top=top+extraOffset+"px",arrow.style.left=left+"px"},self.hideHighlightElement=function hideHighlightElementFn(){var arrow=document.getElementById("iarrow");try{self.PAssert(1533,arrow,"Must have a valid highlight arrow")}catch(PERR){g.reportError(PERR)}arrow.style.display="none"};var eventID,replaceFunction,dblClickTime=300;self.setupClick=function setupClickFn(obj,item,params){function move(e){var xThisFrame=e.eventX-this.lastX,yThisFrame=e.eventY-this.lastY;if(0!==xThisFrame||0!==yThisFrame){var firstMove=!this.moved;if(this.lastX=e.eventX,this.lastY=e.eventY,e.distanceX=this.distanceX=this.distanceX+Math.abs(xThisFrame),e.distanceY=this.distanceY=this.distanceY+Math.abs(yThisFrame),(this.moved||e.distanceX>self.ClickThreshold||e.distanceY>self.ClickThreshold)&&(this.moved=!0,e.moved=this.moved),(params.onMove||params.onFirstMove)&&(e.diffX=e.eventX-this.startX,e.diffY=e.eventY-this.startY,e.xThisFrame=xThisFrame,e.yThisFrame=yThisFrame,e.startX=this.startX,e.startY=this.startY,e.startClientX=this.startClientX,e.startClientY=this.startClientY,e.startSrc=this.startSrc,firstMove&&params.onFirstMove&&params.onFirstMove.call(item,e),params.onMove)){var handled=!1;handled=params.onMove.call(item,e),handled&&e.stopImmediatePropagation()}}}function end(e){e.srcElement||(e.srcElement=e.target);var now=Date.now(),lastTouch=this.lastTouch||now,delta=Math.max(0,now-lastTouch);this.numClicks?this.numClicks++:this.numClicks=1,e.moved=this.moved,e.timeDelta=delta,e.diffX=this.lastX-this.startX,e.diffY=this.lastY-this.startY,e.startX=this.startX,e.startY=this.startY,e.startSrc=this.startSrc,dblClickTime>delta&&delta>0&&params.onDblClick&&!this.moved&&params.onDblClick.call(item,e),isNaN(e.button)||0===e.button?(this.lastTouch=now,params.onClick&&!this.moved&&(params.onClick.call(item,e),self.globalClickHandler&&self.globalClickHandler(e))):1===e.button&&params.onMiddleClick&&!this.moved&&params.onMiddleClick.call(item,e),(isNaN(e.button)||0===e.button)&&params.onEnd&&params.onEnd.call(item,e),setTimeout(function(){this.lastTouch=void 0,this.numClicks=void 0}.bind(this),dblClickTime)}function cancel(e){params.onCancel&&params.onCancel.call(item,e)}function start(e){e.timeStart=this.timeStart=Date.now(),e.srcElement||(e.srcElement=e.target),this.startSrc=e.srcElement,this.moved=!1,e.startX=this.startX=e.eventX,e.startY=this.startY=e.eventY,e.startClientX=this.startClientX=e.clientX,e.startClientY=this.startClientY=e.clientY,this.lastX=e.eventX,this.lastY=e.eventY,this.distanceX=0,this.distanceY=0,(isNaN(e.button)||0===e.button)&&params.onStart&&params.onStart.call(item,e),isNaN(e.changeLastY)||(this.lastY+=e.changeLastY)}function touchMove(e){var touch=platform.ie?e:e.touches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,move.call(obj,e),e.returnFalse?!1:void 0}function touchUp(e){document.removeEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.removeEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.removeEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture);var touch=platform.ie?e:e.changedTouches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,gesture&&gesture.stop(),end.call(obj,e),e.returnFalse?!1:void 0}function touchCancel(e){return document.removeEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.removeEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.removeEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&gesture.stop(),cancel.call(obj,e),e.returnFalse?!1:void 0}function touchStart(e){if(!e.handled){this.lastInputTouch=!0;var touch=platform.ie?e:e.touches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,start.call(obj,e),e.ignore||(document.addEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.addEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.addEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&(log("Add Gesture Pointer: ",e.id,self.elementToString(e.target),self.elementToString(obj)),gesture.addPointer(e.pointerId))),e.returnFalse?!1:void 0}}function mouseMove(e){return this.lastInputTouch?void 0:(e.eventX=e.pageX,e.eventY=e.pageY,move.call(obj,e),e.returnFalse?!1:void 0)}function mouseUp(e){return e.handled||this.lastInputTouch?void 0:(document.removeEventListener(platform.moveEvent,mouseMoveHandler,useCapture),document.removeEventListener(platform.upEvent,mouseUpHandler,useCapture),0===e.button&&end.call(obj,e),e.returnFalse?!1:void 0)}function mouseDown(e){return e.handled||this.lastInputTouch?void 0:(this.lastInputTouch=!1,e.eventX=e.pageX,e.eventY=e.pageY,start.call(obj,e),e.ignore||(0===e.button&&document.addEventListener(platform.moveEvent,mouseMoveHandler,useCapture),document.addEventListener(platform.upEvent,mouseUpHandler,useCapture)),e.returnFalse?!1:void 0)}function contextMenu(e){e.handled||this.lastInputTouch||(e.srcElement||(e.srcElement=e.target),params.onRightClick&&params.onRightClick.call(item,e))}function killMousedown(e){return android.isEnabled()&&android.isTargetBox(e)||(e.preventDefault(),e.stopImmediatePropagation()),!1}try{self.PAssert(1535,obj,"Expecting an object to bind the click handlers to.")}catch(PERR){g.reportError(PERR)}if(!obj)return void log("Skipping setupClick because no valid DOM object was provided to bind to");item||(item=obj);var useCapture=!1;self.isFunction(params)?params={onClick:params}:params&&params.useCapture&&(useCapture=params.useCapture);var touchStartHandler=fnCatch(touchStart),touchMoveHandler=fnCatch(touchMove),touchEndHandler=fnCatch(touchUp),touchCancelHandler=fnCatch(touchCancel),gesture,mouseDownHandler=fnCatch(mouseDown),mouseMoveHandler=fnCatch(mouseMove),mouseUpHandler=fnCatch(mouseUp),contextMenuHandler=fnCatch(contextMenu);return platform.isTouchDevice&&platform.isMobileBrowser?obj.addEventListener(platform.touchStartEvent,touchStartHandler,useCapture):obj.addEventListener(platform.downEvent,mouseDownHandler,useCapture),platform.usePointerEvents&&platform.mobile&&obj.addEventListener("mousedown",killMousedown,useCapture),params.onRightClick&&!platform.mobile&&obj.addEventListener("contextmenu",contextMenuHandler,useCapture),this};var spinnerRunning=!1;self.StartSpinner=function StartSpinnerFn(){platform.mobile&&!spinnerRunning&&(spinnerRunning=!0,self.removeClass(document.getElementById("loading"),"hidden"))},self.StopSpinner=function StopSpinnerFn(){var spinner=document.getElementById("loading");spinnerRunning&&spinner&&self.addClass(document.getElementById("loading"),"hidden")},"function"!=typeof Array.prototype.pushOnlyUniques&&(Array.prototype.pushOnlyUniques=function(arr,comp){if(!arr)return this;for(var i=0,len=arr.length;len>i;++i){for(var isUnique=!0,u=0,len2=this.length;len2>u;++u)if(comp&&comp(arr[i],this[u])||!comp&&arr[i]===this[u]){isUnique=!1;break}isUnique&&this.push(arr[i])}return this}),"function"!=typeof Array.prototype.pushArray&&(Array.prototype.pushArray=function(arr){return this.push.apply(this,arr)}),"function"!=typeof Array.prototype.removeAt&&(Array.prototype.removeAt=function(from){return this.splice(from,1)[0]}),"function"!=typeof Array.prototype.remove&&(Array.prototype.remove=function(obj){var index=this.indexOf(obj);return index>=0&&this.removeAt.call(this,index),index}),"function"!=typeof Array.prototype.equals&&(Array.prototype.equals=function(array){if(!array)return!1;if(this.length!==array.length)return!1;for(var i=0,l=this.length;l>i;i++)if(this[i]instanceof Array&&array[i]instanceof Array){if(!this[i].equals(array[i]))return!1}else if(this[i]!==array[i])return!1;return!0}),"function"!=typeof Array.prototype.findInsertIndex&&(Array.prototype.findInsertIndex=function(ele,comp){try{self.PAssert(1537,void 0!==ele&&null!==ele,"Require a valid element to insert")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1538,comp,"Require a valid comparison function")}catch(PERR){g.reportError(PERR)}for(var low=0,high=this.length-1;high>=low;){var i=low+high>>1,c=comp(this[i],ele);if(0>c)low=i+1;else{if(!(c>0))return i;high=i-1}}return low}),"function"!=typeof Array.prototype.findSorted&&(Array.prototype.findSorted=function(ele,comp){var index=this.findInsertIndex(ele,comp);return 0===comp(this[index],ele)?this[index]:void 0}),"function"!=typeof Array.prototype.insertSorted&&(Array.prototype.insertSorted=function(ele,comp){var idx=this.findInsertIndex(ele,comp);return this.splice.apply(this,[idx,0,ele]),idx}),ko.observableArray.fn.insertSorted=function(ele,comp){this.valueWillMutate();var idx=this.peek().insertSorted(ele,comp);return this.valueHasMutated(),idx},self.clamp=function clampFn(val,min,max){return Math.max(min,Math.min(max,val))},self.randParam=function randParamFn(){return"?t="+Date.now()},self.createPath=function createPathFn(filename){return window.location.protocol+"//"+window.location.host+"/"+filename},self.addScript=function addScriptFn(filename,id,callback,error){try{self.PAssert(1539,!id||null===document.getElementById(id),"Should never include the same script ID multiple times")}catch(PERR){g.reportError(PERR)}var e=document.createElement("script");e.type="text/javascript",e.src=filename,id&&(e.id=id),callback&&readyStateCallback(e,callback,error),"undefined"!=typeof e&&document.getElementsByTagName("head")[0].appendChild(e)},self.addScriptHack=function addScriptHackFn(filename,id,callback,error){window.define.amd=void 0,self.addScript(filename,id,function(){window.define.amd={jQuery:!0},callback&&callback()},function(){window.define.amd={jQuery:!0},error&&error()})},self.addStylesheet=function addStylesheetFn(filename,callback,error){var e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=filename,callback&&readyStateCallback(e,callback,error),"undefined"!=typeof e&&document.getElementsByTagName("head")[0].appendChild(e)},self.PAssert=function PAssertFn(tag,value){if(!value){var assertExtra={isAssert:!0,tag:tag};try{var argString=makeString(Array.prototype.slice.call(arguments,2));log(arguments.length>2?"Assert Failure "+tag+": "+argString:"Assert Failure "+tag),self.reportError(new Error("Assert Failure: "+argString),assertExtra,LogLevels.Warning)}catch(err){log("Exception in PAssert "+tag+": ",err),self.reportError(err,assertExtra)}}},self.hasSelection=function hasSelectionFn(){return!!window.getSelection().anchorNode},self.getSelectionNode=function getSelectionNodeFn(){var selection=window.getSelection(),node=selection.anchorNode;return node?node.nodeType===Node.TEXT_NODE?node.parentNode:node:void 0},self.getCursorSelectionRange=function getCursorSelectionRangeFn(e){var range;if(document.caretRangeFromPoint)range=document.caretRangeFromPoint(e.clientX,e.clientY);else if(e.rangeParent)range=self.createSelectionRange(),range.setStart(e.rangeParent,e.rangeOffset);else try{self.PAssert(1540,!1,"Unable to get selection range at cursor")}catch(PERR){g.reportError(PERR)}return range},self.getCaretSelectionRange=function getCaretSelectionRangeFn(x,y){var range;if(document.caretRangeFromPoint)range=document.caretRangeFromPoint(x,y);else if(document.caretPositionFromPoint)range=document.caretPositionFromPoint(x,y);else try{self.PAssert(1541,!1,"Unable to create range for given XY coord")}catch(PERR){g.reportError(PERR)}return range},self.getSelectionRange=function getSelectionRangeFn(){var selection=window.getSelection();if(selection.rangeCount>0){var range=selection.getRangeAt(0),startComp,endComp;return range}return void 0},self.createSelectionRange=function createSelectionRangeFn(){return document.createRange()},self.setSelectionRange=function setSelectionRangeFn(range){var selection=window.getSelection();selection.removeAllRanges(),selection.addRange(range)},self.clearSelection=function clearSelectionFn(){var selection=window.getSelection();selection.removeAllRanges()},self.setSelectionValues=function setSelectionValuesFn(range,startEle,startOffset,endEle,endOffset){try{self.PAssert(1544,range,"Range must be supplied")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1545,isComponentNode(startEle),"Must be selecting a valid component")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1546,isComponentNode(endEle),"Must be selecting a valid component")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1547,startEle!==endEle||endOffset>=startOffset,"Select elements must be different, or selection must start before it ends")}catch(PERR){g.reportError(PERR)}if(startEle.nodeType===Node.TEXT_NODE)range.setStart(startEle,startOffset);else{try{self.PAssert(1548,self.hasClass(startEle,"plugin"),"Only other valid component is plugin")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1549,0===startOffset||1===startOffset,"Must eiter be selecting before or after the plugin")}catch(PERR){g.reportError(PERR)}0===startOffset?selectBeforeComponent(range,startEle,"setStart"):1===startOffset&&selectAfterComponent(range,startEle,"setStart")}if(endEle.nodeType===Node.TEXT_NODE)range.setEnd(endEle,endOffset);else{try{self.PAssert(1550,self.hasClass(endEle,"plugin"),"Only other valid component is plugin")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1551,0===endOffset||1===endOffset,"Must eiter be selecting before or after the plugin")}catch(PERR){g.reportError(PERR)}0===endOffset?selectBeforeComponent(range,endEle,"setEnd"):1===endOffset&&selectAfterComponent(range,endEle,"setEnd")}},self.getSelectionCoords=function getSelectionCoordsFn(){var sel=document.selection,range,rect,x,y;if(sel)"Control"!==sel.type&&(range=sel.createRange(),range.collapse(!0),x=range.boundingLeft,y=range.boundingTop);else if(window.getSelection&&(sel=window.getSelection(),sel.rangeCount)){range=sel.getRangeAt(0).cloneRange();var span=document.createElement("span");if(span.getClientRects){span.appendChild(document.createTextNode("​")),range.insertNode(span),rect=span.getClientRects()[0],rect&&(x=rect.left,y=rect.top);var spanParent=span.parentNode;spanParent.removeChild(span),spanParent.normalize(),range.startContainer===range.endContainer&&range.startOffset===range.endOffset&&getPTN()&&self.updateEditTextNode(spanParent)}}return{left:x,top:y}},self.computeSelectionLine=function computeSelectionLineFn(ele){var textStyle=window.getComputedStyle(ele),numLines=0,selLine=0;if(textStyle){var selCoords=self.getSelectionCoords(),eleOffset=self.offset(ele),caretLineOffset=8;numLines=Math.round(parseInt(textStyle.height)/parseInt(textStyle.lineHeight)),selLine=Math.round((selCoords.top-eleOffset.top-caretLineOffset)/parseInt(textStyle.lineHeight))}else ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::computeSelectionLine");try{self.PAssert(1552,!isNaN(numLines)&&!isNaN(selLine),"Must always have valid numbers",numLines,selLine)}catch(PERR){g.reportError(PERR)}return{current:selLine+1,total:numLines}},self.templateNameItem=function templateNameItemFn(item){var name;return name=item.isCollapsed()||0===item.items().length?"template-li-nochildren":item.hasPaginationToken()?"template-li-pagination":"template-li-modular"},self.getItemForElement=function getItemForElementFn(el){if(android.isEnabled()){var currentVMLI=android.getCurrentVMLI();if(currentVMLI)return currentVMLI}if(el&&el!==document.body){el.nodeType===Node.TEXT_NODE&&(el=el.parentNode);var vm=ko.dataFor(el);try{self.PAssert(1553,vm instanceof VMLI,"Should always be able to find a valid item for a given element")}catch(PERR){g.reportError(PERR)}return vm instanceof VMLI?vm:void 0}return void 0},self.getSelectedItem=function getSelectedItemFn(){var selection=window.getSelection();return self.getItemForElement(selection.anchorNode)};var activePTNList=[],currentPlaceholderTextNode;self.cleanupEditTextNode=function cleanupEditTextNodeFn(span){try{self.PAssert(1577,span,"Must be passing in a valid item span")}catch(PERR){g.reportError(PERR)}if(isPTNActive()&&getPTN()){try{self.PAssert(1578,getPTN().parentNode===span||!self.isAttachedToDoc(getPTN()),"Span must always be the parent of the placeholder")}catch(PERR){g.reportError(PERR)}var ptn=getPTN();try{if(notifyPTNRemove(ptn),ptn.parentNode){var parent=ptn.parentNode,range=self.getSelectionRange();if(range){var startItem=self.getItemForElement(range.startContainer),endItem=self.getItemForElement(range.endContainer);startItem.getSpan()!==span&&endItem.getSpan()!==span?parent.removeChild(ptn):ptn.nodeValue=""}else parent.removeChild(ptn)}}catch(err){self.reportError(err)}setCurrentPTN(void 0)}},self.setupEditTextNode=function setupEditTextNodeFn(span){try{self.PAssert(1579,span,"Must be passing in a valid item span")}catch(PERR){g.reportError(PERR)}if(!isPTNActive())return!1;try{self.PAssert(1580,!getPTN(),"Must not have a valid PTN yet")}catch(PERR){g.reportError(PERR)}var didOverride=!1,range=self.getSelectionRange();if(range){var overrideComponent=self.getPluginForElement(range.commonAncestorContainer);if(range.commonAncestorContainer===span||overrideComponent){try{self.PAssert(1581,range.startOffset===range.endOffset,"Range selection should not create new text nodes")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1582,range.startContainer===range.endContainer,"Multiple item select should not create new text nodes")}catch(PERR){g.reportError(PERR)}var components=getComponentNodesIn(span),selectStartComponent=overrideComponent?getNextComponent(overrideComponent):components[range.startOffset];if(selectStartComponent&&isComponentSelectable(selectStartComponent))selectStartComponent.nodeType===Node.TEXT_NODE&&0===selectStartComponent.nodeValue.length?(selectStartComponent.nodeValue=TextSpace,notifyPTNInsert(selectStartComponent),verifyValidPTN(selectStartComponent),self.selectMultiline(selectStartComponent,0,selectStartComponent,0),setCurrentPTN(selectStartComponent),didOverride=!0):selectStartComponent.nodeType===Node.TEXT_NODE&&selectStartComponent.nodeValue===TextSpace&&(notifyPTNInsert(selectStartComponent),setCurrentPTN(selectStartComponent),verifyValidPTN(selectStartComponent));else{var newComponent=document.createTextNode(TextSpace);span.insertBefore(newComponent,selectStartComponent),notifyPTNInsert(newComponent),self.selectMultiline(newComponent,0,newComponent,0),setCurrentPTN(newComponent),didOverride=!0}}else range.commonAncestorContainer.nodeType===Node.TEXT_NODE&&0===range.commonAncestorContainer.nodeValue.length?(range.commonAncestorContainer.nodeValue=TextSpace,notifyPTNInsert(range.commonAncestorContainer),verifyValidPTN(range.commonAncestorContainer),self.selectMultiline(range.commonAncestorContainer,0,range.commonAncestorContainer,0),setCurrentPTN(range.commonAncestorContainer),didOverride=!0):range.commonAncestorContainer.nodeType===Node.TEXT_NODE&&range.commonAncestorContainer.nodeValue===TextSpace&&(notifyPTNInsert(range.commonAncestorContainer),setCurrentPTN(range.commonAncestorContainer),verifyValidPTN(range.commonAncestorContainer))}return didOverride},self.updateEditTextNode=function updateEditTextNodeFn(span){try{self.PAssert(1583,span,"Must be passing in a valid item span")}catch(PERR){g.reportError(PERR)}if(!isPTNActive())return!1;var ptn=getPTN(),didOverride=!1,range=self.getSelectionRange();try{self.PAssert(1584,range.startContainer===range.endContainer,"Multiple item select should not be happening during an update")}catch(PERR){g.reportError(PERR)}if(range.startContainer===ptn&&range.endContainer===ptn){if(0!==range.startOffset||0!==range.endOffset){var components=getComponentNodesIn(span),nextComponent=getNextComponent(ptn);try{self.PAssert(1585,!isComponentSelectable(nextComponent),"Should not be able to select the next component, otherwise why did we insert the PTN")}catch(PERR){g.reportError(PERR)}if(nextComponent){self.cleanupEditTextNode(span);var selectComponent=getNextComponent(nextComponent);if(!selectComponent||!isComponentSelectable(selectComponent)||selectComponent.nodeType===Node.TEXT_NODE&&""===selectComponent.nodeValue)if(range.startOffset===range.endOffset){var newComponent=document.createTextNode(TextSpace);span.insertBefore(newComponent,selectComponent),notifyPTNInsert(newComponent),self.selectMultiline(newComponent,0,newComponent,0),setCurrentPTN(newComponent),didOverride=!0}else{var newComponent=document.createTextNode("");span.insertBefore(newComponent,selectComponent),self.selectMultiline(newComponent,0,newComponent,0),didOverride=!0
}else self.selectMultiline(selectComponent,0,selectComponent,0),didOverride=!0}else{var item=self.getItemForElement(span);try{self.PAssert(1586,item,"Must be able to get a valid item for selection span")}catch(PERR){g.reportError(PERR)}var nextItem=self.getNextItem(item,self.focusedPane);nextItem?(self.cleanupEditTextNode(span),self.selectChildren(nextItem,0,0),didOverride=!0):(self.selectMultiline(ptn,0,ptn,0),didOverride=!0)}}}else self.cleanupEditTextNode(span),didOverride=self.setupEditTextNode(span);return didOverride},self.selectElement=function selectElementFn(ele,selectEnd){try{self.PAssert(1587,!isComponentNode(ele),"Should not use this fn with VMLI elements")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1588,!(ko.dataFor(ele)instanceof VMLI),"Should not use this fn with VMLIs")}catch(PERR){g.reportError(PERR)}if(ele.textContent.length>0&&ele.textContent!==TextSpace){var range=self.createSelectionRange(),selStart=selectEnd?ele.textContent.length:0;self.setSelectionValues(range,ele.childNodes[0],selStart,ele.childNodes[0],ele.textContent.length),self.setSelectionRange(range)}else ele.focus()},self.selectChildren=function selectChildrenFn(item,start,length){if(item&&item instanceof VMLI){if(android.isEnabled()){try{self.PAssert(1590,0===length,"Android editing code must be updated if setting a non-zero length")}catch(PERR){g.reportError(PERR)}return void android.updateInput(item,start)}var maxLength=item.getParsedText().length,start=Math.min(start,maxLength),end=Math.min(start+length,maxLength),startElement,startOffset=-1,endElement,endOffset=-1,totalOffset=0,element=item.getSpan();if(element){for(var children=getComponentNodesIn(element),i=0;i<children.length;++i){var childLength=getComponentNodeLength(children[i]);if(-1===startOffset&&totalOffset+childLength>=start&&(startElement=children[i],startOffset=start-totalOffset),totalOffset+childLength>=end){endElement=children[i],endOffset=end-totalOffset;break}totalOffset+=childLength}try{self.PAssert(1591,startElement&&startOffset>=0,"Invalid start selection params: ",!!startElement,startOffset,start,totalOffset)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1592,endElement&&endOffset>=0,"Invalid end selection params: ",!!endElement,endOffset,start+length,totalOffset)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1593,startElement&&startOffset<=getComponentNodeLength(startElement),"Selection start outside of valid range",startOffset,startElement?getComponentNodeLength(startElement):-1)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1594,endElement&&endOffset<=getComponentNodeLength(endElement),"Selection end outside of valid range",endOffset,endElement?getComponentNodeLength(endElement):-1)}catch(PERR){g.reportError(PERR)}if(startOffset=0>startOffset?0:startOffset,endOffset=0>endOffset?0:endOffset,startElement&&endElement){var range=self.createSelectionRange();self.setSelectionValues(range,startElement,startOffset,endElement,endOffset),self.setSelectionRange(range)}}}else try{self.PAssert(1589,!1,"Valid item and text required to perform selection")}catch(PERR){g.reportError(PERR)}},self.getOffsetOfSubNode=function getOffsetOfSubNodeFn(element,subnode){for(var offset=0,children=getComponentNodesIn(element),childrenSub=getComponentNodesIn(subnode),i=0;i<children.length&&children[i]!==childrenSub[0];++i)offset+=getComponentNodeLength(children[i]);return offset},self.selectMultiline=function selectMultilineFn(eStart,oStart,eEnd,oEnd){try{self.PAssert(1597,!(eStart instanceof VMLI),"Should not be passing VMLIs to start this fn")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1598,!(eEnd instanceof VMLI),"Should not be passing VMLIs to end this fn")}catch(PERR){g.reportError(PERR)}var retVal=!1,start=getOffsetChildElement(eStart,oStart),end=getOffsetChildElement(eEnd,oEnd);try{self.PAssert(1599,start&&start.element&&!isNaN(start.offset),"Start element is invalid")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1600,end&&end.element&&!isNaN(end.offset),"End element is invalid")}catch(PERR){g.reportError(PERR)}if(start&&start.element&&end&&end.element){var range=self.createSelectionRange();self.setSelectionValues(range,start.element,start.offset,end.element,end.offset),self.setSelectionRange(range),retVal=!0}return retVal},self.saveSelectionItem=function saveSelectionItemFn(range){if(!range&&(range=self.getSelectionRange(),!range))return void 0;var validSelectionInfo=!0;if(range&&range.startContainer&&range.endContainer)try{if(self.findParent(range.startContainer.parentNode,"paneContent")){self.restrictSelectionToText();var startItem=self.getItemForElement(range.startContainer),endItem=self.getItemForElement(range.endContainer);if(startItem&&endItem&&startItem!==self.vmMain.root())var startOffsets=self.getSelectOffsetsInSpan(startItem.getSpan(),range),endOffsets=self.getSelectOffsetsInSpan(endItem.getSpan(),range),savedPane=self.getPaneForElement(startItem.getSpan());else validSelectionInfo=!1}else validSelectionInfo=!1}catch(err){self.reportError(err),validSelectionInfo=!1}else validSelectionInfo=!1;var selData;return validSelectionInfo&&(selData={start:startOffsets,end:endOffsets,startItem:startItem,endItem:endItem,pane:savedPane}),selData};var savedSelections={};self.saveSelection=function saveSelectionFn(name,range){savedSelections[name]=self.saveSelectionItem(range,name)},self.clearSavedSelection=function clearSavedSelectionFn(name){savedSelections[name]=void 0},self.restoreSavedSelection=function restoreSavedSelectionFn(name,forcePane){var selData=savedSelections[name],restoreItem;if(selData&&(!forcePane||forcePane===selData.pane)){try{restoreItem=self.restoreSelectionItem(selData),restoreItem&&self.scrollIntoView(restoreItem.getSpan(),0)}catch(err){self.reportError(err)}self.clearSavedSelection(name)}return!!restoreItem},self.restoreSelectionItem=function restoreSelectionItemFn(selectionInfo){try{self.PAssert(1601,selectionInfo,"Must restore to a valid selection")}catch(PERR){g.reportError(PERR)}var startIsHidden=self.hasClass(selectionInfo.startItem.getElement(),"hidden"),endIsHidden=self.hasClass(selectionInfo.endItem.getElement(),"hidden");if(startIsHidden&&!endIsHidden){var setSelection=self.selectMultiline(selectionInfo.endItem.getSpan(),selectionInfo.end.end,selectionInfo.endItem.getSpan(),selectionInfo.end.end);return setSelection?selectionInfo.endItem:void 0}if(!startIsHidden&&endIsHidden){var setSelection=self.selectMultiline(selectionInfo.startItem.getSpan(),selectionInfo.start.start,selectionInfo.startItem.getSpan(),selectionInfo.start.start);return setSelection?selectionInfo.startItem:void 0}var setSelection=self.selectMultiline(selectionInfo.startItem.getSpan(),selectionInfo.start.start,selectionInfo.endItem.getSpan(),selectionInfo.end.end);return setSelection?selectionInfo.startItem:void 0},self.getSelectOffsetsInSpan=function getSelectOffsetsInSpanFn(element,range,forceSelection){try{self.PAssert(1602,android.isEnabled()||void 0===forceSelection,"Should never set forceSelection unless running on android")}catch(PERR){g.reportError(PERR)}var returnValue={total:0,totalText:0};if(android.isEnabled()&&!forceSelection)returnValue.start=android.getSelectionStart(),returnValue.startText=returnValue.start,returnValue.end=android.getSelectionEnd(),returnValue.endText=returnValue.end,returnValue.total=android.getInputText().length,returnValue.totalText=returnValue.total;else{try{self.PAssert(1603,element&&"SPAN"===element.tagName,"Expected SPAN, Actual: ",element)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1604,range,"Must provide a valid range")}catch(PERR){g.reportError(PERR)}if(!range||!element||element.textContent===TextSpace||android.isEnabled()&&""===element.textContent)returnValue.start=0,returnValue.startText=0,returnValue.end=0,returnValue.endText=0;else{var startElement=range.startContainer,startOffset=range.startOffset,endElement=range.endContainer,endOffset=range.endOffset;try{self.PAssert(1605,isComponentNode(startElement)||"SPAN"===startElement.tagName,"Expected #text or SPAN, Actual: ",startElement.nodeName)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1606,isComponentNode(endElement)||"SPAN"===endElement.tagName,"Expected #text or SPAN, ActuakL ",endElement.nodeName)}catch(PERR){g.reportError(PERR)}var findingStart=self.isAncestor(startElement,element),findingEnd=self.isAncestor(endElement,element);try{self.PAssert(1607,findingStart||findingEnd,"At least the start or end must be contained in the supplied element")}catch(PERR){g.reportError(PERR)}var totalOffset=0,components=getComponentNodesIn(element);"SPAN"===startElement.tagName&&self.hasClass(startElement,"text")&&(startElement=components[0]),"SPAN"===endElement.tagName&&self.hasClass(endElement,"text")&&(endElement=components[0]);for(var i=0;i<components.length;++i)components[i]===startElement&&(returnValue.start=totalOffset+startOffset,returnValue.startText=totalOffset+startOffset),components[i]===endElement&&(returnValue.end=totalOffset+endOffset,returnValue.endText=totalOffset+endOffset),totalOffset+=getComponentNodeLength(components[i]);returnValue.total=totalOffset,returnValue.totalText=totalOffset}}try{self.PAssert(1608,!findingStart||!findingEnd||returnValue.start<=returnValue.end,"Must start before or at end")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1609,!findingStart||!findingEnd||returnValue.startText<=returnValue.endText,"Must start text before or at end")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1610,!findingStart||returnValue.start<=returnValue.total,"Must start before or at total")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1611,!findingEnd||returnValue.end<=returnValue.total,"Must end before or at total")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1612,!findingStart||returnValue.startText<=returnValue.totalText,"Must start before or at total")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1613,!findingEnd||returnValue.endText<=returnValue.totalText,"Must end before or at total")}catch(PERR){g.reportError(PERR)}return returnValue},self.getSpanParent=function getSpanParentFn(el,suppressAssert){if(android.isEnabled())return android.getInputBox();if(self.hasClass(el,"noItems"))return void 0;for(;el&&("SPAN"!==el.tagName||!hasValidClass(el));)el=el.parentNode;if(el&&hasValidClass(el))return el;try{self.PAssert(1614,suppressAssert,"This shouldn't happen, spans should always be found")}catch(PERR){g.reportError(PERR)}return void 0},self.getLIParent=function getLIParentFn(el){for(;el&&"LI"!==el.tagName;)el=el.parentNode;return el&&!self.hasClass(el,"item")?null:el};var currentFindPass=0;self.getPreviousItem=function getPreviousItemFn(item,pane,options){return currentFindPass++,_getPreviousItem(item,pane,options)},self.getNextItem=function getNextItemFn(item,pane,options){return currentFindPass++,_getNextItem(item,pane,options)},self.getFirstPaneItem=function getFirstPaneItemFn(pane){try{self.PAssert(1626,pane,"Should always provide a valid pane when grabbing the first item")}catch(PERR){g.reportError(PERR)}return pane?self.getNextItem(pane.item()):void 0},self.getLastPaneItem=function getLastPaneItemFn(pane){var item=pane.item().getLastChild();if(!item)return void 0;for(;item&&item.hasChildren();item=item.getLastChild());try{self.PAssert(1627,item,"Must always have a valid pane item")}catch(PERR){g.reportError(PERR)}return item},self.getItemCounts=function getItemCountsFn(start,end,pane){try{self.PAssert(1628,start,"Start must be a valid item")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1629,end,"End must be a valid item")}catch(PERR){g.reportError(PERR)}var count=0,fullscreenChildCount=0,item=start;do{item=self.getNextItem(item,pane);try{self.PAssert(1630,item,"Items must exist")}catch(PERR){g.reportError(PERR)}item.parent()===pane.item()&&item.isHeader()&&fullscreenChildCount++,count++}while(item!==end);return{fscount:fullscreenChildCount,icount:count}},self.getItemsBetween=function getItemsBetweenFn(start,end,pane){try{self.PAssert(1631,start,"Start must be a valid item")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1632,end,"End must be a valid item")}catch(PERR){g.reportError(PERR)}for(var selected=[start],item=start;item!==end&&(item=self.getNextItem(item,pane));)selected.push(item);return selected},self.getFirstItem=function getFirstItemFn(item1,item2){if(item1.id===item2.id||item2.parent().id===item1.id)return item1;if(item1.parent().id===item2.id)return item2;var p=item1,prevP;do{var q=item2,prevQ;do{if(p.id===q.id){if(void 0===prevP)return item1;if(void 0===prevQ)return item2;try{self.PAssert(1634,void 0!==prevQ,"Fix this assert by handling this edge case!")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1635,p.id===prevQ.parent().id,"Must share a common parent")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1636,p.id===prevP.parent().id,"Must share a common parent")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1637,prevP.id!==prevQ.id,"If both previous items match, they should have been the common ancestor")}catch(PERR){g.reportError(PERR)}return prevP.getIndex()<prevQ.getIndex()?item1:item2}prevQ=q}while(void 0!==(q=q.parent()));prevP=p}while(void 0!==(p=p.parent()));try{self.PAssert(1638,!1,"One item must appear first in the tree")}catch(PERR){g.reportError(PERR)}return void 0},self.animateTransform=function animateTransformFn(element,options){function onComplete(){options.clearTransform&&(element.style[platform.transform.style]="",element.style[platform.transformOrigin.style]=""),options.onComplete&&options.onComplete()}try{self.PAssert(1639,element,"Must supply a valid element to transform")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1640,options,"Options must always be defined")}catch(PERR){g.reportError(PERR)}if(element){var transform=options.transform;if(!isNaN(options.delay)){var delay=options.delay;return options.delay=void 0,void setTimeout(self.animateTransform,delay,element,options)}if(options.time){var trans=self.getTransitionClass(options.time);self.addClass(element,trans),setTimeout(function(){self.removeClass(element,trans),onComplete()},options.time)}else onComplete();isNaN(options.opacity)||(element.style.opacity=options.opacity),transform||isNaN(options.left)||isNaN(options.top)||(transform="translate3d("+options.left+"px, "+options.top+"px, 0)"),options.origin&&(element.style[platform.transformOrigin.style]=options.origin),element.style[platform.transform.style]=transform}},self.easeOut=function easeOutFn(t,b,c){return-c*t*(t-2)+b},self.scrollTo=function scrollToFn(n,duration,element,horiz,cb){function scrollLoop(timestamp){startTime||(startTime=timestamp-20);var t=Math.min((timestamp-startTime)/duration,1),scrollOffset=self.easeOut(t,scrollValue,difference);return element[scrollVar]=scrollOffset,1===t?(self.isScrollingIntoView=!1,platform.ios&&self.setSelectionToWhatItAlreadyIs(),void(cb&&cb())):void requestAnimationFrame(scrollLoop)}if(element=element||self.focusedPane.scrollElement,!element)return void self.reportError("Must specify an element to scroll to");var scrollVar=horiz?"scrollLeft":"scrollTop";if(duration>0){self.isScrollingIntoView=!0;var scrollValue=element[scrollVar],startTime,difference=n-scrollValue;requestAnimationFrame(scrollLoop)}else element&&(element[scrollVar]=n),cb&&cb()},self.computeScrollSpeed=function computeScrollSpeedFn(min,max,val){return(max-min-(max-val))/(max-min)};var lastState={speed:0,pane:void 0},runScroll=!1;self.repeatScroll=function repeatScrollFn(speed,pane){lastState.speed=speed,lastState.pane=pane,runScroll||(runScroll=!0,requestAnimationFrame(performScroll))},self.cancelRepeatScroll=function cancelRepeatScrollFn(){runScroll=!1},self.getPaneForContext=function getPaneForContextFn(localContext){var paneCandidate=localContext?localContext.$parents[localContext.$parents.length-2]:void 0;return!paneCandidate&&localContext&&1===localContext.$parents.length&&(paneCandidate=localContext.$data),paneCandidate instanceof VMPane?paneCandidate:paneCandidate},self.getPaneForElement=function getPaneForElementFn(element){if(element){element.nodeType===Node.TEXT_NODE&&(element=element.parentNode);var localContext;return localContext=ko.contextFor(android&&android.isEnabled()&&"androidInput"===element.id?android.getCurrentVMLI().getSpan():element),self.getPaneForContext(localContext)}return void 0},self.elementInPane=function elementInPaneFn(element){if(element){var localContext=ko.contextFor(element);if(localContext){var paneCandidate=localContext.$parents[localContext.$parents.length-2];if(paneCandidate&&paneCandidate.element)return self.hasClass(paneCandidate.element,"pane")}}return!1},self.scrollToTop=function scrollToTopFn(element,duration,options){if(element){var scrollView=self.findParent(element,"scroller");if(scrollView){var top=element.getBoundingClientRect().top,scrollTop=scrollView.scrollTop,amtMoved=top-self.topBoxHeight+(platform.orientation===Orientation.Landscape?self.topBarHeight:0),n=scrollTop+amtMoved;return self.scrollTo(n,duration,scrollView),amtMoved||!0}}return!1},self.scrollIntoView=function scrollIntoViewFn(element,duration,options){var callback=options&&options.callback;isNaN(duration)&&(duration=200);var performedScroll=!1;if(element){var scrollView=self.findParent(element,"scroller");if(scrollView){var scrollBounds=scrollView.getBoundingClientRect(),scrollBottom=scrollBounds.bottom,bounds=element.getBoundingClientRect(),boundsBottom=Math.min(bounds.bottom,bounds.top+80),extraMoveAmt=0,scrollTop=scrollView.scrollTop,n;if(platform.mobile){var topPad=platform.orientation===Orientation.Landscape?self.topBarHeight:120;scrollBottom=Math.max(scrollBounds.top+topPad,scrollBottom-400)}if(bounds.top<scrollBounds.top){var item=ko.dataFor(element);n=platform.mobile||item!==self.getFirstPaneItem(self.focusedPane)?scrollTop+bounds.top-scrollBounds.top-extraMoveAmt:0}else boundsBottom>scrollBottom&&bounds.top>scrollBounds.top&&(n=scrollTop+boundsBottom-scrollBottom+extraMoveAmt);void 0!==n&&(self.scrollTo(n,duration,scrollView,!1,callback),performedScroll=!0)}}return performedScroll},self.isKeyboardInputElement=function isKeyboardInputElementFn(ele){return"checkbox"===ele.type?!1:"INPUT"===ele.nodeName||"textarea"===ele.type?!0:!1},self.openKeyboardOn=function openKeyboardOnFn(e,element,showKeyboard,isModal,focusFn,blurFn){try{self.PAssert(1642,platform.mobile,"Should only be opening keyboard on mobile devices")}catch(PERR){g.reportError(PERR)}var scrollView;scrollView=element?self.findParent(element,"scroller"):self.focusedPane.getScroller();var scrollStart=scrollView?scrollView.scrollTop:0,performedScroll=!1;if(showKeyboard&&self.keyboardToolbar.preShow(),!self.isKeyboardOpen){var callback=function(){showKeyboard?self.keyboardToolbar.show(isModal):self.isKeyboardOpen=!0,focusFn&&focusFn(),self.enforceScroll()};if(scrollView){var scrollObj=ko.dataFor(scrollView);scrollObj&&scrollObj.addPadding&&scrollObj.addPadding()}platform.app&&!platform.ioswk||platform.android||platform.mobileie?performedScroll=self.scrollIntoView(element,platform.keyboardOpenTime,{callback:callback}):(performedScroll=self.scrollIntoView(element,platform.keyboardOpenTime),callback()),self.keyboardToolbar.hideTopBarIfLandscape()}performedScroll&&platform.app&&!platform.android||(focusFn&&focusFn(),showKeyboard&&self.keyboardToolbar.show(isModal)),self.onCloseKeyboard=function onCloseKeyboardFn(){if(self.isKeyboardOpen){if(scrollView){var scrollObj=ko.dataFor(scrollView);scrollObj&&scrollObj.addPadding&&scrollObj.addPadding(),self.scrollTo(scrollStart,platform.keyboardOpenTime,scrollView,!1,function(){scrollObj&&scrollObj.removePadding&&scrollObj.removePadding()})}self.isKeyboardOpen=!1,blurFn&&blurFn()}self.onCloseKeyboard=void 0},platform.ios&&self.preventClick(),isModal||e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0,self.enforceScroll()},self.blurActiveElement=function blurActiveElementFn(ignoreSelectionChange){self.ignoreSelectionChange=!!ignoreSelectionChange,self.fireCustomEvent("closeKeyboard"),document.activeElement.blur(),setTimeout(function(){self.ignoreSelectionChange=!1},100)},self.preventScrollPropagation=function preventScrollPropagationFn(ele){try{self.PAssert(1646,ele,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}return ele.scrollHeight===ele.clientHeight?!1:(0===ele.scrollTop?ele.scrollTop=1:ele.scrollTop+ele.offsetHeight>=ele.scrollHeight&&(ele.scrollTop=ele.scrollHeight-ele.offsetHeight-1),!0)},self.setSelectionToWhatItAlreadyIs=function setSelectionToWhatItAlreadyIsFn(){var sel=window.getSelection();if(sel.rangeCount>0){var range=self.getSelectionRange();self.setSelectionRange(range)}},self.setSelection=function setSelectionFn(element,start,end){try{self.PAssert(1647,element,"Must supply a valid element to set selection on")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1648,!android||!android.isEnabled()||element&&self.hasClass(element,"search"),"Setting selection in android text shouldnt happen")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1649,start>=0&&end>=0,"Must specify positive start and end offsets")}catch(PERR){g.reportError(PERR)}if(0>start||0>end)return!1;if(!element)return!1;var retVal=!0,select;try{var children=getComponentNodesIn(element),range=self.createSelectionRange();select=children.length>0?children[0]:element,self.setSelectionValues(range,select,start,select,end),self.setSelectionRange(range)}catch(err){self.reportError(err,{element:self.elementToString(element,!0),select:self.elementToString(select,!0),start:start,end:end,children:children.length>0?self.elementToString(element,!0):void 0}),retVal=!1}return retVal},self.restrictSelectionToText=function restrictSelectionToTextFn(){if(!android||!android.isEnabled()){var range,rangeStartContainer,rangeEndContainer,rangeStart,rangeEnd,updateSelection=function(){if(android.isEnabled()){if(!android.getCurrentVMLI())return range=void 0,rangeStartContainer=void 0,rangeEndContainer=void 0,rangeStart=void 0,rangeEnd=void 0,!0;range=void 0,rangeStartContainer=rangeEndContainer=android.getCurrentSpan(),rangeStart=android.getSelectionStart(),rangeEnd=android.getSelectionEnd()}else{if(range=self.getSelectionRange(),!range)return rangeStartContainer=void 0,rangeEndContainer=void 0,rangeStart=void 0,rangeEnd=void 0,!0;rangeStartContainer=range.startContainer,rangeEndContainer=range.endContainer,rangeStart=range.startOffset,rangeEnd=range.endOffset}};if(updateSelection(),range){try{self.PAssert(1660,isComponentNode(rangeStartContainer)||"LI"===rangeStartContainer.tagName||"UL"===rangeStartContainer.tagName||"SPAN"===rangeStartContainer.nodeName||"P"===rangeStartContainer.nodeName,"Expected LI, UL, #text, P, or SPAN, Actual: "+rangeStartContainer.nodeName)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1661,isComponentNode(rangeEndContainer)||"LI"===rangeEndContainer.tagName||"UL"===rangeEndContainer.tagName||"SPAN"===rangeEndContainer.tagName||"P"===rangeEndContainer.nodeName,"Expected LI, UL, #text, P, or SPAN, Actual: "+rangeEndContainer.tagName)}catch(PERR){g.reportError(PERR)}if("UL"!==rangeStartContainer.tagName||"UL"!==rangeEndContainer.tagName||!self.hasClass(rangeStartContainer,"noItems")||!self.hasClass(rangeEndContainer,"noItems")){if("SPAN"===rangeStartContainer.nodeName||"P"===rangeStartContainer.nodeName)safeSelectMultiline(rangeStartContainer,rangeStart,rangeEndContainer,rangeEnd),updateSelection();else if("LI"===rangeStartContainer.tagName){try{self.PAssert(1662,"LI"===rangeEndContainer.tagName,"If start in LI, end should match")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1663,"SPAN"===rangeStartContainer.firstElementChild.tagName,"Text span should always be first child of LI node")}catch(PERR){g.reportError(PERR)}var newSelEle=getLastComponentNodeIn(rangeStartContainer.firstElementChild);try{self.PAssert(1664,newSelEle,"Invalid selection element",self.elementToString(rangeStartContainer))}catch(PERR){g.reportError(PERR)}var newSelLength=getComponentNodeLength(newSelEle);self.selectMultiline(newSelEle,newSelLength,newSelEle,newSelLength),updateSelection()}else if("UL"===rangeStartContainer.tagName){try{self.PAssert(1665,!1,"This should never happen, selection should only be in a UL during a .noItems scenario")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1666,"UL"===rangeEndContainer.tagName,"If start in UL, end should match")}catch(PERR){g.reportError(PERR)}var newSelEle=rangeStartContainer.previousElementSibling;try{self.PAssert(1667,newSelEle,"Invalid selection element",self.elementToString(rangeStartContainer))}catch(PERR){g.reportError(PERR)}self.selectMultiline(newSelEle,newSelEle.textContent.length,newSelEle,newSelEle.textContent.length),updateSelection()}if("LI"===rangeEndContainer.tagName){var prevLI=rangeEndContainer.previousElementSibling;try{self.PAssert(1670,!prevLI||"LI"===prevLI.tagName,"Should always expect the previous sibling to be another LI. First item in list this cant happen for")}catch(PERR){g.reportError(PERR)}if(prevLI){if(prevLI.children.length>1){var children=prevLI.children[1].children;prevLI=children[children.length-1]}}else prevLI=rangeEndContainer.parentNode.parentNode;var prevSpan=prevLI.firstChild;try{self.PAssert(1671,prevSpan&&"SPAN"===prevSpan.tagName,"Expected SPAN, Actual: "+prevSpan.tagName)}catch(PERR){g.reportError(PERR)}var prevItem=ko.dataFor(prevSpan);try{self.PAssert(1672,prevItem,"Should always get a valid item from a span: "+self.elementToString(prevSpan))}catch(PERR){g.reportError(PERR)}prevItem&&self.selectChildren(prevItem,0,prevItem.getParsedText().length)}else("UL"===rangeEndContainer.nodeName||"SPAN"===rangeEndContainer.nodeName)&&safeSelectMultiline(rangeStartContainer,rangeStart,rangeEndContainer,rangeEnd);updateSelection();try{self.PAssert(1674,rangeStartContainer.nodeType===Node.TEXT_NODE,"Must have successfully contained select start to a text node")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1675,rangeEndContainer.nodeType===Node.TEXT_NODE,"Must have successfully contained select end to a text node")}catch(PERR){g.reportError(PERR)}}}}},self.trimString=function trimStringFn(str){str=str.replace(/^\s\s*/,"");for(var ws=/\s/,i=str.length;ws.test(str.charAt(--i)););return str.slice(0,i+1)},self.enforceScroll=function enforceScrollFn(force,top){(force||(platform.ios||platform.android)&&(!platform.app||platform.ios71))&&(setTimeout(function(){window.scrollTo(0,top||0)},0),requestAnimationFrame(function(){window.scrollTo(0,top||0)}),window.scrollTo(0,top||0),document.body.scrollTop=0)},self.preventDefault=function preventDefaultFn(e){if(e&&e.preventDefault)e.preventDefault();else try{self.PAssert(1676,!1,"Invalid event object: "+e)}catch(PERR){g.reportError(PERR)}},self.preventClick=function preventClickFn(){self.addClass(self.element("outerWrapper"),"noClick"),window.ontouchstart=self.preventDefault,requestAnimationFrame(function(){window.ontouchstart=void 0,self.removeClass(self.element("outerWrapper"),"noClick")})},self.searchVMLIs=function searchVMLIsFn(options){var startItem=options.item;startItem||(startItem=self.vmMain.root()),options.headers?searchVMLIArray(options,startItem.headers()):searchVMLIArray(options,startItem.items()),options.includeArchived&&startItem.hasArchivedChildren()&&searchVMLIArray(options,startItem.archivedItems(!0))},self.getActiveSearch=function getActiveSearchFn(){return self.focusedPane.vmSearch},self.getLastVisibleItem=function getLastVisibleItemFn(root){try{self.PAssert(1677,platform.mobile,"getLastVisibleItem should only be called by mobile")}catch(PERR){g.reportError(PERR)}for(var list=root.items(),i=list.length-1;i>=0;i--)if(!self.getActiveSearch().hiddenItems[list[i].id]){var lastItem=self.getLastVisibleItem(list[i]);return lastItem?lastItem:list[i]}return void 0},self.invertObject=function invertObjectFn(obj){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(target[obj[i]]=i);return target},self.fieldMapOut=self.invertObject(self.fieldMapIn),self.translateFieldIn=function translateFieldInFn(field){try{self.PAssert(1681,self.fieldMapIn[field],"Incoming field should be added to the field map",field)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1682,"string"==typeof field,"Should only pass strings to the field mapping function",field)}catch(PERR){g.reportError(PERR)}return self.fieldMapIn[field]||field},self.translateFieldOut=function translateFieldOutFn(field){try{self.PAssert(1683,self.fieldMapOut[field],"Incoming field should be added to the field map",field)}catch(PERR){g.reportError(PERR)}try{self.PAssert(1684,"string"==typeof field,"Should only pass strings to the field mapping function",field)}catch(PERR){g.reportError(PERR)}return self.fieldMapOut[field]||field},self.translateObjIn=function translateObjInFn(obj){return getMapping(obj,self.fieldMapIn)},self.translateObjOut=function translateObjOutFn(obj){return getMapping(obj,self.fieldMapOut)};var eventListeners={};self.addCustomEventListener=function addCustomEventListenerFn(name,fn,priority){try{self.PAssert(1685,name,"Must provide a valid event name")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1686,fn,"Must provide a valid event handler to add")}catch(PERR){g.reportError(PERR)}if(void 0!==priority){var evs=eventListeners[name],entry={fn:fn,pri:priority};evs?eventListeners[name].insertSorted(entry,function(left,right){return right>left?1:-1}):(eventListeners[name]=[entry],window.addEventListener(name,function(e){for(var i=0;i<eventListeners[name].length;++i){var ev=eventListeners[name][i],ret=ev.fn(e);if(ret===!1)break}}))}else window.addEventListener(name,fn)},self.removeCustomEventListener=function removeCustomEventListenerFn(name,fn,isPriority){try{self.PAssert(1687,name,"Must provide a valid event name")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1688,fn,"Must provide a valid event handler to remove")}catch(PERR){g.reportError(PERR)}if(isPriority){for(var evs=eventListeners[name],found=!1,i=0;i<evs.length;++i)if(evs[i].fn===fn){found=!0,evs.removeAt(i);break}0===evs.length;try{self.PAssert(1689,found,"Event listener should always be found when removing")}catch(PERR){g.reportError(PERR)}}else window.removeEventListener(name,fn)},self.fireCustomEvent=function fireCustomEventFn(name,data,target){if(document.createEvent){var eventObj=document.createEvent("Event");return data&&(eventObj.data=data),eventObj.initEvent(name,!0,!0),(target||window).dispatchEvent(eventObj)}try{self.PAssert(1690,!1,"Unable to fire custom event")}catch(PERR){g.reportError(PERR)}},self.fireKeyEvent=function fireKeyEventFn(ele,keyData){fireKeyEventInternal(ele,"keydown",keyData),fireKeyEventInternal(ele,"keypress",keyData),fireKeyEventInternal(ele,"keyup",keyData)},self.fireClickEvent=function fireClickEventFn(ele,button){fireClickEventInternal(ele,"mousedown",button),fireClickEventInternal(ele,"mouseup",button),fireClickEventInternal(ele,"mouseclick",button)},self.fireDragStart=function fireDragStartFn(ele){fireClickEventInternal(ele,"mousedown",ButtonCode.Left,{offsetX:10,offsetY:10,clientX:10,clientY:10})},self.fireDragMove=function fireDragMoveFn(ele,x,y){if(ele||(ele=this.getSelectionNode()),document.createEvent){var evObj=document.createEvent("Event");evObj.pageX=x,evObj.pageY=y,evObj.synthetic=!0,evObj.initEvent("mousemove",!0,!0),ele.dispatchEvent(evObj)}else try{self.PAssert(1697,!1,"Unable to fire click event")}catch(PERR){g.reportError(PERR)}},self.fireDragEnd=function fireDragEndFn(ele){self.vmMain.handleDragOver(ele),fireClickEventInternal(ele,"mouseup",ButtonCode.Left)},self.clone=function cloneFn(obj){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(target[i]=obj[i]);return target},self.loadXML=function loadXMLFn(xml){try{if("undefined"!=typeof window.DOMParser)return(new window.DOMParser).parseFromString(xml,"text/xml");if("undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")){var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");return xmlDoc.async="false",xmlDoc.loadXML(xml),xmlDoc}try{self.PAssert(1698,!1,"No XML parser found")}catch(PERR){g.reportError(PERR)}return void 0
}catch(err){return void self.reportError(err)}},self.adjustOriginToBeInsideBounds=function adjustOriginToBeInsideBoundsFn(bounds,rect,xMin,yMin,xPad,yPad){var out={x:rect.left,y:rect.top};return xMin=xMin||0,yMin=yMin||0,xPad=xPad||0,yPad=yPad||0,rect.bottom+yPad>bounds.bottom&&(out.y=Math.max(yMin,rect.top-(rect.bottom+yPad-bounds.bottom))),rect.top-yPad<bounds.top&&(out.y=Math.max(yMin,rect.top)),rect.right+xPad>bounds.right&&(out.x=Math.max(xMin,rect.left-(rect.right+xPad-bounds.right))),out},self.adjustLeftToBeInsideBounds=function adjustLeftToBeInsideBoundsFn(bounds,left,width,leftPad){return left+width+leftPad>bounds.right&&(left=bounds.right-leftPad-width),left},self.adjustHeightToBeInsideBounds=function adjustHeightToBeInsideBoundsFn(bounds,rect,minHeight,maxHeight,yPad){if(rect.bottom+yPad>bounds.bottom&&(rect.bottom=bounds.bottom-yPad,rect.bottom-rect.top<minHeight)){var lineHeight=25,newBottom=Math.max(0,rect.top-lineHeight),newTop=Math.max(0,newBottom-minHeight);rect.bottom=newBottom,rect.top=newTop}return Math.min(maxHeight,rect.bottom-rect.top)},self.setOrigin=function setOriginFn(rect,xOrigin,yOrigin){var xDiff=rect.left-xOrigin,yDiff=rect.top-yOrigin;rect.left-=xDiff,rect.right-=xDiff,rect.top-=yDiff,rect.bottom-=yDiff},self.copyStyles=function copyStylesFn(src,dst,styles){try{self.PAssert(1699,src,"Must have a valid source element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1700,dst,"Must have a valid dest element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1701,styles,"Must have a valid list of styles to copy")}catch(PERR){g.reportError(PERR)}var computedStyle=window.getComputedStyle(src);if(computedStyle){for(var values=[],i=0;i<styles.length;++i)values[i]=computedStyle[styles[i]];for(var i=0;i<values.length;++i)dst.style[styles[i]]=values[i]}},self.hasClass=function hasClassFn(elem,cls){try{self.PAssert(1702,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}return elem&&elem.classList?elem.classList.contains(cls):void 0},self.removeClass=function removeClassFn(elem,cls){try{self.PAssert(1703,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}elem&&elem.classList&&elem.classList.remove(cls)},self.addClass=function addClassFn(elem,cls){try{self.PAssert(1704,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}elem&&elem.classList&&elem.classList.add(cls)},self.toggleClass=function toggleClassFn(elem,cls){try{self.PAssert(1705,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}elem&&elem.classList&&elem.classList.toggle(cls)},self.css=function cssFn(elem,styles){try{self.PAssert(1706,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(elem)for(var style in styles)if(styles.hasOwnProperty(style)){var value=styles[style];"number"==typeof value&&(value+="px"),elem.style[style]=value}},self.findChild=function findChildFn(elem,cls){try{self.PAssert(1707,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(elem)for(var i=0;i<elem.childElementCount;++i)if(self.hasClass(elem.children[i],cls))return elem.children[i];return void 0},self.getPluginForElement=function getPluginForElementFn(ele){return self.findParent(ele,"plugin",3)},self.findParent=function findParentFn(elem,cls,num){try{self.PAssert(1708,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(num||(num=1e3),elem){var parent=elem;try{self.PAssert(1709,parent,"Must have a valid parent element")}catch(PERR){g.reportError(PERR)}for(var i=0;num>i&&parent;++i,parent=parent.parentNode)if(self.hasClass(parent,cls))return parent}return void 0},self.findParentID=function findParentIDFn(elem,id,num){try{self.PAssert(1710,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}if(num||(num=1e4),elem){var parent=elem;try{self.PAssert(1711,parent,"Must have a valid parent element")}catch(PERR){g.reportError(PERR)}for(var i=0;num>i&&parent;++i,parent=parent.parentNode)if(parent.id===id)return parent}return void 0},self.isAncestor=function isAncestorFn(elem,candidate){try{self.PAssert(1712,elem,"Must have a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1713,candidate,"Must have a valid candidate")}catch(PERR){g.reportError(PERR)}for(;elem&&elem!==candidate;)elem=elem.parentNode;return!!elem},self.firstChildTag=function firstChildTagFn(elem,tag){try{self.PAssert(1714,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1715,tag,"Must pass in a valid tag to check")}catch(PERR){g.reportError(PERR)}if(elem)for(var upper=tag.toUpperCase(),i=0;i<elem.childElementCount;++i)if(elem.children[i].tagName===upper)return elem.children[i];return void 0},self.insertAfter=function insertAfterFn(reference,newNode){try{self.PAssert(1717,reference,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1718,newNode,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}reference.parentNode.insertBefore(newNode,reference.nextSibling)},self.prependChild=function prependChildFn(parent,newNode){try{self.PAssert(1719,parent,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1720,newNode,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}parent.insertBefore(newNode,parent.firstChild)},self.isAttachedToDoc=function isAttachedToDocFn(ele){try{self.PAssert(1721,ele,"Must supply a valid element to check")}catch(PERR){g.reportError(PERR)}return ele.ownerDocument.body.contains(ele)},self.offset=function offsetFn(elem){try{self.PAssert(1722,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,docElem=elem.ownerDocument.documentElement,win=doc.defaultView,customAns={top:box.top+win.pageYOffset-docElem.clientTop,left:box.left+win.pageXOffset-docElem.clientLeft};return customAns},self.height=function heightFn(elem){try{self.PAssert(1724,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}var customHeight=elem.offsetHeight,cStyle=window.getComputedStyle(elem);return cStyle?("border-box"!==cStyle.boxSizing&&(customHeight-=parseFloat(cStyle.paddingTop)+parseFloat(cStyle.paddingBottom)),customHeight-=parseFloat(cStyle.borderTopWidth)+parseFloat(cStyle.borderBottomWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::height"),customHeight},self.width=function widthFn(elem){try{self.PAssert(1726,elem,"Must pass in a valid element")}catch(PERR){g.reportError(PERR)}var customWidth=elem.offsetWidth,cStyle=window.getComputedStyle(elem);return cStyle?("border-box"!==cStyle.boxSizing&&(customWidth-=parseFloat(cStyle.paddingLeft)+parseFloat(cStyle.paddingRight)),customWidth-=parseFloat(cStyle.borderLeftWidth)+parseFloat(cStyle.borderRightWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::width"),customWidth};var onLoadCallbacks;self.runOnLoad=function runOnLoadFn(cb){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(cb):(onLoadCallbacks||(onLoadCallbacks=[],document.addEventListener("DOMContentLoaded",loadDone,!1),window.addEventListener("load",loadDone,!1)),onLoadCallbacks[onLoadCallbacks.length]=cb)};var __xhrRequests={};self.getXHRStats=function getXHRStatsFn(){return __xhrRequests};var maxRetryCount=5,retryTimeouts=[0,5,15,35,80,170],retryErrorCodes=[0,408,500,502,503,504];self.XHR=function XHRFn(params){function retry(){try{self.PAssert(1731,maxRetries>currentRetries,"Should not be calling retry once retries have been exhausted")}catch(PERR){g.reportError(PERR)}maxRetries>currentRetries?(currentRetries++,notifyStatsXHRRetry(url),setTimeout(sendXHR,1e3*retryTimeouts[currentRetries])):(notifyStatsXHRFailure(url),self.reportError(new Error("XHR Failed: "+url)))}function sendXHR(){var xhr=new XMLHttpRequest;if(xhr.onreadystatechange=function(){4===xhr.readyState&&(200!==xhr.status?maxRetries>currentRetries?(xhr.retry=retry,autoRetry&&retryErrorCodes.indexOf(xhr.status)>=0?xhr.retry():cb(xhr)):(notifyStatsXHRFailure(url),cb(xhr)):cb(xhr))},username&&password?xhr.open(type.toUpperCase(),url,!0,username,password):xhr.open(type.toUpperCase(),url,!0),headers)for(var key in headers)xhr.setRequestHeader(key,headers[key]);if(data){xhr.setRequestHeader("Accept","*/*"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");var queryString=generateQueryString(data);xhr.send(queryString)}else xhr.send()}try{self.PAssert(1729,params.url,"Must specify a valid URL to use")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1730,params.type,"Must specify a valid request type")}catch(PERR){g.reportError(PERR)}var url=params.url,type=params.type,cb=params.cb,data=params.data,headers=params.headers,autoRetry=params.autoRetry,maxRetries=Math.min(params.maxRetries||2,maxRetryCount),currentRetries=0,username=params.username,password=params.password;notifyStatsXHRRequest(url),sendXHR()},self.XHR_PrivateAPI=function XHR_PrivateAPIFn(params){try{self.PAssert(1732,params.type,"Must supply a valid type")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1733,params.path&&params.path.startsWith("/"),"Must supply a valid path"+params.path)}catch(PERR){g.reportError(PERR)}var goog=require("goog"),protocol=platform.getDeployVar(DeployVariable.APIProtocol),host=platform.getDeployVar(DeployVariable.APIHost),basePath="/private/v1";if(params.requireAuth){var token=goog.getAccessToken(!0);try{self.PAssert(1734,token,"Must have a valid auth token before making API calls")}catch(PERR){g.reportError(PERR)}params.headers||(params.headers={});try{self.PAssert(1735,!params.headers.token,"Callers should not be setting access token themselves")}catch(PERR){g.reportError(PERR)}params.headers.token=token}var XHRParams={type:params.type,url:protocol+host+basePath+params.path,data:params.data,cb:params.cb,headers:params.headers,autoRetry:params.autoRetry,maxRetries:params.maxRetries};self.XHR(XHRParams)},self.XHR_PublicAPI=function XHR_PublicAPIFn(params){};var isXHRWrapped=!1,idXHR=1,notifyURLs={};return self.registerURLForNotifyXHR=function registerURLForNotifyXHRFn(url,cb){return notifyURLs[url]||(notifyURLs[url]=cb),isXHRWrapped},self.wrapXHR=function wrapXHRFn(){try{var __open=window.XMLHttpRequest.prototype.open,__send=window.XMLHttpRequest.prototype.send;window.XMLHttpRequest.prototype.open=function(method,url,async,user,password){this.url=url,__open.call(this,method,url,async,user,password)},window.XMLHttpRequest.prototype.send=function(data){notifyXHR(this),__send.call(this,data)}}catch(err){return void self.reportError(err)}isXHRWrapped=!0},self.wrapXHR(),self.JSONP=function JSONPFn(params){try{self.PAssert(1736,params.url,"Must supply a valid URL to fetch")}catch(PERR){g.reportError(PERR)}try{self.PAssert(1737,params.cb,"Must supply a valid callback")}catch(PERR){g.reportError(PERR)}var url=params.url,data=params.data,cb=params.cb;if(data){for(var queryString="",keys=Object.keys(data),i=0;i<keys.length;i++)queryString+=encodeURIComponent(keys[i])+"="+encodeURIComponent(data[keys[i]]),i!==keys.length-1&&(queryString+="&");url+="?"+queryString}var timestamp=Date.now(),generatedFunction="jsonp"+Math.round(timestamp+10001*Math.random());window[generatedFunction]=function(json){cb(json),delete window[generatedFunction]},url+=-1===url.indexOf("?")?"?":"&";var jsonpScript=document.createElement("script");jsonpScript.id=generatedFunction,jsonpScript.setAttribute("src",url+"callback="+generatedFunction),document.getElementsByTagName("head")[0].appendChild(jsonpScript)},self.element=function elementFn(id,reload){try{self.PAssert(1738,id,"Tried to get an element without an id")}catch(PERR){g.reportError(PERR)}(!self.elements[id]||reload)&&(self.elements[id]=document.getElementById(id));try{self.PAssert(1739,self.elements[id],"Tried to get an element that doesn't exist",id)}catch(PERR){g.reportError(PERR)}return self.elements[id]},self.getElementByClassName=function getElementByClassNameFn(className,parent){if(!parent)return document.getElementsByClassName(className)[0];for(var len=parent.children.length,i=0;len>i;i++)if(parent.children[i].className.indexOf(className)>=0)return parent.children[i]},self.getElementsByClassName=function getElementsByClassNameFn(className,parent){if(parent){for(var arr=[],len=parent.children.length,i=0;len>i;i++)parent.children[i].className.indexOf(className)>=0&&arr.push(parent.children[i]);return arr}return document.getElementsByClassName(className)},self.openUrl=function openUrlFn(url,e,notBlank){try{self.PAssert(1740,url,"Must always provide a valid URL to open")}catch(PERR){g.reportError(PERR)}if(!url)return!1;if(platform.standalone){var a=document.createElement("a");a.setAttribute("href",url),a.setAttribute("target","_blank");var dispatch=document.createEvent("HTMLEvents");dispatch.initEvent("click",!0,!0),a.dispatchEvent(dispatch)}else if(platform.app){var validProtocols,isValid,i;url.startsWith("http://")||url.startsWith("https://")?url=url.replace("http://","").replace("https://",""):url.startsWith("/")&&(url=window.location.host+url),platform.ios&&(url.startsWith("tel:")||url.startsWith("mailto:")||url.startsWith("callto:"))?open(url):self.nativeBridge.sendToApp("openURL",url),e&&(self.handlerPreventStop(e),e.returnFalse=!0)}else notBlank?open(url,"_self"):open(url,"_blank");return!0},self.featureTest=function featureTestFn(property,value,noPrefixes){var prop=property+":",el=document.createElement("test"),mStyle=el.style;return mStyle.cssText=noPrefixes?prop+value:prop+["-webkit-","-moz-","-ms-","-o-",""].join(value+";"+prop)+value+";",-1!==mStyle[property].indexOf(value)},self.isDateSoft=function isDateSoftFn(dateText){if(dateText)switch(dateText.toUpperCase()){case"NEXT":case"SOON":case"LATER":case"SOMEDAY":case"NOW":return!0}return!1},self.handlerPreventStop=function handlerPreventStopFn(e){e.preventDefault(),e.stopImmediatePropagation()},self.handlerStopProp=function handlerStopPropFn(e){e.stopImmediatePropagation()},self.fFalse=function fFalseFn(){return!1},self.fTrue=function fTrueFn(){return!0},self.emptyFn=function emptyFnFn(){},self.hours=function hoursFn(hours){return 36e5*hours},self.minutes=function minutesFn(mins){return 6e4*mins},self.seconds=function secondsFn(secs){return 1e3*secs},self.curry=function curryFn(fn){var args=[].slice.call(arguments,1);return function(){return fn.apply(this,args.concat(Array.prototype.slice.call(arguments,0)))}},self.validateTime=function validateTimeFn(element,callback){function validate(e){var value=e.target.value,regex=new RegExp(/^(0?[1-9]|1[012])(:[0-5]\d) [APap][mM]$/),results=regex.exec(value);callback(!!results)}element.addEventListener("input",validate)},util.hasURLParam("nolocal","true")&&(self.noLocalWrites=!0),self.eventStream=self.createRingBuffer(25),window.__CHECK_OAUTH=function(){self.XHR({type:"GET",url:"https://accounts.google.com/o/oauth2/auth?scope=email&redirect_uri=http://moo.do&response_type=token&client_id=597847337936.apps.googleusercontent.com",cb:function cbFn(xhr){log("XHR OAuth: ",xhr)}})},self}),define("gdata",["ko","globals","data","platform"],function(ko,g,d,platform){function promptTrashDoc(){g.menus.alert({text:"You are using an out of date document - please contact support@moo.do for help.",actionText:"OKAY",action:function actionFn(){gapi.client.load("drive","v2",function(){gapi.client.drive.files.trash({fileId:g.settings.get(Settings.gdocId)}).execute(function(response){g.reportError(response.error?new Error("Error deleting out of date doc - "+response.error):new Error("Successfully deleted out of date doc - "+g.settings.get(Settings.gdocId))),d.clearData(function(){g.reload()})})})}})}function ensureWriteAction(){try{g.PAssert(1784,!self.inCompoundOperation,"Should never be in a compound operation after sync block finishes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1785,!self.wantCompoundOperation,"Should never want a compound operation after a sync block finishes")}catch(PERR){g.reportError(PERR)}if(self.inCompoundOperation){try{self.inCompoundOperation=!1,self.wantCompoundOperation=!1,g.vmMain.notifyDriveOperationError(),self.model.endCompoundOperation()}catch(err){g.reportError(err)}g.reportError(new Error("Compound operation open after sync block finished"))}ensureActionTimeout=void 0}function attachEvents(item){try{g.PAssert(1791,item,"Must have a valid local item to attach events to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1792,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1793,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1794,item.data,"Must have a valid remote item to attach events to")}catch(PERR){g.reportError(PERR)}item.data.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,item.onObjectChanged.bind(item))}function ensureRemoteItemsArray(item){self.beginWriteAction();try{g.PAssert(1821,item instanceof VMLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1822,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1823,item.data,"Must have valid remote item to attach events to and create")}catch(PERR){g.reportError(PERR)}var itemList=self.get(item.data,"items");return itemList||(itemList=self.model.createList(),self.set(item.data,"items",itemList)),itemList}function ensureRemoteArchiveArray(item){self.beginWriteAction();try{g.PAssert(1824,item instanceof VMLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1825,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1826,item.data,"Must have valid remote item to attach events to and create")}catch(PERR){g.reportError(PERR)}var archivedList=self.get(item.data,"archivedItems");return archivedList||(archivedList=self.model.createList(),self.set(item.data,"archivedItems",archivedList)),archivedList}function setRemoteVersion(data){self.beginWriteAction();var v=self.getVersion(data,VersionType.Structure);v=v?v+1:1;var verStr;self.set(data,"version",v)}function setRemoteTextVersion(data){self.beginWriteAction();var v=self.getVersion(data,VersionType.Text);v=v?v+1:1;var verStr;self.set(data,"versionText",v)}function saveChangesInternal(item,changes){try{g.PAssert(1868,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var itemData=self.canSave(item);if(itemData){if(g.isEmpty(changes))return void(ShouldLog(LogLevels.Warning)&&log("Skipped remote saving an empty object"));self.beginWriteAction(),d.addPendingUpdate(item.id);for(var prop in changes){try{g.PAssert(1869,changes.hasOwnProperty(prop),"Changes should only contain properties they own")}catch(PERR){g.reportError(PERR)}if(changes.hasOwnProperty(prop))switch(prop){case"text":try{g.PAssert(1870,g.isString(changes.text))}catch(PERR){g.reportError(PERR)}self.set(itemData,"text",changes.text);break;case"date":try{g.PAssert(1871,!changes.date||"number"==typeof changes.date,"Invalid date type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"date",changes.date);break;case"repeatDate":try{g.PAssert(1872,!changes.repeatDate||g.isString(changes.repeatDate),"Invalid repeat date type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"repeatDate",changes.repeatDate);break;case"dateCreated":try{g.PAssert(1874,"number"==typeof changes.dateCreated,"Invalid dateCreated type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"dateCreated",changes.dateCreated);break;case"dateCompleted":try{g.PAssert(1875,!changes.dateCompleted||"number"==typeof changes.dateCompleted,"Invalid dateCompleted type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"dateCompleted",changes.dateCompleted);break;case"allDayDate":case"priority":case"isComplete":case"isStarred":self.set(itemData,prop,changes[prop]);break;case"isCollapsed":case"isArchived":try{g.PAssert(1876,!1,"These properties are not set this way")}catch(PERR){g.reportError(PERR)}self.set(itemData,prop,changes[prop]);break;case"modifiedOfflineText":case"dateText":break;default:try{g.PAssert(1877,!1,"Attempting to remotely save an unknown field: ",prop)}catch(PERR){g.reportError(PERR)}}}setRemoteTextVersion(itemData)}}function getRetryInterval(count){return retryIntervals[Math.min(count,retryIntervals.length-1)]}function tryDriveReconnect(){try{g.PAssert(1880,driveRealtimeStatus===RealtimeStatus.Error||driveRealtimeStatus===RealtimeStatus.XHRError,"Invalid state for request reconnect: ",driveRealtimeStatus)}catch(PERR){g.reportError(PERR)}clearTimeout(driveReconnectTimer),driveReconnectTimer=void 0,g.goog.reconnectToActiveDocument()}function setDriveRealtimeStatus(newStatus){var oldStatus=driveRealtimeStatus;if(driveRealtimeStatus=newStatus,log("Change Realtime Status: ",oldStatus," -> ",newStatus),oldStatus!==newStatus)switch(oldStatus){case RealtimeStatus.Disconnected:try{g.PAssert(1883,newStatus===RealtimeStatus.Connecting,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}break;case RealtimeStatus.XHRError:case RealtimeStatus.Error:try{g.PAssert(1884,newStatus===RealtimeStatus.Reconnecting||newStatus===RealtimeStatus.Connected,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}newStatus===RealtimeStatus.Connected&&self.notifyReconnectSuccess();break;case RealtimeStatus.Connected:try{g.PAssert(1885,newStatus===RealtimeStatus.Error,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}newStatus===RealtimeStatus.Error&&(self.close(),self.setupReconnect());break;case RealtimeStatus.Connecting:case RealtimeStatus.Reconnecting:try{g.PAssert(1886,newStatus===RealtimeStatus.Error||newStatus===RealtimeStatus.Connected,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}newStatus===RealtimeStatus.Error?(self.close(),self.setupReconnect()):newStatus===RealtimeStatus.XHRError?self.notifyReconnectFailure():newStatus===RealtimeStatus.Connected&&oldStatus===RealtimeStatus.Reconnecting&&self.notifyReconnectSuccess();break;default:try{g.PAssert(1887,!1,"Invalid status: ",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}}}function fwdOnLoaded(cb){try{g.PAssert(1888,cb,"Must pass a valid CB for doc loaded")}catch(PERR){g.reportError(PERR)}return function fwdOnloadedFn(doc){setDriveRealtimeStatus(RealtimeStatus.Connected),_connectIdentifier++,cb(doc)}}function fwdOnInitialized(cb){try{g.PAssert(1889,cb,"Must pass a valid CB for doc initialized")}catch(PERR){g.reportError(PERR)}return function fwdOnInitializedFn(doc){setDriveRealtimeStatus(RealtimeStatus.Connected),cb(doc)}}function fwdOnError(cb){try{g.PAssert(1890,cb,"Must pass a valid CB for doc error")}catch(PERR){g.reportError(PERR)}return function fwdOnErrorFn(err){var fatalError=cb(err);fatalError&&setDriveRealtimeStatus(RealtimeStatus.Error)}}function onRSCDrive(xhr){(!xhr||4===xhr.readyState&&200!==xhr.status)&&setDriveRealtimeStatus(RealtimeStatus.XHRError)}function entrySize(entry){return entry?entry.length:0}var self={isClosed:!0,initialized:!1,loadedOnce:!1,wantCompoundOperation:!1,inCompoundOperation:!1,flushingDeferredActions:!1,deferredActionsCommitted:!1,hasPendingDeferredActions:!1,authenticatedUser:ko.observable(),numChanges:0};self.offlineTimeoutMS=platform.mobile?12e3:8e3;var CURRENT_VERSION=5;self.currentVersion=function currentVersionFn(){return CURRENT_VERSION};var itemCache={};self.cacheItem=function cacheItemFn(item){try{g.PAssert(1742,void 0===itemCache[item.id]||itemCache[item.id]===item,"Should not be caching different items with the same ID")}catch(PERR){g.reportError(PERR)}itemCache[item.id]=item},self.getState=function getStateFn(obj){try{var gState={};if(self.doc)try{var model=self.doc.getModel();gState.isReadOnly=model.isReadOnly,gState.serverVersion=model.serverVersion,gState.size=model.bytesUsed}catch(err2){obj.docAccessError=!0}gState.lastPending=lastPending,gState.lastSaving=lastSaving,gState.isClosed=self.isClosed,gState.initialized=self.initialized,obj.gState=gState}catch(err){log("Error getting information in gdata::getState()"+err.message)}};var d,VMLI;self.checkRemoteIntegrity=function checkRemoteIntegrityFn(){function verifyChildren(children,isArchived){if(children)for(var j=0;j<children.length;++j){var child=children.get(j).id;child||(log(child,": Child does not have a valid reference in our remote database"),remoteDataError=!0),seen[child]?seen[child].ref?(log(child,": Item is referenced remotely multiple times"),log("   ",seen[child].ref),log("   ",item.id),remoteDataError=!0,self.beginWriteAction(),children.remove(j)):seen[child].ref=item.id:seen[child]={exist:!1,arch:isArchived,ref:item.id}}}self.beginAction();var remoteDataError=!1,localDataError=!1,seen={},rootSeen=!1;for(var itemID in itemCache){var item=itemCache[itemID];seen[item.id]?seen[item.id].exist?(log(item.id,": Duplicated IDs in the remote database",item),remoteDataError=!0):seen[item.id].exist=!0:seen[item.id]={exist:!0,ref:!1},item.id===self.rootID&&(rootSeen&&(log(item.id,": Multiple roots present remotely",item),remoteDataError=!0),rootSeen=!0,seen[item.id].isRoot=!0);var childItems=self.get(item,"items");verifyChildren(childItems,!1);var childArchivedItems=self.get(item,"archivedItems");verifyChildren(childArchivedItems,!0);var note=self.get(item,"note");note&&(seen[note.id]?seen[note.id].ref?(log(note,": Note is referenced remotely multiple times: "),log("    ",seen[note.id].ref),log("    ",item.id),remoteDataError=!0,self.beginWriteAction(),self.set(item,"note",void 0)):seen[note.id].ref=item.id:seen[note.id]={exist:!1,ref:item.id})}rootSeen||(log("No root present"),localDataError=!0);for(var entryID in seen){var entry=seen[entryID];if(!entry.exist){try{g.PAssert(1744,!1,"This should never happen as the database is inline with the item tree now")}catch(PERR){g.reportError(PERR)}log(entryID,": Item is referenced remotely as a child but does not exist in the database");var parent=itemCache[entry.ref];try{g.PAssert(1745,parent,"Parent must exist otherwise it couldn't reference this item")}catch(PERR){g.reportError(PERR)}var parentItems=self.getItemList(parent,entry.arch);try{g.PAssert(1746,parentItems,"If the item has been seen here, we will always have a valid parent list")}catch(PERR){g.reportError(PERR)}if(parentItems){var remoteIndex=parentItems.indexOf(entryID);if(remoteIndex>=0)self.beginWriteAction(),parentItems.remove(remoteIndex);else try{g.PAssert(1747,!1,"If we previously saw this item, we expect to be able to delete it from the parent list")}catch(PERR){g.reportError(PERR)}}}entry.ref||entry.isRoot||(log(entryID,": Item exists remotely but is not referenced by a parent"),log("   : ",self.get(itemCache[entryID],"text")),delete itemCache[entryID]),entry.isRoot&&entry.ref&&(log(entryID,": Remote root has a parent"),localDataError=!0)}d.removeDeletedItems(seen),self.endAction()},self.migrateData=function migrateDataFn(){function reloadFn(){reqCount++,2===reqCount&&g.reload()}var stopDocLoad=!1,requireLocalReload=!1,requireRemoteReload=!1,trashDoc=!1,remoteVersion=self.root.get("dataVersion");try{g.PAssert(1757,g.isNumber(remoteVersion),"Remote data version must always be numeric",remoteVersion)}catch(PERR){g.reportError(PERR)}if(CURRENT_VERSION>remoteVersion){self.beginAction(),log("Migrating to latest version: ",remoteVersion);try{switch(remoteVersion){case 0:case 1:case 2:case 3:case 4:trashDoc=!0,log("Remote Migration Completed");break;default:try{g.PAssert(1758,!1,"Unknown remoteVersion: ",remoteVersion)}catch(PERR){g.reportError(PERR)}}}catch(err){requireRemoteReload=!0,g.reportError(err)}self.endAction(),self.model.getRoot().set("dataVersion",CURRENT_VERSION),log("Done Migrating Remote Data!",CURRENT_VERSION)}else remoteVersion>CURRENT_VERSION&&(requireLocalReload=!0,stopDocLoad=!0);if(d.hasLocalData){var localVersion=g.settings.get(Settings.localDataVersion)||0;try{g.PAssert(1760,g.isNumber(localVersion),"Local data version must be numeric",localVersion)}catch(PERR){g.reportError(PERR)}if(g.isNumber(localVersion)){if(CURRENT_VERSION>localVersion){try{switch(localVersion){case 0:case 1:case 2:case 3:case 4:stopDocLoad=!0,trashDoc=!0,log("Local Migration Completed");break;default:try{g.PAssert(1761,!1,"Unknown localVersion",localVersion)}catch(PERR){g.reportError(PERR)}}}catch(err){requireLocalReload=!0,g.reportError(err)}g.settings.set(Settings.localDataVersion,CURRENT_VERSION),log("Done Migrating Local Data!",CURRENT_VERSION)}else if(localVersion>CURRENT_VERSION)try{g.PAssert(1762,!1,"localVersion is greater than our CURRENT_VERSION",localVersion,CURRENT_VERSION)}catch(PERR){g.reportError(PERR)}}else stopDocLoad=!0,g.menus.alert({text:"There was an error loading your document, please try loading a different document and contact support@moo.do.",actionText:"OKAY"})}else g.settings.set(Settings.localDataVersion,remoteVersion);if(trashDoc)promptTrashDoc();else if(requireLocalReload||requireRemoteReload)if(requireLocalReload&&!requireRemoteReload)g.AppCache.runOnFinish(function(){g.reload()},!0);else if(requireRemoteReload&&!requireLocalReload)self.registerSaveNotify(function(){g.reload()});else{var reqCount=0;g.AppCache.runOnFinish(reloadFn,!0),self.registerSaveNotify(reloadFn)}return stopDocLoad},self.beginAction=function beginActionFn(){if(self.model){try{g.PAssert(1775,!self.flushingDeferredActions,"Should never begin a new action while flushing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1776,!self.inCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1777,!self.wantCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1778,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}self.wantCompoundOperation=!0}};var ensureActionTimeout;self.beginWriteAction=function beginWriteActionFn(){if(self.model&&!self.flushingDeferredActions){try{g.PAssert(1779,self.inCompoundOperation||self.wantCompoundOperation,"If performing an action, we should have already requested a compound operation")}catch(PERR){g.reportError(PERR)}if(!self.inCompoundOperation&&self.wantCompoundOperation)try{self.deferredActionsCommitted&&self.flushDeferredActions(),ensureActionTimeout=setTimeout(ensureWriteAction,0),self.model.beginCompoundOperation(),self.inCompoundOperation=!0,self.wantCompoundOperation=!1,self.deferredActionsCommitted||self.executeDeferredActions()}catch(err){g.reportError(err)}else try{g.PAssert(1780,!self.wantCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}}},self.endAction=function endActionFn(){if(self.model){try{g.PAssert(1781,!self.flushingDeferredActions,"Should never end an action while flushing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1782,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1783,self.inCompoundOperation||self.wantCompoundOperation,"If ending an action, a beginning should have happened")}catch(PERR){g.reportError(PERR)}try{self.hasPendingDeferredActions&&(self.deferredActionsCommitted=!0),self.inCompoundOperation&&self.model.endCompoundOperation()}catch(err){g.goog.recoverFromError(err)}finally{self.inCompoundOperation=!1,self.wantCompoundOperation=!1,clearTimeout(ensureActionTimeout),ensureActionTimeout=void 0}}};var DEFERRED_ACTION_TIMEOUT=800,deferredActions={},flushDeferredActionsTimeout;self.performDeferredAction=function performDeferredActionFn(item,action){try{g.PAssert(1786,item,"Must supply a valid item to perform the action on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1787,action,"Must supply a valid action to be performed")}catch(PERR){g.reportError(PERR)}if(self.model){try{g.PAssert(1788,!self.inCompoundOperation,"Cannot perform deferred action after a compound operation has started")}catch(PERR){g.reportError(PERR)}if(deferredActions[item.id])for(var prop in action)deferredActions[item.id].changes[prop]=action[prop];else deferredActions[item.id]={item:item,changes:action};self.hasPendingDeferredActions=!0,clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=setTimeout(self.flushDeferredActions,DEFERRED_ACTION_TIMEOUT)
}},self.executeDeferredActions=function executeDeferredActionsFn(){self.flushingDeferredActions=!0;try{for(var id in deferredActions)saveChangesInternal(deferredActions[id].item,deferredActions[id].changes)}catch(err){g.reportError(err)}finally{self.flushingDeferredActions=!1,self.hasPendingDeferredActions=!1,deferredActions={},self.deferredActionsCommitted=!1}},self.flushDeferredActions=function flushDeferredActionsFn(){if(self.model&&!self.isClosed){try{g.PAssert(1789,!self.flushingDeferredActions,"Should never recursively call flushDeferredActions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1790,!self.inCompoundOperation,"Must flush deferred actions before starting a compound operation")}catch(PERR){g.reportError(PERR)}if(self.hasPendingDeferredActions){clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=void 0;try{self.model.beginCompoundOperation(),self.executeDeferredActions(),self.model.endCompoundOperation()}catch(err){g.reportError(err)}}}},self.createNewItem=function createNewItemFn(item,hasItems,hasArchivedItems){self.beginWriteAction();try{g.PAssert(1795,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1796,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1797,self.inCompoundOperation,"Should always create an item inside of a compound operation")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1798,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1799,self.model,"Need a valid model to create collaborative items")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1800,!item.data,"When initializing a new item, it should have no gdata components already")}catch(PERR){g.reportError(PERR)}var map=self.model.createMap();if(item.data=map,item.data.connectIdentifier=self.connectIdentifier(),self.set(map,"text",item.getRawText()),hasItems){var collabList=self.model.createList();self.set(map,"items",collabList)}if(hasArchivedItems){var collabArchiveList=self.model.createList();self.set(map,"archivedItems",collabArchiveList)}return self.set(map,"dateCreated",item.dateCreated.getTime()),item.id=map.id,itemCache[map.id]||(itemCache[map.id]=map),map.id},self.initializeNewItem=function initializeNewItemFn(item){self.beginWriteAction();try{g.PAssert(1801,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1802,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1803,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1804,self.inCompoundOperation,"Should always initialize an item inside of a compound operation")}catch(PERR){g.reportError(PERR)}if(item.hasChildren()){var items=item.items(),collabList=ensureRemoteItemsArray(item);try{g.PAssert(1805,collabList,"Must have a valid collab list for normal init")}catch(PERR){g.reportError(PERR)}for(var i=0;i<items.length;++i){try{g.PAssert(1806,items[i].data,"Item must have a valid remote to be added to a collab list")}catch(PERR){g.reportError(PERR)}collabList.push(items[i].data)}}if(item.hasArchivedChildren()){var archivedItems=item.archivedItems(!0),collabArchivedList=ensureRemoteArchiveArray(item);try{g.PAssert(1807,collabArchivedList,"Must have a valid collab list for archived init")}catch(PERR){g.reportError(PERR)}for(var i=0;i<archivedItems.length;++i){try{g.PAssert(1808,archivedItems[i].data,"Item must have a valid remote to be added to a collab list")}catch(PERR){g.reportError(PERR)}collabArchivedList.push(archivedItems[i].data)}}if(item.hasNote()){var note=item.getNote();try{g.PAssert(1809,note.data,"Note must have a valid remote to be added to an item")}catch(PERR){g.reportError(PERR)}self.set(item,"note",note.data)}attachEvents(item)},self.attachEventsToItem=function attachEventsToItemFn(item){try{g.PAssert(1810,item instanceof VMLI,"Must pass in a valid local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1811,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1812,item.data,"Must have loaded data from gdrive before attaching events to item")}catch(PERR){g.reportError(PERR)}attachEvents(item)};var undoRedoStateChangeHandler;self.registerForUndoRedoStateChange=function registerForUndoRedoStateChangeFn(handler){self.model?(self.model.addEventListener(gapi.drive.realtime.EventType.UNDO_REDO_STATE_CHANGED,handler.stateChangeForUndoRedo),handler.stateChangeForUndoRedo({canUndo:self.model.canUndo,canRedo:self.model.canRedo})):undoRedoStateChangeHandler=handler},self.registerForSaveStateChange=function registerForSaveStateChangeFn(handler){try{g.PAssert(1813,self.doc,"Must have a valid doc to connect to")}catch(PERR){g.reportError(PERR)}self.doc.addEventListener(gapi.drive.realtime.EventType.DOCUMENT_SAVE_STATE_CHANGED,handler)},self.loadCollaborators=function loadCollaboratorsFn(){for(var collabs=self.doc.getCollaborators(),selfInfo,i=0;i<collabs.length;++i){var collab=collabs[i];collab.isMe&&(selfInfo=collab)}self.authenticatedUser(selfInfo)},self.undoAction=function undoActionFn(){self.flushDeferredActions();try{g.PAssert(1814,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1815,self.model.canUndo)}catch(PERR){g.reportError(PERR)}self.model.undo()},self.redoAction=function redoActionFn(){self.flushDeferredActions();try{g.PAssert(1816,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1817,self.model.canRedo)}catch(PERR){g.reportError(PERR)}self.model.redo()},self.getItemList=function getItemListFn(model,isArchived){self.beginWriteAction();try{g.PAssert(1818,!(model instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return isArchived?self.get(model,"archivedItems"):self.get(model,"items")},self.ensureItemList=function ensureItemListFn(item,isArchived){self.beginWriteAction();try{g.PAssert(1819,item instanceof VMLI,"Must pass in a valid local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1820,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}return isArchived?ensureRemoteArchiveArray(item):ensureRemoteItemsArray(item)},self.canSave=function canSaveFn(item){if(self.initialized){var data=item instanceof VMLI?item.data:item;try{g.PAssert(1827,data,"Must have a valid remote item to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1828,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1829,!data||data.connectIdentifier===self.connectIdentifier(),"Using remote item data that is out of date",data?data.connectIdentifier:-1,self.connectIdentifier())}catch(PERR){g.reportError(PERR)}return data&&!self.isClosed&&data.connectIdentifier===self.connectIdentifier()?data:!1}},self.deleteTree=function deleteTreeFn(item){self.beginWriteAction();try{g.PAssert(1830,!(item instanceof VMLI),"Must not be a VMLI, should be a remote item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1831,!g.isString(item),"Must pass in a valid remote item not an ID")}catch(PERR){g.reportError(PERR)}var items=self.get(item,"items");if(items)for(var i=0;i<items.length;i++){var child=items.get(i);self.deleteTree(child)}delete itemCache[item.id]},self.noteSet=function noteSetFn(item,noteItem){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();try{g.PAssert(1832,item,"Must provide a valid item to set a note on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1833,!noteItem||noteItem.isNote(),"Must be removing a note or setting note with a valid note item")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return ReturnValue.Error;var noteData;noteItem&&(noteData=self.canSave(noteItem)),self.set(itemData,"note",noteData)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.itemAdded=function itemAddedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item,addedItem=params.addedItem,index=params.index,isArchived=params.isArchived,noVersion=params.noVersion;try{g.PAssert(1834,void 0!==item&&void 0!==addedItem&&void 0!==isArchived,"itemAdded is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1835,index>=-1||void 0===index,"Invalid index",index)}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return ReturnValue.Error;var addedData=self.canSave(addedItem);try{g.PAssert(1836,addedData,"Must have valid gdata for the item being inserted")}catch(PERR){g.reportError(PERR)}d.addPendingUpdate(item.id),d.addPendingUpdate(addedItem.id);var arr=self.ensureItemList(item,isArchived);try{g.PAssert(1837,arr,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}0>index||isNaN(index)||index>arr.length?arr.push(addedData):arr.insert(index,addedData),noVersion||setRemoteVersion(addedData)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.itemsAdded=function itemsAddedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item;try{g.PAssert(1838,item instanceof VMLI,"Passed in item must be a VMLI")}catch(PERR){g.reportError(PERR)}var addedItems=params.addedItems,index=params.index,isArchived=params.isArchived,noVersion=params.noVersion;try{g.PAssert(1839,void 0!==item&&void 0!==addedItems&&void 0!==isArchived,"itemsAdded is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1840,isNaN(index)||index>=0,"Must provide a valid item index when adding an item to a remote list")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);try{g.PAssert(1841,itemData,"Must have valid item data when adding an item")}catch(PERR){g.reportError(PERR)}if(!itemData)return ReturnValue.Error;var arr=self.ensureItemList(item,isArchived);try{g.PAssert(1842,arr,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}for(var addedArr=new Array(addedItems.length),i=0;i<addedItems.length;++i)addedArr[i]=addedItems[i].data,d.addPendingUpdate(addedItems[i].id),!noVersion&&addedArr[i]&&setRemoteVersion(addedArr[i]);if(d.addPendingUpdate(item.id),0>index||isNaN(index)){try{g.PAssert(1843,isArchived,"Only archived items should be inserted into a list by pushing")}catch(PERR){g.reportError(PERR)}arr.pushAll(addedArr)}else arr.insertAll(index,addedArr)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.itemRemoved=function itemRemovedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item,index=params.index,numToRemove=params.numToRemove,isArchived=params.isArchived,noDelete=params.noDelete,noVersion=params.noVersion;try{g.PAssert(1844,void 0!==item&&void 0!==index&&void 0!==numToRemove&&void 0!==isArchived,"itemRemoved is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1845,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);try{g.PAssert(1846,itemData,"Must have valid item data when removing an item")}catch(PERR){g.reportError(PERR)}if(!itemData)return ReturnValue.Error;isNaN(numToRemove)&&(numToRemove=1);var arr=self.getItemList(itemData,isArchived);try{g.PAssert(1847,arr,"Must have a valid remote list to remove the item from")}catch(PERR){g.reportError(PERR)}for(var i=index;index+numToRemove>i;i++){var deleted=arr.get(i);d.addPendingUpdate(deleted.id),noVersion||setRemoteVersion(deleted),noDelete||self.deleteTree(deleted)}d.addPendingUpdate(item.id),1===numToRemove?arr.remove(index):arr.removeRange(index,index+numToRemove)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.itemMoved=function itemMovedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item,newInfo=params.newInfo,oldParent=params.oldParent,oldInfo=params.oldInfo,noVersion=params.noVersion;try{g.PAssert(1848,void 0!==item&&void 0!==newInfo&&void 0!==oldParent&&void 0!==oldInfo,"itemMoved is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1849,newInfo&&newInfo.index>=-1)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1850,newInfo&&void 0!==newInfo.isArchived)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1851,oldParent)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1852,oldInfo&&oldInfo.index>=0)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1853,oldInfo&&void 0!==oldInfo.isArchived)}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);try{g.PAssert(1854,itemData,"Must have valid item data when moving")}catch(PERR){g.reportError(PERR)}if(!itemData)return ReturnValue.Error;var oldParentData=self.canSave(oldParent);try{g.PAssert(1855,oldParentData,"Must have valid src item data when moving")}catch(PERR){g.reportError(PERR)}if(!oldParentData)return ReturnValue.Error;var newParentData=self.canSave(item.parent());try{g.PAssert(1856,newParentData,"Must have valid dst item data when moving")}catch(PERR){g.reportError(PERR)}if(!newParentData)return ReturnValue.Error;var srcList=self.getItemList(oldParentData,oldInfo.isArchived);try{g.PAssert(1857,srcList,"Must have a valid remote list to remove the item from")}catch(PERR){g.reportError(PERR)}var dstList=self.ensureItemList(item.parent(),newInfo.isArchived);try{g.PAssert(1858,dstList,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}var dstIndex=newInfo.index;(newInfo.index<0||isNaN(newInfo.index)||newInfo.index>dstList.length)&&(dstIndex=dstList.length),srcList.moveToList(oldInfo.index,dstList,dstIndex),d.addPendingUpdate(item.id),d.addPendingUpdate(oldParent.id),d.addPendingUpdate(item.parent().id),noVersion||setRemoteVersion(itemData)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.itemArchived=function itemArchivedFn(item,itemArchived,index){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();try{g.PAssert(1859,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);try{g.PAssert(1860,itemData,"Must have valid item data when archiving an item")}catch(PERR){g.reportError(PERR)}if(!itemData)return ReturnValue.Error;d.addPendingUpdate(item.id),d.addPendingUpdate(itemArchived.id);var items=self.getItemList(itemData,!1);try{g.PAssert(1861,items,"Must be an items array present")}catch(PERR){g.reportError(PERR)}var archivedItems=ensureRemoteArchiveArray(item);try{g.PAssert(1862,archivedItems,"Must be an archived items array present")}catch(PERR){g.reportError(PERR)}if(!(index<items.length)){try{g.PAssert(1863,!1,"Passed in an invalid idnex to archive an item at")}catch(PERR){g.reportError(PERR)}return ReturnValue.Error}items.remove(index),archivedItems.push(itemArchived.data),setRemoteVersion(itemArchived.data)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.itemUnarchived=function itemUnarchivedFn(item,itemUnarchived,removeIndex,insertIndex){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();try{g.PAssert(1864,removeIndex>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);try{g.PAssert(1865,itemData,"Must have valid item data when archiving an item")}catch(PERR){g.reportError(PERR)}if(!itemData)return ReturnValue.Error;d.addPendingUpdate(item.id),d.addPendingUpdate(itemUnarchived.id);var items=self.get(itemData,"items");try{g.PAssert(1866,items,"Must be an items array present")}catch(PERR){g.reportError(PERR)}var archivedItems=self.get(itemData,"archivedItems");try{g.PAssert(1867,archivedItems,"Must be an archived items array present")}catch(PERR){g.reportError(PERR)}archivedItems.remove(removeIndex),items.insert(insertIndex,itemUnarchived.data),setRemoteVersion(itemUnarchived.data)}catch(err){throw g.reportError(err),err}return ReturnValue.Success},self.saveChanges=function saveChangesFn(item,changes){self.isConnected()&&(self.inCompoundOperation?saveChangesInternal(item,changes):self.performDeferredAction(item,changes))},self.resetDriveData=function resetDriveDataFn(){itemCache={},self.initialized=!1,self.doc=void 0,self.model=void 0,self.root=void 0,self.rootItem=void 0,self.rootID=void 0,window.__remoteDoc=void 0,self.cachesRemote=void 0,d.forEachModel(function(vmli){vmli&&vmli.resetDriveData()}),g.vmMain.notifyDriveDisconnect(),self.inCompoundOperation=!1,self.wantCompoundOperation=!1,self.flushingDeferredActions=!1,self.deferredActionsCommitted=!1,clearTimeout(ensureActionTimeout),ensureActionTimeout=void 0,clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=void 0,self.hasPendingDeferredActions=!1,deferredActions={}},self.close=function closeFn(){try{g.PAssert(1878,driveRealtimeStatus===RealtimeStatus.Error,"Invalid state for document close: ",driveRealtimeStatus)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1879,!self.wantCompoundOperation,"Closing the doc with a deferred compound operation")}catch(PERR){g.reportError(PERR)}if(self.doc&&!self.isClosed){log("---- Closing Remote Document! ----"),self.isClosed=!0,g.vmMain.setGDriveStatus(DriveStatus.Offline);try{self.doc.close()}catch(err){log("Error Closing Doc: ",err)}self.resetDriveData()}else g.vmMain.isReconnecting()&&g.vmMain.setGDriveStatus(DriveStatus.Offline)};var retryCount=0,retryIntervals=[1e3,2e4,4e4,6e4,9e4],driveReconnectTimer;self.setupReconnect=function setupReconnectFn(){try{g.PAssert(1881,driveRealtimeStatus===RealtimeStatus.Error||driveRealtimeStatus===RealtimeStatus.XHRError,"Invalid state for setup reconnect: ",driveRealtimeStatus)}catch(PERR){g.reportError(PERR)}try{g.PAssert(1882,!driveReconnectTimer,"Reconnect timer already active")}catch(PERR){g.reportError(PERR)}var retryTimeout=getRetryInterval(retryCount++);clearTimeout(driveReconnectTimer),driveReconnectTimer=setTimeout(tryDriveReconnect,retryTimeout)},self.notifyReconnectFailure=function notifyReconnectFailureFn(){self.setupReconnect()},self.notifyReconnectSuccess=function notifyReconnectSuccessFn(){retryCount=0,clearTimeout(driveReconnectTimer),driveReconnectTimer=void 0};var RealtimeStatus={Disconnected:0,Connecting:1,Connected:2,Reconnecting:3,Error:4,XHRError:5},driveRealtimeStatus=RealtimeStatus.Disconnected;self.getDriveRealtimeStatus=function getDriveRealtimeStatusFn(){return driveRealtimeStatus};var _connectIdentifier=1;self.connectIdentifier=function connectIdentifierFn(){return _connectIdentifier};var isXHRWrapped=!1;if(self.driveRealtimeLoad=function driveRealtimeLoadFn(id,onLoaded,onInitialized,onError){try{g.PAssert(1891,driveRealtimeStatus===RealtimeStatus.Disconnected||driveRealtimeStatus===RealtimeStatus.Error,"Loading realtime document from invalid state")}catch(PERR){g.reportError(PERR)}var prevStatus=driveRealtimeStatus;if(driveRealtimeStatus===RealtimeStatus.Disconnected?setDriveRealtimeStatus(RealtimeStatus.Connecting):(driveRealtimeStatus===RealtimeStatus.Error||driveRealtimeStatus===RealtimeStatus.XHRError)&&setDriveRealtimeStatus(RealtimeStatus.Reconnecting),prevStatus===RealtimeStatus.Disconnected||prevStatus===RealtimeStatus.Error||prevStatus===RealtimeStatus.XHRError){isXHRWrapped=g.registerURLForNotifyXHR("https://drive.google.com/otservice/gs",onRSCDrive);try{g.PAssert(1892,isXHRWrapped,"XHR must always be successfully wrapped")}catch(PERR){g.reportError(PERR)}gapi.drive.realtime.load(id,fwdOnLoaded(onLoaded),fwdOnInitialized(onInitialized),fwdOnError(onError))}},self.onInitialized=function onInitializedFn(model){log("Initializing",model),d||(d=require("data")),VMLI||(VMLI=require("VMLI"));var home=model.createMap(),homeItems=model.createList();self.set(home,"text","Home"),self.set(home,"items",homeItems),self.set(home,"archivedItems",model.createList()),self.set(home,"dateCreated",Date.now());var root=model.getRoot();root.set("dataVersion",CURRENT_VERSION),root.set("root",home),g.goog.getDocumentFolder(g.goog.getDocId(),function(docFolderID){root.set("docFolderID",docFolderID)}),root.set("settings",model.createMap()),root.set("caches",model.createMap())},DETAILED_STATS){var __RCacheStats={reads:0,writes:0,exists:0,updates:0,deletes:0,ensures:0,rchanges:0};self.getPreviewCacheStats=function getPreviewCacheStatsFn(){return __RCacheStats},window.__dumpRCacheStats=function(){log("---- RCache Stats ----"),log(" Reads: "+__RCacheStats.reads),log(" Writes: "+__RCacheStats.writes),log(" Exists: "+__RCacheStats.exists),log(" Updates: "+__RCacheStats.updates),log(" Deletes: "+__RCacheStats.deletes),log(" Ensures: "+__RCacheStats.ensures),log(" RChanges: "+__RCacheStats.rchanges),log("----------------------")}}var missedCacheWrites={},cacheMaxEntrySize=300;self.maxCacheEntrySize=function maxCacheEntrySizeFn(){return cacheMaxEntrySize},self.cacheChanged=function cacheChangedFn(cache,e){if(e.ocHandled||e.isLocal)return!1;for(var i=0;i<e.events.length;++i){var ev=e.events[i];switch(DETAILED_STATS&&__RCacheStats.rchanges++,ev.type){case gapi.drive.realtime.EventType.VALUES_ADDED:self.notifyListeners(cache,DataChangeType.Add,ev.property,ev.newValue);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:self.notifyListeners(cache,DataChangeType.Remove,ev.property,ev.newValue);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:self.notifyListeners(cache,DataChangeType.Change,ev.property,ev.newValue);break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:try{g.PAssert(1894,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}}};var cacheChangeListeners={};self.notifyListeners=function notifyListenersFn(cache,type,id,data){var listeners=cacheChangeListeners[cache];try{g.PAssert(1895,listeners&&listeners.length>0,"Should always have an interested party if we are receiving notifications")}catch(PERR){g.reportError(PERR)}try{var dataObj;data&&(dataObj=JSON.parse(data),dataObj.id=id);for(var i=0;i<listeners.length;++i)try{listeners[i](type,id,dataObj)}catch(err){g.reportError(err)}}catch(parseErr){g.reportError(parseErr)}},self.hookCacheListeners=function hookCacheListenersFn(){for(var cache in cacheChangeListeners)try{self.hookCacheListener(cache)}catch(err){g.reportError(err)}},self.hookCacheListener=function hookCacheListenerFn(cache){var remoteCache=self.cachesRemote.get(cache);try{g.PAssert(1896,remoteCache,"If we are listening for a cache, it must have been ensured first")}catch(PERR){g.reportError(PERR)}var success=!1;if(remoteCache){var dataCache=remoteCache.get("data");try{g.PAssert(1897,dataCache,"Malformed cache, must have a data entry present")}catch(PERR){g.reportError(PERR)}dataCache&&(dataCache.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,self.cacheChanged.bind(self,cache)),success=!0)}return success},self.registerForCacheChanges=function registerForCacheChangesFn(cache,cb){try{g.PAssert(1898,cb,"Must provide a valid callback function for cache changes")}catch(PERR){g.reportError(PERR)}var success=!1,listeners=cacheChangeListeners[cache];if(listeners){try{g.PAssert(1899,listeners.indexOf(cb)<0,"Should never double register a listener")}catch(PERR){g.reportError(PERR)}listeners.push(cb)}else cacheChangeListeners[cache]=[cb];return self.isCacheAvailable(cache)&&(success=self.hookCacheListener(cache)),success},self.unregisterForCacheChanges=function unregisterForCacheChangesFn(cache,cb){var listeners=cacheChangeListeners[cache];try{g.PAssert(1900,listeners,"Must have previously registered with a cache")}catch(PERR){g.reportError(PERR)}var removedIndex=listeners.remove(cb);try{g.PAssert(1901,removedIndex>=0,"Did not try to remove a valid listener")}catch(PERR){g.reportError(PERR)}return removedIndex>=0},self.loadDataCaches=function loadDataCachesFn(){self.cachesRemote=self.root.get("caches"),self.cachesRemote||(self.cachesRemote=self.model.createMap(),self.root.set("caches",self.cachesRemote)),self.writeMissedCacheEntries(),self.sendAvailableNotifications(),self.hookCacheListeners()},self.queryCache=function queryCacheFn(cache,key){try{g.PAssert(1902,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1903,!g.isTempId(key),"Should not query remote cache for local only items")}catch(PERR){g.reportError(PERR)}if(DETAILED_STATS&&__RCacheStats.reads++,self.cachesRemote){var remoteCache=self.cachesRemote.get(cache);if(remoteCache){var cacheEntry=JSON.parse(remoteCache.get("data").get(key));if(cacheEntry)return cacheEntry.id=key,cacheEntry}}return void 0},self.hasCacheEntry=function hasCacheEntryFn(cache,key){try{g.PAssert(1904,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1905,!g.isTempId(key),"Should not query remote cache for local only items")}catch(PERR){g.reportError(PERR)}if(DETAILED_STATS&&__RCacheStats.exists++,self.cachesRemote){var remoteCache=self.cachesRemote.get(cache);if(remoteCache)return!!remoteCache.get("data").get(key)}return!1},self.updateCache=function updateCacheFn(cache,key,value){try{g.PAssert(1906,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1907,!g.isTempId(key),"Should never save a local only item to the remote cache")}catch(PERR){g.reportError(PERR)}var oldEntry,remoteCache=self.ensureCache(cache);if(value=JSON.stringify(value),remoteCache){oldEntry=remoteCache.get("data").get(key);var oldSize=entrySize(oldEntry),newSize=entrySize(value);try{g.PAssert(1908,newSize<self.maxCacheEntrySize(),"New cache entry too large",newSize)}catch(PERR){g.reportError(PERR)}var sizeDiff=newSize-oldSize,cacheInfo=remoteCache.get("info");if(oldEntry?DETAILED_STATS&&__RCacheStats.updates++:cacheInfo.set("entries",cacheInfo.get("entries")+1),cacheInfo.set("size",cacheInfo.get("size")+sizeDiff),void 0!==value)DETAILED_STATS&&__RCacheStats.writes++,remoteCache.get("data").set(key,value);else{try{g.PAssert(1909,oldEntry,"Should never be setting undefined->undefined")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&__RCacheStats.deletes++,remoteCache.get("data").delete(key)}}else missedCacheWrites[key]=value;return oldEntry},self.ensureCache=function ensureCacheFn(cache){DETAILED_STATS&&__RCacheStats.ensures++;var remoteCache;if(self.cachesRemote&&(remoteCache=self.cachesRemote.get(cache),!remoteCache)){remoteCache=self.model.createMap();var cacheInfo=self.model.createMap();cacheInfo.set("entries",0),cacheInfo.set("size",0),remoteCache.set("info",cacheInfo);var cacheData=self.model.createMap();remoteCache.set("data",cacheData),self.cachesRemote.set(cache,remoteCache)}return remoteCache},self.clearCache=function clearCacheFn(cache){try{g.PAssert(1910,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}if(self.cachesRemote){var remoteCache=self.cachesRemote.get(cache);if(remoteCache){remoteCache.get("data").clear();var cacheInfo=remoteCache.get("info");try{g.PAssert(1911,cacheInfo,"Malformed cache, every cache must have an info object")}catch(PERR){g.reportError(PERR)}cacheInfo.set("entries",0),cacheInfo.set("size",0)}}},self.clearCaches=function clearCachesFn(){},self.getCacheSize=function getCacheSizeFn(cache){try{g.PAssert(1912,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}if(self.cachesRemote){var remoteCache=self.cachesRemote.get(cache);if(remoteCache)return remoteCache.get("info").get("size")}return 0},self.isCacheAvailable=function isCacheAvailableFn(cache){return self.cachesRemote&&self.cachesRemote.get(cache)};var notifyOnCacheAvailable=[];self.requestNotifyWhenAvailable=function requestNotifyWhenAvailableFn(cb){try{g.PAssert(1913,notifyOnCacheAvailable.indexOf(cb)<0,"Should not push same callback multiple times")}catch(PERR){g.reportError(PERR)}self.cachesRemote?cb():notifyOnCacheAvailable.push(cb)},self.sendAvailableNotifications=function sendAvailableNotificationsFn(){for(var i=0;i<notifyOnCacheAvailable.length;++i)notifyOnCacheAvailable[i]();notifyOnCacheAvailable=[]},self.writeMissedCacheEntries=function writeMissedCacheEntriesFn(){for(var key in self.missedCacheWrites){var value=self.missedCacheWrites[key];log("XX Writing missed cache entry: ",key,value)}self.missedCacheWrites={}},self.poke=function pokeFn(){if(self.root&&!self.isClosed)try{var pk=self.root.get("poke");pk?self.root.set("poke",pk+1):self.root.set("poke",1)}catch(err){log("Exception during poke, reconnecting: ",err),self.close(),self.setupReconnect()}},window.__poke=self.poke,self.rootChanged=function rootChangedFn(e){if(e.ocHandled||e.isLocal||self.root.id!==e.target.id)return!1;for(var i=0;i<e.events.length;++i)switch(e.events[i].type){case gapi.drive.realtime.EventType.VALUES_ADDED:case gapi.drive.realtime.EventType.VALUES_REMOVED:break;case gapi.drive.realtime.EventType.VALUE_CHANGED:"dataVersion"===e.property&&(e.newValue>CURRENT_VERSION?g.AppCache.checkForUpdate(!0):e.newVersion<CURRENT_VERSION&&g.reportError(new Error("Remote setting dataVersion to invalid value"+e.newVersion)));break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:try{g.PAssert(1914,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}},self.isConnected=function isConnectedFn(){return self.initialized&&!self.isClosed&&!!self.model},self.onLoad=function onLoadFn(doc){try{try{window.__LOAD_HANDLES.push(g.getCurrentStack("Document Opened Handled"))}catch(err){g.reportError(err)}try{g.PAssert(1915,self.isClosed,"Document must not already be open when we are loading")}catch(PERR){g.reportError(PERR)}try{self.isClosed||g.reportError("Multi-Document Load",window.__LOAD_REQUESTS.ordered())}catch(err){g.reportError(err)}self.initialized=!0,self.loadedOnce=!0,d||(d=require("data")),VMLI||(VMLI=require("VMLI")),self.doc=doc,self.model=doc.getModel(),self.root=self.model.getRoot(),self.root.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,self.rootChanged),self.isClosed=!1,self.registerForSaveStateChange(self.onSaveStateChange);var stopLoadingRemote=self.migrateData();return stopLoadingRemote?(log("---- Skipping Document Load! ----"),self.isClosed=!0,self.initialized=!1,self.doc=void 0,self.model=void 0,self.root=void 0,!1):(self.loadDataCaches(),self.rootItem=self.root.get("root"),self.rootItem?(self.rootID=self.rootItem.id,window.__remoteDoc=doc,undoRedoStateChangeHandler&&(self.registerForUndoRedoStateChange(undoRedoStateChangeHandler),undoRedoStateChangeHandler=void 0),g.vmMain&&g.vmMain.root()?g.vmMain.loadGDriveData():g.requireGDriveDataCallback=!0,self.loadCollaborators(),!0):void g.menus.alert({text:"Moo.do has encountered an error. The developers have been notified to make sure this doesn't happen again. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",action:function actionFn(){d.clearData(function(){g.reload()})}}))}catch(err){g.reportError(err)}},self.getServerVersion=function getServerVersionFn(){return self.model&&!self.isClosed?self.model.serverVersion:void 0};var notifyOfSaveChange=[];self.registerSaveNotify=function registerSaveNotifyFn(fn){notifyOfSaveChange.push(fn)};var lastPending=!1,lastSaving=!1,saveTimeout;return self.onSaveStateChange=function onSaveStateChangeFn(e){if(lastPending!==e.isPending||lastSaving!==e.isSaving){if(e.isSaving||e.isPending)navigator.onLine?e.isSaving&&(e.isPending||g.vmMain.setGDriveStatus(DriveStatus.Saving),clearTimeout(saveTimeout),saveTimeout=setTimeout(self.onErrorSaving,self.offlineTimeoutMS)):g.vmMain.setGDriveStatus(DriveStatus.Offline);else{g.vmMain.setGDriveStatus(DriveStatus.Saved),d.clearPendingUpdates(),clearTimeout(saveTimeout),saveTimeout=void 0,g.messageQueue.clearMessage(MessageID.ConnectionError);for(var i=0;i<notifyOfSaveChange.length;++i)notifyOfSaveChange[i](self.numChanges);self.numChanges=0
}lastPending=e.isPending,lastSaving=e.isSaving}},self.onErrorSaving=function onErrorSavingFn(){g.vmMain.setGDriveStatus(DriveStatus.Offline),saveTimeout=void 0},self.getVersion=function getVersionFn(map,type){try{g.PAssert(1916,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}var field,v;switch(type){case VersionType.Structure:v=map.get(g.translateFieldIn("version"));break;case VersionType.Text:v=map.get(g.translateFieldIn("versionText"));break;default:v=-2;try{g.PAssert(1917,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},self.get=function getFn(map,field){try{g.PAssert(1918,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return map.get(g.translateFieldIn(field))},self.set=function setFn(map,field,value){self.beginWriteAction();try{g.PAssert(1919,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return void 0===value&&(value=null),map.set(g.translateFieldIn(field),value)},self.delete=function deleteFn(map,field){self.beginWriteAction();try{g.PAssert(1920,!(map instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return map.delete(g.translateFieldIn(field))},self.findInTree=function findInTreeFn(item,searched){function findItemInTree(arr,isArchived){if(!arr)return!1;for(var i=0;i<arr.length;i++){var result=arr.get(i);if(result.id===item.id)return{parent:searched,index:i,isArchived:isArchived};var found=self.findInTree(item,result);if(found)return found}return void 0}searched||(searched=self.rootItem);var items=self.get(searched,"items"),foundItem=findItemInTree(items,!1);if(!foundItem){var archivedItems=self.get(searched,"archivedItems");foundItem=findItemInTree(archivedItems,!0)}return foundItem},self});var idbModules={},cleanInterface=!1;!function(){var testObject={test:!0};if(Object.defineProperty)try{Object.defineProperty(testObject,"test",{enumerable:!1}),testObject.test&&(cleanInterface=!0)}catch(e){}}(),function(idbModules){function callback(fn,context,event,func){event.target=context,"function"==typeof context[fn]&&context[fn].apply(context,[event]),"function"==typeof func&&func()}function throwDOMException(name,message,error){var e;try{e=new DOMException.prototype.constructor(0,message)}catch(_error){e=new Error(message)}throw e.name=name,e.message=message,e}var StringList=function(){this.length=0,this._items=[],cleanInterface&&Object.defineProperty(this,"_items",{enumerable:!1})};if(StringList.prototype={contains:function(str){return-1!==this._items.indexOf(str)},item:function(key){return this._items[key]},indexOf:function(str){return this._items.indexOf(str)},push:function(item){this._items.push(item),this.length+=1;for(var i=0;i<this._items.length;i++)this[i]=this._items[i]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var i in this)i===String(parseInt(i,10))&&delete this[i];for(i=0;i<this._items.length;i++)this[i]=this._items[i]}},cleanInterface)for(var i in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(StringList.prototype,i,{enumerable:!1});idbModules.util={throwDOMException:throwDOMException,callback:callback,quote:function(arg){return"'"+arg+"'"},StringList:StringList}}(idbModules),function(idbModules){var Sca=function(){return{decycle:function(object,callback){function checkForCompletion(){0===queuedObjects.length&&returnCallback(derezObj)}function readBlobAsDataURL(blob,path){var reader=new FileReader;reader.onloadend=function(loadedEvent){var dataURL=loadedEvent.target.result,blobtype="blob";updateEncodedBlob(dataURL,path,blobtype)},reader.readAsDataURL(blob)}function updateEncodedBlob(dataURL,path,blobtype){var encoded=queuedObjects.indexOf(path);path=path.replace("$","derezObj"),eval(path+'.$enc="'+dataURL+'"'),eval(path+'.$type="'+blobtype+'"'),queuedObjects.splice(encoded,1),checkForCompletion()}function derez(value,path){var i,name,nu;if(!("object"!=typeof value||null===value||value instanceof Boolean||value instanceof Date||value instanceof Number||value instanceof RegExp||value instanceof Blob||value instanceof String)){for(i=0;i<objects.length;i+=1)if(objects[i]===value)return{$ref:paths[i]};if(objects.push(value),paths.push(path),"[object Array]"===Object.prototype.toString.apply(value))for(nu=[],i=0;i<value.length;i+=1)nu[i]=derez(value[i],path+"["+i+"]");else{nu={};for(name in value)Object.prototype.hasOwnProperty.call(value,name)&&(nu[name]=derez(value[name],path+"["+JSON.stringify(name)+"]"))}return nu}return value instanceof Blob?(queuedObjects.push(path),readBlobAsDataURL(value,path)):value instanceof Boolean?value={$type:"bool",$enc:value.toString()}:value instanceof Date?value={$type:"date",$enc:value.getTime()}:value instanceof Number?value={$type:"num",$enc:value.toString()}:value instanceof RegExp&&(value={$type:"regex",$enc:value.toString()}),value}var objects=[],paths=[],queuedObjects=[],returnCallback=callback,derezObj=derez(object,"$");checkForCompletion()},retrocycle:function retrocycle($){function dataURLToBlob(dataURL){var BASE64_MARKER=";base64,",contentType,parts,raw;if(-1===dataURL.indexOf(BASE64_MARKER))return parts=dataURL.split(","),contentType=parts[0].split(":")[1],raw=parts[1],new Blob([raw],{type:contentType});parts=dataURL.split(BASE64_MARKER),contentType=parts[0].split(":")[1],raw=window.atob(parts[1]);for(var rawLength=raw.length,uInt8Array=new Uint8Array(rawLength),i=0;rawLength>i;++i)uInt8Array[i]=raw.charCodeAt(i);return new Blob([uInt8Array.buffer],{type:contentType})}function rez(value){var i,item,name,path;if(value&&"object"==typeof value)if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"==typeof item&&(path=item.$ref,value[i]="string"==typeof path&&px.test(path)?eval(path):rez(item));else if(void 0!==value.$type)switch(value.$type){case"blob":case"file":value=dataURLToBlob(value.$enc);break;case"bool":value=Boolean("true"===value.$enc);break;case"date":value=new Date(value.$enc);break;case"num":value=Number(value.$enc);break;case"regex":value=eval(value.$enc)}else for(name in value)"object"==typeof value[name]&&(item=value[name],item&&(path=item.$ref,value[name]="string"==typeof path&&px.test(path)?eval(path):rez(item)));return value}var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return rez($),$},encode:function(val,callback){function finishEncode(val){callback(JSON.stringify(val))}this.decycle(val,finishEncode)},decode:function(val){return this.retrocycle(JSON.parse(val))}}}();idbModules.Sca=Sca}(idbModules),function(idbModules){var collations=["","number","string","boolean","object","undefined"],getGenericEncoder=function(){return{encode:function(key){return collations.indexOf(typeof key)+"-"+JSON.stringify(key)},decode:function(key){return"undefined"==typeof key?void 0:JSON.parse(key.substring(2))}}},types={number:getGenericEncoder("number"),"boolean":getGenericEncoder(),object:getGenericEncoder(),string:{encode:function(key){return collations.indexOf("string")+"-"+key},decode:function(key){return""+key.substring(2)}},undefined:{encode:function(key){return collations.indexOf("undefined")+"-undefined"},decode:function(key){return void 0}}},Key=function(){return{encode:function(key){return types[typeof key].encode(key)},decode:function(key){return types[collations[key.substring(0,1)]].decode(key)}}}();idbModules.Key=Key}(idbModules),function(idbModules,undefined){var Event=function(type,debug){return{type:type,debug:debug,bubbles:!1,cancelable:!1,eventPhase:0,timeStamp:new Date}};idbModules.Event=Event}(idbModules),function(idbModules){var IDBRequest=function(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"},IDBOpenRequest=function(){this.onblocked=this.onupgradeneeded=null};IDBOpenRequest.prototype=IDBRequest,idbModules.IDBRequest=IDBRequest,idbModules.IDBOpenRequest=IDBOpenRequest}(idbModules),function(idbModules,undefined){var IDBKeyRange=function(lower,upper,lowerOpen,upperOpen){this.lower=lower,this.upper=upper,this.lowerOpen=lowerOpen,this.upperOpen=upperOpen};IDBKeyRange.only=function(value){return new IDBKeyRange(value,value,!1,!1)},IDBKeyRange.lowerBound=function(value,open){return new IDBKeyRange(value,undefined,open,undefined)},IDBKeyRange.upperBound=function(value){return new IDBKeyRange(undefined,value,undefined,open)},IDBKeyRange.bound=function(lower,upper,lowerOpen,upperOpen){return new IDBKeyRange(lower,upper,lowerOpen,upperOpen)},idbModules.IDBKeyRange=IDBKeyRange}(idbModules),function(idbModules,undefined){function IDBCursor(range,direction,idbObjectStore,cursorRequest,keyColumnName,valueColumnName){this.__range=range,this.source=this.__idbObjectStore=idbObjectStore,this.__req=cursorRequest,this.key=undefined,this.direction=direction,this.__keyColumnName=keyColumnName,this.__valueColumnName=valueColumnName,this.__valueDecoder="value"===valueColumnName?idbModules.Sca:idbModules.Key,this.source.transaction.__active||idbModules.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active."),this.__offset=-1,this.__lastKeyContinued=undefined,this["continue"]()}IDBCursor.prototype.__find=function(key,tx,success,error,recordsToLoad){recordsToLoad=recordsToLoad||1;var me=this,sql=["SELECT * FROM ",idbModules.util.quote(me.__idbObjectStore.name)],sqlValues=[];sql.push("WHERE ",me.__keyColumnName," NOT NULL"),!me.__range||me.__range.lower===undefined&&me.__range.upper===undefined||(sql.push("AND"),me.__range.lower!==undefined&&(sql.push(me.__keyColumnName+(me.__range.lowerOpen?" >":" >= ")+" ?"),sqlValues.push(idbModules.Key.encode(me.__range.lower))),me.__range.lower!==undefined&&me.__range.upper!==undefined&&sql.push("AND"),me.__range.upper!==undefined&&(sql.push(me.__keyColumnName+(me.__range.upperOpen?" < ":" <= ")+" ?"),sqlValues.push(idbModules.Key.encode(me.__range.upper)))),"undefined"!=typeof key&&(me.__lastKeyContinued=key,me.__offset=0),me.__lastKeyContinued!==undefined&&(sql.push("AND "+me.__keyColumnName+" >= ?"),sqlValues.push(idbModules.Key.encode(me.__lastKeyContinued)));var direction="prev"===me.direction||"prevunique"===me.direction?"DESC":"ASC";sql.push("ORDER BY ",me.__keyColumnName," "+direction),sql.push("LIMIT "+recordsToLoad+" OFFSET "+me.__offset),me.__prefetchedData=null,tx.executeSql(sql.join(" "),sqlValues,function(tx,data){data.rows.length>1?(me.__prefetchedData=data.rows,me.__prefetchedIndex=0,me.__decode(data.rows.item(0),success)):1===data.rows.length?me.__decode(data.rows.item(0),success):success(undefined,undefined)},function(tx,data){error(data)})},IDBCursor.prototype.__decode=function(rowItem,callback){var key=idbModules.Key.decode(rowItem[this.__keyColumnName]),val=this.__valueDecoder.decode(rowItem[this.__valueColumnName]),primaryKey=idbModules.Key.decode(rowItem.key);callback(key,val,primaryKey)},IDBCursor.prototype["continue"]=function(key){var recordsToPreloadOnContinue=idbModules.cursorPreloadPackSize||1e3,me=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__offset++;var successCallback=function(key,val,primaryKey){me.key=key,me.value=val,me.primaryKey=primaryKey,success("undefined"!=typeof me.key?me:undefined,me.__req)};return me.__prefetchedData&&(me.__prefetchedIndex++,me.__prefetchedIndex<me.__prefetchedData.length)?void me.__decode(me.__prefetchedData.item(me.__prefetchedIndex),successCallback):void me.__find(key,tx,successCallback,error,recordsToPreloadOnContinue)})},IDBCursor.prototype.advance=function(count){0>=count&&idbModules.util.throwDOMException("Type Error - Count is invalid - 0 or negative",count);var me=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__offset+=count,me.__find(undefined,tx,function(key,value){me.key=key,me.value=value,success("undefined"!=typeof me.key?me:undefined,me.__req)},error)})},IDBCursor.prototype.update=function(valueToUpdate){var me=this,request=this.__idbObjectStore.transaction.__createRequest(function(){});return idbModules.Sca.encode(valueToUpdate,function(encoded){me.__idbObjectStore.transaction.__pushToQueue(request,function(tx,args,success,error){me.__find(undefined,tx,function(key,value,primaryKey){var store=me.__idbObjectStore,storeProperties=me.__idbObjectStore.transaction.db.__storeProperties,params=[encoded],sql="UPDATE "+idbModules.util.quote(store.name)+" SET value = ?",indexList=storeProperties[store.name]&&storeProperties[store.name].indexList;if(indexList)for(var index in indexList){var indexProps=indexList[index];sql+=", "+index+" = ?",params.push(idbModules.Key.encode(valueToUpdate[indexProps.keyPath]))}sql+=" WHERE key = ?",params.push(idbModules.Key.encode(primaryKey)),tx.executeSql(sql,params,function(tx,data){me.__prefetchedData=null,1===data.rowsAffected?success(key):error("No rows with key found"+key)},function(tx,data){error(data)})},error)})}),request},IDBCursor.prototype["delete"]=function(){var me=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__find(undefined,tx,function(key,value,primaryKey){var sql="DELETE FROM  "+idbModules.util.quote(me.__idbObjectStore.name)+" WHERE key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){me.__prefetchedData=null,1===data.rowsAffected?(me.__offset--,success(undefined)):error("No rows with key found"+key)},function(tx,data){error(data)})},error)})},idbModules.IDBCursor=IDBCursor}(idbModules),function(idbModules,undefined){function IDBIndex(indexName,idbObjectStore){this.indexName=this.name=indexName,this.__idbObjectStore=this.objectStore=this.source=idbObjectStore;var storeProps=idbObjectStore.transaction.db.__storeProperties[idbObjectStore.name],indexList=storeProps&&storeProps.indexList;this.keyPath=indexList&&indexList[indexName]&&indexList[indexName].keyPath||indexName,["multiEntry","unique"].forEach(function(prop){this[prop]=!!(indexList&&indexList[indexName]&&indexList[indexName].optionalParams&&indexList[indexName].optionalParams[prop])},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this,transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(){idbModules.util.throwDOMException(0,"Could not create new index",arguments)}2!==transaction.mode&&idbModules.util.throwDOMException(0,"Invalid State error, not a version transaction",me.transaction);var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);"undefined"!=typeof idxList[indexName]&&idbModules.util.throwDOMException(0,"Index already exists on store",idxList);var columnName=indexName;idxList[indexName]={columnName:columnName,keyPath:keyPath,optionalParams:optionalParameters},me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",columnName,"BLOB"].join(" ");tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){!function initIndexForRow(i){if(i<data.rows.length)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+columnName+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(tx,data){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",!0),success(me)},error)}(0)},error)},error)},"createObjectStore")})},IDBIndex.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this.source,cursorRequest,this.indexName,"value");return cursorRequest},IDBIndex.prototype.openKeyCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this.source,cursorRequest,this.indexName,"key");return cursorRequest},IDBIndex.prototype.__fetchIndexData=function(key,opType){var me=this;return me.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){var sql=["SELECT * FROM ",idbModules.util.quote(me.__idbObjectStore.name)," WHERE",me.indexName,"NOT NULL"],sqlValues=[];"undefined"!=typeof key&&(sql.push("AND",me.indexName," = ?"),sqlValues.push(idbModules.Key.encode(key))),tx.executeSql(sql.join(" "),sqlValues,function(tx,data){var d;d="count"===opType?data.rows.length:0===data.rows.length?undefined:"key"===opType?idbModules.Key.decode(data.rows.item(0).key):idbModules.Sca.decode(data.rows.item(0).value),success(d)},error)})},IDBIndex.prototype.get=function(key){return this.__fetchIndexData(key,"value")},IDBIndex.prototype.getKey=function(key){return this.__fetchIndexData(key,"key")},IDBIndex.prototype.count=function(key){return this.__fetchIndexData(key,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){var IDBObjectStore=function(name,idbTransaction,ready){this.name=name,this.transaction=idbTransaction,this.__ready={},this.__setReadyState("createObjectStore","undefined"==typeof ready?!0:ready),this.indexNames=new idbModules.util.StringList;var dbProps=idbTransaction.db.__storeProperties;if(dbProps[name]&&dbProps[name].indexList){var indexes=dbProps[name].indexList;for(var indexName in indexes)indexes.hasOwnProperty(indexName)&&this.indexNames.push(indexName)}};IDBObjectStore.prototype.__setReadyState=function(key,val){this.__ready[key]=val},IDBObjectStore.prototype.__waitForReady=function(callback,key){var ready=!0;if("undefined"!=typeof key)ready="undefined"==typeof this.__ready[key]?!0:this.__ready[key];else for(var x in this.__ready)this.__ready[x]||(ready=!1);if(ready)callback();else{var me=this;window.setTimeout(function(){me.__waitForReady(callback,key)},100)}},IDBObjectStore.prototype.__getStoreProps=function(tx,callback,waitOnProperty){var me=this;this.__waitForReady(function(){me.__storeProps?callback(me.__storeProps):tx.executeSql("SELECT * FROM __sys__ where name = ?",[me.name],function(tx,data){1!==data.rows.length?callback():(me.__storeProps={name:data.rows.item(0).name,indexList:data.rows.item(0).indexList,autoInc:data.rows.item(0).autoInc,keyPath:data.rows.item(0).keyPath},callback(me.__storeProps))},function(){callback()})},waitOnProperty)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(tx,data){callback(1!==data.rows.length?0:data.rows.item(0).seq)},function(tx,error){idbModules.util.throwDOMException(0,"Data Error - Could not get the auto increment value for key",error)})}var me=this;me.__getStoreProps(tx,function(props){if(props||idbModules.util.throwDOMException(0,"Data Error - Could not locate defination for this table",props),props.keyPath)if("undefined"!=typeof key&&idbModules.util.throwDOMException(0,"Data Error - The object store uses in-line keys and the key parameter was provided",props),value)try{var primaryKey=eval("value['"+props.keyPath+"']");void 0===primaryKey?"true"===props.autoInc?getNextAutoIncKey():idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath"):callback(primaryKey)}catch(e){idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath",e)}else idbModules.util.throwDOMException(0,"Data Error - KeyPath was specified, but value was not");else"undefined"!=typeof key?callback(key):"false"===props.autoInc?idbModules.util.throwDOMException(0,"Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props):getNextAutoIncKey()})},IDBObjectStore.prototype.__insertData=function(tx,encoded,value,primaryKey,success,error){var paramMap={};"undefined"!=typeof primaryKey&&(paramMap.key=idbModules.Key.encode(primaryKey));var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes)try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(key in paramMap)sqlStart.push(key+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(encoded);var sql=sqlStart.join(" ")+sqlEnd.join(" ");tx.executeSql(sql,sqlValues,function(tx,data){success(primaryKey)},function(tx,err){error(err)})},IDBObjectStore.prototype.add=function(value,key){var me=this,request=me.transaction.__createRequest(function(){});return idbModules.Sca.encode(value,function(encoded){me.transaction.__pushToQueue(request,function(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){me.__insertData(tx,encoded,value,primaryKey,success,error)})})}),request},IDBObjectStore.prototype.put=function(value,key){var me=this,request=me.transaction.__createRequest(function(){});return idbModules.Sca.encode(value,function(encoded){me.transaction.__pushToQueue(request,function(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){var sql="DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){me.__insertData(tx,encoded,value,primaryKey,success,error)},function(tx,err){error(err)})})})}),request},IDBObjectStore.prototype.get=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var primaryKey=idbModules.Key.encode(key);tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){try{if(0===data.rows.length)return success();success(idbModules.Sca.decode(data.rows.item(0).value))}catch(e){success(void 0)}},function(tx,err){error(err)})})})},IDBObjectStore.prototype["delete"]=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var primaryKey=idbModules.Key.encode(key);tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){success()},function(tx,err){error(err)})})})},IDBObjectStore.prototype.clear=function(){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name),[],function(tx,data){success()},function(tx,err){error(err)})})})},IDBObjectStore.prototype.count=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var sql="SELECT * FROM "+idbModules.util.quote(me.name)+("undefined"!=typeof key?" WHERE key = ?":""),sqlValues=[];"undefined"!=typeof key&&sqlValues.push(idbModules.Key.encode(key)),tx.executeSql(sql,sqlValues,function(tx,data){success(data.rows.length)},function(tx,err){error(err)})})})},IDBObjectStore.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this,cursorRequest,"key","value");return cursorRequest},IDBObjectStore.prototype.index=function(indexName){var index=new idbModules.IDBIndex(indexName,this);return index},IDBObjectStore.prototype.createIndex=function(indexName,keyPath,optionalParameters){var me=this;optionalParameters=optionalParameters||{},me.__setReadyState("createIndex",!1);var result=new idbModules.IDBIndex(indexName,me);me.__waitForReady(function(){result.__createIndex(indexName,keyPath,optionalParameters)},"createObjectStore"),me.indexNames.push(indexName);var storeProps=me.transaction.db.__storeProperties[me.name];return storeProps.indexList[indexName]={keyPath:keyPath,optionalParams:optionalParameters},result},IDBObjectStore.prototype.deleteIndex=function(indexName){var result=new idbModules.IDBIndex(indexName,this,!1);return result.__deleteIndex(indexName),result},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(idbModules){var READ=0,READ_WRITE=1,VERSION_TRANSACTION=2,IDBTransaction=function(storeNames,mode,db){if("number"==typeof mode)this.mode=mode;else if("string"==typeof mode)switch(mode){case"readwrite":this.mode=READ_WRITE;break;case"readonly":this.mode=READ;break;default:this.mode=READ}this.storeNames="string"==typeof storeNames?[storeNames]:storeNames;for(var i=0;i<this.storeNames.length;i++)db.objectStoreNames.contains(this.storeNames[i])||idbModules.util.throwDOMException(0,"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",this.storeNames[i]);this.__active=!0,this.__running=!1,this.__requests=[],this.__aborted=!1,this.db=db,this.error=null,this.onabort=this.onerror=this.oncomplete=null;var me=this};IDBTransaction.prototype.__executeRequests=function(){if(!this.__running||this.mode===VERSION_TRANSACTION){this.__running=!0;var me=this;window.setTimeout(function(){2===me.mode||me.__active||idbModules.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",me.__active),me.db.__db.transaction(function(tx){function success(result,req){req&&(q.req=req),q.req.readyState="done",q.req.result=result,delete q.req.error;var e=idbModules.Event("success");idbModules.util.callback("onsuccess",q.req,e),i++,executeRequest()}function error(errorVal){q.req.readyState="done",q.req.error="DOMError";var e=idbModules.Event("error",arguments);idbModules.util.callback("onerror",q.req,e),i++,executeRequest()}function executeRequest(){return i>=me.__requests.length?(me.__active=!1,void(me.__requests=[])):(q=me.__requests[i],void q.op(tx,q.args,success,error))}me.__tx=tx;var q=null,i=0;try{executeRequest()}catch(e){"function"==typeof me.onerror&&me.onerror()}},function(){"function"==typeof me.onerror&&me.onerror()},function(){"function"==typeof me.oncomplete&&me.oncomplete()})},1)}},IDBTransaction.prototype.__addToTransactionQueue=function(callback,args){this.__active||this.mode===VERSION_TRANSACTION||idbModules.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished.",this.__mode);var request=this.__createRequest();return this.__pushToQueue(request,callback,args),request},IDBTransaction.prototype.__createRequest=function(){var request=new idbModules.IDBRequest;return request.source=this.db,request.transaction=this,request},IDBTransaction.prototype.__pushToQueue=function(request,callback,args){this.__requests.push({op:callback,args:args,req:request}),this.__executeRequests()},IDBTransaction.prototype.objectStore=function(objectStoreName){return new idbModules.IDBObjectStore(objectStoreName,this)},IDBTransaction.prototype.abort=function(){!this.__active&&idbModules.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",this.__active)},IDBTransaction.prototype.READ_ONLY=0,IDBTransaction.prototype.READ_WRITE=1,IDBTransaction.prototype.VERSION_CHANGE=2,idbModules.IDBTransaction=IDBTransaction}(idbModules),function(idbModules){var IDBDatabase=function(db,name,version,storeProperties){this.__db=db,this.version=version,this.objectStoreNames=new idbModules.util.StringList;for(var i=0;i<storeProperties.rows.length;i++)this.objectStoreNames.push(storeProperties.rows.item(i).name);for(this.__storeProperties={},i=0;i<storeProperties.rows.length;i++){var row=storeProperties.rows.item(i),objectStoreProps=this.__storeProperties[row.name]={};objectStoreProps.keyPath=row.keypath,objectStoreProps.autoInc="true"===row.autoInc,objectStoreProps.indexList=JSON.parse(row.indexList)}this.name=name,this.onabort=this.onerror=this.onversionchange=null};IDBDatabase.prototype.createObjectStore=function(storeName,createOptions){var me=this;createOptions=createOptions||{},createOptions.keyPath=createOptions.keyPath||null;var result=new idbModules.IDBObjectStore(storeName,me.__versionTransaction,!1),transaction=me.__versionTransaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){function error(){idbModules.util.throwDOMException(0,"Could not create new object store",arguments)}me.__versionTransaction||idbModules.util.throwDOMException(0,"Invalid State error",me.transaction);var sql=["CREATE TABLE",idbModules.util.quote(storeName),"(key BLOB",createOptions.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");tx.executeSql(sql,[],function(tx,data){tx.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[storeName,createOptions.keyPath,createOptions.autoIncrement?!0:!1,"{}"],function(){result.__setReadyState("createObjectStore",!0),success(result)},error)},error)}),me.objectStoreNames.push(storeName);var storeProps=me.__storeProperties[storeName]={};return storeProps.keyPath=createOptions.keyPath,storeProps.autoInc=!!createOptions.autoIncrement,storeProps.indexList={},result},IDBDatabase.prototype.deleteObjectStore=function(storeName){var error=function(){idbModules.util.throwDOMException(0,"Could not delete ObjectStore",arguments)},me=this;!me.objectStoreNames.contains(storeName)&&error("Object Store does not exist"),me.objectStoreNames.splice(me.objectStoreNames.indexOf(storeName),1);var transaction=me.__versionTransaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__versionTransaction||idbModules.util.throwDOMException(0,"Invalid State error",me.transaction),me.__db.transaction(function(tx){tx.executeSql("SELECT * FROM __sys__ where name = ?",[storeName],function(tx,data){data.rows.length>0&&tx.executeSql("DROP TABLE "+idbModules.util.quote(storeName),[],function(){tx.executeSql("DELETE FROM __sys__ WHERE name = ?",[storeName],function(){},error)},error)})})})},IDBDatabase.prototype.close=function(){},IDBDatabase.prototype.transaction=function(storeNames,mode){var transaction=new idbModules.IDBTransaction(storeNames,mode||1,this);return transaction},idbModules.IDBDatabase=IDBDatabase}(idbModules),function(idbModules){var DEFAULT_DB_SIZE=2097152,isShimReady=!1,isReadyCallbacks,sysdb,shimInitSuccess=!1,shimIndexedDB={loadShim:function(){window.openDatabase&&(sysdb=window.openDatabase("__sysdb__",1,"System Database",DEFAULT_DB_SIZE),sysdb.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){shimIndexedDB.notifyIsReady(!0)},function(){shimIndexedDB.notifyIsReady(!1)})},function(){}))},notifyIsReady:function(success){if(isShimReady=!0,shimInitSuccess=success,isReadyCallbacks){for(var i=0;i<isReadyCallbacks.length;++i)isReadyCallbacks[i](shimInitSuccess);isReadyCallbacks=void 0}},onIsReady:function(cb){isShimReady?setTimeout(function(){cb(shimInitSuccess)},0):isReadyCallbacks?isReadyCallbacks.push(cb):isReadyCallbacks=[cb]},open:function(name,version){function dbCreateError(){if(!calledDbCreateError){var e=idbModules.Event("error",arguments);req.readyState="done",req.error="DOMError",idbModules.util.callback("onerror",req,e),calledDbCreateError=!0}}function openDB(oldVersion){var db=window.openDatabase(name,1,name,DEFAULT_DB_SIZE);req.readyState="done","undefined"==typeof version&&(version=oldVersion||1),(0>=version||oldVersion>version)&&idbModules.util.throwDOMException(0,"An attempt was made to open a database using a lower version than the existing version.",version),db.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){tx.executeSql("SELECT * FROM __sys__",[],function(tx,data){var e=idbModules.Event("success");
req.source=req.result=new idbModules.IDBDatabase(db,name,version,data),version>oldVersion?sysdb.transaction(function(systx){systx.executeSql("UPDATE dbVersions set version = ? where name = ?",[version,name],function(){var e=idbModules.Event("upgradeneeded");e.oldVersion=oldVersion,e.newVersion=version,req.transaction=req.result.__versionTransaction=new idbModules.IDBTransaction([],2,req.source),idbModules.util.callback("onupgradeneeded",req,e,function(){var e=idbModules.Event("success");idbModules.util.callback("onsuccess",req,e)})},dbCreateError)},dbCreateError):idbModules.util.callback("onsuccess",req,e)},dbCreateError)},dbCreateError)},dbCreateError)}var req=new idbModules.IDBOpenRequest,calledDbCreateError=!1;return sysdb.transaction(function(tx){tx.executeSql("SELECT * FROM dbVersions where name = ?",[name],function(tx,data){0===data.rows.length?tx.executeSql("INSERT INTO dbVersions VALUES (?,?)",[name,version||1],function(){openDB(0)},dbCreateError):openDB(data.rows.item(0).version)},dbCreateError)},dbCreateError),req},deleteDatabase:function(name){function dbError(msg){if(!calledDBError){req.readyState="done",req.error="DOMError";var e=idbModules.Event("error");e.message=msg,e.debug=arguments,idbModules.util.callback("onerror",req,e),calledDBError=!0}}function deleteFromDbVersions(){sysdb.transaction(function(systx){systx.executeSql("DELETE FROM dbVersions where name = ? ",[name],function(){req.result=void 0;var e=idbModules.Event("success");e.newVersion=null,e.oldVersion=version,idbModules.util.callback("onsuccess",req,e)},dbError)},dbError)}var req=new idbModules.IDBOpenRequest,calledDBError=!1,version=null;return sysdb.transaction(function(systx){systx.executeSql("SELECT * FROM dbVersions where name = ?",[name],function(tx,data){if(0===data.rows.length){req.result=void 0;var e=idbModules.Event("success");return e.newVersion=null,e.oldVersion=version,void idbModules.util.callback("onsuccess",req,e)}version=data.rows.item(0).version;var db=window.openDatabase(name,1,name,DEFAULT_DB_SIZE);db.transaction(function(tx){tx.executeSql("SELECT * FROM __sys__",[],function(tx,data){var tables=data.rows;!function deleteTables(i){i>=tables.length?tx.executeSql("DROP TABLE __sys__",[],function(){deleteFromDbVersions()},dbError):tx.executeSql("DROP TABLE "+idbModules.util.quote(tables.item(i).name),[],function(){deleteTables(i+1)},function(){deleteTables(i+1)})}(0)},function(e){deleteFromDbVersions()})},dbError)})},dbError),req},cmp:function(key1,key2){return idbModules.Key.encode(key1)>idbModules.Key.encode(key2)?1:key1===key2?0:-1}};idbModules.shimIndexedDB=shimIndexedDB}(idbModules),function(window,idbModules){"undefined"!=typeof window.openDatabase&&(window.shimIndexedDB=idbModules.shimIndexedDB,window.shimIndexedDB&&(window.shimIndexedDB.__useShim=function(){try{console.log("---- Using SQL Shim ----"),idbModules.shimIndexedDB.loadShim(),window.dbProvider=idbModules.shimIndexedDB,window.IDBDatabase=idbModules.IDBDatabase,window.IDBTransaction=idbModules.IDBTransaction,window.IDBCursor=idbModules.IDBCursor,window.IDBKeyRange=idbModules.IDBKeyRange,window.dbProvider!==idbModules.shimIndexedDB&&Object.defineProperty&&Object.defineProperty(window,"dbProvider",{value:idbModules.shimIndexedDB})}catch(err){console.log("Error loading SQL shim")}},window.shimIndexedDB.__debug=function(val){})),window.dbProvider=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB;var poorIndexedDbSupport=!1;(navigator.userAgent.match(/Android 2/)||navigator.userAgent.match(/Android 3/)||navigator.userAgent.match(/Android 4\.[0-3]/))&&(navigator.userAgent.match(/Chrome/)||(poorIndexedDbSupport=!0));var forceSQL=window.location.hash.indexOf("forcesql=true")>=0;if(forceSQL||("undefined"==typeof window.indexedDB||null===window.indexedDB||poorIndexedDbSupport)&&"undefined"!=typeof window.openDatabase)window.shimIndexedDB.__useShim();else{window.IDBDatabase=window.IDBDatabase||window.webkitIDBDatabase,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBCursor=window.IDBCursor||window.webkitIDBCursor,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,window.IDBTransaction||(window.IDBTransaction={});try{window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite"}catch(e){}}}(window,idbModules),define("IndexedDBShim",function(){}),define("database",["IndexedDBShim"],function(idbpoly){var dbProvider=window.dbProvider,IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,transactionModes={readonly:"readonly",readwrite:"readwrite"},hasOwn=Object.prototype.hasOwnProperty;if(!dbProvider)return void console.log("IndexedDB is not available");var defaultMapper=function(value){return value},CallbackList=function(){var state,list=[],exec=function(context,args){if(list){args=args||[],state=state||[context,args];for(var i=0,il=list.length;il>i;i++)list[i].apply(state[0],state[1]);list=[]}};this.add=function(){for(var i=0,il=arguments.length;il>i;i++)list.push(arguments[i]);return state&&exec(),this},this.execute=function(){return exec(this,arguments),this}},Deferred=function(func){var state="progress",actions=[["resolve","done",new CallbackList,"resolved"],["reject","fail",new CallbackList,"rejected"],["notify","progress",new CallbackList]],deferred={},promise={state:function(){return state},then:function(){var handlers=arguments;return Deferred(function(newDefer){actions.forEach(function(action,i){var handler=handlers[i];deferred[action[1]]("function"==typeof handler?function(){var returned=handler.apply(this,arguments);returned&&"function"==typeof returned.promise&&returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify)}:newDefer[action[0]])})}).promise()},promise:function(obj){return obj?(Object.keys(promise).forEach(function(key){obj[key]=promise[key]}),obj):promise}};return actions.forEach(function(action,i){var list=action[2],actionState=action[3];promise[action[1]]=list.add,actionState&&list.add(function(){state=actionState}),deferred[action[0]]=list.execute}),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},Server=function(db,name){var that=this,closed=!1;this.add=function(table){if(closed)throw"Database has been closed";for(var records=[],counter=0,i=0;i<arguments.length-1;i++)if(Array.isArray(arguments[i+1]))for(var j=0;j<arguments[i+1].length;j++)records[counter]=arguments[i+1][j],counter++;else records[counter]=arguments[i+1],counter++;var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred();return records.forEach(function(record){var req;if(record.item&&record.key){var key=record.key;record=record.item,req=store.add(record,key)}else req=store.add(record);req.onsuccess=function(e){var target=e.target,keyPath=target.source.keyPath;null===keyPath&&(keyPath="__id__"),Object.defineProperty(record,keyPath,{value:target.result,enumerable:!0}),deferred.notify()}}),transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.update=function(table){if(closed)throw"Database has been closed";for(var records=[],i=0;i<arguments.length-1;i++)records[i]=arguments[i+1];var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred();return records.forEach(function(record){var req;if(record.item&&record.key){var key=record.key;record=record.item,req=store.put(record,key)}else req=store.put(record);req.onsuccess=function(e){deferred.notify()}}),transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.updateObject=function(table){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),records=arguments[1];for(var id in records)store.put(records[id]);return transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.remove=function(table,key){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),req=store.delete(key);return transaction.oncomplete=function(){deferred.resolve(key)},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.clear=function(table){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),req=store.clear();return transaction.oncomplete=function(){deferred.resolve()},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.close=function(){if(closed)throw"Database has been closed";db.close(),closed=!0,delete dbCache[name]},this.get=function(table,id){if(closed)throw"Database has been closed";var transaction=db.transaction(table),store=transaction.objectStore(table),deferred=Deferred(),req=store.get(id);return req.onsuccess=function(e){deferred.resolve(e.target.result)},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.query=function(table,index){if(closed)throw"Database has been closed";return new IndexQuery(table,db,index)};for(var i=0,il=db.objectStoreNames.length;il>i;i++)!function(storeName){that[storeName]={};for(var i in that)hasOwn.call(that,i)&&"close"!==i&&(that[storeName][i]=function(i){return function(){var args=[storeName].concat([].slice.call(arguments,0));return that[i].apply(that,args)}}(i))}(db.objectStoreNames[i])},IndexQuery=function(table,db,indexName){var that=this,modifyObj=!1,runQuery=function(type,args,cursorType,direction,limitRange,filters,mapper){var transaction=db.transaction(table,modifyObj?transactionModes.readwrite:transactionModes.readonly),store=transaction.objectStore(table),index=indexName?store.index(indexName):store,keyRange=type?IDBKeyRange[type].apply(null,args):null,results=[],deferred=Deferred(),indexArgs=[keyRange],limitRange=limitRange?limitRange:null,filters=filters?filters:void 0,counter=0;"count"!==cursorType&&indexArgs.push(direction||"next");var modifyKeys=modifyObj?Object.keys(modifyObj):!1,modifyRecord=function(record){for(var i=0;i<modifyKeys.length;i++){var key=modifyKeys[i],val=modifyObj[key];val instanceof Function&&(val=val(record)),record[key]=val}return record};return index[cursorType].apply(index,indexArgs).onsuccess=function(e){var cursor=e.target.result;if("number"==typeof cursor)results=cursor;else if(cursor)if(null!==limitRange&&limitRange[0]>counter)counter=limitRange[0],cursor.advance(limitRange[0]);else if(null!==limitRange&&counter>=limitRange[0]+limitRange[1]);else{var matchFilter=!0,result="value"in cursor?cursor.value:cursor.key;filters&&filters.forEach(function(filter){filter&&filter.length&&(matchFilter=2===filter.length?result[filter[0]]===filter[1]:filter[0].apply(void 0,[result]))}),matchFilter&&(counter++,results.push(mapper(result)),modifyObj&&(result=modifyRecord(result),cursor.update(result))),cursor.continue()}},transaction.oncomplete=function(){deferred.resolve(results)},transaction.onerror=function(e){deferred.reject(e)},transaction.onabort=function(e){deferred.reject(e)},deferred.promise()},Query=function(type,args){var direction="next",cursorType="openCursor",filters=[],limitRange=null,mapper=defaultMapper,unique=!1,execute=function(){return runQuery(type,args,cursorType,unique?direction+"unique":direction,limitRange,filters,mapper)},limit=function(){return limitRange=Array.prototype.slice.call(arguments,0,2),1==limitRange.length&&limitRange.unshift(0),{execute:execute}},count=function(){return direction=null,cursorType="count",{execute:execute}},keys=function(){return cursorType="openKeyCursor",{desc:desc,execute:execute,filter:filter,distinct:distinct,map:map}},filter=function(){return filters.push(Array.prototype.slice.call(arguments,0,2)),{keys:keys,execute:execute,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}},desc=function(){return direction="prev",{keys:keys,execute:execute,filter:filter,distinct:distinct,modify:modify,map:map}},distinct=function(){return unique=!0,{keys:keys,count:count,execute:execute,filter:filter,desc:desc,modify:modify,map:map}},modify=function(update){return modifyObj=update,{execute:execute}},map=function(fn){return mapper=fn,{execute:execute,count:count,keys:keys,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}};return{execute:execute,count:count,keys:keys,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}};"only bound upperBound lowerBound".split(" ").forEach(function(name){that[name]=function(){return new Query(name,arguments)}}),this.filter=function(){var query=new Query(null,null);return query.filter.apply(query,arguments)},this.all=function(){return this.filter()}},createSchema=function(e,schema,db){"function"==typeof schema&&(schema=schema());for(var tableName in schema){var table=schema[tableName],store;store=!hasOwn.call(schema,tableName)||db.objectStoreNames.contains(tableName)?e.currentTarget.transaction.objectStore(tableName):db.createObjectStore(tableName,table.key);for(var indexKey in table.indexes)if(!store.indexNames.contains(indexKey)){var index=table.indexes[indexKey];store.createIndex(indexKey,index.key||indexKey,Object.keys(index).length?index:{unique:!1})}}},open=function(e,server,version,schema){var db=e.target.result,s=new Server(db,server),upgrade,deferred=Deferred();return deferred.resolve(s),dbCache[server]=db,deferred.promise()},dbCache={},db={version:"0.9.0",open:function(options){var request,deferred=Deferred();return dbCache[options.server]?open({target:{result:dbCache[options.server]}},options.server,options.version,options.schema).done(deferred.resolve).fail(deferred.reject).progress(deferred.notify):(request=dbProvider.open(options.server,options.version),request.onsuccess=function(e){open(e,options.server,options.version,options.schema).done(deferred.resolve).fail(deferred.reject).progress(deferred.notify)},request.onupgradeneeded=function(e){createSchema(e,options.schema,e.target.result)},request.onerror=function(e){deferred.reject(e)}),deferred.promise()}};return db}),define("demo",["globals"],function(g){var self={cache:{},loadedGapiData:{},_isRemoteHooked:!1};return self.setGapiData=function setGapiDataFn(id,data){try{g.PAssert(1923,g.isObject(data)&&!g.isArray(data),"Setting malformed data",id)}catch(PERR){g.reportError(PERR)}self.loadedGapiData[id]=[];for(var entryID in data)data[entryID].id=entryID,self.loadedGapiData[id].push(data[entryID])},self.setGapiDataDirect=function setGapiDataDirectFn(id,dataArr){try{g.PAssert(1924,g.isArray(dataArr),"Setting malformed data",id)}catch(PERR){g.reportError(PERR)}self.loadedGapiData[id]=dataArr},self.clearGapiData=function clearGapiDataFn(){self.loadedGapiData={}},self.loadRemoteData=function loadRemoteDataFn(info,cb){try{g.PAssert(1925,info&&cb,"Must supply valid remote load info as well as a cb when data is loaded")}catch(PERR){g.reportError(PERR)}var rInfo=info.split(".");self.cache[rInfo[0]]?cb(JSON.parse(JSON.stringify(self.cache[rInfo[0]][rInfo[1]]))):g.XHR({type:"GET",url:window.location.protocol+"//"+window.location.host+"/data/"+rInfo[0]+".json",cb:function cbFn(xhr){if(200===xhr.status)try{var demoData=JSON.parse(xhr.responseText);self.cache[rInfo[0]]=demoData;var demoEntry=demoData[rInfo[1]];if(demoEntry){var dataCopy=JSON.parse(JSON.stringify(demoEntry));cb(dataCopy)}else log("Invalid data slot")}catch(err){log("Error parsing demo data: "+err.message)}else log("Error getting demo data",xhr.status,xhr.responseText)}})},self.stubGapi=function stubGapiFn(){try{g.PAssert(1926,!window.gapi,"Should not have loaded gapi when stubbing")}catch(PERR){g.reportError(PERR)}var emptyFn=function(){},emptyImpl=function(){return{}},emptyPromise=function(){return{then:emptyFn,execute:emptyFn}};window.gapi={client:{load:emptyFn,setApiKey:emptyFn,newBatch:function newBatchFn(){return{add:emptyFn,then:emptyFn}},drive:{files:{get:emptyPromise,list:emptyPromise,trash:emptyPromise,insert:emptyPromise,patch:emptyPromise},permissions:{list:emptyPromise,insert:emptyPromise,"delete":emptyPromise},properties:{insert:emptyPromise},parents:{insert:emptyPromise}},gmail:{users:{threads:{list:emptyPromise}}}}}},self.areRemoteFunctionsHooked=function areRemoteFunctionsHookedFn(){return self._isRemoteHooked},self.hookRemoteFunctions=function hookRemoteFunctionsFn(){function findById(arr,id){try{g.PAssert(1928,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var i=0;i<arr.length;++i)if(arr[i].id===id)return arr[i];return void 0}function findByParentId(arr,id){try{g.PAssert(1929,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var matches=[],i=0;i<arr.length;++i)(arr[i].parents[0].id===id||"root"===id&&arr[i].parents[0].isRoot)&&matches.push(arr[i]);return matches}function findByField(arr,field,value){try{g.PAssert(1930,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var matches=[],i=0;i<arr.length;++i)arr[i][field]===value&&matches.push(arr[i]);return matches}function replyThen(impl){return function(success,failure,context){var data=impl(context);setTimeout(function(){data?success({result:data}):failure({error:!0})},API_TIMEOUT)}}function replyExecute(impl){return function(success,failure,context){var data=impl(context);setTimeout(function(){data?success(data):failure({error:!0})},API_TIMEOUT)}}function genPromise(impl){return{then:replyThen(impl),execute:replyExecute(impl)}}function loadAPI_Drive(){gapi.client.drive.files.get=function(params){function impl(context){var file=findById(self.loadedGapiData.Drive,params.fileId);return file}return genPromise(impl)},gapi.client.drive.files.list=function(params){function impl(context){if("trashed=false and mimeType contains 'application/vnd.google-apps.drive-sdk.597847337936'"===params.q)return{items:self.loadedGapiData.documents};var parentsCheck=/\'(.*)\' in parents/g,match=parentsCheck.exec(params.q);if(match){var parentID=match[1];return{items:findByParentId(self.loadedGapiData.Drive,parentID)}}return{items:self.loadedGapiData.Drive}}return genPromise(impl)},gapi.client.drive.files.trash=function(params){return genPromise(emptyImpl)},gapi.client.drive.files.insert=function(params){return genPromise(emptyImpl)},gapi.client.drive.files.patch=function(params){return genPromise(emptyImpl)},gapi.client.drive.permissions.list=function(params){function impl(context){return{items:self.loadedGapiData.permissions}}return genPromise(impl)},gapi.client.drive.permissions.insert=function(params){return genPromise(emptyImpl)},gapi.client.drive.permissions.delete=function(params){return genPromise(emptyImpl)},gapi.client.drive.properties.insert=function(params){return genPromise(emptyImpl)}}function loadAPI_Gmail(){gapi.client.gmail.users.threads.list=function(params){function impl(context){return void 0===params.q?{threads:findByField(self.loadedGapiData.Gmail,"hideInPane",void 0)}:{threads:self.loadedGapiData.Gmail}}return genPromise(impl)},gapi.client.gmail.users.threads.get=function(params){function impl(context){return findById(self.loadedGapiData.Gmail,params.id)}return genPromise(impl)}}try{g.PAssert(1927,!self._isRemoteHooked,"Should not hook remote functions more than once")}catch(PERR){g.reportError(PERR)}self.stubGapi(),self._isRemoteHooked=!0;var API_TIMEOUT=0;loadAPI_Drive(),loadAPI_Gmail()},self}),define("VMContact",["ko","globals"],function(ko,g){function VMContact(p){try{g.PAssert(1931,g.isObject(p),"Should always supply a valid object to init a contact")}catch(PERR){g.reportError(PERR)}this.id=p.id,this.text=p.text||"",this.phoneNumbers=p.phoneNumbers||[],this.emails=p.emails||[],this.init()}return VMContact.prototype={init:function initFn(){for(var i=0;i<this.phoneNumbers.length;i++)this.phoneNumbers[i].link=this.formatPhone(this.phoneNumbers[i].number),this.phoneNumbers[i].type=this.phoneNumbers[i].type[0];for(var i=0;i<this.emails.length;i++)this.emails[i].link="mailto:"+this.emails[i].address},_phoneRegex:/^(?:\+?1[-. ]?)?(?:\(?([0-9]{3})\)?[-. ]?)?([0-9]{3})[-. ]?([0-9]{4})$/,formatPhone:function formatPhoneFn(phonenum){if(this._phoneRegex.test(phonenum)){var parts=phonenum.match(this._phoneRegex),phoneLink="";return parts[1]&&(phoneLink+="+1-"+parts[1]+"-"),phoneLink+=parts[2]+"-"+parts[3],"tel:"+phoneLink}var parsedNum=phonenum.replace(/\D+/g,"");try{g.PAssert(1932,parsedNum&&""!==parsedNum,"Invalid phone number format: "+phonenum)}catch(PERR){g.reportError(PERR)}return phonenum.startsWith("+")&&(parsedNum="+"+parsedNum),"tel:"+parsedNum},onTapNumber:function onTapNumberFn(e){g.openUrl(this.link,e,!0)},onTapEmail:function onTapEmailFn(e){g.openUrl(this.link,e,!0)},onTap:{onClick:function onClickFn(e){log("Contact Element Tapped: ",e.srcElement,this.text),g.hasClass(e.srcElement,"contactPhone")||g.hasClass(e.srcElement,"contactEmail")||g.autocomplete.onTapped(this.text,this.text.length,!0)}}},VMContact}),define("VMContactManager",["ko","globals","VMContact"],function(ko,g,VMContact){function VMContactManager(){this._contactCache={},this._contacts=[],this._contactsByName={},this._contactNames={___info___:{count:0}},this.init()}return VMContactManager.prototype={init:function initFn(){},loadContacts:function loadContactsFn(contacts,isDemo){try{g.PAssert(1933,0===this._contacts.length,"Should only load contacts once")}catch(PERR){g.reportError(PERR)}var modifiedContact=!1;if(contacts){this._contacts=[];for(var i=0;i<contacts.length;++i){var contact=contacts[i];if(contact.name&&(contact.text=contact.name,contacts[i].text=contact.name,delete contacts[i].name,modifiedContact=!0),!isDemo&&contact.isDemo||contact.text&&!contact.phoneNumbers&&!contact.emails)modifiedContact=!0;else{if(contact.text){var escContact=g.escape(contact.text);this._contactNames[escContact]="",this._contactsByName[contact.text]=contact,this._contacts.push(contact)}try{g.PAssert(1934,contact.id,"Each contact must have a valid id")}catch(PERR){g.reportError(PERR)}}}this._contacts.sort(this.contactComparator),this._contactNames.___info___.count=this._contacts.length}else this.clearContacts();return modifiedContact},addContact:function addContactFn(contact){try{g.PAssert(1935,contact.id,"Incoming contacts must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1936,contact.text,"All contacts are expected to have a text")}catch(PERR){g.reportError(PERR)}var existingContact=this._contactsByName[contact.text];if(existingContact)contact.emails&&(existingContact.emails||(existingContact.emails=[]),existingContact.emails.pushOnlyUniques(contact.emails,this.emailComparator)),contact.phoneNumbers&&(existingContact.phoneNumbers||(existingContact.phoneNumbers=[]),existingContact.phoneNumbers.pushOnlyUniques(contact.phoneNumbers,this.phoneComparator));else{if(this._contacts.insertSorted(contact,this.contactComparator),contact.text){var escContact=g.escape(contact.text);this._contactNames[escContact]="",this._contactsByName[contact.text]=contact}this._contactNames.___info___.count=this._contacts.length}this._contactCache[contact.id]&&(this._contactCache=new VMContact(contact))},updateContact:function updateContactFn(newContact){try{g.PAssert(1937,newContact.id,"Incoming contacts must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1938,newContact.text,"All contacts are expected to have a text")}catch(PERR){g.reportError(PERR)}for(var wasReplaced=!1,i=0;i<this._contacts.length;++i){var oldContact=this._contacts[i];if(oldContact.id===newContact.id){oldContact.text=newContact.text,oldContact.emails=oldContact.phoneNumbers=void 0,this.addContact(newContact),wasReplaced=!0;break}}return wasReplaced?void 0:(this.addContact(newContact),!0)},clearContacts:function clearContactsFn(){this._contactCache={},this._contacts=[],this._contactsByName={},this._contactNames={___info___:{count:0}}},numContacts:function numContactsFn(){try{g.PAssert(1939,this._contacts.length===this._contactNames.___info___.count,"Contact names count should match contacts value")}catch(PERR){g.reportError(PERR)}return this._contacts.length},getContacts:function getContactsFn(){return this._contactNames},previewTemplate:function previewTemplateFn(){return"template-contact"},getItemStyledText:function getItemStyledTextFn(item){return item.text},getItemText:function getItemTextFn(item){return item.text},getItemTextLength:function getItemTextLengthFn(item){return item.text.length},contactComparator:function contactComparatorFn(a,b){return a.text&&b.text?a.text.localeCompare(b.text):a.text&&!b.text?1:!a.text&&b.text?-1:void 0},emailComparator:function emailComparatorFn(a,b){return a.address&&b.address?a.address.localeCompare(b.address):a.address&&!b.address?1:!a.address&&b.address?-1:void 0},phoneComparator:function phoneComparatorFn(a,b){return a===b},ensureCacheObject:function ensureCacheObjectFn(contactData){try{g.PAssert(1940,contactData,"Must have valid data to store in cache")}catch(PERR){g.reportError(PERR)}if(this._contactCache[contactData.id])return this._contactCache[contactData.id];var newContactVM=new VMContact(contactData);return this._contactCache[contactData.id]=newContactVM,newContactVM},findMatchExact:function findMatchExactFn(name){var contactData=this._contactsByName[name];return contactData?this.ensureCacheObject(contactData):void 0},findMatchLike:function findMatchLikeFn(name,maxCount){try{g.PAssert(1941,void 0!==name,"Must provide a valid contact part")}catch(PERR){g.reportError(PERR)}for(var upper=name.toUpperCase(),results=[],i=0;i<this._contacts.length;++i){var index=this._contacts[i].text.toUpperCase().indexOf(upper);if(index>=0&&(results.push(this.ensureCacheObject(this._contacts[i])),results.length>=maxCount))break}return results.sort(this.contactComparator),results},findContactByEmail:function findContactByEmailFn(email){for(var i=0;i<this._contacts.length;++i){var contact=this._contacts[i];if(contact.emails)for(var u=0;u<contact.emails.length;++u)if(contact.emails[u].address===email)return contact}return void 0},findEmailsLike:function findEmailsLikeFn(email,maxCount){try{g.PAssert(1942,void 0!==email,"Must provide a valid email part")}catch(PERR){g.reportError(PERR)}for(var results=[],upper=email.toUpperCase(),i=0;i<this._contacts.length;++i){var contact=this._contacts[i];if(contact&&contact.emails)for(var j=0;j<contact.emails.length;++j){var cEmail=contact.emails[j].address;if(cEmail.toUpperCase().indexOf(upper)>=0&&(results.push(cEmail),results.length>=maxCount))break}if(results.length>=maxCount)break}return results.sort(this.emailComparator),results}},VMContactManager}),define("VMTagManager",["ko","globals"],function(ko,g){function VMTagManager(){this._tagKeys=[],this._tagKeysLower=[],this._tagCache={},this.init()}return VMTagManager.prototype={init:function initFn(){},previewTemplate:function previewTemplateFn(){return void 0},getItemStyledText:function getItemStyledTextFn(item){return item},getItemText:function getItemTextFn(item){return item},getItemTextLength:function getItemTextLengthFn(item){return item?item.length:0},tagComparator:function tagComparatorFn(a,b){return a.localeCompare(b)},findMatchExact:function findMatchExactFn(tag){return this._tagKeys[tag]?tag:void 0},findMatchLike:function findMatchLikeFn(tag,maxCount){var tagLower=tag.toLowerCase(),startIndex=this._tagKeysLower.findInsertIndex(tagLower,this.tagComparator);1===this._tagCache[tag]&&startIndex++;for(var matchCount=maxCount,i=0;maxCount>i&&startIndex+i<this._tagKeys.length;++i)if(!this._tagKeysLower[startIndex+i].startsWith(tagLower)){matchCount=i;break}return this._tagKeys.slice(startIndex,startIndex+matchCount)},notifyAdded:function notifyAddedFn(tag){this._tagCache[tag]?this._tagCache[tag]++:(this._tagCache[tag]=1,this._tagKeys.insertSorted(tag,this.tagComparator),this._tagKeysLower.insertSorted(tag.toLowerCase(),this.tagComparator));try{g.PAssert(1943,this._tagCache[tag]>0,"Invalid value for tag count",this._tagCache[tag])}catch(PERR){g.reportError(PERR)}},notifyRemoved:function notifyRemovedFn(tag){try{g.PAssert(1944,void 0!==this._tagCache[tag]&&this._tagCache[tag]>0,"Invalid value for tag count",this._tagCache[tag])}catch(PERR){g.reportError(PERR)}if(0===--this._tagCache[tag]){var index=this._tagKeys.findInsertIndex(tag,this.tagComparator),removedTag=this._tagKeys.removeAt(index);this._tagKeysLower.removeAt(index);try{g.PAssert(1945,tag===removedTag,"Removed tag should always match incoming tag")}catch(PERR){g.reportError(PERR)}}}},VMTagManager}),define("VMSearchManager",["ko","globals","util"],function(ko,g,util){function VMSearchManager(){this._searchKeys=[],this._searchCache={},this.init()}var DB_SEARCHES="srchs";return VMSearchManager.prototype={init:function initFn(){},previewTemplate:function previewTemplateFn(){return void 0},getItemStyledText:function getItemStyledTextFn(item){return item},getItemText:function getItemTextFn(item){return item},getItemTextLength:function getItemTextLengthFn(item){return item?item.length:0},searchComparator:function searchComparatorFn(a,b){return a.localeCompare(b)},findMatchExact:function findMatchExactFn(str){return this._searchKeys[str]?str:void 0},findMatchLike:function findMatchLikeFn(str,maxCount){for(var startIndex=this._searchKeys.findInsertIndex(str,this.searchComparator),matchCount=maxCount,i=0;maxCount>i&&startIndex+i<this._searchKeys.length;++i)if(!this._searchKeys[startIndex+i].startsWith(str)){matchCount=i;break}return this._searchKeys.slice(startIndex,startIndex+matchCount)},notifyAdded:function notifyAddedFn(str){this._searchCache[str]||(this._searchCache[str]=1),this._searchKeys.insertSorted(str,this.searchComparator)},notifyRemoved:function notifyRemovedFn(str){try{g.PAssert(1946,void 0!==this._searchCache[str]&&this._searchCache[str]>0,"Invalid value for search count",this._searchCache[str])}catch(PERR){g.reportError(PERR)}if(0===--this._searchCache[str]){var index=this._searchKeys.findInsertIndex(str,this.searchComparator),removedSearch=this._searchKeys.removeAt(index);try{g.PAssert(1947,str===removedSearch,"Removed search should always match incoming search")}catch(PERR){g.reportError(PERR)}}},loadSearches:function loadSearchesFn(){if(g.shouldWriteLocal())try{var rawData=util.storage.getItem(DB_SEARCHES);if(rawData){var searchObj=JSON.parse(rawData);this._searchKeys=Object.keys(searchObj),this._searchKeys.sort(this.searchComparator)}}catch(err){g.reportError(err)}},saveSearches:function saveSearchesFn(){g.shouldWriteLocal()&&util.storage.setItem(DB_SEARCHES,JSON.stringify(this._searchCache))}},VMSearchManager}),define("ItemStore",["globals","util"],function(g,util){function ItemStore(id,isReadonly,isDestructible,owner){this.id=id,this._readonly=!!isReadonly,this._isDestructible=!!isDestructible,this._owner=owner,this._root=void 0,this._data={},this._destroyed=!1,this.init()}return ItemStore.prototype={init:function initFn(){this._constructor=require("VMLI")},isOwner:function isOwnerFn(owner){return this._owner===owner},destroy:function destroyFn(){this._destroyed=!0,this.clearStore(),this._root=void 0,this._owner=void 0,util.destroy(this)},clearStore:function clearStoreFn(){this._data={},this._root&&(this._root.items([]),this._data[this._root.id]=this._root)},createRoot:function createRootFn(id,text){this._root=this.createItem(id,text)},createItem:function createItemFn(id,text,parentID,props){try{g.PAssert(1948,!this._data[id],"Should never double-create for the same item, should use update instead")
}catch(PERR){g.reportError(PERR)}var parent;if(parentID){parent=this._data[parentID];try{g.PAssert(1949,parent,"Parent must be valid if defined")}catch(PERR){g.reportError(PERR)}}var itemData={id:id,text:text};if(props)for(var key in props)props.hasOwnProperty(key)&&(itemData[key]=props[key]);var item=new this._constructor(itemData,{parent:parent,changeType:ChangeType.None,canDestroy:this._isDestructible,noSave:this._readonly});return this._data[id]=item,item},destroyItem:function destroyItemFn(id){var item=this._data[id];item.destroy(),this._data[id]=void 0},getItem:function getItemFn(id){return this._data[id]},hasItem:function hasItemFn(id){return!!this._data[id]},getRoot:function getRootFn(){return this._root},getCount:function getCountFn(){return Object.keys(this._data).length},forEach:function forEachFn(fn){for(var id in this._data)this._data[id]&&fn(this._data[id])}},util.defineBase(ItemStore),ItemStore}),define("data",["globals","util","gdata","database","demo","platform","VMContactManager","VMTagManager","VMSearchManager","ItemStore"],function(g,util,gdata,database,demo,platform,VMContactManager,VMTagManager,VMSearchManager,ItemStore){function transactionDoneCallback(){}function transactionErrorCallback(){log("Transaction Error: ",arguments)}function removeItemSubtree(id){var item=self.getItem(id);if(item){var children=item.items;if(children)for(var i=0;i<children.length;++i)removeItemSubtree(children[i]);self.dbDeleteItem(item.id)}}function doArchive(item,archivedItem,value){try{g.PAssert(1987,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1988,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}item.save({items:item.getItemsArrayForSave()},SaveFlag.None),archivedItem.save({isArchived:value},SaveFlag.None)}function makePropString(item,field){var value=item[field];return value?',"'+field+'":'+value:""}function makeJSON(item,hasPrev,allowArchived){var str="";hasPrev&&(str+=",");var model=self.getModel(item.id),text=String(model.getParsedText()).replace(/[\"\\]/g,function(chr){return charMapJSON[chr]}),item=self.getItem(item.id),dateCompletedString=makePropString(item,"dateCompleted"),priorityString=makePropString(item,"priority"),isCompleteString=makePropString(item,"isComplete"),isStarredString=makePropString(item,"isStarred"),isArchivedString=makePropString(item,"isArchived");if(str+='{"text": "'+text+'"'+dateCompletedString+priorityString+isCompleteString+isStarredString+isArchivedString,item.items&&item.items.length>0){str+=',"items":[';for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]);(!child.isArchived||child.isArchived&&allowArchived)&&(str+=makeJSON(child,i>0,allowArchived))}str+="]"}return str+="}"}var DB_CONTACTS="ctcs",self={pendingRemoteUpdates:{},itemCache:{},dbDataCache:{},loadedItemCount:0,hasLocalData:!1,freezeUpdates:!1,dbi:void 0,contactManager:new VMContactManager,tagManager:new VMTagManager};self.forEachModel=function forEachModelFn(fn){try{g.PAssert(1950,fn,"Must pass a valid function to iterate on")}catch(PERR){g.reportError(PERR)}for(var id in self.itemCache)self.itemCache[id]&&fn(self.itemCache[id])},self.getModel=function getModelFn(id){try{g.PAssert(1951,g.isString(id),"ID must be a valid string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1952,id,"Tried to get a model with an invalid id")}catch(PERR){g.reportError(PERR)}return self.itemCache[id]},self.setModel=function setModelFn(model){try{g.PAssert(1953,model,"Tried to set an invalid model")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1954,model.id,"Tried to set a model with an invalid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1955,g.isString(model.id),"ID must be a valid string")}catch(PERR){g.reportError(PERR)}self.itemCache[model.id]=model},self.getItem=function getItemFn(id){try{g.PAssert(1956,g.isString(id),"ID must be a valid string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1957,id,"Tried to get an item that doesn't exist")}catch(PERR){g.reportError(PERR)}return self.dbDataCache[id]},self.setItem=function setItemFn(id,data){try{g.PAssert(1958,g.isString(id),"ID must be a valid string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1959,id,"Tried to set an item with an invalid id")}catch(PERR){g.reportError(PERR)}self.dbDataCache[id]=data},self.clearItems=function clearItemsFn(){self.dbDataCache={},self.itemCache={}},self.clearPlugins=function clearPluginsFn(){g.vmMain.pluginManager.onClearData()},self.getRootItem=function getRootItemFn(){return self.rootId?self.getItem(self.rootId):void 0},self.getRootModel=function getRootModelFn(){return self.rootId?self.getModel(self.rootId):void 0};var itemStores={};self.registerItemStore=function registerItemStoreFn(id,owner){try{g.PAssert(1960,!itemStores[id],"Should only register a single item store per plugin")}catch(PERR){g.reportError(PERR)}return itemStores[id]=new ItemStore(id,!0,!0,owner),itemStores[id]},self.unregisterItemStore=function unregisterItemStoreFn(id){try{g.PAssert(1961,itemStores[id],"Must register an item store before destroying it")}catch(PERR){g.reportError(PERR)}itemStores[id].destroy(),itemStores[id]=void 0},self.getItemStore=function getItemStoreFn(id){try{g.PAssert(1962,itemStores[id],"Must register an item store before using it")}catch(PERR){g.reportError(PERR)}return itemStores[id]},self.initializeIndexedDB=function initializeIndexedDBFn(handler){function initLocalDB(initSuccess){initSuccess?database.open({server:"duchess",version:version,schema:{items:{key:{keyPath:"id"}},settings:{}}}).done(function(server){self.dbi=server,handler()}).fail(function(e){try{log("Error loading local DB client - "+e.target.error.name+": "+e.target.error.message)}catch(err2){log("Error loading local DB client - Invalid Error Message")}g.preventLocalWrites(),"Firefox"===platform.browser?e.target&&e.target.error&&"InvalidStateError"===e.target.error.name||g.reportError(e):g.reportError(e),"VersionError"===e.target.error.name&&g.AppCache.runOnFinish(g.reload,!0),handler()}):(log("Shim failed to init."),g.preventLocalWrites(),handler())}var version=1;window.indexedDB&&void 0!==window.indexedDB.onIsReady&&null!==window.indexedDB.onIsReady?window.indexedDB.onIsReady(initLocalDB):setTimeout(function(){initLocalDB(!0)},0)};var isLocalDataLoaded=!1;self.localDataLoaded=function localDataLoadedFn(){return isLocalDataLoaded},self.loadFromIndexedDB=function loadFromIndexedDBFn(callback){try{g.PAssert(1964,!isLocalDataLoaded,"Should never load local data twice")}catch(PERR){g.reportError(PERR)}self.dbDataCache={},g.shouldWriteLocal()&&self.dbi&&self.dbi.items?self.dbi.items.query().all().execute().done(function(results){self.loadedItemCount=results.length;for(var i=0;i<results.length;++i)self.setItem(results[i].id,g.translateObjOut(results[i]));isLocalDataLoaded=!0,self.dbi.settings?self.dbi.settings.get("root").done(function(result){if(!g.criticalErrorReported()){if(result){try{g.PAssert(1965,self.getItem(result.root),"If there is a root item defined there should be a corresponding local item")}catch(PERR){g.reportError(PERR)}self.rootId=result.root}log("Root Item: ",self.rootId),callback&&callback()}}).fail(callback):(log("Unable to load local settings DB"),callback&&callback())}):(log("Unable to load local items DB"),isLocalDataLoaded=!0,g.preventLocalWrites(),callback&&callback())};var updateTransaction;self.beginTransaction=function beginTransactionFn(){g.shouldWriteLocal()&&(updateTransaction={})},self.transactionUpdate=function transactionUpdateFn(id,data){try{g.PAssert(1966,g.shouldWriteLocal(),"Should never be writing during a transaction if local writes are disabled")}catch(PERR){g.reportError(PERR)}if(updateTransaction[id])for(var attr in data)updateTransaction[id][attr]=data[attr];else updateTransaction[id]=data},self.endTransaction=function endTransactionFn(){if(g.shouldWriteLocal()&&self.dbi&&self.dbi.items)try{self.dbi.items.updateObject(updateTransaction).done(transactionDoneCallback).fail(transactionErrorCallback)}catch(err){g.reportError(err),transactionErrorCallback()}else void 0!==updateTransaction&&g.reportError(new Error("Started a transaction and stopped writes halfway through"));updateTransaction=void 0},self.dbUpdateItem=function dbUpdateItemFn(params){function trackUpdates(){if(window.__UPDATES_ACTUAL++,callback){var args=Array.prototype.slice.call(arguments,1);callback(args)}}if(!self.freezeUpdates){self.hasLocalData||g.isLoadingRemote||params.skipLocalModification||(self.hasLocalData=!0);var changes=params.changes||{},id=params.id?params.id:changes.id,callback=params.callback,saveFlags=params.saveFlags;try{g.PAssert(1967,saveFlags===SaveFlag.None||saveFlags===SaveFlag.Prop||saveFlags===SaveFlag.Text||saveFlags===SaveFlag.All)}catch(PERR){g.reportError(PERR)}var item=self.getItem(id);if(g.shouldWriteLocal()){var translated;try{g.PAssert(1968,!saveFlags||void 0===changes.modifiedOffline&&void 0===changes.modifiedOfflineText,"Shouldn't be setting a modified flag while passing them in with changes")}catch(PERR){g.reportError(PERR)}if(g.isFlagSet(saveFlags,SaveFlag.Prop)){try{g.PAssert(1969,void 0===changes.modifiedOffline,"Shouldnt be passing in a value and assigning "+changes.modifiedOffline)}catch(PERR){g.reportError(PERR)}changes.modifiedOffline=!0;var model=self.getModel(id);model&&(model.modifiedOffline=!0)}if(g.isFlagSet(saveFlags,SaveFlag.Text)){try{g.PAssert(1970,void 0===changes.modifiedOfflineText,"Shouldnt be passing in a value and assigning "+changes.modifiedOfflineText)}catch(PERR){g.reportError(PERR)}changes.modifiedOfflineText=!0;var model=self.getModel(id);model&&(model.modifiedOfflineText=!0)}if(item){for(var prop in changes)if(changes.hasOwnProperty(prop)){var verStr;item[prop]=changes[prop]}translated=g.translateObjIn(item)}else{try{g.PAssert(1971,changes.id,"Item being modified does not already exist as expected",changes)}catch(PERR){g.reportError(PERR)}var verStr,verStr;self.setItem(id,changes),translated=g.translateObjIn(changes)}if(updateTransaction){try{g.PAssert(1973,!callback,"Callbacks not supported for updates inside of a transaction")}catch(PERR){g.reportError(PERR)}self.transactionUpdate(id,translated)}else try{callback?self.dbi.items.update(translated).done(callback).fail(callback):self.dbi.items.update(translated)}catch(err){g.reportError(err)}}else{if(item)for(var prop in changes)changes.hasOwnProperty(prop)&&(item[prop]=changes[prop]);else self.setItem(id,changes);callback&&callback()}}},self.dbDeleteItem=function dbDeleteItemFn(id,callback){if(!self.freezeUpdates&&(self.setItem(id,void 0),g.shouldWriteLocal()))try{callback?self.dbi.items.remove(id).done(callback).fail(callback):self.dbi.items.remove(id)}catch(err){g.reportError(err)}},self.setRoot=function setRootFn(id){if(!self.freezeUpdates){if(g.shouldWriteLocal())try{self.dbi.settings.update({key:"root",item:{root:id}})}catch(err){g.reportError(err)}return self.rootId=id,self.getRootItem()}},self.setPluginData=function setPluginDataFn(data){var plugins=Object.keys(data);demo.clearGapiData();for(var i=0;i<plugins.length;++i){var pluginID=plugins[i],plugin=g.vmMain.pluginManager.getPlugin(pluginID),pluginData=data[pluginID].data;pluginData&&(demo.setGapiData(pluginID,pluginData),plugin.forceLoad())}};var demoId=0,loadedDemoData={};self.loadDemoData=function loadDemoDataFn(testData,forceLoad,handler){function insertIntoDB(root){root.id||(root.id="demo"+demoId++),self.setItem(root.id,root);var items=root.items;if(items){for(var itemIDs=[],i=0;i<items.length;++i)items[i].id||(items[i].id="demo"+demoId++),itemIDs.push(items[i].id),insertIntoDB(items[i]);root.items=itemIDs}}function handleDataLoad(demoData){var root,plugins;demoData&&(root=demoData[0],plugins=demoData[1]),plugins&&(forceLoad&&self.clearPlugins(),self.setPluginData(plugins)),root&&(forceLoad&&self.clearItems(),insertIntoDB(root),self.setRoot(root.id),loadedDemoData[testData]={root:root,plugins:plugins},isLocalDataLoaded=!0,handler&&handler(root.id))}if(void 0===testData&&(testData="demo.5"),demo.areRemoteFunctionsHooked()||demo.hookRemoteFunctions(),forceLoad||void 0===testData||""===testData||void 0===loadedDemoData[testData])demo.loadRemoteData(testData,handleDataLoad);else{log("Use Preloaded demo data: ",testData);var demoData=loadedDemoData[testData];self.setRoot(demoData.root.id),demoData.plugins&&self.setPluginData(demoData.plugins),handler&&handler(demoData.root.id)}};var initDataCalled=!1;self.initData=function initDataFn(handler){if(initDataCalled)return!1;initDataCalled=!0;try{g.isDemoMode()?setTimeout(function(){var testData=util.getURLParam("data");self.loadDemoData(testData,!1,handler)},0):(g.checkpoint(Checkpoint.InitData),self.initializeIndexedDB(function(){self.loadFromIndexedDB(function(){g.checkpoint(Checkpoint.DBLoaded),self.checkLocalIntegrity(function(){self.loadLocalContacts(),handler(),self.hasLocalData||platform.offline||!navigator.onLine||g.vmMain.isLoadingDoc(!0)})})}))}catch(err){g.reportError(err)}return!0},self.initializeItem=function initializeItemFn(item){try{g.PAssert(1974,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var oldId=item.id,isNewItem=!oldId||g.isLocalItem(item)||!item.data;if(isNewItem){var newId=gdata.createNewItem(item,item.hasChildren(),item.hasArchivedChildren());oldId&&oldId!==newId&&self.modifyItemId(oldId,newId);for(var hasNewChildren=!1,items=item.items(),i=0;i<items.length;++i)hasNewChildren|=self.initializeItem(items[i]);if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;++i)hasNewChildren|=self.initializeItem(archivedItems[i]);if(item.hasNote()&&(hasNewChildren|=self.initializeItem(item.getNote())),gdata.initializeNewItem(item),oldId&&oldId!==newId){var parent=item.parent();parent&&parent.save(null,SaveFlag.None)}}return isNewItem},self.checkLocalIntegrity=function checkLocalIntegrityFn(callback){var localDataError=!1,localData=!1;self.ensureLocalCache(function(){var rootSeen=!1,seen={};for(var id in self.dbDataCache)if(self.dbDataCache.hasOwnProperty(id)&&self.getItem(id)){var item=self.getItem(id);(item.i||item.t)&&(log("%cInvalid local properties on item: ","color: red",item),localDataError=!0),seen[item.id]?seen[item.id].exist?(log(item.id,": Duplicated IDs in the local database",item),localDataError=!0):(seen[item.id].exist=!0,seen[item.id].del=!!item.isDeleted):seen[item.id]={exist:!0,ref:!1,del:!!item.isDeleted},item.id===self.rootId&&(rootSeen&&(log(item.id,": Multiple roots present locally",item),localDataError=!0),rootSeen=!0,seen[item.id].isRoot=!0),void 0===item.text&&(log("Found item with no text",item.id),item.text="",self.dbUpdateItem({id:id,changes:{text:""},saveFlags:SaveFlag.None})),item.note&&(seen[item.note]?seen[item.note].ref?(log(item.id,": Item note is used twice - ",item.note),localDataError=!0):seen[item.note].ref=item.id:seen[item.note]={exist:!1,ref:item.id});for(var j=0;item.items&&j<item.items.length;++j){var seenArchived=-1;if(item.items[j]){var child=item.items[j],childInfo=self.getItem(child);if(childInfo){if(childInfo.isArchived&&(seenArchived=j),seenArchived>=0&&!childInfo.isArchived){log(child,": Unarchived child found after an archived one"),log("   ",item.id,": Parent with incorrectly ordered children"),localDataError=!0;var archivedItem=item.items.removeAt(seenArchived);item.items.insert(j,archivedItem),seenArchived=j,self.dbUpdateItem({id:item.id,changes:{items:item.items},saveFlags:SaveFlag.None})}}else log(child,": Child does not have a valid reference on our local database"),localDataError=!0;if(seen[child])if(seen[child].ref){log(child,": Item is referenced locally multiple times: ",childInfo?self.getItem(child).id:"UNDEFINED"),log("   ",seen[child].ref,": ",self.getItem(seen[child].ref).id),log("   ",item.id,": <CLIENTDATA>"),localDataError=!0;var newItems=item.items;newItems.removeAt(j),self.dbUpdateItem({id:id,changes:{items:newItems},saveFlags:SaveFlag.None})}else seen[child].ref=item.id;else seen[child]={exist:!1,ref:item.id}}else log(item.id,": Invalid item in local items array"),localDataError=!0}}rootSeen||(log("No root present"),localDataError=!0);for(var entryID in seen){var entry=seen[entryID];if(!entry.exist){log(entryID,": Item is referenced locally as a child but does not exist in the database");var item=self.getItem(entry.ref);try{g.PAssert(1975,item,"Parent of item must exist")}catch(PERR){g.reportError(PERR)}if(item){var newItems=item.items;newItems?newItems.remove(entryID):newItems=[],self.dbUpdateItem({id:item.id,changes:{items:newItems},saveFlags:SaveFlag.None})}}if(entry.ref||entry.isRoot||entry.del||(log(entryID,": Item exists locally but is not referenced by a parent"),removeItemSubtree(entryID)),entry.ref&&entry.del){log(entryID,": Item is referenced locally by a parent but has been deleted");var item=self.getItem(entry.ref);try{g.PAssert(1976,item)}catch(PERR){g.reportError(PERR)}var newItems=item.items;newItems?newItems.remove(entryID):newItems=[],self.dbUpdateItem({id:item.id,changes:{items:newItems},saveFlags:SaveFlag.None})}if(entry.isRoot&&entry.ref&&(log(entryID,": Local root has a parent"),localDataError=!0),entry.del&&!entry.ref){var item=self.getItem(entryID);g.isLocalItem(item)&&(log("Deleting Unreferenced Local Item: ",entryID),self.dbDeleteItem(entryID))}}callback({error:localDataError,local:localData})})},self.removeDeletedItems=function removeDeletedItemsFn(remoteSeen){for(var id in self.dbDataCache){var localItem=self.getItem(id);localItem&&localItem.isDeleted&&(remoteSeen[id]||self.dbDeleteItem(id))}},self.clearData=function clearDataFn(cb,skip){self.freezeUpdates=!0,g.shouldWriteLocal()?setTimeout(function(){function clearLocalStorage(){self.clearContacts();var skipObj;skipObj=g.isArray(skip)?{Default:skip}:skip,g.settings.resetAll(skipObj),g.vmMain&&g.vmMain.pluginManager&&g.vmMain.pluginManager.onPurgeData(),cb&&cb()}function clearItems(){if(self.dbi.items)try{self.dbi.items.clear().done(function(){clearLocalStorage()}).fail(function(){log("Failed to reset items!",arguments),clearLocalStorage()})}catch(err){g.reportError(err),clearLocalStorage()}}if(g.pageDataCleared(),!self.dbi)return void self.initializeIndexedDB(function(){self.clearData(cb,skip)});if(self.dbi.settings)try{self.dbi.settings.clear().done(function(){clearItems()}).fail(function(){log("Failed to reset settings!",arguments),clearItems()})}catch(err){g.reportError(err),clearItems()}},0):cb&&setTimeout(cb,0)};var localContactsLoaded=!1;self.clearLocalContacts=function clearLocalContactsFn(){if(localContactsLoaded=!1,g.shouldWriteLocal())try{util.storage.setItem(DB_CONTACTS,"[]")}catch(err){g.reportError(err)}self.contactManager.clearContacts(),g.settings.set(Settings.lastContactSync,void 0)},self.loadLocalContacts=function loadLocalContactsFn(){if(!localContactsLoaded&&(localContactsLoaded=!0,g.shouldWriteLocal()))try{self.contactManager.loadContacts(JSON.parse(util.storage.getItem(DB_CONTACTS)),!1)}catch(err){g.reportError(err)}},self.areLocalContactsLoaded=function areLocalContactsLoadedFn(){return localContactsLoaded},self.saveContacts=function saveContactsFn(){g.shouldWriteLocal()&&util.storage.setItem(DB_CONTACTS,JSON.stringify(self.contactManager._contacts))},self.clearContacts=function clearContactsFn(){g.settings.reset(Settings.lastContactSync),g.shouldWriteLocal()&&util.storage.removeItem(DB_CONTACTS,void 0)},self.insertItems=function insertItemsFn(item,items,index){try{g.PAssert(1977,item,"Must pass in a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1978,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1979,void 0===index||index>=0,"Must pass in a valid index")}catch(PERR){g.reportError(PERR)}item.save({items:item.getItemsArrayForSave()},SaveFlag.Prop),1===items.length?gdata.itemAdded({item:item,addedItem:items[0],index:index,isArchived:!1}):gdata.itemsAdded({item:item,addedItems:items,index:index,isArchived:!1})},self.removeItem=function removeItemFn(item,index,removedItem,isArchived){try{g.PAssert(1980,item,"Must pass in a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1981,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1982,void 0===index||index>=0,"Must pass in a valid index")}catch(PERR){g.reportError(PERR)}item.save({items:item.getItemsArrayForSave()},SaveFlag.Prop),removedItem&&removedItem.data&&gdata.itemRemoved({item:item,index:index,numToRemove:1,isArchived:isArchived})},self.moveItem=function moveItemFn(params){var item=params.item,newInfo=params.newInfo,oldParent=params.oldParent,oldInfo=params.oldInfo,isRemoteChange=params.isRemoteChange,noVersion=params.noVersion,saveFlags=isRemoteChange?SaveFlag.None:SaveFlag.Prop;try{g.PAssert(1983,void 0!==item&&void 0!==newInfo&&void 0!==oldParent&&void 0!==oldInfo,"moveItem is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1984,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1985,oldParent.shouldSave(),"Old parent must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1986,item.parent().shouldSave(),"New parent must be marked as saveable")}catch(PERR){g.reportError(PERR)}oldParent.save({items:oldParent.getItemsArrayForSave()},saveFlags),item.parent().save({items:item.parent().getItemsArrayForSave()},saveFlags),oldInfo.isArchived!==newInfo.isArchived&&(item.isArchived(newInfo.isArchived),item.save({isArchived:newInfo.isArchived},saveFlags)),isRemoteChange||(self.saveChanges(item,{},saveFlags),gdata.itemMoved({item:item,newInfo:newInfo,oldParent:oldParent,oldInfo:oldInfo,noVersion:noVersion}))},self.archiveItem=function archiveItemFn(item,index,archivedItem){try{g.PAssert(1989,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1990,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1991,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}doArchive(item,archivedItem,!0),archivedItem.data&&gdata.itemArchived(item,archivedItem,index)},self.unarchiveItem=function unarchiveItemFn(item,index,unarchivedItem){try{g.PAssert(1992,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1993,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1994,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}doArchive(item,unarchivedItem,!1),unarchivedItem.data&&gdata.itemUnarchived(item,unarchivedItem,index,item.items().length-1)},self.modifyItemId=function modifyItemIdFn(id,newId,callback){var item=self.getItem(id),model=self.getModel(id);try{g.PAssert(1995,model.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}if(item.id=newId,model.id=newId,self.pendingRemoteUpdates[id]&&(self.pendingRemoteUpdates[id]=void 0,self.pendingRemoteUpdates[newId]=!0),item.version=-1,item.versionText=-1,"root"===id)for(var i=item.items.length-1;i>=0;i--){var rootChild=self.getItem(item.items[i]);if(g.isLocalItem(rootChild)&&!rootChild.modifiedOffline&&!rootChild.modifiedOfflineText){item.items.removeAt(i);try{g.PAssert(1996,model.items()[i].id===rootChild.id,"Item arrays should match")}catch(PERR){g.reportError(PERR)}model.items().removeAt(i)}}self.itemCache[newId]=self.itemCache[id],self.dbDataCache[newId]=item,self.dbDeleteItem(id),self.dbUpdateItem({changes:item,callback:callback,skipLocalModification:!0,saveFlags:SaveFlag.None}),self.dbDataCache[id]=void 0,delete self.dbDataCache[id],self.itemCache[id]=void 0,delete self.itemCache[id]},self.deleteItem=function deleteItemFn(item){try{g.PAssert(1997,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1998,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(1999,!item.isDeleted(),"Should never try to delete an item that has already been deleted")}catch(PERR){g.reportError(PERR)}var localItem=self.getItem(item.id);if(localItem)item.isDeleted(!0),self.dbUpdateItem({id:item.id,changes:{isDeleted:!0},saveFlags:SaveFlag.Prop});else try{g.PAssert(2e3,"Expected local item, didnt find one",item.id)}catch(PERR){g.reportError(PERR)}},self.undeleteItem=function undeleteItemFn(item){var localItem=self.getItem(item.id);if(localItem)item.isDeleted(!1),self.dbUpdateItem({id:item.id,changes:{isDeleted:void 0},saveFlags:SaveFlag.Prop});else try{g.PAssert(2001,"Expected local item, didnt find one",item.id)}catch(PERR){g.reportError(PERR)}},self.saveChanges=function saveChangesFn(item,changes,saveFlags){if(item){try{g.PAssert(2003,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}changes||(changes={}),self.dbUpdateItem({id:item.id,changes:changes,saveFlags:saveFlags})}else{log("Incoming item to save has no item!",item,changes);try{g.PAssert(2002,!1,"Incoming item to save has no item!")}catch(PERR){g.reportError(PERR)}}},self.addPendingUpdate=function addPendingUpdateFn(id){try{g.PAssert(2004,id,"Invalid ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2005,g.isString(id),"Must provide a valid id string")}catch(PERR){g.reportError(PERR)}self.pendingRemoteUpdates[id]||(self.pendingRemoteUpdates[id]=!0)},self.clearPendingUpdates=function clearPendingUpdatesFn(){for(var itemID in self.pendingRemoteUpdates){try{g.PAssert(2006,self.pendingRemoteUpdates.hasOwnProperty(itemID))}catch(PERR){g.reportError(PERR)}var item=self.getModel(itemID),itemData=self.getItem(itemID);if(itemData&&itemData.isDeleted)self.dbDeleteItem(itemID);else if(item&&item.data){var changes={modifiedOffline:!1,modifiedOfflineText:!1};item.modifiedOffline=!1,item.modifiedOfflineText=!1;var newVersion=gdata.getVersion(item.data,VersionType.Structure),newTextVersion=gdata.getVersion(item.data,VersionType.Text);newVersion!=item.getVersion(VersionType.Structure)&&(changes.version=newVersion,item.setVersion(VersionType.Structure,newVersion)),newTextVersion!=item.getVersion(VersionType.Text)&&(changes.versionText=newTextVersion,item.setVersion(VersionType.Text,newTextVersion)),self.dbUpdateItem({id:itemID,changes:changes,saveFlags:SaveFlag.None})}}self.pendingRemoteUpdates={},self.printIndexedDB("id","text","version","versionText","modifiedOffline","isArchived")};var charMapJSON={'"':'\\"',"\\":"\\\\"};return self.toHtml=function toHtmlFn(item,allowArchived){var str="<ul>";if(item.items)for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]),model=self.getModel(child.id),text=g.escape(model.getParsedText());(!child.isArchived||child.isArchived&&allowArchived)&&(str+="<li>"+text,child.items&&child.items.length>0&&(str+=self.toHtml(child,allowArchived)),str+="</li>")}return str+="</ul>"},self.toPlainText=function toPlainTextFn(item,indent,allowArchived){isNaN(indent)&&(indent=0);var str="";if(item.items)for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]),model=self.getModel(child.id);if(!child.isArchived||child.isArchived&&allowArchived){for(var u=0;indent>u;u++)str+="	";str+=model.getParsedText()+"\n",child.items&&child.items.length>0&&(str+=self.toPlainText(child,indent+1,allowArchived))}}return str},self.toJSON=function toJSONFn(item,hasPrev,allowArchived){var rootItem=makeJSON(item,hasPrev,allowArchived);return'{"moodoVer":'+(g.settings.get(Settings.localDataVersion)||gdata.currentVersion())+',"moodoRoot":'+rootItem+"}"},self.ensureLocalCache=function ensureLocalCacheFn(callback){var root=self.getRootItem();if(root)self.loadedItemCount>1&&(self.hasLocalData=!0),callback();else{var oldLocalData=self.hasLocalData;self.dbUpdateItem({changes:{id:"rootItem",text:"Home",items:[]},skipLocalModification:!0,saveFlags:SaveFlag.None,callback:function callbackFn(){self.setRoot("rootItem"),self.hasLocalData=oldLocalData,callback()}})}},self.printIndexedDB=function printIndexedDBFn(){var args,i,printAll},self}),define("goog",["ko","data","globals","util","gdata","platform"],function(ko,d,g,util,gdata,platform){function showErrorMessage(){g.messageQueue.pushMessage({text:"There was an internal error in Google Drive. Please reload to try again.",action:MessageAction.Reload}),g.vmMain.setGDriveStatus(DriveStatus.Offline)}function openDefaultRealtimeFile(callback){g.vmMain.setGDriveStatus(DriveStatus.Connecting),gapi.client.load("drive","v2",function(){if(!gapi.client.drive)return void showErrorMessage();var queryString="(title='"+self.LEGACY_DefaultDriveDocTitle+"' or properties has {key='"+self.DefaultProperty+"' and value='"+self.DefaultPropertyValue+"' and visibility='PRIVATE'}) and 'me' in owners and trashed=false";gapi.client.drive.files.list({fields:docFields,q:queryString}).execute(function(results){results&&results.items&&0!==results.items.length?callback(results.items[0],!1):results&&200!==results.code&&results.error?showErrorMessage():createDefaultRealtimeFile(callback)})})}function getRootFolder(cb){try{g.PAssert(2030,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2031,cb,"Must provide a valid callback when getting the root folder")}catch(PERR){g.reportError(PERR)}if(rootFolderID)return cb(rootFolderID);var folderID=g.settings.get(Settings.rootFolderId);return folderID?cb(folderID):void gapi.client.drive.files.list({fields:docFields,q:"properties has {key='"+self.DefaultRootFolderProperty+"' and value='"+self.DefaultRootFolderPropertyValue+"' and visibility='PRIVATE'} and 'me' in owners and trashed=false"}).execute(function(results){if(results&&results.items&&0!==results.items.length){var rootFolderInfo=results.items[0];return rootFolderID=rootFolderInfo.id,g.settings.set(Settings.rootFolderId,rootFolderID),cb(rootFolderInfo.id)}return results&&200!==results.code&&results.error?cb():void createDefaultFileStructure(function(rootID){return rootFolderID=rootID,g.settings.set(Settings.rootFolderId,rootFolderID),cb(rootFolderID)})})}function getDocumentFolder(docID,cb){try{g.PAssert(2032,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2033,docID,"Must provide a valid document ID when getting the doc folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2034,cb,"Must provide a valid callback when getting the doc folder")}catch(PERR){g.reportError(PERR)}if(docFolderID)return cb(docFolderID);if(this.isLoaded){var folderID=gdata.root.get("docFolderID");if(folderID)return docFolderID=folderID,cb(docFolderID)}var docPropValue=self.DocFolderPropertyPrefix+docID;gapi.client.load("drive","v2",function(){try{var queryString="properties has {key='"+self.DocFolderProperty+"' and value='"+docPropValue+"' and visibility='PRIVATE'} and trashed=false";gapi.client.drive.files.list({fields:docFields,q:queryString}).execute(function(results){if(results&&results.items&&0!==results.items.length){var docFolderInfo=results.items[0];return docFolderID=docFolderInfo.id,cb(docFolderInfo.id)}return results&&200!==results.code&&results.error?cb():void createDocumentFileStructure(docID,function(folderID){return docFolderID=folderID,cb(docFolderID)})})}catch(err){return g.reportError(err),cb()}})}function createDefaultFileStructure(cb){try{g.PAssert(2035,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2036,void 0===rootFolderID,"Must not already have a root folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2037,cb,"Must supply a valid callback when done creating the default file structure")}catch(PERR){g.reportError(PERR)}gapi.client.drive.files.insert({resource:{mimeType:self.FOLDER_MIMETYPE,title:self.DefaultFolderTitle,writersCanShare:!1,properties:[{key:self.DefaultRootFolderProperty,value:self.DefaultRootFolderPropertyValue,visibility:"PRIVATE"}]}}).execute(function(folderInfo){return 200!==folderInfo.code&&folderInfo.error?cb():(rootFolderID=folderInfo.id,g.settings.set(Settings.rootFolderId,rootFolderID),cb(folderInfo.id))
})}function createDocumentFileStructure(docID,cb){try{g.PAssert(2038,void 0===docFolderID,"Must not already have a document folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2039,docID,"In order to create a valid folder structure we must have a valid document ID")}catch(PERR){g.reportError(PERR)}getRootFolder(function(rootFolderID){return rootFolderID?void gapi.client.drive.files.insert({resource:{mimeType:self.FOLDER_MIMETYPE,title:self.DocFolderTitlePrefix+docID,writersCanShare:!1,parents:[{id:rootFolderID}],properties:[{key:self.DocFolderProperty,value:self.DocFolderPropertyPrefix+docID,visibility:"PRIVATE"}]}}).execute(function(folderInfo){return 200!==folderInfo.code&&folderInfo.error?cb():(docFolderID=folderInfo.id,cb(folderInfo.id))}):cb()})}function createDefaultRealtimeFile(callback){self.createAndSetupDocument(!0,function(docInfo){if(200!==docInfo.code&&docInfo.error)showErrorMessage();else{var loadFileID=util.getURLParam("file");if(loadFileID)try{try{g.PAssert(2040,gapi.drive,"gapi.drive should exist")}catch(PERR){g.reportError(PERR)}util.removeURLParam("file"),gdata.driveRealtimeLoad(loadFileID,onDocLoaded,onDocInitialized,onDocLoadError);try{window.__LOAD_REQUESTS.push(g.getCurrentStack("File Request After Default Load"))}catch(err){g.reportError(err)}}catch(err){g.reportError(err)}else callback(docInfo,!0)}})}function onFirstDocInitialized(doc){log("First Run Drive Document"),onDocInitialized(doc),self.onHaveUserSignupData(function(){g.sendEvent("Subscribe","NewUser"),g.reportSignup(self.getCurrentUserEmail(),self.getCurrentUserSignupInfo())})}function onDocInitialized(doc){log("Drive Document Initialized"),gdata.onInitialized(doc),self.onHaveUserSignupData(function(){g.sendEvent("Documents","CreateNew")})}function onDocLoaded(doc){g.vmMain.setGDriveStatus(DriveStatus.Saved);var success=gdata.onLoad(doc);if(success){self.startWatchdog();var folderID=doc.getModel().getRoot().get("docFolderID");folderID||getDocumentFolder(self.getDocId(),function(newFolderID){doc.getModel().getRoot().set("docFolderID",newFolderID)}),self.isLoaded=!0,g.fireCustomEvent("docLoaded")}}function onDocLoadError(e){switch(ShouldLog(LogLevels.Error)&&log("Doc Load Error - ",JSON.stringify(e)),e.type){case gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED:try{g.PAssert(2050,!e.isFatal,"Token refresh required causes a non-fatal error")}catch(PERR){g.reportError(PERR)}self.recoverFromError();break;case gapi.drive.realtime.ErrorType.INVALID_COMPOUND_OPERATION:try{g.PAssert(2051,e.isFatal,"Invalid compound operation causes a fatal error")}catch(PERR){g.reportError(PERR)}ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+e.type+"] Fatal: "+e.isFatal),g.reportError(new Error("Invalid Compound Operation: "+g.safeStringify(e)));break;case gapi.drive.realtime.ErrorType.CONCURRENT_CREATION:case gapi.drive.realtime.ErrorType.CLIENT_ERROR:ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+e.type+"] Fatal: "+e.isFatal),g.reportError(new Error("Client Error: "+g.safeStringify(e))),self.clearDocInfo(),findAndLoadDoc();break;case gapi.drive.realtime.ErrorType.FORBIDDEN:case gapi.drive.realtime.ErrorType.NOT_FOUND:ShouldLog(LogLevels.Error)&&log("Unable to access or find the requested document"),g.reportError(new Error("DocError Forbidden/NotFound: "+g.safeStringify(e)));var resetData=function(){d.clearData(function(){g.reload()})};g.menus.alert(e.type===gapi.drive.realtime.ErrorType.FORBIDDEN?{text:"Moo.do has lost access to your document. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",action:resetData}:e.type===gapi.drive.realtime.ErrorType.NOT_FOUND?{text:"Moo.do cannot find your document. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",action:resetData}:{text:"An unknown error has occurred. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",action:g.reload});break;case gapi.drive.realtime.ErrorType.SERVER_ERROR:ShouldLog(LogLevels.Error)&&log("Received server error: "+g.safeStringify(e)),e.isFatal&&g.vmMain.setGDriveStatus(DriveStatus.Offline);break;default:ShouldLog(LogLevels.Error)&&log("Unkown Doc Error - "+g.safeStringify(e)),g.reportError(new Error("Unknown Doc Error: "+g.safeStringify(e)))}return e.isFatal}function loadDoc(newDoc){var docId=self.getDocId();if(docId)try{var initFn=newDoc?onFirstDocInitialized:onDocInitialized;gdata.driveRealtimeLoad(docId,onDocLoaded,initFn,onDocLoadError);try{window.__LOAD_REQUESTS.push(g.getCurrentStack("Normal Load ["+newDoc+"]"))}catch(err){g.reportError(err)}}catch(err){self.recoverFromError(err)}else findAndLoadDoc()}function findAndLoadDoc(){openDefaultRealtimeFile(function(docInfo,newDoc){docInfo&&docInfo.id?(self.setDocInfo(docInfo.id,docInfo.title),loadDoc(newDoc)):g.reportError(new Error("We should always find a valid document with a defined id")),newDoc&&g.fireCustomEvent("firstRun")})}function saveAuthorizedScopes(){for(var scopeArr=[],i=0;i<authorizedScopes.length;++i){var scopeIndex=self.scopes.indexOf(authorizedScopes[i]),forceNoSave=noSaveScopes.indexOf(authorizedScopes[i])>=0;scopeIndex>=0&&!forceNoSave&&scopeArr.push(scopeIndex)}var saveString=JSON.stringify(scopeArr);g.settings.set(Settings.authScopes,saveString)}function handleContactsLoaded(numContacts){numContacts>0&&g.vmMain.runParseWorkerNewContacts()}function getAccessTokenInternal(){var token;if(!window.gapi||!window.gapi.auth)return void 0;try{var gapiToken=gapi.auth.getToken();gapiToken&&(token=gapiToken.access_token)}catch(err){self.recoverFromError(err)}return token}function setExternalAccessTokenInternal(){try{g.PAssert(2056,void 0!==externalToken,"Should always have a valid token value")}catch(PERR){g.reportError(PERR)}gapi.auth.setToken(externalToken)}function lockOAuthScheme(){isOAuthSchemeLocked=!0,g.settings.set(Settings.oauthScheme,currentOAuthSchemeType)}function getBestOAuthScheme(){for(var i=OAuthSchemeType.Count;i>=0;i--)if(availableOAuthSchemes[i])return i}function tokenRequestFilter(authFn){return function(config,cb){authFn(config,function(token){token&&!token.error&&lockOAuthScheme(),cb(token)})}}function setupOAuthScheme(){try{g.PAssert(2060,!isOAuthSchemeLocked,"Should not be setting up OAuth if locked into the current scheme")}catch(PERR){g.reportError(PERR)}if(!isOAuthSchemeLocked){var scheme=getBestOAuthScheme();if(scheme!==currentOAuthSchemeType)switch(currentOAuthSchemeType=scheme,scheme){case OAuthSchemeType.None:OAuthScheme={authorize:tokenRequestFilter(self.requestNoneOAuth)};break;case OAuthSchemeType.Web:try{g.PAssert(2061,self.isAuthAPILoaded(),"GAPI Auth should always be valid at this point")}catch(PERR){g.reportError(PERR)}OAuthScheme={authorize:tokenRequestFilter(gapi.auth.authorize)};break;case OAuthSchemeType.Native:OAuthScheme={authorize:tokenRequestFilter(self.requestNativeOAuth)};break;default:try{g.PAssert(2062,!1,"Invalid OAuth scheme type")}catch(PERR){g.reportError(PERR)}}}}function frameIdx(frame){return parseInt(frame.id.split("_")[1])}function handleAuthorization(token,callback){if(token&&!token.error){try{g.PAssert(2064,token.scope,"Scopes must be valid")}catch(PERR){g.reportError(PERR)}g.isString(token.scope)&&(token.scope=token.scope.split(" ")),self.getActiveUser();var oldAuthorizedScopes=authorizedScopes,newAuthorizedScopes=ko.utils.arrayGetDistinctValues(token.scope);authorizedScopes=newAuthorizedScopes,oldAuthorizedScopes.equals(newAuthorizedScopes)||saveAuthorizedScopes();var expireMS=1e3*(parseInt(token.expires_in)-600);log("Token expires in",expireMS/1e3),authorizedUntil=Date.now()+expireMS,clearTimeout(refreshAuthorizationTimer),refreshAuthorizationTimer=setTimeout(function(){refreshAuthorization()},expireMS),lastRefreshWait=DEFAULT_REFRESH_WAIT,gdata.poke(),g.vmMain&&(g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GoogleLogin,authorizedScopes),g.vmMain.docManager.notifyGoogleAuthorization(authorizedScopes)),setTimeout(function(){for(var iframes=document.getElementsByTagName("iframe"),i=0;i<iframes.length;++i)if(iframes[i].src.startsWith("https://accounts.google.com/o/oauth2/auth?"))if(""===iframes[i].id)iframes[i].id="auth_"+authIndex++;else{var idx=frameIdx(iframes[i]);idx!==authIndex&&idx!==authIndex-1&&iframes[i].parentElement.removeChild(iframes[i])}},0)}else log("Error authorizing token: "+(token?token.error:"UNDEFINED"));callback&&callback(token)}function refreshAuthorization(cb){if(!OAuthScheme||!OAuthScheme.authorize)return cb(void 0),!1;try{g.PAssert(2066,!refreshingAuth,"Should not request an authorization refresh while already refreshing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2067,authorizedScopes.length>=self.requiredScopes.length,"We lost some required scopes somewhere...")}catch(PERR){g.reportError(PERR)}refreshingAuth=!0;var tokenString,currentToken,userId=self.getCurrentUserEmail()||g.settings.get(Settings.activeUser),config={client_id:self.CLIENT_ID,scope:authorizedScopes,immediate:!0,login_hint:userId,authuser:-1};return OAuthScheme.authorize(config,function(token){tokenRefreshed=!0,refreshingAuth=!1,handleAuthorization(token,cb)}),!0}function tryToLoadGapi(){if(self.isRealtimeAPILoaded())isLoadingScript=!1;else{var oldScript=document.getElementById("gapiScript");oldScript&&oldScript.parentNode.removeChild(oldScript),g.addScript("https://apis.google.com/js/client.js?onload=GoogleApiLoaded","gapiScript",function(){isLoadingScript=!1}),numTriesLoad-->0?setTimeout(tryToLoadGapi,RELOAD_TIMEOUT):isLoadingScript=!1}}function tryToRefreshToken(cb){tokenRefreshed?(g.vmMain.setGDriveStatus(DriveStatus.Saved),g.messageQueue.clearMessage(MessageID.ConnectionError),cb&&cb()):(refreshAuthorization(),setTimeout(function(){tryToRefreshToken(cb)},RELOAD_TIMEOUT))}var self={CLIENT_ID:"597847337936.apps.googleusercontent.com",eventSubscribers:[],authenticatedUserInfo:ko.observable()};g.goog=self;var DEFAULT_REFRESH_WAIT=1e4,MAX_REFRESH_WAIT=16e4;self.APP_ID="597847337936",self.REALTIME_MIMETYPE="application/vnd.google-apps.drive-sdk",self.FOLDER_MIMETYPE="application/vnd.google-apps.folder",window.GScope={Calendar:"https://www.googleapis.com/auth/calendar",CalendarRO:"https://www.googleapis.com/auth/calendar.readonly",Contacts:"https://www.googleapis.com/auth/contacts.readonly",Drive:"https://www.googleapis.com/auth/drive.file",UserInfoEmail:"https://www.googleapis.com/auth/userinfo.email",DriveFull:"https://www.googleapis.com/auth/drive",TasksRO:"https://www.googleapis.com/auth/tasks.readonly",UserInfoProfile:"https://www.googleapis.com/auth/userinfo.profile",DriveInstall:"https://www.googleapis.com/auth/drive.install",DriveAppData:"https://www.googleapis.com/auth/drive.appdata",DriveMetadataRO:"https://www.googleapis.com/auth/drive.readonly.metadata",GmailRO:"https://www.googleapis.com/auth/gmail.readonly",GmailCompose:"https://www.googleapis.com/auth/gmail.compose"};var noSaveScopes=[GScope.TasksRO];self.LEGACY_DefaultDriveDocTitle="DuchessBeta",self.DefaultDocTitle="Moo.do Personal Document",self.DefaultFolderTitle="__MOODO__",self.DefaultProperty="MooDoDefault",self.DefaultPropertyValue="TRUE",self.DefaultRootFolderProperty="MooDoDefaultRoot",self.DefaultRootFolderPropertyValue="TRUE",self.DocFolderTitlePrefix="Moodo_",self.DocFolderProperty="MooDoFolder",self.DocFolderPropertyPrefix="MDSF_",self.requiredScopes=[GScope.Drive,GScope.UserInfoEmail,GScope.DriveInstall,GScope.DriveAppData],self.requestScopes=[],self.scopes=[GScope.Calendar,GScope.CalendarRO,GScope.Contacts,GScope.Drive,GScope.UserInfoEmail,GScope.DriveFull,GScope.UserInfoProfile,GScope.DriveInstall,GScope.DriveAppData,GScope.DriveMetadataRO,GScope.GmailRO];var authorizedScopes=[];self.getAuthorizedScopes=function getAuthorizedScopesFn(){return authorizedScopes};var docFields="items(id,title,properties)";self.isLoaded=!1,self.init=function initFn(){self.isAuthAPILoaded()?self.addOAuthMethod(OAuthSchemeType.Web):window.addEventListener("gapiLoaded",function(){self.addOAuthMethod(OAuthSchemeType.Web)});var lastOAuthScheme=g.settings.get(Settings.oauthScheme);if(void 0!==lastOAuthScheme&&lastOAuthScheme!=OAuthSchemeType.Web)try{var scheme=parseInt(lastOAuthScheme);self.addOAuthMethod(scheme)}catch(err){g.reportError(err)}setupOAuthScheme();var savedScopesString=g.settings.get(Settings.authScopes);if(savedScopesString){var savedScopes;try{savedScopes=JSON.parse(savedScopesString)}catch(err){g.reportError(err)}if(savedScopes){for(var i=0;i<savedScopes.length;++i){try{g.PAssert(2015,savedScopes[i]>=0,"Each saved scope should be a valid array index")}catch(PERR){g.reportError(PERR)}savedScopes[i]>=0&&self.requestScopes.push(self.scopes[savedScopes[i]])}self.requestScopes=ko.utils.arrayGetDistinctValues(self.requestScopes)}}else self.requestScopes=self.requiredScopes;authorizedScopes=self.requestScopes,platform.syncContacts&&util.getURLParam("access_token")&&!util.hasURLParam("error")&&(authorizedScopes.indexOf(GScope.Contacts)<0&&(authorizedScopes.push(GScope.Contacts),saveAuthorizedScopes()),g.settings.set(Settings.syncContacts,!0)),g.settings.registerForChangeNotification(Settings.syncContacts,function(oldValue,newValue){newValue&&self.authAndLoadContacts()});try{g.PAssert(2016,void 0===self.authenticatedUserInfo(),"We should not have user info when initing goog")}catch(PERR){g.reportError(PERR)}var authGASub=self.authenticatedUserInfo.subscribe(function(newValue){void 0!==newValue&&(window.ga&&ga("set","&uid",g.getAnonUserIdentifier()),authGASub.dispose(),authGASub=void 0)})},self.ensureRequiredScopesAreRequested=function ensureRequiredScopesAreRequestedFn(){for(var needsAdditionalScopes=!1,i=0;i<self.requiredScopes.length;++i)if(authorizedScopes.indexOf(self.requiredScopes[i])<0){needsAdditionalScopes=!0;break}needsAdditionalScopes&&self.runAuthenticate(self.requiredScopes,!0,!1,function(token){!token||token.error?g.messageQueue.pushMessage({text:"We need additional permissions to give you the best experience.",actionText:"AUTHORIZE",action:function actionFn(){self.runAuthenticate(self.requiredScopes,!1,!1,function(token2){(!token2||token2.error)&&g.messageQueue.pushMessage({text:"There was an error authenticating. Please try again.",actionText:"AUTHORIZE",action:self.ensureRequiredScopesAreRequested})})}}):saveAuthorizedScopes()})},self.onHaveUserSignupData=function onHaveUserSignupDataFn(cb){if(self.authenticatedUserInfo())setTimeout(cb,0);else var infoSub=self.authenticatedUserInfo.subscribe(function(){infoSub.dispose(),infoSub=void 0,setTimeout(cb,0)})},self.getCurrentUserFirstName=function getCurrentUserFirstNameFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().given_name:void 0},self.getCurrentUserLastName=function getCurrentUserLastNameFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().family_name:void 0},self.getCurrentUserEmail=function getCurrentUserEmailFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().email:void 0},self.getCurrentUserSignupInfo=function getCurrentUserSignupInfoFn(){var signupInfo={full:self.authenticatedUserInfo(),fname:self.getCurrentUserFirstName(),lname:self.getCurrentUserLastName()};return signupInfo},self.getUserName=function getUserNameFn(info){try{info.fname=self.getCurrentUserFirstName(),info.lname=self.getCurrentUserLastName()}catch(err){info.nameError=!0}};var watchdogWait=96e4,watchdogInterval;self.startWatchdog=function startWatchdogFn(){watchdogInterval||(watchdogInterval=setInterval(self.watchdogFn,watchdogWait))},self.stopWatchdog=function stopWatchdogFn(){clearInterval(watchdogInterval),watchdogInterval=void 0};var lastWatchdogTime=0;self.watchdogFn=function watchdogFnFn(){var currentTime=Date.now();if(lastWatchdogTime-currentTime>=watchdogWait){try{var token=gapi.auth.getToken();if(token){var expireTime=1e3*parseInt(token.expires_at);currentTime>expireTime?(ShouldLog(LogLevels.Error)&&log("Active token is no longer valid: "+currentTime+" vs. "+expireTime),refreshAuthorization(),g.reportError(new Error("Watchdog found expired token on client"))):gdata.poke()}else ShouldLog(LogLevels.Error)&&log("No active token on client!"),refreshAuthorization(),g.reportError(new Error("Watchdog found client with no token set"))}catch(err){g.reportError(err)}finally{lastWatchdogTime=currentTime}g.checkForRemoteChanges()}},self.hasPermission=function hasPermissionFn(scope){return authorizedScopes.indexOf(scope)>-1};var refreshAuthorizationTimer,authorizedUntil,refreshingAuth=!0;self.onFocusHandler=function onFocusHandlerFn(){authorizedUntil&&Date.now()>authorizedUntil&&!refreshingAuth&&refreshAuthorization()},self.onBlurHandler=function onBlurHandlerFn(){refreshAuthorizationTimer&&clearTimeout(refreshAuthorizationTimer)},self.getContactInfo=function getContactInfoFn(name,callback){function handleResponse(xhr){if(200!==xhr.status)callback();else{var obj=JSON.parse(xhr.responseText);try{g.settings.set(Settings.lastContactSync,new Date(obj.feed.updated.$t))}catch(err){g.reportError(err)}callback(obj)}}var accessToken=getAccessTokenInternal();if(!accessToken)return void callback(void 0);var lastSync,url="https://www.google.com/m8/feeds/contacts/default/full?v=3.0&alt=json";name?url+='&q="'+name+'"':lastSync=g.settings.get(Settings.lastContactSync);var forceLoad=d.areLocalContactsLoaded()&&0===d.contactManager.numContacts();if(lastSync&&!forceLoad){var syncDate=new Date(lastSync);url+="&updated-min="+syncDate.toString("yyyy-MM-ddTHH:mm:ss")}url+="&max-results=10000",url+="&access_token="+accessToken,g.XHR({type:"GET",url:url,cb:handleResponse})},self.loadedContacts=!1,self.loadContacts=function loadContactsFn(callback){if(!self.loadedContacts){self.loadedContacts=!0,d.loadLocalContacts();var loadedContacts=d.contactManager.numContacts();self.getContactInfo(void 0,function(data){if(!data)return void callback(-1);log("Loading Remote Contacts!",parseInt(data.feed.openSearch$totalResults.$t));var contactCount=0;if(data&&data.feed&&data.feed.entry&&data.feed.entry.length){contactCount=data.feed.entry.length;for(var entries=data.feed.entry,i=0;i<entries.length;i++){var entry=entries[i],contact={id:/\/([^\s\/]+$)/gi.exec(entry.id.$t)[1],text:""};if(entry.gd$name&&entry.gd$name.gd$fullName){var text=entry.gd$name.gd$fullName.$t;contact.text=text,"'"===contact.text[0]&&(contact.text=contact.text.substr(1))}if(entry.gd$email){var emails=entry.gd$email;contact.emails=emails;for(var u=0;u<emails.length;u++)delete contact.emails[u].rel,!contact.text&&contact.emails[u].primary&&(contact.text=contact.emails[u].address);!contact.text&&emails.length>0&&(contact.text=contact.emails[0].address)}if(entry.gd$phoneNumber){var phoneNumbers=entry.gd$phoneNumber;contact.phoneNumbers=[];for(var u=0;u<phoneNumbers.length;u++){var phoneNumber={number:phoneNumbers[u].$t};phoneNumber.type=phoneNumbers[u].rel?phoneNumbers[u].rel.replace("http://schemas.google.com/g/2005#",""):phoneNumbers[u].label,contact.phoneNumbers.push(phoneNumber)}}contact.text&&(0===loadedContacts?d.contactManager.addContact(contact):d.contactManager.updateContact(contact))}}contactCount>0&&d.saveContacts(),callback&&callback(contactCount)})}},self.setDocInfo=function setDocInfoFn(id,title){g.settings.set(Settings.gdocId,id),g.settings.set(Settings.gdocTitle,title)},self.getDocId=function getDocIdFn(){return g.settings.get(Settings.gdocId)},self.clearDocInfo=function clearDocInfoFn(){g.settings.reset(Settings.gdocId),g.settings.reset(Settings.gdocTitle)};var rootFolderID=void 0,docFolderID=void 0;self.getDocumentFolder=getDocumentFolder,self.createAndSetupDocument=function createAndSetupDocumentFn(isDefault,cb){try{g.PAssert(2041,cb,"Must pass in a valid creation callback")}catch(PERR){g.reportError(PERR)}gapi.client.load("drive","v2",function(){var props;isDefault&&(props=[{key:self.DefaultProperty,value:self.DefaultPropertyValue,visibility:"PRIVATE"}]),gapi.client.drive.files.insert({resource:{mimeType:self.REALTIME_MIMETYPE,title:self.DefaultDocTitle,writersCanShare:!1,properties:props}}).execute(function(docInfo){return 200!==docInfo.code&&docInfo.error?cb(docInfo):void createDocumentFileStructure(docInfo.id,function(folderInfo){return cb(docInfo)})})})};var useCustomEmail=!0;self.listPermissions=function listPermissionsFn(docID,cb){gapi.client.drive.permissions.list({fileId:docID}).execute(cb)},self.givePermission=function givePermissionFn(docID,emailAddr,sendMail,cb){try{g.PAssert(2042,docID,"Must specify a valid document ID to operate on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2043,emailAddr,"Must specify a valid emailAddr to add")}catch(PERR){g.reportError(PERR)}var body={value:emailAddr,type:"user",role:"writer",withLink:!1};if(useCustomEmail){var docURL="http://www.moo.do/app/#login=true&file="+docID;gapi.client.drive.permissions.insert({fileId:docID,sendNotificationEmails:!1,resource:body}).execute(function(response){return g.XHR_PrivateAPI({type:"POST",path:"/sharing/shareDoc",data:{fromUser:g.getUserIdentifier(),toEmail:emailAddr,docURL:docURL},requireAuth:!0,cb:function cbFn(xhr){200!==xhr.status}}),cb(response)})}else{var message="Come collaborate with me at Moo.do!\r\nhttp://www.moo.do/app/#login=true&file="+docID;gapi.client.drive.permissions.insert({fileId:docID,emailMessage:message,resource:body}).execute(cb)}getDocumentFolder(docID,function(folderID){gapi.client.drive.permissions.insert({fileId:folderID,sendNotificationEmails:!1,resource:body}).execute(function(response){})})},self.removePermission=function removePermissionFn(docID,permissionID,cb){try{g.PAssert(2044,docID,"Must specify a valid document ID to operate on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2045,emailAddr,"Must specify a valid emailAddr to remove")}catch(PERR){g.reportError(PERR)}gapi.client.drive.permissions.delete({fileId:docID,permissionId:permission.id}).execute(cb)},self.getShareFolder=function getShareFolderFn(cb){getDocumentFolder(self.getDocId(),cb)},self.shareFile=function shareFileFn(fileID,cb){try{g.PAssert(2046,fileID,"Must specify a valid fileID to share")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2047,cb,"Must specify a valid callback for sharing")}catch(PERR){g.reportError(PERR)}getDocumentFolder(self.getDocId(),function(folderID){var body={id:folderID};gapi.client.drive.parents.insert({fileId:fileID,resource:body}).execute(function(result){var success;success=200!==result.code&&result.error?!1:!0,cb(success)})})},self.unshareFile=function unshareFileFn(fileID,cb){try{g.PAssert(2048,fileID,"Must specify a valid fileID to unshare")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2049,cb,"Must specify a valid callback for unsharing")}catch(PERR){g.reportError(PERR)}getDocumentFolder(self.getDocId(),function(folderID){gapi.client.drive.parents.delete({parentId:folderID,fileId:fileID}).execute(function(result){var success;success=200!==result.code&&result.error?!1:!0,cb(success)})})};var lastRefreshWait=DEFAULT_REFRESH_WAIT;self.recoverFromError=function recoverFromErrorFn(err){err&&(ShouldLog(LogLevels.Error)&&log("GDrive Error: ",err),g.reportError(err)),g.vmMain.setGDriveStatus(DriveStatus.Connecting),refreshAuthorization(function(token){if(!token||token.error){g.messageQueue.pushMessage(MessageID.ConnectionError),g.vmMain.setGDriveStatus(DriveStatus.Offline);var errorMessage="Unable to refresh authentication token - ",sendReport=!0;token?(errorMessage+=token.error,"immediate_failed"===token.error&&(sendReport=!1)):errorMessage+="No Token",sendReport?g.reportError(new Error(errorMessage)):ShouldLog(LogLevels.Error)&&log("Refresh Auth Failed: ",errorMessage),MAX_REFRESH_WAIT>lastRefreshWait&&(setTimeout(self.recoverFromError,lastRefreshWait),lastRefreshWait*=2)}})};var activeUserRequestQueue=[],activeUserRequested=!1;self.getActiveUser=function getActiveUserFn(cb){if(self.getAccessToken(!0))if(self.getCurrentUserEmail()){try{g.PAssert(2052,0===activeUserRequestQueue.length,"If we have the current user data, the request queue should be empty")}catch(PERR){g.reportError(PERR)}cb&&cb(self.getCurrentUserEmail())}else cb&&activeUserRequestQueue.push(cb),activeUserRequested||(activeUserRequested=!0,g.XHR({type:"GET",url:"https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token="+self.getAccessToken(!0),autoRetry:!0,cb:function cbFn(xhr){if(activeUserRequested=!1,200===xhr.status){var userInfoParsed={};try{userInfoParsed=JSON.parse(xhr.responseText)}catch(err){g.reportError(new Error("Error parsing user info"),xhr.responseText)}self.authenticatedUserInfo(userInfoParsed);for(var i=0;i<activeUserRequestQueue.length;++i)activeUserRequestQueue[i](self.getCurrentUserEmail());activeUserRequestQueue=[]}}}));else cb&&activeUserRequestQueue.push(cb)};var loadedClientDefaultFile=!1;self.loadClientDefaultFile=function loadClientDefaultFileFn(){var mainLoaded=!!g.vmMain,driveLoaded=!!window.gapi&&!!window.gapi.drive&&!!window.gapi.drive.realtime;if(!loadedClientDefaultFile&&mainLoaded&&driveLoaded){var token=getAccessTokenInternal();if(token&&g.getLoginState()==LoginState.LOGGED_IN)return g.checkpoint(Checkpoint.LoadDefaultFile),loadedClientDefaultFile=!0,g.vmMain.setGDriveStatus(DriveStatus.Connecting),self.getActiveUser(function(newUser){try{g.PAssert(2053,newUser,"The authenticated user should always be valid",newUser,g.settings.get(Settings.activeUser))}catch(PERR){g.reportError(PERR)}var prevUser=g.settings.get(Settings.activeUser);prevUser&&newUser&&newUser!==prevUser?d.clearData(function(){g.reload()}):!prevUser&&newUser&&g.settings.set(Settings.activeUser,newUser)}),loadDoc(),self.loadCalendarAndContacts(),!0}return!1},self.reconnectToActiveDocument=function reconnectToActiveDocumentFn(){var mainLoaded=!!g.vmMain,driveLoaded=!!window.gapi&&!!window.gapi.drive&&!!window.gapi.drive.realtime,isLoggedIn=g.getLoginState()==LoginState.LOGGED_IN,token=getAccessTokenInternal();try{g.PAssert(2054,!gdata.isConnected(),"Should not try to reconnect if gdata is still connected")}catch(PERR){g.reportError(PERR)}mainLoaded&&driveLoaded&&isLoggedIn&&token&&!gdata.isConnected()&&!g.vmMain.isReconnecting()&&(g.vmMain.setGDriveStatus(DriveStatus.Reconnecting),g.isReconnected=!0,loadDoc())},self.authAndLoadContacts=function authAndLoadContactsFn(cb){g.settings.get(Settings.syncContacts)&&(authorizedScopes.indexOf(GScope.Contacts)<0?self.runAuthenticate([GScope.Contacts],!0,!0,function(token){!token||token.error?(authorizedScopes.push(GScope.Contacts),saveAuthorizedScopes(),g.messageQueue.pushMessage({text:"Contact sync is enabled but permissions have been lost. Please enable contact sync again.",action:self.authAndLoadContacts,actionText:"ENABLE",hold:!0}),cb&&cb(!1)):self.loadContacts(function(numContacts){handleContactsLoaded(numContacts),cb&&numContacts>0&&cb(!0)})}):self.loadContacts(function(numContacts){handleContactsLoaded(numContacts),cb&&numContacts>0&&cb(!0)}))},self.authDocSharing=function authDocSharingFn(){},self.loadCalendarAndContacts=function loadCalendarAndContactsFn(){window.gapi&&self.authAndLoadContacts()},window.__LOAD_HANDLES=g.createRingBuffer(5),window.__LOAD_REQUESTS=g.createRingBuffer(5),self.checkTokenInHash=function checkTokenInHashFn(){var setToken=!1;if(util.hasURLParam("access_token"))try{var scopeString=util.getURLParam("scope"),scopes;scopeString&&(scopes=scopeString.split("+"));var token={access_token:util.getURLParam("access_token"),expires_in:util.getURLParam("expires_in"),scope:scopes};gapi.auth.setToken(token),setToken=!0,util.removeURLParam("access_token",!0),util.removeURLParam("expires_in",!0),util.removeURLParam("scope",!0),util.removeURLParam("token_type",!0),util.hasURLParam("login")||util.insertURLParam("login",!0,!0)}catch(err){g.reportError(err)}return setToken},self.getAccessToken=function getAccessTokenFn(peekOnly){var token=getAccessTokenInternal();return token||peekOnly||self.recoverFromError(),token};var externalToken;self.setExternalAccessToken=function setExternalAccessTokenFn(token){externalToken=token,self.isAuthAPILoaded()?setExternalAccessTokenInternal():window.addEventListener("gapiLoaded",setExternalAccessTokenInternal)};var nativeOAuthCount=0,nativeOAuthRequests={};self.requestNativeOAuth=function requestNativeOAuthFn(config,cb){try{g.PAssert(2057,config,"Must supply valid OAuth config")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2058,cb,"Must specify a callback function for OAuth respose")}catch(PERR){g.reportError(PERR)}var requestId=++nativeOAuthCount,nativeData={id:requestId,scope:config.scope,immediate:config.immediate},wasSent=g.nativeBridge.sendToApp("getOAuth",nativeData);nativeOAuthRequests[requestId]=cb},self.handleNativeOAuthResponse=function handleNativeOAuthResponseFn(data){var requestCallback=nativeOAuthRequests[data.id];if(requestCallback)nativeOAuthRequests[data.id]=void 0,data.success?(self.setExternalAccessToken(data.token),requestCallback(data.token)):requestCallback(void 0);else try{g.PAssert(2059,!1,"OAuth callback without a valid handler")}catch(PERR){g.reportError(PERR)}};var noneOAuthRequests=[];self.requestNoneOAuth=function requestNoneOAuthFn(config,cb){noneOAuthRequests.push({config:config,cb:cb})};var isOAuthSchemeLocked=!1,availableOAuthSchemes=[];availableOAuthSchemes[OAuthSchemeType.None]=!0;var currentOAuthSchemeType=-1,OAuthScheme;self.addOAuthMethod=function addOAuthMethodFn(method){availableOAuthSchemes[method]||(availableOAuthSchemes[method]=!0,isOAuthSchemeLocked||setupOAuthScheme())},self.runAuthenticate=function runAuthenticateFn(requestScopes,runImmediate,retry,callback){if(!self.isAuthAPILoaded())return callback&&callback(),!1;var userId=self.getCurrentUserEmail()||g.settings.get(Settings.activeUser)||void 0;try{g.PAssert(2063,userId===util.getURLParam("user")||!util.getURLParam("user"),"Do not try to login a user that is not valid")}catch(PERR){g.reportError(PERR)}if(runImmediate&&!userId&&!util.hasURLParam("login",!0))return callback&&callback(),!1;var currentToken;try{currentToken=gapi.auth.getToken()}catch(err){g.reportError(err)}var requiredScopesToRequest;if(currentToken){if(requiredScopesToRequest=currentToken.scope,!g.isArray(requiredScopesToRequest)&&g.isString(requiredScopesToRequest))try{requiredScopesToRequest=currentToken.scope.split(" ")}catch(err){g.reportError(err)}var numScopesAdded=0;if(currentToken.scope)for(var i=0;i<requestScopes.length;++i)currentToken.scope.indexOf(requestScopes[i])<0&&(requiredScopesToRequest.push(requestScopes[i]),numScopesAdded++);else requiredScopesToRequest=requestScopes,numScopesAdded=requestScopes.length;0===numScopesAdded&&(requiredScopesToRequest=[])}else requiredScopesToRequest=requestScopes;if(requiredScopesToRequest.length>0){requiredScopesToRequest.indexOf(GScope.DriveFull)>=0&&requiredScopesToRequest.remove(GScope.Drive);var config={client_id:self.CLIENT_ID,scope:requiredScopesToRequest,immediate:runImmediate,login_hint:userId,authuser:-1};platform.requireCustomRedirect&&!runImmediate&&(config.redirect_uri=platform.customRedirectString,platform.customRedirectState&&(requiredScopesToRequest.indexOf(GScope.Contacts)>=0&&(platform.customRedirectState.syncContacts=!0),config.state=JSON.stringify(platform.customRedirectState))),refreshingAuth=!0;var tokenString;OAuthScheme.authorize(config,function(token){refreshingAuth=!1,(!token||token.error)&&runImmediate&&retry?self.runAuthenticate(requiredScopesToRequest,!1,!1,callback):(token&&!token.error&&(platform.app||util.hasURLParam("login","true"))&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),self.loadClientDefaultFile()),handleAuthorization(token,callback))})}else ShouldLog(LogLevels.Error)&&log("Authorization request with no scopes: ",requiredScopesToRequest),callback&&callback(currentToken);return!0};var authIndex=0,tokenRefreshed=!1;self.isAuthAPILoaded=function isAuthAPILoadedFn(){return!!(window.gapi&&window.gapi.auth&&window.gapi.auth.authorize)},self.isDriveAPILoaded=function isDriveAPILoadedFn(){return!!(window.gapi&&window.gapi.client&&window.gapi.client.drive)},self.isRealtimeAPILoaded=function isRealtimeAPILoadedFn(){return!!(window.gapi&&window.gapi.client&&window.gapi.drive&&window.gapi.drive.realtime)
};var RELOAD_TIMEOUT=1e4,numTriesLoad=0,isLoadingScript=!1;return self.goOnline=function goOnlineFn(cb){return numTriesLoad=2,self.isRealtimeAPILoaded()?(tokenRefreshed=!1,setTimeout(function(){tryToRefreshToken(cb)},2e3),!0):(isLoadingScript||(isLoadingScript=!0,setTimeout(tryToLoadGapi,2e3)),!1)},self.ensureDocConnection=function ensureDocConnectionFn(){self.isRealtimeAPILoaded()?tryToRefreshToken(function(){loadedClientDefaultFile?gdata.isConnected()||self.reconnectToActiveDocument():self.loadClientDefaultFile()}):self.goOnline()},self.init(),self}),define("tracker",["globals","platform","data","gdata"],function(g,platform,d,gdata){function getNextGroupID(){return self.groupID+1}function useNextGroupID(){return++self.groupID}function getCurrentGroup(){return self.groups[self.cursor]}function getCurrentAction(){return self.groups[self.cursor].events[self.groups[self.cursor].events.length-1]}function handleGroupTrimmed(group){for(var i=0;i<group.events.length;++i){var action=group.events[i];switch(action.type){case TrackerType.Insert:break;case TrackerType.Remove:break;case TrackerType.Create:break;case TrackerType.Delete:break;case TrackerType.Move:break;case TrackerType.Update:break;case TrackerType.Format:break;case TrackerType.Zoom:break;case TrackerType.UIAction:break;default:try{g.PAssert(2068,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}}}function pushGroup(){var id=useNextGroupID();return self.groups.push({id:id,events:[],persisted:!1}),self.cursor<MaxGroups-1&&self.cursor++,self.groups.length>MaxGroups&&handleGroupTrimmed(self.groups.shift()),id}function doAction(type,data){var group=getCurrentGroup();try{g.PAssert(2069,group,"Expected group to exist")}catch(PERR){g.reportError(PERR)}var action={type:type,data:data};switch(type){case TrackerType.Insert:action.cb={undo:undoInsert,redo:redoInsert};break;case TrackerType.Remove:action.cb={undo:undoRemove,redo:redoRemove};break;case TrackerType.Create:action.cb={undo:undoCreate,redo:redoCreate};break;case TrackerType.Delete:action.cb={undo:undoDelete,redo:redoDelete};break;case TrackerType.Move:action.cb={undo:undoMove,redo:redoMove};break;case TrackerType.Update:action.cb={undo:undoUpdate,redo:redoUpdate};break;case TrackerType.Format:action.cb={undo:undoFormat,redo:redoFormat};break;case TrackerType.Zoom:action.cb={undo:undoZoom,redo:redoZoom};break;case TrackerType.UIAction:action.cb={undo:undoUIAction,redo:redoUIAction};break;default:try{g.PAssert(2070,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}group.events.push(action)}function doExternalAction(type,data){}function mergeAction(type,data){log("Tracker Action Merged: ",type,data);var action=getCurrentAction();try{g.PAssert(2071,action,"Expected action to exist")}catch(PERR){g.reportError(PERR)}switch(type){case TrackerType.Insert:break;case TrackerType.Remove:break;case TrackerType.Create:break;case TrackerType.Delete:break;case TrackerType.Move:break;case TrackerType.Update:break;case TrackerType.Format:try{g.PAssert(2072,!1,"Formats cannot be merged")}catch(PERR){g.reportError(PERR)}break;case TrackerType.Zoom:try{g.PAssert(2073,!1,"Zooms cannot be merged")}catch(PERR){g.reportError(PERR)}break;case TrackerType.UIAction:try{g.PAssert(2074,!1,"UIActions cannot be merged")}catch(PERR){g.reportError(PERR)}break;default:try{g.PAssert(2075,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}}function canMerge(type){var shouldMerge=!1,group=getCurrentGroup();return group&&group.events.length>0&&(group.events[group.events.length-1].type===type?type===TrackerType.Insert&&(shouldMerge=!0):shouldMerge=!1),shouldMerge}function canCombine(type,groupID){var group=getCurrentGroup();return group&&(group.id===groupID||0===group.events.length)}function undoInsert(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(2076,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),startIndex=0;"﻿"==oldText[0]&&(startIndex=1);var newText=oldText.slice(startIndex,entry.position)+oldText.slice(entry.position+entry.text.length);model.setText(newText,!0,ChangeType.Local),g.selectChildren(model,entry.position,0)}}function redoInsert(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(2077,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),newText=oldText.slice(0,entry.position)+entry.text+oldText.slice(entry.position);0===newText.length&&(newText="﻿"),model.setText(newText,!0,ChangeType.Local),g.selectChildren(model,entry.position,entry.text.length)}}function undoRemove(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(2078,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),startIndex=0;"﻿"==oldText[0]&&(startIndex=1);var newText=oldText.slice(startIndex,entry.position)+entry.text+oldText.slice(entry.position);model.setText(newText,!0,ChangeType.Local),g.selectChildren(model,entry.position,entry.text.length)}}function redoRemove(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(2079,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),newText=oldText.slice(0,entry.position)+oldText.slice(entry.position+entry.text.length);0===newText.length&&(newText="﻿"),model.setText(newText,!0,ChangeType.Local),g.selectChildren(model,entry.position,0)}}function undoCreate(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(2080,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var removedChild=parentModel.removeChildAtIndex(entry.position);try{g.PAssert(2081,removedChild.id===entry.itemID,"Expected data to match removed child: ",removedChild,entry)}catch(PERR){g.reportError(PERR)}removedChild.parent(void 0),d.deleteItem(removedChild);var selectionChild=parentModel;entry.position>0&&(selectionChild=parentModel.getChild(entry.position-1)),g.selectChildren(selectionChild,selectionChild.getParsedText().length,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function redoCreate(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(2082,parentModel,"Expected parent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newChild=d.getModel(entry.itemID);try{g.PAssert(2083,newChild,"Expected child model to exist: ",entry)}catch(PERR){g.reportError(PERR)}d.undeleteItem(newChild),parentModel.items.splice(entry.position,0,newChild),newChild.parent(parentModel),g.selectChildren(newChild,0,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function undoDelete(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(2085,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var childModel=d.getModel(entry.itemID);try{g.PAssert(2086,childModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}d.undeleteItem(childModel),parentModel.items.splice(entry.position,0,childModel),childModel.parent(parentModel),g.selectChildren(childModel,0,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function redoDelete(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(2088,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var removedChild=parentModel.removeChildAtIndex(entry.position);try{g.PAssert(2089,removedChild.id===entry.itemID,"Expected data to match removed child: ",removedChild,entry)}catch(PERR){g.reportError(PERR)}removedChild.parent(void 0),d.deleteItem(removedChild);var selectionChild=parentModel;entry.position>0&&(selectionChild=parentModel.getChild(entry.position-1)),g.selectChildren(selectionChild,selectionChild.getParsedText().length,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function undoMove(data){for(var i=0;i<data.length;++i){var entry=data[i],oldParent=d.getModel(entry.oldParent);try{g.PAssert(2090,oldParent,"Expected oldParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newParent=d.getModel(entry.newParent);try{g.PAssert(2091,newParent,"Expected newParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var child=newParent.removeChildAtIndex(entry.newPosition);try{g.PAssert(2092,child.id===entry.itemID,"Expected data to match child: ",child,entry)}catch(PERR){g.reportError(PERR)}child.parent(oldParent),oldParent.items.splice(entry.oldPosition,0,child),g.selectChildren(child,0,0),newParent.save({items:newParent.getItemsArrayForSave()},SaveFlag.None),oldParent.save({items:oldParent.getItemsArrayForSave()},SaveFlag.None)}}function redoMove(data){for(var i=0;i<data.length;++i){var entry=data[i],oldParent=d.getModel(entry.oldParent);try{g.PAssert(2093,oldParent,"Expected oldParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newParent=d.getModel(entry.newParent);try{g.PAssert(2094,newParent,"Expected newParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var child=oldParent.removeChildAtIndex(entry.oldPosition);try{g.PAssert(2095,child.id===entry.itemID)}catch(PERR){g.reportError(PERR)}child.parent(newParent),newParent.items.splice(entry.newPosition,0,child),g.selectChildren(child,0,0),newParent.save({items:newParent.getItemsArrayForSave()},SaveFlag.None),oldParent.save({items:oldParent.getItemsArrayForSave()},SaveFlag.None)}}function undoUpdate(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(2096,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2097,item[entry.field],"Expected field to exist: ",entry)}catch(PERR){g.reportError(PERR)}item[entry.field](entry.oldValue)}}function redoUpdate(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(2098,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2099,item[entry.field],"Expected field to exist: ",entry)}catch(PERR){g.reportError(PERR)}item[entry.field](entry.newValue)}}function undoFormat(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(2100,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}}}function redoFormat(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(2101,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}}}function undoZoom(data){var entry=data[0],oldItem=d.getModel(entry.oldItemID);try{g.PAssert(2102,oldItem,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}if(entry.zoomIn)oldItem.zoomOut(entry.time);else if(entry.zoomOut)oldItem.zoomin({time:entry.time});else try{g.PAssert(2103,!1,"Zoom action must define either zoomIn or zoomOut")}catch(PERR){g.reportError(PERR)}}function redoZoom(data){var entry=data[0],item=d.getModel(entry.itemID);try{g.PAssert(2104,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}if(entry.zoomIn)item.zoomin({time:entry.time});else if(entry.zoomOut)item.zoomOut(entry.time);else try{g.PAssert(2105,!1,"Zoom action must define either zoomIn or zoomOut")}catch(PERR){g.reportError(PERR)}}function undoUIAction(data){var entry=data[0];switch(entry.type){case TrackerUIAction.RemovePane:break;case TrackerUIAction.SwitchPaneMode:break;default:try{g.PAssert(2106,!1,"Invalid UIAction")}catch(PERR){g.reportError(PERR)}}}function redoUIAction(data){}function isActionFromLoad(){return!g.vmMain.isLoaded||g.isLoadingRemote}function processStateChangedSelection(stateChanged){try{g.PAssert(2114,!self.undoRedoActive)}catch(PERR){g.reportError(PERR)}var finalModel=void 0,finalPosition=0,finalLength=0;if(g.isKeyboardOPen||!g.keyboardToolbar){for(var i=0;i<stateChanged.length;++i){var entry=stateChanged[i],data=entry.data,model=d.getModel(data.itemID);try{g.PAssert(2115,model,"Expected model to exist: ",data)}catch(PERR){g.reportError(PERR)}switch(entry.type){case TrackerType.Insert:finalModel=model,finalPosition=data.position,finalLength=data.text.length;break;case TrackerType.Remove:finalModel=model,finalPosition=data.position,finalLength=0;break;case TrackerType.SetText:finalModel=model,finalPosition=data.position,finalLength=0;break;case TrackerType.Create:finalModel=model,finalPosition=0,finalLength=0;break;case TrackerType.Delete:var selectionChild=d.getModel(data.previous);selectionChild&&(finalModel=selectionChild,finalPosition=selectionChild.getParsedText().length,finalLength=0)}}finalModel&&(g.selectChildren(finalModel,finalPosition,finalLength),g.scrollIntoView(finalModel.getSpan(),200))}externalStateChanged=[]}function getOrderedGroups(){return self.groups.slice(self.cursor).concat(self.groups.slice(0,self.cursor))}function updateExternalID(oldID,newID){try{g.PAssert(2121,!1,"This should never be called")}catch(PERR){g.reportError(PERR)}}var self={disabled:!1,allowOfflineUndo:!1,cursor:-1,groupID:0,groups:[],externalUndoRedo:!1,undoRedoActive:!1,canRedo:!1,canUndo:!1};window.TrackerType={Insert:1,Remove:2,SetText:3,Create:4,Delete:5,Move:6,Update:7,Format:8,Zoom:9,UIAction:10,Misc:11,Mobile:12},window.TrackerMisc={ToggleOutline:1,RightClick:2,CloseMessage:3,ChangeDate:4,AddContact:5,DropItem:6,SyncContacts:7,OpenContact:8,SearchChanged:10,ToggleDocumentsMenu:11,AddDocument:12,OpenDocument:13,OpenDocSharing:14,Copy:15,Paste:16,OpenImport:17,OpenExport:18,UndoRedo:19},window.TrackerMiscMobile={OpenKeyboard:1,CloseKeyboard:2,PaneAgenda:3,PaneNormal:4,OpenAutocomplete:5,CloseAutocomplete:6,AtButton:7,OpenMultiselect:8,CloseMultiselect:9},window.TrackerUIAction={AddPane:1,RemovePane:2,SwitchPaneMode:3};var MaxGroups=75,performingActions=!1;self.performActions=function performActionsFn(actions){try{g.PAssert(2107,!self.disabled||g.intro)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2108,!performingActions)}catch(PERR){g.reportError(PERR)}if(performingActions=!0,actions&&actions.length>0){if(!self.disabled){var groupID=void 0;self.cursor!=self.groups.length-1?(self.groups.splice(self.cursor+1,self.groups.length-(self.cursor+1)),groupID=pushGroup()):groupID=getNextGroupID()}for(var i=0;i<actions.length;++i){var action=actions[i];g.intro&&g.intro.onAction(action),self.disabled||(canCombine(action.type,groupID)?canMerge(action.type)?mergeAction(action.type,action.data):doAction(action.type,action.data):(groupID=pushGroup(),doAction(action.type,action.data)))}}performingActions=!1};var currentAction=[],aggregateActions=0;self.beginAction=function beginActionFn(){try{g.PAssert(2109,!performingActions)}catch(PERR){g.reportError(PERR)}if(0===aggregateActions){gdata.beginAction();try{g.PAssert(2110,0===currentAction.length,"Current actions should always be empty when starting a new action")}catch(PERR){g.reportError(PERR)}}aggregateActions++},self.performAction=function performActionFn(type,data){try{g.PAssert(2111,!performingActions)}catch(PERR){g.reportError(PERR)}var isFromLoad=isActionFromLoad();self.disabled?g.intro&&(isFromLoad||self.performActions([{type:type,data:[data]}])):aggregateActions?currentAction.push({type:type,data:[data]}):self.performActions([{type:type,data:[data]}])},self.endAction=function endActionFn(){try{g.PAssert(2112,!performingActions)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2113,0!==aggregateActions,"Must have called beginAction before calling endAction")}catch(PERR){g.reportError(PERR)}1===aggregateActions&&((!self.disabled||g.intro)&&self.performActions(currentAction),currentAction.length=0,gdata.endAction()),aggregateActions=Math.max(0,aggregateActions-1)},self.resetAggregateActionCount=function resetAggregateActionCountFn(){aggregateActions=0};var externalStateChanged=[];return self.notifyStateChangedFromUndoRedo=function notifyStateChangedFromUndoRedoFn(type,data){try{g.PAssert(2116,self.undoRedoActive)}catch(PERR){g.reportError(PERR)}externalStateChanged.push({type:type,data:data})},self.undoAction=function undoActionFn(){g.vmMain.isOnline()||self.allowOfflineUndo||g.messageQueue.pushMessage(MessageID.OfflineUndo),self.undoRedoActive=!0;try{g.PAssert(2117,!performingActions)}catch(PERR){g.reportError(PERR)}if(!self.disabled&&self.allowOfflineUndo){if(self.cursor>=0)for(var group=self.groups[self.cursor--],i=group.events.length-1;i>=0;i--){var action=group.events[i];action.cb.undo(action.data)}}else if(self.canUndo){try{g.PAssert(2118,self.externalUndoRedo)}catch(PERR){g.reportError(PERR)}gdata.undoAction()}self.undoRedoActive=!1,processStateChangedSelection(externalStateChanged),self.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{undo:!0}]})},self.redoAction=function redoActionFn(){g.vmMain.isOnline()||self.allowOfflineUndo||g.messageQueue.pushMessage(MessageID.OfflineUndo),self.undoRedoActive=!0;try{g.PAssert(2119,!performingActions)}catch(PERR){g.reportError(PERR)}if(!self.disabled&&self.allowOfflineUndo){if(self.cursor>=-1&&self.cursor<self.groups.length-1)for(var group=self.groups[++self.cursor],i=0;i<group.events.length;++i){var action=group.events[i];action.cb.redo(action.data)}}else if(self.canRedo){try{g.PAssert(2120,self.externalUndoRedo)}catch(PERR){g.reportError(PERR)}gdata.redoAction()}self.undoRedoActive=!1,processStateChangedSelection(externalStateChanged),self.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{redo:!0}]})},self.miscAction=function miscActionFn(e){if(g.intro)try{g.intro.onAction(e)}catch(err){g.reportError(err)}},self.resetState=function resetStateFn(){performingActions=!1,externalStateChanged=[],currentAction=[],self.undoRedoActive=!1,self.cursor=-1,self.groupID=0,self.groups=[]},self.stringifyGroups=function stringifyGroupsFn(){var groups=getOrderedGroups();return"Tracker: "+groups.length},self.stateChangeForUndoRedo=function stateChangeForUndoRedoFn(event){self.externalUndoRedo=!0,self.disabled=!0,self.canRedo=event.canRedo,self.canUndo=event.canUndo},gdata.registerForUndoRedoStateChange(self),self}),define("android",["ko","globals","platform"],function(ko,g,platform){function forceCapsHelper(){var text=self.getBoxValue(),newText;1===text.length?newText=text.toUpperCase():text.length>1&&(newText=text[0].toUpperCase()+text.substring(1)),self.setBoxValue(newText)}function fixLinePadding(rawText){self.setBoxValue(rawText)}function removeTextSpace(text){var re=new RegExp(padCharacter,"g");return text.replace(re,"")}var self={},paneRoot,paneScroller,paneContent,inputContainer,inputBox,currentVMLI,lastVMLI,_canSetInput=void 0,pasteHappened=!1,forceFirstCaps=!0,isStarred=!1,linePadding=2,padCharacter="​",activeKeyboard,customKeyboard,edit,tracker,copypaste,enabled=!1;self.isEnabled=function isEnabledFn(){return enabled},self.getCurrentVMLI=function getCurrentVMLIFn(){return currentVMLI},self.isCurrentVMLI=function isCurrentVMLIFn(vmli){return currentVMLI===vmli},self.isVisible=function isVisibleFn(){return isInputVisible},self.getCurrentSpan=function getCurrentSpanFn(){return currentVMLI?currentVMLI.getSpan():void 0},self.isTargetBox=function isTargetBoxFn(e){return g.isAncestor(e.target||e.srcElement,self.getInputContainer())},self.getInputContainer=function getInputContainerFn(){return inputContainer},self.getInputBox=function getInputBoxFn(){return inputBox},self.getRawInputText=function getRawInputTextFn(){return self.getInputBox().value},self.setRawInputText=function setRawInputTextFn(text){self.getInputBox().value=text},self.getRawSelectionStart=function getRawSelectionStartFn(){return self.getInputBox().selectionStart},self.getRawSelectionEnd=function getRawSelectionEndFn(){return self.getInputBox().selectionEnd},self.getSelectionStart=function getSelectionStartFn(){return self.getRawSelectionStart()<linePadding?0:self.getRawSelectionStart()-linePadding},self.getSelectionEnd=function getSelectionEndFn(){return self.getRawSelectionEnd()<linePadding?0:self.getRawSelectionEnd()-linePadding},self.setSelection=function setSelectionFn(start,end){self.setRawSelection(start+linePadding,end+linePadding)},self.setRawSelection=function setRawSelectionFn(start,end){self.setRawSelectionStart(start),self.setRawSelectionEnd(end)},self.setRawSelectionStart=function setRawSelectionStartFn(start){self.getInputBox().selectionStart=start},self.setRawSelectionEnd=function setRawSelectionEndFn(end){self.getInputBox().selectionEnd=end},self.canSetInput=function canSetInputFn(){return void 0===_canSetInput&&(_canSetInput=null!==self.getInputBox().selectionStart&&void 0!==self.getInputBox().selectionStart&&null!==self.getInputBox().selectionEnd&&void 0!==self.getInputBox().selectionEnd),_canSetInput},self.getActiveKeyboard=function getActiveKeyboardFn(){return activeKeyboard},self.notifyCustomKeyboard=function notifyCustomKeyboardFn(keyboard){keyboard.startsWith("com.google.android")||(customKeyboard=keyboard),activeKeyboard=keyboard},self.setPaneRoot=function setPaneRootFn(pane){function enforceSelection(){try{g.PAssert(2125,currentVMLI,"VMLI must be selected in order to enforce selection offset")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2126,self.getBoxHasTextSpace(),"Editor must always be prefixed with TextSpace")}catch(PERR){g.reportError(PERR)}self.getRawSelectionStart()<linePadding&&self.setRawSelectionStart(linePadding),self.getRawSelectionEnd()<linePadding&&self.setRawSelectionEnd(linePadding)}return void 0===pane.rootElement?void(enabled=!1):(enabled=!0,void(pane.rootElement!==paneRoot&&(paneRoot=pane.rootElement,paneScroller=pane.scrollElement,paneContent=pane.paneContent,platform.mobileie&&paneContent.removeAttribute("contenteditable"),inputBox=document.createElement("textarea"),inputBox.id="androidInput",inputBox.style.visibility="hidden",inputContainer=inputBox,paneRoot.appendChild(inputBox),inputBox.addEventListener("focus",function(e){g.dragging||g.isKeyboardOpen||g.keyboardToolbar.show(!1)}),platform.mobileie||inputBox.addEventListener("blur",function(e){(!e.relatedTarget||g.hasClass(e.relatedTarget,"search"))&&(self.finishInput(),g.keyboardToolbar.hide())}),inputBox.addEventListener("input",function(e){try{g.PAssert(2122,currentVMLI,"VMLI must be selected in order to get input events")}catch(PERR){g.reportError(PERR)}if(currentVMLI){if(edit=edit||require("edit"),pasteHappened)if(pasteHappened=!1,copypaste=copypaste||require("copypaste"),document.createEvent){var eventObj=document.createEvent("Event");eventObj.synthetic=!0,eventObj.data={types:["text/plain"],getData:function getDataFn(){return self.getBoxValue()}},eventObj.initEvent("paste",!0,!0),self.setSelection(0,self.getBoxValue().length),inputBox.dispatchEvent(eventObj)}else try{g.PAssert(2123,!1,"Unable to fire key event")}catch(PERR){g.reportError(PERR)}else{var isBackspace=!self.getBoxHasTextSpace();if(isBackspace){tracker=tracker||require("tracker");try{g.PAssert(2124,edit&&tracker,"Should always be defined")}catch(PERR){g.reportError(PERR)}tracker.beginAction(),edit.handleBackspace(e,currentVMLI.getSpan(),void 0),tracker.endAction()}else self.handleChacterTyped(e)}self.ensureLinePadding(),edit.updateAutocomplete(e)}}),platform.mobile&&inputContainer.addEventListener(platform.touchStartEvent,function(e){var touch=platform.ie?e:e.touches[0],offsetX=touch.clientX+inputBox.offsetLeft;currentVMLI&&offsetX>=g.vmMain.paneWidth-(g.isKeyboardOpen?g.MobileSideTapThresholdKeyboardOpen:g.MobileSideTapThreshold)&&(currentVMLI.isComplete(!currentVMLI.isComplete()),e.preventDefault())}),platform.ie||(inputBox.ontouchend=function(){setTimeout(enforceSelection,30)}),log("---- Android Editing Enabled ----"))))},self.notifyStarred=function notifyStarredFn(newValue){isStarred!==newValue&&(isStarred=newValue,isStarred?g.addClass(inputBox,"pStar"):g.removeClass(inputBox,"pStar"))},self.handleChacterTyped=function handleChacterTypedFn(){if(!customKeyboard){var sOffset=self.getSelectionStart(),eOffset=self.getSelectionEnd();sOffset===eOffset?1===sOffset?forceFirstCaps&&forceCapsHelper():0===sOffset&&(forceFirstCaps=!1):0===sOffset&&eOffset>0&&forceFirstCaps&&forceCapsHelper()}edit=edit||require("edit"),edit.scrollTextIntoView()};var updateTimer,wasHeader=!1,isInputVisible=!1;self.updateInput=function updateInputFn(vmli,forceOffset){try{g.PAssert(2127,self.isEnabled(),"Must be enabled to update input")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2128,vmli,"Must supply a valid item to select")}catch(PERR){g.reportError(PERR)}updateTimer&&(clearTimeout(updateTimer),updateTimer=void 0);var selOffset,range=g.getSelectionRange();void 0===forceOffset&&range&&range.startContainer.nodeType===Node.TEXT_NODE?selOffset=g.getSelectOffsetsInSpan(vmli.getSpan(),range,!0):void 0===forceOffset&&platform.mobileie&&(selOffset={start:vmli.getParsedText().length,end:vmli.getParsedText().length});var openingInput=!1;isInputVisible||(isInputVisible=!0,openingInput=!0,self.getInputContainer().style.visibility="visible",(null===self.getInputContainer().parentElement||void 0===self.getInputContainer().parentElement)&&paneRoot.appendChild(self.getInputContainer())),g.isKeyboardOpen||g.keyboardToolbar.show();var itemChanged=vmli!==currentVMLI;if((itemChanged||vmli&&vmli.isHeader()!==wasHeader)&&(currentVMLI&&itemChanged&&self.finishInput(!0),lastVMLI=currentVMLI,currentVMLI=vmli,wasHeader=vmli.isHeader(),self.notifyStarred(vmli.isStarred()),self.updateInputText(vmli),self.updateInputBounds(vmli)),openingInput&&self.getInputBox().focus(),self.canSetInput())try{var targetStart,targetEnd;if(void 0!==selOffset)targetStart=selOffset.start+1,targetEnd=selOffset.end+1,self.setRawSelection(targetStart,targetEnd);else if(void 0!==forceOffset)targetStart=forceOffset+1,targetEnd=forceOffset+1,self.setRawSelection(targetStart,targetEnd);else{var targetOffset=0;if(currentVMLI&&currentVMLI.getParsedText()){var textLength=currentVMLI.getParsedText().length;targetOffset=textLength}targetStart=targetOffset+1,targetEnd=targetOffset+1,self.setRawSelection(targetStart,targetEnd)}self.setSelection(targetStart,targetEnd)}catch(err){if(g.reportError(err),self.getInputBox().setSelectionRange)if(void 0!==selOffset)self.getInputBox().setSelectionRange(selOffset.start+linePadding,selOffset.end+linePadding);else if(void 0!==forceOffset)self.getInputBox().setSelectionRange(forceOffset+linePadding,forceOffset+linePadding);else{var targetOffset=0;if(currentVMLI&&currentVMLI.getParsedText()){var textLength=currentVMLI.getParsedText().length;targetOffset=textLength+linePadding}self.getInputBox().setSelectionRange(targetOffset,targetOffset)}}},self.updateInputText=function updateInputTextFn(vmli){if(vmli&&currentVMLI&&vmli===currentVMLI){var displayText=currentVMLI.getParsedText();forceFirstCaps=0===displayText.length,self.setBoxValue(displayText)}},self.insertText=function insertTextFn(offset,text){var val=self.getBoxValue(),newText=val.substr(0,offset)+text+val.substr(offset);self.setBoxValue(newText),self.canSetInput()&&(self.setSelection(offset+text.length,offset+text.length),g.autocomplete&&g.autocomplete.update({owner:currentVMLI,start:self.getSelectionStart(),fromArrows:!1}))},self.getInputText=function getInputTextFn(){try{g.PAssert(2129,self.isEnabled(),"Must be enabled to get input")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2130,currentVMLI,"Android input must be active to get input text")}catch(PERR){g.reportError(PERR)}return currentVMLI?self.getBoxValue():""};var lastHeight=0;return self.updateInputBounds=function updateInputBoundsFn(vmli){if(vmli&&currentVMLI&&vmli===currentVMLI){var elem=vmli.getSpan();if(elem){var bRect=elem.getBoundingClientRect(),leftOffset=8,topOffset=platform.orientation===Orientation.Portrait?g.topBarHeight:0,scrollTop=paneScroller.scrollTop;g.copyStyles(elem,self.getInputContainer(),["paddingLeft","paddingTop","paddingRight","paddingBottom","width","height","fontSize","lineHeight"]),self.getInputContainer().style.top=Math.ceil(bRect.top+scrollTop-topOffset)+"px",self.getInputContainer().style.marginLeft=leftOffset+"px",self.getInputContainer().style.paddingLeft=parseInt(self.getInputContainer().style.paddingLeft)-leftOffset+"px",lastHeight=self.getInputContainer().scrollHeight}}},self.checkAndroidBounds=function checkAndroidBoundsFn(){try{g.PAssert(2131,currentVMLI,"When updating Android bounds we should always have a current VMLI")}catch(PERR){g.reportError(PERR)}var boxHeight=self.getInputContainer().scrollHeight;if(boxHeight!==lastHeight){var resultText=self.getBoxValue();if(enabled=!1,currentVMLI){currentVMLI.getParsedText()!==resultText&&currentVMLI.setText(resultText,!0,ChangeType.Local,!0);var cStyle=window.getComputedStyle(currentVMLI.getSpan());self.getInputContainer().style.height=cStyle?cStyle.height:"16px"}enabled=!0,lastHeight=boxHeight}},self.flushInput=function flushInputFn(){var resultText=self.getBoxValue();currentVMLI&&currentVMLI.getParsedText()!==resultText&&(forceFirstCaps&&(1===resultText.length?resultText=resultText.toUpperCase():resultText.length>1&&(resultText=resultText[0].toUpperCase()+resultText.substring(1))),currentVMLI.setText(resultText,!0,ChangeType.Local,!0))},self.finishInput=function finishInputFn(continueEditing){try{g.PAssert(2132,self.isEnabled(),"Must be enabled to finish input")}catch(PERR){g.reportError(PERR)}currentVMLI&&(isInputVisible&&!continueEditing&&(isInputVisible=!1,self.getInputContainer().style.visibility="hidden",g.blurActiveElement()),self.flushInput(),lastVMLI=currentVMLI,currentVMLI=void 0)},self.handlePaste=function handlePasteFn(){pasteHappened=!0},self.ensureLinePadding=function ensureLinePaddingFn(){var rawText=self.getInputBox().value;if(rawText.length<linePadding)return fixLinePadding(rawText),!1;for(var i=0;linePadding>i;++i)if(rawText[i]!==padCharacter)return fixLinePadding(rawText),!1;return!0},self.getBoxHasTextSpace=function getBoxHasTextSpaceFn(){var rawText=self.getRawInputText();if(rawText.length<linePadding)return!1;for(var sCount=0,i=0;i<rawText.length&&linePadding>sCount;++i)rawText[i]===padCharacter&&sCount++;return sCount===linePadding},self.getBoxValue=function getBoxValueFn(){var rawText=self.getRawInputText(),outText=removeTextSpace(rawText);return outText},self.setBoxValue=function setBoxValueFn(text){text||(text="");for(var newText="",i=0;linePadding>i;++i)newText+=padCharacter;newText+=removeTextSpace(text),self.setRawInputText(newText)},self.passKeypress=function passKeypressFn(e){return currentVMLI&&(e.normCode===KeyCode.Enter||e.synthetic)?!0:!1},self.passKeydown=function passKeydownFn(e){return currentVMLI&&(e.normCode===KeyCode.Tab||e.synthetic)?!0:!1},self}),define("VMLI_TapHandlers",["ko","globals","platform","android"],function(ko,g,platform,android){var dataTransfer,dragStartInfo,VMLI_TapHandlers={dragStart:function dragStartFn(e){try{g.PAssert(2133,!platform.mobile||g.focusedPane.isWriteable,"Should not be able to drag/drop on timeline on mobile")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2134,g.startDrag,"Should always have a valid item to start dragging from")}catch(PERR){g.reportError(PERR)}g.clearSelection(),android.isEnabled()&&android.finishInput();var target=g.startDrag.getElement();g.startDrag=void 0;try{g.PAssert(2135,void 0===g.dragging,"Only one element may be dragged or dropped at a time")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2136,void 0===g.draggingHidden,"Only one element may be dragged or dropped at a time")}catch(PERR){g.reportError(PERR)}var tempUL=g.element("tempUL");try{g.PAssert(2137,tempUL,"TempUL must always be present")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2138,!tempUL.hasChildNodes(),"TempUL should never have children when starting a drag")}catch(PERR){g.reportError(PERR)}var dragLine=g.element("dragLine");try{g.PAssert(2139,dragLine,"DragLine must always be present")}catch(PERR){g.reportError(PERR)
}if(tempUL&&dragLine){g.draggingHidden=target,g.dragging=target.cloneNode(!0),tempUL.appendChild(g.dragging);var srcRect=g.offset(target),width=g.width(target),x=srcRect.left-1,y=srcRect.top-1;dragStartInfo={x:e.eventX,y:e.eventY},dataTransfer={dropEffect:g.focusedPane.dropEffect,item:this,fromPane:g.focusedPane},tempUL.style.display="block",dragLine.style.display="visible",tempUL.style.width=width+"px";var rect=target.getBoundingClientRect(),ulRect=tempUL.getBoundingClientRect();rect.height>ulRect.height&&(y+=(rect.height-ulRect.height)/2),tempUL.style.left=x+"px",tempUL.style.top=y+"px",g.addClass(g.draggingHidden,"itemBeingDragged"),g.disableMouseMove=!0}},dragMove:function dragMoveFn(e){e.preventDefault();var x=platform.mobile?0:e.eventX-dragStartInfo.x,y=e.eventY-dragStartInfo.y,translate="translate3d("+x+"px, "+y+"px, 0)";g.isDemoMode()&&window.__DRAG_SCALE&&(translate+=" scale("+window.__DRAG_SCALE+")");var tempUL=g.element("tempUL");try{g.PAssert(2140,tempUL,"TempUL must always be present")}catch(PERR){g.reportError(PERR)}tempUL.style.pointerEvents="none";var dragOver=document.elementFromPoint(e.eventX,e.eventY);tempUL.style[platform.transform.style]=translate,tempUL.style.pointerEvents="",g.vmMain.handleDragOver({srcElement:dragOver,dataTransfer:dataTransfer,diffY:e.diffY,clientY:e.eventY,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn})},dragEnd:function dragEndFn(e){platform.ios&&g.preventClick(),g.disableMouseMove=!1;var dragging=g.dragging,draggingHidden=g.draggingHidden;g.dragging=void 0,g.draggingHidden=void 0,g.removeClass(draggingHidden,"itemBeingDragged"),dragging.parentNode.removeChild(dragging),g.element("tempUL").style.display="none",g.element("dragLine").style.visibility="hidden",g.vmMain.handleDrop({srcElement:e.srcElement,dataTransfer:dataTransfer,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn}),dataTransfer=void 0,platform.ios&&g.preventClick(),g.disableMouseMove=!1},onStart:function onStartFn(e){g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0);var element=this.getElement(),offsetX=element?e.clientX-g.offset(element).left:0;g.scrollAtTouchStart=g.focusedPane.getScrollOffset(),platform.mobile&&this.isDraggable()&&!platform.ie&&"UL"!==e.srcElement.tagName&&!g.isKeyboardOpen&&g.focusedPane.isWriteable?g.dragStartTimeout=setTimeout(function(){g.clearSelection(),g.startDrag=this,this.dragStart(e),this.dragMove(e)}.bind(this),400):!platform.mobile&&(this.isDraggable()&&"SPAN"===e.srcElement.tagName&&offsetX<=this.getPadding(g.focusedPane)-g.SPThresholdLeft||g.hasClass(e.srcElement,"plugin")||g.hasClass(e.srcElement.parentElement,"plugin"))&&(g.clearSelection(),g.startDrag=this,e.preventDefault(),e.stopImmediatePropagation())},onMove:function onMoveFn(e,onPane){g.startDrag&&(!platform.touch||Math.abs(e.distanceY)>g.ClickThreshold&&Math.abs(e.distanceX)<g.ClickThreshold)&&g.startDrag===this&&this.dragStart(e),g.dragging?this.dragMove(e):platform.touch&&g.canRevealMenu&&g.focusedPane.type!==PaneMode.Timeline&&(g.revealingMenu||e.distanceY<g.ClickThreshold&&Math.abs(e.diffX)>g.ClickThreshold)&&((!onPane||g.phoneMenu.multiSelectMode())&&(g.revealingMenu||g.menus.revealGestureMenu(this,e),g.menus.updateRevealGestureMenu(e)),e.preventDefault())},onClick:function onClickFn(e){var element=this.getElement(),offsetX=element?e.clientX-g.offset(element).left:0;if(platform.mobile&&g.dragging)e.preventDefault(),platform.ios&&g.preventClick();else if(platform.mobile&&g.phoneMenu.multiSelectMode())g.menus.multiSelect(this);else if(!platform.mobile&&"SPAN"===e.srcElement.tagName&&offsetX<this.getPadding(g.focusedPane)-g.SPThresholdLeft&&g.focusedPane.supportCollapsing)platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey?g.vmMain.zoomin(this):this.isCollapsible()&&this.toggleCollapsed();else if(!platform.mobile&&"SPAN"===e.srcElement.tagName&&offsetX>=g.vmMain.paneWidth-g.SPThresholdRight)this.isComplete(!this.isComplete());else if("SPAN"===e.srcElement.tagName&&g.hasClass(e.srcElement,"itemDataPageLoad"))this.notifyPaginationUpdate();else if(platform.mobile&&"SPAN"===e.srcElement.tagName&&offsetX<=this.getPadding(g.focusedPane))this.isCollapsible()&&this.toggleCollapsed(),e.preventDefault(),platform.ios&&g.preventClick();else if(platform.mobile&&offsetX>=g.vmMain.paneWidth-(g.isKeyboardOpen?g.MobileSideTapThresholdKeyboardOpen:g.MobileSideTapThreshold))this.isComplete(!this.isComplete()),e.preventDefault(),platform.ios&&g.preventClick();else if(g.hasClass(e.srcElement,"tag")&&!platform.mobile&&(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)){var text=e.srcElement.textContent;e.shiftKey?g.focusedPane.vmSearch.setSearch(text):g.focusedPane.vmSearch.addToSearch(text)}else if(g.hasClass(e.srcElement,"contact")){if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){var text=e.srcElement.textContent;e.shiftKey?g.focusedPane.vmSearch.setSearch(text):g.focusedPane.vmSearch.addToSearch(text)}else if(!platform.mobile||!g.isKeyboardOpen){var offset=g.getOffsetOfSubNode(this.getSpan(),e.srcElement);g.autocomplete.update({owner:this,start:offset}),g.autocomplete.show(e.srcElement),e.preventDefault(),platform.ios&&g.preventClick()}}else if(g.vmMain.pluginManager.handleTapEvent(this,e));else if("A"===e.srcElement.tagName)(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey||platform.app)&&g.openUrl(e.srcElement.href,e);else if(g.autocomplete&&g.autocomplete.hide(),platform.ios||platform.android||platform.mobileie){var activeElement=document.activeElement,scrollTopClick=g.focusedPane.getScrollOffset(),justCancelledInertialScroll=Math.abs(scrollTopClick-g.scrollAtTouchStart)>0;if(g.isKeyboardOpen&&activeElement&&!g.hasClass(activeElement,"search")||justCancelledInertialScroll||!g.focusedPane.isWriteable)platform.mobileie&&android.isEnabled()&&g.focusedPane.isWriteable&&(android.updateInput(this),e.preventDefault(),e.stopPropagation());else{var item=this;platform.mobile&&this===g.focusedPane.item()&&(item=g.getLastVisibleItem(g.focusedPane.item()));try{g.PAssert(2141,item,"Click on item should not happen")}catch(PERR){g.reportError(PERR)}platform.ios&&g.vmMain.setSelected([item]),g.openKeyboardOn(e,item.getSpan(),!0,!1,function(){if(android.isEnabled()){if(android.updateInput(item),g.hasClass(e.srcElement,"contact")){var offset=g.getOffsetOfSubNode(this.getSpan(),e.srcElement);g.autocomplete.update({owner:this,start:offset+1}),g.autocomplete.show(e.srcElement),e.preventDefault()}}else g.selectChildren(item,item.getParsedText().length,0)}.bind(this))}}else if(!platform.mobile&&g.focusedPane.type===PaneMode.Timeline&&g.hasClass(e.srcElement,"text")){var item=this;g.vmMain.paneManager.runForEachPane(function(pane){pane.vmSearch.isVisible(item)&&g.scrollIntoView(item.getSpan(pane.id),200)}),this.highlight(),g.sendEvent("Menu","GoTo")}},onDblClick:function onDblClickFn(e){if(platform.mobile&&g.focusedPane.type===PaneMode.Timeline&&g.hasClass(e.srcElement,"text")){g.focusedPane.onTapToggleModeMobile(),e.preventDefault();var item=this;g.vmMain.paneManager.runForEachPane(function(pane){pane.vmSearch.isVisible(item)&&g.scrollIntoView(item.getSpan(pane.id),200)}),this.highlight(),g.sendEvent("PhoneMenu","GoTo")}},onEnd:function onEndFn(e){g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0,e.preventDefault()),g.startDrag=void 0,g.itemMenuOpenedOn===this&&g.menus.menuItemSelected(e.srcElement),(g.revealingMenu||g.phoneMenu&&g.phoneMenu.multiSelectMode())&&(e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0,platform.ios&&g.preventClick()),g.revealingMenu&&g.menus.stopRevealGestureMenu(e),g.dragging&&(this.dragEnd(e),e.preventDefault())},onRightClick:function onRightClickFn(e){g.menus.openItemMenu(this,e),e.preventDefault(),e.stopPropagation()},onAutocompleteTapped:function onAutocompleteTappedFn(text,textLength,trackingTag){try{g.PAssert(2142,trackingTag,"Must be tracking the current AC tag")}catch(PERR){g.reportError(PERR)}if(android.isEnabled()){var aText=android.getInputText(),newText=aText.substr(0,trackingTag.index-trackingTag.replaceLength)+text+aText.substr(trackingTag.index+trackingTag.length);this.setText(newText,!0,ChangeType.Local),android.updateInputText(this);var selOffset=trackingTag.index+textLength;android.setSelection(selOffset,selOffset)}else{var newText=this.getParsedText().substr(0,trackingTag.index-trackingTag.replaceLength)+text+this.getParsedText().substr(trackingTag.index+trackingTag.length);this.setText(newText,!0,ChangeType.Local),g.selectChildren(this,trackingTag.index+textLength,0)}}};return VMLI_TapHandlers}),define("RepeatDate",["globals"],function(g){function RepeatDate(p){if(this._valid=!0,g.isString(p))this.fromString(p);else if(p instanceof RepeatDate)this._startDate=new Date(p._startDate),this._endDate=p._endDate?new Date(p._endDate):void 0,this._frequency=p._frequency,this._separation=p._separation,this._offsets=p._offsets?p._offsets.slice():void 0;else if(g.isObject(p)){try{g.PAssert(2143,p.type===DateType.Repeat,"Must have a valid date type set")}catch(PERR){g.reportError(PERR)}this._startDate=new Date(p.startDate),this._endDate=p.endDate?new Date(p.endDate):void 0,this._frequency=p.frequency,this._separation=p.separation||1,this._offsets=p.offsets}else{try{g.PAssert(2144,!1,"Invalid object passed to RepeatDate constructor")}catch(PERR){g.reportError(PERR)}this._valid=!1}if(this._startDate){try{g.PAssert(2145,this._startDate instanceof Date,"Must be a valid date instance")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2146,this._startDate.isAfter(minStartDate),"Start date must be after the minimum start date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2147,!this._endDate||this._endDate instanceof Date,"Must be a valid date instance")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2148,!this._offsets||this._offsets.length>=1,"Must always store at least one offset if _offsets is defined",this._offsets)}catch(PERR){g.reportError(PERR)}if(this._endDate&&!this._startDate.isBefore(this._endDate)&&!this._startDate.equals(this._endDate)){this._valid=!1;try{g.PAssert(2150,!1,"Start date must always be before the end date")}catch(PERR){g.reportError(PERR)}}}else this._valid=!1;this._doneGenerating=!this._valid,this._cache=[],this._cacheDate=new Date(this._startDate)}var REPEAT_VER=1,SEP="|",maxGenDates=500,minStartDate=new Date(1401606e6);return RepeatDate.prototype={setStartDate:function setStartDateFn(date){try{g.PAssert(2151,date,"Must provide a valid date")}catch(PERR){g.reportError(PERR)}if(this._startDate=new Date(date),this._endDate&&!this._startDate.isBefore(this._endDate)&&!this._startDate.equals(this._endDate)){this._valid=!1;try{g.PAssert(2152,!1,"Start date must always be before the end date")}catch(PERR){g.reportError(PERR)}}this._resetCache()},getStartDate:function getStartDateFn(){return this._startDate},getEndDate:function getEndDateFn(){return this._endDate},_isBeforeEnd:function _isBeforeEndFn(date){try{g.PAssert(2153,date,"Must provide a valid date")}catch(PERR){g.reportError(PERR)}var cacheHasSpace=this._cache.length<maxGenDates,beforeEnd=this._endDate?date.isBefore(this._endDate)||date.equals(this._endDate):!0;return cacheHasSpace&&beforeEnd},_resetCache:function _resetCacheFn(){this._cache=[],this._cacheDate=new Date(this._startDate),this._doneGenerating=!this._valid},_getNext:function _getNextFn(num){return this._cache.length<num&&this._generate(num),this._cache.slice(0,num)},_generateUntil:function _generateUntilFn(until){try{g.PAssert(2154,until,"Must provide a valid date to generate until")}catch(PERR){g.reportError(PERR)}for(var generated=!1;!this._doneGenerating&&this._getLastCachedDate()&&this._getLastCachedDate().isBefore(until);)this._generateNext(1),generated=!0;return generated},_generateNext:function _generateNextFn(num){try{g.PAssert(2155,num>0,"Must request a valid number of additional dates")}catch(PERR){g.reportError(PERR)}this._generate(this._cache.length+num)},_generate:function _generateFn(totalNum){try{g.PAssert(2156,totalNum>0,"Must request a valid number of dates")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2157,maxGenDates>totalNum,"Must request less than maxGenDates dates")}catch(PERR){g.reportError(PERR)}var currentDate=new Date(this._cacheDate);totalNum=Math.min(totalNum,maxGenDates);for(var iterations=0;totalNum>iterations&&this._cache.length<totalNum&&this._isBeforeEnd(currentDate);){if(this._offsets)for(var i=0;i<this._offsets.length&&this._cache.length<totalNum;++i){var cOffset=this._offsets[i],instanceDate=new Date(currentDate);if(instanceDate.getDay()<=cOffset){switch(this._frequency){case RepeatFreq.Weekly:instanceDate.addDays(cOffset-instanceDate.getDay());break;default:try{g.PAssert(2158,!1,"Invalid repeat frequency for offset dates",this._frequency)}catch(PERR){g.reportError(PERR)}}var lastCache=this._cache[this._cache.length-1];if(!this._isBeforeEnd(instanceDate)||lastCache&&!instanceDate.isAfter(lastCache))return void(this._isBeforeEnd(instanceDate)||(this._doneGenerating=!0));this._cache.push(instanceDate)}}else{var instanceDate=new Date(currentDate),lastCache=this._cache[this._cache.length-1];if(!this._isBeforeEnd(instanceDate)||lastCache&&!instanceDate.isAfter(lastCache))return void(this._isBeforeEnd(instanceDate)||(this._doneGenerating=!0));this._cache.push(instanceDate)}switch(this._frequency){case RepeatFreq.Hourly:currentDate.addHours(this._separation);break;case RepeatFreq.Daily:currentDate.addDays(this._separation);break;case RepeatFreq.Weekly:this._offsets&&this._offsets.length>1&&currentDate.getDay()!==this._offsets[0]&&currentDate.moveToDayOfWeek(this._offsets[0],-1),currentDate.addWeeks(this._separation);break;case RepeatFreq.Monthly:currentDate.addMonths(this._separation);break;case RepeatFreq.NthMonthInst:var targetDay=this._startDate.getDay(),occur=Math.ceil(this._startDate.getDate()/7);currentDate.addMonths(this._separation),(4===occur||5===occur)&&(occur=-1),currentDate.moveToNthOccurrence(targetDay,occur);break;case RepeatFreq.Yearly:currentDate.addYears(this._separation);break;case RepeatFreq.EndOfMonthOffset:currentDate.addMonths(this._separation);var offsetDay=this._startDate.getDate(),maxOffsetDay=this._startDate.getDaysInMonth(),diff=maxOffsetDay-offsetDay;currentDate.setDate(currentDate.getDaysInMonth()-diff);break;case RepeatFreq.DayOfMonth:for(var i=0;i<this._separation;++i)this.getNextValidMonth(currentDate,this._startDate.getDate());break;case RepeatFreq.Once:default:try{g.PAssert(2159,!1,"Invalid repeat frequency")}catch(PERR){g.reportError(PERR)}return void(this._doneGenerating=!0)}this._cacheDate=currentDate,iterations++}this._isBeforeEnd(currentDate)||(this._doneGenerating=!0)},getNextValidMonth:function getNextValidMonthFn(date,offsetDay){if(date.addMonths(1),date.getDate()!==offsetDay){var maxDays=date.getDaysInMonth();offsetDay>maxDays&&(date.addMonths(1),date.setDate(offsetDay))}},getDates:function getDatesFn(futureOnly){var maxPastDates=3,maxFutureDates=4,today=new Date;this._generate(maxFutureDates),this._generateUntil(today);var todayIndex=this._cache.findInsertIndex(today,Date.compare),futureDates=this._cache.length-todayIndex;maxFutureDates>futureDates&&this._generateNext(maxFutureDates-futureDates);var minIndex=futureOnly?Math.max(todayIndex,0):Math.max(todayIndex-maxPastDates,0),maxIndex=Math.min(todayIndex+maxFutureDates,this._cache.length);return this._cache.slice(minIndex,maxIndex)},next:function nextFn(num){return num>0?this._getNext(num):void 0},nextIndex:function nextIndexFn(fromDate){var from=fromDate?new Date(fromDate):this._startDate,generated=this._generateUntil(from);if(generated)return this._cache.length-1;for(var i=0;i<this._cache.length;++i)if(this._cache[i].isAfter(from)||this._cache[i].equals(from))return i;return this._generateNext(1),this._cache.length-1},nextComplete:function nextCompleteFn(fromDate){var futIndex=this.nextIndex(fromDate);return this._cache[futIndex]},nextActive:function nextActiveFn(fromDate){var futIndex=this.nextIndex(fromDate);return this._cache.length<=futIndex+1&&this._generateNext(1),this._cache[futIndex+1]},_getLastCachedDate:function _getLastCachedDateFn(){return this._cache[this._cache.length-1]},hasTimeOfDay:function hasTimeOfDayFn(){return this._startDate.hasTimeOfDay()},isRepeatDate:function isRepeatDateFn(){return!0},getTimeOfDay:function getTimeOfDayFn(){return this._startDate.getTimeOfDay()},getTime:function getTimeFn(format){return this._startDate.toString(format)},equals:function equalsFn(dateInfo){if(this._valid){if(g.isString(dateInfo))return this.toString()===dateInfo;if(dateInfo instanceof RepeatDate){if(dateInfo._valid){var startEqual=!isNaN(this._startDate)&&!isNaN(dateInfo._startDate)&&this._startDate.equals(dateInfo._startDate),endEqual=this._endDate?this._endDate.equals(dateInfo._endDate):this._endDate===dateInfo._endDate,freqEqual=this._frequency===dateInfo._frequency,sepEqual=this._separation===dateInfo._separation,offsetsEqual=this._offsets?this._offsets.equals(dateInfo._offsets):this._offsets===dateInfo._offsets;return startEqual&&endEqual&&freqEqual&&sepEqual&&offsetsEqual}}else if(g.isObject(dateInfo)){try{g.PAssert(2165,dateInfo.type===DateType.Repeat,"Must have a valid date type set")}catch(PERR){g.reportError(PERR)}var compDate=new Date(dateInfo.startDate),startEqual=!isNaN(this._startDate)&&!isNaN(compDate)&&this._startDate.equals(compDate),endEqual=this._endDate==(dateInfo._endDate?new Date(dateInfo._endDate):void 0),freqEqual=this._frequency===dateInfo.frequency,sepEqual=this._separation===dateInfo._separation,offsetsEqual=this._offsets?this._offsets.equals(dateInfo._offsets):this._offsets===dateInfo._offsets;return startEqual&&endEqual&&freqEqual&&sepEqual&&offsetsEqual}}return!1},fromString:function fromStringFn(str){try{var tokens=str.split(SEP),ver=tokens[0];if("1"===ver){if(this._startDate=new Date(parseInt(tokens[1])),this._endDate=tokens[2]?new Date(parseInt(tokens[2])):void 0,this._frequency=parseInt(tokens[3]),this._separation=parseInt(tokens[4]),this._offsets=void 0,tokens[5]){var offsets=tokens[5].split(",");if(offsets.length>0){this._offsets=[];for(var i=0;i<offsets.length;++i)this._offsets.push(parseInt(offsets[i]))}}}else this._valid=!1}catch(err){this._valid=!1,g.reportError(err)}this._resetCache()},toString:function toStringFn(){if(this._valid){var start=this._startDate.getTime(),end=this._endDate?this._endDate.getTime():"",offsets=this._offsets&&this._offsets.length>1?this._offsets.join(","):"";return REPEAT_VER+SEP+start+SEP+end+SEP+this._frequency+SEP+this._separation+SEP+offsets}return void 0}},RepeatDate}),window.DuchessHelpers={},define("DuchessHelpers",["globals"],function(g){function isFlagSet(data,mask){return(data&mask)===mask}function enumToString(en,value){for(var k in en)if(en[k]===value)return k;return null}function escape(html){return String(html).replace(/[&\"<>]/g,function(chr){return charMap[chr]})}function trimPunc(str){var outStr=str.replace(/[:,\.\'\"\)\]]$/g,"");return outStr}function getRepeatStartDate(repeatDateStr){if(repeatDateStr&&"string"==typeof repeatDateStr){var tokens=repeatDateStr.split("|");if(tokens.length>3)return new Date(parseInt(tokens[1]))}return void 0}function setDateTokens(dateString){lastToken=void 0,dateTokens=dateString.split(" "),dateTokenOffset=1,dateCharsConsumed=dateTokens[0].length,dateCharsFromString=0,dateParsedDate=void 0}function checkAndParse(tokenType,numTokens){var isValid=!1;if(numTokens=void 0!==numTokens&&numTokens>1?Math.min(dateTokens.length-dateTokenOffset,numTokens):numTokens,void 0===numTokens||1===numTokens)dateTokenOffset<dateTokens.length&&(isValid=dateTokens[dateTokenOffset].match(tokenType),isValid&&(lastToken=dateTokens[dateTokenOffset],dateTokenOffset++,dateCharsConsumed+=lastToken.length+1));else if(numTokens>1&&dateTokenOffset+numTokens<=dateTokens.length)for(var consumeToken=numTokens;consumeToken>0;consumeToken--){for(var currentString="",i=0;consumeToken>i;++i)currentString+=dateTokens[dateTokenOffset+i],i+1!==consumeToken&&(currentString+=" ");if(isValid=currentString.match(tokenType)){lastToken=currentString,dateTokenOffset+=consumeToken,dateCharsConsumed+=currentString.length+1;break}}return isValid}function checkAndParseDate(){var isValid=!1;if(dateTokenOffset+1<dateTokens.length&&!dateTokens[dateTokenOffset+1].match(dToken.at)){var twoParsedDate=Date.parse(dateTokens[dateTokenOffset]+" "+dateTokens[dateTokenOffset+1]);twoParsedDate&&(isValid=!0,lastToken=dateTokens[dateTokenOffset]+dateTokens[dateTokenOffset+1],dateParsedDate=twoParsedDate,dateTokenOffset+=2,dateCharsConsumed+=lastToken.length+2)}if(!isValid&&dateTokenOffset<dateTokens.length){var parsedDate=Date.parse(dateTokens[dateTokenOffset]);parsedDate&&(isValid=!0,lastToken=dateTokens[dateTokenOffset],dateParsedDate=parsedDate,dateTokenOffset++,dateCharsConsumed+=lastToken.length+1)}return isValid}function computeStartDate(dayOrd,wkOrd,monthOrd,yearOrd,time,fromDate){var minStart=fromDate||new Date,startDate=(fromDate?new Date(fromDate):new Date).clearTime();if(void 0!==yearOrd&&(startDate.setMonth(yearOrd),startDate.isBefore(minStart)&&(startDate.addYears(1),startDate.setMonth(yearOrd))),void 0!==monthOrd&&monthOrd>0&&31>=monthOrd){var maxDays=Date.getDaysInMonth(startDate.getFullYear(),startDate.getMonth());monthOrd>maxDays&&startDate.addMonths(1),startDate.setDate(monthOrd)}if(void 0!==wkOrd?(startDate.moveToNthOccurrence(dayOrd,wkOrd),startDate.isBefore(minStart)&&(startDate.addMonths(1),startDate.moveToNthOccurrence(dayOrd,wkOrd))):void 0!==dayOrd&&startDate.getDay()!==dayOrd&&(startDate.moveToDayOfWeek(dayOrd,-1),startDate.isBefore(minStart)&&startDate.moveToDayOfWeek(dayOrd)),time){var parts=timeRegexp.exec(time),merid,isPM,hour,min,hourString;void 0!==parts[1]?(merid=parts[3].toUpperCase(),isPM=merid===Date.CultureInfo.pmDesignator[0]||merid===Date.CultureInfo.pmDesignator,hour=parseInt(parts[1])+(isPM?12:0),min=parts[2]?parseInt(parts[2].slice(1)):0,hourString=parts[1]):void 0!==parts[4]&&void 0!==parts[5]&&(hour=parseInt(parts[4]),min=parseInt(parts[5]),hourString=parts[4]);var is24Hour=!1;if(hourString){var rawHour=parseInt(hourString);(hourString.startsWith("0")||0===rawHour||rawHour>12)&&(is24Hour=!0)}merid||is24Hour?merid&&!is24Hour&&(isPM||12!==hour?isPM&&24===hour&&(hour=12):hour=0):8>hour&&(hour+=12),startDate.setHours(hour),startDate.setMinutes(min),startDate.setMilliseconds(1)}return startDate}var punctuation=", . ? ! ) ( : ; [ ] ' \"".split(" "),cmdChar=-1===navigator.userAgent.indexOf("Mac")?"ctrl":"⌘";"function"!=typeof String.prototype.insertTag&&(String.prototype.insertTag=function(sIndex,sTag,length,eTag){return this.substr(0,sIndex)+sTag+this.substr(sIndex,length)+eTag+this.substr(sIndex+length)}),"function"!=typeof String.prototype.replaceText&&(String.prototype.replaceText=function(sIndex,text,length){return this.substr(0,sIndex)+text+this.substr(sIndex+length)});var charMap={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"},validProtocols=["http","https","evernote"],forceCompleteTime=new Date(9e12).getTime(),minStartDate=new Date(1401606e6),softDateRegexp=/^(today|tomorrow|yesterday|(?:sun|mon|tue(?:s)?|wed(?:nes)?|thu(?:rs)?|fri|sat(?:ur)?)(?:day)?)/i,timeRegexp=/^(?:(?:([0]?[1-9]|1[0-2])(?::([0-5]\d))?(?:\s)?(am?|pm?|\b))|(?:([0]?\d|1\d|2[0-3]):([0-5]\d)))$/i,tagRegexp=/(^#|[\(\s]#)([^\s\),]+)/g,dateRegexp=/(?:^@|[\(\s]@)([^\s\)]{2,})(\s[^\s\)@]{1,})?(\s[^\s\)@]{1,})?/g,linkRegexp=/\b((?:(https?|evernote):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/g,minLinkRegexp=/(?:^|[\s\(\[])([^\(\[#@\s]+\.(?:com|org|net|io))/gi,pluginRegexp=/(?:\u2001(p:[^\u2001]+)\u2001)/gi;window.__PARSE_TEXT_TOTAL_CALLS=0,window.DuchessHelpers.parseText=function(itemText,prevDate,prevRepeatDate,completedTime,changeType,contactsList){window.__PARSE_TEXT_TOTAL_CALLS++;var hasDiffParse=!1,parsedText=itemText,contacts=[];if(!itemText||0===itemText.length)return{parsedText:void 0};var startText=itemText,hasStyle=!1,oldLength=itemText.length;itemText=escape(itemText),oldLength!==itemText.length&&(hasStyle=!0);var match,startTag,endTag,tags,dates,attachments;if(contactsList&&contactsList.___info___.count>0&&itemText.indexOf(ContactPrefix)>=0){for(var words=itemText.split(" "),lineIndex=0,i=0;i<words.length;i++){if(0===words[i].indexOf(ContactPrefix)){for(var matchedName,combined=words[i].substring(1),u=1;;u++){var compStr=trimPunc(combined);if(""===contactsList[compStr]&&(matchedName=compStr),!(i+u<words.length))break;combined+=" "+words[i+u]}matchedName&&contacts.push({name:matchedName,lineIndex:lineIndex})}lineIndex+=words[i].length+1}if(contacts.length>0)for(var i=contacts.length-1;i>=0;i--)itemText=itemText.insertTag(contacts[i].lineIndex,'<p class="contact">',contacts[i].name.length+1,"</p>"),hasStyle=!0}for(tagRegexp.lastIndex=0;null!==(match=tagRegexp.exec(itemText));){var matchIndex=match.index+match[1].length-1,matchLength=match[2].length+1;punctuation.indexOf(match[2].charAt(match[2].length-1))>=0&&matchLength--,tags?tags.push(match[2]):tags=[match[2]],itemText=itemText.insertTag(matchIndex,'<p class="tag" tooltip="'+cmdChar+'+click to search">',matchLength,"</p>"),hasStyle=!0}for(dateRegexp.lastIndex=0;null!==(match=dateRegexp.exec(itemText));){for(var prefixLength=match[0].indexOf(DatePrefix),dateString,puncFound=!1,i=1;i<match.length&&match[i];++i)if(puncFound)match[i]=void 0;else{var lastChar=match[i][match[i].length-1];punctuation.indexOf(lastChar)>=0&&(match[i]=match[i].slice(0,-1),puncFound=!0)}var repeatDateInfo=window.DuchessHelpers.parseRepeatDate(prevRepeatDate,completedTime,changeType,itemText.substr(match.index+prefixLength+1));if(repeatDateInfo||match[1].startsWith("every")||"in"===match[1]){if(repeatDateInfo){if(repeatDateInfo.replacedStartDate){var dateLength=repeatDateInfo.text.length+1,dateTextOffset=match.index+prefixLength+1,repeatDateString=itemText.substr(dateTextOffset,dateTextOffset+repeatDateInfo.repLength);itemText=itemText.substr(0,dateTextOffset)+repeatDateInfo.text+itemText.substr(dateTextOffset+repeatDateInfo.repLength),itemText=itemText.insertTag(match.index+prefixLength,'<p class="date">',dateLength,"</p>");var parsedDateIndex=parsedText.indexOf(repeatDateString);parsedText=parsedText.substr(0,parsedDateIndex)+repeatDateInfo.text+parsedText.substr(parsedDateIndex+repeatDateInfo.repLength),hasDiffParse=!0}else itemText=itemText.insertTag(match.index+prefixLength,'<p class="date">',repeatDateInfo.repLength+prefixLength+1,"</p>");dates?dates.push(repeatDateInfo):dates=[repeatDateInfo],hasStyle=!0;break}}else{dateString=match[1]+(match[2]?match[2]:"")+(match[3]?match[3]:"");var dt=Date.parse(dateString);if(!dt&&match[3]&&(dateString=match[1]+(match[2]?match[2]:""),dt=Date.parse(dateString)),!dt&&match[2]&&(dateString=match[1],dt=Date.parse(dateString)),dt){var newDateInfo=window.DuchessHelpers.computeDateInfo(prevDate,changeType,dt,dateString);if(newDateInfo.replacedDate){var dateLength=newDateInfo.text.length+1,dateTextOffset=match.index+prefixLength+1;itemText=itemText.substr(0,dateTextOffset)+newDateInfo.text+itemText.substr(dateTextOffset+dateString.length),itemText=itemText.insertTag(match.index+prefixLength,'<p class="date">',dateLength,"</p>");var parsedDateIndex=parsedText.indexOf(dateString);parsedText=parsedText.substr(0,parsedDateIndex)+newDateInfo.text+parsedText.substr(parsedDateIndex+dateString.length),hasDiffParse=!0;var dateObj={type:DateType.Once,date:newDateInfo.date,text:newDateInfo.text,explicitTime:dt.hasTimeOfDay()};dates?dates.push(dateObj):dates=[dateObj]}else{var dateLength=dateString.length+1;itemText=itemText.insertTag(match.index+prefixLength,'<p class="date">',dateLength,"</p>");var dateObj={type:DateType.Once,date:newDateInfo.date,text:dateString,explicitTime:dt.hasTimeOfDay()};dates?dates.push(dateObj):dates=[dateObj]}hasStyle=!0;break}}}if(linkRegexp.lastIndex=0,null!==(match=linkRegexp.exec(itemText))){var hasProtocol=validProtocols.indexOf(match[2])>=0,linkHref=hasProtocol?match[0]:"http://"+match[0];startTag='<a target="_blank" href="'+linkHref+'" tooltip="'+cmdChar+'+click to navigate">',endTag="</a>",itemText=itemText.insertTag(match.index,startTag,match[0].length,endTag),hasStyle=!0}else if(minLinkRegexp.lastIndex=0,null!==(match=minLinkRegexp.exec(itemText))){var prefixLength=match[0].length-match[1].length,linkHref=match[1].startsWith("http")?match[1]:"http://"+match[1];startTag='<a target="_blank" href="'+linkHref+'" tooltip="'+cmdChar+'+click to navigate">',endTag="</a>",itemText=itemText.insertTag(match.index+prefixLength,startTag,match[1].length,endTag),hasStyle=!0}for(pluginRegexp.lastIndex=0;null!==(match=pluginRegexp.exec(itemText));){var padBefore=0!==match.index,padAfter=match.index+match[0].length<itemText.length,obj=g.vmMain.pluginManager.parseAttachmentEmbedString(match[1],padBefore,padAfter);itemText=itemText.replaceText(match.index,obj.styledText,match[0].length),hasStyle=!0,hasDiffParse=!0,attachments?attachments.push(obj):attachments=[obj]}return attachments&&(pluginRegexp.lastIndex=0,parsedText=parsedText.replace(pluginRegexp,window.AttachChar)),{text:startText,styledText:itemText,parsedText:hasDiffParse?parsedText:void 0,dates:dates,tags:tags,attachments:attachments,hasStyle:hasStyle,numContacts:contacts.length}};var DAY_LENGTH=864e5;window.DuchessHelpers.computeDateInfo=function(prevDate,changeType,dt,dateString){function getSoftText(date){return 0>diff?diff>=-DAY_LENGTH?"yesterday":date.toString(Date.CultureInfo.formatPatterns.monthDayYear):DAY_LENGTH>=diff&&date.isToday()?"today":2*DAY_LENGTH>diff?"tomorrow":void 0}var prevDateTime=new Date(prevDate).clearTime(),currentDateTime=(new Date).clearTime(),diff=prevDateTime-currentDateTime,finalString=dateString,replacedDate=!1,newDate;if(isFlagSet(changeType,ChangeType.Auto)||isFlagSet(changeType,ChangeType.Remote))if(newDate=new Date(prevDate),void 0!==prevDate&&dt.getTime()!==prevDate||diff>=0&&2*DAY_LENGTH>diff){var softMatch;if(null!==(softMatch=softDateRegexp.exec(dateString))){var transString=getSoftText(newDate);transString&&transString.toUpperCase()!==softMatch[0].toUpperCase()&&(finalString=dateString.replace(softMatch[0],transString),replacedDate=!0)}else if(null!==(softMatch=timeRegexp.exec(dateString))){var transString=getSoftText(newDate);transString&&"today"!==transString&&(finalString=transString+" "+dateString,replacedDate=!0)}}else void 0===prevDate&&(newDate=dt);else newDate=isFlagSet(changeType,ChangeType.Local)?dt:dt;return{text:finalString,date:newDate,replacedDate:replacedDate}};var dToken={repeat:/^(ev(ery)?|after)\b/i,recur:/^(other|first|second|third|fourth|1st|2nd|3rd|4th|last)$/i,day:/^(((sun|mon|tue(s)?|wed(nes)?|thu(rs)?|fri|sat(ur)?)(day)?)(?:,|\sand\s)?)$/i,daysOfWeek:/^(weekday|weekend)$/i,len:/^(day|week|month|year|morning|afternoon|night)$/i,count:/^((\d{1,2})|one|two|three|four|five|six|seven|eight|nine|ten)$/i,month:/^(jan(uary)?|feb(ruary)?|ma((r(ch)?)?|y)|apr(il)?|ju(ly|ne)|aug(ust)?|oct(ober)?|(sept|nov|dec)(ember)?)$/i,at:/^at$/i,of:/^of$/i,"in":/^in$/i,delim:/^and$/i,date:/^((\d{1,2})|([2-5]?1(st)?|[2-5]?2(nd)?|[2-5]?3(rd)?|(0|[1-5]?[4-9]|[1-5]0|1[1-3])(th)?))$/i,year:/^((\d\d)|(\d\d\d\d))$/i,time:timeRegexp,from:/^(from|starting)$/i,until:/^(until)$/i,measure:/^(days|weeks|months|years)$/i},dTokenValue={"1st":1,fir:1,"2nd":2,sec:2,"3rd":3,thi:3,"4th":4,fou:4,sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,days:RepeatFreq.Daily,weeks:RepeatFreq.Weekly,months:RepeatFreq.Monthly,years:RepeatFreq.Yearly},lastToken,dateCharsConsumed=0,dateCharsFromString=0,dateTokens,dateTokenOffset=1,dateParsedDate;return window.DuchessHelpers.parseRepeatDate=function(prevRepeatDate,completedTime,changeType,dateString){var retValue,isDateValid=!1,startDate=Date.today(),endDate,freq=RepeatFreq.Daily,sep=1,offsets,time,dayOrd,wkOrd,monthOrd,yearOrd;
if(dateString.match(dToken.repeat)){setDateTokens(dateString);var parsedRecur=!1;if(checkAndParse(dToken.recur)){switch(lastToken){case"other":sep=2;break;case"last":freq=RepeatFreq.NthMonthInst,wkOrd=-1;break;default:freq=RepeatFreq.NthMonthInst,wkOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()]}parsedRecur=!0}if(parsedRecur&&"other"!==lastToken||!checkAndParse(dToken.date))if(!parsedRecur&&checkAndParse(dToken.count)){var parsedSep=parseInt(lastToken);isNaN(parsedSep)&&(parsedSep=dTokenValue[lastToken]),checkAndParse(dToken.measure)&&(freq=dTokenValue[lastToken.toLowerCase()],sep=parsedSep,isDateValid=!0)}else if(checkAndParse(dToken.day)){freq!==RepeatFreq.NthMonthInst&&(freq=RepeatFreq.Weekly),dayOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()];for(var dayOrdList;(lastToken.endsWith(",")||checkAndParse(dToken.delim))&&checkAndParse(dToken.day);){var nxtDayOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()];dayOrdList?dayOrdList.push(nxtDayOrd):dayOrdList=[dayOrd,nxtDayOrd]}dayOrdList&&(dayOrdList.sort(),offsets=dayOrdList),isDateValid=!0}else if(checkAndParse(dToken.daysOfWeek))freq=RepeatFreq.Weekly,"weekday"===lastToken?offsets=[1,2,3,4,5]:"weekend"===lastToken&&(offsets=[0,6]),isDateValid=!0;else if(checkAndParse(dToken.month)){var monthParsed=lastToken;if(checkAndParse(dToken.date)){var tempMonthOrd=parseInt(lastToken);tempMonthOrd>0&&31>=tempMonthOrd&&(monthOrd=tempMonthOrd,yearOrd=dTokenValue[monthParsed.substr(0,3).toLowerCase()],freq=RepeatFreq.Yearly,isDateValid=!0)}}else if(parsedRecur&&"other"!==lastToken||!checkAndParse(dToken.len))if(parsedRecur&&"last"!==lastToken||!checkAndParse(dToken.len))parsedRecur&&"other"!==lastToken&&(freq=RepeatFreq.DayOfMonth,monthOrd=wkOrd,wkOrd=void 0,isDateValid=!0);else switch(lastToken){case"day":isDateValid=!0,freq=RepeatFreq.EndOfMonthOffset}else{switch(lastToken){case"day":freq=RepeatFreq.Daily;break;case"week":freq=RepeatFreq.Weekly;break;case"month":freq=RepeatFreq.Monthly;break;case"year":freq=RepeatFreq.Yearly;break;case"morning":freq=RepeatFreq.Daily,time="9:00am";break;case"afternoon":freq=RepeatFreq.Daily,time="2:00pm";break;case"night":freq=RepeatFreq.Daily,time="7:00pm"}isDateValid=!0}else{var dateParsed=parseInt(lastToken);dateParsed>0&&31>=dateParsed&&(isNaN(dateParsed)||(freq=RepeatFreq.DayOfMonth,monthOrd=dateParsed,isDateValid=!0),checkAndParse(dToken.measure)?(freq=dTokenValue[lastToken.toLowerCase()],sep=dateParsed,monthOrd=void 0,isDateValid=!0):(checkAndParse(dToken.of),checkAndParse(dToken.month)&&(monthOrd=dateParsed,yearOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()],freq=RepeatFreq.Yearly,isDateValid=!0)))}var atParsed=!1;checkAndParse(dToken.at)&&(atParsed=!0),checkAndParse(dToken.time,2)&&(time=lastToken,isDateValid=!0);var implicitFrom=!1,inParsed=!1;if(checkAndParse(dToken.in)){inParsed=!0;var inMonth,inYear;checkAndParse(dToken.month)&&(inMonth=dTokenValue[lastToken.substr(0,3).toLowerCase()]),checkAndParse(dToken.year)&&(inYear=parseInt(lastToken)),(void 0!==inMonth||void 0!==inYear)&&(endDate=new Date,fromDate=new Date,implicitFrom=!0,inYear&&(endDate.setYear(inYear),endDate.setMonth(11),fromDate.setYear(inYear),fromDate.setMonth(0)),void 0!==inMonth&&(void 0!==inYear&&(endDate.getMonth()>inMonth&&endDate.addYears(1),fromDate.getMonth()>inMonth&&fromDate.addYears(1)),endDate.setMonth(inMonth),fromDate.setMonth(inMonth)),endDate.moveToLastDayOfMonth(),fromDate.setDate(1))}var fromDate,fromDateOffset=dateCharsConsumed+1,fromOffset=dateCharsConsumed;checkAndParse(dToken.from)?(fromDateOffset=dateCharsConsumed+1,checkAndParseDate()&&((!implicitFrom||dateParsedDate.isAfter(fromDate))&&(fromDate=dateParsedDate),implicitFrom=!1,dateCharsFromString=dateCharsConsumed)):dateCharsFromString=dateCharsConsumed;var postParsed=!1;atParsed||time||(checkAndParse(dToken.at)&&(atParsed=!0,postParsed=!0),checkAndParse(dToken.time,2)&&(time=lastToken,postParsed=!0)),inParsed||checkAndParse(dToken.until)&&checkAndParseDate()&&(endDate=dateParsedDate,postParsed=!0),endDate&&endDate.isBefore(fromDate)&&(isDateValid=!1)}else"everyday"===dateString&&(setDateTokens(dateString),isDateValid=!0,freq=RepeatFreq.Daily,sep=1);if(isDateValid){var prevStartDate=getRepeatStartDate(prevRepeatDate),computeFromDate=isFlagSet(changeType,ChangeType.Remote)?prevStartDate:fromDate;if(offsets&&freq===RepeatFreq.Weekly)for(var currentDayOrd=(computeFromDate||new Date).getDay(),i=0;i<offsets.length;++i)if(offsets[i]>=currentDayOrd){dayOrd=offsets[i];break}var startDate=computeStartDate(dayOrd,wkOrd,monthOrd,yearOrd,time,computeFromDate),isValidStartDate=!!startDate;if(startDate&&(startDate.isBefore(minStartDate)&&(isValidStartDate=!1),endDate&&endDate.isBefore(startDate)&&(isValidStartDate=!1)),isValidStartDate){var replacedStartDate,finalDateString=dateString.substr(0,dateCharsConsumed),fromString;if(!completedTime&&fromDate&&prevRepeatDate&&!implicitFrom){fromString=dateString.substr(fromDateOffset,dateCharsFromString);var newFromDateInfo=window.DuchessHelpers.computeDateInfo(prevStartDate,changeType,fromDate,fromString);newFromDateInfo.replacedDate&&(fromString=newFromDateInfo.text)}else completedTime&&completedTime!==forceCompleteTime&&(isFlagSet(changeType,ChangeType.Text)||(fromString=new Date(completedTime).toString(Date.CultureInfo.formatPatterns.shortDate)));if(fromString){var origString=dateString.substr(fromDateOffset,dateCharsFromString);if(origString.toUpperCase()!==fromString.toUpperCase()){var repStart=Date.parse(fromString);repStart&&(replacedStartDate=repStart.getTime(),finalDateString=finalDateString.substr(0,fromOffset)+" from "+fromString+(postParsed?finalDateString.substr(dateCharsFromString):""))}}retValue={type:DateType.Repeat,repLength:dateCharsConsumed,text:finalDateString,startDate:replacedStartDate||startDate,endDate:endDate,frequency:freq,separation:sep,offsets:offsets,replacedStartDate:replacedStartDate}}}return retValue},window.DuchessHelpers}),define("VMLI_Text",["ko","data","gdata","globals","tracker","android","RepeatDate","DuchessHelpers"],function(ko,d,gdata,g,tracker,android,RepeatDate){var VMLI_Text={_runAndGetSaveData:function _runAndGetSaveDataFn(text,immediateParse,changeType){if(this.shouldSave())var oldMetaData=this.getMetaTextSaveData();if(this.setRawText(this.generateSaveText(text)),this.parseText(immediateParse,changeType),this.shouldSave()){var newMetaData=this.getMetaTextSaveData(),saveData={};for(var key in newMetaData)oldMetaData[key]!==newMetaData[key]&&(saveData[key]=newMetaData[key])}return saveData},setText:function setTextFn(text,immediateParse,changeType,fromAndroidEditing){changeType|=ChangeType.Text;var saveData=this._runAndGetSaveData(text,immediateParse,changeType);this.shouldSave()&&(saveData.text=this.generateSaveText(text),gdata.saveChanges(this,saveData),saveData.dateText=this.dateText,this.save(saveData,SaveFlag.Text),immediateParse&&!fromAndroidEditing&&android.isEnabled()&&android.updateInputText(this))},generateSaveText:function generateSaveTextFn(text){return this._generateUsableText(text,"getEmbedString")},generateTitleText:function generateTitleTextFn(text){return this._generateUsableText(text,"getTitleString")},_generateUsableText:function _generateUsableTextFn(text,fnName){try{g.PAssert(2166,this.hasAttachments()||text.indexOf(window.AttachChar)<0,"Should either have attachments or no embedded attachment chars")}catch(PERR){g.reportError(PERR)}var outText=text;if(this.hasAttachments()&&text.indexOf(window.AttachChar)>=0){var attachIndex=0,maxAttachIndex=this.getNumAttachments();outText=text.replace(/\u2000/g,function(){if(maxAttachIndex>attachIndex){var attach=this.getAttachment(attachIndex);return attachIndex++,attach[fnName]()}return window.AttachChar}.bind(this));try{g.PAssert(2167,outText.indexOf(window.AttachChar)<0,"Should convert all attachments to their string form")}catch(PERR){g.reportError(PERR)}}return outText},splitUsableText:function splitUsableTextFn(text,startSplitIndex,endSplitIndex){try{g.PAssert(2168,this.hasAttachments()||text.indexOf(window.AttachChar)<0,"Should either have attachments or no embedded attachment chars")}catch(PERR){g.reportError(PERR)}var usableText=text.substring(0,startSplitIndex)+text.substring(endSplitIndex),splitIndex=startSplitIndex;if(this.hasAttachments()&&text.indexOf(window.AttachChar)>=0){var attachIndex=0,maxAttachIndex=this.getNumAttachments();usableText=text.replace(/\u2000/g,function(match,offset){if(maxAttachIndex>attachIndex){var attach=this.getAttachment(attachIndex);attachIndex++;var replaceStr=attach.getEmbedString();return startSplitIndex>offset&&(splitIndex+=Math.max(replaceStr.length-1,0)),replaceStr}return window.AttachChar}.bind(this));try{g.PAssert(2169,usableText.indexOf(window.AttachChar)<0,"Should convert all attachments to their string form")}catch(PERR){g.reportError(PERR)}}var outData={before:usableText.substring(0,splitIndex),after:usableText.substring(splitIndex)};return outData},parseText:function parseTextFn(immediateParse,changeType,changedStyles){try{g.PAssert(2170,immediateParse,"Currently we only support immediate parsing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2171,g.isValidChangeType(changeType),"Must specify a valid changetype")}catch(PERR){g.reportError(PERR)}var styleInfo;if(immediateParse)styleInfo=window.DuchessHelpers.parseText(this.getRawText(),this.getDateTime(),this.getRepeatDate(),this.getDateCompletedTime(),changeType,d.contactManager.getContacts()),g.isFlagSet(changeType,ChangeType.Local)&&styleInfo.numContacts>0&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddContact,data:[{itemID:this.id}]});else try{g.PAssert(2172,!1,"Should always be using immediate parse")}catch(PERR){g.reportError(PERR)}return this.styleText(styleInfo,immediateParse,changeType,changedStyles)},styleText:function styleTextFn(styleInfo,parsedFull,changeType,changedStyles){try{g.PAssert(2173,parsedFull,"Currently we only support full parses")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2174,g.isValidChangeType(changeType),"Must specify a valid changetype")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2175,!(!styleInfo&&parsedFull),"In a full parse, styleInfo should always be defined")}catch(PERR){g.reportError(PERR)}var styleChanges=!1,text;if(styleInfo){if(text=void 0!==styleInfo.styledText?styleInfo.styledText:void 0!==styleInfo.text?styleInfo.text:this.getRawText(),parsedFull&&this.setParsedText(styleInfo.parsedText),styleInfo.dates){0===styleInfo.dates.length&&(this.date()||this.repeatDate())&&(this.dateText=void 0,this.repeatDate()&&!this.isForceCompleted()&&(this.dateCompleted=void 0,changedStyles&&(styleChanges=!0,changedStyles.dateCompleted=void 0)),this.date(null),this.repeatDate(null),changedStyles&&(styleChanges=!0,changedStyles.date=void 0,changedStyles.dateText=void 0,changedStyles.repeatDate=void 0));for(var i=0;i<styleInfo.dates.length;i++){var dt=styleInfo.dates[i];if(dt.type===DateType.Once)this.dateText!==dt.text&&(this.dateText=dt.text,changedStyles&&(styleChanges=!0,changedStyles.dateText=dt.text)),dt.date&&this.date()&&dt.date==this.date()||(!!dt.date^!!this.date()||this.date()&&dt.date.getTime()!==this.date().getTime())&&(this.date(dt.date),changedStyles&&(styleChanges=!0,changedStyles.date=dt.date)),this.repeatDate()&&(this.repeatDate(null),changedStyles&&(styleChanges=!0,changedStyles.repeatDate=void 0));else if(dt.type===DateType.Repeat){this.dateText!==dt.text&&(this.dateText=dt.text,changedStyles&&(styleChanges=!0,changedStyles.dateText=dt.text));var rDate=new RepeatDate(dt);(!this.repeatDate()||!rDate.equals(this.repeatDate())||!!rDate^!!this.repeatDate())&&((!rDate||this.repeatDate()&&!this.repeatDate().getStartDate().equals(rDate.getStartDate()))&&(this.isForceCompleted()||(this.dateCompleted=void 0,changedStyles&&(styleChanges=!0,changedStyles.dateCompleted=void 0))),this.repeatDate(rDate),changedStyles&&(styleChanges=!0,changedStyles.repeatDate=rDate.toString())),this.date()&&(this.date(null),changedStyles&&(styleChanges=!0,changedStyles.date=void 0))}}}else(this.date()||this.repeatDate())&&parsedFull&&(this.dateText=void 0,this.repeatDate()&&!this.isForceCompleted()&&(this.dateCompleted=void 0,changedStyles&&(styleChanges=!0,changedStyles.dateCompleted=void 0)),this.date(null),this.repeatDate(null),changedStyles&&(styleChanges=!0,changedStyles.date=void 0,changedStyles.dateText=void 0,changedStyles.repeatDate=void 0));if((styleInfo.tags||this._activeTags)&&this.setTags(styleInfo.tags),styleInfo.attachments||this.getAttachments()){for(var newAttachments=[],newClasses="",i=0;styleInfo.attachments&&i<styleInfo.attachments.length;++i){var newAttach=g.vmMain.pluginManager.getAttachment(styleInfo.attachments[i]);newAttach&&newAttachments.push(newAttach)}this.setAttachments(newAttachments,changeType)}this.isStyled=styleInfo.hasStyle}else text=this.getRawText();return text&&0!==text.length||(text=TextSpace,parsedFull=!0),this.setStyledText(text),styleChanges}};return VMLI_Text}),define("VMLI_Drive",["globals","data","gdata","tracker","RepeatDate"],function(g,d,gdata,tracker,RepeatDate){var VMLI_Drive=function(VMLI){function iterateRemoteLink(remoteItem){gdata.cacheItem(remoteItem),iterateLink(gdata.get(remoteItem,"items")),iterateLink(gdata.get(remoteItem,"archivedItems"))}function iterateLink(itemArray){if(itemArray)for(var i=0;i<itemArray.length;++i){var item=itemArray.get(i);try{g.PAssert(2188,item,"Item must exist to get it from the array")}catch(PERR){g.reportError(PERR)}if(item){var localItem=d.getModel(item.id);localItem?localItem.linkToGDrive(item):iterateRemoteLink(item)}else g.reportError(new Error("Removing undefined/null value form remote list")),itemArray.remove(i),i--}}function linkNote(note){if(note){var localItem=d.getModel(note.id);localItem?localItem.linkToGDrive(note):gdata.cacheItem(note)}}return{linkToGDrive:function linkToGDriveFn(data,overwriteFromRemote){try{g.PAssert(2189,data,"Must be passing in valid data")}catch(PERR){g.reportError(PERR)}if(!this.data){if(data){try{g.PAssert(2190,void 0===data.connectIdentifier,"Should never have a connect identifier present during link")}catch(PERR){g.reportError(PERR)}data.connectIdentifier=gdata.connectIdentifier(),this.data=data,gdata.cacheItem(data)}this.setRemoteVersion(VersionType.Structure,gdata.getVersion(data,VersionType.Structure)),this.setRemoteVersion(VersionType.Text,gdata.getVersion(data,VersionType.Text)),overwriteFromRemote&&(this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text))),linkNote(gdata.get(data,"note")),iterateLink(gdata.get(data,"items")),iterateLink(gdata.get(data,"archivedItems"))}},resetModified:function resetModifiedFn(){var i;try{g.PAssert(2191,this.data,"Can only reset modified if remote data exists")}catch(PERR){g.reportError(PERR)}var remoteChanged=!1,versionChanges={};if(!this.modifiedOffline&&this.isRemoteVersionNewer(VersionType.Structure)){var remoteVersion=this.getRemoteVersion(VersionType.Structure);this.setVersion(VersionType.Structure,remoteVersion),versionChanges.version=remoteVersion,remoteChanged=!0}else this.modifiedOffline&&(versionChanges.modifiedOffline=!1,remoteChanged=!0);if(!this.modifiedOfflineText&&this.isRemoteVersionNewer(VersionType.Text)){var remoteVersionText=this.getRemoteVersion(VersionType.Text);this.setVersion(VersionType.Text,remoteVersionText),versionChanges.versionText=remoteVersionText,remoteChanged=!0}else this.modifiedOfflineText&&(versionChanges.modifiedOfflineText=!1,remoteChanged=!0);remoteChanged&&this.save(versionChanges,SaveFlag.None),this.setRemoteVersion(VersionType.Structure,void 0),this.setRemoteVersion(VersionType.Text,void 0);var items=this.items();for(i=0;i<items.length;++i)items[i].resetModified();if(this.hasArchivedChildren()){var archivedItems=this.archivedItems(!0);for(i=0;i<archivedItems.length;++i)archivedItems[i].resetModified()}},initFromGDrive:function initFromGDriveFn(data){try{g.PAssert(2194,data,"To initialize from gdrive a valid remote data object must be passed in")}catch(PERR){g.reportError(PERR)}if(!data)return void g.reportError(new Error("FATAL ERROR - No remote data for item"));if(this.data=data,data.connectIdentifier)try{g.PAssert(2197,data.connectIdentifier===gdata.connectIdentifier(),"Should never have a connect identifier present during link")}catch(PERR){g.reportError(PERR)}else data.connectIdentifier=gdata.connectIdentifier();var needsFullSave=void 0===this.id||this.forceModifiedItems,remoteChanges=needsFullSave?void 0:{},needsParsing=!1;this.id=data.id,g.topLevelInitId||(g.topLevelInitId=this.id);try{needsParsing=this.resolveMisc(remoteChanges)||needsParsing,needsParsing=this.resolveText(remoteChanges)||needsParsing,needsParsing&&(g.vmMain.addParseItem(this,ChangeType.Remote|ChangeType.All),g.vmMain.addModifiedItem(this)),this.resolveItems(remoteChanges)}catch(err){g.reportError(err)}if(g.topLevelInitId===this.id&&(g.topLevelInitId=void 0),needsFullSave){try{g.PAssert(2198,void 0===remoteChanges,"If doing a full save, remoteChanges should always be undefined")}catch(PERR){g.reportError(PERR)}this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text)),this.save(null,SaveFlag.None)}else g.isEmpty(remoteChanges)||(remoteChanges.isDeleted!==!0&&(remoteChanges.isDeleted=void 0),this.save(remoteChanges,SaveFlag.None));gdata.attachEventsToItem(this)},resolveText:function resolveTextFn(remoteChanges){var needsParsing=!1;if(this.modifiedOfflineText&&!this.forceModifiedItems)if(this.isLocalVersionNewer(VersionType.Text))gdata.saveChanges(this,{text:this.getParsedText()});else{var remoteText=gdata.get(this.data,"text");try{g.PAssert(2199,void 0!==remoteText,"Every item should have text associated with it from gdrive")}catch(PERR){g.reportError(PERR)}var localText=this.getRawText(),needDupe=!1;if(localText!==remoteText&&(needDupe=!0),needDupe){var thisIndex=this.getIndex(),newItem=new VMLI({text:this.getParsedText()},{parent:this.parent(),forceSave:!0,changeType:ChangeType.Auto});this.parent().insertItem(newItem,thisIndex+1),this.setText(remoteText,!0,ChangeType.Remote),remoteChanges&&(remoteChanges.text=this.getParsedText())}else remoteChanges&&(remoteChanges.modifiedOfflineText=!1);remoteChanges&&(remoteChanges.versionText=this.getRemoteVersion(VersionType.Text))}else if(this.isRemoteVersionNewer(VersionType.Text)){var remoteText=gdata.get(this.data,"text");try{g.PAssert(2200,void 0!==remoteText,"Every item should have text associated with it from gdrive")}catch(PERR){g.reportError(PERR)}this.getRawText()!==remoteText&&(this.setRawText(remoteText),remoteChanges&&(remoteChanges.text=this.getRawText()),this.isVersionUninitialized(VersionType.Text)||(needsParsing=!0)),remoteChanges&&this.getVersion(VersionType.Text)!==this.getRemoteVersion(VersionType.Text)&&(remoteChanges.versionText=this.getRemoteVersion(VersionType.Text))}return needsParsing},resolveMisc:function resolveMiscFn(remoteChanges){var useLocal=this.modifiedOfflineText&&this.isLocalVersionNewer(VersionType.Text),needsParsing=!1,modLocal=!1;if(useLocal||this.isRemoteVersionNewer(VersionType.Structure)||this.isRemoteVersionNewer(VersionType.Text)){var localChanges={},remoteDate=gdata.get(this.data,"date");if((remoteDate||this.date())&&(!this.date()||this.date().getTime()!==remoteDate))if(useLocal&&this.date())localChanges.date=this.date().getTime(),modLocal=!0;else{var newDate=new Date(remoteDate);this.date(newDate,!0),remoteChanges&&(remoteChanges.date=this.date().getTime()),this.isVersionUninitialized(VersionType.Text)||(needsParsing=!0)}var remoteRepeatDate=gdata.get(this.data,"repeatDate");if(!(!remoteRepeatDate&&!this.repeatDate()||this.repeatDate()&&this.repeatDate().equals(remoteRepeatDate)))if(useLocal&&this.repeatDate())localChanges.repeatDate=this.repeatDate().toString(),modLocal=!0;else{var newRepeatDate=new RepeatDate(remoteRepeatDate);this.repeatDate(newRepeatDate,!0),remoteChanges&&(remoteChanges.repeatDate=this.repeatDate().toString()),this.isVersionUninitialized(VersionType.Text)||(needsParsing=!0)}var remoteDateCreated=gdata.get(this.data,"dateCreated");if(!this.dateCreated||!remoteDateCreated||this.dateCreated.getTime()!==remoteDateCreated)if(useLocal)localChanges.dateCreated=this.dateCreated?this.dateCreated.getTime():void 0,modLocal=!0;else{var rDate=remoteDateCreated;try{g.PAssert(2201,"string"!=typeof remoteDateCreated,"Invalid date format stored")}catch(PERR){g.reportError(PERR)}this.dateCreated=new Date(rDate),remoteChanges&&(remoteChanges.dateCreated=rDate)}var remoteDateCompleted=gdata.get(this.data,"dateCompleted");if(!(!remoteDateCompleted&&!this.dateCompleted||this.dateCompleted&&remoteDateCompleted&&this.dateCompleted.getTime()===remoteDateCompleted))if(useLocal)localChanges.dateCompleted=this.dateCompleted?this.dateCompleted.getTime():void 0,modLocal=!0;else{var rDate=remoteDateCompleted;try{g.PAssert(2202,"string"!=typeof remoteDateCompleted,"Invalid date format stored")}catch(PERR){g.reportError(PERR)}this.dateCompleted=new Date(rDate),remoteChanges&&(remoteChanges.dateCompleted=rDate)}var remotePriority=gdata.get(this.data,"priority");(remotePriority||this.priority())&&this.priority()!==remotePriority&&(useLocal?(localChanges.priority=this.priority(),modLocal=!0):(null===remotePriority&&(remotePriority=VMLIFlag.None),this.priority(remotePriority,!0)));var remoteStarred=gdata.get(this.data,"isStarred");(remoteStarred||this.isStarred())&&this.isStarred()!==remoteStarred&&(useLocal?(localChanges.isStarred=this.isStarred(),modLocal=!0):(null===remoteStarred&&(remoteStarred=!1),this.isStarred(remoteStarred,!0)));var remoteComplete=gdata.get(this.data,"isComplete");if((remoteComplete||this.isComplete())&&this.isComplete()!==remoteComplete&&(useLocal?(localChanges.isComplete=this.isComplete(),modLocal=!0):(null===remoteComplete&&(remoteComplete=!1),this.isComplete(remoteComplete,!0))),useLocal){try{g.PAssert(2203,modLocal===!g.isEmpty(localChanges),"Verify modLocal is computed properly. It should track any changes to localChanges")}catch(PERR){g.reportError(PERR)}modLocal===!0&&gdata.saveChanges(this,localChanges)}}return needsParsing},resolveNote:function resolveNoteFn(remoteChanges){var remoteItem=gdata.get(this.data,"note"),localModel=this.hasNote()?this.getNote():void 0;if(remoteItem)if(localModel)localModel.initFromGDrive(remoteItem);else{var localItem=d.getItem(remoteItem.id);if(localItem){if(localItem.isDeleted){try{g.PAssert(2204,g.isReconnected||!localModel,"The local model should never exist when an item has been marked as deleted locally")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2205,localItem.modifiedOffline,"How did the note get deleted if it wasn't modified offline?")}catch(PERR){g.reportError(PERR)}gdata.getVersion(remoteItem,VersionType.Structure)==localItem.version?gdata.noteSet(this,void 0):(localModel=new VMLI({data:remoteItem,isNote:!0},{parent:this,forceSave:!0,changeType:ChangeType.Remote}),d.undeleteItem(localModel),this.setNote(localModel,!0),g.vmMain.addModifiedItem(localModel))}}else localModel=new VMLI({data:remoteItem,isNote:!0},{parent:this,forceSave:!0,changeType:ChangeType.Remote}),this.setNote(localModel,!0),g.vmMain.addModifiedItem(localModel)}else localModel&&(d.initializeItem(localModel),gdata.noteSet(this,localModel))},resolveItemsHelper:function resolveItemsHelperFn(resolveArchived,remoteChanges){var i,remoteItem,localIndex,localItem,localModel,saveItemLists,collabItemList=gdata.getItemList(this.data,resolveArchived),itemArray;itemArray=resolveArchived?this.hasArchivedChildren()?this.archivedItems(!0):[]:this.items();try{g.PAssert(2206,itemArray,"Item arrays must exist")}catch(PERR){g.reportError(PERR)}for(i=0;collabItemList&&i<collabItemList.length;i++)if(remoteItem=collabItemList.get(i)){try{g.PAssert(2208,void 0===gdata.loadSeen[remoteItem.id]||gdata.loadSeen[remoteItem.id]===!1,"Items can only be seen once on the remote.")}catch(PERR){g.reportError(PERR)}gdata.loadSeen[remoteItem.id]=this.id;var localIndex=this.getIndexOf(remoteItem.id,resolveArchived);if(localIndex>=0)localModel=itemArray[localIndex],localModel.initFromGDrive(remoteItem);else if(localItem=d.getItem(remoteItem.id),localModel=d.getModel(remoteItem.id),localItem)if(localItem.isDeleted){try{g.PAssert(2209,g.isReconnected||!localModel,"The local model should never exist when an item has been marked as deleted locally")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2210,localItem.modifiedOffline,"How did the item get deleted if it wasn't modified offline?")}catch(PERR){g.reportError(PERR)}if(gdata.getVersion(remoteItem,VersionType.Structure)==localItem.version){gdata.itemRemoved({item:this,index:i,numToRemove:1,isArchived:resolveArchived});var childItem;i--}else{try{g.PAssert(2211,g.isReconnected||!localModel,"The local model should never exist when an item has been marked as deleted locally")}catch(PERR){g.reportError(PERR)}localModel=new VMLI({data:remoteItem,isArchived:resolveArchived},{parent:this,forceSave:!0,changeType:ChangeType.Remote}),d.undeleteItem(localModel),itemArray.splice(i,0,localModel),saveItemLists=!0,g.vmMain.addModifiedItem(localModel)}}else if(localModel&&localModel.modifiedOffline)if(localModel.isLocalVersionNewer(VersionType.Structure)){try{g.PAssert(2212,gdata.loadSeen[remoteItem.id]===this.id)}catch(PERR){g.reportError(PERR)}gdata.loadSeen[remoteItem.id]=!1}else localModel.moveTo({parent:this,index:i,isRemoteChange:!0,shouldBeArchived:resolveArchived}),localModel.initFromGDrive(remoteItem),saveItemLists=!0,g.vmMain.addModifiedItem(localModel);else localModel?(localModel.moveTo({parent:this,index:i,isRemoteChange:!0,shouldBeArchived:resolveArchived}),localModel.initFromGDrive(remoteItem),saveItemLists=!0,g.vmMain.addModifiedItem(localModel)):g.reportError(new Error("Local model does not exist for local item that was not deleted."));else localModel=new VMLI({data:remoteItem,isArchived:resolveArchived},{parent:this,forceSave:!0,changeType:ChangeType.Remote}),itemArray.splice(i,0,localModel),saveItemLists=!0,g.vmMain.addModifiedItem(localModel)}else try{g.PAssert(2207,remoteItem,"Item in remote list does not exist")}catch(PERR){g.reportError(PERR)}if(d.hasLocalData){for(i=0;i<itemArray.length;i++)if(localModel=itemArray[i],gdata.loadSeen[localModel.id]!==this.id)if(remoteItem=localModel.data){if(localModel.modifiedOffline&&localModel.isLocalVersionNewer(VersionType.Structure)){var inTree=gdata.findInTree(remoteItem);try{g.PAssert(2219,inTree,"Item should be found in tree")}catch(PERR){g.reportError(PERR)}if(inTree){var oldParentModel;gdata.itemMoved({item:localModel,newInfo:{index:i,isArchived:resolveArchived},oldParent:inTree.parent,oldInfo:inTree})}localModel.initFromGDrive(remoteItem)}}else if(localModel.modifiedOfflineText){var childrenToRemove=[],localChildren;if(resolveArchived?localModel.hasArchivedChildren()&&(localChildren=localModel.archivedItems(!0)):localChildren=localModel.items(),localChildren)for(var j=0;j<localChildren.length;++j)if(localChildren[j].data&&localChildren[j].isLocalVersionNewer(VersionType.Structure)){var inTree=gdata.findInTree(localChildren[j].data);try{g.PAssert(2214,inTree,"Item should be found in tree")}catch(PERR){g.reportError(PERR)}inTree&&childrenToRemove.push({parent:inTree.parent,child:localChildren[j]})}d.initializeItem(localModel),gdata.itemAdded({item:this,addedItem:localModel,index:i,isArchived:resolveArchived});for(var j=0;j<childrenToRemove.length;++j){var removeData=childrenToRemove[j];try{g.PAssert(2215,removeData,"Must have valid data to remove")}catch(PERR){g.reportError(PERR)}var isArchived=removeData.child.isArchived(),remoteList=gdata.getItemList(removeData.parent,isArchived);try{g.PAssert(2216,remoteList,"The item has children, it must have a list")}catch(PERR){g.reportError(PERR)}var index=remoteList.indexOf(removeData.child.data);try{g.PAssert(2217,index>=0,"Remote item must be in the parents list")}catch(PERR){g.reportError(PERR)}gdata.itemRemoved({item:removeData.parent,index:index,numToRemove:1,isArchived:isArchived})}localModel.initFromGDrive(localModel.data)}else{try{g.PAssert(2218,d.getItem(localModel.id),"Trying to delete an item locally that doesn't exist locally")}catch(PERR){g.reportError(PERR)}this.deleteChild(localModel),i--,saveItemLists=!0,g.vmMain.addModifiedItem(localModel)}if(!resolveArchived&&collabItemList&&(collabItemList.length>0||itemArray.length>0)){var localModArray=[],nonSharedArray,tempArray=[],remoteArray=collabItemList.asArray(),reorderFound=!1;for(i=0;i<remoteArray.length;++i){var tempID=remoteArray[i].id,tempModel=d.getModel(tempID);try{g.PAssert(2220,tempModel,"If the remote ID exists the local item should have been created.")}catch(PERR){g.reportError(PERR)}var localIndex=this.getIndexOf(tempID);tempModel&&tempModel.modifiedOffline&&tempModel.isLocalVersionNewer(VersionType.Structure)?localIndex>=0?localModArray.push(localIndex):(nonSharedArray||(nonSharedArray=[]),log(this.id+": Item in remote array not found in local array: ",tempID),nonSharedArray.push(tempID)):localIndex>=0?(tempArray.push(tempID),localIndex!==i&&(reorderFound=!0)):(nonSharedArray||(nonSharedArray=[]),log(this.id+": Item in remote array not found in local array: ",tempID),nonSharedArray.push(tempID))}if(reorderFound||localModArray.length>0){var tempArrayText;for(localModArray.sort(),i=0;i<localModArray.length;i++){var localItem=itemArray[localModArray[i]];localItem&&tempArray.splice(localModArray[i],0,localItem.id);var tempArrayText}nonSharedArray&&nonSharedArray.length>0&&(tempArray=tempArray.concat(nonSharedArray));var remoteArrayText,localArrayText,tempArrayText,remoteArrayText;for(i=0;i<tempArray.length;++i)for(var searchItem=tempArray[i],j=i;j<collabItemList.length;++j){var findItem=collabItemList.get(j);if(searchItem===findItem.id){if(i!==j){var lModel=d.getModel(findItem.id),oldInfo={index:j,isArchived:!1},newInfo={index:i,isArchived:!1};gdata.itemMoved({item:lModel,newInfo:newInfo,oldParent:this,oldInfo:oldInfo}),saveItemLists=!0,g.vmMain.addModifiedItem(lModel);var remoteArrayText}break}}var localArrayText;for(i=0;i<tempArray.length;++i)for(var searchItem=tempArray[i],j=i;j<itemArray.length;++j){var findItem=itemArray[j];if(searchItem===findItem.id){if(i!==j){findItem.moveTo({parent:this,index:i,isRemoteChange:!0,shouldBeArchived:!1}),saveItemLists=!0,g.vmMain.addModifiedItem(findItem);var localArrayText}break}}}}}saveItemLists&&(resolveArchived?this.hasArchivedChildren()&&this.archivedItems().valueHasMutated():this.items.valueHasMutated(),resolveArchived&&!this.hasArchivedChildren()&&this.archivedItems()(itemArray),remoteChanges&&(remoteChanges.items=this.getItemsArrayForSave()))},resolveItems:function resolveItemsFn(remoteChanges){this.resolveItemsHelper(!1,remoteChanges),this.resolveItemsHelper(!0,remoteChanges),this.resolveNote(remoteChanges)},onValueChanged:function onValueChangedFn(event){if(!event.isLocal||tracker.undoRedoActive){var mappedProperty=g.translateFieldOut(event.property);if(this.id===event.target.id){var needsParse=!1;switch(mappedProperty){case"version":case"versionText":var remoteVersion=gdata.get(this.data,mappedProperty);if(remoteVersion>this[mappedProperty]||void 0===this[mappedProperty]){var changes={modifiedOffline:!1};changes[mappedProperty]=this[mappedProperty]=remoteVersion,this.save(changes,SaveFlag.None)}break;case"priority":this.priority(event.newValue,!0);break;case"isComplete":this.isComplete(event.newValue,!0);break;case"isStarred":this.isStarred(event.newValue,!0);break;case"dateCompleted":this.dateCompleted=event.newValue?new Date(event.newValue):null,this.save({dateCompleted:event.newValue},SaveFlag.None),needsParse=!0;break;case"isArchived":this.isArchived(event.newValue),this.save({isArchived:event.newValue},SaveFlag.None);break;case"date":this.date(event.newValue?new Date(event.newValue):null,!0),this.save({date:event.newValue},SaveFlag.None);break;case"repeatDate":this.repeatDate(event.newValue?new RepeatDate(event.newValue):null,!0),this.save({repeatDate:event.newValue},SaveFlag.None),needsParse=!0;
break;case"allDayDate":break;case"note":event.newValue?this.addRemoteNote(event.newValue):this.removeRemoteNote();break;case"items":case"archivedItems":var isArchived=!("items"===mappedProperty);if(event.newValue)for(var i=0;i<event.newValue.length;++i)this.addRemoteItem(event.newValue.get(i),i,isArchived);else{try{g.PAssert(2227,0===event.oldValue.length,"Expected no items in list")}catch(PERR){g.reportError(PERR)}this.removeAllRemoteItems(isArchived)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None);break;case"dateCreated":break;case"text":this.onTextChanged(event);break;default:ShouldLog(LogLevels.Error)&&log("Unhandled value changed remotely: ",mappedProperty,event)}needsParse&&this.parseText(!0,ChangeType.Remote|ChangeType.Property)}}},onTextChanged:function onTextChangedFn(event){if(!event.isLocal||tracker.undoRedoActive){var remoteText=gdata.get(this.data,"text");if(remoteText!==this.getRawText()&&(this.setRawText(remoteText),this.parseText(!0,ChangeType.Remote|ChangeType.Text),this.save({text:this.getRawText()},SaveFlag.None),tracker.undoRedoActive)){var evType=TrackerType.SetText;tracker.notifyStateChangedFromUndoRedo(evType,{itemID:this.id,position:g.findFirstDiff(event.newValue,event.oldValue),text:event.newValue})}}},addRemoteItem:function addRemoteItemFn(remoteItem,index,isArchived){var remoteID=remoteItem.id;gdata.cacheItem(remoteItem);var localList=isArchived?this.archivedItems():this.items;if(index<localList().length&&localList()[index].id===remoteID)return void log("Skipping addRemoteItem - "+index+" vs. "+localList().length);var vmli=d.getModel(remoteID);vmli||(vmli=new VMLI({data:remoteItem},{parent:this,changeType:ChangeType.Remote})),vmli.isDeleted&&(vmli.isDeleted(!1),vmli.save(null,SaveFlag.None)),vmli.isArchived()!==isArchived&&(vmli.isArchived(isArchived),vmli.save({isArchived:isArchived},SaveFlag.None)),vmli.parent(this),localList.splice(index,0,vmli),g.fireCustomEvent("itemAdded",{item:vmli,force:!0}),g.timeline.notifyStateChanged(vmli),tracker.undoRedoActive&&tracker.notifyStateChangedFromUndoRedo(TrackerType.Create,{itemID:vmli.id,parent:this.id,position:index,text:gdata.get(remoteItem,"text")})},removeAllRemoteItems:function(isArchived){isArchived?this.hasArchivedChildren()&&this.archivedItems()([]):this.items([])},removeRemoteItem:function removeRemoteItemFn(remoteItem,index,isArchived,isActualDelete){var localList;if(isArchived){try{g.PAssert(2228,this.hasArchivedChildren(),"Must have a valid item list to remove from")}catch(PERR){g.reportError(PERR)}localList=this.archivedItems()}else localList=this.items;var localItem=localList()[index];if(localItem&&localItem.id===remoteItem.id){try{g.PAssert(2229,localItem,"Expect a valid local item to remove")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2230,remoteItem.id===localItem.id,"Remote item should match local items")}catch(PERR){g.reportError(PERR)}if(tracker.undoRedoActive){var prevItem=g.getPreviousItem(localItem);tracker.notifyStateChangedFromUndoRedo(TrackerType.Delete,{itemID:localItem.id,parent:this.id,position:index,previous:prevItem?prevItem.id:void 0})}localList.splice(index,1),isActualDelete&&(d.deleteItem(localItem),g.timeline.notifyStateChanged(localItem))}},addRemoteNote:function addRemoteNoteFn(remoteNote){try{g.PAssert(2231,!this.hasNote(),"State of note should always match when adding")}catch(PERR){g.reportError(PERR)}var remoteID=remoteNote.id;gdata.cacheItem(remoteNote);var vmli=d.getModel(remoteID);vmli||(vmli=new VMLI({data:remoteNote,isNote:!0},{parent:this,changeType:ChangeType.Remote}));try{g.PAssert(2232,vmli.isNote(),"Must always be a valid note")}catch(PERR){g.reportError(PERR)}vmli.parent(this),g.fireCustomEvent("itemAdded",{item:vmli,force:!0}),g.timeline.notifyStateChanged(vmli),this.setNote(vmli,!0)},removeRemoteNote:function removeRemoteNoteFn(){try{g.PAssert(2233,this.hasNote(),"State of note should always match when removing")}catch(PERR){g.reportError(PERR)}var localNote=this.getNote();this.setNote(void 0,!0),d.deleteItem(localNote),g.timeline.notifyStateChanged(localNote)},onListAdded:function onListAddedFn(event){if(!event.isLocal||tracker.undoRedoActive){gdata.numChanges++;var areItemsArchived=!1,isValidTarget=!0,remoteItemList=gdata.get(this.data,"items");if(remoteItemList&&event.target.id===remoteItemList.id)isValidTarget=event.target.id===remoteItemList.id;else{var remoteArchivedList=gdata.get(this.data,"archivedItems");remoteArchivedList&&event.target.id===remoteArchivedList.id&&(areItemsArchived=!0),isValidTarget=remoteArchivedList&&event.target.id===remoteArchivedList.id}if(!isValidTarget)return void log("Skipping list add due to invalid target");var getRemoteFn,startIndex,endIndex;event.values.length>0?(startIndex=event.index,endIndex=startIndex+event.values.length,getRemoteFn=function(index){return event.values[index]}):(startIndex=0,endIndex=event.target.length,getRemoteFn=function(index){return event.target.get(index)});for(var i=startIndex;endIndex>i;++i){var eventIndex=i-startIndex,remoteItem=getRemoteFn(eventIndex);try{g.PAssert(2236,remoteItem,"Always expect a valid item at each index")}catch(PERR){g.reportError(PERR)}this.addRemoteItem(remoteItem,i,areItemsArchived)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None)}},onListRemoved:function onListRemovedFn(event){if(!event.isLocal||tracker.undoRedoActive){gdata.numChanges++;var idx,remoteItem,debugLocalItem,localText,areItemsArchived=!1,isValidTarget=!0,remoteItemList=gdata.get(this.data,"items");if(remoteItemList&&event.target.id===remoteItemList.id)isValidTarget=event.target.id===remoteItemList.id;else{var remoteArchivedList=gdata.get(this.data,"archivedItems");remoteArchivedList&&event.target.id===remoteArchivedList.id&&(areItemsArchived=!0),isValidTarget=remoteArchivedList&&event.target.id===remoteArchivedList.id}if(!isValidTarget)return void log("Skipping list remove due to invalid target");for(var startIndex=event.index,endIndex=startIndex+event.values.length,i=endIndex-1;i>=startIndex;i--){var eventIndex=i-startIndex;try{g.PAssert(2240,!!event.values[eventIndex],"Always expect a valid item at each index")}catch(PERR){g.reportError(PERR)}var remoteItem=event.values[eventIndex],isActualDelete=void 0===event.movedToList||null===event.movedToList;this.removeRemoteItem(remoteItem,i,areItemsArchived,isActualDelete)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None)}},onListSet:function onListSetFn(event){try{g.PAssert(2241,!1,"What? This shouldn't happen!",event)}catch(PERR){g.reportError(PERR)}},onObjectChanged:function onObjectChangedFn(event){if(event.ocHandled)return ShouldLog(LogLevels.Warning|LogLevels.Verbose)&&log("Event Already Handled: ",event.ocHandled,"-",this.id,event.events[0].type),!1;gdata.numChanges++,event.ocHandled=this.id,event.stopPropagation();var i,ev;if(event.isLocal&&!tracker.undoRedoActive)return!1;for(var i=0;i<event.events.length;++i)if(event.events[i].ocHandled)log("Sub-Event Already Handled: ",event.events[i].ocHandled,"-",this.id,event.events[i].type);else switch(event.events[i].ocHandled=this.id,event.events[i].type){case gapi.drive.realtime.EventType.TEXT_DELETED:this.onTextChanged(event.events[i]);break;case gapi.drive.realtime.EventType.TEXT_INSERTED:this.onTextChanged(event.events[i]);break;case gapi.drive.realtime.EventType.VALUES_ADDED:this.onListAdded(event.events[i]);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:this.onListRemoved(event.events[i]);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:this.onValueChanged(event.events[i]);break;case gapi.drive.realtime.EventType.VALUES_SET:try{g.PAssert(2242,!1,"VALUES_SET should never be triggered")}catch(PERR){g.reportError(PERR)}break;default:try{g.PAssert(2243,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}return!1}}};return VMLI_Drive}),define("sounds",["globals","platform"],function(g,platform){function addSource(sound,src){var source=document.createElement("source");source.src=src,sound.appendChild(source)}var self={},bank={};return self.add=function addFn(name){if(self[name]=name,!bank[name]){var sound=document.createElement("audio");addSource(sound,"sounds/"+name+".mp3"),sound.preload="auto",bank[name]=sound}},self.play=function playFn(name){if(!g.settings.get(Settings.noSounds)){if(!bank[name])return log("Tried to play a sound that has not been loaded:",name),void console.trace();try{bank[name].play()}catch(err){log("Failed to play audio",err)}}},self}),define("International",["platform","globals"],function(platform,g){function International(){this._currentLanguage="en-US",this._supportedLanguages=["en-US","en-GB"],this._languages={},this._localized=[],this.init()}return window.DFormat={LongDayTime:0,ShortDayTime:1,ShortTime:2,ShortDate:3,MonthDay:4},International.prototype={init:function initFn(){this._loadLanguages();var browserLang=navigator.language||navigator.userLanguage;browserLang!==this._currentLanguage&&this._supportedLanguages[browserLang]&&(this._currentLanguage=browserLang,this._loadLanguage()),this._loadLocalized()},setLanguage:function setLanguageFn(lcode,cb){lcode!==this._currentLanguage&&this._supportedLanguages.indexOf(lcode)>=0&&(this._currentLanguage=lcode,this._loadLanguage(cb))},getCurrentLanguageCode:function getCurrentLanguageCodeFn(){return this._currentLanguage},getCurrentLanguagePack:function getCurrentLanguagePackFn(){try{g.PAssert(2244,this._languages[this._currentLanguage],"Invalid language request")}catch(PERR){g.reportError(PERR)}return this._languages[this._currentLanguage]},getFormat:function getFormatFn(format){try{g.PAssert(2245,this._localized[format],"Invalid format request")}catch(PERR){g.reportError(PERR)}return this._localized[format]},_loadLanguage:function _loadLanguageFn(cb){var loadLanguage=this._currentLanguage;try{g.PAssert(2246,this._languages[loadLanguage],"Languages must always be loaded")}catch(PERR){g.reportError(PERR)}log("Set Language: ",loadLanguage),Date.CultureStrings=Date.CultureStrings||{},Date.CultureStrings[loadLanguage]=this._languages[loadLanguage],g.vmMain.notifyLanguageUpdated(),Date.i18n.setLanguage(loadLanguage,!1,function(){cb&&cb(),this._loadLocalized()}.bind(this))},_loadLocalized:function _loadLocalizedFn(){this._localized[DFormat.LongDayTime]="dddd "+Date.CultureInfo.formatPatterns.shortTime,this._localized[DFormat.ShortDayTime]=Date.CultureInfo.formatPatterns.monthDayShortTime+" "+Date.CultureInfo.formatPatterns.shortTime,this._localized[DFormat.ShortTime]=Date.CultureInfo.formatPatterns.shortTime,this._localized[DFormat.ShortDate]=Date.CultureInfo.formatPatterns.monthDayShortTime,this._localized[DFormat.MonthDay]="MMM d",this._localized[DFormat.MonthDayYear]=Date.CultureInfo.formatPatterns.monthDayYear},_loadLanguages:function _loadLanguagesFn(){this._languages["en-US"]={},this._languages["en-GB"]={name:"en-GB",englishName:"English (United Kingdom)",nativeName:"English (United Kingdom)",Sunday:"Sunday",Monday:"Monday",Tuesday:"Tuesday",Wednesday:"Wednesday",Thursday:"Thursday",Friday:"Friday",Saturday:"Saturday",Sun:"Sun",Mon:"Mon",Tue:"Tue",Wed:"Wed",Thu:"Thu",Fri:"Fri",Sat:"Sat",Su:"Su",Mo:"Mo",Tu:"Tu",We:"We",Th:"Th",Fr:"Fr",Sa:"Sa",S_Sun_Initial:"S",M_Mon_Initial:"M",T_Tue_Initial:"T",W_Wed_Initial:"W",T_Thu_Initial:"T",F_Fri_Initial:"F",S_Sat_Initial:"S",January:"January",February:"February",March:"March",April:"April",May:"May",June:"June",July:"July",August:"August",September:"September",October:"October",November:"November",December:"December",Jan_Abbr:"Jan",Feb_Abbr:"Feb",Mar_Abbr:"Mar",Apr_Abbr:"Apr",May_Abbr:"May",Jun_Abbr:"Jun",Jul_Abbr:"Jul",Aug_Abbr:"Aug",Sep_Abbr:"Sep",Oct_Abbr:"Oct",Nov_Abbr:"Nov",Dec_Abbr:"Dec",AM:"AM",PM:"PM",firstDayOfWeek:1,twoDigitYearMax:2029,mdy:"dmy","M/d/yyyy":"dd/MM/yyyy","dddd, MMMM dd, yyyy":"dd MMMM yyyy","h:mm tt":"HH:mm","h:mm:ss tt":"HH:mm:ss","dddd, MMMM dd, yyyy h:mm:ss tt":"dd MMMM yyyy HH:mm:ss","yyyy-MM-ddTHH:mm:ss":"yyyy-MM-ddTHH:mm:ss","yyyy-MM-dd HH:mm:ssZ":"yyyy-MM-dd HH:mm:ssZ","ddd, dd MMM yyyy HH:mm:ss":"ddd, dd MMM yyyy HH:mm:ss","MMMM dd":"dd MMMM","MM/dd":"dd/MM","MM/dd/yy":"dd/MM/yy","MMMM, yyyy":"MMMM yyyy","/jan(uary)?/":"jan(uary)?","/feb(ruary)?/":"feb(ruary)?","/mar(ch)?/":"mar(ch)?","/apr(il)?/":"apr(il)?","/may/":"may","/jun(e)?/":"jun(e)?","/jul(y)?/":"jul(y)?","/aug(ust)?/":"aug(ust)?","/sep(t(ember)?)?/":"sep(t(ember)?)?","/oct(ober)?/":"oct(ober)?","/nov(ember)?/":"nov(ember)?","/dec(ember)?/":"dec(ember)?","/^sun(day)?/":"^sun(day)?","/^mon(day)?/":"^mon(day)?","/^tue(s(day)?)?/":"^tue(s(day)?)?","/^wed(nesday)?/":"^wed(nesday)?","/^thu(rsday)?/":"^thu(rsday)?","/^fri(day)?/":"^fri(day)?","/^sat(urday)?/":"^sat(urday)?","/^next/":"^next","/^last|past|prev(ious)?/":"^last|past|prev(ious)?","/^yesterday/":"^yesterday","/^today/":"^today","/^tom(orrow)?/":"^tom(orrow)?","/^soon/":"^soon","/^later/":"^later","/^someday/":"^someday","/^now/":"^now","/^(a|p)/":"^(a|p)","/^(a\\.?m?\\.?|p\\.?m?\\.?)/":"^(a\\.?m?\\.?|p\\.?m?\\.?)","/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\\s*(\\+|\\-)\\s*\\d\\d\\d\\d?)|gmt|utc)/":"^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\\s*(\\+|\\-)\\s*\\d\\d\\d\\d?)|gmt|utc)","/^\\s*(st|nd|rd|th)/":"^\\s*(st|nd|rd|th)","/^\\s*(\\:|a(?!u|p)|p)/":"^\\s*(\\:|a(?!u|p)|p)","/(this )(morn(ing)?)\\b/":"(this )(morn(ing)?)\\b","/(this )(even(ing)?)\\b/":"(this )(even(ing)?)\\b",LINT:"LINT",TOT:"TOT",CHAST:"CHAST",NZST:"NZST",NFT:"NFT",SBT:"SBT",AEST:"AEST",ACST:"ACST",JST:"JST",CWST:"CWST",CT:"CT",ICT:"ICT",MMT:"MMT",BIOT:"BST",NPT:"NPT",IST:"IST",PKT:"PKT",AFT:"AFT",MSK:"MSK",IRST:"IRST",FET:"FET",EET:"EET",CET:"CET",UTC:"UTC",GMT:"GMT",CVT:"CVT",GST:"GST",BRT:"BRT",NST:"NST",AST:"AST",EST:"EST",CST:"CST",MST:"MST",PST:"PST",AKST:"AKST",MIT:"MIT",HST:"HST",SST:"SST",BIT:"BIT",CHADT:"CHADT",NZDT:"NZDT",AEDT:"AEDT",ACDT:"ACDT",AZST:"AZST",IRDT:"IRDT",EEST:"EEST",CEST:"CEST",BST:"BST",PMDT:"PMDT",ADT:"ADT",NDT:"NDT",EDT:"EDT",CDT:"CDT",MDT:"MDT",PDT:"PDT",AKDT:"AKDT",HADT:"HADT"}}},new International}),define("VMLI",["ko","globals","util","platform","data","gdata","android","VMLI_TapHandlers","VMLI_Text","VMLI_Drive","tracker","sounds","RepeatDate","International"],function(ko,g,util,platform,d,gdata,android,VMLI_TapHandlers,VMLI_Text,VMLI_Drive,tracker,sounds,RepeatDate,International){function VMLI(p,extraInfo){try{g.PAssert(2247,g.isValidChangeType(extraInfo.changeType),"Must specify a valid change type when creating a VMLI")}catch(PERR){g.reportError(PERR)}if(!p.id&&p.data&&p.data.id)p.id=p.data.id;else if(p.id&&p.data)try{g.PAssert(2248,p.id===p.data.id,"If passing in a local id and a remote ID, they should match")}catch(PERR){g.reportError(PERR)}if(p.id&&d.getModel[p.id]){ShouldLog(LogLevels.Warning)&&log("Attempting to create an already created VMLI: ",p.id);try{g.PAssert(2249,!1,"Should not be constructing a VMLI here")}catch(PERR){g.reportError(PERR)}return d.getModel[p.id]}try{g.PAssert(2250,void 0===p.v,"We should never be passing in 'v'")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2251,void 0===p.extern,"We should never be passing in 'extern'")}catch(PERR){g.reportError(PERR)}this._parent=extraInfo?extraInfo.parent:void 0,this._rawText=p.data?"":p.text,this._searchText=p.data?"":p.text?p.text.toLowerCase():"",this._parsedText=void 0,this._styledText=ko.observable(""),this._isArchived=p.isArchived||!1,this.items=ko.observableArray(),this._note=void 0,this.headers=ko.observableArray(),this._archivedItems=void 0,this._demandLoadChildren=p.demandLoadChildren||!1,this._loadedOnDemandData=!this._demandLoadChildren,this._paginationToken=void 0,this._canDestroy=p.canDestroy||!1,this._date=ko.observable(void 0),this._repeatDate=void 0,this._attachments=void 0;var origFlags=VMLIFlag.None;(p.isCollapsed||this.isDemandLoad())&&(origFlags|=VMLIFlag.Collapsed),p.isComplete&&(origFlags|=VMLIFlag.Complete),p.isStarred&&(origFlags|=VMLIFlag.Starred),p.isNote&&(origFlags|=VMLIFlag.Note),p.priority&&(origFlags|=p.priority),this._flags=ko.observable(origFlags),this.dateText=p.dateText,this.dateCreated=p.dateCreated?new Date(p.dateCreated):new Date,this.dateCompleted=p.dateCompleted?new Date(p.dateCompleted):void 0,this._activeTags=void 0,this.isLoaded=!1,this._isDeleted=p.isDeleted||!1,this.isStyled=!1,this.modifiedOffline=void 0,this.modifiedOfflineText=void 0,this.highlightTimeout=void 0,this.data=void 0,this._version=window.UninitializedVersion,this._versionText=window.UninitializedVersion,this._versionRemote=void 0,this._versionRemoteText=void 0,this.lastFindPass=0,this.levelsDeep=ko.observable(this._parent?this._parent.levelsDeep()+1:0),window.__TOTAL_ITEMS++,p.isArchived&&window.__TOTAL_ARCHIVED_ITEMS++,this._needsParse=!1,this.items.subscribe(this.generateHeaders.bind(this)),this.items.subscribe(this.isHeader.bind(this)),this.init(p,extraInfo)}window.__TOTAL_ITEMS=0,window.__TOTAL_ARCHIVED_ITEMS=0,window.__TOTAL_ARCHIVE_PARENTS=0;var forceCompleteDate=new Date(9e12);return VMLI.prototype={templateNameItem:function templateNameItemFn(item){return g.templateNameItem(item)},notifyDemandLoadUpdate:function notifyDemandLoadUpdateFn(showItems){showItems&&!this._loadedOnDemandData&&(g.focusedPane.requestDemandLoadData(this),this.notifyLoadedData())},notifyLoadedData:function notifyLoadedDataFn(){this._loadedOnDemandData=!0},notifyLoadDataFailed:function notifyLoadDataFailedFn(){this.isCollapsed(!1),this._loadedOnDemandData=!1},isDemandLoad:function isDemandLoadFn(){return this._demandLoadChildren},hasPaginationToken:function hasPaginationTokenFn(){return!!(this._flags()&VMLIFlag.HasPageToken)},setPaginationToken:function setPaginationTokenFn(token){try{g.PAssert(2252,token,"Should never be setting an undefined token - use clear instead")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2253,!this._paginationToken,"Should never be overriding a pagination token - clear then set")}catch(PERR){g.reportError(PERR)}this._paginationToken=token,this._flags(this._flags.peek()|VMLIFlag.HasPageToken)},beginDataPageLoad:function beginDataPageLoadFn(){var token=this._paginationToken;try{g.PAssert(2255,token,"Should always have a valid pagination token when beginning to load a data page")}catch(PERR){g.reportError(PERR)}return this._paginationToken=void 0,this._flags(this._flags.peek()&~VMLIFlag.HasPageToken),token},endDataPageLoad:function endDataPageLoadFn(token){token&&this.setPaginationToken(token)},notifyPaginationUpdate:function notifyPaginationUpdateFn(){try{g.PAssert(2257,this._paginationToken,"Must have a valid token to get next page of data")}catch(PERR){g.reportError(PERR)}this._paginationToken&&g.focusedPane.requestDataPage(this)},stylePaginationPadding:function stylePaginationPaddingFn(context){try{g.PAssert(2258,context,"Must always supply a data context for pagination padding calculation")}catch(PERR){g.reportError(PERR)}var pane=context.$parents[context.$parents.length-2];return this.getPadding(pane)+40+"px"},hasNote:function hasNoteFn(){return void 0!==this._note},getNote:function getNoteFn(){try{g.PAssert(2259,this.hasNote(),"Must have a note to get one")}catch(PERR){g.reportError(PERR)}return this._note},setNote:function setNoteFn(note,fromRemote){try{g.PAssert(2260,!this.isNote(),"Should never set a note on a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2261,!this._note||!note,"Should never set a note multiple times on a single item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2262,!note||note.isNote(),"Should only set items that are notes as notes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2263,!note||note instanceof VMLI,"Note must be a valid VMLI")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2264,!note||note.parent()===this,"Should always have a valid parent set before setting note on item")}catch(PERR){g.reportError(PERR)}if(this.items.valueWillMutate(),this._note=note,this.shouldSave()){var newID=note?note.id:void 0;this.save({note:newID},SaveFlag.Prop),fromRemote||gdata.noteSet(this,note)}this.items.valueHasMutated()},isNote:function isNoteFn(value,fromRemote){if(void 0===value)return this._isFlagHelper(VMLIFlag.Note);if(value!==this._isFlagHelper(VMLIFlag.Note)){var newFlags=value?this._flags()|VMLIFlag.Note:this._flags&~VMLIFlag.Note;this._flags(newFlags)}},shouldSave:function shouldSaveFn(){return this._shouldSave||g.isDemoMode()},canDestroy:function canDestroyFn(){return this._canDestroy},_getLineStyle:function _getLineStyleFn(){return this._flags()&g.LSMask},_getPriority:function _getPriorityFn(){return this._flags()&g.PMask},getPadding:function getPaddingFn(pane){try{g.PAssert(2265,pane&&pane.item.peek(),"Invalid pane")}catch(PERR){g.reportError(PERR)}if(this.isNote())return this.parent().getPadding(pane);var rootDepth=pane.item.peek().levelsDeep.peek(),paddingLevels=this.levelsDeep()-rootDepth-1;return g.itemPaddingStart+paddingLevels*g.itemPaddingIncrement},getPaddingOutline:function getPaddingOutlineFn(){var paddingLevels=this.levelsDeep()-1;return g.outlinePaddingStart+paddingLevels*g.outlinePaddingIncrement},stylePadding:function stylePaddingFn(context){if(context){var pane=g.getPaneForContext(context);try{g.PAssert(2266,pane,"Must find a valid pane to get style padding for element")}catch(PERR){g.reportError(PERR)}return this.getPadding(pane)+"px"}return this.getPaddingOutline()+"px"},_updateStylePadding:function _updateStylePaddingFn(parentDepth,forceChange){try{g.PAssert(2267,this._parent,"Must have a valid parent to update padding, root should never change")}catch(PERR){g.reportError(PERR)}var newDepth=parentDepth+1,hasChanged=this.levelsDeep.peek()!==newDepth;if(hasChanged||forceChange){hasChanged?this.levelsDeep(newDepth):this.levelsDeep.valueHasMutated();for(var children=this.items.peek(),i=0;i<children.length;++i)children[i]._updateStylePadding(newDepth,forceChange)}},styleProps:function stylePropsFn(blockDate){var localFlags=this._flags(),styleProps=localFlags&VMLIFlag.Header?"pHeader ":"";localFlags&VMLIFlag.Collapsed&&(styleProps+="collapsed "),localFlags&VMLIFlag.Selected&&(styleProps+="selected "),localFlags&VMLIFlag.Highlighted&&(styleProps+="highlight "),localFlags&VMLIFlag.NumList&&(styleProps+="pNumList "),this.isArchived()&&(styleProps+="archived "),localFlags&VMLIFlag.Complete?(!this.repeatDate()||this.dateCompleted&&this.dateCompleted.getTime()===forceCompleteDate.getTime())&&(styleProps+="pComplete "):styleProps+=localFlags&g.PMask?g.priorityMapOut[localFlags&g.PMask]+" ":"pNormal ",localFlags&VMLIFlag.Starred&&(styleProps+="pStar "),localFlags&VMLIFlag.Note&&(styleProps+="pNote ",localFlags&VMLIFlag.Multiline&&(styleProps+="multiline "));var attachments=this.getAttachments();if(attachments)for(var i=0;i<attachments.length;++i)if(attachments[i].isLoaded()){var cssField=attachments[i].getField("cssClass");cssField&&(styleProps+=cssField)}return styleProps},onAttachmentIDChange:function onAttachmentIDChangeFn(attach,oldID){this.setText(this.getParsedText(),!0,ChangeType.None)},onAttachmentUpdate:function onAttachmentUpdateFn(attach){this.parseText(!0,ChangeType.None)},setAttachments:function setAttachmentsFn(attachments,changeType){if(!this._attachments&&attachments&&(this._attachments=ko.observableArray()),this._attachments){for(var thisAttachments=this._attachments(),i=0;i<thisAttachments.length;++i)attachments.indexOf(thisAttachments[i])<0&&(thisAttachments[i].unsubscribe(this),this.shouldSave()&&thisAttachments[i].markUnused(changeType));for(var i=0;i<attachments.length;++i)thisAttachments.indexOf(attachments[i])<0&&(attachments[i].subscribe(this),this.shouldSave()&&attachments[i].markInUse(changeType));this._attachments(attachments)}},getAttachment:function getAttachmentFn(index){try{g.PAssert(2272,this._attachments,"Must have valid attachments in order to query")}catch(PERR){g.reportError(PERR)}return this._attachments?this._attachments()[index]:void 0},getAttachments:function getAttachmentsFn(){return this._attachments&&this._attachments().length>0?this._attachments():void 0},hasAttachments:function hasAttachmentsFn(){return this._attachments&&this._attachments().length>0},getNumAttachments:function getNumAttachmentsFn(){return this._attachments?this._attachments().length:0},copyProperties:function copyPropertiesFn(src){this.isStarred(src.isStarred()),this.isComplete(src.isComplete()),this.priority(src.priority())},moveNote:function moveNoteFn(src){try{g.PAssert(2273,src.hasNote(),"Must have a note to move")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2274,!this.hasNote(),"Must not already have a note")}catch(PERR){g.reportError(PERR)}var note=src.getNote();src.setNote(void 0),note&&(note.parent(this),this.setNote(note))},parent:function parentFn(){if(1===arguments.length){try{g.PAssert(2275,arguments[0]instanceof VMLI||void 0===arguments[0],"Parent must be a VMLI")}catch(PERR){g.reportError(PERR)}this._parent=arguments[0],void 0!==arguments[0]&&this._updateStylePadding(this._parent.levelsDeep(),!1)}return this._parent},archivedItems:function archivedItemsFn(underlying){return this._archivedItems||(this._archivedItems=ko.observableArray(),window.__TOTAL_ARCHIVE_PARENTS++),underlying?this._archivedItems():this._archivedItems},hasArchivedChildren:function hasArchivedChildrenFn(){return void 0!==this._archivedItems?this._archivedItems().length>0:!1},generateHeaders:function generateHeadersFn(){for(var headers=[],items=this.items(),i=0;i<items.length;++i)items[i].isHeader()&&headers.push(items[i]);this.headers(headers)},isArchived:function isArchivedFn(){if(1===arguments.length){var oldValue=this._isArchived;this._isArchived=arguments[0],arguments[0]!==oldValue&&g.timeline.notifyStateChanged(this,PropChangeType.Archive)}return this._isArchived},isHidden:function isHiddenFn(pane,outline){try{g.PAssert(2276,pane,"Must specify the pane for the item being checked")}catch(PERR){g.reportError(PERR)}return pane?g.vmMain.paneManager.getPerPaneState(pane.id,this.id,outline?PerPaneStateField.HiddenOutline:PerPaneStateField.Hidden):!1},setHidden:function setHiddenFn(value,pane,outline){try{g.PAssert(2277,pane,"Must specify the pane the item is being hidden in")}catch(PERR){g.reportError(PERR)}var oldValue=this.isHidden(pane,outline);if(void 0!==value&&value!==oldValue){g.vmMain.paneManager.setPerPaneState(pane.id,this.id,outline?PerPaneStateField.HiddenOutline:PerPaneStateField.Hidden,value);var el;el=outline?this.getOutlineElement(pane.id):this.getElement(pane.id),el&&(value?g.addClass(el,"hidden"):g.removeClass(el,"hidden"))}return oldValue},getRawText:function getRawTextFn(){return this._rawText},getParsedText:function getParsedTextFn(){try{g.PAssert(2278,this._needsParse===!1,"Text should be parsed before calling get")}catch(PERR){g.reportError(PERR)}return this._parsedText?this._parsedText:this._rawText},getStyledText:function getStyledTextFn(){return this._styledText()},getSearchText:function getSearchTextFn(){try{g.PAssert(2280,void 0!==this._searchText,"Item should always have search text")}catch(PERR){g.reportError(PERR)}return this._searchText},setRawText:function setRawTextFn(text){(void 0===text||null===text)&&(text=""),this._rawText=text,text&&(this._searchText=text.toLowerCase()),this._parsedText=void 0,this._needsParse=!0},setParsedText:function setParsedTextFn(text){this._parsedText=text,text&&(this._searchText=text.toLowerCase()),this._needsParse=!1},setStyledText:function setStyledTextFn(text){this._styledText(text)},priority:function priorityFn(pri,fromRemote){if(void 0===pri)return this._getPriority();try{g.PAssert(2283,null===pri||g.priorityMapOut[pri],"Priority must be defined in globals")}catch(PERR){g.reportError(PERR)}var oldPriority=this._getPriority();if(pri!==oldPriority){var newFlags=this._flags()&~g.PCMask|pri;if(this._flags(newFlags),this.isLoaded){if(this.shouldSave()){var saveData={priority:pri};fromRemote||(gdata.saveChanges(this,saveData),saveData=g.clone(saveData));var saveFlags=fromRemote?SaveFlag.None:SaveFlag.Text;this.save(saveData,saveFlags)}g.timeline.notifyStateChanged(this,PropChangeType.Priority|PropChangeType.Complete),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"priority",newValue:pri,oldValue:oldPriority})}}},isScheduled:function isScheduledFn(){return!!this._date()||!!this._repeatDate},date:function dateFn(date,fromRemote){if(void 0!==date){try{g.PAssert(2284,!date||date instanceof Date,"Must pass in a valid date object")}catch(PERR){g.reportError(PERR)}date!==this._date()&&(null===date&&(date=void 0),this._date(date),g.timeline.notifyStateChanged(this,PropChangeType.Date),this.isLoaded&&!fromRemote&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:[{itemID:this.id,date:date}]}))}return this._date()},repeatDate:function repeatDateFn(rDate,fromRemote){if(void 0!==rDate){try{g.PAssert(2285,!rDate||rDate instanceof RepeatDate,"Must pass in a valid repeat date object")}catch(PERR){g.reportError(PERR)}rDate!==this._repeatDate&&(null===rDate&&(rDate=void 0),this._repeatDate=rDate,!rDate&&this.dateCompleted&&this.dateCompleted.getTime()!==forceCompleteDate.getTime()&&this.isComplete(!1,fromRemote),g.timeline.notifyStateChanged(this,PropChangeType.Date),this.isLoaded&&!fromRemote&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:[{itemID:this.id,date:rDate}]}))}return this._repeatDate},allDayDate:function allDayDateFn(){return this._date()?!this._date().hasTimeOfDay():this.repeatDate()?!this.repeatDate().hasTimeOfDay():!1},_isFlagHelper:function _isFlagHelperFn(flag,value){if(void 0!==value){var newFlags=value?this._flags()|flag:this._flags()&~flag;return void this._flags(newFlags)}return!!(this._flags()&flag)},isDeleted:function isDeletedFn(value){if(void 0!==value&&(this._isDeleted=value,this.shouldSave())){var tAttach=this._attachments?this._attachments():void 0;if(tAttach&&tAttach.length>0)for(var i=0;i<tAttach.length;++i)value?tAttach[i].markUnused():tAttach[i].markInUse()}return this._isDeleted},isImportant:function isImportantFn(){return this._getPriority()},forceComplete:function forceCompleteFn(value,fromRemote){return this.isComplete(value,fromRemote,!0)},isComplete:function isCompleteFn(value,fromRemote,force){if(void 0===value)return this._isFlagHelper(VMLIFlag.Complete)&&(!this.repeatDate()||this.dateCompleted&&this.dateCompleted.getTime()===forceCompleteDate.getTime());var saveData={isComplete:value},propChanges=PropChangeType.Complete;if(value!==this._isFlagHelper(VMLIFlag.Complete)||this.repeatDate()){if(this.isLoaded){if(value){if(this.repeatDate()){try{g.PAssert(2286,!this.dateCompleted||this.dateCompleted.getTime()!==forceCompleteDate.getTime(),"If the passed in value is true then the repeated date should never be forced")}catch(PERR){g.reportError(PERR)}if(force)this.dateCompleted=forceCompleteDate;else{var nextComplete=this.repeatDate().nextComplete(this.dateCompleted),nextActive=this.repeatDate().nextActive(this.dateCompleted);if(nextActive){if(this.dateCompleted=nextActive,!fromRemote){tracker.beginAction();var newText=this.getParsedText().replace(this.dateText,nextComplete.toString(Date.CultureInfo.formatPatterns.shortDate)),completedItem=new VMLI({text:newText,isComplete:!0,dateCompleted:Date.now()},{parent:this.parent(),forceSave:!0,changeType:ChangeType.AllLocal});this.parent().insertItem(completedItem,this.getIndex()),this.repeatDate().setStartDate(nextActive),saveData.repeatDate=this.repeatDate().toString(),tracker.endAction()}}else this.dateCompleted=forceCompleteDate,force=!0}saveData.dateCompleted=this.getDateCompletedTime(),g.vmMain.addParseItem(this,(fromRemote?ChangeType.Remote:ChangeType.Local)|ChangeType.Property)}else this.dateCompleted||(this.dateCompleted=new Date,saveData.dateCompleted=this.getDateCompletedTime());g.vmMain.isLoaded&&g.aggregateEvent("ItemCompleted")}else this.dateCompleted=void 0,saveData.dateCompleted=void 0,force=!0;if(this.shouldSave()){fromRemote||(gdata.saveChanges(this,saveData),saveData=g.clone(saveData));var saveFlags=fromRemote?SaveFlag.None:SaveFlag.Text;this.save(saveData,saveFlags)}this.repeatDate()&&(propChanges|=PropChangeType.Date),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isComplete",newValue:value,oldValue:!value})
}(force||!this.repeatDate())&&(this._isFlagHelper(VMLIFlag.Complete,value),g.timeline.notifyStateChanged(this,propChanges),g.vmMain.paneManager.applyFnToPanes("onItemCompleteChanged",void 0,this))}},isStarred:function isStarredFn(value,fromRemote){if(void 0===value)return this._isFlagHelper(VMLIFlag.Starred);if(value!==this._isFlagHelper(VMLIFlag.Starred)){var origFlags=value?this._flags()&~VMLIFlag.Complete:this._flags(),newFlags=value?origFlags|VMLIFlag.Starred:origFlags&~VMLIFlag.Starred;if(this._flags(newFlags),this.isLoaded){var saveData={isStarred:value};if(android.isEnabled()&&android.isCurrentVMLI(this)&&android.notifyStarred(value),this.shouldSave()){fromRemote||(gdata.saveChanges(this,saveData),saveData=g.clone(saveData));var saveFlags=fromRemote?SaveFlag.None:SaveFlag.Text;this.save(saveData,saveFlags)}g.timeline.notifyStateChanged(this,PropChangeType.Starred|PropChangeType.Complete)}tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isStarred",newValue:value,oldValue:!value})}},isHeader:function isHeaderFn(){if(this.isNote())return!1;var value=this.items().length>0||this._demandLoadChildren&&!this._loadedOnDemandData,currStyle=this._flags();if(!!(currStyle&VMLIFlag.Header)!==value){var newFlags=value?currStyle|VMLIFlag.Header:currStyle&~VMLIFlag.Header;this._flags(newFlags),!value&&this.isCollapsed()&&this.isCollapsed(!1),this._parent&&this._parent.isFullscreen()&&this._updateStylePadding(this._parent.levelsDeep(),!0)}return value},isOutlineHeader:function isOutlineHeaderFn(){return!this.isNote()&&(this.headers().length>0||this._demandLoadChildren&&!this._loadedOnDemandData)},isCollapsed:function isCollapsedFn(value){var oldValue=this._isFlagHelper(VMLIFlag.Collapsed);return void 0!==value&&(!value||this.isCollapsible())&&(this._isFlagHelper(VMLIFlag.Collapsed,value),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isCollapsed",newValue:value,oldValue:oldValue}),this.shouldSave()&&this.save({isCollapsed:value},SaveFlag.Text),this.isDemandLoad()&&this.notifyDemandLoadUpdate(!value)),oldValue},isCollapsible:function isCollapsibleFn(){return!this.isNote()&&(this.items().length>0||this._demandLoadChildren&&!this._loadedOnDemandData)},isDraggable:function isDraggableFn(){return!this.isNote()},setTags:function setTagsFn(newTags){for(var i=0;this._activeTags&&i<this._activeTags.length;++i)d.tagManager.notifyRemoved(this._activeTags[i]);for(var i=0;newTags&&i<newTags.length;++i)d.tagManager.notifyAdded(newTags[i]);this._activeTags=newTags},isSelected:function isSelectedFn(value){return this._isFlagHelper(VMLIFlag.Selected,value)},isMultiline:function isMultilineFn(value){return this._isFlagHelper(VMLIFlag.Multiline,value)},isHighlighted:function isHighlightedFn(value){return this._isFlagHelper(VMLIFlag.Highlighted,value)},isNumList:function isNumListFn(value){return this._isFlagHelper(VMLIFlag.NumList,value)},hasCompletedAncestor:function hasCompletedAncestorFn(){for(var parent=this.parent();parent;){if(parent.isComplete())return!0;parent=parent.parent()}},hasTime:function hasTimeFn(){return this.date()?this.date().hasTimeOfDay():this.repeatDate()?this.repeatDate().hasTimeOfDay():!!this.dateCompleted},getTimeOfDay:function getTimeOfDayFn(){return this.date()?this.date().getTimeOfDay():this.repeatDate()?this.repeatDate().getTimeOfDay():this.dateCompleted?this.dateCompleted.getTimeOfDay():0},time:function timeFn(){var timeString="";return this.date()?timeString=this.date().hasTimeOfDay()?this.date().toString(International.getFormat(DFormat.ShortTime)):"Any Time":this.repeatDate()?timeString=this.repeatDate().hasTimeOfDay()?this.repeatDate().getTime(International.getFormat(DFormat.ShortTime)):"Any Time":this.dateCompleted&&(timeString=this.dateCompleted.toString(International.getFormat(DFormat.ShortTime))),timeString},createDateString:function createDateStringFn(dt){return dt.toString(dt.isBefore(Date.today().addWeeks(1))?International.getFormat(DFormat.LongDayTime):International.getFormat(DFormat.ShortDayTime))},fullTime:function fullTimeFn(){var date=this.date();return date?void this.createDateString(date):""},isVersionUninitialized:function isVersionUninitializedFn(type){var v;switch(type){case VersionType.Structure:v=this._version;break;case VersionType.Text:v=this._versionText;break;default:v=-2;try{g.PAssert(2288,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return(v?v:0)===window.UninitializedVersion},setVersion:function setVersionFn(type,v){var verStr;switch(type){case VersionType.Structure:this._version=v;break;case VersionType.Text:this._versionText=v;break;default:try{g.PAssert(2289,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}},getVersion:function getVersionFn(type){var v;switch(type){case VersionType.Structure:v=this._version;break;case VersionType.Text:v=this._versionText;break;default:v=-2;try{g.PAssert(2290,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},setRemoteVersion:function setRemoteVersionFn(type,v){var verStr;switch(type){case VersionType.Structure:this._versionRemote=v;break;case VersionType.Text:this._versionRemoteText=v;break;default:try{g.PAssert(2291,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}},getRemoteVersion:function getRemoteVersionFn(type){var v;switch(type){case VersionType.Structure:v=this._versionRemote;break;case VersionType.Text:v=this._versionRemoteText;break;default:v=-2;try{g.PAssert(2292,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},isLocalVersionNewer:function isLocalVersionNewerFn(type){return this.getVersion(type)==this.getRemoteVersion(type)},isRemoteVersionNewer:function isRemoteVersionNewerFn(type){return!this.isLocalVersionNewer(type)},init:function initFn(p,extraInfo){this._shouldSave=!(extraInfo&&extraInfo.noSave);try{g.PAssert(2293,this._shouldSave||!(extraInfo&&extraInfo.forceSave)&&!this._shouldSave,"Should never have an item forced to save while marked as not save")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2294,!this._shouldSave||!this._demandLoadChildren,"Should never be saving results of demand loaded items")}catch(PERR){g.reportError(PERR)}if(p.data){try{g.PAssert(2295,this._shouldSave,"Should never be loading from remote with item that doesnt save")}catch(PERR){g.reportError(PERR)}var verStructure=gdata.getVersion(p.data,VersionType.Structure),verText=gdata.getVersion(p.data,VersionType.Text);this.setRemoteVersion(VersionType.Structure,verStructure),this.setRemoteVersion(VersionType.Text,verText),tracker.beginAction(),this.initFromGDrive(p.data),tracker.endAction(),this.setRemoteVersion(VersionType.Structure,void 0),this.setRemoteVersion(VersionType.Text,void 0)}else{if(this.setVersion(VersionType.Structure,p.version),this.setVersion(VersionType.Text,p.versionText),this.modifiedOffline=p.modifiedOffline,this.modifiedOfflineText=p.modifiedOfflineText,this.modifiedOffline,this.modifiedOfflineText,g.vmMain.isLoaded&&this._shouldSave&&gdata.isConnected()?d.initializeItem(this):this.id=p.id||g.generateTempId(),p.date){var newDate=new Date(p.date);this.date(newDate)}if(p.repeatDate){var newRepeatDate=new RepeatDate(p.repeatDate);this.repeatDate(newRepeatDate)}p.dateCompleted&&(this.dateCompleted=new Date(p.dateCompleted)),(p.items&&p.items.length>0||p.note)&&this.updateItems(p.items,p.note,extraInfo&&extraInfo.forceSave)}if(!this.isArchived()||g.vmMain.hasDisplayedArchivedItems()){try{g.PAssert(2296,extraInfo,"Currently we have required properties in extraInfo")}catch(PERR){g.reportError(PERR)}var changeType=extraInfo?extraInfo.changeType:ChangeType.Auto;try{g.PAssert(2297,g.isValidChangeType(changeType),"Must supply a valid changetype to VMLIs")}catch(PERR){g.reportError(PERR)}this.parseText(!0,extraInfo.changeType)}this._shouldSave&&extraInfo&&extraInfo.forceSave&&(this.save(void 0,SaveFlag.Prop),(this.date()||this.repeatDate())&&gdata.saveChanges(this,this.getMetaTextSaveData()),this.isComplete()&&gdata.saveChanges(this,{isComplete:this.isComplete()})),g.vmMain.isLoaded&&g.aggregateEvent("ItemCreated"),d.setModel(this)},onLoad:function onLoadFn(element,pModel){if(pModel&&pModel.trackDOM&&pModel.trackDOM()){try{g.PAssert(2298,pModel,"Items must be added to a pane")}catch(PERR){g.reportError(PERR)}var paneID=pModel.id;if(this.isLoaded=!0,g.hasClass(element,"outlineItem"))g.vmMain.paneManager.setPerPaneState(paneID,this.id,PerPaneStateField.OutlineElement,element),this._demandLoadChildren&&!this._loadedOnDemandData&&g.addClass(element,"collapsed"),pModel.vmSearch.checkItem(this,!0,!1);else{g.vmMain.paneManager.setPerPaneState(paneID,this.id,PerPaneStateField.Element,element);try{g.PAssert(2301,g.hasClass(element.firstElementChild,"text"),"Invalid element loaded for VMLI")}catch(PERR){g.reportError(PERR)}(!g.vmMain.isLoaded||pModel!==g.focusedPane||pModel.reloading)&&pModel.vmSearch.checkItem(this,!1,!0)}}},destroy:function destroyFn(){try{g.PAssert(2302,this._canDestroy,"VMLI must be explicitly marked as destroyable")}catch(PERR){g.reportError(PERR)}util.destroy(this)},getACText:function getACTextFn(){return android.isEnabled()&&android.isCurrentVMLI(this)?android.getInputText():this.getParsedText()},resetDriveData:function resetDriveDataFn(){this._versionRemote=void 0,this._versionRemoteText=void 0,this.data=void 0},isFullscreen:function isFullscreenFn(){return g.focusedItem===this},findItem:function findItemFn(id){var found=this.getIndexOf(id,!1);return found>=0?{index:found,arr:this.items,isArchived:!1}:this.hasArchivedChildren()&&(found=this.getIndexOf(id,!0),found>=0)?{index:found,arr:this.archivedItems(),isArchived:!0}:void 0},updateItems:function updateItemsFn(newItems,note,forceSave){var itemsModified=!1,archivedItemsModified=!1;if(newItems&&newItems.length>0){var collabItemList,collabArchivedItemList;this.data&&(collabItemList=gdata.get(this.data,"items"),collabArchivedItemList=gdata.get(this.data,"archivedItems"));try{g.PAssert(2305,!this.hasChildren(),"Update items should only be called from initialize when there are no items already loaded")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2306,!this.hasArchivedChildren(),"Update items should only be called from initialize when there are no items already loaded")}catch(PERR){g.reportError(PERR)}for(var i=0;i<newItems.length;++i){var item=newItems[i],itemVM=void 0;if(item instanceof VMLI?itemVM=item:g.isString(item)&&(itemVM=d.getModel(item)),itemVM){var oldParentInfo=d.getItem(itemVM.parent().id);if(oldParentInfo){var oldParentIndex=oldParentInfo.items.indexOf(itemVM.id);try{g.PAssert(2309,-1===oldParentIndex,"Expect that the old parent has been notified")}catch(PERR){g.reportError(PERR)}var childModelIndex=itemVM.getIndex();childModelIndex>-1&&itemVM.parent().removeChildAtIndex(childModelIndex)}itemVM.parent(this)}else if("object"!=typeof item){var itemInfo=d.getItem(item);try{g.PAssert(2307,itemInfo,"Referenced item doesn't exist",item)}catch(PERR){g.reportError(PERR)}itemInfo&&(itemVM=new VMLI(itemInfo,{parent:this,forceSave:forceSave,changeType:ChangeType.Auto}))}else{try{g.PAssert(2308,item,"Item must exist otherwise we arent creating anything")}catch(PERR){g.reportError(PERR)}item&&(itemVM=new VMLI(item,{parent:this,forceSave:forceSave,changeType:ChangeType.Auto}))}try{g.PAssert(2310,itemVM,"There must be a model at this point")}catch(PERR){g.reportError(PERR)}itemVM&&(itemVM.isArchived()?(archivedItemsModified=!0,this.archivedItems(!0).push(itemVM),!collabArchivedItemList&&this.data&&(collabArchivedItemList=gdata.ensureItemList(this,!0)),collabArchivedItemList&&collabArchivedItemList.push(itemVM.data)):(itemsModified=!0,this.items().push(itemVM),!collabItemList&&this.data&&(collabItemList=gdata.ensureItemList(this,!1)),collabItemList&&collabItemList.push(itemVM.data)))}}if(note){try{g.PAssert(2311,!this._note,"Must not already have a valid note set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2312,g.isString(note),"Note must be a valid ID")}catch(PERR){g.reportError(PERR)}var noteVM=d.getModel(note);if(!noteVM){var itemInfo=d.getItem(note);try{g.PAssert(2313,itemInfo,"Referenced note doesn't exist",note)}catch(PERR){g.reportError(PERR)}itemInfo&&(itemInfo.isNote=!0,noteVM=new VMLI(itemInfo,{parent:this,forceSave:forceSave,changeType:ChangeType.Auto}))}try{g.PAssert(2314,noteVM,"Must have a valid note VM at this point")}catch(PERR){g.reportError(PERR)}this._note=noteVM,itemsModified=!0}itemsModified&&this.items.valueHasMutated(),archivedItemsModified&&this.archivedItems().valueHasMutated()},insertItem:function insertItemFn(item,index,underlying){try{g.PAssert(2315,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2316,item,"Must specify a valid item to be inserted")}catch(PERR){g.reportError(PERR)}var arr=underlying?this.items():this.items;isNaN(index)?arr.push(item):arr.splice(index,0,item),this.shouldSave()&&d.insertItems(this,[item],index),g.fireCustomEvent("itemAdded",{item:item,force:!1})},insertSorted:function insertSortedFn(item,sortFn){try{g.PAssert(2317,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2318,item,"Must specify a valid item to be inserted")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2319,sortFn,"Must supply a valid comparator")}catch(PERR){g.reportError(PERR)}var index=this.items.insertSorted(item,sortFn);this.shouldSave()&&d.insertItems(this,[item],index),g.fireCustomEvent("itemAdded",{item:item,force:!1})},moveTo:function moveToFn(params){var parent=params.parent,index=params.index,isRemoteChange=params.isRemoteChange,shouldBeArchived=params.shouldBeArchived,noVersion=params.noVersion,underlying=params.underlying;try{g.PAssert(2320,parent instanceof VMLI)}catch(PERR){g.reportError(PERR)}void 0===index&&(index=-1),void 0===isRemoteChange&&(isRemoteChange=!1),void 0===shouldBeArchived&&(shouldBeArchived=!1);var oldParent=this.parent(),oldInfo=oldParent.findItem(this);if(oldInfo){var dstLocalIndex=index,dstRemoteIndex=index;if(oldParent===parent){if(oldInfo.index===dstLocalIndex)return;oldInfo.index<dstLocalIndex&&dstLocalIndex--}underlying&&(oldInfo.arr=oldInfo.arr()),oldInfo.arr.splice(oldInfo.index,1),this.parent(parent);var arr=shouldBeArchived?parent.archivedItems():parent.items;if(underlying&&(arr=arr()),0>dstLocalIndex?arr.push(this):arr.splice(dstLocalIndex,0,this),this.shouldSave()){var newInfo={index:dstRemoteIndex,isArchived:shouldBeArchived};d.moveItem({item:this,newInfo:newInfo,oldParent:oldParent,oldInfo:oldInfo,isRemoteChange:isRemoteChange,noVersion:noVersion})}}},getItemsArrayForSave:function getItemsArrayForSaveFn(){try{g.PAssert(2321,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}for(var saveItems=[],items=this.items(),i=0;i<items.length;++i)saveItems.push(items[i].id);if(this.hasArchivedChildren())for(var archivedItems=this.archivedItems(!0),i=0;i<archivedItems.length;++i)saveItems.push(archivedItems[i].id);return saveItems},getDateTime:function getDateTimeFn(){return this.date()?this.date().getTime():void 0},getRepeatDate:function getRepeatDateFn(){return this.repeatDate()?this.repeatDate().toString():void 0},getDateCompletedTime:function getDateCompletedTimeFn(){return this.dateCompleted?this.dateCompleted.getTime():void 0},isForceCompleted:function isForceCompletedFn(){return this.dateCompleted&&this.dateCompleted.equals(forceCompleteDate)?!0:!1},getMetaTextSaveData:function getMetaTextSaveDataFn(){var currentDate=this.date(),repeatDate=this.repeatDate(),numDate,numRepeatDate;return void 0!==currentDate&&(numDate=currentDate.getTime()),void 0!==repeatDate&&(numRepeatDate=repeatDate.toString()),{date:numDate,repeatDate:numRepeatDate,dateCompleted:this.getDateCompletedTime()}},_generateNotificationEntry:function _generateNotificationEntryFn(date){var dateJSON=date.toJSON(),alertDateJSON;return alertDateJSON=date.hasTimeOfDay()?new Date(date).addMinutes(-30).toJSON():new Date(date).addDays(-1).setHours(17).toJSON(),{id:this.id,text:this.getParsedText(),date:dateJSON,alertDate:alertDateJSON}},getNotificationEntries:function getNotificationEntriesFn(){try{g.PAssert(2322,this.date()||this.repeatDate(),"Must have a valid date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2323,!this.allDayDate(),"All day dates should not be scheduled")}catch(PERR){g.reportError(PERR)}if(this.allDayDate())return void 0;if(this.date())return this._generateNotificationEntry(this.date());if(this.repeatDate()){for(var entries=[],dates=this.repeatDate().getDates(!0),i=0;i<dates.length;++i)entries.push(this._generateNotificationEntry(dates[i]));return entries}},getDebugData:function getDebugDataFn(){var data={id:this.id,parent:this._parent?this._parent.id:void 0,items:this.isNote()?void 0:this.getItemsArrayForSave(),text:this.getRawText(),note:this.hasNote()?this.getNote().id:void 0,isNote:this.isNote(),isArchived:this.isArchived(),isDeleted:this.isDeleted(),version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return data},getCollapsedData:function getCollapsedDataFn(){return this.isCollapsed()||void 0},getFullSaveData:function getFullSaveDataFn(){try{g.PAssert(2324,this.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var data={id:this.id,text:this.getRawText(),date:this.getDateTime(),repeatDate:this.getRepeatDate(),dateText:this.dateText,dateCreated:this.dateCreated.getTime(),dateCompleted:this.getDateCompletedTime(),priority:this._getPriority()||void 0,isComplete:this.isComplete()||void 0,isStarred:this.isStarred()||void 0,isCollapsed:this.getCollapsedData(),note:this.hasNote()?this.getNote().id:void 0,isArchived:this.isArchived()||void 0,isNote:this.isNote()||void 0,isDeleted:void 0,version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return this.isNote()||(data.items=this.getItemsArrayForSave()),data},save:function saveFn(changes,saveFlags){try{g.PAssert(2325,this.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2326,void 0!==saveFlags,"Must specify saveFlags for the changes that are being saved")}catch(PERR){g.reportError(PERR)}if(changes){var existingItem=d.getItem(this.id);existingItem||changes.id?(changes.items&&(changes.items=this.getItemsArrayForSave()),changes.text&&g.fireCustomEvent("itemTextChanged",{item:this,force:saveFlags===SaveFlag.None})):changes=this.getFullSaveData()}else changes=this.getFullSaveData();d.saveChanges(this,changes,saveFlags)},toggleCollapsed:function toggleCollapsedFn(){this.isCollapsed(!this.isCollapsed())},highlight:function highlightFn(){var self=this;this.highlightTimeout?(this.isHighlighted(!1),clearTimeout(this.highlightTimeout),this.highlightTimeout=0,setTimeout(function(){self.isHighlighted(!0)},0)):this.isHighlighted(!0),this.highlightTimeout=setTimeout(function(){self.isHighlighted(!1)},2e3)},getElement:function getElementFn(paneID){return void 0===paneID&&(paneID=g.focusedPane.id),g.vmMain.paneManager.getPerPaneState(paneID,this.id,PerPaneStateField.Element)},getSpan:function getSpanFn(paneID){var ele=this.getElement(paneID);return ele?ele.firstElementChild:void 0},getOutlineElement:function getOutlineElementFn(paneID){return void 0===paneID&&(paneID=g.focusedPane.id),g.vmMain.paneManager.getPerPaneState(paneID,this.id,PerPaneStateField.OutlineElement)},removeChild:function removeChildFn(child){try{g.PAssert(2331,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2332,!child.isNote(),"Do not use remove child to remove notes from items")}catch(PERR){g.reportError(PERR)}var removedIndex;if(child.isArchived()){try{g.PAssert(2333,this.hasArchivedChildren(),"For a child to be archived, this item must have valid archived children")}catch(PERR){g.reportError(PERR)}this.hasArchivedChildren()&&(this.archivedItems().valueWillMutate(),removedIndex=this.archivedItems(!0).remove(child),this.shouldSave()&&d.removeItem(this,removedIndex,child,!0),this.archivedItems().valueHasMutated())}else this.items.valueWillMutate(),removedIndex=this.items().remove(child),this.shouldSave()&&d.removeItem(this,removedIndex,child,!1),this.items.valueHasMutated();return removedIndex},removeChildAtIndex:function removeChildAtIndexFn(index){try{g.PAssert(2334,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2335,!this.items()[index].isArchived())}catch(PERR){g.reportError(PERR)}this.items.valueWillMutate();var removed=this.items().removeAt(index);return this.shouldSave()&&d.removeItem(this,index,removed,!1),this.items.valueHasMutated(),removed},archiveChild:function archiveChildFn(child){try{g.PAssert(2336,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2337,!child.isNote(),"Do not use archive child on notes")}catch(PERR){g.reportError(PERR)}var retVal=!1;if(!child.isArchived()){tracker.beginAction(),child.isArchived(!0),this.archivedItems().push(child),this.items.valueWillMutate();var removedIndex=this.items().remove(child);this.shouldSave()&&d.archiveItem(this,removedIndex,child),this.items.valueHasMutated(),tracker.endAction(),retVal=!0}return retVal},unarchiveChild:function unarchiveChildFn(child){try{g.PAssert(2338,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2339,!child.isNote(),"Do not use unarchive child on notes")}catch(PERR){g.reportError(PERR)}var retVal=!1;if(child.isArchived()){tracker.beginAction();try{g.PAssert(2340,child.isArchived(),"Child must be archived to be unarchived")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2341,this.hasArchivedChildren(),"Parent must have archived children to unarchive a child")}catch(PERR){g.reportError(PERR)}child.isArchived(!1);var removedIndex=this.archivedItems(!0).remove(child);this.items.push(child),this.shouldSave()&&d.unarchiveItem(this,removedIndex,child),this.archivedItems().valueHasMutated(),tracker.endAction(),retVal=!0}return retVal},_moveChildrenHelper:function _moveChildrenHelperFn(params){var newParent=params.newParent,index=params.index,isArchived=params.isArchived;try{g.PAssert(2342,void 0!==newParent&&void 0!==isArchived,"_moveChildrenHelper is missing parameters")}catch(PERR){g.reportError(PERR)}var oldItems=isArchived?this.archivedItems():this.items,children=oldItems();if(children.length>0){var newItems=isArchived?newParent.archivedItems():newParent.items;!isArchived&&(isNaN(index)||0>index)&&(index=newItems().length),oldItems.valueWillMutate(),newItems.valueWillMutate();for(var i=0;children.length>0;){try{g.PAssert(2343,children[i]!==newParent,"Should never be reparenting to a child")}catch(PERR){g.reportError(PERR)}var id=children[0];children[0].moveTo({parent:newParent,index:index+i,shouldBeArchived:isArchived,underlying:!0}),tracker.performAction(TrackerType.Move,{itemID:id,oldParent:this.id,oldPosition:i,newParent:newParent.id,newPosition:index+i}),i++}oldItems.valueHasMutated(),newItems.valueHasMutated()}},moveChildren:function moveChildrenFn(newParent,index){try{g.PAssert(2344,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2345,this.id!==newParent.id,"Do not use moveChildren to move a child to the same parent")}catch(PERR){g.reportError(PERR)}if(newParent.parent()===this){var oldIndex=this.removeChild(newParent);tracker.performAction(TrackerType.Delete,{itemID:newParent.id,parent:this.id,position:oldIndex})}this._moveChildrenHelper({newParent:newParent,index:index,isArchived:!1}),this._moveChildrenHelper({newParent:newParent,index:index,isArchived:!0})},deleteSelf:function deleteSelfFn(){this.parent().deleteChild(this),this.parent(void 0)},deleteChild:function deleteChildFn(child,newParent,newIndex){try{g.PAssert(2346,child,"Must provide a valid child to delete")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2347,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}if(tracker.beginAction(),child.isNote())this.setNote(void 0);else if(child.hasChildren()||child.hasArchivedChildren())if(newParent)child.moveChildren(newParent,newIndex);else for(var childItems=child.items(),i=childItems.length-1;i>=0;i--)child.deleteChild(childItems[i]);if(!child.isDeleted()){if(!child.isNote()){var oldIndex=this.removeChild(child);tracker.performAction(TrackerType.Delete,{itemID:child.id,parent:this.id,position:oldIndex})}d.deleteItem(child)}g.timeline.notifyStateChanged(child),tracker.endAction()},replaceChild:function replaceChildFn(oldChild,newChild){try{g.PAssert(2348,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2349,!oldChild.isNote(),"Old child should not be a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2350,!newChild.isNote(),"New child should not be a note")}catch(PERR){g.reportError(PERR)}var index=oldChild.getIndex();this.items().removeAt(index),tracker.performAction(TrackerType.Delete,{itemID:oldChild.id,parent:this.id,position:index}),d.deleteItem(oldChild),newChild.moveTo({parent:this,index:index}),d.removeItem(this,index+1,oldChild,!1),oldChild.moveChildren(newChild,newChild.numChildren());var newChildOldParentID=newChild.parent().id;if(newChildOldParentID!==this.id){var newChildOldIndex=newChild.parent().items().remove(newChild);tracker.performAction(TrackerType.Move,{itemID:newChild.id,oldParent:newChildOldParentID,oldPosition:newChildOldIndex,newParent:this.id,newPosition:index})}this.items.valueHasMutated()},getChildren:function getChildrenFn(){return this.isNote()?void 0:this.hasNote()?[this.getNote()].concat(this.items()):this.items()},getChild:function getChildFn(index){try{g.PAssert(2351,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2352,index<this.items().length)}catch(PERR){g.reportError(PERR)}return this.items()[index]},getFirstChild:function getFirstChildFn(){try{g.PAssert(2353,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.hasChildren()?this.items()[0]:void 0},isFirstChild:function isFirstChildFn(){try{g.PAssert(2354,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.parent()?this.parent().getFirstChild()===this:!1},getLastChild:function getLastChildFn(){try{g.PAssert(2355,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.hasChildren()?this.items()[this.items().length-1]:void 0},isLastChild:function isLastChildFn(){try{g.PAssert(2356,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.parent()?this.parent().getLastChild()===this:!1},isDescendantOf:function isDescendantOfFn(ancestor){for(var check=this.parent();check&&check!==ancestor;)check=check.parent();return void 0!==check},getChildIndex:function getChildIndexFn(child){try{g.PAssert(2357,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2358,!child.isNote(),"Should not get the index of an item note")}catch(PERR){g.reportError(PERR)}return this.getIndexOf(child.id,child.isArchived())},getIndexOf:function getIndexOfFn(id,isArchived){try{g.PAssert(2359,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}id.id&&(id=id.id);var index=-1,arr;if(isArchived?this.hasArchivedChildren()&&(arr=this.archivedItems(!0)):arr=this.items(),arr)for(var i=0;i<arr.length;++i)if(arr[i].id===id){index=i;break}return index},getRemoteIndexOf:function getRemoteIndexOfFn(item,isArchived){try{g.PAssert(2361,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2362,!item.isNote(),"Should never be getting a remote child index of a note")}catch(PERR){g.reportError(PERR)}var remoteList=gdata.getItemList(this.data,isArchived),index=-1;return remoteList&&(index=remoteList.indexOf(item)),index},getIndex:function getIndexFn(){try{g.PAssert(2364,!this.isNote(),"Should never be getting a child index of a note")}catch(PERR){g.reportError(PERR)}return this.parent().getChildIndex(this)},hasChildren:function hasChildrenFn(){return this.isNote()?!1:this.items().length>0},numChildren:function numChildrenFn(){try{g.PAssert(2365,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.items().length},canZoom:function canZoomFn(){return this.isNote()?!1:this.numChildren()>0||this.getParsedText().length>0},parents:function parentsFn(){for(var parents=[],parent=this;parent;)parents.splice(0,0,parent),parent=parent.parent();return parents},getSiblings:function getSiblingsFn(startIndex){try{g.PAssert(2366,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}startIndex=startIndex||0;var arr=[];if(this.parent())for(var items=this.parent().items(),i=0,_l=items.length;_l>i;i++)items[i]!==this&&arr.push(items[i]);return arr},isPaneRoot:function isPaneRootFn(context){if(context)for(var i=context.$parents.length-1;i>=0;i--)if(context.$parents[i]instanceof g.VMPane)return this===context.$parents[i].item()},clone:function cloneFn(changeType){for(var items=[],i=0;i<this.items().length;i++)items.push(this.items()[i].clone());return new VMLI({text:this.getRawText(),isComplete:this.isComplete(),items:items},{parent:this.parent(),forceSave:!0,changeType:changeType})}},util.defineBase(VMLI),util.extend(VMLI.prototype,VMLI_TapHandlers),util.extend(VMLI.prototype,VMLI_Text),util.extend(VMLI.prototype,VMLI_Drive(VMLI)),VMLI}),define("edit",["ko","globals","platform","android","VMLI","tracker"],function(ko,g,platform,android,VMLI,tracker){function updateSelection(){if(android.isEnabled()){if(!android.getCurrentVMLI())return range=void 0,rangeStartContainer=void 0,rangeEndContainer=void 0,rangeStart=void 0,rangeEnd=void 0,!0;range=void 0,rangeStartContainer=rangeEndContainer=android.getCurrentSpan(),rangeStart=android.getSelectionStart(),rangeEnd=android.getSelectionEnd()}else{if(range=g.getSelectionRange(),!range)return rangeStartContainer=void 0,rangeEndContainer=void 0,rangeStart=void 0,rangeEnd=void 0,!0;rangeStartContainer=range.startContainer,rangeEndContainer=range.endContainer,rangeStart=range.startOffset,rangeEnd=range.endOffset}}function checkKeypressSpecialCases(e,character){var forceValid;return e.ctrlKey&&e.altKey&&character?forceValid=!0:e.metaKey&&e.normCode===KeyCode.Tilde&&(forceValid=!1),forceValid}function allowTextEditing(item){try{g.PAssert(2377,item,"Must provide a valid item to check")}catch(PERR){g.reportError(PERR)}return!platform.mobile||android.isEnabled()||!item.hasAttachments()}var self={},range,rangeStartContainer,rangeEndContainer,rangeStart,rangeEnd,keyCodesDown=[KeyCode.Tab,KeyCode.BackSpace,KeyCode.Delete],keyCodesArrows=[KeyCode.UpArrow,KeyCode.DownArrow,KeyCode.LeftArrow,KeyCode.RightArrow,KeyCode.Home,KeyCode.End],textSaveInfo={},tempInput,lastKeypress,StringNewLine=String.fromCharCode(10);return self.updateAutocomplete=function updateAutocompleteFn(e){var fromArrows=e.normCode&&keyCodesArrows.indexOf(e.normCode)>=0;if(g.autocomplete)if(android.isEnabled()){var span=android.getCurrentSpan();span?g.autocomplete.update({owner:android.getCurrentVMLI(),start:android.getSelectionStart(),fromArrows:fromArrows}):g.autocomplete.hide()}else{var range=g.getSelectionRange();if(range){var startLI=g.getLIParent(range.startContainer),endLI=g.getLIParent(range.endContainer);if(startLI&&startLI===endLI&&range.startOffset===range.endOffset&&"UL"!==range.startContainer.tagName){var item=ko.dataFor(startLI);try{g.PAssert(2367,item,"There should always be a valid item")}catch(PERR){g.reportError(PERR)}if(item){var span=item.getSpan();try{g.PAssert(2368,span,"Items should always have a valid span if we are performing updates in a VMPane")}catch(PERR){g.reportError(PERR)}if(span){g.restrictSelectionToText(),updateSelection();var offset=g.getSelectOffsetsInSpan(span,g.getSelectionRange());
offset.start===offset.end&&g.autocomplete.update({owner:item,start:offset.start,fromArrows:fromArrows})}else g.autocomplete.hide()}else g.autocomplete.hide()}}}},self.keyup=function keyupFn(element,e){textSaveInfo.item&&(tracker.beginAction(),void 0!==textSaveInfo.text&&textSaveInfo.item.setText(textSaveInfo.text,!0,ChangeType.Local),textSaveInfo.nextItem?g.selectChildren(textSaveInfo.nextItem,0,0):g.selectChildren(textSaveInfo.item,textSaveInfo.start,0),self.updateAutocomplete(e),tracker.endAction()),textSaveInfo.item=void 0,textSaveInfo.nextItem=void 0,textSaveInfo.text=void 0,textSaveInfo.start=void 0,textSaveInfo.waitAutocorrect=void 0,(e.normCode===KeyCode.Enter||e.normCode===KeyCode.PageUp||e.normCode===KeyCode.PageDown)&&self.scrollTextIntoView();try{g.PAssert(2369,e.stopImmediatePropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopImmediatePropagation&&e.stopImmediatePropagation();try{g.PAssert(2370,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),e.handled?!0:void 0},self.scrollTextIntoView=function scrollTextIntoViewFn(time){if(isNaN(time)&&(time=200),!g.isScrolling&&(updateSelection(),rangeEndContainer&&"UL"!==rangeEndContainer.tagName&&"LI"!==rangeEndContainer.tagName&&!g.hasClass(rangeEndContainer,"search"))){var scrollSpan=g.getSpanParent(rangeEndContainer);if(scrollSpan){var currentItem=android.isEnabled()?android.getCurrentVMLI():ko.dataFor(scrollSpan);if(currentItem){try{g.PAssert(2372,currentItem instanceof VMLI,"The currently selected item should always be a VMLI instance")}catch(PERR){g.reportError(PERR)}if(currentItem instanceof VMLI){var targetSpan=currentItem.getSpan();g.scrollIntoView(targetSpan,time)}}}}},self.handleSelectAll=function handleSelectAllFn(pane){updateSelection();var firstItem=g.getFirstPaneItem(pane),lastItem=g.getLastPaneItem(pane);return firstItem&&lastItem&&g.selectMultiline(firstItem.getSpan(),0,lastItem.getSpan(),lastItem.getParsedText().length),!1},self.handleSelectAllItem=function handleSelectAllItemFn(){g.restrictSelectionToText(),updateSelection();var item=g.getSelectedItem();return item&&g.selectMultiline(item.getSpan(),0,item.getSpan(),item.getParsedText().length),!1},self._move=function _moveFn(direction,e){try{g.PAssert(2373,-1===direction||1===direction,"Must move in a direction")}catch(PERR){g.reportError(PERR)}g.restrictSelectionToText(),updateSelection();var firstItem=ko.dataFor(g.getSpanParent(rangeStartContainer)),lastItem=ko.dataFor(g.getSpanParent(rangeEndContainer)),ok=!1;if(firstItem.parent()===lastItem.parent()&&(ok=!0),!ok){var next=g.getNextItem(lastItem,g.focusedPane,{sameLevel:!0});if(!next)for(;lastItem;){if(firstItem.parent()===lastItem.parent()){ok=!0;break}lastItem=lastItem.parent()}}if(ok){var moveItem,index;0>direction?(moveItem=g.getPreviousItem(firstItem,g.focusedPane,{sameLevel:!0}),index=lastItem.getIndex()+1):(moveItem=g.getNextItem(lastItem,g.focusedPane,{sameLevel:!0}),index=firstItem.getIndex()),moveItem&&(tracker.beginAction(),moveItem.moveTo({parent:moveItem.parent(),index:index}),tracker.endAction(),g.scrollIntoView(moveItem.getSpan()))}},self.moveUp=function moveUpFn(e){self._move(-1,e)},self.moveDown=function moveDownFn(e){self._move(1,e)},self.handleArrows=function handleArrowsFn(element,e){if(g.restrictSelectionToText(),updateSelection(),platform.mac&&e.metaKey&&e.normCode===KeyCode.UpArrow||!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.Home){var firstItem=g.getFirstPaneItem(g.focusedPane);return firstItem&&(e.shiftKey?g.selectMultiline(firstItem.getSpan(),0,rangeEndContainer,rangeEnd):g.selectChildren(firstItem,0,0),g.scrollIntoView(firstItem.getSpan())),!1}if(platform.mac&&e.metaKey&&e.normCode===KeyCode.DownArrow||!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.End){var lastItem=g.getLastPaneItem(g.focusedPane);return lastItem&&(e.shiftKey?g.selectMultiline(rangeStartContainer,rangeStart,lastItem.getSpan(),lastItem.getParsedText().length):g.selectChildren(lastItem,lastItem.getParsedText().length,0),g.scrollIntoView(lastItem.getSpan())),!1}if(!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.UpArrow&&rangeStartContainer){var item=ko.dataFor(g.getSpanParent(rangeStartContainer)),focusItem;if(item.parent()===g.focusedItem){if(!item.isFirstChild()){try{g.PAssert(2374,item.getIndex()>0,"Should never hit this with the first item in the list")}catch(PERR){g.reportError(PERR)}focusItem=item.parent().getChild(item.getIndex()-1)}}else{for(;item.parent()!==g.focusedItem;)item=item.parent();focusItem=item}return void 0!==focusItem&&(g.selectChildren(focusItem,focusItem.getParsedText().length,0),g.scrollIntoView(focusItem.getSpan())),!1}if(!platform.mac&&e.ctrlKey&&e.normCode===KeyCode.DownArrow&&rangeEndContainer){var item=ko.dataFor(g.getSpanParent(rangeEndContainer)),focusItem;if(item.parent()===g.focusedItem)item.isLastChild()||(focusItem=item.parent().getChild(item.getIndex()+1));else{for(;item.parent()!==g.focusedItem;)item=item.parent();item.isLastChild()||(focusItem=item.parent().getChild(item.getIndex()+1))}return void 0!==focusItem&&(g.selectChildren(focusItem,focusItem.getParsedText().length,0),g.scrollIntoView(focusItem.getSpan())),!1}if(void 0===rangeStartContainer||void 0===rangeEndContainer)return!0;if(e.normCode===KeyCode.LeftArrow||e.normCode===KeyCode.RightArrow){if(updateSelection(),!e.altKey||!e.shiftKey){var li=g.getLIParent(rangeStartContainer),li2=g.getLIParent(rangeEndContainer);if(li&&li2&&li===li2){var item=ko.dataFor(li);if(item){var offsets=g.getSelectOffsetsInSpan(item.getSpan(),g.getSelectionRange());if(0===item.getParsedText().length){if(e.normCode===KeyCode.LeftArrow){var prev=g.getPreviousItem(item,g.focusedPane);prev&&g.selectChildren(prev,prev.getParsedText().length,0)}else if(e.normCode===KeyCode.RightArrow){var next=g.getNextItem(item,g.focusedPane);next&&g.selectChildren(next,0,0)}return!1}if(e.normCode===KeyCode.LeftArrow&&0===offsets.startText){var prev=g.getPreviousItem(item,g.focusedPane,{includeNotes:!0});if(prev&&prev.isNote())return g.selectChildren(prev.parent(),prev.parent().getParsedText().length,0),!1;if(prev&&prev.getParsedText()[prev.getParsedText().length-1]===window.AttachChar)return g.selectChildren(prev,prev.getParsedText().length,0),!1}else if(e.normCode===KeyCode.RightArrow&&offsets.endText===item.getParsedText().length){var next=g.getNextItem(item,g.focusedPane,{includeNotes:!0});if(next&&next.isNote()){var nextSelect=g.getNextItem(next,g.focusedPane);return nextSelect&&g.selectChildren(nextSelect,0,0),!1}if(next&&next.getParsedText()[0]===window.AttachChar)return g.selectChildren(next,0,0),!1}else if(e.altKey&&e.normCode===KeyCode.LeftArrow){var lastWord=item.getParsedText().prevIndexOf(" ",offsets.startText-1),lastPlugin=item.getParsedText().prevIndexOf(window.AttachChar,offsets.startText);if(lastPlugin>lastWord){var newSel=lastPlugin+1;return lastPlugin+1===offsets.startText&&newSel--,g.selectChildren(item,newSel,0),!1}}else if(e.altKey&&e.normCode===KeyCode.RightArrow){var nextWord=item.getParsedText().indexOf(" ",offsets.endText),nextPlugin=item.getParsedText().indexOf(window.AttachChar,offsets.endText);if((nextWord>nextPlugin||0>nextWord)&&nextPlugin>=0){var newSel=nextPlugin;return nextPlugin===offsets.endText&&newSel++,g.selectChildren(item,newSel,0),!1}}else if(platform.isFirefox)if(e.normCode===KeyCode.LeftArrow){var prevChar=item.getParsedText()[offsets.startText-1];if(prevChar===window.AttachChar&&!e.shiftKey)return g.selectChildren(item,offsets.startText-1,0),!1}else if(e.normCode===KeyCode.RightArrow){var nextChar=item.getParsedText()[offsets.endText];if(nextChar===window.AttachChar&&!e.shiftKey)return g.selectChildren(item,offsets.endText+1,0),!1}}}}}else if(e.normCode===KeyCode.UpArrow||e.normCode===KeyCode.DownArrow){updateSelection();var startItem=g.getItemForElement(rangeStartContainer),endItem=g.getItemForElement(rangeEndContainer),lineInfo,selStart=rangeStart,selEnd=rangeEnd,oldItem,newItem,needSkipNote;e.normCode!==KeyCode.UpArrow||startItem.isNote()?e.normCode!==KeyCode.DownArrow||endItem.isNote()||(lineInfo=g.computeSelectionLine(endItem.getSpan()),lineInfo.current===lineInfo.total&&(oldItem=endItem,newItem=g.getNextItem(endItem,g.focusedPane),needSkipNote=newItem&&startItem===endItem&&endItem.hasNote())):(lineInfo=g.computeSelectionLine(startItem.getSpan()),1===lineInfo.current&&(oldItem=startItem,newItem=g.getPreviousItem(startItem,g.focusedPane),needSkipNote=newItem&&startItem===endItem&&newItem.hasNote()));var itemText=newItem&&newItem.getParsedText(),needArrowOverride=itemText&&(platform.ie&&0===itemText.length||1===itemText.length&&itemText[0]===window.AttachChar);if(needArrowOverride||needSkipNote)return e.shiftKey?(selStart=Math.min(oldItem.getParsedText().length,selStart),selEnd=Math.min(newItem.getParsedText().length,selEnd),g.selectMultiline(oldItem.getSpan(),selStart,newItem.getSpan(),selEnd)):(selStart=Math.min(newItem.getParsedText().length,selStart),g.selectChildren(newItem,selStart,0)),g.scrollIntoView(newItem.getSpan(),0),!1}return self.updateAutocomplete(e),!0},self.keydown=function keydownFn(element,e){var ret=!0;if(keyCodesDown.indexOf(e.normCode)>=0)ret=self.keypress(element,e,!0);else if(platform.mac&&e.ctrlKey&&e.normCode===KeyCode.D)ret=self.keypress(element,e,!0);else if(keyCodesArrows.indexOf(e.normCode)>=0)ret=self.handleArrows(element,e);else if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){if(e.normCode===KeyCode.A&&!e.shiftKey)return self.handleSelectAll(element);if(e.normCode===KeyCode.Y||e.normCode===KeyCode.Z)return self.keypress(element,e,!0)}switch(e.normCode){case KeyCode.Enter:platform.mobile||self.scrollTextIntoView();break;case KeyCode.UpArrow:platform.mac&&!e.metaKey&&self.scrollTextIntoView(100);break;case KeyCode.DownArrow:platform.mac&&!e.metaKey&&self.scrollTextIntoView(100);break;default:var validCharacter=e.normCode>=32&&e.normCode<=90||e.normCode===KeyCode.Enter;!validCharacter||platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey||self.scrollTextIntoView()}return ret},self.keypress=function keypressFn(element,e,fromKeydown){var keyCodes=[KeyCode.Enter,KeyCode.D];try{g.PAssert(2378,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopPropagation&&e.stopPropagation();var returnValue=!0,validCharacter=e.normCode>=32||keyCodes.indexOf(e.normCode)>=0,skipCharacter=platform.mobile&&e.normCode===KeyCode.Delete||0===e.which;if(!skipCharacter&&(fromKeydown||validCharacter)){if(updateSelection(),!range&&!android.isEnabled())return!0;if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){if(e.normCode===KeyCode.Y||e.normCode===KeyCode.Z){e.normCode!==KeyCode.Z||e.shiftKey?(tracker.redoAction(),g.sendEvent("Hotkey","Redo")):(tracker.undoAction(),g.sendEvent("Hotkey","Undo")),e.handled=!0;try{g.PAssert(2379,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!0}var keyChar=String.fromCharCode(e.normCode);switch(keyChar){case"c":case"C":return e.handled=!0,!0;case"v":case"V":return e.handled=!0,!0;case"x":case"X":return e.handled=!0,!0;case"r":case"R":case"a":case"A":case"t":case"T":return e.handled=!0,!0}}var item;if("UL"===rangeStartContainer.nodeName){var pane=ko.dataFor(rangeStartContainer);pane instanceof VMLI||(item=pane.addItemToPane("",0),g.selectChildren(item,0,0))}g.restrictSelectionToText(),updateSelection();var startSpan=g.getSpanParent(rangeStartContainer),endSpan=g.getSpanParent(rangeEndContainer);if(!startSpan||!endSpan)return e.stopPropagation(),e.preventDefault(),!1;tracker.beginAction(),startSpan!==endSpan&&e.normCode!==KeyCode.Tab&&(returnValue=returnValue&&self.handleMultiselect(e,startSpan,endSpan,range));var specialKeys=[KeyCode.Tab,KeyCode.Enter,KeyCode.BackSpace,KeyCode.Delete,KeyCode.D];if(returnValue&&specialKeys.indexOf(e.normCode)>=0){var span=g.getSpanParent(rangeStartContainer);try{g.PAssert(2380,android.isEnabled()||span&&"SPAN"===span.tagName,"Expected SPAN, Actual: "+(span?span.tagName:"UNDEFINED"))}catch(PERR){g.reportError(PERR)}if(span){item||(item=g.getItemForElement(span));var treatBackspaceLikeTab=!1;if(e.shiftKey&&e.normCode===KeyCode.BackSpace){var startOffset=g.getSelectOffsetsInSpan(span,range);0===startOffset.start&&(treatBackspaceLikeTab=!0)}e.normCode===KeyCode.Tab||treatBackspaceLikeTab?returnValue=returnValue&&self.handleTab(e,range):e.normCode===KeyCode.Enter?returnValue=returnValue&&self.handleEnter(e,span,range):e.normCode===KeyCode.BackSpace?allowTextEditing(item)?(returnValue=returnValue&&self.handleBackspace(e,span,range),textSaveInfo.item||self.updateAutocomplete(e)):returnValue=!1:(e.normCode===KeyCode.Delete||platform.mac&&e.ctrlKey&&e.normCode===KeyCode.D)&&(returnValue=allowTextEditing(item)?returnValue&&self.handleDelete(e,span,range):!1)}}var keyCode=e.normCode;e.normCode!==KeyCode.Period||fromKeydown||(keyCode=KeyCode.Delete);var character=String.fromCharCode(keyCode),isValid=returnValue&&character&&e.normCode!==KeyCode.BackSpace&&e.normCode!==KeyCode.Enter&&!e.ctrlKey,forceValid=checkKeypressSpecialCases(e,character);if(forceValid===!0?isValid=!0:forceValid===!1&&(isValid=!1),isValid){updateSelection();try{g.PAssert(2381,g.getSpanParent(rangeStartContainer)===g.getSpanParent(rangeEndContainer),"Should not be handling multiselect here")}catch(PERR){g.reportError(PERR)}var span=g.getSpanParent(rangeStartContainer);try{g.PAssert(2382,android.isEnabled()||span&&"SPAN"===span.tagName,span.tagName)}catch(PERR){g.reportError(PERR)}item||(item=g.getItemForElement(span));try{g.PAssert(2383,item,"Must be able to get a valid item from the selected span")}catch(PERR){g.reportError(PERR)}if(allowTextEditing(item)){var offsets=g.getSelectOffsetsInSpan(span,range),s;s=android.isEnabled()?android.getInputText():item.getParsedText();var newText=s.substr(0,offsets.startText)+character+s.substr(offsets.endText);if(offsets.startText!==offsets.endText&&tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:s.slice(offsets.startText,offsets.endText)}),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:offsets.startText,text:character}),platform.ios)textSaveInfo.text=newText,textSaveInfo.start=offsets.start+1,textSaveInfo.waitAutocorrect=" "===character?"space":void 0,textSaveInfo.item=item,returnValue=!0;else{g.clearSelection(),item.setText(newText,!0,ChangeType.Local),g.selectChildren(item,offsets.start+1,0),returnValue=!1;try{g.PAssert(2384,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.preventDefault&&e.preventDefault(),self.updateAutocomplete(e)}}else returnValue=!1}tracker.endAction()}return lastKeypress=e.normCode,returnValue},self.textInputiOS7=function textInputiOS7Fn(element,e){if(textSaveInfo.item&&textSaveInfo.waitAutocorrect&&" "!==e.data&&e.data!==StringNewLine){var item=textSaveInfo.item,span="enter"===textSaveInfo.waitAutocorrect?tempInput:item.getSpan(),s=item.getParsedText();updateSelection();var offsets=g.getSelectOffsetsInSpan(span,range),oldLength=offsets.endText-offsets.startText,insertText="space"===textSaveInfo.waitAutocorrect?" ":"";textSaveInfo.text=s.substr(0,offsets.startText)+e.data+insertText+s.substr(offsets.endText),textSaveInfo.start+=e.data.length-oldLength,textSaveInfo.waitAutocorrect=void 0}return!0},self.textInputiOS8=function textInputiOS8Fn(element,e){try{g.PAssert(2385,platform.ios||platform.mac||platform.windows,"Should only ever use textInput events on iOS or OSX")}catch(PERR){g.reportError(PERR)}var returnValue=!0;try{g.PAssert(2386,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopPropagation&&e.stopPropagation(),g.restrictSelectionToText(),updateSelection();try{g.PAssert(2387,"#text"===rangeStartContainer.nodeName||"SPAN"===rangeStartContainer.nodeName,"Expected SPAN, Actual: "+rangeStartContainer.tagName)}catch(PERR){g.reportError(PERR)}var startSpan=g.getSpanParent(rangeStartContainer);try{g.PAssert(2388,"#text"===rangeEndContainer.nodeName||"SPAN"===rangeEndContainer.nodeName,"Expected SPAN, Actual: "+rangeEndContainer.tagName)}catch(PERR){g.reportError(PERR)}var endSpan=g.getSpanParent(rangeEndContainer);if(!startSpan||!endSpan)return e.stopPropagation(),e.preventDefault(),!1;try{g.PAssert(2389,startSpan===endSpan,"We should only be selecting a single line")}catch(PERR){g.reportError(PERR)}tracker.beginAction();var incText=e.data;try{g.PAssert(2390,void 0!==incText&&incText.length>0,"Must have valid incoming text")}catch(PERR){g.reportError(PERR)}var incTextLength=incText?incText.length:0,item=g.getItemForElement(startSpan);try{g.PAssert(2391,item,"Must be able to get a valid item from the selected span")}catch(PERR){g.reportError(PERR)}var offsets=g.getSelectOffsetsInSpan(startSpan,range),s=item.getParsedText(),delLength=s.length-offsets.totalText;if(offsets.startText!==offsets.endText&&0===delLength){var endIndex=s.indexOf(" ",offsets.endText);0>endIndex&&(endIndex=s.length);var fullWord=s.substring(offsets.startText,endIndex),trimWord=g.trimPunc(fullWord);try{g.PAssert(2393,offsets.endText<=offsets.startText+trimWord.length,"Should never shorten a word being replaced by autocomplete")}catch(PERR){g.reportError(PERR)}offsets.endText=offsets.startText+trimWord.length;try{g.PAssert(2394,offsets.endText<=offsets.totalText)}catch(PERR){g.reportError(PERR)}}var newText=s.substr(0,offsets.startText)+incText+s.substr(offsets.endText+delLength);offsets.startText!==offsets.endText&&tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:s.slice(offsets.startText,offsets.endText)}),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:offsets.startText,text:incText}),g.clearSelection(),item.setText(newText,!0,ChangeType.Local),g.selectChildren(item,offsets.start+incTextLength,0),returnValue=!1;try{g.PAssert(2395,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),self.updateAutocomplete(e),tracker.endAction(),textSaveInfo.item=void 0,returnValue},self.handleMultiselect=function handleMultiselectFn(e,startSpan,endSpan,range){var arrToDelete=[],levelsDeep=0,returnValue=!0,startLI=startSpan.parentNode,endLI=endSpan.parentNode;try{g.PAssert(2396,"LI"===startLI.tagName,"Expected LI, Actual: ",startLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2397,"LI"===endLI.tagName,"Expected LI, Actual: ",endLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2398,startLI!==endLI,"Multiselect should only handle cases where multiple VMLIs are selected")}catch(PERR){g.reportError(PERR)}var startItem=g.getItemForElement(startLI);try{g.PAssert(2399,startItem,"Must always have a valid start item")}catch(PERR){g.reportError(PERR)}var endItem=g.getItemForElement(endLI);try{g.PAssert(2400,endItem,"Must always have a valid end item")}catch(PERR){g.reportError(PERR)}if(startItem.isNote()&&(startItem=startItem.parent()),endItem.isNote()&&(endItem=endItem.parent()),startItem===endItem)return!1;if(e.normCode===KeyCode.Enter&&e.shiftKey)return!0;var nextItem=startItem,startOffset=g.getSelectOffsetsInSpan(startSpan,range),endOffset=g.getSelectOffsetsInSpan(endSpan,range),fscount=0;do{var nextItemOptions={numLevels:0};nextItem=g.getNextItem(nextItem,g.focusedPane,nextItemOptions),nextItem&&(nextItem.parent()===g.focusedPane.item()&&nextItem.isHeader()&&fscount++,levelsDeep+=nextItemOptions.numLevels,(nextItem!==endItem||endOffset.end===endOffset.total)&&arrToDelete.push(nextItem))}while(nextItem&&nextItem!==endItem);var doAction=!0;if(arrToDelete.length>=16&&fscount>=2&&(doAction=confirm("You have selected a large number of items to delete, please confirm you want to perform this action.")),doAction){var newStartText;if(startOffset.start>0||endOffset.end<endOffset.total){var startTextInfo=startItem.splitUsableText(startItem.getParsedText(),startOffset.startText,startOffset.startText),textAddedInfo=endItem.splitUsableText(endItem.getParsedText(),endOffset.endText,endOffset.endText);newStartText=startTextInfo.before+textAddedInfo.after,tracker.performAction(TrackerType.Remove,{itemID:startItem.id,position:startOffset.startText,text:startItem.getParsedText().slice(startOffset.startText)}),tracker.performAction(TrackerType.Insert,{itemID:startItem.id,position:startOffset.startText,text:endItem.getParsedText().substring(endOffset.endText)}),arrToDelete.indexOf(endItem)<0&&arrToDelete.push(endItem),0===startOffset.start&&startItem.copyProperties(endItem)}else tracker.performAction(TrackerType.Remove,{itemID:startItem.id,position:0,text:startItem.getParsedText()}),newStartText="";if((e.normCode===KeyCode.BackSpace||e.normCode===KeyCode.Delete||e.normCode===KeyCode.Enter)&&(returnValue=!1),endItem.moveChildren(startItem,0),levelsDeep>0){var arrToMove=[],next;next=endLI.children.length>1?endLI.children[1].children[0]:endLI.nextElementSibling;for(var nextChild=next;levelsDeep>0&&nextChild;){for(levelsDeep--;void 0!==nextChild&&null!==nextChild;)arrToMove.push(nextChild),nextChild=nextChild.nextElementSibling;next=next.parentElement.parentElement,nextChild=next.nextElementSibling}if(arrToMove.length>0)for(var parentToMoveTo=startItem,index=0,i=0;i<arrToMove.length;i++){var item=ko.dataFor(arrToMove[i]),oldParent=item.parent();if(arrToDelete.indexOf(oldParent)>=0){item.moveTo({parent:parentToMoveTo,index:index});var oldIndex=item.parent().getIndexOf(item);tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:oldParent.id,oldPosition:oldIndex,newParent:parentToMoveTo.id,newPosition:index}),index++}}}else if(arrToDelete.indexOf(endItem.parent())>=0)for(var parentToMoveTo=startItem.parent(),item=g.getNextItem(endItem,g.focusedPane,{sameLevel:!0});item;){var index=parentToMoveTo.items().length,oldParent=item.parent(),oldIndex=oldParent.getIndexOf(item);item.moveTo({parent:parentToMoveTo,index:index}),tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:oldParent.id,oldPosition:oldIndex,newParent:parentToMoveTo.id,newPosition:index}),item=g.getNextItem(endItem,g.focusedPane,{sameLevel:!0})}for(var i=0;i<arrToDelete.length;i++){var item=arrToDelete[i];try{g.PAssert(2401,item,"Item must exist")}catch(PERR){g.reportError(PERR)}item.isDeleted()||item.parent().deleteChild(item)}startItem.setText(newStartText,!0,ChangeType.Local),g.selectChildren(startItem,startOffset.start,0)}else returnValue=!1;return returnValue},self.handleTab=function handleTabFn(e,range){var startItem,endItem;if(android.isEnabled())startItem=android.getCurrentVMLI(),endItem=android.getCurrentVMLI();else{var startSpan=g.getSpanParent(range.startContainer),endSpan=g.getSpanParent(range.endContainer),startOffset=g.getSelectOffsetsInSpan(startSpan,range),endOffset=g.getSelectOffsetsInSpan(endSpan,range);try{g.PAssert(2402,"LI"===startSpan.parentNode.tagName,"Expected LI, Actual: ",startSpan.parentNode)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2403,"LI"===endSpan.parentNode.tagName,"Expected LI, Actual: ",endSpan.parentNode)}catch(PERR){g.reportError(PERR)}startItem=g.getItemForElement(startSpan.parentNode),endItem=g.getItemForElement(endSpan.parentNode)}var origStartItem=startItem;startItem.isNote()&&(startItem=startItem.parent());var origEndItem=endItem;endItem.isNote()&&(endItem=endItem.parent());var nextItem=startItem,needUpdate={},itemsToTab=[startItem],newParent,moved={},itemsHighlighted={};if(itemsHighlighted[startItem.id]=!0,startItem!==endItem)do{var nextItemOptions={numLevels:0,ignoreSearch:!0};nextItem=g.getNextItem(nextItem,void 0,nextItemOptions),nextItem&&(itemsToTab.push(nextItem),itemsHighlighted[nextItem.id]=!0)}while(nextItem!==endItem&&void 0!==nextItem);var i,condition,increment;if(e.shiftKey)var initial=function(){i=itemsToTab.length-1},condition=function(){return i>=0},increment=function(){i--};else var initial=function(){i=0},condition=function(){return i<itemsToTab.length},increment=function(){i++};for(initial();condition();increment()){var item=itemsToTab[i];try{g.PAssert(2404,item,"Must always be tabbing/untabbing valid items")}catch(PERR){g.reportError(PERR)}var parent=item.parent(),index=parent.items().indexOf(item),ok,u;if(e.shiftKey){if(ok=item.parent()!==g.focusedItem){newParent=item.parent().parent();var parentItems=parent.items();for(u=index+1;parentItems[index+1];){var siblingItem=parentItems[index+1];itemsHighlighted[siblingItem.id]||g.hasClass(siblingItem.getElement(),"hidden")?index++:(needUpdate[siblingItem.parent().id]=siblingItem.parent(),needUpdate[item.id]=item,siblingItem.moveTo({parent:item,underlying:!0}),moved[siblingItem.id]=!0,tracker.performAction(TrackerType.Move,{itemID:siblingItem.id,oldParent:parent.id,oldPosition:u,newParent:item.id,newPosition:item.items().length-1})),u++}if(itemsHighlighted[parent.id]>=0&&(!parent.parent()||parent.parent()!==g.focusedItem))continue;var parentIndex=newParent.items().indexOf(parent);needUpdate[item.parent().id]=item.parent(),needUpdate[newParent.id]=newParent,item.moveTo({parent:newParent,index:parentIndex+1,underlying:!0}),moved[item.id]=!0,tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:parent.id,oldPosition:index,newParent:newParent.id,newPosition:parentIndex+1})}}else{if(ok=index>0){for(newParent=parent.items()[index-1];g.hasClass(newParent.getElement(),"hidden");){if(index--,0>=index)return!1;newParent=parent.items()[index-1]}moved[parent.id]||(needUpdate[item.parent().id]=item.parent(),needUpdate[newParent.id]=newParent,item.moveTo({parent:newParent,underlying:!0})),moved[item.id]=!0,tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:parent.id,oldPosition:index,newParent:newParent.id,newPosition:newParent.items().length-1})}else newParent=parent,moved[item.id]=moved[parent.id];for(var moveSiblings=!1,parentMoved=item;parentMoved;){if(moved[parentMoved.id]){parentMoved.isCollapsed()||(moveSiblings=!0);break}parentMoved=parentMoved.parent()}var siblingStartIndex=item.getIndex()+1;if(moveSiblings){var items=item.items(),numMoved=0;for(u=0;u<items.length;u++){var child=items[u];if(!itemsHighlighted[child.id]){if(g.hasClass(child.getElement(),"hidden"))continue;needUpdate[child.parent().id]=child.parent(),needUpdate[item.parent().id]=item.parent();var moveIndex=siblingStartIndex+numMoved;child.moveTo({parent:item.parent(),index:moveIndex,underlying:!0}),moved[child.id]=!0,tracker.performAction(TrackerType.Move,{itemID:child.id,oldParent:item.id,oldPosition:u,newParent:item.parent().id,newPosition:moveIndex}),numMoved++,u--}}}}}for(var itemId in needUpdate)needUpdate[itemId].items.valueHasMutated();if(android.isEnabled())android.updateInputBounds(startItem);else if(startItem||endItem){try{g.PAssert(2405,startItem&&endItem)}catch(PERR){g.reportError(PERR)}g.selectMultiline(origStartItem.getSpan(),startOffset.start,origEndItem.getSpan(),endOffset.end)}e.handled=!0;try{g.PAssert(2406,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1},self.handleEnter=function handleEnterFn(e,span,range){var item=g.getItemForElement(span);if(!item){try{g.PAssert(2408,!1,"Invalid item in handleEnter")}catch(PERR){g.reportError(PERR)}return!1}var parent=item.parent();if(!parent){try{g.PAssert(2409,!1,"Invalid parent in handleEnter")}catch(PERR){g.reportError(PERR)}return!1}var index=parent.items().indexOf(item),offsets=g.getSelectOffsetsInSpan(span,range);android.isEnabled()&&android.finishInput(!0);var text=item.getParsedText(),item2,addToChild=!1,newParent=parent;if(e.shiftKey)return e.preventDefault(),!1;if(!item.isNote()){var useNextItem=!0;if(0===offsets.end&&""!==text)item2=item.isNumList()?new VMLI({text:NumListPrefix},{parent:newParent,forceSave:!0,changeType:ChangeType.AllLocal}):new VMLI({text:""},{parent:newParent,forceSave:!0,changeType:ChangeType.AllLocal}),index--,useNextItem=!1;else if(offsets.start>=offsets.total){addToChild=!item.isCollapsed()&&(item.items().length>0||item.isHeader()),addToChild&&(newParent=item);var newText="";item.isNumList()&&(newText=NumListPrefix),item2=new VMLI({text:newText},{parent:newParent,forceSave:!0,changeType:ChangeType.AllLocal})}else if(0===offsets.start&&offsets.end===offsets.total)item2=new VMLI({text:""},{parent:newParent,forceSave:!0,changeType:ChangeType.AllLocal}),item.setText("",!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text});else{var splitText=item.splitUsableText(text,offsets.startText,offsets.endText);item.isNumList()&&(secondText=NumListPrefix+splitText.after),item2=new VMLI({text:splitText.before},{parent:newParent,forceSave:!0,changeType:ChangeType.AllLocal}),item.setText(splitText.after,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.substring(offsets.startText)}),item2.copyProperties(item),index--,useNextItem=!1}if(item2.parseText(!0,ChangeType.Local|ChangeType.All),addToChild)item.insertItem(item2,0),tracker.performAction(TrackerType.Create,{itemID:item2.id,parent:item.id,position:0,text:item2.getParsedText()});else{try{g.PAssert(2410,!item2.isNote(),"Should never be inserting a note here")}catch(PERR){g.reportError(PERR)}newParent.insertItem(item2,index+1),tracker.performAction(TrackerType.Create,{itemID:item2.id,parent:newParent.id,position:index+1,text:item2.getParsedText()})}var selectItem=useNextItem?item2:item;try{g.PAssert(2411,selectItem,"Expected another item to exist")}catch(PERR){g.reportError(PERR)}if(platform.ios)return textSaveInfo.start=offsets.start,textSaveInfo.waitAutocorrect="enter",textSaveInfo.item=useNextItem?item:item2,textSaveInfo.nextItem=useNextItem?item2:item,tempInput||(tempInput=g.element("tempInput")),tempInput.innerHTML=textSaveInfo.item.getStyledText(),g.selectMultiline(tempInput,offsets.start,tempInput,offsets.start),!0;if(android.isEnabled()){android.updateInput(selectItem,0);try{g.PAssert(2412,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),self.scrollTextIntoView(),!1}g.selectChildren(selectItem,0,0);try{g.PAssert(2413,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1}if(platform.ios);else if(!android.isEnabled()){var newText=text.substr(0,offsets.startText)+StringNewLine+text.substr(offsets.endText);return item.setText(newText,!0,ChangeType.Local),g.selectChildren(item,offsets.start+1,0),e.preventDefault(),!1}},self.handleBackspace=function handleBackspaceFn(e,span,range){var item=g.getItemForElement(span);if(!item){try{g.PAssert(2415,!1,"Invalid item in handleBackspace")}catch(PERR){g.reportError(PERR)}return!1}var parent=item.parent();try{g.PAssert(2416,parent,"Must always have a valid parent for an item")}catch(PERR){g.reportError(PERR)}var offsets=g.getSelectOffsetsInSpan(span,range);android.isEnabled()&&android.finishInput(!0),platform.ie&&(e.preventDefault(),e.stopImmediatePropagation());var text=item.getParsedText(),newText="",newTextOffset=0;if(0===offsets.startText&&0===offsets.endText||""===text){if(item.isNote()&&""!==text)return!1;var prev=g.getPreviousItem(item,g.focusedPane),next=g.getNextItem(item,g.focusedPane);if(prev&&(!prev.isFullscreen()||""===text&&next)){var prevTextLength=prev.getParsedText().length;parent.deleteChild(item,prev,0),text.length>0&&""!==text&&(0===prev.getParsedText().length&&prev.copyProperties(item),prev.setText(prev.getParsedText()+item.generateSaveText(text),!0,ChangeType.Local),item.hasNote()&&(prev.hasNote()||prev.moveNote(item)),tracker.performAction(TrackerType.Insert,{itemID:prev.id,position:prevTextLength,text:text}));var selectItem=prev.isFullscreen()?prev.getFirstChild():prev,selectOffset=prev.isFullscreen()?0:prevTextLength;return g.selectChildren(selectItem,selectOffset,0),platform.mobile&&self.scrollTextIntoView(),!1}return android.isEnabled()&&android.updateInput(item,offsets.startText),!1}if(0===offsets.startText&&offsets.endText===text.length)tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:item.getParsedText()}),newText="",newTextOffset=0;
else if(e.metaKey)if(item.isNote()){var lastLine=text.prevIndexOf("\n",offsets.startText);0>lastLine?(newText=text.substring(offsets.startText),newTextOffset=0,tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,offsets.startText)})):(newText=text.substring(0,lastLine)+text.substring(offsets.startText),newTextOffset=lastLine,tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(lastLine,offsets.startText)}))}else newText=text.substring(offsets.startText),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,offsets.startText)}),newTextOffset=0;else if((platform.mac&&e.altKey||!platform.mac&&e.ctrlKey)&&offsets.start===offsets.end){for(var endOfText=text.substring(offsets.startText),seenALetter=!1,isHandled=!1,i=offsets.startText-1;i>=0&&!isHandled;i--)if(seenALetter=seenALetter||" "!==text[i]," "!==text[i]||" "!==text[i-1]){var specialCharMatch=" "===text[i]||"\n"===text[i]||"@"===text[i]||text[i]===window.AttachChar;if(0===i||specialCharMatch){var subIndex=i+1;(i===offsets.startText-1||0===i&&!specialCharMatch)&&subIndex--,(seenALetter||" "!==text[i])&&(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:subIndex,text:text.slice(subIndex,offsets.startText)}),newText=text.substring(0,subIndex)+endOfText,newTextOffset=subIndex,isHandled=!0)}}isHandled||(offsets.startText===text.length?0===offsets.start&&(newText="",tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text})):(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,offsets.startText)}),newText=endOfText),newTextOffset=0)}else if(1===offsets.start&&1===offsets.end&&1===text.length&&""!==text[0])tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:item.getParsedText()}),newText="",newTextOffset=0;else if(offsets.start!==offsets.end)tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.slice(offsets.startText,offsets.endText)}),newText=text.substr(0,offsets.startText)+text.substr(offsets.endText),newTextOffset=offsets.start;else{var sub=1;text.length>1&&""===text[offsets.startText-1]&&sub++,newText=text.substr(0,offsets.startText-sub)+text.substr(offsets.startText),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText-sub,text:text.slice(offsets.startText-sub,offsets.startText)}),newTextOffset=offsets.startText-sub}return platform.phone&&!android.isEnabled()&&lastKeypress!==KeyCode.BackSpace?(textSaveInfo.text=newText,textSaveInfo.start=newTextOffset,textSaveInfo.item=item,0===newText.length&&(item.setStyledText(TextSpace+" ",!0),g.selectChildren(item,1,0)),!0):(item.setText(newText,!0,ChangeType.Local),g.selectChildren(item,newTextOffset,0),!1)},self.handleDelete=function handleDeleteFn(e,span,range){var item=ko.dataFor(span.parentNode);if(!item)return!1;var offsets=g.getSelectOffsetsInSpan(span,range),parent=item.parent(),text=item.getParsedText();if(""===text)if(item.isNote())parent.setNote(void 0),g.selectChildren(parent,parent.getParsedText().length,0);else{var index=item.getIndex(),refocusItem=g.getNextItem(item,g.focusedPane),refocusIndex=0;refocusItem||(refocusItem=g.getPreviousItem(item,g.focusedPane),refocusIndex=refocusItem.getParsedText().length),refocusItem&&!refocusItem.isFullscreen()&&(item.hasChildren()?parent.replaceChild(item,item.getFirstChild()):parent.deleteChild(item,parent,index),g.selectChildren(refocusItem,refocusIndex,0))}else if(offsets.start===offsets.total&&offsets.end===offsets.total||offsets.start===offsets.total-1&&offsets.end===offsets.total-1&&""===span.textContent[offsets.endText]){if(item.isNote())return!1;var next=g.getNextItem(item,g.focusedPane);next&&(item.setText(item.generateSaveText(text)+next.getParsedText(),!0,ChangeType.Local),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:text.length,text:next.getParsedText()}),next.parent().deleteChild(next,item,0),g.selectChildren(item,offsets.total,0))}else if((platform.mac&&e.altKey||!platform.mac&&e.ctrlKey)&&offsets.start===offsets.end){for(var startOfText=text.substring(0,offsets.startText),seenALetter=!1,isHandled=!1,i=offsets.startText;i<text.length&&!isHandled;i++)if(seenALetter=seenALetter||" "!==text[i],i===text.length-1||" "===text[i]){var subIndex=" "===text[i]&&" "===text[offsets.startText]?i:i+1;if(seenALetter||" "!==text[i]){var newText=startOfText+text.substring(subIndex);item.setText(newText,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:subIndex,text:newText}),g.selectChildren(item,offsets.start,0),isHandled=!0}}}else if(offsets.start!==offsets.end){var newText=text.substr(0,offsets.startText)+text.substr(offsets.endText);item.setText(newText,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.slice(offsets.startText,offsets.endText)}),g.selectChildren(item,offsets.start,0)}else{var newText=text.substr(0,offsets.startText)+text.substr(offsets.startText+1);item.setText(newText,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:offsets.startText,text:text.slice(offsets.startText,offsets.startText+1)}),g.selectChildren(item,offsets.start,0)}return!1},self}),define("AScript",["globals","platform","data","tracker","VMLI","edit","International"],function(g,platform,d,tracker,VMLI,edit,International){function AScript(){function onMessage(e){if(e.data&&g.isString(e.data)&&e.data.indexOf("{")<0){for(var commands=e.data.split("&"),i=0;i<commands.length;i++){var params=commands[i].split("=");try{g.PAssert(2418,params.length>=0,"Invalid number of params in message")}catch(PERR){g.reportError(PERR)}switch(params[0]){case"script":this.runScript(params[1],!1);break;case"data":if(this.isRunning)return this.stop(),void setTimeout(onMessage.bind(this),100,e);this.loadScriptData(params[1]);break;case"video":window.__IS_DEMO_VIDEO=!0;break;case"demoIntroWider":g.addClass(document.documentElement,"demoIntroWider");break;case"start":this.start();break;case"stop":this.stop();break;case"pause":this.pause();break;case"resume":this.resume();break;case"restart":this.restart();break;case"alertDemo":g.menus.alert({text:'Click anywhere to try this <b class="blue">live demo</b>',action:g.emptyFn,big:!0});break;case"help":var show=params[1];"1"==show?g.vmMain.showHelp(HelpMode.Intro):g.intro.closeHelp();break;case"panes":this.loadPanes(params[1])}}var firstItem=g.getFirstPaneItem(g.vmMain.paneManager.getPaneAtIndex(0));firstItem&&firstItem.getSpan()&&g.setSelection(firstItem.getSpan(),0,0)}}this.queueDebug=!1,this.videoPhone=!1,this.hasSelection=!1,this.isTyping=!1,this.isRunning=!1,this.isDisabled=!1,this.isPaused=!1,this.stoppedFromPause=!1,this.activeScript=void 0,this.index=0,this.repeat=!1,this.onScriptDone=void 0,this.selectedItem=void 0,this.needsFinish=!1,this.needsStop=!1,this.lastLoadedData=void 0,this.savedItems={},this._scriptQueue=[],this.startText={},window.addEventListener("message",onMessage.bind(this),!1),window.pauseScript=function(){this.isDisabled||(log("pause script"),this.isDisabled=!0)}.bind(this)}var ActionType={Run:1,Reset:2},q=function(){var args=Array.prototype.slice.call(arguments,1),s=arguments[0];args.splice(0,0,ActionType.Run),s.queue.apply(s,args)},repeat=function(){for(var args=Array.prototype.slice.call(arguments,1),num=arguments[0],i=0;num>i;i++)q.apply(q,args)},addItem=function(s,text,name,indent,set){if(s.queue(ActionType.Run,"createItemAfter",void 0,name),void 0!==indent&&0!==indent)for(var i=0;i<Math.abs(indent);i++)s.queue(ActionType.Run,"indent",0>indent?!0:!1);set?s.queue(ActionType.Run,"setText",void 0,text):s.queue(ActionType.Run,"typeString",void 0,text,40)};return AScript.prototype={runScript:function runScriptFn(id,repeat){var shouldStart=!0;if(!this.isDisabled){switch(id){case"intro":this._scriptQueue.push(this.demoIntro()),g.addClass(document.documentElement,"demoIntro"),repeat=!1,shouldStart=!1;break;case"kanban":this._scriptQueue.push(this.demoKanban()),repeat=!1;break;case"gtd":this._scriptQueue.push(this.demoGTD()),repeat=!1;break;case"projectManagement":this._scriptQueue.push(this.demoProjectManagement()),repeat=!1;break;case"inboxZero":this._scriptQueue.push(this.demoInboxZero()),repeat=!1;break;case"none":return;default:try{g.PAssert(2419,!1,"Invalid script request: ",id)}catch(PERR){g.reportError(PERR)}}this.repeat=repeat,this.activeScript=this._scriptQueue[0],!this.isRunning&&this.activeScript&&shouldStart&&this.start()}},start:function startFn(){this.needsStop=!1,g.messageQueue.clearMessage(MessageID.ThisIsDemo),this.onScriptStart(this.activeScript),this.reset(),this.run()},restart:function restartFn(){this.activeScript=this._scriptQueue[0],this.activeScript.index=0,this.start()},stop:function stopFn(){this._scriptQueue=[],this.needsStop=!0,this.isRunning=!1,this.activeScript=void 0,clearTimeout(this.delayTimeout),g.autocomplete.hide()},pause:function pauseFn(){this.isPaused=!0},resume:function resumeFn(){this.isPaused=!1,this.stoppedFromPause&&this.run()},loadScriptData:function loadScriptDataFn(dataId,cb){log("Load Script Data: ",dataId),this._scriptQueue=[],this.repeat=!1,this.lastLoadedData=dataId,g.vmMain.resetScrollOffsets(),d.loadDemoData(dataId,!0,function(id){g.vmMain.changeRoot(id),cb&&cb()})},loadPanes:function loadPanesFn(dataId){g.demoPanes=dataId.split(":"),g.vmMain.loadDemoPanes()},onScriptStart:function onScriptStartFn(script){script&&window.parent.postMessage(script.getName(),"*")},createScript:function createScriptFn(name,repeat){var script={owner:this,_name:name,index:0,isResetting:!1,_repeat:!1,noDelay:!1,runQueue:[],resetQueue:[],_activeQueue:function _activeQueueFn(){return this.isResetting?this.resetQueue:this.runQueue},queue:function queueFn(type,fnName){var args=Array.prototype.slice.call(arguments,2),arr=type===ActionType.Run?this.runQueue:this.resetQueue;return arr.push({name:fnName,args:args}),arr},repeat:function repeatFn(val){this._repeat=val},reset:function resetFn(){this.index=0;for(var i=0;i<this.resetQueue.length;i++){var next=this.resetQueue[i];this.owner[next.name].apply(this.owner,next.args)}},nextStep:function nextStepFn(){var queue=this.runQueue;return queue[this.index++]},getName:function getNameFn(){return this._name}};return script},reset:function resetFn(){this.index=0;for(var i=0;i<this._scriptQueue.length;i++)this._scriptQueue[i].reset()},run:function runFn(){if(!this.isDisabled&&this.activeScript){if(this.isPaused)return void(this.stoppedFromPause=!0);try{g.PAssert(2421,this.activeScript,"Must have a script active to be running")}catch(PERR){g.reportError(PERR)}var next=this.activeScript.nextStep();if(!next){if(this.index++,this.index>=this._scriptQueue.length){if(!this.repeat)return this.isRunning=!1,void(this.onScriptDone&&this.onScriptDone());this.reset()}this.activeScript=this._scriptQueue[this.index],this.activeScript.reset(),this.onScriptStart(this.activeScript),next=this.activeScript.nextStep()}var args=next.args;args.push(this.run.bind(this)),args.push(this.activeScript),this.isRunning=!0,setTimeout(function(){try{this.queueDebug,this[next.name].apply(this,args)}catch(err){g.reportError(err),this.onDisable()}}.bind(this),0)}},onDisable:function onDisableFn(){this.isDisabled=!0},setSelection:function setSelectionFn(item,paneIndex,offset,length,cb){try{g.PAssert(2422,item,"Must provide a valid item to select")}catch(PERR){g.reportError(PERR)}item=this.getItemIfString(item);var selectPane=paneIndex>=0?g.vmMain.paneManager.getPaneAtIndex(paneIndex):g.focusedPane;g.focusedPane.id!==selectPane.id&&g.vmMain.setFocusedPane(selectPane),void 0===offset||null===offset?offset=0:0>offset&&(offset=item.getParsedText().length+offset+1),g.selectChildren(item,offset,length),this.hasSelection=!0,this.selectedItem=item,cb&&cb()},clearSelection:function clearSelectionFn(cb){g.clearSelection(),this.hasSelection=!1,this.selectedItem=void 0,cb&&cb()},scrollTo:function scrollToFn(index,offset,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(index);try{g.PAssert(2423,pane,"Must have selected a valid pane")}catch(PERR){g.reportError(PERR)}pane.setScrollOffset(offset),cb&&cb()},setText:function setTextFn(item,str,cb){item=item||this.selectedItem,item.setText(str,!0,ChangeType.Local),cb&&cb()},appendText:function appendTextFn(item,str,cb){item.setText(item.getParsedText()+str,!0),cb&&cb()},setPriority:function setPriorityFn(item,priority,cb){item=this.getItemIfString(item)||this.selectedItem,item.priority(priority),cb&&cb()},setStarred:function setStarredFn(item,isStarred,cb){item=item||this.selectedItem,item.isStarred(isStarred),cb&&cb()},setComplete:function setCompleteFn(item,isComplete,date,cb){item=this.getItemIfString(item)||this.selectedItem,item.dateCompleted=date,item.isComplete(isComplete),cb&&cb()},indent:function indentFn(outdent,cb){var keyData={normCode:KeyCode.Tab,shiftKey:outdent};g.fireKeyEvent(void 0,keyData),cb&&cb()},typeString:function typeStringFn(item,str,charDelay,cb){function typeChar(){if(this.needsStop)return void stop();this.videoPhone&&this.setSelection(item,0,-1,0);var normCode=str.charCodeAt(i);normCode===KeyCode.Delete&&(normCode=KeyCode.Period),g.fireKeyEvent(void 0,{normCode:normCode}),++i>=str.length&&(stop(),cb&&cb())}try{g.PAssert(2428,cb,"typeString should always have a callback")}catch(PERR){g.reportError(PERR)}this.needsFinish&&(charDelay=0),item=this.getItemIfString(item)||this.selectedItem;try{g.PAssert(2429,item,"Must be an item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2430,this.hasSelection,"Must set selection before typing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2431,!this.isTyping,"Must wait until previous typing is finished")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2432,void 0!==str,"Must supply a string to be typed")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2433,void 0!==charDelay,"Must specify a delay between each typed character")}catch(PERR){g.reportError(PERR)}this.isTyping=!0;var i=0,typeInterval,stop=function(){typeInterval&&clearInterval(typeInterval),this.isTyping=!1,this.needsStop=!1}.bind(this);str&&(typeChar.apply(this),str.length>1&&(typeInterval=setInterval(typeChar.bind(this),charDelay)))},createItemAfter:function createItemAfterFn(item,savedName,cb){item=item||this.selectedItem,this.setSelection(item,void 0,item.getParsedText().length,0),g.fireKeyEvent(void 0,{normCode:KeyCode.Enter}),this.clearSelection(function(){var newItem;newItem=item.isHeader()?item.getChild(0):item.parent().getChild(item.getIndex()+1),savedName&&(this.savedItems[savedName]=newItem),this.selectedItem=newItem,this.setSelection(newItem,void 0,-1,0,cb)}.bind(this))},delay:function delayFn(ms,cb){cb&&(this.needsFinish||0===ms?cb&&cb():(this.delayCb=cb,this.delayTimeout=setTimeout(function(){this.delayCb=this.delayTimeout=void 0,cb()}.bind(this),ms)))},selectItemInPane:function selectItemInPaneFn(paneIndex,itemIndex,cb){for(var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),item=pane.item().items()[0],i=0;itemIndex>i;i++)item=g.getNextItem(item,pane);this.selectedItem=item,cb()},dragTo:function dragToFn(moveItem,paneIndexMove,targetParent,paneIndexTarget,targetIndex,totalTime,cb){function ease(t){return.5>t?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}function moveDrag(time){if(self.needsStop)return g.vmMain.handleDragOver({srcElement:targetSpan}),g.fireDragEnd(moveSpan),void(self.needsStop=!1);startTime||(startTime=time);var p=ease((time-startTime)/totalTime);currentX=targetX*p+srcRect.left+10,currentY=targetY*p+srcRect.top+5,g.fireDragMove(g.dragging?g.dragging:moveSpan,currentX,currentY),p>=1?(g.vmMain.handleDragOver({srcElement:targetSpan}),g.fireDragEnd(moveSpan),cb&&cb()):requestAnimationFrame(moveDrag)}moveItem=this.getItemIfString(moveItem)||this.selectedItem,targetParent=this.getItemIfString(targetParent);var paneMove=g.vmMain.paneManager.getPaneAtIndex(paneIndexMove),moveSpan=moveItem.getSpan(paneMove.id),paneTarget=g.vmMain.paneManager.getPaneAtIndex(paneIndexTarget),targetSpan=targetParent.getChild(targetIndex).getSpan(paneTarget.id),srcRect=moveSpan.getBoundingClientRect(),dstRect=targetSpan.getBoundingClientRect(),targetX=dstRect.left-srcRect.left,targetY=dstRect.top-srcRect.top,currentX,currentY,startTime=null,self=this;g.fireDragStart(moveSpan),requestAnimationFrame(moveDrag)},getItemIfString:function getItemIfStringFn(item){if(g.isString(item)){item=d.getModel(item)||this.savedItems[item];try{g.PAssert(2448,item,"Item was not saved correctly")}catch(PERR){g.reportError(PERR)}}return item},pushMessage:function pushMessageFn(text,cb){var msg;msg=g.messageQueue.pushMessage(g.isString(text)?{text:text,hold:!0}:text);var closeFn=function(){g.messageQueue.clearMessage(msg),window.removeEventListener("tapMain",closeFn)};window.addEventListener("tapMain",closeFn),cb&&cb()},notify:function notifyFn(text,cb){window.parent.postMessage(text,"*"),cb()},addClass:function addClassFn(cls,cb){g.addClass(document.documentElement||document.body,cls),cb()},removeClass:function removeClassFn(cls,cb){g.removeClass(document.documentElement||document.body,cls),cb()},demoKanban:function demoKanbanFn(id){function delay(value){s.queue(ActionType.Run,"delay",value)}var s=this.createScript(id);return delay(1500),q(s,"dragTo","errorTracking",0,"kTodo",1,3,1e3),delay(1500),q(s,"dragTo","helpSystem",1,"kProgress",2,1,1e3),delay(1500),q(s,"setSelection","helpSystem",2,0,0),q(s,"typeString",void 0," ",80),q(s,"setSelection","helpSystem",2,0,0),q(s,"typeString",void 0,"+Jay ",160),delay(1500),q(s,"setComplete","touchup",!0,new Date),delay(2e3),q(s,"pushMessage",MessageID.ThisIsDemo),q(s,"notify","done"),s},demoGTD:function demoGTDFn(id){function delay(value){s.queue(ActionType.Run,"delay",value)}var s=this.createScript(id);return delay(1500),q(s,"setSelection","tapContact",0,-1,0),q(s,"typeString",void 0," #mobile @today",80),delay(1500),q(s,"dragTo",void 0,0,"helpProject",1,0,1e3),delay(1500),q(s,"setSelection","tapTooltips",0,-1,0),q(s,"dragTo",void 0,0,"contactsProject",1,0,1e3),delay(1500),q(s,"setSelection","tapSlide",0,-1,0),q(s,"typeString",void 0," #mobile @tomorrow",80),delay(1500),q(s,"dragTo",void 0,0,"contactsProject",1,0,1e3),delay(2e3),q(s,"pushMessage",MessageID.ThisIsDemo),q(s,"notify","done"),s},demoProjectManagement:function demoProjectManagementFn(id){function delay(value){s.queue(ActionType.Run,"delay",value)}var s=this.createScript(id);return delay(1500),q(s,"setSelection","pressHold",0,-1,0),q(s,"typeString",void 0," #Android ",80),delay(1500),q(s,"setComplete","projectTouchup",!0,new Date),delay(1500),q(s,"setSelection","projectHelpSystem",0,0,0),q(s,"typeString",void 0,"+Jay ",160),delay(2e3),q(s,"pushMessage",MessageID.ThisIsDemo),q(s,"notify","done"),s},demoInboxZero:function demoInboxZeroFn(id){function delay(value){q(s,"delay",value)}var s=this.createScript(id);return delay(1500),q(s,"selectItemInPane",0,1),q(s,"dragTo",void 0,0,"bugsContact",1,0,1e3),delay(1500),q(s,"selectItemInPane",0,0),q(s,"setComplete","emailContacts1",!0,(new Date).addDays(-2)),delay(1500),q(s,"selectItemInPane",0,1),q(s,"dragTo",void 0,0,"respond",1,0,1e3),delay(2e3),q(s,"pushMessage",MessageID.ThisIsDemo),q(s,"notify","done"),s},demoIntro:function demoIntroFn(id){function delay(value){s.queue(ActionType.Run,"delay",value)}var s=this.createScript(id),timeList=800;delay(2500),q(s,"addClass","showSecondPane"),q(s,"notify","showSecondPane"),delay(1500),q(s,"setSelection","first",1,-1,0),q(s,"typeString",void 0,"Work",30),addItem(s,"Website design","subproject",1,!1),addItem(s,"Update icons","task1",1,!1),addItem(s,"New flat buttons","task2",0,!1),addItem(s,"Home",void 0,-2,!1),addItem(s,"Take out the trash","homeFirst",1,!1),delay(1500),q(s,"notify","showEmails"),delay(1500),q(s,"selectItemInPane",0,1),q(s,"dragTo",void 0,0,"subproject",1,0,1e3),delay(1700),q(s,"addClass","showThirdPane"),q(s,"notify","showAgenda"),delay(2e3),q(s,"setSelection","task1",1,-1,0),q(s,"typeString","task1"," @",80),delay(1e3),q(s,"typeString","task1","tomorrow",80),delay(1e3),q(s,"setSelection","task2",1,-1,0),q(s,"typeString","task2"," @",80),delay(1e3);var date=Date.today().addDays(4);return q(s,"typeString","task2",date.toString("MMM d"),80),delay(1e3),q(s,"selectItemInPane",1,2),q(s,"setPriority",void 0,VMLIFlag.P0),delay(1e3),q(s,"setSelection","homeFirst",1,-1,0),addItem(s,"Reference contacts +",void 0,0,!1),delay(1e3),q(s,"typeString","homeFirst","Jane Johnson",100),delay(1e3),addItem(s,"Use #tags to help you search",void 0,0,!1),delay(2e3),q(s,"notify","done"),s}},AScript}),define("VMSetup",["ko","data","globals","util","platform","goog","AScript"],function(ko,d,g,util,platform,goog,AScript){function VMSetup(){this.loginState=ko.observable(LoginState.NONE);var gapiLoaded=window.gapi&&window.gapi.auth;this.loginStatus=ko.observable(navigator.onLine?gapiLoaded?LoginStatus.Normal:LoginStatus.Loading:LoginStatus.Offline),gapiLoaded||window.addEventListener("gapiLoaded",function(){this.loginStatus()===LoginStatus.Loading&&this.loginStatus(LoginStatus.Normal)}.bind(this)),this.loginRequested=!1,this.loginRequestTimer=void 0}var LoginStatus={Normal:"Sign in with Google",Connecting:"Connecting...",LoggingIn:"Logging In...",Loading:"Loading...",Offline:"Offline"};return VMSetup.prototype={init:function initFn(){if(g.isDemoMode())return LoginState.LOGGED_OUT;var loginState=g.getLoginState();return this.setLoginState(loginState),g.applyBindings(this,"setup"),window.addEventListener("gapiLoaded",function(){try{g.PAssert(2449,window.gapi&&window.gapi.auth,"Must have gapi libs loaded correctly to receive gapiLoaded event")}catch(PERR){g.reportError(PERR)}this.loginRequested&&(this.loginStatus(LoginStatus.Normal),goog.getAccessToken(!0)?this.userLogin():this.loginRequested=!1)}.bind(this)),window.addEventListener("offline",function(){log("Browser going offline."),g.vmMain.setGDriveStatus(DriveStatus.Offline),this.loginStatus(LoginStatus.Offline)}.bind(this)),window.addEventListener("online",function(){if(log("Browser going online."),this.loginStatus(LoginStatus.Normal),this.loginRequested&&(goog.getAccessToken(!0)?this.userLogin():this.loginRequested=!1),g.getLoginState()==LoginState.LOGGED_IN&&!platform.offline){var alreadyOnline=goog.ensureDocConnection();log("Coming online. Already online:",alreadyOnline)}}.bind(this)),loginState},showGooglePlus:function showGooglePlusFn(){return this.loginStatus()===LoginStatus.Normal},logoutButtonText:function logoutButtonTextFn(){return g.isDemoMode()?"Leave Introduction":"LOGOUT"},setLoginState:function setLoginStateFn(state){state!=this.loginState()&&(g.setLoginState(state),this.loginState(state))},userLogin:function userLoginFn(){var gapiLoaded=window.gapi&&window.gapi.auth;gapiLoaded&&this.loginStatus()===LoginStatus.Normal&&this.loginState()!=LoginState.LOGGED_IN?(this.loginStatus(LoginStatus.LoggingIn),this.loginRequested=!1,goog.runAuthenticate(goog.requiredScopes,!1,!0,function(token){this.loginStatus(LoginStatus.Normal),token&&!token.error?(g.settings.set(Settings.localIntegrity,!0),this.setLoginState(LoginState.LOGGED_IN),goog.onHaveUserSignupData(function(){g.reportLogin(goog.getCurrentUserEmail())}),gapi.load("drive-realtime",function(){goog.loadClientDefaultFile()})):log("Invalid token returned when calling userLogin")}.bind(this))):(this.loginStatus(LoginStatus.Connecting),this.loginRequested=!0),clearTimeout(this.loginRequestTimer),this.loginRequestTimer=setTimeout(function(){this.loginStatus(navigator.onLine?LoginStatus.Normal:LoginStatus.Offline),this.loginRequested=!1}.bind(this),500)},openLogin:function openLoginFn(){this.loginState(LoginState.NONE),g.StopSpinner()},logout:function logoutFn(){this.setLoginState(LoginState.LOGGED_OUT),d.clearData(function(){util.hasURLParam("login")?util.removeURLParam("login"):util.hasURLParam("user")?util.removeURLParam("user"):platform.app?platform.app&&g.nativeBridge.sendToApp("logout"):g.reload()})},logoutClicked:function logoutClickedFn(){if(g.isDemoMode())util.removeURLParam("demo");else{var ok=!0;for(var itemID in d.pendingRemoteUpdates)if(d.pendingRemoteUpdates.hasOwnProperty(itemID)){g.menus.confirm("You have unsaved changes which will be lost if you log out. Are you sure?",function(result){result&&this.logout()}.bind(this)),ok=!1;break}ok&&this.logout()}},isLocal:function isLocalFn(){return"localhost"==window.location.hostname},onlineStatusToggle:function onlineStatusToggleFn(){platform.offline?util.removeURLParam("offline"):util.insertURLParam("offline","true")},runScript:function runScriptFn(id){g.AScript||(g.AScript=new AScript),g.AScript.runScript(id,!0)},onTapLogin:function onTapLoginFn(e){this.loginStatus()===LoginStatus.Normal&&this.userLogin(),platform.mobile&&e&&(e.preventDefault(),e.stopPropagation(),g.preventClick())},onTapDemo:function onTapDemoFn(e){util.insertURLParam("demo","true",!0),util.insertURLParam("dmode","1024"),platform.mobile&&e&&(e.preventDefault(),e.stopPropagation(),g.preventClick())},onTapLanding:function onTapLandingFn(e){(platform.mobile||g.hasClass(e.srcElement,"link"))&&g.openUrl("/",e)},onPrivacyPolicy:function onPrivacyPolicyFn(e){(platform.mobile||g.hasClass(e.srcElement,"link"))&&g.openUrl("/privacy/",e)},onEmailKeydown:function onEmailKeydownFn(data,e){return e.normCode===KeyCode.Enter?(this.onTapLogin(e),e.preventDefault(),e.stopImmediatePropagation(),!1):!0}},VMSetup}),define("SettingsManager",["ko","globals","util"],function(ko,g,util){function SettingsManager(){this._versions={},this._values={},this._changeListeners=[],this._localLoaded=!1,this._localLoadError=!1,this._localWriteError=!1,this._remoteLoaded=!1,this._remoteLoadError=!1,this._remoteSettings=void 0,this.init()}window.Settings={theme:"theme",syncContacts:"syncContacts",lastContactSync:"lastContactSync",disableNotifications:"disableNotifications",rootFolderId:"rootFolderId",authScopes:"authScopes",localIntegrity:"localIntegrity",localDataVersion:"localDataVersion",shownTutorial:"shownTutorial",gdocId:"gdocId",gdocTitle:"gdocTitle",activeUser:"activeUser",noSounds:"noSounds",lastServerVersion:"lastServerVersion",helpPaneState:"helpPaneState",oauthScheme:"oauthScheme",premiumStatus:"zzp",trialStart:"pzs",trialDuration:"pzd"};var CURRENT_VERSION=1,LocalSettingProp="localSettings",DefaultGroup="Default",UnsetVersion=-1,RemoteKey=0,RemoteValue=1;return SettingsManager.prototype={init:function initFn(){this._testLocalWrites(),this.registerGroup(DefaultGroup),this.registerSetting(Settings.theme,DefaultGroup,!0),this.registerSetting(Settings.syncContacts,DefaultGroup,!0),this.registerSetting(Settings.shownTutorial,DefaultGroup,!0),this.registerSetting(Settings.lastContactSync),this.registerSetting(Settings.disableNotifications),this.registerSetting(Settings.rootFolderId),this.registerSetting(Settings.authScopes),this.registerSetting(Settings.localIntegrity),this.registerSetting(Settings.localDataVersion),this.registerSetting(Settings.gdocId),this.registerSetting(Settings.gdocTitle),this.registerSetting(Settings.activeUser),this.registerSetting(Settings.noSounds),this.registerSetting(Settings.lastServerVersion),this.registerSetting(Settings.helpPaneState),this.registerSetting(Settings.oauthScheme),this.registerSetting(Settings.premiumStatus),this.registerSetting(Settings.trialStart),this.registerSetting(Settings.trialDuration),this._setupLocalNotifications(),this._ensureLocalLoaded(),this._ensureRemoteSettings()},_setupLocalNotifications:function _setupLocalNotificationsFn(){g.shouldWriteLocal()&&window.addEventListener("storage",function(e){if(e||(e=window.event),e.key===LocalSettingProp){var oldParsedValue,newParsedValue;try{if(e.oldValue&&(oldParsedValue=this._deserializeSettings(e.oldValue)),e.newValue&&(newParsedValue=this._deserializeSettings(e.newValue)),oldParsedValue&&newParsedValue){try{g.PAssert(2452,oldParsedValue.values,"Must have a valid set of old settings")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2453,newParsedValue.values,"Must have a valid set of new settings")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this._changeListeners.length;++i){var entry=this._changeListeners[i];try{g.PAssert(2454,entry,"Each listener must have a valid entry")}catch(PERR){g.reportError(PERR)}var oldGroup=oldParsedValue.values[entry.groupID],newGroup=newParsedValue.values[entry.groupID],oldValue,newValue;oldGroup&&newGroup?(oldValue=oldGroup[entry.key],newValue=newGroup[entry.key]):!oldGroup&&newGroup?(oldValue=void 0,newValue=newGroup[entry.key]):oldGroup&&!newGroup&&(oldValue=oldGroup[entry.key],newValue=void 0),oldValue!==newValue&&entry.fn(oldValue,newValue)}}}catch(err){g.reportError(err)}if(this._localLoaded=!1,newParsedValue)this._loadLocalSettings(newParsedValue);else try{g.PAssert(2455,!1,"Unable to update settings to be empty")}catch(PERR){g.reportError(PERR)}}}.bind(this),!1)},registerForChangeNotification:function registerForChangeNotificationFn(key,fn,groupID){try{g.PAssert(2456,key,"Must provide a valid key to watch")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2457,fn&&g.isFunction(fn),"Must provide a valid callback fn",fn)}catch(PERR){g.reportError(PERR)}groupID=groupID||DefaultGroup,this._changeListeners.push({key:key,groupID:groupID,fn:fn})},_testLocalWrites:function _testLocalWritesFn(){var localAvailable=!1;try{util.storage.setItem("poke",0),localAvailable=!0}catch(err){g.preventLocalWrites()}return localAvailable},registerGroup:function registerGroupFn(groupID){this._versions[groupID]||(this._versions[groupID]={},this._values[groupID]={})},registerSetting:function registerSettingFn(key,groupID,syncRemote){groupID=groupID||DefaultGroup,syncRemote=syncRemote||!1;try{g.PAssert(2459,this._versions[groupID],"Must first register a group before a setting in the group")}catch(PERR){g.reportError(PERR)}this._versions[groupID][key]||(this._versions[groupID][key]={version:UnsetVersion,syncRemote:syncRemote})},get:function getFn(key,groupID){groupID=groupID||DefaultGroup;try{g.PAssert(2461,key,"Must specify a valid setting to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2462,this._versions[groupID],"Must first register a group before getting a setting from it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2463,!this._versions[groupID]||void 0!==this._versions[groupID][key],"Must first register a setting before getting a value from it")}catch(PERR){g.reportError(PERR)}return this._ensureLocalLoaded(),this._values[groupID][key]},set:function setFn(key,value,groupID){groupID=groupID||DefaultGroup;try{g.PAssert(2464,key,"Must specify a valid setting to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2465,this._versions[groupID],"Must first register a group before getting a setting from it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2466,!this._versions[groupID]||void 0!==this._versions[groupID][key],"Must first register a setting before setting a value to it")}catch(PERR){g.reportError(PERR)}var performWrite=!1;this._ensureLocalLoaded();var localValue=this._values[groupID][key],localVersion=this._versions[groupID][key].version;if((localValue!==value||g.isObject(value))&&(performWrite=!0),performWrite){var syncRemote=this._versions[groupID][key].syncRemote,newVersion=localVersion+1;syncRemote&&this._remoteLoaded&&this._setRemoteValue(key,value,newVersion,groupID),this._values[groupID][key]=value,this._versions[groupID][key].version=newVersion,this._writeLocalSettings()}},reset:function resetFn(key,groupID){groupID=groupID||DefaultGroup;try{g.PAssert(2467,key,"Must specify a valid setting to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2468,void 0!==this._versions[groupID],"Must first register a group before getting a setting from it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2469,this._versions[groupID][key].syncRemote===!1,"Currently do not support resetting remote syncd settings")}catch(PERR){g.reportError(PERR)}this._ensureLocalLoaded(),delete this._values[groupID][key],this._writeLocalSettings()},resetAll:function resetAllFn(skipList){for(var groupID in this._versions){var group=this._versions[groupID],groupSkip=skipList?skipList[groupID]:void 0;
for(var propID in group)(!groupSkip||groupSkip.indexOf(propID)<0)&&(this._versions[groupID][propID].version=UnsetVersion,this._values[groupID][propID]=void 0)}if(skipList)this._writeLocalSettings();else if(g.shouldWriteLocal())try{util.storage.setItem(LocalSettingProp,"{}")}catch(err){g.reportError(err)}},_ensureLocalLoaded:function _ensureLocalLoadedFn(){if(g.shouldWriteLocal()&&!this._localLoaded)try{var storValue=util.storage.getItem(LocalSettingProp);storValue||(g.isFirstRun=!0),this._loadLocalSettings(this._deserializeSettings(storValue))}catch(err){g.reportError(err),this._localLoadError=!0}},_serializeSettings:function _serializeSettingsFn(){var out={__version:CURRENT_VERSION,versions:{},values:{}};for(var groupID in this._versions){var group=this._versions[groupID];for(var propID in group){var pVersion=this._versions[groupID][propID].version,pValue=this._values[groupID][propID];this._versions[groupID][propID].syncRemote&&(out.versions[groupID]||(out.versions[groupID]={}),out.versions[groupID][propID]=pVersion),out.values[groupID]||(out.values[groupID]={}),void 0!==pValue&&(out.values[groupID][propID]=pValue)}}return out},_deserializeSettings:function _deserializeSettingsFn(settings){var out={versions:{},values:{}};if(settings)try{var settingsObj=JSON.parse(settings);if(void 0===settingsObj.__version){var VersionPrefix="V~";out.versions[DefaultGroup]={},out.values[DefaultGroup]={};for(var prop in settingsObj)if(prop.startsWith(VersionPrefix)){var ver=settingsObj[prop];out.versions[DefaultGroup][prop.substr(VersionPrefix.length)]=ver}else{var value=settingsObj[prop];out.values[DefaultGroup][prop]=value}}else if(settingsObj.__version===CURRENT_VERSION)out.versions=settingsObj.versions,out.values=settingsObj.values;else try{g.PAssert(2471,!1,"Invalid settings version")}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}return out},_loadLocalSettings:function _loadLocalSettingsFn(parsedSettings){try{g.PAssert(2472,!this._localLoaded,"Should not load settings from local twice")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2473,parsedSettings,"Must supply some valid parsed settings")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2474,!parsedSettings||parsedSettings.versions,"Must have a valid constructed parsed settings - versions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2475,!parsedSettings||parsedSettings.values,"Must have a valid constructed parsed settings - values")}catch(PERR){g.reportError(PERR)}var versions=parsedSettings.versions,values=parsedSettings.values;for(var groupID in versions){var group=versions[groupID];this._versions[groupID]||(this._versions[groupID]={});for(var propID in group)this._versions[groupID][propID]={version:group[propID],syncRemote:!0}}for(var groupID in values){var group=values[groupID];this._values[groupID]||(this._values[groupID]={});for(var propID in group)this._values[groupID][propID]=group[propID]}this._localLoaded=!0,this._localLoadError=!1},_writeLocalSettings:function _writeLocalSettingsFn(){if(g.shouldWriteLocal())try{var writeSettings=this._serializeSettings();util.storage.setItem("localSettings",JSON.stringify(writeSettings))}catch(err){g.reportError(err);try{util.storage.setItem("localSettings","{}")}catch(err2){g.reportError(err2)}this._localWriteError=!0}},_ensureRemoteSettings:function _ensureRemoteSettingsFn(){this._remoteRequested||this._remoteLoaded||g.vmMain&&g.vmMain.docManager&&(this._remoteRequested=!0,g.vmMain.docManager.registerForReadyNotification(DocType.GAppData,function(){this._remoteSettings=g.vmMain.docManager.createDocument(DocType.GAppData,"RemoteSettings"),this._remoteSettings.open("RemoteSettings",this._onRemoteLoad.bind(this),this._onRemoteInit.bind(this),this._onRemoteError.bind(this))}.bind(this)))},_getRemoteEntry:function _getRemoteEntryFn(key,groupID){if(this._remoteLoaded){var model=this._remoteSettings.getModel(),settingsRoot=model.getRoot().get("settings"),group=settingsRoot.get(groupID);if(group){var entry=group.get(key);return entry}}return void 0},_getRemoteValue:function _getRemoteValueFn(key,groupID){var entry=this._getRemoteEntry(key,groupID);return entry?entry.value:void 0},_getRemoteVersion:function _getRemoteVersionFn(key,groupID){var entry=this._getRemoteEntry(key,groupID);return entry?entry.ver:UnsetVersion},_setRemoteValue:function _setRemoteValueFn(key,value,version,groupID){if(groupID=groupID||DefaultGroup,this._remoteLoaded){var model=this._remoteSettings.getModel(),settingsRoot=model.getRoot().get("settings"),group=settingsRoot.get(groupID);group||(group=model.createMap(),settingsRoot.set(groupID,group)),group.set(key,{value:value,ver:version})}},_sendChangeNotification:function _sendChangeNotificationFn(key,oldValue,newValue){for(var i=0;i<this._changeListeners.length;++i){var listener=this._changeListeners[i];if(key===listener.key)try{listener.fn(oldValue,newValue)}catch(err){g.reportError(err)}}},_onRemoteSettingsChange:function _onRemoteSettingsChangeFn(change){for(var wasChanged=!1,i=0;i<change.events.length;++i){var ev=change.events[i];ev.isLocal||this._sendChangeNotification(ev.property,ev.oldValue,ev.newValue)}},_remoteSettingLoaded:function _remoteSettingLoadedFn(key,remoteValue,remoteVersion,groupID){try{g.PAssert(2476,!this._versions[groupID]||!this._versions[groupID][key]||this._versions[groupID][key].syncRemote,"Should always have local values marked as remote syncing",groupID,key)}catch(PERR){g.reportError(PERR)}this._versions[groupID]||this.registerGroup(groupID),this._versions[groupID][key]||this.registerSetting(key,groupID,!0);var localValue=this._values[groupID][key],localVersion=this._versions[groupID][key].version;if(remoteVersion>localVersion)this._values[groupID][key]=remoteValue,this._versions[groupID][key].version=remoteVersion,this._sendChangeNotification(key,localValue,remoteValue);else if(localVersion>remoteVersion)this._setRemoteValue(key,localValue,localVersion,groupID);else if(remoteVersion===localVersion)try{g.PAssert(2477,localValue===remoteValue,"Should match if the versions are the same")}catch(PERR){g.reportError(PERR)}else try{g.PAssert(2478,!1,"What - remote and local versions are messed up",remoteVersion,localVersion)}catch(PERR){g.reportError(PERR)}},_onRemoteLoad:function _onRemoteLoadFn(doc){try{g.PAssert(2479,this._localLoaded,"Local settings must be loaded before remote")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2480,this._remoteRequested,"Remote document must have been requested")}catch(PERR){g.reportError(PERR)}this._remoteLoaded=!0;var updatedLocal=!1,updatedRemote=!1,model=doc.getModel();model.beginCompoundOperation("Sync Settings",!1);var root=model.getRoot(),settings=root.get("settings"),info=root.get("info");try{for(var groups=settings.items(),i=0;i<groups.length;++i)for(var groupID=groups[i][RemoteKey],group=groups[i][RemoteValue],props=group.items(),j=0;j<props.length;++j){var propID=props[j][RemoteKey],prop=props[j][RemoteValue],pValue=prop.value,pVersion=prop.ver;updatedLocal|=this._remoteSettingLoaded(propID,pValue,pVersion,groupID)}for(var groupID in this._versions){var group=this._versions[groupID];for(var propID in group)if(this._versions[groupID][propID].syncRemote&&this._versions[groupID][propID].version!==UnsetVersion){var remoteGroup=settings.get(groupID);remoteGroup||(remoteGroup=model.createMap(),settings.set(groupID,remoteGroup));var remoteProp=remoteGroup.get(propID);remoteProp||(remoteProp={value:this._values[groupID][propID],ver:this._versions[groupID][propID].version},remoteGroup.set(propID,remoteProp),updatedRemote=!0)}}}catch(err){g.reportError(err)}model.endCompoundOperation(),settings.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,this._onRemoteSettingsChange.bind(this)),updatedLocal&&this._writeLocalSettings()},_onRemoteError:function _onRemoteErrorFn(err){try{g.PAssert(2481,this._localLoaded,"Local settings must be loaded before remote")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2482,this._remoteRequested,"Remote document must have been requested")}catch(PERR){g.reportError(PERR)}this._remoteLoaded=!1,this._remoteLoadError=!0},_onRemoteInit:function _onRemoteInitFn(model){try{g.PAssert(2483,this._localLoaded,"Local settings must be loaded before remote")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2484,this._remoteRequested,"Remote document must have been requested")}catch(PERR){g.reportError(PERR)}var root=model.getRoot(),settings=model.createMap(),info=model.createMap();info.set("settingsVer",1),root.set("settings",settings),root.set("info",info)},getRawSettings:function getRawSettingsFn(){var rawSettings;if(g.shouldWriteLocal())try{rawSettings=util.storage.getItem("localSettings")}catch(err){g.reportError(err)}else try{return this._serializeSettings()}catch(err){return g.reportError(err),'{m:"Invalid Settings"}'}return rawSettings},_dumpSettings:function _dumpSettingsFn(){log("---- Settings ----"),log("Versions: ",this._versions),log("Values: ",this._values)}},util.defineBase(SettingsManager),g.settings=new SettingsManager,g.settings}),define("parse",["globals","VMLI","tracker","data"],function(g,VMLI,tracker,d){function parseHead(node){for(var props={},i=0;i<node.childElementCount;++i){var prop=node.children[i],propName=prop.nodeName;if(prop.firstChild){var propValue=prop.firstChild.textContent;props[propName]=propValue}}return props}function stripParents(item){if(item.parent=void 0,item.items)for(var i=0;i<item.items.length;i++)stripParents(item.items[i])}var self={};return self.parseOPML=function parseOPMLFn(data,filename){function visit(node,parentModel){var visitChildren=!0,nodeModel;switch(node.nodeName){case"#document":case"body":case"opml":break;case"head":visitChildren=!1;var ret=parseHead(node);ret&&ret.title&&!rootModel&&(rootModel=new VMLI({text:ret.title},{parent:d.getRootModel(),forceSave:!0,changeType:ChangeType.AllLocal}),d.getRootModel().insertItem(rootModel));break;case"outline":parentModel||(rootModel?parentModel=rootModel:(parentModel=rootModel=new VMLI({text:filename},{parent:d.getRootModel(),forceSave:!0,changeType:ChangeType.AllLocal}),d.getRootModel().insertItem(rootModel))),nodeModel=new VMLI({text:node.attributes.text.value},{parent:parentModel,forceSave:!0,changeType:ChangeType.AllLocal}),parentModel.insertItem(nodeModel);break;default:log("Unknown OPML Node: ",node)}if(visitChildren)for(var i=0;i<node.childElementCount;++i)visit(node.children[i],nodeModel);return nodeModel}var rootModel;return tracker.beginAction(),visit(data),tracker.endAction(),!0},self.parseJSON=function parseJSONFn(data,root){function visit(node,parentModel){var nodeParent=parentModel||root||d.getRootModel(),nodeData={text:node.text,dateCompleted:node.dateCompleted,priority:node.priority,isComplete:node.isComplete,isStarred:node.isStarred},nodeModel=new VMLI(nodeData,{parent:nodeParent,forceSave:!0,changeType:ChangeType.AllLocal});if(nodeParent.insertItem(nodeModel),node.items)for(var i=0;i<node.items.length;++i)visit(node.items[i],nodeModel)}var dataVersion;if(void 0!==data.moodoVer&&void 0!==data.moodoRoot)try{return dataVersion=parseInt(data.moodoVer),tracker.beginAction(),visit(data.moodoRoot),tracker.endAction(),!0}catch(err){}else if(void 0!==data.text&&void 0!==data.items)try{return tracker.beginAction(),visit(data),tracker.endAction(),!0}catch(err){}return!1},self.traverseDOM=function traverseDOMFn(options){function visit(node){if(node.nodeType===Node.TEXT_NODE){(reallyNeedsNewItem||needsNewItem)&&(currentLine.text=currentLine.text.trim(),""!==currentLine.text&&(newItem={text:"",parent:currentLine.parent},currentLine.parent.items.push(newItem),currentLine=newItem)),reallyNeedsNewItem=!1,needsNewItem=!1;var addText=node.nodeValue.replace(/[\ud800-\udfff]+/g,"");""===currentLine.text&&(addText=addText.replace(/^\s+/g,"")),currentLine.text+=addText}else node.nodeType===Node.COMMENT_NODE||("BR"===node.tagName||"P"===node.tagName||"LI"===node.tagName||"DIV"===node.tagName?needsNewItem=!0:("UL"===node.tagName||"OL"===node.tagName)&&(needsNewItem=!1,currentLine.text=currentLine.text.trim(),newItem={text:"",parent:currentLine},currentLine.items?currentLine.items.push(newItem):currentLine.items=[newItem],currentLine=newItem))}function end(node){node.nodeType!==Node.TEXT_NODE&&("UL"===node.tagName||"OL"===node.tagName?(currentLine=currentLine.parent,reallyNeedsNewItem=!0):("DIV"===node.tagName||"P"===node.tagName)&&(needsNewItem=!0))}function print(r,levelsDeep){isNaN(levelsDeep)&&(levelsDeep=0);for(var text="",i=0;levelsDeep>i;i++)text+="--";if(levelsDeep&&console.log(text,r.text),r.items)for(var i=0;i<r.items.length;i++)print(r.items[i],levelsDeep+1)}var root=options.root,doStripParents=options.stripParents,shouldPrint=options.shouldPrint,n=root.firstChild,rootNode={items:[]},currentLine={text:"",parent:rootNode};rootNode.items.push(currentLine);var newItem,needsNewItem=!1,reallyNeedsNewItem=!1,c;do if(visit(n),c=n.firstChild)n=c;else if(c=n.nextSibling)n=c;else{do c=n.parentNode.nextSibling,c?(end(n.parentNode),n=c):(n=n.parentNode,end(n));while(!c&&n&&n.parentNode);if(!c)break}while(n);return doStripParents&&stripParents(rootNode),shouldPrint&&print(rootNode),rootNode},self}),define("copypaste",["ko","globals","platform","android","edit","VMLI","tracker","parse"],function(ko,g,platform,android,edit,VMLI,tracker,parse){function killEvent(e){try{g.PAssert(2486,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2487,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}function insertToNote(startSpan,endSpan,text){var range=g.getSelectionRange(),item=g.getItemForElement(startSpan);if(item){var sOffset=g.getSelectOffsetsInSpan(item.getSpan(),range),itemText=item.getParsedText();tracker.beginAction();var newText;newText=endSpan===startSpan?itemText.substring(0,sOffset.startText)+text+itemText.substring(sOffset.endText):itemText.substring(0,sOffset.startText)+text,item.setText(newText,!0,ChangeType.Local),tracker.endAction()}}function handlepaste(e){if(e.srcElement||(e.srcElement=e.target),!e.synthetic&&android.isEnabled())return void android.handlePaste();var clipData=e&&e.clipboardData?e.clipboardData:e.synthetic?e.data:window.clipboardData,range=g.getSelectionRange();return range?self.insert(clipData,range,e,DataSource.Paste):void 0}function handlecut(e){var copySuccess=!handlecopy(e);return copySuccess?(edit.keydown(void 0,{normCode:KeyCode.BackSpace,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn}),killEvent(e),!1):!0}function handlecopy(e){if(!android.isEnabled()){var dataType=platform.ie?"Text":"text/plain",clipData=e&&e.clipboardData?e.clipboardData:window.clipboardData;if(clipData){e.srcElement||(e.srcElement=e.target);var range=g.getSelectionRange();if(!range)return!0;if("exportedArea"===e.srcElement.id||"exportedContent"===e.srcElement.id)clipData.setData(dataType,e.srcElement.textContent);else{var currentItem=range.startContainer;if(currentItem.nodeType===Node.TEXT_NODE&&(currentItem=currentItem.parentNode),!currentItem)return!0;if(!android.isEnabled()){var inPane=g.elementInPane(currentItem),selectNode=g.getSelectionNode();if(!inPane||g.findParentID(selectNode,"searchDiv")||g.hasClass(selectNode,"search"))return!0;if(inPane){var activePane=g.getPaneForElement(currentItem);if(!activePane.overrideCopyBehavior)return!0}}g.restrictSelectionToText(),range=g.getSelectionRange();try{g.PAssert(2491,android.isEnabled()||range.startContainer.nodeType===Node.TEXT_NODE,"Expected #text, Actual: "+range.startContainer.tagName)}catch(PERR){g.reportError(PERR)}var startSpan=g.getSpanParent(range.startContainer);try{g.PAssert(2492,android.isEnabled()||range.endContainer.nodeType===Node.TEXT_NODE||"SPAN"===range.endContainer.nodeName,"Expected #text or SPAN, Actual: "+range.endContainer.tagName)}catch(PERR){g.reportError(PERR)}var endSpan=g.getSpanParent(range.endContainer);if(!startSpan||!endSpan)return!0;var item=android.isEnabled()?android.getCurrentVMLI():ko.dataFor(startSpan),endItem=android.isEnabled()?android.getCurrentVMLI():ko.dataFor(endSpan),offsets=g.getSelectOffsetsInSpan(startSpan,range);try{g.PAssert(2495,item&&endItem,"Must have valid item selections")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2496,item instanceof VMLI&&endItem instanceof VMLI,"Items must be valid VMLIs")}catch(PERR){g.reportError(PERR)}var createHTML=!platform.ie,html,plain,text=item.getParsedText().substring(offsets.startText);if(item===endItem)text=offsets.start===offsets.end?item.getParsedText():item.getParsedText().substr(offsets.startText,offsets.endText-offsets.startText),createHTML&&(html=text),plain=text;else{var deep=0;deep++,createHTML&&(html="<ul><li>"+text+"</li>"),plain=text;do{var nextOptions={numLevels:0};if(item=g.getNextItem(item,g.focusedPane,nextOptions)){for(nextOptions.numLevels>0&&(createHTML&&(html+="<ul>"),deep++);nextOptions.numLevels<0&&deep>=0;)createHTML&&(html+="</ul>"),deep--,nextOptions.numLevels++;if(0>=deep&&(createHTML&&(html+="<ul>"),deep++),item!==endItem)text=item.getParsedText(),createHTML&&(html+="<li>"+text+"</li>");else{var endOffset=g.getSelectOffsetsInSpan(item.getSpan(),range);text=item.getParsedText().substring(0,endOffset.endText),createHTML&&(html+="<li>"+text+"</li></ul>"),deep--}}plain+="\r\n"+text}while(item!==endItem);for(;deep>0;)createHTML&&(html+="</ul>"),deep--}createHTML&&html&&clipData.setData("text/html",html),clipData.setData(dataType,plain)}}return killEvent(e),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Copy,data:[{value:!0}]}),!1}}var self={};return self.init=function initFn(){try{g.PAssert(2485,"complete"===document.readyState||"interactive"===document.readyState,"Setting up copy/paste too early")}catch(PERR){g.reportError(PERR)}document.body.addEventListener("paste",handlepaste,!1),document.body.addEventListener("cut",handlecut,!1),document.body.addEventListener("copy",handlecopy,!1)},self.insert=function insertFn(data,range,e,source){var clipboardBuffer="",dataTypeText=platform.ie?"Text":"text/plain",pane=g.getPaneForElement(range.startContainer);if(!pane)return!1;if(g.hasClass(range.startContainer,"search")||g.hasClass(range.startContainer.parentElement,"search")){if(pane&&source!==DataSource.Plugin&&(clipboardBuffer=data.getData(dataTypeText))){var inputString=clipboardBuffer.replace(/[\r\n\t]/g,"");inputString&&pane.vmSearch.insert(inputString)}return e.preventDefault(),!1}var startSpan=g.getSpanParent(range.startContainer),endSpan=g.getSpanParent(range.endContainer),item;if(startSpan&&endSpan)item=g.getItemForElement(startSpan);else{if(range.startContainer!==pane.paneContent&&range.endContainer!==pane.paneContent){try{g.PAssert(2488,!1,"There should always be something to paste into")}catch(PERR){g.reportError(PERR)}return}item=pane.addItemToPane("",0),startSpan=endSpan=item.getSpan(),g.selectChildren(item,0,0)}if(item){if(pane.type!==PaneMode.Normal)return!1;var traversed;if(source===DataSource.Plugin)traversed={items:[{text:data}]};else if(data&&data.getData){if(tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Paste,data:[{value:!0}]}),killEvent(e),!platform.ie&&(clipboardBuffer=data.getData("text/html"))){if(!clipboardBuffer)return;var node=document.createElement("div"),replacedText=clipboardBuffer.replace(/[\n\t]/g," ").replace(/[\r]|<head(.|\s)*?\/head>|<script(.|\s)*?\/script>|<style(.|\s)*?\/style>/g,"").replace(/\s+/g," ").replace(/onload/gi,"never"),bodyRegex=/<body(.|\s)*?\/body>/g,bodyMatch;(bodyMatch=bodyRegex.exec(replacedText))&&(replacedText=bodyMatch[0]),node.innerHTML=replacedText,item.isNote()?insertToNote(startSpan,endSpan,node.innerText):(traversed=parse.traverseDOM({root:node,shouldPrint:!1,stripParents:!0}),1===traversed.items.length&&""===traversed.items[0].text&&(traversed=traversed.items[0]))}else if(clipboardBuffer=data.getData(dataTypeText)){var isXML=clipboardBuffer.startsWith("<?xml "),isOPML=clipboardBuffer.startsWith("<?opml "),xml;if((isXML||isOPML)&&(xml=g.loadXML(clipboardBuffer)),xml){if(isXML)return g.messageQueue.pushMessage({text:"We currently do not support pasting XML. If you need to import XML please tell us",action:MessageAction.Contact,hold:!0}),!1;if(isOPML)return parse.parseOPML(xml,"OPML Import"),!1}else{if(clipboardBuffer.startsWith("{")&&clipboardBuffer.endsWith("}"))try{var jsonData=JSON.parse(clipboardBuffer),root=ko.dataFor(startSpan.parentElement),res=parse.parseJSON(jsonData,root);if(res)return!1}catch(err){}var replacedText=clipboardBuffer.replace(/[\t]/g," ");if(item.isNote())insertToNote(startSpan,endSpan,replacedText);else{var traversedText=replacedText.split("\n");traversed={items:[]};for(var i=0;i<traversedText.length;i++)if(0!==traversedText[i].length){var str=g.trimString(traversedText[i].replace(/[\ud800-\udfff]+/g,""));traversed.items.push({text:str,parent:traversed})}}}}else try{g.PAssert(2489,!1,"Paste with unexpected data type",data.types)}catch(PERR){g.reportError(PERR)}if(!traversed||!traversed.items||0===traversed.items.length)return!1}if(traversed){try{g.PAssert(2490,void 0!==startSpan&&void 0!==endSpan,"Must have a valid selection to perform paste")}catch(PERR){g.reportError(PERR)}tracker.beginAction();var itemStart=android.isEnabled()?android.getCurrentVMLI():ko.dataFor(startSpan),itemEnd=android.isEnabled()?android.getCurrentVMLI():ko.dataFor(endSpan),sOffset=g.getSelectOffsetsInSpan(startSpan,range),eOffset=g.getSelectOffsetsInSpan(endSpan,range),itemParent=itemStart.parent(),itemIndex=itemStart.getIndex(),sText=itemStart.getParsedText(),eText=itemEnd.getParsedText(),selItemSpan,selOffset;itemStart!==itemEnd&&(itemEnd.isNote()&&(itemEnd=itemEnd.parent()),itemStart!==itemEnd&&edit.handleMultiselect({},startSpan,endSpan,range));var lastItem=itemStart;if(traversed&&1===traversed.items.length&&!traversed.items[0].items){var iText=traversed.items[0].text.trim(),str=sText.substring(0,sOffset.startText)+iText+eText.substring(eOffset.endText);selItemSpan=itemStart.getSpan(),tracker.performAction(TrackerType.Remove,{itemID:itemStart.id,position:0,text:itemStart.getParsedText()}),itemStart.setText(str,!0,ChangeType.Local),tracker.performAction(TrackerType.Insert,{itemID:itemStart.id,position:0,text:str}),selOffset=sOffset.start+iText.length,g.selectChildren(itemStart,selOffset,0)}else{for(var mutations=[],i=0;traversed&&i<traversed.items.length;++i){var itemInfo=traversed.items[i];if(itemInfo.text=itemInfo.text.trim(),""!==itemInfo.text||itemInfo.items)if(0===i){if(itemInfo.text[0]===sText&&(itemInfo.text=itemInfo.text.substr(1)),itemInfo.text=sText.substring(0,sOffset.startText)+itemInfo.text,itemStart.setText(itemInfo.text,!0,ChangeType.Local),tracker.performAction(TrackerType.Insert,{itemID:itemStart.id,position:0,text:itemInfo.text}),itemIndex++,itemInfo.items){for(var u=0;u<itemInfo.items.length;++u){var child=itemInfo.items[u];(""!==child.text||child.items)&&itemStart.insertItem(new VMLI(child,{parent:itemStart,forceSave:!0,changeType:ChangeType.AllLocal}))}mutations.indexOf(itemStart)<0&&mutations.push(itemStart)}}else{var newItem=new VMLI(itemInfo,{parent:itemParent,forceSave:!0,changeType:ChangeType.AllLocal});itemParent.insertItem(newItem,itemIndex++,!0),mutations.indexOf(itemParent)<0&&mutations.push(itemParent),tracker.performAction(TrackerType.Create,{itemID:newItem.id,parent:itemParent.id,position:itemIndex-1,text:newItem.getParsedText()})}}for(i=0;i<mutations.length;i++)mutations[i].items.valueHasMutated();for(lastItem=itemParent.getChild(itemIndex-1);lastItem.hasChildren();)lastItem=lastItem.getLastChild();selOffset=lastItem.getParsedText().length,lastItem.setText(lastItem.getParsedText()+eText.substring(eOffset.endText),!0,ChangeType.Local),g.vmMain.parseSubtree(itemParent,ChangeType.Local|ChangeType.All,function(){setTimeout(function(){g.selectChildren(lastItem,selOffset,0)},0)})}tracker.endAction()}return lastItem&&!android.isEnabled()&&g.scrollIntoView(lastItem.getSpan(),200),!1}},self}),define("VMSearch",["ko","globals","util","platform","android","data","VMLI","tracker"],function(ko,g,util,platform,android,d,VMLI,tracker){function VMSearch(pane,searchStr){this.elSearch=void 0,this.elSearchWrap=void 0,this.elAutocomplete=void 0,this.search=ko.observable(searchStr||""),this.isFocused=ko.observable(!1),this.placeholderActive=ko.observable(!0),this.searchLoaded=!1,this.pane=pane,this.searchArr=[],this.matches={},this.hiddenItems={},this.numMatches=ko.observable(0),this.previousSearch="",this.initialized=!1,this.isSearchBoxSmall=ko.observable(),this.onUpdated=ko.observable(),this._handlers={}}return VMSearch.prototype={getSearchBox:function getSearchBoxFn(){return this.elSearch},handleItemAdded:function handleItemAddedFn(e){if(e.data.force||g.focusedPane.id!==this.pane.id&&!platform.mobile){var match=this.checkItem(e.data.item);match===!0&&this.updateNumMatches(e.data.item,!0)}else g.focusedPane.id===this.pane.id&&this.updateNumMatches(e.data.item,!0)},handleItemTextChanged:function handleItemTextChangedFn(e){if(g.vmMain.paneManager.isPaneActive(this.pane.id)&&(e.data.force||g.focusedPane.id!==this.pane.id&&!platform.mobile)){var item=e.data.item,oldValue=this.matches[item.id],newValue=this.checkItem(item);(newValue===!0&&oldValue!==!0||newValue!==!0&&oldValue===!0)&&this.updateNumMatches(item,newValue===!0),this.checkChildren(item,!1,!0)}},init:function initFn(){try{g.PAssert(2497,!this.initialized,"Should only initialize search once")}catch(PERR){g.reportError(PERR)}if(!this.initialized){if(this._showArchivedSubscription=this.pane.showArchived.subscribe(this.updateSearch.bind(this)),g.addCustomEventListener("itemAdded",util.forceBind("handleItemAdded",this)),g.addCustomEventListener("itemTextChanged",util.forceBind("handleItemTextChanged",this)),this.search())this.updateSearch();else{var num=0;g.searchVMLIs({item:this.pane.item(),includeArchived:this.pane.showArchived(),each:function eachFn(item){var newNum=this.amountIncrementNumMatches(item,!0);newNum&&(num+=newNum)}.bind(this)}),this.setNumMatches(num)}this.initialized=!0}},onLoad:function onLoadFn(element){this.elSearch=element,this.elSearch.oninput=this.oninput.bind(this),this.elSearchWrap=element.parentNode,this.elAutocomplete=g.getElementByClassName("searchAutocomplete",this.elSearchWrap),this.elSearch.addEventListener("focus",this.onfocus.bind(this),!1),this.elSearch.addEventListener("blur",this.onblur.bind(this),!1),platform.android&&this.elSearch.addEventListener("input",function(e){var activeText=this.getDisplayText().replace("\n",""),activeSearch=this.search();activeText.length<activeSearch.length&&(e.normCode=KeyCode.BackSpace,this.keydown(void 0,e),this.keyup(void 0,e))}.bind(this)),this.search()?setTimeout(function(){this.setDisplayText(this.search()),this.checkPlaceholder(),this.searchLoaded=!0}.bind(this),0):setTimeout(function(){this.searchLoaded=!0}.bind(this),0)},destroy:function destroyFn(){g.removeCustomEventListener("itemAdded",this.handleItemAdded),g.removeCustomEventListener("itemTextChanged",this.handleItemTextChanged),this._showArchivedSubscription.dispose(),this._showArchivedSubscription=void 0,this.pane=void 0,this.elSearch=void 0,this.elSearchWrap=void 0,this.elAutocomplete=void 0,util.destroy(this)},getACText:function getACTextFn(){return this.getDisplayText()},getAutocompleteInfo:function getAutocompleteInfoFn(words,selectionStart){return{startWord:0,startChar:0,provider:ACProvider.Search}},onAutocompleteTapped:function onAutocompleteTappedFn(text,tag){},onfocus:function onfocusFn(){this.isFocused(!0),g.vmMain.setFocusedPane(this.pane),platform.phone?g.sendEvent("SearchFocus","Mobile"):g.sendEvent("SearchFocus","Desktop")},onblur:function onblurFn(){this.isFocused(!1),g.fireCustomEvent("closeKeyboard"),g.clearSavedSelection("StoredSearch")},focusBox:function focusBoxFn(){g.vmMain.setFocusedPane(this.pane),g.keyboardToolbar&&g.keyboardToolbar.preShow(),this.getSearchBox().focus(),g.enforceScroll(),g.keyboardToolbar&&g.keyboardToolbar.show(!1)},blurBox:function blurBoxFn(){this.getSearchBox().blur()},focusAndSelectEnd:function focusAndSelectEndFn(){this.focusBox(),g.selectElement(this.elSearch,!0)},resetSearch:function resetSearchFn(){this.search(""),this.setDisplayText("");for(var item in this.matches)this.updateMatchState(d.getModel(item),void 0,void 0);this.matches[this.pane.item().id]=!1,this.updateSearch()},setSearch:function setSearchFn(text){this.setDisplayText(text),this.search(text),this.checkPlaceholder(),this.updateSearch()},addToSearch:function addToSearchFn(text){if(text){var newText=this.search()+" "+text;this.setDisplayText(newText),this.search(newText),this.checkPlaceholder(),this.updateSearch()}},isSearching:function isSearchingFn(){return this.search().length>0},isShowing:function isShowingFn(){return this.isFocused()||this.isSearching()},isMatched:function isMatchedFn(item){return(void 0===this.matches[item.id]||!!this.matches[item.id])&&-1!==this.matches[item.id]},isVisible:function isVisibleFn(item){return!item.isHidden(this.pane)},hideItem:function hideItemFn(item,outline){item!==g.vmMain.root.peek()&&item.setHidden(!0,this.pane,outline)},showItem:function showItemFn(item,outline){item.setHidden(!1,this.pane,outline)},updateMatchState:function updateMatchStateFn(item,newValue,outline){var wasChanged=!1;if(item!==this.pane.item.peek()&&item!==g.vmMain.root.peek()){if(item){var oldValue=this.matches[item.id];this.matches[item.id]=newValue,oldValue===newValue||void 0===oldValue&&newValue===!0||(wasChanged=!0,this.pane.type===PaneMode.Timeline&&this.pane.notifySearchStateChanged(item,newValue))}return wasChanged}},amountIncrementNumMatches:function amountIncrementNumMatchesFn(item,newValue){return item===this.pane.item.peek()||item===g.vmMain.root.peek()?0:newValue?1:-1},updateNumMatches:function updateNumMatchesFn(item,newValue){var newNum=this.amountIncrementNumMatches(item,newValue);newNum&&this.setNumMatches(this.numMatches()+newNum);try{g.PAssert(2498,this.numMatches()>=0)}catch(PERR){g.reportError(PERR)}},setNumMatches:function setNumMatchesFn(val){var oldValue=this.numMatches();oldValue!==val&&(this.numMatches(val),this.pane.paneContent&&!!oldValue!=!!val&&this.pane.noItems(!val))},isMatch:function isMatchFn(item,lower,s){var found=!0;if(s.indexOf("!")>=0&&(found=item.priority()>=VMLIFlag.P2,s.indexOf("!!")>=0&&(found=item.priority()>=VMLIFlag.P1,s.indexOf("!!!")>=0&&(found=item.priority()>=VMLIFlag.P0)),s=s.replace(/!/g,"")),s.indexOf("*")>=0&&found&&(found=item.isStarred()&&!item.isComplete(),s=s.replace(/\*/g,"")),s.indexOf("//")>=0&&found&&(found=item.isComplete(),s=s.replace(/\//g,"")),s.length>0&&found&&(found=lower.indexOf(s)>=0,!found)){var attachments=item.getAttachments();if(attachments)for(var i=0;i<attachments.length&&!found;i++)found=attachments[i].match(s)}return found},checkItem:function checkItemFn(item,outline,onLoad){for(var searchRoot=outline?g.vmMain.root.peek():this.pane.item.peek(),isMatch=!0,parent,lower=item.getSearchText(),i=0;i<this.searchArr.length;i++){var termEntry=this.searchArr[i],negate=termEntry.isNegated;if(negate){var s=termEntry.text;try{g.PAssert(2499,s,"Each value in the search array should be valid at this point")}catch(PERR){g.reportError(PERR)}var found=this.isMatch(item,lower,s);if(found){isMatch=-1;break}}}if(isMatch===!0)for(var i=0;i<this.searchArr.length;i++){var termEntry=this.searchArr[i],negate=termEntry.isNegated,s=termEntry.text;try{g.PAssert(2500,s,"Each value in the search array should be valid at this point")}catch(PERR){g.reportError(PERR)}if(!negate){var found=this.isMatch(item,lower,s);if(!found)for(parent=item;parent;){if(parent=parent.parent(),!parent||parent===d.getRootModel()){isMatch=!1;break}if(this.isMatch(parent,parent.getSearchText(),s))break}}if(isMatch!==!0)break}if(isMatch===!0&&item.isLoaded){for(var model=item,oldMatchState=this.matches[item.id],wasChanged=this.updateMatchState(item,!0,outline);model;){if(-1===this.matches[model.id]){this.matches[item.id]=!1;break}if(model.isLoaded&&this.showItem(model,outline),model===searchRoot)break;
if(model=model.parent()){if(this.matches[model.id]===!0)break;oldMatchState=this.matches[model.id]}}onLoad&&!outline&&this.search()&&this.updateNumMatches(item,!0)}else if(item.isLoaded){var wasChanged=this.updateMatchState(item,isMatch,outline);this.hideItem(item,outline)}return this.matches[item.id]},checkChildren:function checkChildrenFn(item,countItems,countChanged){var num=this.numMatches();countItems&&(num=0),g.searchVMLIs({item:item,includeArchived:this.pane.showArchived(),each:function eachFn(item){var oldValue=this.matches[item.id],newValue=this.checkItem(item);if(countItems&&newValue===!0||countChanged&&(newValue===!0&&oldValue!==!0||newValue!==!0&&oldValue===!0)){var newNum=this.amountIncrementNumMatches(item,newValue===!0);newNum&&(num+=newNum)}}.bind(this)}),this.setNumMatches(num)},checkChildrenOutline:function checkChildrenOutlineFn(){g.searchVMLIs({item:this.pane.item(),headers:!0,each:function eachFn(item){this.checkItem(item,!0)}.bind(this)})},updateSearch:function updateSearchFn(force){if(force===!0||this.search()!==this.previousSearch){this.searchLoaded&&g.vmMain.paneManager.updatePaneStateForPane(this.pane);var textArray=this.search().toLowerCase().trim().split(/\s+/);textArray=textArray.filter(function(str){return!(!str||"-"===str)}),this.searchArr=[];for(var i=0;i<textArray.length;++i){var isNegated=textArray[i].startsWith("-"),itemText=isNegated?textArray[i].substr(1):textArray[i];this.searchArr.push({text:itemText,isNegated:isNegated})}this.pane.isSearching=this.search()?!0:!1,this.previousSearch=this.search(),this.matches[this.pane.item().id]=!1,this.initialized&&(this.checkChildren(this.pane.item(),!0),this.checkChildrenOutline()),this.onUpdated.valueHasMutated()}},keydown:function keydownFn(UNUSED,e){if(e.normCode===KeyCode.Enter)return!1;if(e.normCode===KeyCode.BackSpace){var text=this.getDisplayText();if(""===text)return!1;if(1===text.length)return this.setDisplayText(""),!1}else if(e.normCode===KeyCode.Tab){var firstChild=g.focusedItem.getFirstChild();return firstChild&&(g.selectChildren(firstChild,0,0),g.scrollIntoView(firstChild.getSpan(),0)),e.preventDefault(),!1}return!0},keyup:function keyupFn(UNUSED,e){var text=this.getDisplayText();if(platform.mobile||""!==text||this.setDisplayText(""),e.normCode===KeyCode.Escape)g.selectElement(this.elSearch,!1);else{var newText=text.replace("\n","");this.search(newText),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:[{pane:this.pane.id,text:newText}]});var forceUpdate=e.normCode===KeyCode.Enter;if(this.updateSearch(forceUpdate),platform.ie&&this.checkPlaceholder(),e.normCode===KeyCode.Enter){if(platform.android&&g.keyboardToolbar)g.clearSavedSelection("StoredSearch"),g.clearSelection();else if(!g.restoreSavedSelection("StoredSearch",g.focusedPane)){var firstChild=g.focusedItem.getFirstChild();firstChild&&(g.selectChildren(firstChild,0,0),g.scrollIntoView(firstChild.getSpan(),0))}return e.preventDefault(),!1}}return!0},insert:function insertFn(ch,withSpace){try{g.PAssert(2501,ch,"Character being inserted must be valid")}catch(PERR){g.reportError(PERR)}var range=g.getSelectionRange();if(range){var start=range.startOffset,text=this.search();if(withSpace&&text.length>0){var prevChar=text[start-1];" "!==prevChar&"-"!==prevChar&&(ch=" "+ch)}var len=ch.length,newSearch=text.substr(0,range.startOffset)+ch+text.substr(range.endOffset);this.search(newSearch),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:[{pane:this.pane.id,text:newSearch}]}),this.setDisplayText(newSearch),this.checkPlaceholder(),this.updateSearch();var newStart=Math.min(this.elSearch.textContent.length,start+len);g.setSelection(this.elSearch,newStart,newStart)}},onTapAutocomplete:{onStart:function onStartFn(e){e.preventDefault()}},onTapSearchInsert:{onStart:function onStartFn(e){e.preventDefault()},onClick:function onClickFn(e){var className=e.srcElement.className;switch(0!==className.indexOf("search")&&(className=e.srcElement.parentNode.className),className){case"searchNegate":var range=g.getSelectionRange();if(range&&range.startOffset!==range.endOffset){var start=range.startOffset,end=range.endOffset,sText=this.search();if("-"!==sText[start]){var newText=sText.substring(0,start)+"-"+sText.substring(start);this.setSearch(newText),g.setSelection(this.elSearch,start,end+1)}else{var newText=sText.substring(0,start)+sText.substring(start+1);this.setSearch(newText),g.setSelection(this.elSearch,start,Math.max(0,end-1))}}else this.insert("-",!0);break;case"searchP2":this.insert("!",!0);break;case"searchP1":this.insert("!!",!0);break;case"searchP0":this.insert("!!!",!0);break;case"searchStarred":this.insert("*",!0);break;case"searchComplete":this.insert("//",!0)}g.sendEvent("Menu",className)}},onTapSearchForward:{onStart:function onStartFn(e){e.preventDefault()},onClick:function onClickFn(e){try{g.PAssert(2502,this.pane.onTapRunSearch,"Pane must define a search AC handler if it is using a custom search autocomplete")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2503,this.pane.onTapClearSearch,"Pane must define a search AC handler if it is using a custom search autocomplete")}catch(PERR){g.reportError(PERR)}var elemClass=e.srcElement.className;switch(elemClass){case"searchRunRemote":this.pane.onTapRunSearch(e,this.search());break;case"searchClearRemote":this.pane.onTapClearSearch(e);break;default:try{g.PAssert(2504,!1,"Invalid search AC element pressed",g.elementToString(e.srcElement))}catch(PERR){g.reportError(PERR)}}}},requestFocusBoxForEvent:function requestFocusBoxForEventFn(e){var activeElement=document.activeElement;activeElement&&g.hasClass(activeElement,"search")||(this.open(),e.preventDefault())},onTapBox:{onClick:function onClickFn(e){platform.mobile?("listTitle"===e.srcElement.id?g.ScreenManager.toggleOutline():g.phoneMenu.mode()===g.phoneMenu.Modes.Normal&&this.open()&&e.stopImmediatePropagation(),e.preventDefault()):this.requestFocusBoxForEvent(e)}},onTapX:{onStart:function onStartFn(e){e.handled=!0,e.preventDefault()},onClick:function onClickFn(e){this.isSearchActive()?(this.resetSearch(),e.preventDefault(),g.sendEvent("Menu","ClearSearch")):(this.requestFocusBoxForEvent(e),g.sendEvent("Menu","FocusSearch"))}},isSearchActive:function isSearchActiveFn(){return 0!==this.search().length},getTitleText:function getTitleTextFn(){return this.isSearchActive()?"Clear Search":"Search"},getSearchIcon:function getSearchIconFn(){return this.isSearchActive()?"icon-close":"icon-search"},open:function openFn(){return this.isFocused()?void 0:(platform.mobile?this.focusAndSelectEnd():this.focusBox(),!0)},getDisplayText:function getDisplayTextFn(){return this.elSearch.textContent},oninput:function oninputFn(){this.checkPlaceholder()},checkPlaceholder:function checkPlaceholderFn(){this.placeholderActive(0===this.elSearch.textContent.length?!0:!1)},setDisplayText:function setDisplayTextFn(text){this.elSearch.textContent=text,""===text&&this.checkPlaceholder()}},VMSearch}),define("VMTitle",["ko","globals","util"],function(ko,g,util){function VMTitle(p){this.text=p.text,this.item=p.item,this.home=p.home,this.pane=p.pane,this.init(p)}return VMTitle.prototype={init:function initFn(){this.text=this.item.generateTitleText(this.item.getParsedText())},destroy:function destroyFn(){this.pane=void 0,util.destroy(this)},onTap:{onStart:function onStartFn(e){e.handled=!0,g.vmMain.setFocusedPane(this.pane)},onClick:function onClickFn(e){g.focusedPane.onTapTitle.onClick.call(g.focusedPane,e,this.item)}}},VMTitle}),define("VMOutline",["ko","globals","util","data","gdata","VMSearch","platform","tracker"],function(ko,g,util,d,gdata,VMSearch,platform,tracker){function VMOutline(pane){this.pane=pane,this.root=pane.getRootItem(),this.isVisible=ko.observable(!1),this.init()}return VMOutline.prototype={init:function initFn(){platform.mobile&&(this._isVisibleSubscription=this.isVisible.subscribe(function(value){value&&g.isKeyboardOpen&&!g.getActiveSearch().isFocused()&&g.blurActiveElement(),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOutline,data:{element:this.getTopElement(),value:value}})}.bind(this)))},destroy:function destroyFn(){this.pane=void 0,platform.mobile&&(this._isVisibleSubscription.dispose(),this._isVisibleSubscription=void 0),util.destroy(this)},getTopElement:function getTopElementFn(){return document.getElementsByClassName("paneOutline")[0]},onTapSection:function onTapSectionFn(e){g.vmMain.vmPicker.onTapSection(e)},onTap:{onStart:function onStartFn(e){g.ScreenManager&&g.ScreenManager.checkSwipeStart(e)},onMove:function onMoveFn(e){g.ScreenManager&&g.ScreenManager.checkSwipeMove(e)},onClick:function onClickFn(e){if(!platform.mobile||g.ScreenManager&&!g.ScreenManager.checkSwipeClick(e)){var item,data=ko.dataFor(e.srcElement);if(data!=this&&data!=this.outline){item=g.getItemForElement(e.srcElement);try{g.PAssert(2505,item,"Element in outline was text but was not an item")}catch(PERR){g.reportError(PERR)}}if(item){var li=item.getOutlineElement(this.id);try{g.PAssert(2506,li,"Item must have an outline element")}catch(PERR){g.reportError(PERR)}if(li){var offsetX=e.clientX-g.offset(li).left;offsetX<item.getPaddingOutline()-(platform.mobile?0:g.SPThresholdLeft)?g.hasClass(li,"collapsed")?(g.removeClass(li,"collapsed"),item.isDemandLoad()&&item.notifyDemandLoadUpdate(!0),g.sendEvent("Menu","OutlineMinimize")):(g.addClass(li,"collapsed"),g.sendEvent("Menu","OutlineMaximize")):(platform.mobile||g.vmMain.setFocusedPane(this),g.vmMain.zoomin(item),platform.mobile?g.ScreenManager.closeOutline():g.focusedPane.toggleOutlineVisibility(),g.sendEvent("Menu","OutlineZoom"))}e.preventDefault()}}},onEnd:function onEndFn(e){g.ScreenManager&&g.ScreenManager.checkSwipeEnd(e)}},onTapCollapse:{onStart:function onStartFn(e){if(g.hasClass(e.srcElement,"outlineArrow")){var li=e.srcElement.parentNode;g.hasClass(li,"collapsed")?(g.removeClass(li,"collapsed"),g.sendEvent("Menu","OutlineMinimize")):(g.addClass(li,"collapsed"),g.sendEvent("Menu","OutlineMaximize")),e.handled=!0,e.preventDefault()}}},toggleDesktop:function toggleDesktopFn(){var paneWidth=g.width(this.pane.element),time=150;this.isVisible()?(g.setTransform(this.pane.outlineElement,1*-paneWidth,0,time,"ease-out"),g.setTransform(this.pane.paneContent,0,0,time,"ease-out"),setTimeout(function(){this.isVisible(!this.isVisible()),this.pane.outlineElement.style.visibility="hidden"}.bind(this),time)):(this.isVisible(!this.isVisible()),this.pane.outlineElement.style.visibility="visible",g.setTransform(this.pane.outlineElement,1*-paneWidth,0),requestAnimationFrame(function(){g.setTransform(this.pane.outlineElement,0,0,time,"ease-in-out"),g.setTransform(this.pane.paneContent,paneWidth,0,time,"ease-in-out")}.bind(this))),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOutline,data:{element:this.getTopElement()}})}},VMOutline}),define("VMPane",["ko","globals","util","android","data","gdata","VMSearch","VMTitle","edit","VMLI","tracker","VMOutline","platform"],function(ko,g,util,android,d,gdata,VMSearch,VMTitle,edit,VMLI,tracker,VMOutline,platform){function VMPane(p){this.type=PaneMode.Normal,this.paneClass="paneNormal",this.dropEffect=DropEffect.Move,this.isWriteable=!0,this.overrideCopyBehavior=!0,this.supportCollapsing=!0,this.supportOffline=!0,this.supportViewArchived=!1,this.supportPerformArchive=!0,this.supportDataRefresh=!1,this.supportPagination=!1;try{g.PAssert(2507,void 0!==p.id,"Must supply a valid pane id")}catch(PERR){g.reportError(PERR)}this.id=p.id,p.item||(p.item=this.getRootItem(),p.offset=0,p.search=""),this.item=ko.observable(p.item),this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.vmSearch=void 0,this.titles=ko.observableArray(),this.showArchived=ko.observable(!1),this.reloading=!1,this.numCompleteItems=ko.observable(),this.noItems=ko.observable(!this.plugin),this.isNotReady=ko.observable(this.plugin?!this.plugin.isReady():!1),this.width=-1,this._perPaneState={},this._destroyed=!1,this.initialOffset=p.offset,this.defaultOffset=platform.mobile?g.topBoxHeight-16:0,platform.mobile?(this.vmSearch=new VMSearch(this,p.search),this.outline=g.vmMain.outline=new VMOutline(this)):(this.vmSearch=new VMSearch(this,p.search),this.outline=new VMOutline(this)),this.init(p)}return VMPane.prototype={init:function initFn(){this.vmSearch.init(),this._itemSubscription=this.item.subscribe(this.onItemChanged,this),this.onItemChanged(),setTimeout(function(){this.updateContents()}.bind(this),0),this.plugin&&this.plugin.notifyPaneCreated(this)},destroy:function destroyFn(){this._destroyed=!0,this.plugin&&this.plugin.notifyPaneDestroyed(this),this._itemSubscription.dispose(),this._itemSubscription=void 0;for(var titles=this.titles(),i=0;i<titles.length;++i)titles[i].destroy();this.vmSearch.destroy(),this.vmSearch=void 0,this.outline.destroy(),this.outline=void 0,this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.outlineElement=void 0,platform.mobile&&(this.itemMenuPhone=void 0,this.rightMenuPhone=void 0),util.destroy(this)},copyStateFrom:function copyStateFromFn(pane){this.item()!==pane.item&&(this.item(pane.item()),this.notifyOfZoom())},getSaveInfo:function getSaveInfoFn(){return{id:this.id,focus:this.item().id,type:this.type,showarch:this.showArchived(),search:this.vmSearch.search(),offset:this.getScrollOffset}},getPerPaneState:function getPerPaneStateFn(id,field){return this._perPaneState[id]?this._perPaneState[id][field]:void 0},setPerPaneState:function setPerPaneStateFn(id,field,data){this._perPaneState[id]=this._perPaneState[id]||{},this._perPaneState[id][field]=data},deletePerPaneState:function deletePerPaneStateFn(id){this._perPaneState[id]=void 0},requestDemandLoadData:function requestDemandLoadDataFn(paneID,item){try{g.PAssert(2509,!1,"SubClass must override - by default demand load is not supported")}catch(PERR){g.reportError(PERR)}},requestDataPage:function requestDataPageFn(item){try{g.PAssert(2510,!1,"SubClass must override - by default data pagination is not supported")}catch(PERR){g.reportError(PERR)}},getRootItem:function getRootItemFn(){return g.vmMain.root.peek()},setRootItem:function setRootItemFn(item){try{g.PAssert(2511,void 0===item.parent(),"Root should never have a parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2512,this.item()!==item,"Should not be setting root to the same value")}catch(PERR){g.reportError(PERR)}this.item(item),this.notifyOfZoom()},getScroller:function getScrollerFn(){return this.scrollElement},getScrollOffset:function getScrollOffsetFn(){var sOffset=0;return this.scrollElement&&(sOffset=this.scrollElement.scrollTop),sOffset},onTapSection:function onTapSectionFn(e){g.vmMain.vmPicker.onTapSection(e)},setScrollOffset:function setScrollOffsetFn(offset){try{g.PAssert(2513,this.scrollElement,"Pane must have loaded a scrollable element")}catch(PERR){g.reportError(PERR)}void 0===offset&&(offset=this.defaultOffset),g.scrollTo(offset,0,this.scrollElement)},addPadding:function addPaddingFn(){var padSize=platform.windowHeight()-g.topBarHeight-g.topBoxHeight;this.paneContent.style.paddingBottom=padSize+"px"},removePadding:function removePaddingFn(){this.paneContent.style.paddingBottom=""},getTopElement:function getTopElementFn(){return this.element},trackDOM:function trackDOMFn(){return!0},templateName:function templateNameFn(pane,b){return"template-pane-normal"},searchACName:function searchACNameFn(){return"template-search-ac-default"},templateNameItem:function templateNameItemFn(item,context){var pane=g.getPaneForContext(context);try{g.PAssert(2514,pane,"Must be able to find a valid pane")}catch(PERR){g.reportError(PERR)}return pane&&pane.isWriteable?"template-li":g.templateNameItem(item)},getPaneIcon:function getPaneIconFn(){return"icon-align-left"},itemHasChildren:function itemHasChildrenFn(){return this.item().items().length>0},onItemChanged:function onItemChangedFn(){var numComplete=0;g.searchVMLIs({item:this.item(),includeArchived:!1,comparator:function comparatorFn(item){return item.isComplete()},action:function actionFn(item){numComplete++}}),this.numCompleteItems(numComplete)},onItemCompleteChanged:function onItemCompleteChangedFn(item){item.isDescendantOf(this.item())&&this.numCompleteItems(this.numCompleteItems()+(item.isComplete()?1:-1))},onLoad:function onLoadFn(e){if(g.hasClass(e,"pane"))this.element=e,platform.mobile&&(this.itemMenuPhone=g.element("itemMenuPhone"),this.rightMenuPhone=g.element("rightMenuPhone"));else{this.paneContent=e,this.rootElement=e.parentElement,this.scrollElement=this.rootElement.parentElement,this.outlineElement=this.scrollElement.previousElementSibling;try{g.PAssert(2517,g.hasClass(this.rootElement,"paneRoot"))}catch(PERR){g.reportError(PERR)}try{g.PAssert(2518,g.hasClass(this.paneContent,"paneContent"))}catch(PERR){g.reportError(PERR)}!platform.android&&!platform.mobileie||platform.script||android.setPaneRoot(this),setTimeout(this.onAfterLoaded.bind(this),0),platform.ios&&(this.scrollElement.onscroll=function(e){return Math.abs(this.scrollElement.scrollTop-g.scrollAtTouchStart)>100&&(g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0),g.startDrag=void 0),0===this.scrollElement.scrollTop?(e.preventDefault(),e.stopImmediatePropagation(),!1):!0}.bind(this)),this.plugin||this.noItems(!this.vmSearch.numMatches())}},onAfterLoaded:function onAfterLoadedFn(){g.vmMain.updatePaneWidth(),isNaN(this.initialOffset)&&(this.initialOffset=this.defaultOffset),0!==this.initialOffset&&this.setScrollOffset(this.initialOffset)},getWidth:function getWidthFn(){return this.width},toggleOutlineVisibility:function toggleOutlineVisibilityFn(){try{g.PAssert(2519,this.outline,"Outline must exist")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2520,this.outlineElement,"Outline element must be valid")}catch(PERR){g.reportError(PERR)}this.outline.toggleDesktop()},updateContents:function updateContentsFn(){this.updateTitles()},notifyOfZoom:function notifyOfZoomFn(){this.updateContents(),this.vmSearch.updateSearch(!0)},updateTitles:function updateTitlesFn(){var parents=this.item().parents();this.titles.removeAll();for(var i=0;i<parents.length;i++){var title=new VMTitle({item:parents[i],pane:this});this.titles.push(title)}},notifyDropFrom:function notifyDropFromFn(droppedItem){},keydown:function keydownFn(element,e){if(android.isEnabled()&&!android.passKeydown(e))return!0;if(g.autocomplete&&!g.autocomplete.onkeydown(e))return!1;platform.mobile||android.isEnabled()||!g.hasClass(this.paneContent,"noItems")||g.hasClass(this.paneContent,"loading")||this.addItem(e);try{return edit.keydown(element,e)}catch(err){g.reportError(err,e)}},keypress:function keypressFn(element,e){if(android.isEnabled()&&!android.passKeypress(e))return!0;try{return edit.keypress(element,e)}catch(err){g.reportError(err,e)}},keyup:function keyupFn(element,e){if(g.vmMain.lastActivity=Date.now(),android.isEnabled())return android.checkAndroidBounds(),!0;try{return edit.keyup(element,e)}catch(err){g.reportError(err,e)}},textInput:function textInputFn(element,e){if(!(platform.ios||platform.mac||platform.windows||platform.linux))return!0;try{return platform.ios7?edit.textInputiOS7(element,e):edit.textInputiOS8(element,e)}catch(err){g.reportError(err,e)}},compositionEnd:function compositionEndFn(element,e){if(!platform.isFirefox)return!0;try{return edit.textInputiOS8(element,e)}catch(err){g.reportError(err,e)}},addItemToPane:function addItemToPaneFn(text,index){var target=this.item();text||(text=""),tracker.beginAction();var item=new VMLI({text:text},{parent:target,changeType:ChangeType.AllLocal,forceSave:!0});return target.insertItem(item,index),tracker.performAction(TrackerType.Create,{itemID:item.id,parent:target.id,position:isNaN(index)?target.items().length-1:index,text:text}),tracker.endAction(),item},onTapTitle:{onClick:function onClickFn(e,item){var oldItem=g.focusedItem;return platform.ios||item===this.item()&&this.vmSearch.resetSearch(),this.titles().length<=1?void(this.outline.isVisible()&&this.toggleOutlineVisibility()):(g.vmMain.zoomout(item,oldItem),void g.sendEvent("Menu","Title"))}},onTap:{onStart:function onStartFn(e){if(!platform.mobile||g.ScreenManager&&!g.ScreenManager.checkSwipeStart(e)){if(g.menus&&g.phoneMenu&&(g.menus.startedInMultiSelectMode=g.phoneMenu.multiSelectMode()),g.vmMain.setFocusedPane(this),platform.isTouchDevice&&!platform.app&&(!platform.ie||platform.mobileie)){var ele=this.scrollElement;if(!g.preventScrollPropagation(ele))return e.preventDefault(),!1}if(!android.isEnabled()||!android.isTargetBox(e)){var target=ko.dataFor(e.srcElement);platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item())),target&&target.onStart&&target.onStart(e)}}},onMove:function onMoveFn(e){g.autocomplete&&platform.mobile&&g.autocomplete.hide(),g.dragStartTimeout&&(clearTimeout(g.dragStartTimeout),g.dragStartTimeout=void 0);var sendMove=!0;if(platform.mobile&&(g.menus.startedInMultiSelectMode||g.dragging||g.ScreenManager&&(sendMove=!g.ScreenManager.checkSwipeMove(e))),sendMove&&(!android.isEnabled()||!android.isTargetBox(e))){var target=ko.dataFor(e.startSrc),onPane=!1;platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item()),onPane=!0),target&&target.onMove&&target.onMove(e,onPane)}return!1},onClick:function onClickFn(e){if(!(platform.mobile&&(!g.ScreenManager||g.ScreenManager.checkSwipeClick(e))||android.isEnabled()&&android.isTargetBox(e))){var target=ko.dataFor(e.startSrc);platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item())),target&&target.onClick?target.onClick(e):g.hasClass(this.paneContent,"noItems")&&!g.hasClass(this.paneContent,"loading")?this.addItem(e):g.hasClass(e.startSrc,"paneDataPageLoad")?this.requestDataPage(this.item()):e.preventDefault()}},onEnd:function onEndFn(e){if(!(platform.mobile&&(!g.ScreenManager||g.ScreenManager.checkSwipeEnd(e))||android.isEnabled()&&android.isTargetBox(e))){var target=ko.dataFor(e.startSrc);if(platform.mobile&&target===this&&(target=g.getLastVisibleItem(g.focusedPane.item())),!target)return;"paneContent"===e.startSrc.id&&(e.preventDefault(),platform.ios&&g.preventClick()),target&&target.onEnd&&target.onEnd(e)}},onDblClick:function onDblClickFn(e){var target=ko.dataFor(e.startSrc);target&&target.onDblClick&&target.onDblClick(e)},onRightClick:function onRightClickFn(e){if(!g.isDisplayModeActive(DisplayMode.NoRightClick)){if(g.vmMain.setFocusedPaneFromElement(e.srcElement),!android.isEnabled()||!android.isTargetBox(e)){var target=ko.dataFor(e.srcElement);target&&target.onRightClick&&target.onRightClick(e)}tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.RightClick,data:{element:void 0}})}}},addItem:function addItemFn(e){var item=this.addItemToPane("",0);platform.mobileie&&android.isEnabled()?android.updateInput(item):(g.focusedPane.paneContent.focus(),g.selectChildren(item,0,0)),platform.mobile&&g.openKeyboardOn(e,item.getSpan(),!0,!1),g.sendEvent("Menu","AddItemButton")},onClose:function onCloseFn(){},onTapAddItem:{onStart:function onStartFn(e){e.preventDefault(),e.stopImmediatePropagation()},onClick:function onClickFn(e){this.addItem(e)}},onTapOutlineButton:function onTapOutlineButtonFn(){this.toggleOutlineVisibility(),this.outline.isVisible()?g.sendEvent("Menu","OpenOutline"):g.sendEvent("Menu","CloseOutline")},onTapClosePane:function onTapClosePaneFn(){var removedID=g.vmMain.paneManager.removePane(this);if(removedID){try{g.PAssert(2521,removedID===this.id,"Pane IDs must match")}catch(PERR){g.reportError(PERR)}tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:removedID}),g.sendEvent("Menu","ClosePane"),g.tooltip.hideTip(),this.onClose()}},onTapArchiveCompleted:{onStart:function onStartFn(e){e.stopImmediatePropagation()},onClick:function onClickFn(e){this.archiveCompleted(),g.sendEvent("Menu","ArchiveCompleted"),g.handlerPreventStop(e)}},onTapRefreshData:{onStart:function onStartFn(e){e.stopImmediatePropagation()},onClick:function onClickFn(e){try{g.PAssert(2522,this.supportDataRefresh,"How did this pane try to perform a data refresh if it is not supported",this.type)}catch(PERR){g.reportError(PERR)}this.refreshPaneData(),g.sendEvent("Menu","PaneDataRefresh"),g.handlerPreventStop(e)}},archiveCompleted:function archiveCompletedFn(){var archivedItems=[];g.searchVMLIs({item:this.item(),includeArchived:!1,comparator:function comparatorFn(item){return item.isComplete()},action:function actionFn(item){archivedItems.push(item)}}),tracker.beginAction();for(var i=archivedItems.length-1;i>=0;i--){var item=archivedItems[i];item.parent().archiveChild(item)}if(tracker.endAction(),archivedItems.length>0){var z=archivedItems.length>1?" items.":" item.";g.messageQueue.pushMessage({text:"Archived "+(archivedItems.length+z),action:MessageAction.Undo,hold:platform.mobile,timeout:platform.mobile?void 0:8e3})}else g.messageQueue.pushMessage({text:"No completed items to archive"});g.sendEvent("Menu","ArchiveCompleted")},onTapViewArchived:function onTapViewArchivedFn(){},updatePosition:function updatePositionFn(x,animate){var time=animate?150:0;g.setTransform(this.scrollElement,x,0,time)},itemTitle:function itemTitleFn(){return this.item().getParsedText()},onTapToggleModeMobile:function onTapToggleModeMobileFn(){var dstType=this.type===PaneMode.Normal?PaneMode.Timeline:PaneMode.Normal;g.vmMain.togglePaneModeMobile(this,dstType)},onTapSettingsMobile:{onClick:function onClickFn(e){g.menus.openModal(Modals.MobileSettings),g.handlerPreventStop(e),g.sendEvent("PhoneMenu","OpenSettings")}},showLoadMore:function showLoadMoreFn(){return!1}},util.defineBase(VMPane),g.VMPane=VMPane,VMPane}),define("VMMain_DragDrop",["ko","globals","platform","tracker","VMPane","VMLI","copypaste"],function(ko,g,platform,tracker,VMPane,VMLI,copypaste){var VMMain_DragDrop=function(self){var activePane,previousEventTarget,previousDropTarget,previousHighlightElement,previousAbove=!1,previousWasPane=!1;self.setDropInfo=function setDropInfoFn(dropTarget,eventTarget,isPane,above){previousDropTarget=dropTarget,previousEventTarget=eventTarget,previousWasPane=isPane,previousAbove=above},self.handleDragOver=function handleDragOverFn(e){if(previousEventTarget!==e.srcElement){e.srcElement&&(activePane=g.getPaneForElement(e.srcElement));var eventTarget=e.srcElement;if(!eventTarget||!activePane||"SPAN"!==eventTarget.tagName&&"P"!==eventTarget.tagName&&"LI"!==eventTarget.tagName&&"UL"!==eventTarget.tagName&&"DIV"!==eventTarget.tagName);else{var pane=g.getPaneForElement(eventTarget);try{g.PAssert(2523,pane,"Must have a valid pane to update our drag target on")}catch(PERR){g.reportError(PERR)}var currentDropTarget=ko.dataFor(eventTarget);try{g.PAssert(2524,currentDropTarget,"Should always have a valid drop target")}catch(PERR){g.reportError(PERR)}var highlightAbove,isPane=!1;if(eventTarget.className.indexOf("paneScroller")>=0)return!1;if(currentDropTarget instanceof VMPane)if(isPane=!0,highlightAbove=e.diffY<0?!0:!1,previousDropTarget&&g.getPaneForElement(previousDropTarget)===pane)currentDropTarget=previousDropTarget;else{var lastItem=g.getLastPaneItem(currentDropTarget);lastItem&&(currentDropTarget=lastItem)}else currentDropTarget instanceof VMLI?(currentDropTarget.isNote()&&(currentDropTarget=currentDropTarget.parent()),pane.isWriteable&&(currentDropTarget.isFullscreen()||"LI"===eventTarget.tagName)?previousDropTarget&&(currentDropTarget=previousDropTarget,highlightAbove=e.diffY<0||previousWasPane?!0:!1):highlightAbove=!0):currentDropTarget=e.dataTransfer.item;try{g.PAssert(2526,currentDropTarget,"Should always have a valid drop target")}catch(PERR){g.reportError(PERR)}var xPadding=0;if(previousAbove=highlightAbove,pane.isWriteable){if(currentDropTarget instanceof VMLI)previousHighlightElement=currentDropTarget.getSpan(pane.id),xPadding=currentDropTarget.getPadding(pane);else if(currentDropTarget instanceof VMPane){try{g.PAssert(2527,currentDropTarget.item&&currentDropTarget.item()&&currentDropTarget.item().items&&0===currentDropTarget.item().items().length,"When dropping into a pane it should be empty")}catch(PERR){g.reportError(PERR)}previousHighlightElement=currentDropTarget.paneContent,highlightAbove=!0}}else previousHighlightElement=void 0;if(previousHighlightElement){var rect=previousHighlightElement.getBoundingClientRect(),y=highlightAbove?rect.top:rect.bottom,x=rect.left+xPadding,width=rect.right-rect.left-xPadding;g.element("dragLine").style.visibility="visible",g.element("dragLine").style[platform.transform.style]="translate("+x+"px, "+y+"px) scale("+width+",1)"}else g.element("dragLine").style.visibility="hidden";previousDropTarget=currentDropTarget,previousEventTarget=eventTarget,previousWasPane=isPane}}if(activePane){var scrollAreaSize=120,topMin=0,topMax=scrollAreaSize,bottomMin=g.vmMain.paneHeight-scrollAreaSize,bottomMax=g.vmMain.paneHeight,offsetY=e.clientY-g.paneTop,speedMod=3;if(topMax>offsetY){var speed=-(1-g.computeScrollSpeed(topMin,topMax,offsetY))*speedMod;g.repeatScroll(speed,activePane)}else if(offsetY>bottomMin&&bottomMax>offsetY){var speed=g.computeScrollSpeed(bottomMin,bottomMax,offsetY)*speedMod;g.repeatScroll(speed,activePane)}else g.cancelRepeatScroll()}else g.cancelRepeatScroll();return!1},self.handleDropItem=function handleDropItemFn(movingItem,e,isNew){var item=movingItem;if(g.cancelRepeatScroll(),movingItem!==previousDropTarget){if(previousDropTarget instanceof VMLI){for(var parent=previousDropTarget.parent();parent;){if(parent===movingItem)return;parent=parent.parent()}if(g.getNextItem(movingItem,g.focusedPane)===previousDropTarget&&previousAbove)return}var pane=g.getPaneForElement(previousEventTarget);if(pane&&pane.isWriteable){var target,targetIndex=-1;previousDropTarget instanceof VMPane?(target=previousDropTarget.item(),targetIndex=0):previousDropTarget.isFullscreen()?(target=previousDropTarget,targetIndex=target.numChildren()):(target=previousDropTarget.parent(),targetIndex=previousAbove?previousDropTarget.getIndex():previousDropTarget.getIndex()+1),tracker.beginAction();try{g.PAssert(2528,target,"Trying to move without a target")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2529,!isNaN(targetIndex),"Trying to move without a target index")}catch(PERR){g.reportError(PERR)}if(e.dataTransfer.dropEffect===DropEffect.Move){var previousParent=movingItem.parent(),previousIndex=movingItem.getIndex();movingItem.moveTo({parent:target,index:targetIndex}),tracker.performAction(TrackerType.Move,{itemID:movingItem.id,oldParent:previousParent.id,oldPosition:previousIndex,newParent:target.id,newPosition:targetIndex})}else isNew||(item=movingItem.clone(ChangeType.Local)),item.parent(target),target.insertItem(item,targetIndex);tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DropItem,data:[{itemID:movingItem.id}]}),tracker.endAction(),g.timeline.reloadTimelines(),previousDropTarget instanceof VMPane&&previousDropTarget.noItems(!1),e.dataTransfer.fromPane&&e.dataTransfer.fromPane.notifyDropFrom(movingItem)}}return item},self.handleDrop=function handleDropFn(e){if(e.stopPropagation(),previousEventTarget){var dropItem=e.dataTransfer.item;if(dropItem)self.handleDropItem(dropItem,e);else{var pluginHandled=g.vmMain.pluginManager.handleDropEvent(e,function(res,isNew){tracker.beginAction();var item=new VMLI({text:res},{forceSave:!0,changeType:ChangeType.AllLocal});return item=self.handleDropItem(item,e,isNew),tracker.endAction(),item});if(!pluginHandled&&(e.dataTransfer.getData(platform.ie?"Text":"text/plain")||e.dataTransfer.getData("text/html"))){var range=g.getCursorSelectionRange(e);try{g.PAssert(2530,range,"Range should always be properly set")}catch(PERR){g.reportError(PERR)}g.setSelectionRange(range),copypaste.insert(e.dataTransfer,range,e,DataSource.Drop)}}return g.element("tempUL").style.display="none",g.element("dragLine").style.visibility="hidden",e.preventDefault(),!1}},self.handleDragLeave=function handleDragLeaveFn(){g.element("tempUL").style.display="none",g.element("dragLine").style.visibility="hidden"
},window.addEventListener("dragover",self.handleDragOver),window.addEventListener("drop",self.handleDrop)};return VMMain_DragDrop}),define("VMTimelineBlock",["ko","globals","data","VMLI","International"],function(ko,g,d,VMLI,International){function VMTimelineBlock(p){this.owner=p.owner,this.date=p.date,this.dateKey=p.dateKey,this.text=p.text,this.name=p.name,this.searchProvider=void 0,this.items=ko.observableArray(),this.searchCount=ko.observable(0),this.hasDeferredUpdate=!1,this.element=void 0,this.isStarred=p.isStarred,this.isImportant=p.isImportant,this.isToday=!1,this.init(p)}return VMTimelineBlock.prototype={destroy:function destroyFn(){this.owner=void 0,this.searchProvider=void 0,this.element=void 0},showBlock:function showBlockFn(){return this.items().length>0&&this.searchCount()>0},specialClass:function specialClassFn(){return this.isStarred?"starredBlock":this.isImportant?"importantBlock":this.isToday||this.isNow?"todayBlock":void 0},showTime:function showTimeFn(ctx){var item=ctx.$data,index=ctx.$index;if(this.isNow)return!1;var tempValue=this.searchProvider.onUpdated();if(!this.items()[0].hasTime()||this.isStarred||this.isImportant||!this.searchProvider.isVisible(item))return!1;for(var previousVisible=index()-1;previousVisible>0&&!this.searchProvider.isVisible(this.items()[previousVisible]);)previousVisible--;if(0>previousVisible)return!0;var prevItem=this.items()[previousVisible];if(item.hasTime()){if(prevItem.getTimeOfDay()===item.getTimeOfDay())return!1}else if(!prevItem.hasTime())return!1;return!0},processDeferredUpdates:function processDeferredUpdatesFn(){this.hasDeferredUpdate&&(this.hasDeferredUpdate=!1)},init:function initFn(p){try{g.PAssert(2531,this.date)}catch(PERR){g.reportError(PERR)}if(this.dateKey||(this.dateKey=this.date.clone().clearTime().getTime(),p.name&&(this.dateKey=this.dateKey+p.name)),this.name)this.text=this.name.toUpperCase(),"NOW"===this.name&&(this.isNow=!0);else{this.text="";var today=Date.today();if(this.date){var timeDiff=Math.floor((this.date-today)/864e5);switch(timeDiff){case-1:this.text="YESTERDAY ";break;case 0:this.text="TODAY ",this.isToday=!0;break;case 1:this.text="TOMORROW ";break;default:this.text=this.date.toString("dddd").toUpperCase()}}var showYear=this.date.getYear()!==today.getYear(),dateFormatEnum=showYear?DFormat.MonthDayYear:DFormat.ShortDate,dateFormat=International.getFormat(dateFormatEnum);this.text=this.text+" "+this.date.toString(dateFormat)}},comparePriority:function comparePriorityFn(left,right){var lPri=left.priority(),rPri=right.priority();return lPri>rPri?-1:rPri>lPri?1:0},compareDate:function compareDateFn(left,right){if(left.isComplete()&&!right.isComplete())return-1;if(!left.isComplete()&&right.isComplete())return 1;if(left.isComplete()&&right.isComplete())return left.dateCompleted>right.dateCompleted?1:-1;var leftDate=left.date()||left.repeatDate(),rightDate=right.date()||right.repeatDate();if(leftDate&&!rightDate)return-1;if(!leftDate&&rightDate)return 1;if(leftDate.hasTimeOfDay()&&rightDate.hasTimeOfDay()){var leftTime=leftDate.getTimeOfDay(),rightTime=rightDate.getTimeOfDay();return leftTime===rightTime?0:rightTime>leftTime?-1:1}return leftDate.hasTimeOfDay()?-1:rightDate.hasTimeOfDay()?1:0},compareOrder:function compareOrderFn(left,right){var first=g.getFirstItem(left,right);try{g.PAssert(2532,void 0!==first)}catch(PERR){g.reportError(PERR)}return first.id===left.id?-1:1},compareItems:function compareItemsFn(left,right){var cDate=this.isStarred||this.isImportant?0:this.compareDate(left,right);if(0===cDate){var cPriority=this.isStarred?0:this.comparePriority(left,right);if(0===cPriority){var cOrder=this.compareOrder(left,right);try{g.PAssert(2533,0!==cOrder,"This should always result in a tie break")}catch(PERR){g.reportError(PERR)}return cOrder}return cPriority}return cDate},addItem:function addItemFn(item){return this.items.indexOf(item)>=0?void this.updateItem(item):(this.searchProvider.isMatched(item)&&this.searchCount(this.searchCount()+1),void(this.owner.deferModelUpdates?(this.items().insertSorted(item,this.compareItems.bind(this)),this.hasDeferredUpdate=!0):this.items.insertSorted(item,this.compareItems.bind(this))))},removeItem:function removeItemFn(item){if(this.searchProvider.isMatched(item)){this.searchCount(this.searchCount()-1);try{g.PAssert(2534,this.searchCount()>=0,"Searchcount should never be negative")}catch(PERR){g.reportError(PERR)}}this.owner.deferModelUpdates?(this.items().remove(item),this.hasDeferredUpdate=!0):this.items.remove(item)},updateItem:function updateItemFn(item){this.owner.deferModelUpdates?(this.items().remove(item),this.items().insertSorted(item,this.compareItems.bind(this)),this.hasDeferredUpdate=!0):(this.items.remove(item),this.items.insertSorted(item,this.compareItems.bind(this)))},onLoad:function onLoadFn(element){this.element=element},notifySearchStateChanged:function notifySearchStateChangedFn(item,newValue){try{g.PAssert(2535,void 0!==newValue||this.searchProvider,"Must supply a value or a valid search provider")}catch(PERR){g.reportError(PERR)}if(void 0===newValue&&(newValue=this.searchProvider.isMatched(item)),newValue===!0)this.searchCount(this.searchCount()+1);else{this.searchCount(this.searchCount()-1);try{g.PAssert(2536,this.searchCount()>=0,"Searchcount should never be negative")}catch(PERR){g.reportError(PERR)}}},setSearchProvider:function setSearchProviderFn(vmSearch){this.searchProvider=vmSearch}},VMTimelineBlock}),define("VMPane_Timeline",["ko","globals","util","platform","data","VMTimelineBlock","RepeatDate","VMPane"],function(ko,g,util,platform,d,VMTimelineBlock,RepeatDate,VMPane){function VMPane_Timeline(p){this._super.constructor.call(this,p),this.type=PaneMode.Timeline,this.paneClass="paneTimeline",this.isWriteable=!1,this.overrideCopyBehavior=!1,this.supportCollapsing=!1,this.supportOffline=!0,this.supportViewArchived=!0,this.initTimeline()}var VMPane_TimelineFns={initTimeline:function initTimelineFn(){this.blocks=ko.observableArray(),this.blockImportant=void 0,this.blockStarred=void 0,this.days={},this.updateNextTimeout=0,this.datesByItem={},this.starredItems={},this.priorityItems={},this.isLoading=!1,this.deferModelUpdates=0,this._showArchivedSubscription=this.showArchived.subscribe(this.reloadTimeline.bind(this)),this._notifyArchivedSubscription=this.showArchived.subscribe(g.vmMain.paneManager.checkDisplayArchived.bind(g.vmMain.paneManager))},destroy:function destroyFn(){this._showArchivedSubscription.dispose(),this._showArchivedSubscription=void 0,this._notifyArchivedSubscription.dispose(),this._notifyArchivedSubscription=void 0,this.blockImportant&&(this.blockImportant.destroy(),this.blockImportant=void 0),this.blockStarred&&(this.blockStarred.destroy(),this.blockStarred=void 0);for(var blocks=this.blocks(),i=0;i<blocks.length;++i)blocks[i].destroy();this._super.destroy.call(this)},templateName:function templateNameFn(pane,b){return"template-pane-timeline"},getPaneIcon:function getPaneIconFn(){return"icon-calendar2"},updateContents:function updateContentsFn(){this._super.updateContents.call(this),this.reloadTimeline()},onTapViewArchived:function onTapViewArchivedFn(){this.showArchived(!this.showArchived()),g.vmMain.paneManager.updatePaneStateForPane(this),g.sendEvent("Menu","ShowArchivedTimeline")},onAfterLoaded:function onAfterLoadedFn(){var block=this.findNextBlock();this.initialOffset=block&&block.element?platform.mobile?block.element.getBoundingClientRect().top:block.element.getBoundingClientRect().top-this.scrollElement.getBoundingClientRect().top-25:0,this._super.onAfterLoaded.call(this)},hasBlocks:function hasBlocksFn(){for(var count=0,i=0;i<this.blocks().length;i++)count+=this.blocks()[i].searchCount();return count>0},reasonEmpty:function reasonEmptyFn(){return this.vmSearch&&this.vmSearch.search().length>0?"No search results":"Nothing on the agenda"},blockCompare:function blockCompareFn(left,right){return left.isNow&&right.isToday?-1:left.isToday&&right.isNow?1:left.date.compareTo(right.date)},removeDate:function removeDateFn(item){var vmDateStore=this.datesByItem[item.id];if(vmDateStore)if(g.isArray(vmDateStore))for(var i=0;i<vmDateStore.length;++i)vmDateStore[i].removeItem(item);else vmDateStore.removeItem(item);this.datesByItem[item.id]=void 0},updateItem:function updateItemFn(item){var vmDateStore=this.datesByItem[item.id];if(vmDateStore)if(g.isArray(vmDateStore))for(var i=0;i<vmDateStore.length;++i)vmDateStore[i].updateItem(item);else vmDateStore.updateItem(item)},addBlock:function addBlockFn(block){block.setSearchProvider(this.vmSearch),this.deferModelUpdates?this.blocks().insertSorted(block,this.blockCompare):this.blocks.insertSorted(block,this.blockCompare)},dumpBlocks:function dumpBlocksFn(){log("Dump Timeline Blocks:");for(var i=0;i<this.blocks().length;++i){var block=this.blocks()[i];log("  Block: ",block.text),log("  Date: ",block.date),log("  Key: ",block.dateKey),log("  Count: ",block.searchCount());for(var j=0;j<block.items().length;++j){var item=block.items()[j];log("    Item: ",item.getParsedText())}}},findNextBlock:function findNextBlockFn(){for(var now=new Date,i=0;i<this.blocks().length;i++){var block=this.blocks()[i];if(block.isToday||block.isStarred||block.isImportant||block.date>now)return block}},hideDescendants:function hideDescendantsFn(parent){for(var i=0;i<parent.items().length;i++){var item=parent.items()[i];this.datesByItem[item.id]&&this.removeDate(item),this.starredItems[item.id]&&(this.blockStarred.removeItem(item),this.starredItems[item.id]=void 0),this.priorityItems[item.id]&&(this.blockImportant.removeItem(item),this.priorityItems[item.id]=void 0),item.items().length>0&&this.hideDescendants(item)}},notifyDescendants:function notifyDescendantsFn(parent){for(var i=0;i<parent.items().length;i++){var item=parent.items()[i];this.notifyStateChanged(item),item.items().length>0&&this.notifyDescendants(item)}},notifyPositionChanged:function notifyPositionChangedFn(item){this.isLoading||(this.datesByItem[item.id]&&this.updateItem(item),this.starredItems[item.id]&&this.blockStarred.updateItem(item),this.priorityItems[item.id]&&this.blockImportant.updateItem(item))},notifySearchStateChanged:function notifySearchStateChangedFn(item,newValue){if(!this.isLoading){if(this.datesByItem[item.id]){var vmDateStore=this.datesByItem[item.id];if(g.isArray(vmDateStore))for(var i=0;i<vmDateStore.length;++i)vmDateStore[i].notifySearchStateChanged(item,newValue);else vmDateStore.notifySearchStateChanged(item,newValue)}this.starredItems[item.id]&&this.blockStarred.notifySearchStateChanged(item,newValue),this.priorityItems[item.id]&&this.blockImportant.notifySearchStateChanged(item,newValue)}},notifyStateChanged:function notifyStateChangedFn(item,changeType){if(!this.isLoading&&!item.hasCompletedAncestor()&&item.isDescendantOf(this.item())){var dataItem=d.getItem(item.id);try{g.PAssert(2537,!dataItem||!!dataItem.isDeleted==!!item.isDeleted()||g.isDemoMode(),"isDeleted should match loaded item and item info")}catch(PERR){g.reportError(PERR)}if(this.vmSearch.checkItem(item),dataItem&&dataItem.isDeleted)this.removeDate(item),item.isImportant()&&this.updateSpecialBlock(item,this.priorityItems,this.blockImportant,!1),item.isStarred()&&this.updateSpecialBlock(item,this.starredItems,this.blockStarred,!1);else{if(!changeType||g.isAtLeastOneFlagSet(changeType,PropChangeType.Date|PropChangeType.Complete|PropChangeType.Archive))if(item.date()||item.repeatDate()||item.isComplete()){var date;date=item.repeatDate()?item.repeatDate():item.date()?item.date():item.dateCompleted,this.dateUpdated(item,date)}else this.removeDate(item);g.isAtLeastOneFlagSet(changeType,PropChangeType.Complete|PropChangeType.Archive)&&(item.isComplete()||item.isArchived()?this.hideDescendants(item):this.notifyDescendants(item)),(!changeType||g.isAtLeastOneFlagSet(changeType,PropChangeType.Priority|PropChangeType.Complete|PropChangeType.Archive))&&this.updateSpecialBlock(item,this.priorityItems,this.blockImportant,item.isImportant()&&!item.isComplete()),(!changeType||g.isAtLeastOneFlagSet(changeType,PropChangeType.Starred|PropChangeType.Complete|PropChangeType.Archive))&&this.updateSpecialBlock(item,this.starredItems,this.blockStarred,item.isStarred()&&!item.isComplete())}}},updateSpecialBlock:function updateSpecialBlockFn(item,items,block,matches){!matches||item.isDeleted()||item.isArchived()&&!this.showArchived()?items[item.id]&&(block.removeItem(item),items[item.id]=void 0):items[item.id]?block.updateItem(item):(block.addItem(item),items[item.id]=item)},getDateKey:function getDateKeyFn(item,date){var dateKey;if(date instanceof RepeatDate){var schedDates=date.getDates();dateKey=[];for(var i=0;i<schedDates.length;++i)dateKey.push(schedDates[i].clone().clearTime().getTime())}else dateKey=g.isDateSoft(item.dateText)?item.dateText.toUpperCase():date.clone().clearTime().getTime();return dateKey},updateItemEntry:function updateItemEntryFn(item,dateKey,newEntry){if(this.removeDate(item),this.datesByItem[item.id]=newEntry,g.isArray(dateKey))for(var i=0;i<dateKey.length;++i)this.days[dateKey[i]].addItem(item);else this.days[dateKey].addItem(item)},dateUpdated:function dateUpdatedFn(item,date,skipSort){if(!this.isLoading){if(item.isArchived()&&!this.showArchived())return void(this.datesByItem[item.id]&&this.removeDate(item));if(item.isDescendantOf(this.item()))if(this.vmSearch.checkItem(item),date){var dateKey=this.getDateKey(item,date);if(g.isArray(dateKey)){for(var schedDates=date.getDates(),blocks=[],i=0;i<dateKey.length;++i)blocks.push(this.ensureDateBlock(dateKey[i],schedDates[i],skipSort));this.updateItemEntry(item,dateKey,blocks)}else{var block=this.ensureDateBlock(dateKey,date,skipSort);this.updateItemEntry(item,dateKey,block)}}else this.removeDate(item)}},ensureDateBlock:function ensureDateBlockFn(dateKey,date,skipSort){var vmDate=this.days[dateKey];if(!vmDate){var options={owner:this,date:date.clone().clearTime(),dateKey:dateKey};g.isString(dateKey)&&(options.name=dateKey),vmDate=new VMTimelineBlock(options),this.days[dateKey]=vmDate,this.addBlock(vmDate,skipSort)}return vmDate},ensureSpecialBlocks:function ensureSpecialBlocksFn(){this.blockStarred||(this.blockStarred=new VMTimelineBlock({owner:this,name:"Starred",date:Date.today().add({hour:1}),isStarred:!0}),this.addBlock(this.blockStarred)),this.blockImportant||(this.blockImportant=new VMTimelineBlock({owner:this,name:"Important",date:Date.today().add({hour:2}),isImportant:!0}),this.addBlock(this.blockImportant))},loadTimeline:function loadTimelineFn(){try{g.PAssert(2538,0===this.blocks().length,"When loading the timeline we expect it to be empty")}catch(PERR){g.reportError(PERR)}this.setDeferUpdates(!0),this.ensureSpecialBlocks(),g.searchVMLIs({item:this.item(),includeArchived:this.showArchived(),each:this.notifyStateChanged.bind(this)}),this.setDeferUpdates(!1),this.vmSearch.onUpdated.valueHasMutated()},unloadTimeline:function unloadTimelineFn(){this.datesByItem={},this.starredItems={},this.priorityItems={},this.days={},this.deferModelUpdates?this.blocks().splice(0,this.blocks().length):this.blocks([]),this.blockStarred=void 0,this.blockImportant=void 0},reloadTimeline:function reloadTimelineFn(){this.reloading=!0,this.unloadTimeline(),this.loadTimeline(),this.reloading=!1},setDeferUpdates:function setDeferUpdatesFn(value){this.deferModelUpdates+=value?1:-1;try{g.PAssert(2539,this.deferModelUpdates>=0,"Mismatching defer update calls")}catch(PERR){g.reportError(PERR)}if(0===this.deferModelUpdates){this.blocks.valueWillMutate();for(var numBlocks=this.blocks().length,i=0;numBlocks>i;++i)this.blocks()[i].processDeferredUpdates();this.blocks.valueHasMutated()}},startLoading:function startLoadingFn(){try{g.PAssert(2540,!this.isLoading,"Should only notify the timeline a single time when loading starts")}catch(PERR){g.reportError(PERR)}this.isLoading=!0},endLoading:function endLoadingFn(){try{g.PAssert(2541,this.isLoading,"Must have started loading the timeline to stop loading it")}catch(PERR){g.reportError(PERR)}this.isLoading=!1,this.setDeferUpdates(!0),this.reloadTimeline(),this.setDeferUpdates(!1)}};return util.inherit(VMPane,VMPane_Timeline),util.extend(VMPane_Timeline.prototype,VMPane_TimelineFns),VMPane_Timeline}),define("PaneFactory",["ko","globals","data","VMPane","VMPane_Timeline"],function(ko,g,d,VMPane,VMPane_Timeline){function PaneFactory(){this._inactivePaneTypes={},this._activePaneTypes=ko.observableArray(),this._registeredTypes={},this.numInactivePanes=ko.observable(0),this.registerPaneType(void 0,PaneMode.Normal,"Normal",VMPane,"icon-align-left"),this.registerPaneType(void 0,PaneMode.Timeline,"Agenda",VMPane_Timeline,"icon-calendar2")}return PaneFactory.prototype={registerPaneType:function registerPaneTypeFn(plugin,type,name,constructor,icon){this._registeredTypes[type]={plugin:plugin,constructor:constructor};var paneTypeInfo={type:type,name:name,icon:icon,text:name+" Pane",tooltip:"Add "+name+" Pane"};!plugin||plugin.isActive()?this._activePaneTypes.push(paneTypeInfo):(this._inactivePaneTypes[type]=paneTypeInfo,this.numInactivePanes(this.numInactivePanes()+1))},activatePaneType:function activatePaneTypeFn(type){var paneTypeInfo=this._inactivePaneTypes[type];try{g.PAssert(2542,paneTypeInfo,"Must have previously registered pane type")}catch(PERR){g.reportError(PERR)}this._inactivePaneTypes[type]=void 0,this._activePaneTypes.push(paneTypeInfo),this.numInactivePanes(this.numInactivePanes()-1)},deactivatePaneType:function deactivatePaneTypeFn(type){var paneTypeInfo=this._activePaneTypes.remove(function(entry){return entry.type===type})[0];try{g.PAssert(2543,paneTypeInfo,"Must have previously activated pane type")}catch(PERR){g.reportError(PERR)}g.vmMain.paneManager.removePanesByType(type),this._inactivePaneTypes[type]=paneTypeInfo,this.numInactivePanes(this.numInactivePanes()+1)},createPane:function createPaneFn(type,options){var paneInfo=this._registeredTypes[type];if(paneInfo)return!paneInfo.plugin||paneInfo.plugin.isActive()&&!paneInfo.plugin.isPluginBlocked()?new paneInfo.constructor(options):void 0;try{g.PAssert(2544,!1,"Invalid pane type requested")}catch(PERR){g.reportError(PERR)}return void 0},isPaneTypeActive:function isPaneTypeActiveFn(type){var isRegistered=!!this._registeredTypes[type],isInactive=!!this._inactivePaneTypes[type];return isRegistered&&!isInactive},getRegisteredPanes:function getRegisteredPanesFn(){return this._activePaneTypes}},new PaneFactory}),define("VMDocument",["ko","globals","platform","data","goog","tracker"],function(ko,g,platform,d,goog,tracker){function VMDocument(p){this.file=p,this.id=p&&p.id,this.title=ko.observable(p&&p.title||""),this.shared=p&&p.shared,this.isOpen=void 0,this.isOwned=ko.observable(!1),this.init()}return VMDocument.prototype={init:function initFn(){this.file&&"me"===this.file.userPermission.id&&"owner"===this.file.userPermission.role&&this.isOwned(!0)},update:function updateFn(file){this.title()!==file.title&&this.title(file.title),this.shared!==file.shared&&(this.shared=file.shared)},onTapMenu:function onTapMenuFn(){this.openSharing(),g.sendEvent("Menu","OpenSharing"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocSharing,data:[{value:!0}]})},openSharing:function openSharingFn(callback){g.menus.openModal(Modals.ShareDoc,this,callback)},closeMenu:function closeMenuFn(){g.menus.closeContextMenu(g.element("contextMenuDocument"))},onTapContextMenu:function onTapContextMenuFn(e){var id=e.srcElement.id;switch(id||(id=e.srcElement.parentNode.id),id){case"documentDelete":break;case"documentShare":}this.closeMenu()}},VMDocument}),define("ModalBase",["ko","globals","util"],function(ko,g,util){function ModalBase(id){try{g.PAssert(2545,id,"Must supply each modal with a valid ID")}catch(PERR){g.reportError(PERR)}this.id=id,this.isRegistered=!1,this.isVisible=ko.observable(!1),this.openFn=void 0,this.closeFn=void 0}return ModalBase.prototype={registerModal:function registerModalFn(openFn,closeFn){try{g.PAssert(2546,!openFn||g.isFunction(openFn),"May only supply a function as an open callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2547,!closeFn||g.isFunction(closeFn),"May only supply a function as an open callback")}catch(PERR){g.reportError(PERR)}this.openFn=openFn,this.closeFn=closeFn,this.isRegistered=!0,g.menus.registerModal(this.id,this)},openModal:function openModalFn(){setTimeout(function(){this.isVisible(!0)}.bind(this),0),this.openFn&&this.openFn.apply(this,arguments)},closeModal:function closeModalFn(){this.isVisible(!1),this.closeFn&&this.closeFn.apply(this,arguments)},close:function closeFn(){g.menus.closeModal(this.id,!0)}},util.defineBase(ModalBase),ModalBase}),define("ModalConfirm",["ko","globals","util","platform","ModalBase"],function(ko,g,util,platform,ModalBase){function ModalConfirm(){this._super.constructor.call(this,Modals.Confirm),this.activeCallback=void 0,this.activeText=ko.observable(""),this.init()}var ModalConfirmFns={init:function initFn(){this.registerModal()},openDialog:function openDialogFn(text,cb){try{g.PAssert(2548,text,"Must have valid text to display")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2549,cb,"Must supply a valid callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2550,!this.activeCallback,"Must not already have an active callback")}catch(PERR){g.reportError(PERR)}this.activeText(text),this.activeCallback=cb,g.menus.openModal(this.id)},closeNo:function closeNoFn(){try{g.PAssert(2551,this.activeCallback,"Must have an active callback")}catch(PERR){g.reportError(PERR)}g.menus.closeModal(this.id),this.activeCallback(!1),this.clearModalData()},closeYes:function closeYesFn(){try{g.PAssert(2552,this.activeCallback,"Must have an active callback")}catch(PERR){g.reportError(PERR)}g.menus.closeModal(this.id),this.activeCallback(!0),this.clearModalData()},clearModalData:function clearModalDataFn(){this.activeCallback=void 0,this.activeText("")}};return util.inherit(ModalBase,ModalConfirm),util.extend(ModalConfirm.prototype,ModalConfirmFns),ModalConfirm}),define("ModalAlert",["ko","globals","util","platform","ModalBase"],function(ko,g,util,platform,ModalBase){function ModalAlert(){this._super.constructor.call(this,Modals.Alert),this.activeCallback=void 0,this.activeDescriptionText=ko.observable(""),this.activeActionText=ko.observable(""),this.isBig=ko.observable(!1),this.init()}var ModalAlertFns={init:function initFn(){this.registerModal()},openDialog:function openDialogFn(params){this.activeCallback=params.action,this.activeDescriptionText(params.text),this.activeActionText(params.actionText),this.isBig(params.big),g.menus.openModal(this.id)},onTapAlertClose:function onTapAlertCloseFn(){try{g.PAssert(2553,this.activeCallback,"Must have an active callback")}catch(PERR){g.reportError(PERR)}g.menus.closeModal(this.id),this.activeCallback(),this.clearModalData()},clearModalData:function clearModalDataFn(){this.activeCallback=void 0,this.activeDescriptionText(""),this.activeActionText(""),this.isBig(!1)}};return util.inherit(ModalBase,ModalAlert),util.extend(ModalAlert.prototype,ModalAlertFns),ModalAlert}),define("ModalSettings",["ko","globals","data","util","platform","goog","tracker","ModalBase"],function(ko,g,d,util,platform,goog,tracker,ModalBase){function ModalSettings(){this._super.constructor.call(this,Modals.Settings),this.billingManager=g.billingManager,this.sectionOpened=ko.observable(Sections.Plugins),this._pluginsEnabled={},this.pluginsAvailable=[PluginID.Drive,PluginID.Gmail],this._pluginOptions={},this.isAllDayTimeValid=ko.observable(!0),this.refreshingContacts=!1,this.numContacts=ko.observable(),this.init()}var Sections={Plugins:"plugins",Premium:"premium"},ModalSettingsFns={init:function initFn(){this.registerModal(this.onModalOpen.bind(this),this.onModalClose.bind(this)),this.sectionOpened.subscribe(this.onSectionOpened.bind(this))},addSetting:function addSettingFn(name,value){this[name]=ko.observable(value),this[name].subscribe(g.curry(this.save.bind(this),name))},isOpen:function isOpenFn(section){return this.sectionOpened()===section},isPluginEnabled:function isPluginEnabledFn(id){return this._pluginsEnabled[id]},getPluginOption:function getPluginOptionFn(id,option){return this._pluginOptions[id][option]},isPluginAnOption:function isPluginAnOptionFn(id){return id===PluginID.Mailbird?"mailbird"===platform.embed:void 0},_updatePluginStatus:function _updatePluginStatusFn(pluginID,status){this._pluginsEnabled[pluginID]?this._pluginsEnabled[pluginID](status):this._pluginsEnabled[pluginID]=ko.observable(status)},_updatePluginOptionStatus:function _updatePluginOptionStatusFn(pluginID,option){this._pluginOptions[pluginID]||(this._pluginOptions[pluginID]={});var status=g.vmMain.pluginManager.getSetting(pluginID,option);this._pluginOptions[pluginID][option]?this._pluginOptions[pluginID][option](status):this._pluginOptions[pluginID][option]=ko.observable(status)},onModalOpen:function onModalOpenFn(section){section&&this.sectionOpened(section),this._updatePluginStatus(PluginID.Contacts,g.settings.get(Settings.syncContacts)),this.numContacts(d.contactManager.numContacts());for(var i=0;i<this.pluginsAvailable.length;i++){var pluginID=this.pluginsAvailable[i],authed=g.vmMain.pluginManager.isAuthorized(pluginID);this._updatePluginStatus(pluginID,authed)}this._updatePluginOptionStatus(PluginID.Drive,"writeAccess")},onModalClose:function onModalCloseFn(){},save:function saveFn(e1,e2){log(e1,"changed to to",e2)},onSectionOpened:function onSectionOpenedFn(section){section===Sections.Premium&&this.billingManager.initUI()},onTapSection:function onTapSectionFn(e){var id=e.target.id.replace("btn-settings-","");try{g.PAssert(2554,id,"Must have a valid section defined")}catch(PERR){g.reportError(PERR)}this.sectionOpened(id)},onFailedAuthenticate:function onFailedAuthenticateFn(name){g.messageQueue.pushMessage({text:"TODO: TEMPORARY ERROR MESSAGE",actionText:"TRY AGAIN",action:function actionFn(){}.bind(this)})},togglePlugin:function togglePluginFn(name){var enabled=!this._pluginsEnabled[name]();if(name===PluginID.Contacts)g.settings.set(Settings.syncContacts,enabled),enabled?this.enableSyncContacts():(g.sendEvent("Settings","DisableContacts"),goog.loadedContacts=!1,d.clearContacts(),this._pluginsEnabled[name](!1));else{var options={};enabled?g.vmMain.pluginManager.authorizePlugin(name,options,function(success){success?this._pluginsEnabled[name](!0):this.onFailedAuthenticate(name)}.bind(this)):g.vmMain.pluginManager.deauthorizePlugin(name,options,function(){this._pluginsEnabled[name](!1)}.bind(this))}},togglePluginOption:function togglePluginOptionFn(pluginID,name){var enabled=!this._pluginOptions[pluginID][name]();g.vmMain.pluginManager.setSetting(pluginID,name,enabled);var options={};enabled?g.vmMain.pluginManager.authorizePlugin(pluginID,options,function(success){success?this._pluginOptions[pluginID][name](!0):this.onFailedAuthenticate(name)}.bind(this)):this._pluginOptions[pluginID][name](!1)},toggleContacts:function toggleContactsFn(e){this.togglePlugin(PluginID.Contacts)},enableSyncContacts:function enableSyncContactsFn(handler){function handleContactsLoaded(numContacts){0>numContacts?(g.messageQueue.pushMessage({text:"There was an error syncing your contacts. Please try again.",actionText:"SYNC",action:function actionFn(){this.enableSyncContacts(handler)}.bind(this)}),handler&&handler(!1)):numContacts>0&&(g.vmMain.parseSubtree(g.vmMain.root(),ChangeType.Auto),handler&&handler(!0)),this.numContacts(d.contactManager.numContacts())}g.sendEvent("Settings","EnableContacts"),goog.runAuthenticate([GScope.Contacts],!1,!1,function(token){token&&!token.error?(goog.loadContacts(handleContactsLoaded.bind(this)),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SyncContacts,data:[{value:!0}]}),this._pluginsEnabled[PluginID.Contacts](!0),g.settings.set(Settings.syncContacts,!0)):(this._pluginsEnabled[PluginID.Contacts](!1),g.settings.set(Settings.syncContacts,!1),g.messageQueue.pushMessage({text:"To sync your contacts we need permission to access them. Please try again.",actionText:"SYNC",action:function actionFn(){this.enableSyncContacts(handler)}.bind(this)}),handler&&handler(!1))}.bind(this))},onTapRefreshContacts:function onTapRefreshContactsFn(){this.refreshingContacts||(this.refreshingContacts=!0,d.clearLocalContacts(),goog.loadedContacts=!1,goog.authAndLoadContacts(function(success){this.numContacts(d.contactManager.numContacts()),setTimeout(function(){this.refreshingContacts=!1}.bind(this),1e3)}.bind(this)),g.sendEvent("Menu","RefreshContacts"))},textContacts:function textContactsFn(){return this.numContacts()+" contacts loaded"},toggleDrive:function toggleDriveFn(e){this.togglePlugin(PluginID.Drive)},toggleSharedDrive:function toggleSharedDriveFn(e){this.togglePluginOption(PluginID.Drive,"writeAccess")},toggleGmail:function toggleGmailFn(e){this.togglePlugin(PluginID.Gmail)},isPremiumEnabled:function isPremiumEnabledFn(){return!g.isDemoMode()&&g.billingManager.isPremiumEnabled()},onAllDayTimeValid:function onAllDayTimeValidFn(value){this.isAllDayTimeValid(value),value&&this.datesAllDayTime(g.element("settings-allday").value)}};return util.inherit(ModalBase,ModalSettings),util.extend(ModalSettings.prototype,ModalSettingsFns),ModalSettings}),define("VMMenus",["ko","globals","data","gdata","VMSearch","VMTitle","edit","VMLI","tracker","platform","VMDocument","ModalBase","ModalConfirm","ModalAlert","ModalSettings","PaneFactory"],function(ko,g,d,gdata,VMSearch,VMTitle,edit,VMLI,tracker,platform,VMDocument,ModalBase,ModalConfirm,ModalAlert,ModalSettings,PaneFactory){function VMMenus(){try{g.PAssert(2555,!g.menus,"Should only have a single instance of VMMenus")}catch(PERR){g.reportError(PERR)}g.menus=this,this.linkAddress=ko.observable(),this.rightMenuThresh=8,this.rightMenuWidth=55,this.rightItemMenuWidth=55,this.phoneLastTop=0,this.rightMenuPhone=void 0,this.itemIsHeader=ko.observable(!1),this.itemHasChildren=ko.observable(!1),this.itemIsCollapsed=ko.observable(!1),this.itemIsArchived=ko.observable(!1),this.itemIsComplete=ko.observable(!1),this.itemCanIndent=ko.observable(!1),this.itemCanUnindent=ko.observable(!1),this.itemCanZoom=ko.observable(!1),this.itemCanAddNote=ko.observable(!1),this.itemCanArchive=ko.observable(!1),this.contextMenuOpenedOn=ko.observable(void 0),this.isModalVisible=ko.observable(!1),this.menusBound=!1,this._registeredModals={},this._openModals=[],this.main=function(){return g.vmMain},this.init()}return VMMenus.prototype={init:function initFn(){window.addEventListener("closeKeyboard",this.onCloseKeyboard.bind(this)),g.addCustomEventListener("keyEscape",this.onEscapeKey.bind(this),100),platform.mobile||this.isModalVisible.subscribe(function(newValue){requestAnimationFrame(newValue?function(){requestAnimationFrame(function(){g.addClass(g.element("main"),"modalOpen"),g.addClass(g.element("desktopMenu"),"modalOpen")})}:function(){g.removeClass(g.element("main"),"modalOpen"),g.removeClass(g.element("desktopMenu"),"modalOpen")})}),g.applyBindings(this,"modals"),this.modalConfirm=new ModalConfirm,this.modalAlert=new ModalAlert,new ModalSettings},vmPicker:function vmPickerFn(){return g.vmMain.vmPicker},bind:function bindFn(){this.menusBound||(this.menusBound=!0,g.applyBindings(this,"contextMenus"),platform.mobile&&(this.rightMenuPhone=g.element("rightMenuPhone"),this.rightMenuPhoneItems=g.element("rightMenuPhoneItems"),g.applyBindings(this,"rightMenuPhoneItems")))},onEscapeKey:function onEscapeKeyFn(){return this.isModalVisible()?this._closeModalInternal(!1):void this.closeItemMenu()},selectionHasChildren:function selectionHasChildrenFn(){for(var i=0;i<g.vmMain.selected().length;i++)if(g.vmMain.selected()[i].hasChildren())return!0;return!1},selectionIsHeader:function selectionIsHeaderFn(){return 1===g.vmMain.selected().length&&g.vmMain.selected()[0].isHeader()},openLinkMenu:function openLinkMenuFn(target,address,left,top){this.linkAddress(address),g.menuOnItem=target;var menuLink=document.getElementById("contextMenuLink");menuLink.style.left=left+"px",menuLink.style.top=top+"px",menuLink.style.display="block",g.vmMain.handleFullscreenClick()
},closeLinkMenu:function closeLinkMenuFn(){g.menuOnItem=void 0,this.linkAddress("");var menuLink=document.getElementById("contextMenuLink");menuLink.style.display="none",g.vmMain.cancelFullscreenClick()},onTapLink:{onClick:function onClickFn(){this.closeLinkMenu()}},closeAllMenus:function closeAllMenusFn(){this.closeLinkMenu(),this.closeContextMenu(),this.closeAddPaneMenu(),this.closeOptionsMenu(),this.closeDocumentsMenu()},setupItemMenu:function setupItemMenuFn(){g.element("menuGoto").style.display=g.focusedPane.isSearching?"block":"none"},onTapHover:{onStart:function onStartFn(e){e.preventDefault()},onClick:function onClickFn(e){var id=e.srcElement.id;g.sendEvent("Menu",id)}},multiSelect:function multiSelectFn(item){item.isSelected(!item.isSelected()),item.isSelected()?g.vmMain.selected.push(item):g.vmMain.selected.splice(g.vmMain.selected.indexOf(item),1)},revealGestureMenu:function revealGestureMenuFn(item){try{g.PAssert(2557,g.revealingMenu===!1,"Must not have already started a gesture")}catch(PERR){g.reportError(PERR)}g.revealingMenu=!0,this.startedInMultiSelectMode=g.phoneMenu.multiSelectMode(),g.menuOnItem=item;var menuSpan=item.getSpan(),height=40,offsetTop=g.offset(menuSpan).top,top=offsetTop-g.topBarHeight,spanHeight=g.height(menuSpan)+8;top+=(spanHeight-height)/2;var paneTop=top;this.phoneLastTop!==paneTop&&(this.phoneLastTop=paneTop),this.startedInMultiSelectMode||g.setTransformStyle(this.rightMenuPhone,0,0)},updateRevealGestureMenu:function updateRevealGestureMenuFn(e){try{g.PAssert(2558,g.revealingMenu===!0,"Must have already started a gesture to perform an update")}catch(PERR){g.reportError(PERR)}var xOffset=e.diffX;if(this.startedInMultiSelectMode){xOffset-=this.rightMenuWidth;var offset=g.clamp(xOffset,-this.rightMenuWidth,0);g.setTransformStyle(this.rightMenuPhone,offset,0)}else{var offset=g.clamp(xOffset,-this.rightMenuWidth,0);g.setTransformStyle(this.rightMenuPhone,offset,0),g.isKeyboardOpen||g.vmMain.setSelected([g.menuOnItem])}},stopRevealGestureMenu:function stopRevealGestureMenuFn(e){try{g.PAssert(2559,g.revealingMenu===!0,"Must have already started a gesture")}catch(PERR){g.reportError(PERR)}var xOffset=e.diffX;if(g.revealingMenu=!1,this.startedInMultiSelectMode){xOffset-=this.rightMenuWidth;var offset=g.clamp(xOffset,-this.rightMenuWidth,0);offset<=.6*-this.rightMenuWidth?g.setTransform(this.rightMenuPhone,-this.rightMenuWidth,0,200,"ease-out"):(this.closeMultiSelect(),g.vmMain.clearSelected())}else xOffset<=.6*-this.rightMenuWidth?(g.setTransform(this.rightMenuPhone,-this.rightMenuWidth,0,200,"ease-out"),g.phoneMenu.multiSelectMode(!0),g.blurActiveElement(!0),g.vmMain.setSelected([g.menuOnItem])):(g.setTransform(this.rightMenuPhone,0,0,200,"ease-out"),g.isKeyboardOpen||g.vmMain.clearSelected())},closeMultiSelect:function closeMultiSelectFn(){g.setTransform(this.rightMenuPhone,0,0,200,"ease-out"),g.phoneMenu.multiSelectMode(!1),g.vmMain.clearSelected()},onResize:function onResizeFn(){},onTapMenuPhone:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){if(0!==g.vmMain.selected().length){var id=e.srcElement.id,fn,val;switch(id){case"phoneMenuComplete":fn="isComplete",val=!g.vmMain.getFirstSelectedItem().isComplete();break;case"phoneMenuStar":fn="isStarred",val=!g.vmMain.getFirstSelectedItem().isStarred();break;case"phoneMenuPriorityNone":fn="priority",val=VMLIFlag.None;break;case"phoneMenuPriorityHigh":fn="priority",val=g.vmMain.getFirstSelectedItem().priority()===VMLIFlag.P0?VMLIFlag.None:VMLIFlag.P0;break;case"phoneMenuPriorityMed":fn="priority",val=g.vmMain.getFirstSelectedItem().priority()===VMLIFlag.P1?VMLIFlag.None:VMLIFlag.P1;break;case"phoneMenuPriorityLow":fn="priority",val=g.vmMain.getFirstSelectedItem().priority()===VMLIFlag.P2?VMLIFlag.None:VMLIFlag.P2;break;case"phoneMenuZoom":g.vmMain.zoomin(g.vmMain.getFirstSelectedItem()),this.closeMultiSelect();break;case"phoneMenuDelete":fn="deleteSelf"}if(fn)for(var i=0;i<g.vmMain.selected().length;i++)g.vmMain.selected()[i][fn](val);"phoneMenuDelete"===id&&g.vmMain.clearSelected()}}},onTapComplete:{onClick:function onClickFn(){g.menuOnItem.isComplete(!g.menuOnItem.isComplete())}},onTapPriority:{onClick:function onClickFn(){var prevPri=g.menuOnItem.priority(),newPri=prevPri!==VMLIFlag.None?VMLIFlag.None:VMLIFlag.P0;g.menuOnItem.priority(newPri)}},onTapCollapse:{onClick:function onClickFn(){g.menuOnItem.toggleCollapsed()}},onTapDelete:{onClick:function onClickFn(){tracker.beginAction(),g.menuOnItem.deleteSelf(),tracker.endAction()}},toggleDocumentsMenu:function toggleDocumentsMenuFn(){this.isDocumentsOpen?this.closeDocumentsMenu():this.openDocumentsMenu()},openDocumentsMenu:function openDocumentsMenuFn(){var menu=g.element("contextMenuDocuments");g.addClass(menu,"open"),this.isDocumentsOpen=!0,g.vmMain.vmPicker.refreshFiles(),g.vmMain.handleFullscreenClick()},closeDocumentsMenu:function closeDocumentsMenuFn(){var menu=g.element("contextMenuDocuments");g.removeClass(menu,"open"),this.isDocumentsOpen=!1,g.vmMain.cancelFullscreenClick()},toggleOptionsMenu:function toggleOptionsMenuFn(){this.isOptionsMenuOpen?this.closeOptionsMenu():this.openOptionsMenu()},openOptionsMenu:function openOptionsMenuFn(){var menu=g.element("contextMenuOptions");g.addClass(menu,"open"),this.isOptionsMenuOpen=!0,g.vmMain.handleFullscreenClick()},closeOptionsMenu:function closeOptionsMenuFn(){var menu=g.element("contextMenuOptions");g.removeClass(menu,"open"),this.isOptionsMenuOpen=!1,g.vmMain.cancelFullscreenClick()},toggleAddPaneMenu:function toggleAddPaneMenuFn(){this.isAddPaneOpen?this.closeAddPaneMenu():this.openAddPaneMenu()},openAddPaneMenu:function openAddPaneMenuFn(){var menu=g.element("contextMenuAddPane");g.addClass(menu,"open"),this.isAddPaneOpen=!0,g.vmMain.handleFullscreenClick()},closeAddPaneMenu:function closeAddPaneMenuFn(){var menu=g.element("contextMenuAddPane");g.removeClass(menu,"open"),this.isAddPaneOpen=!1,g.vmMain.cancelFullscreenClick()},openContextMenu:function openContextMenuFn(offset,toLeft){var menu=g.element("contextMenuItem");g.autocomplete&&g.autocomplete.hide();var styles={top:offset.top},menuWidth=g.width(menu);toLeft||offset.left+menuWidth>platform.windowWidth()&&(toLeft=!0),styles.left=toLeft?offset.left-menuWidth-2:offset.left+2;var menuHeight=g.height(menu);offset.top+menuHeight>platform.windowHeight()&&(styles.top-=menuHeight),g.css(menu,styles),g.addClass(menu,"open");var windowBounds=document.documentElement.getBoundingClientRect(),rect=menu.getBoundingClientRect(),autoRect={left:rect.left,right:rect.right,top:rect.top,bottom:rect.bottom},origin=g.adjustOriginToBeInsideBounds(windowBounds,autoRect);(origin.x!==autoRect.left||origin.y!==autoRect.top)&&(menu.style.left=origin.x+"px",menu.style.top=origin.y+"px"),g.vmMain.handleFullscreenClick()},closeContextMenu:function closeContextMenuFn(){g.removeClass(g.element("contextMenuItem"),"open"),g.vmMain.cancelFullscreenClick()},getModalForId:function getModalForIdFn(id){return this._registeredModals[id]},isModalBound:function isModalBoundFn(id){var element=document.getElementById(id);return ko.dataFor(element.firstElementChild)!==this},isModalOpen:function isModalOpenFn(id){return this._openModals.indexOf(id)>=0},getTopModal:function getTopModalFn(){return this._openModals[this._openModals.length-1]},removeTopModal:function removeTopModalFn(){return this._openModals.pop()},addTopModal:function addTopModalFn(id){this._openModals.push(id)},isTopModal:function isTopModalFn(id){return this.getTopModal()===id},registerModal:function registerModalFn(id,modalObj){try{g.PAssert(2560,id,"Must have a valid modal id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2561,modalObj,"Must have a valid modal object to bind to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2562,!this._registeredModals[id],"Should only register a modal a single time")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2563,modalObj instanceof ModalBase,"Can only register valid modals")}catch(PERR){g.reportError(PERR)}this._registeredModals[id]=modalObj},openModal:function openModalFn(id){try{g.PAssert(2564,this._registeredModals[id],"Must have registered the modal before opening it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2565,!this.isModalOpen(id),"Must not have the same modal open multiple times")}catch(PERR){g.reportError(PERR)}if(!this.isModalOpen(id)){var activeModal=this.getModalForId(id);activeModal.openModal.apply(activeModal,Array.prototype.slice.call(arguments,1)),this.isModalBound(id)||g.applyBindings(activeModal,id),this.addTopModal(id),this.isModalVisible(!0)}},closeModal:function closeModalFn(id){try{g.PAssert(2566,this._registeredModals[id],"Must have registered the modal before closing it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2567,this.isModalOpen(id),"Modal must be open to be closed")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2568,this.isTopModal(id),"Tried to close the wrong modal: "+id+", "+this.getTopModal())}catch(PERR){g.reportError(PERR)}arguments.length>1?this._closeModalInternal.apply(this,Array.prototype.slice.call(arguments,1)):this._closeModalInternal()},_closeModalInternal:function _closeModalInternalFn(){try{g.PAssert(2569,this._openModals.length>0,"Tried to close when no modal was open")}catch(PERR){g.reportError(PERR)}var currentModal=this.getModalForId(this.removeTopModal());this.modalInputOn=void 0,0===this._openModals.length&&setTimeout(function(){this.isModalVisible(!1)}.bind(this),200),g.fireCustomEvent("closeKeyboard"),currentModal.closeModal.apply(currentModal,arguments)},focusModalInputMobile:function focusModalInputMobileFn(e,element){try{g.PAssert(2570,platform.mobile,"Should not call this from non-mobile")}catch(PERR){g.reportError(PERR)}var currentModal=this.getModalForId(this.getTopModal());this.modalInputOn?this.modalInputOn!==element?(element.focus(),currentModal.onKeyboardOpened&&requestAnimationFrame(function(){currentModal.onKeyboardOpened(e)}.bind(this)),e.preventDefault(),e.stopPropagation(),g.enforceScroll()):g.enforceScroll():g.openKeyboardOn(e,element,!0,!0,function(){platform.app?(currentModal&&currentModal.onKeyboardOpened&&currentModal.onKeyboardOpened(e),requestAnimationFrame(function(){requestAnimationFrame(function(){element.focus(),g.enforceScroll()})})):element.focus()}.bind(this))},onTapModal:{onClick:function onClickFn(e){var prevent=!0;if("modals"===e.srcElement.id){var topModal=this.getTopModal();topModal&&this.closeModal(topModal),this.modalInputOn=void 0}else e.srcElement===this.modalInputOn?prevent=!1:g.isKeyboardInputElement(e.srcElement)||g.hasClass(e.srcElement,"input")?(platform.mobile&&(prevent=!1,this.focusModalInputMobile(e,e.srcElement)),this.modalInputOn=e.srcElement):this.modalInputOn=void 0;prevent&&platform.mobile&&(e.preventDefault(),e.stopPropagation())}},onCloseKeyboard:function onCloseKeyboardFn(){this.modalInputOn=void 0},openItemMenu:function openItemMenuFn(item,e){this.openContextMenu({left:e.pageX,top:e.pageY},!1),this.contextMenuOpenedOn(g.getPaneForElement(e.srcElement));var firstItem,foundZoomCandidate=!1;g.vmMain.applyToSelection(function(item,index,total){try{g.PAssert(2571,item,"Item must be defined")}catch(PERR){g.reportError(PERR)}return item&&0===index&&(firstItem=item,this.itemIsHeader(item.isHeader()),this.itemHasChildren(item.isHeader()||item.hasChildren()),this.itemIsCollapsed(item.isCollapsed()),this.itemIsArchived(item.isArchived()),this.itemIsComplete(item.isComplete()),this.itemCanIndent(!item.isNote()&&0!==item.getIndex()),this.itemCanUnindent(!item.isNote()&&item.parent()!==g.focusedItem),this.itemCanAddNote(!item.isNote()),this.itemCanArchive(!item.isNote())),foundZoomCandidate||item.canZoom()&&(foundZoomCandidate=!0,this.itemCanZoom(!0)),foundZoomCandidate||index!==total-1||this.itemCanZoom(!1),!foundZoomCandidate}.bind(this),{passExtraInfo:!0})},closeItemMenu:function closeItemMenuFn(){this.closeContextMenu(g.element("contextMenuItem")),this.contextMenuOpenedOn(void 0)},itemContextText:function itemContextTextFn(){return this.itemIsCollapsed()?"Expand":"Collapse"},itemArchivedText:function itemArchivedTextFn(){return this.itemIsArchived()?"Unarchive":"Archive"},itemCompleteText:function itemCompleteTextFn(){return this.itemIsComplete()?"Uncomplete":"Complete"},hotkeyText:function hotkeyTextFn(key){return platform.secModKey+" + "+key},onTapItemMenu:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var id=e.srcElement.id;switch(id||(id=e.srcElement.parentNode.id),id){case"itemComplete":g.vmMain.applyFnToSelection("isComplete",!0);break;case"itemStar":g.vmMain.applyFnToSelection("isStarred",!0);break;case"itemIndent":g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1});break;case"itemUnindent":g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0});break;case"contextMenuPriority":break;case"itemPriorityNone":g.vmMain.applyPriorityToSelection(VMLIFlag.None);break;case"itemPriorityLow":g.vmMain.applyPriorityToSelection(VMLIFlag.P2);break;case"itemPriorityMed":g.vmMain.applyPriorityToSelection(VMLIFlag.P1);break;case"itemPriorityHigh":g.vmMain.applyPriorityToSelection(VMLIFlag.P0);break;case"itemAddNote":g.fireKeyEvent(void 0,{normCode:KeyCode.Enter,shiftKey:!0});break;case"itemCollapse":g.vmMain.applyToSelection(function(item){item.toggleCollapsed()});break;case"itemZoom":g.vmMain.applyToSelection(function(item){return item.canZoom()?(g.vmMain.zoomin(item),!1):!0});break;case"itemCopy":break;case"itemPaste":break;case"itemUndo":break;case"itemRedo":break;case"itemArchive":var numChanged=0,selectItem,numChecked=g.vmMain.applyToSelection(function(item){selectItem||(selectItem=g.getPreviousItem(item,g.focusedPane)),this.itemIsArchived()?item.parent().unarchiveChild(item)&&numChanged++:item.parent().archiveChild(item)&&numChanged++}.bind(this));if(numChanged>0){var z=numChanged>1?" items.":" item.",verb=this.itemIsArchived()?"Unarchived":"Archived";g.messageQueue.pushMessage({text:verb+" "+numChanged+z,action:MessageAction.Undo,hold:platform.mobile,timeout:platform.mobile?void 0:8e3}),selectItem&&g.selectChildren(selectItem,selectItem.getParsedText().length,0)}break;case"itemDelete":var selectItem;g.vmMain.applyToSelection(function(item){selectItem||(selectItem=g.getPreviousItem(item,g.focusedPane)),item.deleteSelf()}),selectItem&&g.selectChildren(selectItem,selectItem.getParsedText().length,0);break;case"contextMenuItem":break;case"fullscreenClickGrabber":break;default:try{g.PAssert(2572,!1,"Unknown context menu item: ",g.elementToString(e.srcElement))}catch(PERR){g.reportError(PERR)}}g.sendEvent("ContextMenu",id),this.closeItemMenu()}},onTapAddPaneMenu:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var paneInfo=ko.dataFor(e.srcElement);if(paneInfo)if(paneInfo===this)this.openModal(Modals.Settings,"plugins");else{var newPane=g.vmMain.paneManager.createPaneAtIndex(paneInfo.type);newPane&&(tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.AddPane,data:newPane.id}),g.sendEvent("Menu","AddPane_"+paneInfo.type))}this.closeAddPaneMenu()}},onTapOptionsMenu:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var id=e.srcElement.id;id||(id=e.srcElement.parentNode.id),g.sendEvent("Menu",id);var mode;if(g.sendEvent("Menu",id),"optionsSettings"==id)g.menus.openModal("settings");else if("optionsHelp"==id)g.vmMain.showHelp(HelpMode.Normal);else if("optionsImport"==id)g.menus.openModal("importData"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenImport,data:[{value:!0}]});else if("optionsExport"==id)g.menus.openModal("exportData"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenExport,data:[{value:!0}]});else if("optionsSendFeedback"==id)g.menus.openModal("reportBug");else if("optionsBlog"==id)g.openUrl("/blog/");else if("optionsLogout"==id)g.vmSetup.logoutClicked();else try{g.PAssert(2573,!1,"Trying to add pane type that doesn't exist",id)}catch(PERR){g.reportError(PERR)}this.closeOptionsMenu()}},confirm:function confirmFn(text,cb){this.modalConfirm.openDialog(text,cb)},alert:function alertFn(params){this.modalAlert.openDialog(params)},onTapAlertButton:function onTapAlertButtonFn(e){this.modalAlert.onTapAlertClose()},getUserEmail:function getUserEmailFn(){return g.getUserIdentifier()},getUserName:function getUserNameFn(){var user=gdata.authenticatedUser();return user?user.displayName:g.vmMain.gdriveStatus()===DriveStatus.Saved?"Connected":g.vmSetup.loginState()==LoginState.LOGGED_IN?"Connecting":"Demo"},addPaneMoreText:function addPaneMoreTextFn(){return g.billingManager.isPremiumEnabled()&&PaneFactory.numInactivePanes()>0?"Enable more panes":void 0}},VMMenus}),define("VMDocSharing",["ko","globals","util","platform","data","goog","ModalBase"],function(ko,g,util,platform,d,goog,ModalBase){function VMDocSharing(){this._super.constructor.call(this,Modals.ShareDoc),this.doc=ko.observable({isOwned:function(){return!1}}),this.isLoading=ko.observable(!1),this.isCreating=ko.observable(!1),this.permissions=ko.observableArray(),this.permissionsNew=ko.observableArray(),this.permissionsRemove=[],this.newEmail=ko.observable(""),this.errorGlobal=ko.observable(!1),this.errorName=ko.observable(!1),this.errorInvite=ko.observable(!1),this.isSaving=ko.observable(!1),this.editing=ko.observable(!1),this.closeCallback=void 0,this.justCreated=!1,this.matchedContacts=ko.observableArray(),this.selectedContactIndex=ko.observable(0),this.newEmail.subscribe(this.onInviteEmailUpdate.bind(this)),this.init()}var VMDocSharingFns={init:function initFn(){this.registerModal(this.open.bind(this),this.onClose.bind(this))},open:function openFn(doc,callback){this.doc(doc),this.closeCallback=callback,this.isLoading(!0),this.isCreating(!this.doc().file),this.permissions.removeAll(),this.permissionsNew.removeAll(),this.permissionsRemove=[],this.newEmail(""),this.errorGlobal(!1),this.errorName(!1),this.errorInvite(!1),this.isSaving(!1),this.editing(!1),this.justCreated=!1,this.inputName=document.getElementById("shareNameInput"),this.inputName.value=this.doc().title(),this.shareLink=document.getElementById("shareLinkInput"),this.shareLink&&(this.shareLink.value="http://moo.do/app/#file="+this.doc().id),platform.mobile||setTimeout(function(){this.inputName.focus()}.bind(this),0),this.isCreating()?this.isLoading(!1):goog.listPermissions(this.doc().id,this.permissionHandler.bind(this))},addPadding:function addPaddingFn(){var padSize=platform.windowHeight()-platform.getKBSize()+g.topBarHeight;platform.android&&(padSize=platform.getKBSize()+20),g.element("shareScroller").style.paddingBottom=padSize+"px"},removePadding:function removePaddingFn(){document.getElementById("shareScroller").style.paddingBottom=""},permissionHandler:function permissionHandlerFn(response){if(!response.error){this.isLoading(!1);for(var permissions=[],i=0;i<response.items.length;++i){var item=response.items[i];item.emailAddress!==g.getUserIdentifier()&&(item.onRemove=this.onRemove.bind(this,item),"anyone"!==item.id&&(item.emailAddress||(item.emailAddress="owner"===item.role?"Owner":""),"owner"===item.role?permissions.splice(0,0,item):permissions.push(item)),item.emailDisplay="("+item.emailAddress+")")}this.permissions(permissions)}},isOwned:function isOwnedFn(){return this.doc().isOwned&&this.doc().isOwned()},saveText:function saveTextFn(){if(this.isCreating())return this.isSaving()?"CREATING...":"CREATE";if(platform.mobile&&this.editing()){switch(this.editing()){case"Name":return"SAVE";case"Invite User":return"INVITE"}return""}return this.newEmail().length>0?"INVITE":this.isSaving()?"SAVING...":"SAVE"},titleText:function titleTextFn(){return platform.mobile&&this.editing()?this.editing():this.isCreating()?"Create Document":"Edit Document"},onKeyboardOpened:function onKeyboardOpenedFn(e){this.editing(e.srcElement.title)},inviteUser:function inviteUserFn(){if(0===this.newEmail().length)return void this.errorInvite("");if(!g.isEmail(this.newEmail()))return this.errorInvite("Please enter a valid email address."),!1;var user={emailAddress:this.newEmail(),error:ko.observable(!1)},contact=d.contactManager.findContactByEmail(user.emailAddress.toLowerCase());return user.name=contact?contact.text:user.emailAddress,user.onRemove=this.onRemoveNew.bind(this,user),this.permissionsNew.push(user),this.newEmail(""),this.errorInvite(!1),!0},checkName:function checkNameFn(){var title=this.inputName.value.trim();return title.length>0&&title.length<255?(this.errorName(!1),!0):(this.errorName("Error: Document name must be >0 and <255 characters."),!1)},rename:function renameFn(){var title=this.inputName.value.trim();title!==this.doc().title()&&(this.doc().title(title),gapi.client.drive.files.patch({fileId:this.doc().id,resource:{title:title}}).execute(function(response){response.error?this.errorName("Error: Unable to update name on remote server."):log("File renamed to",title)}.bind(this)))},create:function createFn(callback){this.justCreated=!0,this.isSaving(!0);var title=this.inputName.value.trim();this.tooltip=title,this.isSaving(!0),goog.createAndSetupDocument(!1,function(response){response.error?this.errorGlobal("Error: Unable to create new document."):(this.doc().id=response.id,this.doc().file=response,this.isCreating(!this.doc().file),this.isSaving(!1),callback&&callback())}.bind(this))},save:function saveFn(){function handleResponse(index,response){response.error?(this.permissionsNew()[index].error(!0),this.errorInvite("Some people could not be invited."),this.isSaving(!1)):(count--,0>=count&&g.menus.closeModal(Modals.ShareDoc,!1))}if(!this.isSaving()||this.justCreated){if(!goog.isDriveAPILoaded())return this.errorGlobal("Error communicating with Google Drive. Please reconnect and try again."),void g.blurActiveElement();if(this.checkName()){if(this.isCreating())return void this.create(this.save.bind(this));if(this.newEmail().length>0){if(!this.inviteUser())return}else this.errorInvite(!1);this.rename();for(var count=0,i=0;i<this.permissionsNew().length;i++){var newPermission=this.permissionsNew()[i];newPermission.error()||(count++,goog.givePermission(this.doc().id,newPermission.emailAddress,!0,handleResponse.bind(this,i)))}for(var i=0;i<this.permissionsRemove.length;i++){var permission=this.permissionsRemove[i];goog.removePermission(this.doc().id,permission.id,function(response){})}this.errorInvite()||this.errorName()||(0===count?g.menus.closeModal(Modals.ShareDoc,!0):(this.isSaving(!0),this.onClose(!0)))}}},onClose:function onCloseFn(isSave){this.closeCallback&&(this.closeCallback(isSave),this.closeCallback=void 0),g.blurActiveElement()},onTapInviteMessage:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var el=g.element("inputShareInvite");platform.mobile?g.menus.focusModalInputMobile(e,el):el.focus()}},onTapSave:{onStart:g.handlerPreventStop,onClick:function onClickFn(){this.editing()?(g.blurActiveElement(),this.inviteUser(),this.editing("")):(this.save(),g.sendEvent("Menu","SharingSave"))}},onTapCancel:{onStart:g.handlerPreventStop,onClick:function onClickFn(){this.editing()?(g.blurActiveElement(),this.editing("")):(g.blurActiveElement(),g.menus.closeModal(Modals.ShareDoc,!1),g.sendEvent("Menu","SharingCancel"))}},onTapDelete:{onClick:function onClickFn(){g.sendEvent("Menu","SharingDelete"),g.menus.confirm("Are you sure you want to delete the file?",function(result){result&&(gapi.client.drive.files.trash({fileId:this.doc().id}).execute(function(response){log("Document Delete Response: ",response),response.error&&g.messageQueue.pushMessage({text:"Unable to delete document on the remote server."})}.bind(this)),g.vmMain.vmPicker.removeFile(this.doc()),g.menus.closeModal(Modals.ShareDoc,!1))}.bind(this))}},onRemove:function onRemoveFn(user){this.permissionsRemove.push(user),this.permissions.remove(user),g.sendEvent("Menu","SharingRemoveUser")},onRemoveNew:function onRemoveNewFn(user){this.permissionsNew.remove(user)},onkeydown:function onkeydownFn(data,e){if(platform.normalizeKeys(e),e.normCode===KeyCode.Escape)return this.newEmail(""),e.preventDefault(),e.stopImmediatePropagation(),!1;if(e.normCode===KeyCode.Enter){var newEmailTextEle=document.getElementById("shareContactsItems").children[this.selectedContactIndex()];return newEmailTextEle&&this.newEmail(newEmailTextEle.textContent),this.inviteUser(),g.scrollIntoView(g.element("inputShareInvite"),0),e.preventDefault(),e.stopImmediatePropagation(),!1}if(e.normCode===KeyCode.UpArrow){var newIndex=this.selectedContactIndex()-1;0>newIndex&&(newIndex=this.matchedContacts().length-1),this.selectedContactIndex(newIndex),e.preventDefault(),e.stopImmediatePropagation();var shareContactsEle=document.getElementById("shareContactsItems");return g.scrollIntoView(shareContactsEle.children[newIndex],200),!1}if(e.normCode===KeyCode.DownArrow){var newIndex=this.selectedContactIndex()+1;newIndex>=this.matchedContacts().length&&(newIndex=0),this.selectedContactIndex(newIndex),e.preventDefault(),e.stopImmediatePropagation();var shareContactsEle=document.getElementById("shareContactsItems");return g.scrollIntoView(shareContactsEle.children[newIndex],200),!1}return!0},onInviteEmailUpdate:function onInviteEmailUpdateFn(newEmail){if(newEmail){var contacts=d.contactManager.findEmailsLike(newEmail);contacts&&this.matchedContacts(contacts)}else this.matchedContacts([])},showContactList:function showContactListFn(){return this.matchedContacts().length>1},computeSelectionIndex:function computeSelectionIndexFn(e){var index=0,ele=e.srcElement||e.target;for("#text"===ele.tagName&&(ele=ele.parentNode);ele=ele.previousElementSibling;)++index;this.selectedContactIndex(index)},onTapContactList:function onTapContactListFn(e){this.matchedContacts([]);var selectedEmail=(e.srcElement||e.target).innerText;return this.newEmail(selectedEmail),this.selectedContactIndex(0),this.inviteUser(),g.scrollIntoView(g.element("inputShareInvite"),0),e.preventDefault(),e.stopImmediatePropagation(),!1},onMouseoverContactList:function onMouseoverContactListFn(self,e){this.computeSelectionIndex(e)},isContactSelected:function isContactSelectedFn(index){return this.selectedContactIndex()===index()}};return util.inherit(ModalBase,VMDocSharing),util.extend(VMDocSharing.prototype,VMDocSharingFns),VMDocSharing}),define("VMPicker",["ko","globals","util","platform","data","goog","VMDocument","VMDocSharing","tracker"],function(ko,g,util,platform,d,goog,VMDocument,VMDocSharing,tracker){function VMPicker(){this.files=ko.observableArray(),this.permissions=ko.observableArray(),this.isPublic=ko.observable(),this.fileMap={},this.isLoading=ko.observable(!1),this.needPermission=ko.observable(!1),this.showError=ko.observable(!1),this.documentButtonsCollapsed=ko.observable(!1),this.scroller=void 0,this.listHeight=void 0,this.scrollDebounced=!1,this.filePageRequests=0,this.loadCallbacks=[],this.init()}var MAX_FILE_PAGE_REQUESTS=5,mime=goog.REALTIME_MIMETYPE+"."+goog.APP_ID;return VMPicker.prototype={init:function initFn(){new VMDocSharing},hasFiles:function hasFilesFn(){return this.files().length>0},showLoading:function showLoadingFn(){return 0===this.files().length&&!this.showError()},onLoad:function onLoadFn(e){if(platform.mobile){var mobileDocuments=document.getElementById("mobileDocuments");this.scroller=mobileDocuments.parentElement}},refreshFiles:function refreshFilesFn(){this.runOnFileLoad(this.markFileProperties.bind(this)),this.loadFileList()},clearFiles:function clearFilesFn(){this.files.removeAll()},setFiles:function setFilesFn(files,selectedId){this.clearFiles(),this.addFiles(files,selectedId)},addFiles:function addFilesFn(files,selectedId){for(var i=0;i<files.length;i++){var file=files[i];try{g.PAssert(2574,file.mimeType===mime,"All files returned from drive should match our mimeType: ",file.mimeType)}catch(PERR){g.reportError(PERR)}if(!file.appDataContents){var vmDoc=this.fileMap[file.id];vmDoc?vmDoc.update(file):(vmDoc=new VMDocument(file),vmDoc.isOpen=file.id===selectedId,this.files.push(vmDoc),this.fileMap[file.id]=vmDoc)}}this.setMinHeight()},runLoad:function runLoadFn(pageToken){window.gapi&&window.gapi.client&&window.gapi.client.drive?gapi.client.drive.files.list({fields:"items(createdDate,id,labels,mimeType,owners,parents,permissions,properties,shared,appDataContents,sharedWithMeDate,sharingUser,title,userPermission),nextPageToken",maxResults:999,pageToken:pageToken,q:"trashed=false and mimeType contains '"+mime+"'"}).execute(function(results){results.error||!results.items&&0===this.files().length&&!results.nextPageToken?this.showError("Load Documents"):results.items&&this.addFiles(results.items,goog.getDocId()),this.filePageRequests++,results.error||!results.nextPageToken||this.filePageRequests>=MAX_FILE_PAGE_REQUESTS?(this.isLoading(!1),this.onFilesLoaded(results)):this.runLoad(results.nextPageToken)}.bind(this)):(this.showError("Load Documents"),g.reportError(new Error("GAPI Drive was incorrectly loaded")))},loadFileList:function loadFileListFn(){this.isLoading()||(this.isLoading(!0),this.showError(!1),this.filePageRequests=0,window.gapi&&window.gapi.client.drive?this.runLoad():window.gapi&&gapi.client.load("drive","v2",this.runLoad.bind(this)))},markFileProperties:function markFilePropertiesFn(res){if(res&&res.items)for(var i=0;i<res.items.length;++i){var fileInfo=res.items[i];if(!fileInfo.properties&&fileInfo.title===goog.LEGACY_DefaultDriveDocTitle&&"me"===fileInfo.userPermission.id&&"owner"===fileInfo.userPermission.role){gapi.client.drive.properties.insert({fileId:fileInfo.id,resource:{key:goog.DefaultProperty,value:goog.DefaultPropertyValue,visibility:"PRIVATE"}}).execute(function(result){(result.error||"drive#property"!==result.kind)&&ShouldLog(LogLevels.Error)&&log("Error adding default file property: ",result)});break}}},onFilesLoaded:function onFilesLoadedFn(res){if(this.loadCallbacks.length>0){for(var i=0;i<this.loadCallbacks.length;++i)this.loadCallbacks[i]&&this.loadCallbacks[i](res);this.loadCallbacks=[]}},runOnFileLoad:function runOnFileLoadFn(cb){this.loadCallbacks.push(cb)},requestOpenDocument:function requestOpenDocumentFn(id){var doc=this.getFile(id);doc?this.openDocument(doc):this.needPermission()?this.doRequestPermission(function(){this.openDocumentFromId(id)}.bind(this)):this.openDocumentFromId(id)},openDocumentFromId:function openDocumentFromIdFn(id,title){var currentDoc=goog.getDocId();if(currentDoc!==id){var skipSettings=[Settings.authScopes,Settings.activeUser,Settings.shownTutorial,Settings.helpPaneState,Settings.oauthScheme];d.clearData(function(){goog.setDocInfo(id,title),util.hasURLParam("file")?util.removeURLParam("file",!0):util.hasURLParam("state")&&util.removeURLParam("state",!0),setTimeout(function(){g.reload()},500)},skipSettings)}},openDocument:function openDocumentFn(doc){g.localDocChangeRequested=!0,this.openDocumentFromId(doc.id,doc.title)},doRequestPermission:function doRequestPermissionFn(cb){},onRequestPermission:function onRequestPermissionFn(e){this.doRequestPermission()},onTapReloadDocuments:function onTapReloadDocumentsFn(e){this.loadFileList()},onTapDocument:{onClick:function onClickFn(e){var doc=ko.dataFor(e.srcElement);g.hasClass(e.srcElement,"documentTitle")?(this.openDocument(doc),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocument,data:[{value:!0}]})):doc instanceof VMDocument?(doc.onTapMenu(),e.stopImmediatePropagation()):"documentsList"!==e.srcElement.id&&g.reportError("Incorrect document type: "+g.elementToString(e.srcElement)),e.preventDefault(),e.stopImmediatePropagation()}},onTapAdd:{onStart:g.handlerStopProp,onClick:function onClickFn(){if(g.vmMain&&g.vmMain.isOnline()){var doc=new VMDocument;doc.isOwned(!0),this.files.push(doc),this.setMinHeight(),g.sendEvent("Menu","AddDocument"),doc.openSharing(function(saved){saved||(this.files.remove(doc),this.setMinHeight())}.bind(this)),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddDocument,data:[{value:!0}]})}else g.messageQueue.pushMessage({text:"You must be online to create a new document."})}},onTapRefresh:{onStart:g.handlerStopProp,onClick:function onClickFn(){g.vmMain&&g.vmMain.isOnline()&&!this.isLoading()&&this.refreshFiles()
}},getFile:function getFileFn(id){return this.fileMap[id]},removeFile:function removeFileFn(doc){this.files.remove(doc),this.setMinHeight(),doc.isOpen&&d.clearData(function(){setTimeout(function(){g.reload()},0)})},setMinHeight:function setMinHeightFn(){if(platform.mobile){var documentsList=document.getElementById("documentsList");if(!documentsList)return void setTimeout(this.setMinHeight.bind(this),0);if(this.listHeight=documentsList.clientHeight,!this.hasSetHeightOnce){this.hasSetHeightOnce=!0;var top=g.element("headerOutline").getBoundingClientRect().top;this.scroller.scrollTop=top-75}}}},VMPicker}),define("VMSettings",["ko","data","globals","util","goog","platform","tracker","VMPicker","ModalBase"],function(ko,d,g,util,goog,platform,tracker,VMPicker,ModalBase){function VMSettings(){this._super.constructor.call(this,platform.mobile?Modals.MobileSettings:Modals.Settings),this.enabledSyncContacts=ko.observable(!1),this.enabledSounds=ko.observable(!1),this.enabledNotifications=ko.observable(!1),this.enabledMobileUI=ko.observable(!1),this.enabledPluginDrive=ko.observable(!1),this.enabledPluginGmail=ko.observable(!1),this.syncContactsEnabledOnOpen=ko.observable(!1),this.refreshingContacts=!1,this.refreshContactsSuccess=ko.observable(void 0),this.init()}var VMSettingsFns={init:function initFn(){if(platform.mobile&&this.registerModal(this.open.bind(this),this.close.bind(this)),this.loadSettings(),platform.mobile){var saveFn=this.save.bind(this);this.enabledSyncContacts.subscribe(saveFn),this.enabledSounds.subscribe(saveFn),this.enabledNotifications.subscribe(saveFn),this.enabledMobileUI.subscribe(saveFn)}if(platform.isTouchDevice&&!platform.app){var paneSettings=document.getElementById("paneSettings");paneSettings&&paneSettings.addEventListener(platform.touchStartEvent,function(e){return g.preventScrollPropagation(paneSettings)||"paneSettings"!==e.srcElement.id?void 0:(e.preventDefault(),!1)})}g.settings.registerForChangeNotification(Settings.syncContacts,this.onSyncContactsChange.bind(this))},isLocal:function isLocalFn(){return"localhost"===window.location.hostname||!1},showMobileAppReview:function showMobileAppReviewFn(){return!!platform.appReviewLink},showMobileUIOptionOnDesktop:function showMobileUIOptionOnDesktopFn(){return!1},showMobileUIOptionOnMobile:function showMobileUIOptionOnMobileFn(){return parseInt(window.innerWidth)>767},onEnableNotificationsChange:function onEnableNotificationsChangeFn(){this.enabledNotifications()?g.timeline.updateNotifications():g.timeline.clearNotifications()},onSyncContactsChange:function onSyncContactsChangeFn(oldValue,newValue){this.enabledSyncContacts(newValue)},getTopElement:function getTopElementFn(){return document.getElementById("paneSettings")},open:function openFn(){this.isClosing||(this.refreshContactsSuccess(void 0),this.loadSettings(),this.syncContactsEnabledOnOpen(this.enabledSyncContacts()))},close:function closeFn(save){if(save)this.save();else{var checkSyncContacts=!!g.settings.get(Settings.syncContacts),checkPluginDrive=g.vmMain.pluginManager.isAuthorized(PluginID.Drive),checkPluginGmail=g.vmMain.pluginManager.isAuthorized(PluginID.Gmail);this.enabledSyncContacts(checkSyncContacts),this.enabledSounds(!g.settings.get(Settings.noSounds)),this.enabledPluginDrive(checkPluginDrive),this.enabledPluginGmail(checkPluginGmail)}},onScreenStartOpen:function onScreenStartOpenFn(){this.loadSettings()},enableSyncContacts:function enableSyncContactsFn(handler){function handleContactsLoaded(numContacts){0>numContacts?(g.messageQueue.pushMessage({text:"There was an error syncing your contacts. Please try again.",actionText:"SYNC",action:function actionFn(){this.enableSyncContacts(handler)}.bind(this)}),handler&&handler(!1)):numContacts>0&&(g.vmMain.parseSubtree(g.vmMain.root(),ChangeType.Auto),handler&&handler(!0))}g.sendEvent("Settings","EnableContacts"),goog.runAuthenticate([GScope.Contacts],!1,!1,function(token){token&&!token.error?(goog.loadContacts(handleContactsLoaded.bind(this)),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SyncContacts,data:[{value:!0}]}),this.enabledSyncContacts(!0),g.settings.set(Settings.syncContacts,!0)):(this.enabledSyncContacts(!1),g.settings.set(Settings.syncContacts,!1),g.messageQueue.pushMessage({text:"To sync your contacts we need permission to access them. Please try again.",actionText:"SYNC",action:function actionFn(){this.enabledSyncContacts(handler)}.bind(this)}),handler&&handler(!1))}.bind(this))},loadSettings:function loadSettingsFn(){this.enabledSyncContacts(!!g.settings.get(Settings.syncContacts)),this.enabledSounds(!g.settings.get(Settings.noSounds)),this.enabledNotifications(!g.settings.get(Settings.disableNotifications)),this.enabledPluginDrive(g.vmMain.pluginManager.isAuthorized(PluginID.Drive)),this.enabledPluginGmail(g.vmMain.pluginManager.isAuthorized(PluginID.Gmail))},save:function saveFn(){var changedContacts=this.enabledSyncContacts()!==!!g.settings.get(Settings.syncContacts),changedSounds=this.enabledSounds()!==!g.settings.get(Settings.noSounds),changedNotifications=this.enabledNotifications()!==!g.settings.get(Settings.disableNotifications),changedPluginDrive=this.enabledPluginDrive()!==g.vmMain.pluginManager.isAuthorized(PluginID.Drive),changedPluginGmail=this.enabledPluginGmail()!==g.vmMain.pluginManager.isAuthorized(PluginID.Gmail);changedContacts&&(g.settings.set(Settings.syncContacts,this.enabledSyncContacts()),this.enabledSyncContacts()?this.enableSyncContacts():(g.sendEvent("Settings","DisableContacts"),goog.loadedContacts=!1,d.clearContacts())),changedSounds&&g.settings.set(Settings.noSounds,!this.enabledSounds()),changedNotifications&&(g.settings.set(Settings.disableNotifications,!this.enabledNotifications()),this.enabledNotifications()?g.timeline.updateNotifications():g.timeline.clearNotifications()),changedPluginDrive&&(this.enabledPluginDrive()?g.vmMain.pluginManager.authorizePlugin(PluginID.Drive,function(success){success||(this.enabledPluginDrive(!1),g.messageQueue.pushMessage({text:"To sync GDrive we need permission to access your file names. Please try again."}))}.bind(this)):g.vmMain.pluginManager.deauthorizePlugin(PluginID.Drive,function(){this.enabledPluginDrive(!1)}.bind(this))),changedPluginGmail&&(this.enabledPluginGmail()?g.vmMain.pluginManager.authorizePlugin(PluginID.Gmail,function(success){success||(this.enabledPluginDrive(!1),g.messageQueue.pushMessage({text:"To sync Gmail we need permission to access your file names. Please try again."}))}.bind(this)):g.vmMain.pluginManager.deauthorizePlugin(PluginID.Gmail,function(){this.enabledPluginDrive(!1)}.bind(this)))},isDemo:function isDemoFn(){return g.isDemoMode()},onTapSave:function onTapSaveFn(){g.menus.closeModal(platform.mobile?"mobileSettings":"settings",!0)},onTapCancel:function onTapCancelFn(){g.menus.closeModal(platform.mobile?"mobileSettings":"settings",!0)},isPremiumEnabled:function isPremiumEnabledFn(){return g.billingManager.isPremiumEnabled()},onTapLogout:function onTapLogoutFn(e){g.vmSetup.logoutClicked(),g.sendEvent("Menu","Logout"),e.preventDefault()},onTapRunPicker:function onTapRunPickerFn(){},onTapFeedback:function onTapFeedbackFn(e){g.menus.openModal(Modals.ReportBug),g.sendEvent("Menu","GiveFeedback"),e.preventDefault()},onTapLeaveDemo:function onTapLeaveDemoFn(){util.removeURLParam("demo")},onTapRestartClient:function onTapRestartClientFn(e){g.reload(),e.preventDefault()},onTapResetClient:function onTapResetClientFn(){d.clearData(function(){g.reload()}),g.sendEvent("Menu","ResetClient")},onForceReloadDoc:function onForceReloadDocFn(){var skipSettings=[Settings.authScopes,Settings.activeUser,Settings.shownTutorial,Settings.gdocId,Settings.gdocTitle,Settings.helpPaneState,Settings.oauthScheme];d.clearData(function(){g.reload()},skipSettings),g.sendEvent("Menu","ReloadDoc")},onTapSettings:function onTapSettingsFn(){g.menus.openModal(Modals.Settings),g.vmMain.cancelFullscreenClick(),g.sendEvent("Menu","Settings")},onlineStatusToggle:function onlineStatusToggleFn(){platform.offline?util.removeURLParam("offline"):util.insertURLParam("offline","true")},logoutButtonText:function logoutButtonTextFn(){return g.vmSetup.logoutButtonText()},isLoggedIn:function isLoggedInFn(){return g.vmSetup.loginState()==LoginState.LOGGED_IN},isOnline:function isOnlineFn(){return g.vmMain.isOnline()},showAppDebugInfo:function showAppDebugInfoFn(){return platform.debugApp},getHostName:function getHostNameFn(){return"Host: "+window.location.host},getLowMemText:function getLowMemTextFn(){return"LowMem: "+(g.hasSentLowMemoryWarning()?"TRUE":"FALSE")},getDebugUserText:function getDebugUserTextFn(){return"Premium: "+g.billingManager.getPremiumStatus()},getDebugPremiumText:function getDebugPremiumTextFn(){return"User: "+g.billingManager.getBillingIdentifier()},onTapRefreshContacts:function onTapRefreshContactsFn(){this.refreshingContacts||(this.refreshingContacts=!0,this.refreshContactsSuccess(void 0),d.clearLocalContacts(),goog.loadedContacts=!1,goog.authAndLoadContacts(function(success){this.refreshContactsSuccess(success),setTimeout(function(){this.refreshingContacts=!1}.bind(this),1e3)}.bind(this)),g.sendEvent("Menu","RefreshContacts"))},contactsRefreshSuccessTest:function contactsRefreshSuccessTestFn(){return void 0===this.refreshContactsSuccess()?"":this.refreshContactsSuccess()===!0?"Success!":this.refreshContactsSuccess()===!1?"Failure!":void 0},onTapRestartIntro:function onTapRestartIntroFn(){g.intro?(g.intro.clearState(),g.intro.init()):g.vmMain.showHelp()},onTapSendToAppReview:function onTapSendToAppReviewFn(){platform.appReviewLink&&g.openUrl(platform.appReviewLink)}};return util.inherit(ModalBase,VMSettings),util.extend(VMSettings.prototype,VMSettingsFns),VMSettings}),define("VMPhoneMenu",["ko","globals","data","platform","tracker"],function(ko,g,d,platform,tracker){function VMPhoneMenu(){try{g.PAssert(2575,platform.mobile,"Should only initialize on mobile platforms")}catch(PERR){g.reportError(PERR)}this.mode=ko.observable(this.Modes.Normal),this.multiSelected=g.vmMain.selected,this.init()}return VMPhoneMenu.prototype={Modes:{Normal:0,Multiselect:1,Contact:2,Date:3},init:function initFn(){g.applyBindings(this,"phoneMenu"),this.mode.subscribe(function(newValue){newValue===this.Modes.Multiselect?(g.addClass(g.focusedPane.element,"multiSelectMode"),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenMultiselect})):(g.removeClass(g.focusedPane.element,"multiSelectMode"),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseMultiselect}))}.bind(this))},_modeHelper:function _modeHelperFn(val,mode){return void 0!==val&&(val&&this.mode(mode),val||mode!==this.mode()||this.mode(this.Modes.Normal)),this.mode()===mode},activeScreenClass:function activeScreenClassFn(){var name="",activeSearch=g.getActiveSearch();return activeSearch&&(activeSearch.isShowing()&&(name+=" searchShowing"),activeSearch.isFocused()&&(name+=" searchFocused")),name},normalMode:function normalModeFn(val){return this._modeHelper(val,this.Modes.Normal)},multiSelectMode:function multiSelectModeFn(val){return this._modeHelper(val,this.Modes.Multiselect)},contactMode:function contactModeFn(val){return this._modeHelper(val,this.Modes.Contact)},dateMode:function dateModeFn(val){return this._modeHelper(val,this.Modes.Date)},tagMode:function tagModeFn(val){return this._modeHelper(val,this.Modes.Tag)},onTapMultiSelectCancel:{onClick:function onClickFn(e){g.menus.closeMultiSelect(),g.handlerPreventStop(e)}},onTapAutocompleteClose:{onClick:function onClickFn(e){g.autocomplete.hide(),g.handlerPreventStop(e)}},onTapArchive:{onClick:function onClickFn(e){g.focusedPane.archiveCompleted(),g.sendEvent("PhoneMenu","ArchiveCompleted"),g.handlerPreventStop(e)}},onTapHeader:{onStart:function onStartFn(e){g.ScreenManager.checkSwipeStart(e)},onMove:function onMoveFn(e){g.ScreenManager.checkSwipeMove(e)},onEnd:function onEndFn(e){g.ScreenManager.checkSwipeEnd(e)}}},VMPhoneMenu}),define("VMKeyboardToolbar",["ko","globals","data","edit","platform","tracker"],function(ko,g,d,edit,platform,tracker){function VMKeyboardToolbar(){this.buttons=ko.observableArray(),this.priorityVisible=ko.observable(),this.isVisible=ko.observable(!1),this.element=void 0,this.aboutToShow=void 0,this.bottomPosition=void 0,this.topBarHidden=!1,this.init()}return VMKeyboardToolbar.prototype={init:function initFn(){this.element=g.element("mobileKeyboardToolbar"),g.applyBindings(this,"mobileKeyboardToolbar"),window.addEventListener("closeKeyboard",this.hide.bind(this))},onTap:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var id=e.srcElement.id;if("mobileKeyboardToolbar"===id&&(e.preventDefault(),e.returnFalse=!0),"closeKeyboardButton"===id)g.blurActiveElement(),g.vmMain.clearSelected();else if(g.getActiveSearch().isFocused()){var ch;"priorityButton"===id?ch="!":"dateButton"===id?ch=DatePrefix:"contactButton"===id?ch=ContactPrefix:"tagButton"===id&&(ch=TagPrefix),ch&&g.getActiveSearch().insert(ch)}else"outdentButton"===id?g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0}):"indentButton"===id?g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1}):"priorityButton"===id?this.priorityVisible(!this.priorityVisible()):"pNoneButton"===id?g.vmMain.applyPriorityToSelection(VMLIFlag.None,!1):"p0Button"===id?g.vmMain.applyPriorityToSelection(VMLIFlag.P0,!0):"p1Button"===id?g.vmMain.applyPriorityToSelection(VMLIFlag.P1,!0):"p2Button"===id?g.vmMain.applyPriorityToSelection(VMLIFlag.P2,!0):"pStarButton"===id?g.vmMain.applyFnToSelection("isStarred",!0):"dateButton"===id?(g.vmMain.insertCharacter(DatePrefix,!0),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.AtButton})):"contactButton"===id?g.vmMain.insertCharacter(ContactPrefix,!0):"tagButton"===id&&g.vmMain.insertCharacter(TagPrefix,!0);g.handlerPreventStop(e)}},preShow:function preShowFn(){this.aboutToShow=!0,this.priorityVisible(!1),setTimeout(function(){this.aboutToShow=!1}.bind(this),100)},show:function showFn(isModal){(!isModal||platform.app)&&(this.aboutToShow=!1,this.updatePosition(),g.isKeyboardOpen=!0,(!platform.ie||platform.ie&&(platform.mobro||platform.winphone))&&this.isVisible(!0),g.getActiveSearch().isFocused()?(g.addClass(this.element,"kbsearch"),g.removeClass(this.element,"kbmodal")):isModal?(g.addClass(this.element,"kbmodal"),g.removeClass(this.element,"kbsearch")):(g.removeClass(this.element,"kbmodal"),g.removeClass(this.element,"kbsearch")),setTimeout(function(){tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenKeyboard}),g.fireCustomEvent("keyboardOpened")},0))},hide:function hideFn(){!this.aboutToShow&&g.isKeyboardOpen&&(this.priorityVisible(!1),g.onCloseKeyboard&&g.onCloseKeyboard(),g.isKeyboardOpen=!1,this.hideTopBarIfLandscape(),this.isVisible(!1),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseKeyboard}))},hideTopBarIfLandscape:function hideTopBarIfLandscapeFn(){platform.orientation!==Orientation.Landscape||!g.isKeyboardOpen&&!this.aboutToShow||g.getActiveSearch().isFocused()?this.topBarHidden&&(this.topBarHidden=!1,g.setTransform(g.element("container"),0,0),g.setTransform(g.element("phoneMenuTopWrapper"),0,0)):(g.setTransform(g.element("container"),0,-g.topBarHeight),g.setTransform(g.element("phoneMenuTopWrapper"),0,-g.topBarHeight),this.topBarHidden=!0)},updatePosition:function updatePositionFn(byResize){platform.app||(platform.kbsize=platform.orientation===Orientation.Portrait?platform.kbsizePortrait:platform.kbsizeLandscape);var bottom=platform.kbsize;bottom!==this.bottomPosition&&(this.bottomPosition=bottom,g.element("mobileKeyboardToolbar").style.bottom=platform.getKBTop()+"px",g.isKeyboardOpen&&g.focusedPane.addPadding())}},VMKeyboardToolbar}),define("VMIntroSection",["ko","globals","platform"],function(ko,g,platform){function VMIntroSection(text,note){this.text=text,this.note=note,this.items=[],this.inOrder=!1,this.enforceOrder=!1,this.owner=void 0,this.numComplete=0,this.next=0,this.isComplete=ko.observable(!1)}return VMIntroSection.prototype={getHash:function getHashFn(){return g.introHash(this.text)},getStepHash:function getStepHashFn(index){return g.introHash(this.items[index].text)},defaultShow:function defaultShowFn(){this.isDisabled(!1)},loadFromSaveDataOld:function loadFromSaveDataOldFn(data){if(data===!0){for(var i=0;i<this.items.length;++i)this.items[i].isComplete(!0);this.numComplete=this.items.length,this.isComplete(!0)}else{for(var i=0;i<data.length;++i)for(var j=0;j<this.items.length;++j)data[i]===this.getStepHash(j)&&(this.items[j].isComplete(!0),this.numComplete++,this.inOrder&&(this.next=Math.max(this.next,j+1)));this.numComplete===this.items.length&&this.isComplete(!0)}if(this.inOrder&&0!==this.next&&this.next<this.items.length){var nextItem=this.items[this.next];nextItem&&(nextItem.show(),!g.isKeyboardOpen&&this.owner.needsKeyboardOpen&&g.tooltip.hideTip())}},loadFromSaveData:function loadFromSaveDataFn(data){for(var j=0;j<this.items.length;++j)data[this.getStepHash(j)]&&(this.items[j].isComplete(!0),this.numComplete++,this.inOrder&&(this.next=Math.max(this.next,j+1)));if(this.numComplete===this.items.length&&this.isComplete(!0),this.inOrder&&0!==this.next&&this.next<this.items.length){var nextItem=this.items[this.next];nextItem&&(nextItem.show(),!g.isKeyboardOpen&&this.owner.needsKeyboardOpen&&g.tooltip.hideTip())}},addStep:function addStepFn(item){try{g.PAssert(2576,item.text,"Invalid help step")}catch(PERR){g.reportError(PERR)}return item.isComplete||(item.isComplete=ko.observable(!1)),this.inOrder&&!platform.mobile?item.isDisabled||(item.isDisabled=ko.observable(this.items.length>0)):item.isDisabled=g.fFalse,item.show||(item.show=this.defaultShow.bind(item)),this.items.push(item),item},complete:function completeFn(item){item.isComplete()||(this.numComplete++,item.isComplete(!0),this.numComplete===this.items.length&&this.isComplete(!0),this.owner.notifyOfChange(item))},check:function checkFn(e){try{g.PAssert(2577,!this.isComplete(),"Should never be checking items in a completed section")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this.items.length&&(this.items[i].isComplete()||((e===!0||this.items[i].check&&this.items[i].check(e))&&(this.complete(this.items[i]),this.inOrder&&i===this.next&&(this.next++,this.next<this.items.length&&this.items[this.next].show())),!this.enforceOrder));i++);this.numComplete===this.items.length&&this.isComplete(!0)},showFirstIncomplete:function showFirstIncompleteFn(){try{g.PAssert(2578,!this.isComplete(),"Should never be showing a tooltip for a completed section")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this.items.length;i++)if(!this.items[i].isComplete()){this.items[i].show();break}}},VMIntroSection}),define("VMIntro",["ko","globals","util","platform","data","VMIntroSection"],function(ko,g,util,platform,d,VMIntroSection){function VMIntro(initState){this.mode=ko.observable(HelpMode.None),this.sections=ko.observableArray(),this.introSection=void 0,this.needsKeyboardOpen=!1,this.ModeClassIntro="helpIntro",this.ModeClassNormal="helpNormal",this.ModeClassHotkeys="helpHotkeys",this.priKey=platform.priModKey,this.secKey=platform.secModKey,this.isImportShowing=ko.observable(!1),g.intro=this,this.init()}return window.HelpMode={None:0,Normal:1,Intro:2,Hotkeys:3},VMIntro.prototype={isHelpShowing:function isHelpShowingFn(){return!platform.mobile&&(this.mode()===HelpMode.Intro||this.mode()===HelpMode.Normal||this.mode()===HelpMode.Hotkeys)},isShowing:function isShowingFn(){return this.isHelpShowing()||this.isImportShowing()},init:function initFn(){var helpState=g.settings.get(Settings.helpPaneState);if(void 0===helpState&&(helpState=HelpMode.Intro),helpState===HelpMode.None||g.isDemoMode()||(helpState=helpState||HelpMode.Intro,this.initState(helpState)),!platform.mobile&&g.shouldWriteLocal()){var importPaneState=util.storage.getItem("closedImport");importPaneState||g.isDemoMode()||this.isImportShowing(!0)}},initState:function initStateFn(initState){try{g.PAssert(2579,void 0!==initState,"Must pass in a valid display state")}catch(PERR){g.reportError(PERR)}this.sections.removeAll(),this.setMode(initState),platform.mobile?this.initMobile():(this.initItemsDesktop(),this.isIntroMode()?this.initIntro():this.isHotkeyMode()?this.initHotkeys():this.initHelp()),this.loadStateOld(),this.loadState()},initItemsDesktop:function initItemsDesktopFn(){this.itemAddItem={text:"Write a list title, then press enter to add a new item",check:this.checkAddItem},this.itemIndent={text:'Press the <span class="hHotkey">Tab</span> key to add an item into a list',check:this.checkIndent},this.itemOutdent={text:'Press <span class="hHotkey">Shift + Tab</span> to move an item out of a list',check:this.checkOutdent},this.itemDateTime={text:"Add a date/time by typing @ in the text of an item",check:function checkFn(e){return e.type===TrackerType.Insert&&"@"===e.data[0].text}},this.itemRightClick={text:"Right click an item to explore more options",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick}},this.itemAddAgenda={text:'Click <i class="icon-add f18 g"></i> in the top right and add an Agenda pane',check:function checkFn(e){if(e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane){var pane=g.vmMain.paneManager.getPaneById(e.data[0].data);if(pane.type===PaneMode.Timeline)return!0}}}},setMode:function setModeFn(mode){this.mode(mode),g.settings.set(Settings.helpPaneState,mode),g.vmMain.helpButtonHidden(mode===HelpMode.Intro)},isIntroMode:function isIntroModeFn(){return this.mode()===HelpMode.Intro},isHotkeyMode:function isHotkeyModeFn(){return this.mode()===HelpMode.Hotkeys},modeClass:function modeClassFn(){var modeClass="";return(platform.mobile||this.isHelpShowing())&&(modeClass=this.isIntroMode()?this.ModeClassIntro:this.isHotkeyMode()?this.ModeClassHotkeys:this.ModeClassNormal),modeClass},loadStateOld:function loadStateOldFn(){if(g.shouldWriteLocal())try{var stateString=util.storage.getItem(this.modeClass());if(stateString&&"{}"!==stateString){var state=JSON.parse(stateString);if(state){for(var i=0;i<this.sections().length;++i){var section=this.sections()[i],secHash=section.getHash();state[secHash]&&section.loadFromSaveDataOld(state[secHash])}this.sections().length>0&&(this.saveState(),util.storage.removeItem(this.modeClass()))}}}catch(err){g.reportError(err)}},loadState:function loadStateFn(){if(g.shouldWriteLocal())try{var stateString=util.storage.getItem("help");if(stateString){var state=JSON.parse(stateString);if(state)for(var i=0;i<this.sections().length;++i){var section=this.sections()[i];section.loadFromSaveData(state)}}}catch(err){g.reportError(err)}},saveState:function saveStateFn(){if(g.shouldWriteLocal())try{var state=this.getState();util.storage.setItem("help",JSON.stringify(state))}catch(err){g.reportError(err)}},getState:function getStateFn(){for(var saveData={},i=0;i<this.sections().length;++i)for(var section=this.sections()[i],j=0;j<section.items.length;++j){try{g.PAssert(2580,section.items[j],"Item entries must exist")}catch(PERR){g.reportError(PERR)}section.items[j].isComplete()&&(saveData[section.getStepHash(j)]=1)}return saveData},clearState:function clearStateFn(){g.shouldWriteLocal()&&(util.storage.setItem(this.ModeClassIntro,""),util.storage.setItem(this.ModeClassNormal,""))},notifyOfChange:function notifyOfChangeFn(change){this.saveState()},addSection:function addSectionFn(section){section.owner=this,this.sections.push(section)},initHotkeys:function initHotkeysFn(){var basic=new VMIntroSection("Basic");basic.addStep({text:'<span class="hHotkey">Tab</span> to indent an item'}),basic.addStep({text:'<span class="hHotkey">Shift + Tab</span> to un-indent an item'}),basic.addStep({text:'<span class="hHotkey">'+this.secKey+" + /</span> to complete an item"}),basic.addStep({text:'<span class="hHotkey">'+this.secKey+" + 1|2|3</span> to set item priority"}),basic.addStep({text:'<span class="hHotkey">'+this.secKey+" + 8</span> to star an item"}),basic.addStep({text:'<span class="hHotkey">'+this.secKey+" + ,</span> to collapse an item"}),basic.addStep({text:'<span class="hHotkey">'+this.secKey+" + F</span> to search for text"});var nav=new VMIntroSection("Navigation");nav.addStep({text:'<span class="hHotkey">'+this.secKey+" + Enter</span> to focus a pane on an item"}),nav.addStep({text:'<span class="hHotkey">'+this.secKey+" + Shift + Enter</span> to unfocus a pane"}),nav.addStep({text:'<span class="hHotkey">'+this.priKey+" + "+(platform.mac?"Up":"Home")+"</span> to go to the top of a pane"}),nav.addStep({text:'<span class="hHotkey">'+this.priKey+" + "+(platform.mac?"Down":"End")+"</span> to go to the bottom of a pane"});var advanced=new VMIntroSection("Advanced");advanced.addStep({text:'<span class="hHotkey">'+(platform.mac?"Ctrl + ⌘ + Up":"Alt + Shift + Up")+"</span> to move an item up in a list"}),advanced.addStep({text:'<span class="hHotkey">'+(platform.mac?"Ctrl + ⌘ + Down":"Alt + Shift + Down")+"</span> to move an item down in a list"}),advanced.addStep({text:'<span class="hHotkey">'+this.secKey+" + Shift + A</span>"+(platform.mac?' or <span class="hHotkey">'+this.secKey+" + L</span>":"")+" to select the current item"}),advanced.addStep({text:'<span class="hHotkey">'+this.secKey+" + Shift + ,</span> to collapse all top-level items"}),advanced.addStep({text:'<span class="hHotkey">Shift + F4</span> to close the current pane'});var editor=new VMIntroSection("Text Editor");editor.addStep({text:'<span class="hHotkey">'+this.secKey+" + Z</span> to undo your last action"}),editor.addStep({text:'<span class="hHotkey">'+this.secKey+" + Y</span> to redo your last action"}),editor.addStep({text:'<span class="hHotkey">'+(platform.mac?"Option":"Ctrl")+" + Backspace</span> to delete the previous word"}),editor.addStep({text:'<span class="hHotkey">'+(platform.mac?"Option":"Ctrl")+" + Delete</span> to delete the next word"}),this.addSection(basic),this.addSection(nav),this.addSection(advanced),this.addSection(editor)},initIntro:function initIntroFn(){this.introSection=new VMIntroSection("Welcome to Moo.do!","We'll walk you through the basics to get you started."),this.introSection.inOrder=!0,this.introSection.addStep(this.itemAddItem),this.introSection.addStep(this.itemIndent),this.introSection.addStep(this.itemOutdent),this.introSection.addStep(this.itemDateTime),this.introSection.addStep(this.itemRightClick),g.isDemoMode()||this.introSection.addStep(this.itemAddAgenda),this.addSection(this.introSection)},checkAddItem:function checkAddItemFn(e){if(e.type===TrackerType.Create){var item=d.getModel(e.data[0].itemID);return!item||item.parent()===d.getRootModel()&&0===e.data[0].position?!1:!0}},checkIndent:function checkIndentFn(e){if(e.type===TrackerType.Move){var oldParentItem=d.getItem(e.data[0].oldParent);if(oldParentItem&&oldParentItem.items.indexOf(e.data[0].newParent)>=0)return!0}},checkOutdent:function checkOutdentFn(e){if(e.type===TrackerType.Move){var newParentItem=d.getItem(e.data[0].newParent);if(newParentItem&&newParentItem.items.indexOf(e.data[0].oldParent)>=0)return!0}},checkSearch:function checkSearchFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged},checkComplete:function checkCompleteFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isComplete"===v.field&&v.newValue}},checkOutline:function checkOutlineFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleOutline},initHelp:function initHelpFn(){this.sections.removeAll();var org=new VMIntroSection("Organization","Moo.do works like a text editor so you can organize like you're writing a document.");org.addStep(this.itemAddItem),org.addStep(this.itemIndent),org.addStep(this.itemOutdent),org.addStep({text:"Click and drag on the left edge of an item to move it",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&g.vmMain.isLoaded?!0:void 0}}),org.addStep({text:'Press <span class="hHotkey">'+this.priKey+' + Z</span> to undo and <span class="hHotkey">'+this.priKey+" + Y</span> to redo",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.UndoRedo?!0:void 0}}),org.addStep({text:'Click the left edge of a list or press <span class="hHotkey">'+this.secKey+" + ,</span> to collapse its subitems",check:function checkFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isCollapsed"===v.field&&v.newValue}}}),this.addSection(org);var dates=new VMIntroSection("Dates","Scheduling items automatically puts them on your Agenda.");dates.addStep(this.itemDateTime),dates.addStep({text:'Write dates in plain English like <span class="date">@tomorrow</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data[0].date;return!!date}}}),dates.addStep({text:'Schedule a full date and time like <span class="date">@today 2:30pm</span> or <span class="date">@5/25 6:00</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data[0].date;if(date)return date.hasTimeOfDay()}}}),dates.addStep({text:'Describe urgency with <span class="date">@now</span>, <span class="date">@soon</span>, or <span class="date">@later</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var item=d.getModel(e.data[0].itemID);return item?g.isDateSoft(item.dateText):!1}}}),dates.addStep({text:'Create a repeating date like <span class="date">@every friday</span> or <span class="date">@every other tuesday</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data[0].date;if(date)return date.isRepeatDate()}}}),dates.addStep({text:'Create a repeating date with a beginning or end <span class="date">@every friday from tomorrow</span> or <span class="date">@every other tuesday until october</span>',check:function checkFn(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data[0].date;if(date&&date.isRepeatDate())return!date.getStartDate().equals(Date.today())||!!date.getEndDate()}}}),this.addSection(dates);var priority=new VMIntroSection("Priority","Prioritizing items automatically puts them on your agenda and lets you manage what to do next.");priority.addStep(this.itemRightClick),priority.addStep({text:'Set a priority with the right click menu or <span class="hHotkey">'+this.secKey+" + 1|2|3</span>",check:function checkFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"priority"===v.field&&v.newValue>0}}}),priority.addStep({text:'Click the right edge of an item or <span class="hHotkey">'+this.secKey+" + /</span> to complete it",check:this.checkComplete}),priority.addStep({text:'Press <span class="hHotkey">'+this.secKey+" + 8</span> to star an item which highlights it in yellow",check:function checkFn(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isStarred"===v.field&&v.newValue}}}),this.addSection(priority);var contacts=new VMIntroSection("Contacts","Add a contact to an item to easily start a call or email.");contacts.addStep({text:"Add a contact by typing + in the text of an item",check:function checkFn(e){return e.type===TrackerType.Insert&&"+"===e.data[0].text}}),contacts.addStep({text:"Select a contact's name from the list or start typing a name to narrow the search",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddContact}}),contacts.addStep({text:'Click on a <span class="contact">+contact</span> to start a call or email',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenContact}}),this.addSection(contacts);var panes=new VMIntroSection("Panes","There are two types of panes: List and Agenda. The List pane is where you write and organize while the Agenda pane is organized automatically by time and priority.");panes.addStep(this.itemAddAgenda),panes.addStep({text:'Click <i class="icon-close gd"></i> in the top right of a pane to close it',check:function checkFn(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.RemovePane
}}),this.addSection(panes);var focus=new VMIntroSection("Focus","Focus on an item to show only the items under it");focus.addStep({text:'To focus on an item, right click it and select Focus, press <span class="hHotkey">'+this.secKey+' + Enter</span>, or hold <span class="hHotkey">'+this.secKey+"</span> and click its left edge",check:function checkFn(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut}}),focus.addStep({text:"To bring focus back out, click the title of the list you want to focus on",check:function checkFn(e){return e.type===TrackerType.Zoom&&e.data[0].zoomOut}}),focus.addStep({text:'Press <i class="outlineButtonNormal icon-list g"></i> in the top left of a pane to open the outline',check:this.checkOutline}),focus.addStep({text:"Click the title of a list in the outline to focus on it",check:function checkFn(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut&&g.focusedPane.outline.isVisible()}}),this.addSection(focus);var search=new VMIntroSection("Search","Filter for only the items you want to see right now");search.addStep({text:"Filter for a keyword by searching for that word",check:this.checkSearch}),search.addStep({text:'Mark similar items with a <span class="tag">#tag</span> to easily search for all items matching that tag',check:function checkFn(e){return e.type===TrackerType.Insert&&e.data[0].text===TagPrefix}}),search.addStep({text:"Filter by priority by searching for !, !!, or !!!",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("!")>=0}}),search.addStep({text:"Show only starred items by searching for *",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("*")>=0}}),search.addStep({text:"Hide items you're not interested in by starting a search with - (dash)",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("-")>=0}}),search.addStep({text:"Hide completed items by searching for -// (dash, two slashes)",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data[0].text.indexOf("-//")>=0}}),this.addSection(search);var documents=new VMIntroSection("Collaboration","Collaborate with others by sharing documents with different groups of people");documents.addStep({text:'Click <i class="icon-folder-o g c f18"></i> in the top left to open the documents menu',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleDocumentsMenu&&e.data[0].value}}),documents.addStep({text:'Click <i class="icon-add f18 g"></i> to create a new document',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddDocument&&e.data[0].value}}),documents.addStep({text:"Open your new document by clicking on it in the list of documents",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocument&&e.data[0].value}}),documents.addStep({text:'Click <i class="icon-settings f18 c g"></i> to change the sharing settings',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocSharing&&e.data[0].value}}),this.addSection(documents);var data=new VMIntroSection("Data","Import data from another app to use in Moo.do or export your data out of Moo.do");data.addStep({text:'Paste into Moo.do by pressing <span class="hHotkey">'+this.priKey+" + V</span> or finding Paste in your browsers edit menu",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.Paste&&e.data[0].value}}),data.addStep({text:'Copy the selected text by pressing <span class="hHotkey">'+this.priKey+" + C</span> or finding Copy in your browsers edit menu",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.Copy&&e.data[0].value}}),data.addStep({text:'Click on Import Data in the options menu in the top right, then choose the app to import from and follow the instructions. If you do not see your app, try using copy and paste to paste it in to Moo.do. If that does not work, please <a href="mailto:support@moo.do?subject=Import Request">contact us</a> and tell us what app you want to import from.',check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenImport&&e.data[0].value}}),data.addStep({text:"Click on Export Data in the options menu in the top right, then choose the format you'd like. You can see your data in a new tab so you may copy or download it.",check:function checkFn(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenExport&&e.data[0].value}}),this.addSection(data)},initMobile:function initMobileFn(){var t=g.tooltip,intro=new VMIntroSection("Mobile Intro");intro.inOrder=!0,intro.enforceOrder=!0;var self=this;intro.addStep({text:"Open Keyboard",show:function showFn(e){self.needsKeyboardOpen=!1},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.OpenKeyboard}}),intro.addStep({text:"Press return to add another item",show:function showFn(e){self.needsKeyboardOpen=!0,t.displayTip({text:this.text,element:g.element("mobileKeyboardToolbar"),above:!0,offset:{y:-10},maxWidth:240})},check:this.checkAddItem}),intro.addStep({text:"Indent items into lists",show:function showFn(e){self.needsKeyboardOpen=!0,t.displayTip({text:this.text,element:g.element("indentButton"),above:!0,offset:{y:-10},arrow:"arrowBottom",time:200})},check:function checkFn(e){return this.checkIndent(e)||this.checkOutdent(e)}.bind(this)}),intro.addStep({text:"Add a date to a task",show:function showFn(e){self.needsKeyboardOpen=!0,t.displayTip({text:this.text,element:g.element("dateButton"),above:!0,offset:{x:0,y:-10},arrow:"arrowBottom",time:200})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.AtButton&&t.hideTip(),e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.CloseAutocomplete}}),intro.addStep({text:"Tap the right edge of an item to complete it",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5}})},check:this.checkComplete}),intro.addStep({text:"Tap the left edge of a list to collapse its items",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5}})},check:function checkFn(e){return e.type===TrackerType.Update&&e.data[0]&&"isCollapsed"===e.data[0].field}}),intro.addStep({text:"Open the Agenda",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,element:g.element("modeButton"),offset:{y:8},arrow:"arrowTop"})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.PaneAgenda}}),intro.addStep({text:"The agenda shows items with dates or priorities. Go back to the List view.",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,element:g.element("modeButton"),offset:{y:8},arrow:"arrowTop"})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.PaneNormal}}),intro.addStep({text:"Swipe from right to left to enter multiselect mode",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5},time:200})},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.OpenMultiselect}}),intro.addStep({text:"Wait close multiselect",show:function showFn(e){self.needsKeyboardOpen=!1,t.hideTip()},check:function checkFn(e){return e.type===TrackerType.Mobile&&e.misc===TrackerMiscMobile.CloseMultiselect}}),intro.addStep({text:"Swipe from left to right to open the Outline",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5},time:200})},check:this.checkOutline}),intro.addStep({text:"Tap a list title to focus on it",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5},time:200})},check:function checkFn(e){return e.type===TrackerType.Zoom}}),intro.addStep({text:"Open the outline again and tap on Home to go back",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5},time:200})},check:function checkFn(e){return e.type===TrackerType.Zoom?e.data[0].itemID===g.vmMain.root().id:void 0}}),intro.addStep({text:"Finished! Open Moo.do on your computer for a more detailed introduction.",show:function showFn(e){self.needsKeyboardOpen=!1,t.displayTip({text:this.text,bottom:!0,offset:{y:-5},time:200})},check:function checkFn(e){return e.type===TrackerType.Zoom?e.data[0].itemID===g.vmMain.root().id:void 0}}),intro.addStep({text:"Intro Done",show:function showFn(e){this.hasShown=!0,self.needsKeyboardOpen=!1,t.hideTip(),self.setMode(HelpMode.None)},check:function checkFn(e){return!!this.hasShown}}),this.addSection(intro),platform.mobile&&(window.addEventListener("closeKeyboard",function(e){this.needsKeyboardOpen&&g.tooltip.hideTip()}.bind(this)),window.addEventListener("keyboardOpened",function(e){try{g.PAssert(2581,this.sections().length>0,"Should have one section on mobile")}catch(PERR){g.reportError(PERR)}this.sections()[0].isComplete()||this.sections()[0].showFirstIncomplete(e)}.bind(this)))},addMobileStep:function addMobileStepFn(step){this.sections.push(step)},onAction:function onActionFn(e){if(!g.menus.isModalOpen(Modals.ImportData))try{for(var scts=this.sections(),i=0;i<scts.length;++i)scts[i].isComplete()||scts[i].check(e)}catch(err){g.reportError(err)}},closeHelp:function closeHelpFn(e){g.tooltip.hideTip(),g.vmMain.helpButtonHidden(!1),this.setMode(HelpMode.None),g.sendEvent("Menu","CloseHelp")},onCloseImport:function onCloseImportFn(e){g.tooltip.hideTip(),this.isImportShowing(!1),g.shouldWriteLocal()&&util.storage.setItem("closedImport",!0)},introComplete:function introCompleteFn(){return this.introSection&&this.introSection.isComplete()},switchToHelp:function switchToHelpFn(){delete this.introSection,this.setMode(HelpMode.Normal),this.initHelp(),this.saveState(),g.sendEvent("Menu","OpenHelp")},nextStep:function nextStepFn(){for(var scts=this.sections(),i=0;i<scts.length;++i)scts[i].isComplete()||scts[i].check(!0)},onTapImport:function onTapImportFn(e){var el=e.target||e.srcElement,importer=el.id.replace("helpImport","");importer&&(g.sendEvent("Menu","HelpImport"+importer),g.menus.openModal(Modals.ImportData,importer))},onTapFeatures:function onTapFeaturesFn(e){this.initState(HelpMode.Normal)},onTapHotkeys:function onTapHotkeysFn(e){this.initState(HelpMode.Hotkeys)}},VMIntro}),define("VMMessage",["ko","globals","util","data","tracker"],function(ko,g,util,d,tracker){function VMMessage(info,queue){try{g.PAssert(2582,info,"Must provide valid message info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2583,queue,"Must provide a valid message owner")}catch(PERR){g.reportError(PERR)}if(this.id=info.id,this.owner=queue,this.timeout=info.timeout||4e3,this.text=info.text,this.action=info.action||MessageAction.Default,this.data=info.data,this.hold=!info.timeout&&(info.hold||this.action!==MessageAction.Default),this.noIgnore=info.noIgnore,this.onCloseFn=info.onClose,this.clearTimeout=void 0,this._isVisible=!1,this.actionText=info.actionText,!this.actionText)switch(this.action){case MessageAction.Default:this.actionText="";break;case MessageAction.Reload:case MessageAction.ResetClient:this.actionText="RELOAD";break;case MessageAction.Okay:this.actionText="OKAY";break;case MessageAction.Blog:this.actionText="BLOG";break;case MessageAction.Undo:this.actionText="UNDO";break;case MessageAction.LoginScreen:this.actionText="LOGIN";break;case MessageAction.Contact:this.actionText="CONTACT";break;case MessageAction.OpenSettings:this.actionText="LEARN MORE"}}return VMMessage.prototype={show:function showFn(){this._isVisible||(this._isVisible=!0,this.hold||(this.clearTimeout=setTimeout(this.hide.bind(this),this.timeout)),this.owner.onMessageShow(this))},hide:function hideFn(noNotify){this._isVisible&&(this._isVisible=!1,clearTimeout(this.clearTimeout),this.clearTimeout=void 0,this.onCloseFn&&this.onCloseFn(this),noNotify||this.owner.onMessageHide(this))},isVisible:function isVisibleFn(){return this._isVisible},doAction:function doActionFn(e){if(this.isVisible()){if(g.isFunction(this.action))this.action();else switch(this.action){case MessageAction.None:case MessageAction.Okay:case MessageAction.Default:break;case MessageAction.Reload:g.reload();break;case MessageAction.Login:util.removeURLParam("demo");break;case MessageAction.Demo:util.insertURLParam("demo","true");break;case MessageAction.ResetClient:d.clearData(function(){g.reload()});break;case MessageAction.OpenURL:var targetUrl=this.data?this.data.url:void 0;try{g.PAssert(2584,targetUrl,"Should always have a valid URL to navigate")}catch(PERR){g.reportError(PERR)}targetUrl&&g.openUrl(targetUrl);break;case MessageAction.Blog:g.openUrl("http://www.moo.do/blog/updates");break;case MessageAction.Undo:tracker.undoAction();break;case MessageAction.LoginScreen:util.removeURLParam("demo",!0),util.removeURLParam("dmode");break;case MessageAction.Contact:g.menus.openModal(Modals.ReportBug);break;case MessageAction.OpenSettings:g.menus.openModal(Modals.Settings,"plugins");break;default:try{g.PAssert(2585,!1,"Invalid message action, add a new case here or pass in a function",this.action)}catch(PERR){g.reportError(PERR)}}this.hide(),e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0}},onTapIgnore:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){this.isVisible()&&!this.noIgnore&&(this.hide(),e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0)}}},VMMessage}),define("VMMessageQueue",["ko","globals","util","platform","data","VMMessage"],function(ko,g,util,platform,d,VMMessage){function VMMessageQueue(){this.queue=ko.observableArray(),this.remoteMessages={},this.defaultMessages=[],this.defaultMessages[MessageID.Undefined]=void 0,g.messageQueue=this,this.init()}return VMMessageQueue.prototype={init:function initFn(){try{g.PAssert(2586,0===this.queue().length,"There should never be items in the queue when initializing the message queue: ",this.queue().length)}catch(PERR){g.reportError(PERR)}try{}catch(err){g.reportError(err,"Error binding message queue: ",this.queue().length)}},getMessageById:function getMessageByIdFn(id){void 0===this.defaultMessages[id]&&this.initMessageByid(id);try{g.PAssert(2587,void 0!==this.defaultMessages[id],"After init message should always be defined")}catch(PERR){g.reportError(PERR)}return this.defaultMessages[id]},testMessageById:function testMessageByIdFn(id){return!!this.defaultMessages[id]},initMessageByid:function initMessageByidFn(id){switch(id){case MessageID.ConnectionError:this.defaultMessages[id]=new VMMessage({text:"Connection error detected. Please reload to try again.",action:MessageAction.Reload},this);break;case MessageID.OfflineUndo:this.defaultMessages[id]=new VMMessage({text:"Offline undo/redo has been disabled temporarily",hold:!0},this);break;case MessageID.FatalError:this.defaultMessages[id]=new VMMessage({text:"There was a fatal error in the application. "+platform.actionVerbCaps()+" to restart.",action:MessageAction.Reload},this);break;case MessageID.ExitDemo:this.defaultMessages[id]=new VMMessage({text:"Changes are not saved in demo",action:MessageAction.LoginScreen,hold:!0,noIgnore:!0},this);break;case MessageID.ShareFailure:this.defaultMessages[id]=new VMMessage({text:"There was an error sharing the file you attached.",action:MessageAction.OpenSettings},this);break;case MessageID.ThisIsDemo:this.defaultMessages[id]=new VMMessage({text:"Click anywhere to try this live demo of <b>Moo.do</b>",hold:!0},this);break;default:try{g.PAssert(2588,!1,"Invalid MessageID")}catch(PERR){g.reportError(PERR)}}},pushMessage:function pushMessageFn(msg){var vmMsg;if(msg instanceof VMMessage)vmMsg=msg;else if(g.isObject(msg))vmMsg=new VMMessage(msg,this);else if(g.isString(msg))vmMsg=new VMMessage({text:msg},this);else if(vmMsg=this.getMessageById(msg),!vmMsg){try{g.PAssert(2589,!1,"Invalid data passed to message creation")}catch(PERR){g.reportError(PERR)}log("Message not created properly",msg)}return vmMsg&&vmMsg.show(),vmMsg},clearMessage:function clearMessageFn(msg){var vmMsg;return msg instanceof VMMessage?vmMsg=msg:this.testMessageById(msg)&&(vmMsg=this.getMessageById(msg)),vmMsg&&vmMsg.hide(),vmMsg},onMessageShow:function onMessageShowFn(msg){try{g.PAssert(2590,msg,"Must pass in a valid message to add to the queue")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2591,msg&&msg.doAction,"Message added to queue must have valid API exposed - doAction")}catch(PERR){g.reportError(PERR)}msg instanceof VMMessage?this.queue.push(msg):g.reportError(new Error("Overlay message must be an instance of VMMessage"),msg)},onMessageHide:function onMessageHideFn(msg){try{g.PAssert(2592,msg,"Must pass in a valid message to be removed from the queue")}catch(PERR){g.reportError(PERR)}var index=this.queue.indexOf(msg);if(0>index)try{g.PAssert(2593,!1,"Trying to remove an invalid message from the queue")}catch(PERR){g.reportError(PERR)}else this.queue.splice(index,1)}},VMMessageQueue}),define("VMAttachment",["globals","util"],function(g,util){function VMAttachment(plugin,id){this.id=id,this._plugin=plugin,this._loadState=LoadState.Unloaded,this._subscribers=[],this._countInUse=0,this._iteratingSubscribers=!1,this.init()}var LoadState={Unloaded:1,Waiting:2,Requesting:3,LoadedPreview:4,LoadedFull:5,FailedRequest:6,Updating:7};return VMAttachment.prototype={init:function initFn(){this.load()},load:function loadFn(){this._loadState=LoadState.Waiting,this._plugin.requestData(this)},notifyDataRequested:function notifyDataRequestedFn(){try{g.PAssert(2594,!this.isLoaded(),"Should not request additional data once loaded")}catch(PERR){g.reportError(PERR)}this._loadState=LoadState.Requesting},notifyDataLoaded:function notifyDataLoadedFn(type,isUpdate){try{g.PAssert(2595,isUpdate||this._loadState!==LoadState.LoadedFull||type!==PluginLoad.Preview,"Should not load preview data after full data has been loaded")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2596,!isUpdate||this._loadState===LoadState.LoadedPreview||type===PluginLoad.Full,"Incoming update much match previous type")}catch(PERR){g.reportError(PERR)}this._loadState=type===PluginLoad.Preview?LoadState.LoadedPreview:LoadState.LoadedFull,this.onUpdate()},notifyDataRequestFailed:function notifyDataRequestFailedFn(){try{g.PAssert(2597,this._loadState===LoadState.Requesting||this._loadState===LoadState.LoadedPreview,"Must be requesting remote data or a preview cache was able to service after the request was sent")}catch(PERR){g.reportError(PERR)}if(this._loadState===LoadState.Requesting)this._loadState=LoadState.FailedRequest;else if(this._loadState===LoadState.LoadedPreview)try{g.PAssert(2598,!1,"Failed remote reuqest but serviced by preview cache, should not have made the request?")}catch(PERR){g.reportError(PERR)}else try{g.PAssert(2599,!1,"Invalid loadstate when remote request failed: ",this._loadState)}catch(PERR){g.reportError(PERR)}},isLoaded:function isLoadedFn(){return this._loadState===LoadState.LoadedPreview||this._loadState===LoadState.LoadedFull},needsRemoteData:function needsRemoteDataFn(){return this._loadState!==LoadState.LoadedFull},changeID:function changeIDFn(newID){var oldID=this.id;this.id=newID,this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i)this._subscribers[i].onAttachmentIDChange(this,oldID);this._iteratingSubscribers=!1},delayChangeID:function delayChangeIDFn(){this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i){var subscriber=this._subscribers[i],changeFn=subscriber.onAttachmentIDChange.bind(subscriber,this,this.id);setTimeout(changeFn,0)}this._iteratingSubscribers=!1},isFieldDefined:function isFieldDefinedFn(field){return this._plugin.isFieldDefined(field)},hasField:function hasFieldFn(field){return this._plugin.hasAttachField(this,field)},getField:function getFieldFn(field){return this._plugin.getAttachField(this,field)},isFieldDefault:function isFieldDefaultFn(field){return this._plugin.isAttachFieldDefault(this,field)},fieldNeedsWrite:function fieldNeedsWriteFn(field,value){return this._plugin.fieldNeedsWrite(this,field,value)},getFieldAsDate:function getFieldAsDateFn(field){var value=this._plugin.getAttachField(this,field);if(value){var date=new Date(value);return date.toString("MMM d")}try{g.PAssert(2600,!1,"Invalid attachment date field: ",this._plugin.id,field)}catch(PERR){g.reportError(PERR)}return void 0},getPlugin:function getPluginFn(){return this._plugin},getData:function getDataFn(){return this._plugin.getCacheData(this.id)},getEmbedString:function getEmbedStringFn(){return this._plugin.getAttachmentEmbedString(this)},getTitleString:function getTitleStringFn(){return this._plugin.getAttachmentTitleString(this)},unload:function unloadFn(){this._plugin.releaseAttachment(this)},match:function matchFn(text){return this.isLoaded()?this._plugin.matchAttachment(this,text):!1},markInUse:function markInUseFn(changeType){0===this._countInUse&&this._plugin.notifyAttachmentInUse(this,changeType),this._countInUse++},markUnused:function markUnusedFn(changeType){this._countInUse--,0===this._countInUse&&this._plugin.notifyAttachmentUnused(this,changeType);try{g.PAssert(2601,this._countInUse>=0,"Should never have negative users of the attachment")}catch(PERR){g.reportError(PERR)}},isInUse:function isInUseFn(){return this._countInUse>0},subscribe:function subscribeFn(subscriber){try{g.PAssert(2602,this._subscribers.indexOf(subscriber)<0,"Must not double subscribe")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2603,!this._iteratingSubscribers,"Should not modify subscriptions during iteration")}catch(PERR){g.reportError(PERR)}this._subscribers.push(subscriber)},unsubscribe:function unsubscribeFn(subscriber){try{g.PAssert(2604,this._subscribers.indexOf(subscriber)>=0,"Subscriber should be active")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2605,!this._iteratingSubscribers,"Should not modify subscriptions during iteration")}catch(PERR){g.reportError(PERR)}this._subscribers.remove(subscriber)},onUpdate:function onUpdateFn(){this.isInUse()&&this._plugin.notifyAttachmentUpdated(this),this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i)this._subscribers[i].onAttachmentUpdate(this);this._iteratingSubscribers=!1},isLocalOnlyAttachment:function isLocalOnlyAttachmentFn(){return g.isTempId(this.id)}},util.defineBase(VMAttachment),VMAttachment}),define("PluginRenderer",["globals","util","VMAttachment"],function(g,util,VMAttachment){function PluginRenderer(){this._registeredRenderers=[],this._registeredRenderers[PluginRenderTypes.Generic]={},this._registeredRenderers[PluginRenderTypes.StyledText]={},this._registeredRenderers[PluginRenderTypes.UnstyledText]={},this._registeredRenderers[PluginRenderTypes.AutocompleteText]={}}return PluginRenderer.prototype={registerDefaultRenderers:function registerDefaultRenderersFn(){this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile,function(attach){return attach.isLoaded()?"<span>"+attach.getField("title")+"</span>":"Loading..."},["iconLink","title"]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.DriveFile,function(attach){return attach.isLoaded()?attach.getField("title"):"Loading..."},["title"]),this.registerRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.DriveFile,function(data,searchText){var text='<p class="plugin '+this.getMimetypeClass(data.mimeType)+'">',title=data.title,text2="</p>",index=data.titleLower.indexOf(searchText);return index>=0&&(index+=text.length),{text:text+title+text2,index:index}},["mimeType","title","titleLower"]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread,function(attach){var content;return attach.isLoaded()?(content='<span class="from">'+attach.getField("from")+'</span><span class="subject">'+attach.getField("subject")+"</span>",attach.hasField("snippet")&&(content+='<span class="snippet">'+attach.getField("snippet")+"</span>")):content="Loading...",content},["from","subject","snippet"]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread,function(attach){return attach.isLoaded()?"From: "+attach.getField("from")+" - "+attach.getField("subject"):"Loading..."},["from","subject"]),this.registerRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.EmailThread,function(data,searchText){var text='<p class="plugin plugin_gmail"><span class="from">',from=data.from,text2='</span><span class="subject">',text3=data.subject+"</span></p>",index=data.fromLower.indexOf(searchText);return index>=0?index+=text.length:(index=data.subjectLower.indexOf(searchText),index+=text.length+from.length+text2.length),{text:text+from+text2+text3,index:index}},["from","subject","fromLower","subjectLower"])},registerRenderer:function registerRendererFn(type,id,fn,fields){try{g.PAssert(2606,this._registeredRenderers[type],"Invalid renderer type",type,id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2607,!this._registeredRenderers[type][id],"Cannot register a renderer twice",type,id)}catch(PERR){g.reportError(PERR)}this._registeredRenderers[type][id]={fn:fn,fields:fields}},useRenderer:function useRendererFn(type,id){try{g.PAssert(2608,this._registeredRenderers[type],"Invalid renderer type",type,id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2609,this._registeredRenderers[type][id],"Renderer has not been registered yet",type,id)}catch(PERR){g.reportError(PERR)}return this._registeredRenderers[type][id].fn},ensureRendererFields:function ensureRendererFieldsFn(type,id,plugin){}},PluginRenderer}),define("VMPlugin",["globals","util","data","goog","gdata","PaneFactory","PluginRenderer","VMAttachment"],function(g,util,d,goog,gdata,PaneFactory,PluginRenderer,VMAttachment){function VMPlugin(id,name){try{g.PAssert(2610,id,"Must supply a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2611,name,"Must supply a valid name")}catch(PERR){g.reportError(PERR)}this.id=id,this.name=name,this._previewCache="p_"+id,this._offlineCache="ocache_"+id,this._paneType="Pane"+id,this._rootId=id+"Root",this._acProviderId="AC"+id,this._settingsGroup="plugin"+this.id,this.loadedEvent="Plugin_"+id+"_Loaded",this._isActive=!1,this._isReady=!1,this._propertyDescriptors={},this._previewProperties=[],this._entryProperties=[],this._registeredAutocomplete=!1,this._attachKeys=[],this._attachCache={},this._dataKeys=[],this._dataCache={},this._scorchOfflineCache=!1,this._defaultItemStore=void 0,this._activeItemStore={},this._pastSearches={},this._searchBuckets={},this._activeSearchBucket={},this._numDeferredReqs=0,this._numOutstandingReqs=0,this._pendingRequests=[],this._activeAttachments=[],this._numActivePanes=0,this._unloadedDependencies=this.getDependencies(),this._loadedInitialData=!1,this._hasLoadedCaches=!1,g.settings.registerGroup(this._settingsGroup),this.registerSetting("isEnabled",this._settingsGroup,!0),this.getDataPane()&&PaneFactory.registerPaneType(this,this._paneType,this.name,this.getDataPane(),this.getPaneIcon()),DETAILED_STATS&&(this.__Stats={requestData:0,remoteRequests:0,canceledRequests:0,remoteBatches:0,cacheWrites:0,cacheUpdates:0,findByField:0,createdAttachments:0,previewCacheIsAvailable:0,previewCacheUpdate:0,previewCacheQuery:0}),this.declareProperty("cssClass",PluginLoad.Runtime,!0)}var maxBatchSize=30;return VMPlugin.prototype={getSetting:function getSettingFn(key){return g.settings.get(key,this._settingsGroup)},setSetting:function setSettingFn(key,value){return g.settings.set(key,value,this._settingsGroup)},registerSetting:function registerSettingFn(key,syncRemote){g.settings.registerSetting(key,this._settingsGroup,syncRemote)},onSettingChanged:function onSettingChangedFn(key,cb){g.settings.registerForChangeNotification(key,cb,this._settingsGroup)},getStats:function getStatsFn(){return{fnCalls:DETAILED_STATS?this.__Stats:void 0,numItems:this._defaultItemStore?this._defaultItemStore.getCount():-1,activeAttachments:this._activeAttachments.length,numAttach:this._attachKeys.length,numDataCache:this._dataKeys.length}},isPluginPane:function isPluginPaneFn(pane){return pane.type===this._paneType},activate:function activateFn(loadedDeps){if(!this._isActive){if(this._isActive=!0,this.useItemStore()&&(this._defaultItemStore=d.registerItemStore(this.id,this),this._defaultItemStore.createRoot(this._rootId,this.useItemStore())),this._hasLoadedCaches||(this.usesPreviewCache()&&this.registerPreviewCache(),this.supportOfflineCache()&&g.shouldWriteLocal()&&this.loadOfflineCache(),this._hasLoadedCaches=!0),this.getDataPane()&&this.getSetting("isEnabled")&&PaneFactory.activatePaneType(this._paneType),this.registerAutocomplete(),this._unloadedDependencies){for(var remainDeps=[],i=0;i<this._unloadedDependencies.length;++i){var dep=this._unloadedDependencies[i];loadedDeps[dep]||remainDeps.push(dep)}this._unloadedDependencies=remainDeps.length>0?remainDeps:void 0}return this._unloadedDependencies||this.onAllDependenciesLoaded(),!0}return!1},deactivate:function deactivateFn(){try{g.PAssert(2612,this._isActive,"Must be active in order to deactivate pane")}catch(PERR){g.reportError(PERR)}return this._isActive=!1,this.unregisterAutocomplete(),this.getDataPane()&&g.vmMain.paneFactory.deactivatePaneType(this._paneType),this.useItemStore()&&(d.unregisterItemStore(this.id),this._defaultItemStore=void 0),!0},ensurePaneTypeIsActive:function ensurePaneTypeIsActiveFn(){this.getDataPane()&&!PaneFactory.isPaneTypeActive(this._paneType)&&this.getSetting("isEnabled")&&PaneFactory.activatePaneType(this._paneType)},isActive:function isActiveFn(){return this._isActive},isReady:function isReadyFn(){return this._isReady},goOnline:function goOnlineFn(){},goOffline:function goOfflineFn(){},onDependencyLoaded:function onDependencyLoadedFn(dep,data){if(this._unloadedDependencies){var depIndex=this._unloadedDependencies.indexOf(dep);depIndex>=0&&this.isDependencyLoaded(dep,data)&&this._unloadedDependencies.removeAt(depIndex),0===this._unloadedDependencies.length&&(this._unloadedDependencies=void 0,this.onAllDependenciesLoaded())}},onAllDependenciesLoaded:function onAllDependenciesLoadedFn(){this._isActive&&(this._isReady=!0,g.vmMain.paneManager.applyFnToPanes("isNotReady",this._paneType,!1),this.load())},areDependenciesLoaded:function areDependenciesLoadedFn(){return void 0===this._unloadedDependencies},isDependencyLoaded:function isDependencyLoadedFn(dep,data){return!0},loadRemoteAPIs:function loadRemoteAPIsFn(){},forceLoad:function forceLoadFn(){this._loadedInitialData=!1,this.activate(),this._unloadedDependencies&&(this._unloadedDependencies=void 0,this.onAllDependenciesLoaded())},authorize:function authorizeFn(options,cb){try{g.PAssert(2613,cb&&g.isFunction(cb),"Must provide a valid authoirzation callback")}catch(PERR){g.reportError(PERR)}this.googleScopes(options)?this._authorizeGoogle(options,cb):cb(!0)},_authorizeGoogle:function _authorizeGoogleFn(options,cb){try{g.PAssert(2614,this.googleScopes(options),"Must have a valid google scope to request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2615,cb&&g.isFunction(cb),"Must provide a valid authoirzation callback")}catch(PERR){g.reportError(PERR)}goog.runAuthenticate(this.googleScopes(options),!1,!1,function(token){cb(token&&!token.error?!0:!1)}.bind(this))},googleScopes:function googleScopesFn(options){return void 0},getDependencies:function getDependenciesFn(){return void 0},getPluginDependencies:function getPluginDependenciesFn(){return void 0},getOfflineCacheName:function getOfflineCacheNameFn(){return this._offlineCache},loadOfflineCache:function loadOfflineCacheFn(){try{g.PAssert(2616,0===this._dataKeys.length,"Must have no data already loaded")}catch(PERR){g.reportError(PERR)}if(this.supportOfflineCache()&&g.shouldWriteLocal()){var inString=util.storage.getItem(this.getOfflineCacheName());if(inString)try{var inObj=JSON.parse(inString);inObj&&this.loadDataFromObject(inObj)
}catch(err){g.reportError(err)}}},loadDataFromObject:function loadDataFromObjectFn(inObj){try{g.PAssert(2617,inObj,"Must provide a valid dataset to load")}catch(PERR){g.reportError(PERR)}var props=inObj.props,data=inObj.data;try{g.PAssert(2618,data,"Load object must contain valid data")}catch(PERR){g.reportError(PERR)}this._dataKeys=Object.keys(data);for(var i=0;i<this._dataKeys.length;++i){var key=this._dataKeys[i];this._dataCache[key]=this.createEntryFromLocal(data[key]),this._dataCache[key].id=key}},saveOfflineCache:function saveOfflineCacheFn(){if(this.supportOfflineCache()&&g.shouldWriteLocal()&&!this._scorchOfflineCache){for(var numEntries=0,outObjData={},i=0;i<this._activeAttachments.length;++i){var attach=this._activeAttachments[i];try{g.PAssert(2619,attach.isInUse(),"Attachments in the active list should always be in use")}catch(PERR){g.reportError(PERR)}if(attach.isInUse()){var serialObj=this.serializeEntry(attach);serialObj&&(outObjData[attach.id]=serialObj,numEntries++)}}var outObj={data:outObjData,info:{writeDate:Date.now(),entries:numEntries}};try{var outString=JSON.stringify(outObj);util.storage.setItem(this.getOfflineCacheName(),outString)}catch(err){g.reportError(err)}}},clearOfflineCache:function clearOfflineCacheFn(noFutureSave){this.supportOfflineCache()&&g.shouldWriteLocal()&&(util.storage.removeItem(this.getOfflineCacheName()),noFutureSave&&(this._scorchOfflineCache=!0))},supportOfflineCache:function supportOfflineCacheFn(){return!1},createEntryFromLocal:function createEntryFromLocalFn(){try{g.PAssert(2620,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},clearData:function clearDataFn(){this._attachKeys=[],this._attachCache={},this._dataKeys=[],this._dataCache={},this.useItemStore()&&(this.getDefaultItemStore().clearStore(),this._activeItemStore={}),this._pastSearches={},this._searchBuckets={},this._activeSearchBucket={},this._numDeferredReqs=0,this._numOutstandingReqs=0,this._pendingRequests=[],this._activeAttachments=[]},changeID:function changeIDFn(attach,oldID,newID){try{g.PAssert(2621,oldID!==newID,"Should never be switching to the same ID")}catch(PERR){g.reportError(PERR)}var checkNewAttachID=this._attachCache[newID];if(checkNewAttachID)attach.delayChangeID(newID),this._attachCache[oldID]=void 0,this._attachKeys.remove(oldID),this._dataCache[oldID]=void 0,this._dataKeys.remove(oldID);else{var attachEntry=this._attachCache[oldID];try{g.PAssert(2622,attach===attachEntry,"Attach entries must match")}catch(PERR){g.reportError(PERR)}attachEntry&&(this._attachCache[oldID]=void 0,this._attachCache[newID]=attachEntry,this._attachKeys.remove(oldID),this._attachKeys.push(newID));var entry=this._dataCache[oldID];this._dataCache[oldID]=void 0,this._dataCache[newID]=entry,this._dataKeys.remove(oldID),this._dataKeys.push(newID),attach.changeID(newID)}},_isPreviewData:function _isPreviewDataFn(data){for(var props=this.getPreviewProperties(),i=0;i<props.length;++i){var desc=this.getPropertyDescriptor(props[i]);if(!desc.isOpt&&!data.hasOwnProperty(props[i]))return!1}return!0},_isFullData:function _isFullDataFn(data){for(var props=this.getEntryProperties(),i=0;i<props.length;++i){var desc=this.getPropertyDescriptor(props[i]);if(!desc.isOpt&&!data.hasOwnProperty(props[i]))return!1}return!0},cacheData:function cacheDataFn(key,data,isUpdate){DETAILED_STATS&&this.__Stats.cacheWrites++;var oldData=this._dataCache[key];if(this._dataCache[key]=data,oldData?DETAILED_STATS&&this.__Stats.cacheUpdates++:this._dataKeys.push(key),this._attachCache[key]){var attach=this._attachCache[key],loadState=this._getPluginLoadType(data);try{g.PAssert(2624,loadState,"Must either contain valid preview or full data")}catch(PERR){g.reportError(PERR)}attach.notifyDataLoaded(loadState,isUpdate)}},getCacheData:function getCacheDataFn(key){return this._dataCache[key]},isFieldDefined:function isFieldDefinedFn(field){return!!this.getPropertyDescriptor(field)},hasAttachField:function hasAttachFieldFn(attach,field){var hasField=!1,data=this._dataCache[attach.id];try{g.PAssert(2625,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}if(data)if(data.hasOwnProperty(field))hasField=!0;else{var desc=this.getPropertyDescriptor(field);try{g.PAssert(2626,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}desc&&desc.isOpt&&(hasField=!0)}return hasField},getAttachField:function getAttachFieldFn(attach,field){var value,data=this._dataCache[attach.id];try{g.PAssert(2627,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}if(data)if(data.hasOwnProperty(field))value=data[field];else{var desc=this.getPropertyDescriptor(field);try{g.PAssert(2628,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2629,desc.isOpt,"Field must be optional if it is not defined",field)}catch(PERR){g.reportError(PERR)}value=desc?desc.defaultValue:void 0}return value},isAttachFieldDefault:function isAttachFieldDefaultFn(attach,field){var isDefault=!1,data=this._dataCache[attach.id];try{g.PAssert(2630,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}if(data){var desc=this.getPropertyDescriptor(field);try{g.PAssert(2631,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}data.hasOwnProperty(field)?desc&&desc.isOpt&&desc.defaultValue===data[field]&&(isDefault=!0):desc&&desc.isOpt&&(isDefault=!0)}return isDefault},fieldNeedsWrite:function fieldNeedsWriteFn(attach,field,value){var data=this._dataCache[attach.id];try{g.PAssert(2632,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}return this.dataFieldNeedsWrite(data,field,value)},dataFieldNeedsWrite:function dataFieldNeedsWriteFn(data,field,value){var needsWrite=!1;if(data){var desc=this.getPropertyDescriptor(field);try{g.PAssert(2633,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}data.hasOwnProperty(field)?data[field]!==value&&(needsWrite=!0):void 0!==value&&(desc&&desc.isOpt&&desc.defaultValue===value||(needsWrite=!0))}return needsWrite},hasCacheData:function hasCacheDataFn(key){return!!this._dataCache[key]},findCachedItemsByField:function findCachedItemsByFieldFn(field,value,limit){DETAILED_STATS&&this.__Stats.findByField++;for(var matches=[],i=0;i<this._dataKeys.length;i++){var item=this._dataCache[this._dataKeys[i]];if(item[field]===value&&(matches.push(item),matches.length>=limit))break}return matches},findCachedItemsByFn:function findCachedItemsByFnFn(fn,limit){try{g.PAssert(2634,fn,"Must supply a valid match function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2635,g.isFunction(fn),"Match function must be a valid function")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&this.__Stats.findByFn++;for(var matches=[],i=0;i<this._dataKeys.length;i++){var item=this._dataCache[this._dataKeys[i]];if(fn(item)&&(matches.push(item),matches.length>=limit))break}return matches},notifyAttachmentInUse:function notifyAttachmentInUseFn(attach,changeType){try{g.PAssert(2636,this._activeAttachments.indexOf(attach)<0,"Attachment should not already be active")}catch(PERR){g.reportError(PERR)}this._activeAttachments.push(attach),g.isLocalChange(changeType)&&this.usesPreviewCache()&&this.isPreviewCacheAvailable()&&attach.isLoaded()&&this.writeAttachmentToPreviewCache(attach)},notifyAttachmentUpdated:function notifyAttachmentUpdatedFn(attach){this.usesPreviewCache()&&this.isPreviewCacheAvailable()&&attach.isLoaded()&&this.writeAttachmentToPreviewCache(attach)},notifyAttachmentUnused:function notifyAttachmentUnusedFn(attach,changeType){try{g.PAssert(2637,this._activeAttachments.indexOf(attach)>=0,"Attachment should be marked active")}catch(PERR){g.reportError(PERR)}this._activeAttachments.remove(attach),g.isLocalChange(changeType)&&this.usesPreviewCache()&&this.isPreviewCacheAvailable()&&attach.isLoaded()&&this.updatePreviewCache(attach.id,void 0)},getAttachment:function getAttachmentFn(key){try{g.PAssert(2638,key,"Must provide a valid key")}catch(PERR){g.reportError(PERR)}return this._attachCache[key]||(this._attachCache[key]=this._requestAttachment(key),this._attachKeys.push(key)),this._attachCache[key]},getAttachmentEmbedString:function getAttachmentEmbedStringFn(attach){return this._getTextForItem(attach)},getAttachmentTitleString:function getAttachmentTitleStringFn(attach){return this.getUnstyledText(attach)},_getTextForItem:function _getTextForItemFn(item){try{g.PAssert(2639,item,"Must pass in a valid item to get text for")}catch(PERR){g.reportError(PERR)}return window.EmbedAttachChar+"p:"+this.id+",id:"+item.id+window.EmbedAttachChar},_requestAttachment:function _requestAttachmentFn(key){try{g.PAssert(2640,key,"Must provide a valid key")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&this.__Stats.createdAttachments++;var newAttach=new VMAttachment(this,key);return newAttach},releaseAttachment:function releaseAttachmentFn(attach){},registerPreviewCache:function registerPreviewCacheFn(){var remoteCache=gdata.ensureCache(this._previewCache);gdata.requestNotifyWhenAvailable(this.serviceRemoteRequestsFromPreview.bind(this)),remoteCache||gdata.requestNotifyWhenAvailable(this.writeActiveAttachmentsToPreviewCache.bind(this))},isPreviewCacheAvailable:function isPreviewCacheAvailableFn(){return DETAILED_STATS&&this.__Stats.previewCacheIsAvailable++,gdata.isCacheAvailable(this._previewCache)},updatePreviewCache:function updatePreviewCacheFn(key,value){try{g.PAssert(2641,g.isString(key),"Key must be a valid string")}catch(PERR){g.reportError(PERR)}return DETAILED_STATS&&this.__Stats.previewCacheUpdate++,gdata.updateCache(this._previewCache,key,value)},queryPreviewCache:function queryPreviewCacheFn(key){try{g.PAssert(2642,g.isString(key),"Key must be a valid string")}catch(PERR){g.reportError(PERR)}return DETAILED_STATS&&this.__Stats.previewCacheQuery++,gdata.queryCache(this._previewCache,key)},onPreviewCacheChange:function onPreviewCacheChangeFn(type,id,data){switch(type){case DataChangeType.Add:break;case DataChangeType.Remove:break;case DataChangeType.Change:break;default:try{g.PAssert(2643,!1,"Invalid or unhandled DataChangeType: ",type)}catch(PERR){g.reportError(PERR)}}log("Preview Cache Change: ",arguments)},writeActiveAttachmentsToPreviewCache:function writeActiveAttachmentsToPreviewCacheFn(){for(var i=0;i<this._activeAttachments.length;++i){var attach=this._activeAttachments[i];attach.isLoaded()&&this.writeAttachmentToPreviewCache(attach)}},writeAttachmentToPreviewCache:function writeAttachmentToPreviewCacheFn(attach){try{g.PAssert(2644,attach.isLoaded(),"Attachments should have data before saving them")}catch(PERR){g.reportError(PERR)}for(var previewProps=this.getPreviewProperties(),oldData=this.queryPreviewCache(attach.id),doPreviewUpdate=!oldData,i=0;!doPreviewUpdate&&i<previewProps.length;++i){var field=previewProps[i];attach.fieldNeedsWrite(field,oldData[field])&&(doPreviewUpdate=!0)}doPreviewUpdate&&this.updatePreviewCache(attach.id,this.serializePreview(attach))},dataHasChanged:function dataHasChangedFn(oldData,newData){for(var hasChanged=!oldData,props=this.getEntryProperties(),i=0;!hasChanged&&i<props.length;++i){var field=props[i];this.dataFieldNeedsWrite(oldData,field,newData[field])&&(hasChanged=!0)}return hasChanged},serviceRemoteRequestsFromPreview:function serviceRemoteRequestsFromPreviewFn(){for(var i=0;i<this._pendingRequests.length;++i){var requestData=this._pendingRequests[i];if(!g.isFunction(requestData)&&requestData.attach){var previewData=this.queryPreviewCache(requestData.attach.id);previewData&&this.cacheData(requestData.attach.id,previewData)}}for(var i=0;i<this._activeAttachments.length;++i){var attach=this._activeAttachments[i];if(!attach.isLoaded()){var previewData=this.queryPreviewCache(attach.id);previewData&&this.cacheData(attach.id,previewData)}}},usesPreviewCache:function usesPreviewCacheFn(){return!1},matchAttachment:function matchAttachmentFn(attach,text){try{g.PAssert(2645,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},getStyledText:function getStyledTextFn(attach){try{g.PAssert(2646,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},getUnstyledText:function getUnstyledTextFn(attach){try{g.PAssert(2647,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},getBlockedText:function getBlockedTextFn(attach){return"Blocked"},useRenderer:function useRendererFn(type,id){var renderer=g.vmMain.pluginManager.useRenderer(type,id),fnName;switch(type){case PluginRenderTypes.StyledText:fnName="getStyledText";break;case PluginRenderTypes.UnstyledText:fnName="getUnstyledText";break;case PluginRenderTypes.AutocompleteText:fnName="getItemStyledText";break;default:try{g.PAssert(2648,!1,"Unknown plugin renderer type")}catch(PERR){g.reportError(PERR)}}fnName&&(this[fnName]=renderer)},createDisplayElement:function createDisplayElementFn(attach,padBefore,padAfter){var content;content=this.isPluginBlocked()?this.getBlockedText(attach):this.getStyledText(attach);var styles;return styles=attach.isLoaded()?this.getAttachmentClass(attach):"",padBefore&&(styles+=" padB"),padAfter&&(styles+=" padA"),'<p class="plugin '+styles+'" plugin="'+this.id+'" plugin-id="'+attach.id+'" contenteditable=false>'+content+"</p>"},getAttachmentClass:function getAttachmentClassFn(attach){return""},isPluginBlocked:function isPluginBlockedFn(){return!g.billingManager.hasPremiumFeatures()},_displayMissingProperties:function _displayMissingPropertiesFn(attach,data){try{g.PAssert(2649,!1,"This function is DEBUG only")}catch(PERR){g.reportError(PERR)}var isMissingProps=!1,props=this.getPreviewProperties();console.log("Displaying Missing Properties: ",attach.id);for(var i=0;i<props.length;++i){var desc=this.getPropertyDescriptor(props[i]);desc.isOpt||data.hasOwnProperty(props[i])||(console.log(" Missing Property: ",props[i]),isMissingProps=!0)}try{g.PAssert(2650,isMissingProps,"Must be missing props to run this")}catch(PERR){g.reportError(PERR)}},_getPluginLoadType:function _getPluginLoadTypeFn(data){try{g.PAssert(2651,data,"Must be querying loaded data for load state with valid data")}catch(PERR){g.reportError(PERR)}var loadState;return this._isPreviewData(data)&&(loadState=this._isFullData(data)?PluginLoad.Full:PluginLoad.Preview),loadState},requestData:function requestDataFn(attach){DETAILED_STATS&&this.__Stats.requestData++;var cacheData=this.getCacheData(attach.id);if(cacheData){var loadState=this._getPluginLoadType(cacheData);if(loadState)attach.notifyDataLoaded(loadState,!1);else try{g.PAssert(2652,attach.isLocalOnlyAttachment(),"If load state is not a valid preview or full data load, must be a local only item")}catch(PERR){g.reportError(PERR)}}else if(!attach.isLocalOnlyAttachment()){var loadState;if(this.isPreviewCacheAvailable()){var previewData=this.queryPreviewCache(attach.id);previewData&&(this.cacheData(attach.id,previewData),loadState=this._getPluginLoadType(previewData),loadState&&attach.notifyDataLoaded(loadState,!1))}this.allowRemoteRequests()&&loadState!==PluginLoad.Full&&this.getRemoteAttachmentData(attach)}},_handleRequestResponse:function _handleRequestResponseFn(attach){this._numOutstandingReqs--},_queueRemoteRequest:function _queueRemoteRequestFn(request,successCB,failureCB,attach,type){try{g.PAssert(2653,request,"Must pass in a valid request object")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2654,request.then,"Request object must be thenable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2655,successCB,"Must supply a callback for request success")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2656,g.isFunction(successCB),"Success callback must be a valid function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2657,failureCB,"Must supply a callback for request failure")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2658,g.isFunction(failureCB),"Failure callback must be a valid function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2659,type,"Request type must be specified")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2660,!attach||!attach.isLocalOnlyAttachment(),"Must either specify a valid remote attachment or none at all",attach?attach.id:"UNDEFINED")}catch(PERR){g.reportError(PERR)}var reqObj={plugin:this,attach:attach,request:request,successCB:successCB,failureCB:failureCB,type:type};this._pendingRequests.push(reqObj),g.vmMain.pluginManager.notifyHasPendingRemoteRequest()},_queueDeferredRemoteRequest:function _queueDeferredRemoteRequestFn(fn){this._numDeferredReqs++,this._pendingRequests.push(fn)},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach){try{g.PAssert(2661,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},_pumpRequestQueue:function _pumpRequestQueueFn(maxAllowed,cb){var numRequested=0,numProcessed=0,batchCount=0,availReqs=maxAllowed-this._numOutstandingReqs;try{g.PAssert(2662,availReqs>=0,"Should never have more than max outstanding requests for a given plugin")}catch(PERR){g.reportError(PERR)}var batch;availReqs>1&&this._pendingRequests.length>1&&(batch=this.createBatch());for(var i=0;availReqs>0&&i<this._pendingRequests.length&&maxBatchSize>batchCount;++i){var requestData=this._pendingRequests[i];if(g.isFunction(requestData))requestData(),this._numDeferredReqs--,numProcessed++;else{var doPerformRequest=!0;if(requestData.attach&&(requestData.attach.needsRemoteData()?requestData.attach.notifyDataRequested():doPerformRequest=!1),doPerformRequest){var wasBatched=this._runRemoteRequest(batch,requestData,cb);DETAILED_STATS&&this.__Stats.remoteRequests++,wasBatched&&0!==batchCount||(numRequested++,availReqs--,this._numOutstandingReqs++),wasBatched&&batchCount++}else DETAILED_STATS&&this.__Stats.canceledRequests++;numProcessed++}}if(this._pendingRequests.splice(0,numProcessed),batch){try{g.PAssert(2663,batchCount>1,"Batches should always have multiple items in them")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&this.__Stats.remoteBatches++,this.commitBatch(batch)}return numRequested},_runRemoteRequest:function _runRemoteRequestFn(batch,requestData,cb){var wasBatched=!1;return batch&&(batch.add(requestData.request),wasBatched=!0),requestData.request.then(function(response){requestData.successCB(response.result),cb(requestData.attach,requestData.plugin)},function(response){log("Remote request failed!",response),requestData.attach&&requestData.attach.notifyDataRequestFailed(),requestData.failureCB(response.result),cb(requestData.attach,requestData.plugin)}),wasBatched},createPaginationToken:function createPaginationTokenFn(nextPageToken,q,maxResults,entryCB,doneCB){try{g.PAssert(2664,nextPageToken,"Must create the pagination token with a valid next page token")}catch(PERR){g.reportError(PERR)}return{nextPageToken:nextPageToken,q:q,maxResults:maxResults,entryCB:entryCB,doneCB:doneCB}},updatePaginationToken:function updatePaginationTokenFn(oldToken,nextPageToken){try{g.PAssert(2665,oldToken,"Must specify a valid token to update")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2666,nextPageToken,"Must update the pagination token with a valid next page token")}catch(PERR){g.reportError(PERR)}return oldToken.nextPageToken=nextPageToken,oldToken},createBatch:function createBatchFn(){return gapi.client.newBatch()},commitBatch:function commitBatchFn(batch){try{g.PAssert(2667,batch,"Batch to commit must be specified")}catch(PERR){g.reportError(PERR)}batch.then(function(response){log("Batch completed: ",arguments)},function(){log("Remote batch failed: ",arguments)})},_serializeObj:function _serializeObjFn(entry,props){try{g.PAssert(2668,entry,"Must specify a valid entry to serialize")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2669,props,"Must provide a valid property list")}catch(PERR){g.reportError(PERR)}for(var outObj={},i=0;i<props.length;++i){var prop=props[i],desc=this.getPropertyDescriptor(prop);desc.isOpt&&desc.defaultValue===entry[prop]||(outObj[prop]=entry[prop])}var blobData=this.getBlobData(entry);return blobData&&(outObj._blob=blobData),outObj},serializeEntry:function serializeEntryFn(attach){var props=this.getEntryProperties(),entry=this.getCacheData(attach.id);return entry?this._serializeObj(entry,props):void 0},serializePreview:function serializePreviewFn(attach){var props=this.getPreviewProperties(),entry=this.getCacheData(attach.id);return entry?this._serializeObj(entry,props):void 0},registerAutocomplete:function registerAutocompleteFn(){if(g.autocomplete&&!this._registeredAutocomplete){var prefixes=this.getAutocompletePrefixes();if(prefixes){g.autocomplete.registerProvider(this._acProviderId,this);for(var i=0;i<prefixes.length;++i)g.autocomplete.registerPrefix(this._acProviderId,prefixes[i])}this._registeredAutocomplete=!0}},unregisterAutocomplete:function unregisterAutocompleteFn(){g.autocomplete&&this._registeredAutocomplete},declareProperty:function declarePropertyFn(name,requiredFor,isOpt,defaultValue){try{g.PAssert(2670,!this._propertyDescriptors[name],"Should not declare the same property twice")}catch(PERR){g.reportError(PERR)}requiredFor=requiredFor||PluginLoad.Preview|PluginLoad.Full,isOpt=isOpt||!1,g.isFlagSet(requiredFor,PluginLoad.Preview)&&this._previewProperties.push(name),g.isFlagSet(requiredFor,PluginLoad.Full)&&this._entryProperties.push(name),this._propertyDescriptors[name]={isOpt:isOpt,defaultValue:defaultValue}},getEntryProperties:function getEntryPropertiesFn(){return this._entryProperties},getPreviewProperties:function getPreviewPropertiesFn(){return this._previewProperties},getPropertyDescriptor:function getPropertyDescriptorFn(name){return this._propertyDescriptors[name]},getBlobData:function getBlobDataFn(entry){return void 0},load:function loadFn(){this._loadedInitialData||!g.isDemoMode()&&!this.hasActiveDataPanes()||this.isPluginBlocked()||this.loadInitialData()},loadInitialData:function loadInitialDataFn(){try{g.PAssert(2671,!this._loadedInitialData,"Do not make multiple requests for initial data load")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2672,!this.isPluginBlocked(),"Should not load data for blocked plugins")}catch(PERR){g.reportError(PERR)}this._loadedInitialData=!0},finishedLoading:function finishedLoadingFn(){g.fireCustomEvent(this.loadedEvent)},getDataPane:function getDataPaneFn(){return void 0},getPaneIcon:function getPaneIconFn(){return"icon-question2"},useItemStore:function useItemStoreFn(){return void 0},getDefaultItemStore:function getDefaultItemStoreFn(){try{g.PAssert(2673,this.useItemStore(),"Must request an item store")}catch(PERR){g.reportError(PERR)}return this._defaultItemStore},getActiveItemStore:function getActiveItemStoreFn(paneID){try{g.PAssert(2674,paneID,"Must specify a valid paneID to get the item store for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2675,this.useItemStore(),"Must request item store usage")}catch(PERR){g.reportError(PERR)}var activeStore=this._activeItemStore[paneID];return activeStore?activeStore:this._defaultItemStore},allowRemoteRequests:function allowRemoteRequestsFn(){return!1},handleDropEvent:function handleDropEventFn(e,cb){return!1},handleTapEvent:function handleTapEventFn(vmli,id,e){return!1},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return void 0},notifyPaneCreated:function notifyPaneCreatedFn(){this._numActivePanes++,!this.isActive()||this._loadedInitialData||this.isPluginBlocked()||(this.areDependenciesLoaded()?this.loadInitialData():this.loadRemoteAPIs())},notifyPaneDestroyed:function notifyPaneDestroyedFn(){this._numActivePanes--;try{g.PAssert(2678,this._numActivePanes>=0,"Should never have negative active panes")}catch(PERR){g.reportError(PERR)}},hasActiveDataPanes:function hasActiveDataPanesFn(){return this._numActivePanes>0},_createSearchBucket:function _createSearchBucketFn(search){var searchBucketID,pastSearchID=this._pastSearches[search];if(pastSearchID&&this._searchBuckets[pastSearchID])searchBucketID=pastSearchID;else{searchBucketID=g.generateTempId(),this._pastSearches[search]=searchBucketID;var bucket=d.registerItemStore(searchBucketID,this);bucket.createRoot(g.generateTempId(),"Search Results"),this._searchBuckets[searchBucketID]=bucket}return searchBucketID},_destroySearchBucket:function _destroySearchBucketFn(bucketID){var bucket=this._searchBuckets[bucketID];bucket.clearStore()},createSearchResultItem:function createSearchResultItemFn(bucketID,itemID,text,props){try{g.PAssert(2679,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2680,this._searchBuckets[bucketID],"Must have a valid search bucket to match id")}catch(PERR){g.reportError(PERR)}var bucket=this._searchBuckets[bucketID],rootItem=bucket.getRoot(),searchItem=bucket.createItem(itemID,text,rootItem.id,props);rootItem.insertItem(searchItem)},swapInSearchBucket:function swapInSearchBucketFn(bucketID,paneID){try{g.PAssert(2681,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}var pane=g.vmMain.paneManager.getPaneById(paneID),bucket=this._searchBuckets[bucketID],root=bucket.getRoot();pane.setRootItem(root),this._activeItemStore[paneID]=bucket,this._activeSearchBucket[paneID]=bucket},swapOutSearchBucket:function swapOutSearchBucketFn(bucketID,paneID){try{g.PAssert(2682,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}var pane=g.vmMain.paneManager.getPaneById(paneID),oldBucket=this._searchBuckets[bucketID];try{g.PAssert(2683,oldBucket,"Must have a valid bucket we are swapping from")}catch(PERR){g.reportError(PERR)}var oldRoot=pane.getRootItem();try{g.PAssert(2684,oldRoot===oldBucket.getRoot(),"Current root for pane should match bucket root")}catch(PERR){g.reportError(PERR)}var newRoot=this._defaultItemStore.getRoot();pane.setRootItem(newRoot),this._destroySearchBucket(bucketID),this._activeItemStore[paneID]=void 0,this._activeSearchBucket[paneID]=void 0},runSearch:function runSearchFn(search,paneID){try{g.PAssert(2685,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}var searchBucketID=this._createSearchBucket(search);this.runRemoteSearch(search,searchBucketID,paneID)},getSearchRoot:function getSearchRootFn(bucketID){var bucket=this._searchBuckets[bucketID];try{g.PAssert(2686,bucket,"Should always reference a valid search bucket")}catch(PERR){g.reportError(PERR)}return bucket.getRoot()},runRemoteSearch:function runRemoteSearchFn(search,searchBucketID,paneID){try{g.PAssert(2687,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},clearSearch:function clearSearchFn(paneID){this._activeSearchBucket[paneID]&&this.swapOutSearchBucket(this._activeSearchBucket[paneID].id,paneID)},refreshCurrentView:function refreshCurrentViewFn(paneID){try{g.PAssert(2688,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}}},util.defineBase(VMPlugin),VMPlugin}),define("plugins/Plugin_Drive_Pane",["ko","globals","util","data","VMPane"],function(ko,g,util,d,VMPane){function Plugin_Drive_Pane(p){this.plugin=g.vmMain.pluginManager.getPlugin(PluginID.Drive),this._super.constructor.call(this,p),this.type=this.plugin._paneType,this.paneClass="paneNormal panePlugin paneDrive noComplete",this.dropEffect=DropEffect.Copy,this.isWriteable=!1,this.overrideCopyBehavior=!1,this.supportCollapsing=!0,this.supportOffline=!1,this.supportPerformArchive=!1,this.supportDataRefresh=!0,this.supportPagination=!0,this.initDrive()}var Plugin_Drive_PaneFns={initDrive:function initDriveFn(){},getRootItem:function getRootItemFn(){var itemStore=this.plugin.getActiveItemStore(this.id);return itemStore?itemStore.getRoot():void 0},showLoadMore:function showLoadMoreFn(){return this.item().hasPaginationToken()},templateName:function templateNameFn(pane,b){return"template-pane-normal"},searchACName:function searchACNameFn(){return"template-search-ac-remote"},getPaneIcon:function getPaneIconFn(){return this.plugin.getPaneIcon()},requestDemandLoadData:function requestDemandLoadDataFn(item){this.plugin.requestDemandLoadData(this.id,item)},requestDataPage:function requestDataPageFn(item){this.plugin.requestDataPage(item)},updateContents:function updateContentsFn(){this._super.updateContents.call(this)},onAfterLoaded:function onAfterLoadedFn(){this._super.onAfterLoaded.call(this)},onClose:function onCloseFn(){this._super.onClose.call(this)},onTapRunSearch:function onTapRunSearchFn(e,search){this.plugin.runSearch(search,this.id)},onTapClearSearch:function onTapClearSearchFn(e){this.plugin.clearSearch(this.id)},refreshPaneData:function refreshPaneDataFn(){this.plugin.refreshCurrentView(this.id)},notifyDropFrom:function notifyDropFromFn(droppedItem){this.plugin.notifyDropFrom(droppedItem)}};return util.inherit(VMPane,Plugin_Drive_Pane),util.extend(Plugin_Drive_Pane.prototype,Plugin_Drive_PaneFns),Plugin_Drive_Pane}),define("plugins/Plugin_Drive",["globals","util","platform","goog","PluginRenderer","VMPlugin","plugins/Plugin_Drive_Pane"],function(g,util,platform,goog,PluginRenderer,VMPlugin,Plugin_Drive_Pane){function Plugin_Drive(){this._super.constructor.call(this,PluginID.Drive,"Drive"),this.autocompleteReplace=!0,this.registerSetting("writeAccess",!0),this.registerSetting("lastChangeId"),this.declareProperty("title"),this.declareProperty("mimeType"),this.declareProperty("alternateLink",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("iconLink",PluginLoad.Preview|PluginLoad.Full,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.DriveFile)}var MimeTypes={Folder:"application/vnd.google-apps.folder",Sheet:"application/vnd.google-apps.spreadsheet",Slide:"application/vnd.google-apps.presentation",Document:"application/vnd.google-apps.document",Moodo:goog.REALTIME_MIMETYPE+"."+goog.APP_ID,ImagePng:"image/png",ImageJpg:"image/jpg"},RequestType={SingleFile:1,FolderStruct:2,SubFolder:3,Search:4,DataPage:5,ChangeList:6},openUrl="https://drive.google.com/open?id=",DEFAULT_FOLDER_MAX_RESULTS=999,DEFAULT_FILE_MAX_RESULTS=50,MAX_FILE_UPLOAD_SIZE=536870912,boundary="-------314159265358979323846",delimiter="\r\n--"+boundary+"\r\n",close_delim="\r\n--"+boundary+"--",requestFields="id,mimeType,title,alternateLink,iconLink,parents(id,isRoot)",Plugin_DriveFns={getDataPane:function getDataPaneFn(){try{g.PAssert(2689,!!this.getPaneIcon(),"Should have a pane icon specified")}catch(PERR){g.reportError(PERR)}return Plugin_Drive_Pane},getPaneIcon:function getPaneIconFn(){return"icon-drive-file"},useItemStore:function useItemStoreFn(){return"Google Drive"},allowRemoteRequests:function allowRemoteRequestsFn(){return!0},loadInitialData:function loadInitialDataFn(){this._super.loadInitialData.call(this);var firstRequestLoaded=!1,itemStore=this.getDefaultItemStore(),item=itemStore.getRoot(),qRootItems="trashed=false and 'root' in parents and mimeType != '"+MimeTypes.Moodo+"'";this._requestRemoteFiles(RequestType.SubFolder,item,qRootItems,DEFAULT_FILE_MAX_RESULTS,function(entry){if(entry.title!==goog.DefaultFolderTitle){this._addRemoteEntry(entry);var vmli=itemStore.createItem(entry.id,this._getTextForItem(entry),item.id,{demandLoadChildren:entry.mimeType===MimeTypes.Folder});item.insertSorted(vmli,this.sortFn)}}.bind(this),function(){firstRequestLoaded||(firstRequestLoaded=!0,this.finishedLoading())}.bind(this))},performChangeListUpdate:function performChangeListUpdateFn(){var maxChangeId=-1,startChangeId=this.getSetting("lastChangeId");this._requestChangeList(startChangeId,function(entry){try{g.PAssert(2690,entry.id>startChangeId,"Must have correctly ordered change entry")}catch(PERR){g.reportError(PERR)}maxChangeId=entry.id,entry.fileId&&this._handleChange(entry)}.bind(this),function(success){success&&-1!=maxChangeId&&this.setSetting("lastChangeId",maxChangeId)}.bind(this))},_handleChange:function _handleChangeFn(change){log("Change Entry: ",change);var cacheEntry=this.getCacheData(change.fileId);cacheEntry&&(change.deleted||this.dataHasChanged(cacheEntry,change.file)&&this.cacheData(change.file.id,change.file),g.vmMain.paneManager.runForEachPane(function(pane){var itemStore=this.getActiveItemStore(pane.id),item=itemStore.getItem(change.fileId);
if(item&&item.parent())if(change.deleted)item.parent().removeChild(item);else{var oldParent=item.parent(),newParent;if(change.file.parents.length>0&&change.file.parents[0]&&oldParent.id!==change.file.parents[0].id){var parentInfo=change.file.parents[0];newParent=parentInfo.isRoot?itemStore.getRoot():itemStore.getItem(change.file.parents[0].id)}try{g.PAssert(2691,newParent,"Must have a valid parent to move item to")}catch(PERR){g.reportError(PERR)}newParent!==oldParent&&(oldParent.removeChild(item),newParent&&(newParent.insertSorted(item,this.sortFn),item.parent(newParent)))}}.bind(this),this._paneType))},requestDemandLoadData:function requestDemandLoadDataFn(paneID,item){try{g.PAssert(2692,1===item.getNumAttachments(),"Should only have a single attachment for Drive Pane VMLIs")}catch(PERR){g.reportError(PERR)}var attach=item.getAttachments()[0],q="trashed=false and '"+attach.id+"' in parents and mimeType != '"+MimeTypes.Folder+"' and mimeType != '"+MimeTypes.Moodo+"'",itemStore=this.getActiveItemStore(paneID);this._requestRemoteFiles(RequestType.SubFolder,item,q,DEFAULT_FILE_MAX_RESULTS,function(entry){if(!this.hasCacheData(entry.id)){this._addRemoteEntry(entry);var vmli=itemStore.createItem(entry.id,this._getTextForItem(entry),item.id,{demandLoadChildren:entry.mimeType===MimeTypes.Folder});item.insertSorted(vmli,this.sortFn)}}.bind(this),function(success){success||item.hasPaginationToken()||item.notifyLoadDataFailed()}.bind(this))},requestDataPage:function requestDataPageFn(item){this._requestRemoteFiles(RequestType.DataPage,item)},runRemoteSearch:function runRemoteSearchFn(search,searchBucketID,paneID){var entryCB=this.addSearchResultToBucket.bind(this,searchBucketID),doneCB=this.swapInSearchBucket.bind(this,searchBucketID,paneID),q="trashed=false and title contains '"+search+"' and mimeType != '"+MimeTypes.Folder+"' and mimeType != '"+MimeTypes.Moodo+"'";this._requestRemoteFiles(RequestType.Search,this.getSearchRoot(searchBucketID),DEFAULT_FILE_MAX_RESULTS,q,entryCB,doneCB)},addSearchResultToBucket:function addSearchResultToBucketFn(bucketID,result){var entry=this._createRemoteEntry(result);this.cacheData(entry.id,entry),this.createSearchResultItem(bucketID,entry.id,this._getTextForItem(entry))},_requestRemoteFiles:function _requestRemoteFilesFn(type,reqItem,q,maxResults,entryCB,doneCB){var paginationToken;reqItem&&reqItem.hasPaginationToken()&&(paginationToken=reqItem.beginDataPageLoad(),q=paginationToken.q,maxResults=paginationToken.maxResults,entryCB=paginationToken.entryCB,doneCB=paginationToken.doneCB),maxResults=maxResults||DEFAULT_FILE_MAX_RESULTS;try{g.PAssert(2693,entryCB&&g.isFunction(entryCB),"Must define a valid entry callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2694,doneCB&&g.isFunction(doneCB),"Must define a valid done callback")}catch(PERR){g.reportError(PERR)}var request=gapi.client.drive.files.list({fields:"items,nextPageToken",maxResults:maxResults,q:q,pageToken:paginationToken?paginationToken.nextPageToken:void 0}),successCB=function(results){if(results.items)for(var i=0;i<results.items.length;++i)entryCB(results.items[i]);var newPaginationToken;results.nextPageToken&&(newPaginationToken=paginationToken?this.updatePaginationToken(paginationToken,results.nextPageToken):this.createPaginationToken(results.nextPageToken,q,maxResults,entryCB,doneCB)),reqItem&&paginationToken?reqItem.endDataPageLoad(newPaginationToken):newPaginationToken&&reqItem.setPaginationToken(newPaginationToken),doneCB(!0)}.bind(this),failureCB=function(results){paginationToken&&reqItem.endDataPageLoad(paginationToken),doneCB(!1)}.bind(this);this._queueRemoteRequest(request,successCB,failureCB,void 0,type)},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach){function _doAction(){var request=gapi.client.drive.files.get({fileId:attach.id,fields:requestFields}),successCB=function(result){try{g.PAssert(2695,!result||result.id===attach.id,"If valid result, attachment should match remote file ID")}catch(PERR){g.reportError(PERR)}result&&this._addRemoteEntry(result)}.bind(this),failureCB=function(result){attach.notifyDataRequestFailed()}.bind(this);this._queueRemoteRequest(request,successCB,failureCB,attach,RequestType.SingleFile)}window.gapi&&window.gapi.client&&window.gapi.client.drive?_doAction.bind(this)():this._queueDeferredRemoteRequest(_doAction.bind(this))},_requestChangeList:function _requestChangeListFn(startChangeId,entryCB,doneCB){var MAX_CHANGE_ID=1e8;if(startChangeId){try{g.PAssert(2696,entryCB,"Must supply a valid entry CB")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2697,doneCB,"Must provide a valid done CB")}catch(PERR){g.reportError(PERR)}var request=gapi.client.drive.changes.list({includeDeleted:!0,includeSubscribed:!0,maxResults:500,startChangeId:+startChangeId+1}),successCB=function(results){for(var newMaxID=startChangeId,i=0;i<results.items.length;++i){var entry=results.items[i];try{g.PAssert(2698,entry,"Must have a valid change entry")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2699,parseInt(entry.id)<MAX_CHANGE_ID,"Must have a valid entry ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2700,entry.id>newMaxID,"Must be ordered monotonic increasing")}catch(PERR){g.reportError(PERR)}newMaxID=entry.id,entryCB(entry)}results.nextPageToken?this._requestChangeList(newMaxID,entryCB,doneCB):doneCB(!0)}.bind(this),failureCB=function(results){doneCB(!1)}}else var request=gapi.client.drive.changes.list({includeDeleted:!0,includeSubscribed:!0,maxResults:1,startChangeId:MAX_CHANGE_ID}),successCB=function(results){var lastChangeId=results.largestChangeId;entryCB({id:lastChangeId}),doneCB(!0)},failureCB=function(results){doneCB(!1)};this._queueRemoteRequest(request,successCB,failureCB,void 0,RequestType.ChangeList)},_createRemoteEntry:function _createRemoteEntryFn(info){var entry={id:info.id,mimeType:info.mimeType,title:info.title,titleLower:info.title.toLowerCase(),alternateLink:info.alternateLink,iconLink:info.iconLink,parents:info.parents};return this._isFolder(entry)&&(entry.items=[]),entry},_addRemoteEntry:function _addRemoteEntryFn(info){var entry=this._createRemoteEntry(info);this.cacheData(entry.id,entry)},createEntryFromLocal:function createEntryFromLocalFn(info){return this._isFolder(info)&&(info.items=[]),info.titleLower=info.title.toLowerCase(),info},_isFolder:function _isFolderFn(data){return data.mimeType===MimeTypes.Folder},sortFn:function sortFnFn(left,right){return left.getAttachment(0).getTitleString().localeCompare(right.getAttachment(0).getTitleString())},getAttachmentClass:function getAttachmentClassFn(attach){var mime=attach.getField("mimeType"),text="plugin_drive "+this.getMimetypeClass(mime);return text},getMimetypeClass:function getMimetypeClassFn(mimeType){switch(mimeType){case MimeTypes.Folder:return"plugin_drive_folder";case MimeTypes.Sheet:return"plugin_drive_sheet";case MimeTypes.Slide:return"plugin_drive_slide";case MimeTypes.Document:return"plugin_drive_doc";case MimeTypes.ImagePng:case MimeTypes.ImageJpg:return"plugin_drive_image";default:return"plugin_drive_unk"}},googleScopes:function googleScopesFn(options){return options.writeAccess?[GScope.DriveFull]:[GScope.DriveMetadataRO]},getDependencies:function getDependenciesFn(){return[PluginDependency.PremiumSub,PluginDependency.DriveAPI,PluginDependency.GoogleLogin]},isDependencyLoaded:function isDependencyLoadedFn(dep,data){var isLoaded=!1;switch(dep){case PluginDependency.GoogleLogin:data&&(data.indexOf(GScope.DriveMetadataRO)>=0||data.indexOf(GScope.DriveFull))&&(isLoaded=!0);break;default:isLoaded=!0}return isLoaded},loadRemoteAPIs:function loadRemoteAPIsFn(){function loadDriveAPI(){gapi.client.load("drive","v2",function(){g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.DriveAPI)})}window.gapi&&window.gapi.client?loadDriveAPI():g.addCustomEventListener("gapiLoaded",loadDriveAPI)},handleDropEvent:function handleDropEventFn(e,cb){var url=e.dataTransfer.getData("text/uri-list");if(url&&url.startsWith(openUrl)){var str=url.replace(openUrl,""),andIndex=str.indexOf("&"),id=str.substr(0,andIndex),attach=this.getAttachment(id);return cb(attach.getEmbedString()),!0}if(e.dataTransfer.files&&e.dataTransfer.files.length>0){for(var i=0,f;f=e.dataTransfer.files[i];i++)this._handleDropFile(f,e,cb);return!0}return!1},_handleDropFile:function _handleDropFileFn(file,e,cb){for(var matched=!1,matches=this.findCachedItemsByField("title",file.name),dropPane=g.getPaneForElement(e.srcElement),i=0;i<matches.length;++i){var item=matches[i];if(item.fileSize===file.size){var attach=this.getAttachment(item.id);dropPane&&dropPane.isWriteable&&dropPane.plugin!==this&&cb(this.getAttachmentEmbedString(attach),!1),matched=!0;break}}if(!matched){var itemID=g.generateTempId();this.cacheData(itemID,{title:file.name});var attach=this.getAttachment(itemID),doShare=dropPane&&dropPane.isWriteable&&dropPane.plugin!==this;this._upload(file,attach,doShare,cb),dropPane&&dropPane.isWriteable&&dropPane.plugin!==this&&cb(this.getAttachmentEmbedString(attach),!0);var itemStore=this.getDefaultItemStore(),rootItem=itemStore.getRoot(),newDriveItem=itemStore.createItem(attach.id,this.getAttachmentEmbedString(attach),rootItem.id);rootItem.insertSorted(newDriveItem,this.sortFn)}},notifyDropFrom:function notifyDropFromFn(droppedItem){try{g.PAssert(2701,droppedItem,"Must have a valid item that was dropped")}catch(PERR){g.reportError(PERR)}g.isDemoMode()||goog.shareFile(droppedItem.id,function(success){success||g.messageQueue.pushMessage(MessageID.ShareFailure)})},handleTapEvent:function handleTapEventFn(vmli,id,e){var item=this.getCacheData(id);if(item){if(this.isPluginPane(g.focusedPane)&&this._isFolder(item))g.vmMain.zoomin(vmli);else if(!g.isDemoMode())if(item.alternateLink)g.openUrl(item.alternateLink,e);else{var driveURL="https://docs.google.com/file/d/"+item.id+"/edit";g.openUrl(driveURL,e)}return!0}return!1},supportOfflineCache:function supportOfflineCacheFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},matchAttachment:function matchAttachmentFn(attach,text){return attach.getField("titleLower").indexOf(text)>=0},_upload:function _uploadFn(fileData,attach,doShare){gapi.client.load("drive","v2",function(){var reader=new FileReader;reader.readAsBinaryString(fileData),reader.onload=function(e){var contentType=fileData.type||"application/octet-stream";fileData.size>MAX_FILE_UPLOAD_SIZE&&log("Warning: Uploading large file"),goog.getShareFolder(function(folderID){if(folderID){var metadata={title:fileData.name,mimeType:contentType};doShare&&(metadata.parents=[{id:folderID}]);var base64Data=btoa(reader.result),body=delimiter+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+delimiter+"Content-Type: "+contentType+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+base64Data+close_delim,request=gapi.client.request({path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+boundary+'"'},body:body}),callback=function(file){this.changeID(attach,attach.id,file.id),this._addRemoteEntry(file)}.bind(this);request.execute(callback)}}.bind(this))}.bind(this)}.bind(this))},findMatchExact:function findMatchExactFn(text){},findMatchLike:function findMatchLikeFn(text,maxCount){var textLower=text.toLowerCase();return this.findCachedItemsByFn(function(item){return item.titleLower.indexOf(textLower)>=0},maxCount)},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return this.getAttachmentEmbedString(item)},getItemTextLength:function getItemTextLengthFn(item){return 1},autocompleteWidth:function autocompleteWidthFn(){return 350},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return["f:","drive:","file:"]}};return util.inherit(VMPlugin,Plugin_Drive),util.extend(Plugin_Drive.prototype,Plugin_DriveFns),Plugin_Drive}),define("plugins/Plugin_Mailbird",["globals","util","platform","goog","VMPlugin"],function(g,util,platform,goog,VMPlugin){function Plugin_Mailbird(){if(this._super.constructor.call(this,PluginID.Mailbird,"Mailbird"),this.autocompleteReplace=!0,this.declareProperty("subject"),this.declareProperty("from"),this.declareProperty("unread",PluginLoad.Runtime,!0),this.declareProperty("snippet",PluginLoad.Runtime,!0),this.declareProperty("provider",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("threadID",PluginLoad.Preview|PluginLoad.Full,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.EmailThread),this.isMailbirdEmbed="mailbird"===platform.embed,this.isMailbirdEmbed){this.setSetting("isEnabled",!0);var nativeInAPI=g.nativeBridge.registerInboundAPI("mailbird");try{g.PAssert(2702,nativeInAPI,"Error creating native inbound API for mailbird")}catch(PERR){g.reportError(PERR)}nativeInAPI&&(nativeInAPI.registerVariable("_prevX"),nativeInAPI.registerVariable("_prevY"),nativeInAPI.registerFunction("dragOver",nativeAPIFns.dragOver,!0),nativeInAPI.registerFunction("drop",nativeAPIFns.drop,!0),nativeInAPI.registerFunction("dragLeave",nativeAPIFns.dragLeave,!0)),this._mailbirdOutAPI=g.nativeBridge.registerOutboundAPI("mailbird");try{g.PAssert(2703,this._mailbirdOutAPI,"Error creating native outbound API for mailbird")}catch(PERR){g.reportError(PERR)}this._mailbirdOutAPI&&this._mailbirdOutAPI.requireFunction("selectConversation")}}var nativeAPIFns={dragOver:function dragOverFn(obj){var element=document.elementFromPoint(obj.x,obj.y);if(element){var diffX=void 0!==this._prevX?obj.x-this._prevX:0,diffY=void 0!==this._prevY?obj.y-this._prevY:0;this._prevX=obj.x,this._prevY=obj.y;var e={clientX:obj.x,clientY:obj.y,diffX:diffX,diffY:diffY,srcElement:element,dataTransfer:{}};g.vmMain.handleDragOver(e)}},drop:function dropFn(obj){var element=document.elementFromPoint(obj.x,obj.y),options={clientX:obj.x,clientY:obj.y,dataTransfer:{getData:function getDataFn(type){if("mailbird/email"===type){var inData={subject:obj.subject,from:obj.from,id:"mailbird_"+obj.id};return obj.gmailID&&(inData.provider="Gmail",inData.threadID=obj.gmailID),inData}}},preventDefault:g.emptyFn,stopPropagation:g.emptyFn};setTimeout(function(){g.vmMain.handleDrop(options)},0)},dragLeave:function dragLeaveFn(){g.vmMain.handleDragLeave()}},Plugin_MailbirdFns={getPaneIcon:function getPaneIconFn(){return"icon-email"},useItemStore:function useItemStoreFn(){return"Mailbird"},_addRemoteEntry:function _addRemoteEntryFn(info){var entry={id:info.id,provider:info.provider,threadID:info.threadID,subject:info.subject,subjectLower:info.subject.toLowerCase(),from:info.from,fromLower:info.from.toLowerCase()};return this.cacheData(entry.id,entry),entry},createEntryFromLocal:function createEntryFromLocalFn(info){return info.subjectLower=info.subject.toLowerCase(),info.fromLower=info.from.toLowerCase(),info},getAttachmentClass:function getAttachmentClassFn(attach){return"plugin_mailbird"},isPluginBlocked:function isPluginBlockedFn(){return!1},handleDropEvent:function handleDropEventFn(e,cb){try{g.PAssert(2704,cb,"Must provide a valid callback to the drop event")}catch(PERR){g.reportError(PERR)}var info=e.dataTransfer.getData("mailbird/email");if(info){var email=this._addRemoteEntry(info);return cb(this._getTextForItem(email)),!0}return!1},handleTapEvent:function handleTapEventFn(vmli,id,e){var item=this.getCacheData(id);if(item){var id=item.id.replace("mailbird_","");return this.isMailbirdEmbed?this._mailbirdOutAPI.call("selectConversation",id):g.messageQueue.pushMessage({text:"Sorry, emails can currently only be opened from inside Mailbird",action:MessageAction.Okay}),!0}return!1},matchAttachment:function matchAttachmentFn(attach,text){return attach.getField("fromLower").indexOf(text)>=0||attach.getField("subjectLower").indexOf(text)>=0},findMatchExact:function findMatchExactFn(text){},findMatchLike:function findMatchLikeFn(text,maxCount){var textLower=text.toLowerCase();return this.findCachedItemsByFn(function(item){return item.subjectLower.indexOf(textLower)>=0||item.fromLower.indexOf(textLower)>=0},maxCount)},supportOfflineCache:function supportOfflineCacheFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return this.getAttachmentEmbedString(item)},getItemTextLength:function getItemTextLengthFn(item){return 1},autocompleteWidth:function autocompleteWidthFn(){return 450},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return["m:","mailbird:"]}};return util.inherit(VMPlugin,Plugin_Mailbird),util.extend(Plugin_Mailbird.prototype,Plugin_MailbirdFns),Plugin_Mailbird}),define("plugins/Plugin_Gmail_Pane",["ko","globals","util","data","VMPane"],function(ko,g,util,d,VMPane){function Plugin_Gmail_Pane(p){this.plugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail),this._super.constructor.call(this,p),this.type=this.plugin._paneType,this.paneClass="paneNormal panePlugin paneGmail",this.dropEffect=g.isDemoMode()?DropEffect.Move:DropEffect.Copy,this.isWriteable=!1,this.overrideCopyBehavior=!1,this.supportCollapsing=!0,this.supportOffline=!1,this.supportPerformArchive=!1,this.supportDataRefresh=!0,this.supportPagination=!0,this.loadMoreOnScroll=ko.observable(!0),this.requestedPage=!1,this.numPagesLoaded=1,this.maxPagesOnScroll=4,this.shouldCheckHeight=!0,this.scrollHeight=0,this.contentHeight=0,this.initGmail()}var Plugin_Gmail_PaneFns={initGmail:function initGmailFn(){},onLoad:function onLoadFn(e){this._super.onLoad.call(this,e),this.scrollElement&&(this.scrollElement.onscroll=this.onScroll.bind(this))},getRootItem:function getRootItemFn(){var itemStore=this.plugin.getActiveItemStore(this.id);return itemStore?itemStore.getRoot():void 0},templateName:function templateNameFn(pane,b){return"template-pane-normal"},searchACName:function searchACNameFn(){return"template-search-ac-remote"},getPaneIcon:function getPaneIconFn(){return this.plugin.getPaneIcon()},requestDataPage:function requestDataPageFn(item){this.plugin.requestDataPage(item,this.onDataPagedIn.bind(this))},updateContents:function updateContentsFn(){this._super.updateContents.call(this)},onAfterLoaded:function onAfterLoadedFn(){this._super.onAfterLoaded.call(this)},onClose:function onCloseFn(){this._super.onClose.call(this)},onTapRunSearch:function onTapRunSearchFn(e,search){this.plugin.runSearch(search,this.id)},onTapClearSearch:function onTapClearSearchFn(e){this.plugin.clearSearch(this.id)},refreshPaneData:function refreshPaneDataFn(){this.plugin.refreshCurrentView(this.id)},onDataPagedIn:function onDataPagedInFn(){this.numPagesLoaded++,setTimeout(function(){this.numPagesLoaded>=this.maxPagesOnScroll&&(this.loadMoreOnScroll(!1),this.scrollElement.onscroll=void 0),this.shouldCheckHeight=!0,this.requestedPage=!1}.bind(this),1e3)},onScroll:function onScrollFn(e){if(!this.requestedPage){this.shouldCheckHeight&&(this.scrollHeight=g.height(this.scrollElement),this.contentHeight=g.height(this.paneContent),this.shouldCheckHeight=!1,setTimeout(function(){this.shouldCheckHeight=!0}.bind(this),5e3));var scroll=this.scrollElement.scrollTop;scroll+this.scrollHeight>this.contentHeight&&(this.requestedPage=!0,this.requestDataPage(this.item()))}},showLoadMore:function showLoadMoreFn(){return this.supportPagination&&this.loadMoreOnScroll&&!this.loadMoreOnScroll()&&this.item().hasPaginationToken()}};return util.inherit(VMPane,Plugin_Gmail_Pane),util.extend(Plugin_Gmail_Pane.prototype,Plugin_Gmail_PaneFns),Plugin_Gmail_Pane}),define("plugins/Plugin_Gmail",["globals","util","platform","VMPlugin","plugins/Plugin_Gmail_Pane"],function(g,util,platform,VMPlugin,Plugin_Gmail_Pane){function Plugin_Gmail(){this._super.constructor.call(this,PluginID.Gmail,"Gmail"),this.autocompleteReplace=!0,this.declareProperty("subject"),this.declareProperty("from"),this.declareProperty("unread",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("snippet",PluginLoad.Full),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.EmailThread)}var RequestType={Inbox:1,Thread:2,Search:3,DataPage:4},fromRegexp=/(?:\"?([^\"]*)\"?\s)?<(.*)>/g,DEFAULT_THREAD_MAX_RESULTS=20,MAX_EMAIL_PAGE_REQUESTS=1,requestFields="",Plugin_GmailFns={getDataPane:function getDataPaneFn(){try{g.PAssert(2705,!!this.getPaneIcon(),"Should have a pane icon specified")}catch(PERR){g.reportError(PERR)}return Plugin_Gmail_Pane},getPaneIcon:function getPaneIconFn(){return"icon-email"},useItemStore:function useItemStoreFn(){return"Gmail"},allowRemoteRequests:function allowRemoteRequestsFn(){return!0},loadInitialData:function loadInitialDataFn(){this._super.loadInitialData.call(this);var firstRequestLoaded=!1,itemStore=this.getDefaultItemStore(),item=itemStore.getRoot();this._requestRemoteThreads(RequestType.Inbox,item,void 0,DEFAULT_THREAD_MAX_RESULTS,function(entry){this._addRemoteEntry(entry),this.initVMLIsFromGmailThread(entry)}.bind(this),function(){firstRequestLoaded||(firstRequestLoaded=!0,this.finishedLoading())}.bind(this))},requestDataPage:function requestDataPageFn(item,doneCB){this._requestRemoteThreads(RequestType.DataPage,item,void 0,DEFAULT_THREAD_MAX_RESULTS,void 0,doneCB)},_requestRemoteThreads:function _requestRemoteThreadsFn(type,reqItem,q,maxResults,entryCB,doneCB){var paginationToken;reqItem&&reqItem.hasPaginationToken()&&(paginationToken=reqItem.beginDataPageLoad(),q=paginationToken.q,maxResults=paginationToken.maxResults,entryCB=paginationToken.entryCB,doneCB=doneCB||paginationToken.doneCB),maxResults=maxResults||DEFAULT_FILE_MAX_RESULTS;try{g.PAssert(2706,entryCB&&g.isFunction(entryCB),"Must define a valid entry callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2707,doneCB&&g.isFunction(doneCB),"Must define a valid done callback")}catch(PERR){g.reportError(PERR)}var request=gapi.client.gmail.users.threads.list({userId:"me",maxResults:maxResults,q:q,pageToken:paginationToken?paginationToken.nextPageToken:void 0}),successThreadCB=function(results){if(results.threads)for(var successThreadGetCB=function(result){result&&entryCB(result)}.bind(this),failureThreadGetCB=function(result){}.bind(this),i=0;i<results.threads.length;++i){var thread=results.threads[i],requestThread=gapi.client.gmail.users.threads.get({userId:"me",id:thread.id,format:"metadata"});this._queueRemoteRequest(requestThread,successThreadGetCB,failureThreadGetCB,void 0,RequestType.Thread)}var newPaginationToken;results.nextPageToken&&(newPaginationToken=paginationToken?this.updatePaginationToken(paginationToken,results.nextPageToken):this.createPaginationToken(results.nextPageToken,q,maxResults,entryCB,doneCB)),reqItem&&paginationToken?reqItem.endDataPageLoad(newPaginationToken):newPaginationToken&&reqItem.setPaginationToken(newPaginationToken),doneCB(!0)}.bind(this),failureThreadCB=function(results){paginationToken&&reqItem.endDataPageLoad(paginationToken),doneCB(!1)}.bind(this);this._queueRemoteRequest(request,successThreadCB,failureThreadCB,void 0,type)},runRemoteSearch:function runRemoteSearchFn(search,searchBucketID,paneID){var threadCB=this.addSearchResultToBucket.bind(this,searchBucketID),doneCB=this.swapInSearchBucket.bind(this,searchBucketID,paneID);this._requestRemoteThreads(RequestType.Search,this.getSearchRoot(searchBucketID),search,DEFAULT_THREAD_MAX_RESULTS,threadCB,doneCB)},addSearchResultToBucket:function addSearchResultToBucketFn(bucketID,result){var entry=this._createRemoteEntry(result);this.cacheData(entry.id,entry),this.createSearchResultItem(bucketID,entry.id,this._getTextForItem(entry))},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach){function _doAction(){var request=gapi.client.gmail.users.threads.get({userId:"me",id:attach.id,format:"metadata"}),successCB=function(result){result&&this._addRemoteEntry(result)}.bind(this),failureCB=function(result){attach.notifyDatarequestFailed()}.bind(this);this._queueRemoteRequest(request,successCB,failureCB,attach,RequestType.Thread)}window.gapi&&window.gapi.client&&window.gapi.client.gmail?_doAction.bind(this)():this._queueDeferredRemoteRequest(_doAction.bind(this))},_createRemoteEntry:function _createRemoteEntryFn(info){for(var entry={id:info.id,messages:[]},i=0;i<info.messages.length;++i){var msg=info.messages[i],msgEntry={id:msg.id,snippet:msg.snippet};msg.labelIds&&msg.labelIds.indexOf("UNREAD")>=0?(msg.unread=!0,entry.unread=!0,entry.cssClass="unread"):void 0===entry.unread&&(entry.unread=!1);for(var j=0;j<msg.payload.headers.length;++j){var header=msg.payload.headers[j];switch(header.name){case"From":msgEntry.from=header.value;break;case"Subject":msgEntry.subject=header.value}}msgEntry.subject||(msgEntry.subject=msg.snippet),entry.messages.push(msgEntry)}entry.snippet=entry.messages[entry.messages.length-1].snippet,fromRegexp.lastIndex=0;var fromMatch=fromRegexp.exec(entry.messages[0].from);return entry.subject=entry.messages[0].subject,entry.subjectLower=entry.subject.toLowerCase(),entry.from=fromMatch?fromMatch[1]||fromMatch[2]:entry.messages[0].from,entry.fromLower=entry.from.toLowerCase(),entry},_addRemoteEntry:function _addRemoteEntryFn(info){var entry=this._createRemoteEntry(info);this.cacheData(entry.id,entry)},createEntryFromLocal:function createEntryFromLocalFn(info){return info.subjectLower=info.subject.toLowerCase(),info.fromLower=info.from.toLowerCase(),info.unread&&(info.cssClass="unread"),info},finishedLoading:function finishedLoadingFn(){this._super.finishedLoading.call(this)},_getTextForThread:function _getTextForThreadFn(thread){try{g.PAssert(2708,thread,"Must be getting info for a valid thread")}catch(PERR){g.reportError(PERR)}return"From: "+thread.messages[0].from},initVMLIsFromGmailThread:function initVMLIsFromGmailThreadFn(thread){var itemStore=this.getDefaultItemStore(),root=itemStore.getRoot();if(!itemStore.hasItem(thread.id)){var threadVMLI=itemStore.createItem(thread.id,this._getTextForItem(thread),root.id);root.insertItem(threadVMLI)}},getAttachmentClass:function getAttachmentClassFn(){return"plugin_gmail"},googleScopes:function googleScopesFn(options){return[GScope.GmailRO]},getDependencies:function getDependenciesFn(){return[PluginDependency.PremiumSub,PluginDependency.GmailAPI,PluginDependency.GoogleLogin]},isDependencyLoaded:function isDependencyLoadedFn(dep,data){var isLoaded=!1;switch(dep){case PluginDependency.GoogleLogin:data&&data.indexOf(GScope.GmailRO)>=0&&(isLoaded=!0);break;default:isLoaded=!0}return isLoaded},loadRemoteAPIs:function loadRemoteAPIsFn(){function loadGmailAPI(){gapi.client.load("gmail","v1",function(){g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GmailAPI)})}window.gapi&&window.gapi.client?loadGmailAPI():g.addCustomEventListener("gapiLoaded",loadGmailAPI)},handleTapEvent:function handleTapEventFn(vmli,id,e){if(!g.isDemoMode()){var gmailURL="https://mail.google.com/mail/u/0/#inbox/"+id;g.openUrl(gmailURL)}return!0},supportOfflineCache:function supportOfflineCacheFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},matchAttachment:function matchAttachmentFn(attach,text){return attach.getField("fromLower").indexOf(text)>=0||attach.getField("subjectLower").indexOf(text)>=0},findMatchExact:function findMatchExactFn(text){},findMatchLike:function findMatchLikeFn(text,maxCount){var textLower=text.toLowerCase();return this.findCachedItemsByFn(function(item){return item.subjectLower.indexOf(textLower)>=0||item.fromLower.indexOf(textLower)>=0},maxCount)},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return this.getAttachmentEmbedString(item)},getItemTextLength:function getItemTextLengthFn(item){return 1},autocompleteWidth:function autocompleteWidthFn(){return 350},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return["g:","gmail:"]}};return util.inherit(VMPlugin,Plugin_Gmail),util.extend(Plugin_Gmail.prototype,Plugin_GmailFns),Plugin_Gmail}),define("VMPluginManager",["globals","util","platform","PluginRenderer","VMPlugin","plugins/Plugin_Drive","plugins/Plugin_Mailbird","plugins/Plugin_Gmail"],function(g,util,platform,PluginRenderer,VMPlugin,Plugin_Drive,Plugin_Mailbird,Plugin_Gmail){function VMPluginManager(){this._plugins={},this._activePlugins=[],this._loadedDependencies={},this._iteratingPlugins=!1,this._queueTimeout=void 0,this._forcedLastPossible=!1,this._numOutstandingReqs=0,this._pluginRenderer=new PluginRenderer,this.init()}var maxRequestsAtOnce=6,maxSinglePluginRequestsAtOnce=3,queueRequestTimeoutTime=2e3;return VMPluginManager.prototype={init:function initFn(){util.forceBind("_pumpRequestQueues",this),util.forceBind("_handleRequestResponse",this),this._setupRequestQueues(),this._pluginRenderer.registerDefaultRenderers(),g.billingManager.hasPremiumFeatures()&&this.notifyDependencyLoad(PluginDependency.PremiumSub)},printStats:function printStatsFn(){var pluginKeys=Object.keys(this._plugins);log("---- Plugin Stats ----");for(var i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]],pStat=plugin.getStats();log(plugin.name),log(" Stats: ",pStat)}log("----------------------")},getStats:function getStatsFn(){for(var stats={},pluginKeys=Object.keys(this._plugins),i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]];stats[plugin.id]=plugin.getStats()}return stats},registerPlugins:function registerPluginsFn(){try{this.registerPlugin(new Plugin_Drive)}catch(err){g.reportError(err)}try{this.registerPlugin(new Plugin_Gmail)}catch(err){g.reportError(err)}try{this.registerPlugin(new Plugin_Mailbird)}catch(err){g.reportError(err)}},registerPlugin:function registerPluginFn(plugin){try{g.PAssert(2710,!this._plugins[plugin.id],"Should never double-register a plguin")}catch(PERR){g.reportError(PERR)}this._plugins[plugin.id]=plugin,this.isAuthorized(plugin.id)&&this.loadPlugin(plugin.id)},getPlugin:function getPluginFn(id){return this._plugins[id]},loadPlugin:function loadPluginFn(id){var plugin=this.getPlugin(id);try{g.PAssert(2711,plugin,"Must register a plugin before loading it")}catch(PERR){g.reportError(PERR)}this.activatePlugin(plugin)},unloadPlugin:function unloadPluginFn(id){},authorizePlugin:function authorizePluginFn(id,options,cb){try{g.PAssert(2712,cb&&g.isFunction(cb),"Must provide a valid callback fn")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(id);try{g.PAssert(2713,plugin,"Must register a plugin before loading it")}catch(PERR){g.reportError(PERR)}options=options||{},plugin.authorize(options,function(success){plugin.setSetting("isEnabled",success),success&&this.activatePlugin(plugin),cb(success)}.bind(this))},deauthorizePlugin:function deauthorizePluginFn(id,options,cb){try{g.PAssert(2714,cb&&g.isFunction(cb),"Must provide a valid callback fn")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(id);try{g.PAssert(2715,plugin,"Must register a plugin before loading it")}catch(PERR){g.reportError(PERR)}plugin.setSetting("isEnabled",!1),this.deactivatePlugin(plugin),cb(!0)},activatePlugin:function activatePluginFn(plugin){try{g.PAssert(2716,plugin,"Plugin must be valid to be activated")}catch(PERR){g.reportError(PERR)}if(this._activePlugins.indexOf(plugin.id)<0){var success=plugin.activate(this._loadedDependencies);success&&this._activePlugins.push(plugin.id)}else plugin.ensurePaneTypeIsActive()},deactivatePlugin:function deactivatePluginFn(plugin){try{g.PAssert(2717,plugin,"Plugin must be valid to be deactivated")}catch(PERR){g.reportError(PERR)}if(this._activePlugins.indexOf(plugin.id)>=0){var success=plugin.deactivate();success&&this._activePlugins.remove(plugin.id)}},goOnline:function goOnlineFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.goOnline()}catch(err){this._reportPluginError(err)}}},goOffline:function goOfflineFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];
try{plugin.goOffline()}catch(err){this._reportPluginError(err)}}},writeCaches:function writeCachesFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.saveOfflineCache()}catch(err){this._reportPluginError(err)}}},onShutdown:function onShutdownFn(writeCaches){writeCaches&&this.writeCaches()},onPurgeData:function onPurgeDataFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.clearOfflineCache(!0)}catch(err){this._reportPluginError(err)}}},onClearData:function onClearDataFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.clearData()}catch(err){this._reportPluginError(err)}}},validatePlugin:function validatePluginFn(id){},runForEachPlugin:function runForEachPluginFn(fn){this._iteratingPlugins=!0;for(var i=0;i<this._activePlugins.length;++i)try{fn(this.getPlugin(this._activePlugins[i]))}catch(err){g.reportError(err)}this._iteratingPlugins=!1},getAttachment:function getAttachmentFn(obj){try{g.PAssert(2718,obj.p,"Must specify the plugin string to be used")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2719,obj.id,"Must specify the ID of the data to use from the plugin")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(obj.p);try{g.PAssert(2720,plugin,"Must specify a valid plugin")}catch(PERR){g.reportError(PERR)}return plugin?(plugin.isActive()||this.activatePlugin(plugin),plugin.getAttachment(obj.id)):void 0},getStyledText:function getStyledTextFn(obj,padBefore,padAfter){try{g.PAssert(2721,obj.p,"Must specify the plugin string to be used")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2722,obj.id,"Must specify the ID of the data to use from the plugin")}catch(PERR){g.reportError(PERR)}var styledText,plugin=this.getPlugin(obj.p);try{g.PAssert(2723,plugin,"Must specify a valid plugin")}catch(PERR){g.reportError(PERR)}if(plugin){var attach=this.getAttachment(obj);try{styledText=plugin.createDisplayElement(attach,padBefore,padAfter)}catch(err){this._reportPluginError(err)}}else styledText="";return styledText},parseAttachmentEmbedString:function parseAttachmentEmbedStringFn(str,padBefore,padAfter){try{g.PAssert(2724,str,"Must provide a valid string to parse")}catch(PERR){g.reportError(PERR)}var properties=str.replace(/&quot;/g,'"').split(","),obj={};return properties.forEach(function(property){var indexColon=property.indexOf(":"),key=property.substr(0,indexColon),value=property.substr(indexColon+1,property.length-indexColon-1);obj[key]=value}),obj.styledText=this.getStyledText(obj,padBefore,padAfter),obj},getAttachmentFromElement:function getAttachmentFromElementFn(element){var pluginName=element.getAttribute("plugin"),pluginID=element.getAttribute("plugin-id");try{g.PAssert(2725,pluginName,"Element must have a plugin set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2726,pluginID,"Element must have a plugin ID set")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(pluginName),attachment=plugin.getAttachment(pluginID);return attachment},handleDropEvent:function handleDropEventFn(e,cb){for(var handled=!1,i=0;i<this._activePlugins.length&&!handled;++i){var pluginID=this._activePlugins[i],plugin=this.getPlugin(pluginID);try{handled=plugin.handleDropEvent(e,cb)}catch(err){this._reportPluginError(err)}}return handled},handleTapEvent:function handleTapEventFn(vmli,e){var handled=!1,pluginElement=g.getPluginForElement(e.srcElement);if(pluginElement){var pluginName=pluginElement.getAttribute("plugin"),plugin=this.getPlugin(pluginName);try{g.PAssert(2727,plugin,"Must be able to get a valid plugin from a plugin element")}catch(PERR){g.reportError(PERR)}if(!plugin.isPluginBlocked()){var itemID=pluginElement.getAttribute("plugin-id");try{g.PAssert(2728,itemID,"Must have a valid item ID for a plugin element")}catch(PERR){g.reportError(PERR)}try{handled=plugin.handleTapEvent(vmli,itemID,e)}catch(err){this._reportPluginError(err)}}}return handled},isAuthorized:function isAuthorizedFn(id){return g.isDemoMode()?!0:!!this.getSetting(id,"isEnabled")},getSetting:function(pluginID,key){return this.getPlugin(pluginID).getSetting(key)},setSetting:function setSettingFn(pluginID,key,value){return this.getPlugin(pluginID).setSetting(key,value)},isDependencyLoaded:function isDependencyLoadedFn(dep){return!!this._loadedDependencies[dep]},notifyDependencyLoad:function notifyDependencyLoadFn(dep,data){this._loadedDependencies[dep]=data||!0;for(var id in this._plugins)try{this.getPlugin(id).onDependencyLoaded(dep,data)}catch(err){this._reportPluginError(err)}},_handleRequestResponse:function _handleRequestResponseFn(attach,plugin){try{g.PAssert(2730,plugin,"Plugin must be passed to response to know who is handling it")}catch(PERR){g.reportError(PERR)}this._numOutstandingReqs--;try{plugin._handleRequestResponse(attach)}catch(err){this._reportPluginError(err)}},notifyHasPendingRemoteRequest:function notifyHasPendingRemoteRequestFn(){this._numOutstandingReqs<maxRequestsAtOnce&&this._setupRequestQueues(!0)},_setupRequestQueues:function _setupRequestQueuesFn(nextPossible){var delay=nextPossible?0:queueRequestTimeoutTime;this._forcedLastPossible||(clearTimeout(this._queueTimeout),this._queueTimeout=setTimeout(this._pumpRequestQueues,delay)),this._forcedLastPossible=nextPossible},_pumpRequestQueues:function _pumpRequestQueuesFn(){var numRequested=0,availReqs=maxRequestsAtOnce-this._numOutstandingReqs;try{g.PAssert(2731,availReqs>=0,"Should never have more than max outstanding requests at any given point in time")}catch(PERR){g.reportError(PERR)}for(var i=0;availReqs>0&&i<this._activePlugins.length;++i){var pluginID=this._activePlugins[i],plugin=this.getPlugin(pluginID),pluginMaxRequests=Math.min(availReqs,maxSinglePluginRequestsAtOnce);if(pluginMaxRequests>0&&plugin.isReady()){var numReqSent=0;try{numReqSent=plugin._pumpRequestQueue(pluginMaxRequests,this._handleRequestResponse)}catch(err){this._reportPluginError(err)}numRequested+=numReqSent,availReqs-=numReqSent,this._numOutstandingReqs+=numReqSent}}return this._forcedLastPossible=!1,this._setupRequestQueues(),numRequested},useRenderer:function useRendererFn(type,id){return this._pluginRenderer.useRenderer(type,id)},_reportPluginError:function _reportPluginErrorFn(err){g.reportError(err)}},VMPluginManager}),define("PaneManager",["ko","globals","util","platform","PaneFactory"],function(ko,g,util,platform,PaneFactory){function PaneManager(){this._panesById={},this._panes=ko.observableArray(),this._displayingArchivedItems=ko.observable(!1),this._iteratingPanes=!1,this._savedPaneState=void 0,this._activePaneState=[],this._swappedOutPanes=[],this.init()}return PaneManager.prototype={init:function initFn(){this._panes.subscribe(this.checkDisplayArchived.bind(this))},checkDisplayArchived:function checkDisplayArchivedFn(){var displayArchiveCount=0;this.runForEachPane(function(pane){pane.showArchived()&&displayArchiveCount++}),this._displayingArchivedItems(!!displayArchiveCount)},getNextPaneID:function getNextPaneIDFn(){return g.generateTempId()},getPerPaneState:function getPerPaneStateFn(paneID,itemID,field){var pane=this.getPaneById(paneID);return pane?pane.getPerPaneState(itemID,field):void 0},setPerPaneState:function setPerPaneStateFn(paneID,itemID,field,data){var pane=this.getPaneById(paneID);pane&&pane.setPerPaneState(itemID,field,data)},getAllPerPaneState:function getAllPerPaneStateFn(itemID,field){for(var state=[],paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);state.push(pane.getPerPaneState(itemID,field))}return state},setAllPerPaneState:function setAllPerPaneStateFn(itemID,field){},deletePerPaneState:function deletePerPaneStateFn(paneID,itemID){var pane=this.getPaneById(paneID);pane&&pane.deletePerPaneState(itemID)},getPaneState:function getPaneStateFn(){if(!g.isDemoMode()){var activeDocId=g.settings.get(Settings.gdocId);void 0===this._savedPaneState&&(this._savedPaneState=this.loadPaneState()),this._activePaneState=this._savedPaneState[activeDocId]||[]}try{g.PAssert(2732,this._activePaneState,"Must always return a valid pane state to callers")}catch(PERR){g.reportError(PERR)}return this._activePaneState},loadPaneState:function loadPaneStateFn(){if(!g.isDemoMode()){var savedState=util.storage.getItem("paneState"),savedObj;try{savedObj=JSON.parse(savedState),g.isString(savedObj)&&(g.reportError(new Error("Invalid saved PaneState: "+savedObj)),util.storage.removeItem("paneState"),savedObj=void 0)}catch(err){g.reportError(err),util.storage.removeItem("paneState"),savedObj=void 0}return savedObj||{}}return{}},savePaneState:function savePaneStateFn(){if(!g.isDemoMode()){var activeDocId=g.settings.get(Settings.gdocId);if(activeDocId){this._savedPaneState[activeDocId]=this._activePaneState;try{var paneStateString=JSON.stringify(this._savedPaneState);util.storage.setItem("paneState",paneStateString)}catch(err){g.reportError(err);try{this._activePaneState=this.recreatePaneState(),this._savedPaneState[activeDocId]=this._activePaneState,paneStateString=JSON.stringify(this._savedPaneState),util.storage.setItem("paneState",paneStateString)}catch(err2){g.reportError(err2)}}}}},clearPaneState:function clearPaneStateFn(){this._activePaneState=[],this.savePaneState()},updatePaneStateForPane:function updatePaneStateForPaneFn(pane){try{g.PAssert(2733,pane,"Must pass in a valid pane to update")}catch(PERR){g.reportError(PERR)}if(!g.isRunningScript()&&!g.isDemoMode()){var paneState=this.getPaneState();if(paneState.length===this.paneCount())for(var i=0;i<paneState.length;++i){var info=paneState[i];if(info.id===pane.id){info.focus=pane.item().id,info.type=pane.type,info.showarch=pane.showArchived(),info.search=pane.vmSearch.search();break}}else paneState=this.recreatePaneState();this._activePaneState=paneState,this.savePaneState()}},recreatePaneState:function recreatePaneStateFn(){var paneState=[];return this.runForEachPane(function(tPane){paneState.push(tPane.getSaveInfo())}),paneState},updatePaneScrollState:function updatePaneScrollStateFn(){if(!g.isRunningScript()&&!g.isDemoMode()){for(var paneState=this.getPaneState(),i=0;paneState&&i<paneState.length;++i){var entry=paneState[i],pane=this.getPaneById(entry.id);pane&&(entry.offset=pane.getScrollOffset())}this.savePaneState()}},isPaneActive:function isPaneActiveFn(id){return!!this._panesById[id]},createPaneAtIndex:function createPaneAtIndexFn(type,index){try{g.PAssert(2734,type,"Must supply a valid pane type")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2735,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}isNaN(index)&&(index=this.paneCount());var newPane=PaneFactory.createPane(type,{id:this.getNextPaneID()});return newPane?this.addPaneAtIndex(newPane,index):g.reportError(new Error("Invalid pane created: "+type+" | "+index)),newPane},addPaneAtIndex:function addPaneAtIndexFn(pane,index,noSaveState){try{g.PAssert(2736,pane,"Must supply a valid pane")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2737,!this._panesById[pane.id],"Should never add the same pane twice")}catch(PERR){g.reportError(PERR)}if(this._panesById[pane.id]=pane,isNaN(index)?this._panes.push(pane):this._panes.splice(index,0,pane),!noSaveState&&!g.isRunningScript()&&!g.isDemoMode()){var paneState=this.getPaneState();paneState.push(pane.getSaveInfo()),this.savePaneState()}},removePaneAtIndex:function removePaneAtIndexFn(index){try{g.PAssert(2738,!isNaN(index),"Must supply a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2739,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}if(this.paneCount()>1){var removedPane=this._panes.splice(index,1)[0];try{g.PAssert(2740,removedPane,"Must have removed a valid pane")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2741,this._panesById[removedPane.id],"Should never add the same pane twice")}catch(PERR){g.reportError(PERR)}if(this._panesById[removedPane.id]=void 0,removedPane.destroy(),!g.isRunningScript()&&!g.isDemoMode()){var paneState=this.getPaneState();return paneState.splice(index,1),this.savePaneState(),removedPane.id}}return void 0},removePanesByType:function removePanesByTypeFn(type){var removePanes=[];this.runForEachPane(function(pane){pane.type===type&&removePanes.push(pane)});for(var i=0;i<removePanes.length;++i)this.removePane(removePanes[i])},addSwapPane:function addSwapPaneFn(pane){try{g.PAssert(2742,pane,"Must supply a valid pane to swap")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2743,this._swappedOutPanes.indexOf(pane)<0,"Should never add the same pane twice to swapped out pane list")}catch(PERR){g.reportError(PERR)}this._swappedOutPanes.push(pane)},swapPaneAtIndex:function swapPaneAtIndexFn(index,pane){try{g.PAssert(2744,!isNaN(index)&&0===index,"Must supply a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2745,platform.mobile,"We only perform pane swapping on mobile currently")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2746,pane,"Must supply a valid pane to swap out")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2747,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2748,1===this.paneCount(),"Swapping panes should only happen when there is a single pane present")}catch(PERR){g.reportError(PERR)}var currentPane=this._panes()[index];if(this._swappedOutPanes.push(currentPane),this._panesById[currentPane.id]=void 0,this._panesById[pane.id]=pane,this._panes([pane]),!g.isRunningScript()&&!g.isDemoMode()){var paneState=this.getPaneState();paneState.splice(index,1,pane.getSaveInfo()),this.savePaneState()}},getSwappedPaneByType:function getSwappedPaneByTypeFn(type){try{g.PAssert(2749,platform.mobile,"Mobile platform will only ever have a single instance of each pane type")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this._swappedOutPanes.length;++i){var pane=this._swappedOutPanes[i];if(pane&&pane.type===type)return pane}var newPane=PaneFactory.createPane(type,{id:this.getNextPaneID()});return this._swappedOutPanes.push(newPane),newPane},removeFocusedPane:function removeFocusedPaneFn(){return this.removePane(g.focusedPane)},removePane:function removePaneFn(pane){var index=this.getPaneIndex(pane);return this.removePaneAtIndex(index)},movePane:function movePaneFn(indexFrom,indexTo){try{g.PAssert(2750,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2751,!1,"Not Implemented")}catch(PERR){g.reportError(PERR)}},clearPanes:function clearPanesFn(){try{g.PAssert(2752,g.isDemoMode(),"Should only be clearing panes in demo mode")}catch(PERR){g.reportError(PERR)}this._panes([]),this.setFocusedPane(void 0)},getPaneAtIndex:function getPaneAtIndexFn(index){return this._panes.peek()[index]},getPaneIndex:function getPaneIndexFn(pane){return this._panes.peek().indexOf(pane)},getPaneById:function getPaneByIdFn(id){try{g.PAssert(2755,this._panesById[id],"Should never request a pane that is not currently loaded")}catch(PERR){g.reportError(PERR)}return this._panesById[id]},getPanesByType:function getPanesByTypeFn(type){for(var panes=[],paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);type&&pane.type!==type||panes.push(pane)}return panes},paneCount:function paneCountFn(){return this._panes().length},runForEachPane:function runForEachPaneFn(fn,type){this._iteratingPanes=!0;for(var paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);if(!type||pane.type===type)try{fn(pane)}catch(err){g.reportError(err)}}this._iteratingPanes=!1},applyFnToPanes:function applyFnToPanesFn(fnName,type){this._iteratingPanes=!0;for(var paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);if(!type||pane.type===type){var fn=pane[fnName];try{g.PAssert(2756,fn,"Must provide a valid function name for the given pane type")}catch(PERR){g.reportError(PERR)}try{fn.apply(pane,Array.prototype.slice.call(arguments,2))}catch(err){g.reportError(err)}}}this._iteratingPanes=!1},setFocusedPane:function setFocusedPaneFn(pane){pane||log("Setting Focused Pane to Undefined"),pane&&g.focusedPane&&g.focusedPane.id===pane.id||(g.focusedPane=pane,g.focusedItem=pane?pane.item():void 0)},subscribeToPaneChanges:function subscribeToPaneChangesFn(fn){try{g.PAssert(2757,fn,"Must have a valid callback function")}catch(PERR){g.reportError(PERR)}this._panes.subscribe(fn)},isDisplayingArchivedItems:function isDisplayingArchivedItemsFn(){return this._displayingArchivedItems()},subscribeToDisplayArchivedItemsChange:function subscribeToDisplayArchivedItemsChangeFn(fn){try{g.PAssert(2758,fn,"Must have a valid cb function")}catch(PERR){g.reportError(PERR)}this._displayingArchivedItems.subscribe(fn),fn(this._displayingArchivedItems())}},util.defineBase(PaneManager),PaneManager}),define("RemoteDoc",["ko","globals","data","util","platform","goog"],function(ko,g,d,util,platform,goog){function RemoteDoc(type,name){this._type=type,this._name=name,this._doc=void 0,this._loadFn=void 0,this._errorFn=void 0,this._initFn=void 0}return RemoteDoc.prototype={open:function openFn(id,loadFn,initFn,errorFn){try{g.PAssert(2759,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},close:function closeFn(){try{g.PAssert(2760,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},_getDocument:function _getDocumentFn(){return this._doc},getModel:function getModelFn(){return this._doc.getModel()},setLoadFn:function setLoadFnFn(loadFn){return this._loadFn=loadFn,this._onLoad.bind(this)},setInitFn:function setInitFnFn(initFn){return this._initFn=initFn,this._onInit.bind(this)},setErrorFn:function setErrorFnFn(errorFn){return this._errorFn=errorFn,this._onError.bind(this)},_onLoad:function _onLoadFn(doc){this._doc=doc,this._loadFn(doc)},_onError:function _onErrorFn(err){this._errorFn(err)},_onInit:function _onInitFn(model){this._initFn(model)}},util.defineBase(RemoteDoc),RemoteDoc}),define("GRealtimeDoc",["ko","globals","data","util","platform","goog","RemoteDoc"],function(ko,g,d,util,platform,goog,RemoteDoc){function GRealtimeDoc(name){this._super.constructor.call(this,DocType.GRealtime,name),this.init()}var GRealtimeDocFns={init:function initFn(){},open:function openFn(id,loadFn,initFn,errorFn){gdata.driveRealtimeLoad(id,this.setLoadFn(loadFn),this.setInitFn(initFn),this.setErrorFn(errorFn))},close:function closeFn(){}};return util.inherit(RemoteDoc,GRealtimeDoc),util.extend(GRealtimeDoc.prototype,GRealtimeDocFns),GRealtimeDoc}),define("GAppDataDoc",["ko","globals","data","util","platform","goog","RemoteDoc"],function(ko,g,d,util,platform,goog,RemoteDoc){function GAppDataDoc(name){this._super.constructor.call(this,DocType.GAppData,name),this.init()}var GAppDataDocFns={init:function initFn(){},open:function openFn(id,loadFn,initFn,errorFn){gapi.drive.realtime.loadAppDataDocument(this.setLoadFn(loadFn),this.setInitFn(initFn),this.setErrorFn(errorFn))},close:function closeFn(){}};return util.inherit(RemoteDoc,GAppDataDoc),util.extend(GAppDataDoc.prototype,GAppDataDocFns),GAppDataDoc}),define("DocumentManager",["ko","globals","data","util","platform","goog","GRealtimeDoc","GAppDataDoc"],function(ko,g,d,util,platform,goog,GRealtimeDoc,GAppDataDoc){function DocumentManager(){this._activeDocuments={},this._activeTypes={},this._authorizedTypes={},this._listeners=[],this.init()}return window.DocType={GRealtime:0,GAppData:1},DocumentManager.prototype={init:function initFn(){var checkDrive=function(){window.gapi.drive?(this._activateType(DocType.GRealtime),this._activateType(DocType.GAppData)):(g.reportError(new Error("Fatal error while loading google drive - did not add self to gapi")),window.addEventListener("gapiDriveLoaded",checkDrive.bind(this)))};window.gapi&&window.gapi.drive?checkDrive():window.addEventListener("gapiDriveLoaded",checkDrive.bind(this))},_activateType:function _activateTypeFn(type){if(this._activeTypes[type])try{g.PAssert(2761,!1,"Should only be activating a doc type once")}catch(PERR){g.reportError(PERR)}else this._activeTypes[type]=!0,this._authorizedTypes[type]&&this._notifyListeners(type)},_authorizeType:function _authorizeTypeFn(type){this._authorizedTypes[type]||(this._authorizedTypes[type]=!0,this._activeTypes[type]&&this._notifyListeners(type))},registerForReadyNotification:function registerForReadyNotificationFn(type,cb){if(g.isArray(this._listeners[type]))this._listeners[type].push(cb);else if(void 0===this._listeners[type])this._listeners[type]=[cb];else{try{g.PAssert(2762,-1===this._listeners[type],"After a type is loaded, do not queue listners")}catch(PERR){g.reportError(PERR)}cb()}},_notifyListeners:function _notifyListenersFn(type){if(g.isArray(this._listeners[type]))for(var i=0;i<this._listeners[type].length;++i)this._listeners[type][i]();this._listeners[type]=-1},notifyGoogleAuthorization:function notifyGoogleAuthorizationFn(){for(var scopes=goog.getAuthorizedScopes(),i=0;i<scopes.length;++i)switch(scopes[i]){case GScope.Drive:case GScope.DriveFull:this._authorizeType(DocType.GRealtime);break;case GScope.DriveAppData:this._authorizeType(DocType.GAppData)}},createDocument:function createDocumentFn(type,name){try{g.PAssert(2763,type,"Must provide a document type")}catch(PERR){g.reportError(PERR)}name=name||g.generateTempId();try{g.PAssert(2764,!this._activeDocuments[name],"Should not name two documents the same thing")}catch(PERR){g.reportError(PERR)}var remoteDoc;switch(type){case DocType.GRealtime:remoteDoc=new GRealtimeDoc(name);break;case DocType.GAppData:remoteDoc=new GAppDataDoc(name);break;default:try{g.PAssert(2765,!1,"Invalid document type requested",type)}catch(PERR){g.reportError(PERR)}}return this._activeDocuments[name]=remoteDoc,remoteDoc}},util.defineBase(DocumentManager),DocumentManager}),define("VMMain",["ko","globals","util","android","data","gdata","goog","edit","copypaste","VMMain_DragDrop","VMLI","VMTitle","tracker","platform","VMSearch","VMPane","PaneFactory","VMMenus","VMSettings","VMPicker","VMPhoneMenu","VMKeyboardToolbar","VMIntro","VMMessageQueue","International","VMPluginManager","PaneManager","DocumentManager"],function(ko,g,util,android,d,gdata,goog,edit,copypaste,VMMain_DragDrop,VMLI,VMTitle,tracker,platform,VMSearch,VMPane,PaneFactory,VMMenus,VMSettings,VMPicker,VMPhoneMenu,VMKeyboardToolbar,VMIntro,VMMessageQueue,International,VMPluginManager,PaneManager,DocumentManager){var VMMain=function(){function runRemoteLoad(rootItem){g.isLoadingRemote=!0;try{d.beginTransaction(),g.timeline.startLoading();var lastServerVersion=g.settings.get(Settings.lastServerVersion),currentServerVersion=gdata.getServerVersion();lastServerVersion===currentServerVersion&&log("Client and Server Versions Match!"),g.startTimeEvent("PageLoad","RemoteData","Load Remote Data"),tracker.beginAction();var previousLocalIntegrity=g.settings.get(Settings.localIntegrity);previousLocalIntegrity===!1&&(ShouldLog(LogLevels.Warning)&&log("Previous remote sync had an issue!"),g.reportError(new Error("Previous remote sync had an issue!"))),gdata.loadSeen={},g.settings.set(Settings.localIntegrity,!1),self.root().initFromGDrive(rootItem),g.settings.set(Settings.localIntegrity,!0),gdata.loadSeen={},tracker.endAction(),self.flushParseItems(),self.flushModifiedItems(),g.timeline.endLoading(),d.hasLocalData&&self.root().resetModified(),d.clearPendingUpdates(),g.endTimeEvent(),self.paneManager.runForEachPane(function(pane){pane.vmSearch.updateSearch(!0)}),g.fireCustomEvent("remoteDataLoaded")}catch(err){g.reportError(err),g.messageQueue.pushMessage({text:"There was an error loading your data from the server. Please try again.",action:MessageAction.Reload})}finally{d.endTransaction(),g.isLoadingRemote=!1,g.vmMain.isLoadingDoc(!1),g.StopSpinner()}}function restoreLoadSelection(){if(!platform.mobile){var setSelection=g.restoreSavedSelection("loadData");if(!setSelection&&g.focusedPane&&g.focusedPane.isWriteable){var firstItem=g.getFirstPaneItem(g.focusedPane);firstItem&&g.setSelection(firstItem.getSpan(),0,0)}}}function clearPrevNoteSelection(){if(prevSelectedNote){try{g.PAssert(2818,prevSelectedNote.isNote(),"Should always be a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2819,prevSelectedNote.isSelected(),"Previous selected note should always be marked as selected")}catch(PERR){g.reportError(PERR)}var isMultiline=g.height(prevSelectedNote.getSpan())>16;prevSelectedNote.isMultiline(isMultiline),prevSelectedNote.isSelected(!1),prevSelectedNote=void 0}}function setPrevNoteSelection(newNote){try{g.PAssert(2820,newNote.isNote(),"Should always be selecting a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2821,!newNote.isSelected(),"Should not be double selecting")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2822,!prevSelectedNote,"Must have cleared the previously selected note")}catch(PERR){g.reportError(PERR)}prevSelectedNote=newNote,prevSelectedNote.isSelected(!0);var isMultiline=g.height(prevSelectedNote.getSpan())>16;prevSelectedNote.isMultiline(isMultiline)}function clearPrevItemSelection(){if(prevSelectedItem){try{g.PAssert(2823,!prevSelectedItem.isNote(),"Should never be a note")}catch(PERR){g.reportError(PERR)}g.cleanupEditTextNode(prevSelectedElement),prevSelectedItem=void 0,prevSelectedElement=void 0}}function setPrevItemSelection(newItem,newElement){try{g.PAssert(2824,!newItem.isNote(),"Should never be selecting a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2825,!prevSelectedItem,"Should not be double selecting")}catch(PERR){g.reportError(PERR)}return prevSelectedItem=newItem,prevSelectedElement=newElement,g.setupEditTextNode(newElement)}function updatePrevItemSelection(item,itemElement){try{g.PAssert(2826,prevSelectedItem===item,"Item must match")}catch(PERR){g.reportError(PERR)}return prevSelectedElement=itemElement,g.updateEditTextNode(itemElement)}function itemNeedsSelectionTracking(item){return item.hasAttachments()}function setupPageVisibility(){function handleVisibilityChange(){platform.isPageVisible()?updateTimeout&&(clearTimeout(updateTimeout),updateTimeout=0):updateTimeout=setTimeout(function(){g.AppCache.checkForUpdate(!1,!0),g.vmMain.pluginManager.writeCaches()},5e3)}function checkActivity(){Date.now()>self.lastActivity+g.minutes(90)&&(g.AppCache.checkForUpdate(!1,!0),self.lastActivity=Date.now()),activityTimeout=setTimeout(checkActivity,g.minutes(60))}platform.pageVisibilityChange&&document.addEventListener(platform.pageVisibilityChange,handleVisibilityChange),platform.mobile||(activityTimeout=setTimeout(checkActivity,g.minutes(60)))}var self={root:ko.observable(void 0),isLoadingDoc:ko.observable(!1),isLoaded:!1,hasResized:ko.observable(!1),_hasDisplayedArchivedItems:!1,helpButtonHidden:ko.observable(!1),showFeedback:ko.observable(!platform.mobile&&!platform.demo),gdriveStatus:ko.observable(-1),isPhone:platform.phone,supportWebWorker:!1,vmSettings:void 0,vmPicker:new VMPicker,selected:ko.observableArray(),help:void 0,messageQueue:new VMMessageQueue,lastActivity:0,grabber:void 0,pluginManager:new VMPluginManager,paneManager:new PaneManager,paneFactory:PaneFactory,docManager:new DocumentManager};g.vmMain=self,self.pluginManager.registerPlugins(),self.loadPlugins=function loadPluginsFn(){var debugPlugin},self.statusClass=platform.mobile?function statusClassFn(){return self.gdriveStatus()===DriveStatus.Offline?"statusOffline":self.gdriveStatus()===DriveStatus.Connecting||self.gdriveStatus()===DriveStatus.Reconnecting?"statusConnecting":void 0}:function statusClassFn(){return""},platform.mobile&&(self.elPhoneMenu=g.element("phoneMenu")),g.vmSettings=self.vmSettings=new VMSettings(this),self.isOnline=function isOnlineFn(){return self.gdriveStatus()!==DriveStatus.Offline},self.isReconnecting=function isReconnectingFn(){return self.gdriveStatus()===DriveStatus.Reconnecting},self.isLocal=function isLocalFn(){return"localhost"===window.location.hostname},self.onlineText=function onlineTextFn(){if(self.isDemoMode())return"DEMO";switch(self.gdriveStatus()){case DriveStatus.Connecting:return"CONNECTING";case DriveStatus.Offline:return"OFFLINE";case DriveStatus.Saving:case DriveStatus.Saved:return"";case DriveStatus.Reconnecting:return"RETRYING"}},VMMain_DragDrop(self),self.maxWidth=function maxWidthFn(){if(self.isPhone)return"";setTimeout(self.updatePaneWidth,0);var width=800*self.paneManager.paneCount()+(self.help.isShowing()?400:0);return width+"px"},self.getUserEmail=function getUserEmailFn(){return g.getUserIdentifier()},self.getUserImage=function getUserImageFn(){var user=gdata.authenticatedUser();return user?user.photoUrl:void 0},self.isDemoMode=function isDemoModeFn(){return g.isDemoMode()},window.addEventListener("scriptLoadError",function(e){self.handleScriptLoadError(e)}),self.handleScriptLoadError=function handleScriptLoadErrorFn(e){"gapiScript"===e.data.id&&(log("Failed to load GAPI!"),self.setGDriveStatus(DriveStatus.Offline),self.failedGapiLoad=!0,setTimeout(goog.goOnline,3e4))};var connectTimeout;self.connectFailed=function connectFailedFn(){self.setGDriveStatus(DriveStatus.Offline),connectTimeout=void 0,goog.ensureDocConnection()},self.setGDriveStatus=function setGDriveStatusFn(status){var prevStatus=self.gdriveStatus();status!==prevStatus&&status!==DriveStatus.Saving&&(self.gdriveStatus(status),status===DriveStatus.Connecting||status===DriveStatus.Reconnecting?gdata.loadedOnce&&(clearTimeout(connectTimeout),connectTimeout=setTimeout(self.connectFailed,gdata.offlineTimeoutMS)):(clearTimeout(connectTimeout),connectTimeout=void 0),status===DriveStatus.Offline?g.goOffline():prevStatus===DriveStatus.Offline&&g.goOnline())},self.init=function initFn(){g.settings._ensureRemoteSettings(),copypaste.init(),self.loadPlugins(),self.paneManager.subscribeToDisplayArchivedItemsChange(function(value){value&&(self._hasDisplayedArchivedItems||(self._hasDisplayedArchivedItems=!0,self.parseSubtreeArchive(self.root(),ChangeType.Auto)))})},self.isDisplayingArchivedItems=function isDisplayingArchivedItemsFn(){return self.paneManager.isDisplayingArchivedItems()},self.hasDisplayedArchivedItems=function hasDisplayedArchivedItemsFn(){return self._hasDisplayedArchivedItems},self.onLoad=function onLoadFn(){if(platform.isTouchDevice&&!platform.app)for(var outlines=document.getElementsByClassName("paneOutline"),i=0;i<outlines.length;++i)outlines[i].addEventListener(platform.touchStartEvent,function(e){return g.preventScrollPropagation(outlines[i])?void 0:(e.preventDefault(),!1)});self.isDemoMode()&&platform.script&&g.setupClick(document.getElementById("main"),self,self.onTapMain),setTimeout(function(){self.grabber=document.getElementById("fullscreenClickGrabber"),g.setupClick(self.grabber,void 0,{onRightClick:function onRightClickFn(e){self.grabber.style.display="none";var realElem=document.elementFromPoint(e.clientX,e.clientY),pane=g.getPaneForElement(realElem);pane&&pane.onTap.onRightClick({srcElement:realElem,pageX:e.pageX,pageY:e.pageY,preventDefault:function preventDefaultFn(){e.preventDefault()},stopPropagation:function stopPropagationFn(){e.stopPropagation()},stopImmediatePropagation:function stopImmediatePropagationFn(){e.stopImmediatePropagation()}}),self.grabber.style.display=""},onEnd:function onEndFn(){self.cancelFullscreenClick()}})},0)},self.addModifiedItem=function addModifiedItemFn(item,modFlags){},self.flushModifiedItems=function flushModifiedItemsFn(){},self.addParseItem=function addParseItemFn(item,changeType){self.runSingleParse(item,changeType)},self.flushParseItems=function flushParseItemsFn(){},self.runParseWorkerNewContacts=function runParseWorkerNewContactsFn(){self.root()&&self.parseWorkerNewContactsHelper(self.root(),ChangeType.Auto)},self.parseWorkerNewContactsHelper=function parseWorkerNewContactsHelperFn(item,changeType){try{g.PAssert(2766,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}var rawText=item.getRawText();rawText.indexOf(ContactPrefix)>=0&&self.runSingleParse(item,changeType);for(var items=item.items(),i=0;i<items.length;i++)self.parseWorkerNewContactsHelper(items[i],changeType)
},self.parseSubtree=function parseSubtreeFn(item,changeType){try{g.PAssert(2769,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}self.runSingleParse(item,changeType);for(var items=item.items(),i=0;i<items.length;i++)self.parseSubtree(items[i],changeType)},self.parseSubtreeArchive=function parseSubtreeArchiveFn(item,changeType){try{g.PAssert(2770,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}self.runSingleParse(item,changeType);for(var items=item.items(),i=0;i<items.length;i++)self.parseSubtreeArchive(items[i],changeType);if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;i++)self.parseSubtreeArchive(archivedItems[i],changeType)},self.runSingleParse=function runSingleParseFn(item,changeType){try{g.PAssert(2777,item,"Must have a valid item to parse")}catch(PERR){g.reportError(PERR)}var changedStyles={};item.parseText(!0,changeType,changedStyles)&&item.save(changedStyles,SaveFlag.None)};var lastDateRollover=0;self.setupDateRollover=function setupDateRolloverFn(){var currentTime=new Date,nextRolloverTime=currentTime.clone().addDays(1).clearTime();try{g.PAssert(2782,nextRolloverTime>currentTime,"Rollover time must be in the future")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2783,nextRolloverTime>lastDateRollover,"Rollover time must be after the last rollover")}catch(PERR){g.reportError(PERR)}return log("Next Rollover Time: ",nextRolloverTime),setTimeout(function(){function runRolloverWork(){self.parseSubtree(self.root(),ChangeType.Auto),g.timeline.reloadTimelines(),log("-------------------------------")}try{g.PAssert(2784,self.isLoaded,"Expect that we have fully loaded the page before performing rollover")}catch(PERR){g.reportError(PERR)}log("---- Running Date Rollover ----"),lastDateRollover=new Date,self.setupDateRollover(),Date.Parsing.Normalizer.buildReplaceData(),g.settings.get(Settings.syncContacts)?(goog.loadedContacts=!1,goog.loadContacts(runRolloverWork)):runRolloverWork()},nextRolloverTime-currentTime),nextRolloverTime};var hasLoadedRemoteData=!1;self.notifyDriveDisconnect=function notifyDriveDisconnectFn(){hasLoadedRemoteData=!1,tracker.resetAggregateActionCount()},self.notifyDriveOperationError=function notifyDriveOperationErrorFn(){tracker.resetAggregateActionCount()},self.loadGDriveData=function loadGDriveDataFn(){if(!hasLoadedRemoteData){hasLoadedRemoteData=!0,platform.mobile||g.saveSelection("loadData");var rootItem=gdata.rootItem;try{self.root().linkToGDrive(rootItem)}catch(err){g.reportError(err),g.menus.alert({text:"There was a fatal error in the application. Please reload to try again.",actionText:"RELOAD",action:g.reload})}try{gdata.checkRemoteIntegrity()}catch(err){g.reportError(err)}var localRoot=d.getRootItem();localRoot.id!==rootItem.id?d.modifyItemId(localRoot.id,rootItem.id,function(){var item=d.getModel(rootItem.id);try{g.PAssert(2785,localRoot.id===rootItem.id,"IDs should have been modified in modifyItemId")}catch(PERR){g.reportError(PERR)}localRoot.id=rootItem.id,d.setRoot(rootItem.id),item.forceModifiedItems=!0,runRemoteLoad(rootItem),d.hasLocalData||item.items.valueHasMutated(),restoreLoadSelection()}):(runRemoteLoad(rootItem),restoreLoadSelection()),self.vmPicker.refreshFiles()}};var hasLoadedData=!1;self.loadData=function loadDataFn(){function addContact(name){contacts.push({id:"contact_"+contactId++,name:name,isDemo:!0,emails:[{address:"contact@moo.do",primary:!0}],phoneNumbers:[{number:"(555) 123-4567",type:"mobile"}]})}if(!hasLoadedData&&d.localDataLoaded()){if(hasLoadedData=!0,self.isDemoMode()){var contacts=[],contactId=0;addContact("Jay"),addContact("Grant"),addContact("Ramada"),addContact("Canyon Ranch"),addContact("Jim Joseph"),addContact("Miller Harris"),addContact("Bob Johnson"),addContact("Bill Wilson"),addContact("Emily Edwards"),addContact("Jane Johnson"),addContact("Mike Thomas"),addContact("Joe Lewis"),addContact("Steve"),addContact("Melissa"),addContact("Mikey"),addContact("Bart"),addContact("Dad"),addContact("Mom"),d.contactManager.loadContacts(contacts,!0)}g.startTimeEvent("PageLoad","LocalData","Load Local Data"),self.root(new VMLI(d.getRootItem(),{changeType:ChangeType.Auto})),g.checkpoint(Checkpoint.LocalDocLoad),g.endTimeEvent(),g.requireGDriveDataCallback&&self.loadGDriveData(),setTimeout(function(){self.isDemoMode()&&(platform.script&&g.vmSetup.runScript(util.getURLParam("script")),window.parent.postMessage("loaded","*"))},0),self.afterLoaded(),g.startTimeEvent("PageLoad","ApplyBindings","Apply Bindings"),g.applyBindings(self,"container"),platform.mobile||g.applyBindings(self,"desktopMenu"),self.paneManager.runForEachPane(function(pane){pane.vmSearch.onUpdated.valueHasMutated()}),self.isLoaded=!0,document.getElementById("container").style.display="block",platform.app&&g.nativeBridge.sendToApp("localLoaded"),g.endTimeEvent()}},self.changeRoot=function changeRootFn(rootId){try{g.PAssert(2786,rootId,"Cannot use to reset root to undefined")}catch(PERR){g.reportError(PERR)}var newRoot=d.getModel(rootId);newRoot||(newRoot=new VMLI(d.getItem(rootId),{changeType:ChangeType.Auto}));try{g.PAssert(2787,newRoot,"Must have a new root VMLI at this point, otherwise failed creation")}catch(PERR){g.reportError(PERR)}newRoot&&(self.root(newRoot),self.paneManager.runForEachPane(function(pane){pane.item(newRoot),pane.notifyOfZoom()}))},self.resetScrollOffsets=function resetScrollOffsetsFn(){self.paneManager.runForEachPane(function(pane){pane.setScrollOffset(pane.defaultOffset)})},self.onTapMain={onStart:function onStartFn(){g.fireCustomEvent("tapMain")},onClick:function onClickFn(){try{g.PAssert(2788,self.isDemoMode()&&platform.script,"Tap handler should only be active on demo page")}catch(PERR){g.reportError(PERR)}window.parent.postMessage("click","*")}},g.globalClickHandler=function(e){g.tooltip.hideTip()},self.loadDemoPanes=function loadDemoPanesFn(){self.paneManager.clearPanes();for(var i=0;i<g.demoPanes.length;i++){var paneInfo=g.demoPanes[i].split(",");if("help"===paneInfo[0])self.showHelp();else{var type=paneInfo[0];"1"===type?type=PaneMode.Normal:"2"===type&&(type=PaneMode.Timeline);var paneInit={id:self.paneManager.getNextPaneID()};if(paneInfo.length>1){paneInfo[1]&&(paneInit.search=paneInfo[1]);var focusModel;paneInfo[2]&&(focusModel=d.getModel(paneInfo[2])),paneInit.item=focusModel||self.root()}var addedPane=PaneFactory.createPane(type,paneInit);addedPane&&self.paneManager.addPaneAtIndex(addedPane)}}var firstPane=self.paneManager.getPaneAtIndex(0);try{g.PAssert(2793,firstPane,"Must always have at least one valid pane in demo mode")}catch(PERR){g.reportError(PERR)}firstPane&&(self.setFocusedPane(firstPane),self.zoomin(firstPane.item(),!0))},self.loadItemPane=function loadItemPaneFn(paneData){try{g.PAssert(2794,paneData,"Must specify valid pane data to load from")}catch(PERR){g.reportError(PERR)}var normalPanes=self.paneManager.getPanesByType(PaneMode.Normal),focusModel=d.getModel(paneData);if(focusModel){var focusPane;if(normalPanes.length>0)focusPane=normalPanes[0];else{var initData={id:self.paneManager.getNextPaneID(),item:focusModel};focusPane=PaneFactory.createPane(PaneMode.Normal,initData),focusPane&&self.paneManager.addPaneAtIndex(0)}focusPane&&(self.setFocusedPane(focusPane),self.zoomin(focusModel,!0))}},self.getItemURL=function getItemURLFn(item){var docID=g.goog.getDocId(),itemID=item.id,url=window.location.protocol+"//"+window.location.host+"/app/#file="+docID+"&panes="+itemID;return log("Item URL: ",url),url},self.afterLoaded=function afterLoadedFn(){var paneState=self.paneManager.getPaneState();if(paneState.length>0){try{g.PAssert(2795,1===paneState.length||!platform.mobile,"Mobile will always have a single pane")}catch(PERR){g.reportError(PERR)}for(var i=0;i<paneState.length;++i){if(platform.mobile&&i>0){try{g.PAssert(2796,!1,"Loading invalid pane state")}catch(PERR){g.reportError(PERR)}break}var paneInfo=paneState[i],item=d.getModel(paneInfo.focus),paneType=paneInfo.type||(1===paneInfo.mode?PaneMode.Normal:PaneMode.Timeline),pane=PaneFactory.createPane(paneType,{id:self.paneManager.getNextPaneID(),item:item,search:paneInfo.search,offset:paneInfo.offset});pane&&(paneInfo.id=pane.id,paneInfo.showarch&&pane.showArchived(!0),self.paneManager.addPaneAtIndex(pane,void 0,!0),self.setFocusedPane(pane,!0),self.zoomin(pane.item(),!0))}1!==self.paneManager.paneCount()&&self.setFocusedPane(self.paneManager.getPaneAtIndex(0),!0)}var loadPanes=util.getURLParam("panes");if(self.isDemoMode()&&g.demoPanes)self.loadDemoPanes();else if(loadPanes)self.loadItemPane(loadPanes);else if(0===self.paneManager.paneCount()){var pane=PaneFactory.createPane(PaneMode.Normal,{id:self.paneManager.getNextPaneID()});if(self.paneManager.addPaneAtIndex(pane),!platform.mobile&&g.activeDisplayMode&DisplayMode.ForceTwoPane){var pane2=PaneFactory.createPane(PaneMode.Timeline,{id:self.paneManager.getNextPaneID()});self.paneManager.addPaneAtIndex(pane2)}self.setFocusedPane(self.paneManager.getPaneAtIndex(0)),self.zoomin(self.root(),!0)}platform.mobile&&(g.phoneMenu=new VMPhoneMenu,g.keyboardToolbar=new VMKeyboardToolbar),platform.app&&(document.onreadystatechange=function(){platform.mobile&&g.nativeBridge.sendToApp("kbsize"),g.nativeBridge.sendToApp("loaded")},document.onreadystatechange()),g.timeline.updateNotifications()},self.togglePaneModeMobile=function togglePaneModeMobileFn(srcPane,dstType){try{g.PAssert(2798,platform.mobile,"Should only call on mobile devices")}catch(PERR){g.reportError(PERR)}var dstPane=self.paneManager.getSwappedPaneByType(dstType);try{g.PAssert(2799,dstPane,"Must always have a pane of requested type available")}catch(PERR){g.reportError(PERR)}self.paneManager.swapPaneAtIndex(0,dstPane),self.paneManager.setFocusedPane(dstPane),dstPane.copyStateFrom(srcPane)},self.getPaneSwapIconMobile=function getPaneSwapIconMobileFn(){try{g.PAssert(2800,platform.mobile,"Should only call on mobile devices")}catch(PERR){g.reportError(PERR)}var activePane=self.paneManager.getPaneAtIndex(0);return activePane.type===PaneMode.Timeline?"icon-align-left":"icon-calendar2"};var prevRange;self.getFirstSelectedItem=function getFirstSelectedItemFn(){try{g.PAssert(2806,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}return self.selected().length>0?self.selected()[0]:void 0},self.setSelected=function setSelectedFn(selection){try{g.PAssert(2807,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}selection=selection||[],self._clearIsSelected(selection);for(var i=0;i<selection.length;++i){try{g.PAssert(2808,selection[i]&&!!selection[i].isSelected,"Must have a selectable item")}catch(PERR){g.reportError(PERR)}selection[i].isSelected(!0)}self.selected(selection)},self.getSelected=function getSelectedFn(){try{g.PAssert(2809,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}return self.selected()},self._clearIsSelected=function _clearIsSelectedFn(newSelected){try{g.PAssert(2810,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}newSelected=newSelected||[];for(var i=0;i<self.selected().length;i++){var selectedItem=self.selected()[i];if(newSelected.indexOf(selectedItem)<0){try{g.PAssert(2811,selectedItem&&!!selectedItem.isSelected,"Must have a selectable item")}catch(PERR){g.reportError(PERR)}selectedItem.isSelected(!1)}}},self.clearSelected=function clearSelectedFn(newSelected){try{g.PAssert(2812,platform.mobile,"Selection tracking only available from mobile")}catch(PERR){g.reportError(PERR)}self._clearIsSelected(newSelected),self.selected([])};var fixingSelection=!1;if(platform.mobile&&(document.onselectstart=function(e){return g.dragging?(e.preventDefault(),!1):!0},setTimeout(function(){document.addEventListener("selectionchange",function(e){if(!fixingSelection){var itemsChanged=!0,arrToSelect;if(g.ignoreSelectionChange)return g.ignoreSelectionChange=!1,void(prevRange=void 0);if(g.hasSelection()){if(platform.android&&g.dragging)return void g.clearSelection();var range=g.getSelectionRange();if(itemsChanged=!prevRange||range.startContainer!==prevRange.startContainer||range.endContainer!==prevRange.endContainer,prevRange&&!itemsChanged&&range.startOffset===prevRange.startOffset&&range.endOffset===prevRange.endOffset)return;if("fullscreenClickGrabber"===range.startContainer.id)return;if(prevRange=range,g.focusedPane&&g.focusedPane.type===PaneMode.Normal){var origLIParent=g.getLIParent(range.startContainer),origStart=origLIParent?ko.dataFor(origLIParent):void 0,skipUpdates=!origStart||!origStart instanceof VMPane&&!origStart instanceof VMLI;if(skipUpdates);else{if(g.restrictSelectionToText(),range=g.getSelectionRange(),!range)return;var startLI=g.getLIParent(range.startContainer),endLI=g.getLIParent(range.endContainer);if(startLI&&endLI&&!g.hasClass(startLI,"emptyPaneItem")&&!g.hasClass(endLI,"emptyPaneItem")){var item=ko.dataFor(startLI);try{g.PAssert(2813,item,"Must have a valid item to set as selection")}catch(PERR){g.reportError(PERR)}if(itemsChanged)if(startLI!==endLI)if(platform.android&&android.isEnabled())g.clearSelection();else{try{g.PAssert(2814,!platform.android||!platform.mobile,"Multi-select is not enabled in mobile android")}catch(PERR){g.reportError(PERR)}var endItem=ko.dataFor(endLI);if(item===g.getFirstPaneItem(g.focusedPane)&&endItem===g.getLastPaneItem(g.focusedPane)){var cSelected=self.getSelected();try{g.PAssert(2815,cSelected&&cSelected.length>0,"Must have a valid item selection to be selecting all")}catch(PERR){g.reportError(PERR)}var newFirst=cSelected[0],newLast=cSelected[cSelected.length-1];try{g.PAssert(2816,newFirst&&newLast,"Must have valid selection VMLIs")}catch(PERR){g.reportError(PERR)}return g.selectMultiline(newFirst.getSpan(),0,newLast.getSpan(),newLast.getParsedText().length),g.scrollIntoView(newFirst.getSpan(),0),void g.preventDefault(e)}arrToSelect=g.getItemsBetween(item,endItem,g.focusedPane)}else if(arrToSelect=[item],android.isEnabled()&&!platform.mobileie){android.updateInput(item);var selectNode=g.getSelectionNode();if(selectNode&&g.hasClass(selectNode,"contact")){var offset=g.getOffsetOfSubNode(item.getSpan(),selectNode);g.autocomplete.update({owner:item,start:offset+1}),g.autocomplete.show(selectNode)}}}}}}else(platform.android||platform.mobileie||platform.ios&&(!platform.app||platform.ipad))&&(platform.mobileie&&android.isEnabled()&&android.isVisible()||g.fireCustomEvent("closeKeyboard"));g.hasSelection()||(prevRange=void 0),!itemsChanged||platform.android||platform.mobileie||self.setSelected(arrToSelect)}})},0)),!platform.mobile||platform.ios){var prevSelectedItem,prevSelectedNote;document.addEventListener("selectionchange",function(e){var selectionOverride=!1;if(!fixingSelection){fixingSelection=!0;try{if(g.hasSelection()&&g.focusedPane&&g.focusedPane.type===PaneMode.Normal){var range=g.getSelectionRange(),startSpan=g.getSpanParent(range.startContainer,!0),endSpan=g.getSpanParent(range.endContainer,!0);if(startSpan===endSpan){var itemElement=startSpan;if(itemElement){var item=g.getItemForElement(itemElement);if(prevSelectedNote!==item&&(clearPrevNoteSelection(),item.isNote())){var noteSel=g.saveSelectionItem(range);setPrevNoteSelection(item),g.restoreSelectionItem(noteSel)}prevSelectedItem!==item?(clearPrevItemSelection(),itemNeedsSelectionTracking(item)&&setPrevItemSelection(item,itemElement)&&(selectionOverride=!0)):updatePrevItemSelection(item,itemElement)&&(selectionOverride=!0)}else clearPrevNoteSelection(),clearPrevItemSelection()}else clearPrevNoteSelection(),clearPrevItemSelection()}else clearPrevNoteSelection(),clearPrevItemSelection()}catch(err){g.reportError(err)}fixingSelection=!1}return selectionOverride&&e.preventDefault(),selectionOverride})}self.setFocusedPaneFromElement=function setFocusedPaneFromElementFn(element){try{g.PAssert(2828,element,"Trying to set the currently focused pane from an element that doesnt exist")}catch(PERR){g.reportError(PERR)}if(element){var paneEl=g.hasClass(element,"paneRoot")?element:g.getPaneForElement(element).rootElement,pane=ko.dataFor(paneEl);try{g.PAssert(2829,pane,"Could not find matching pane")}catch(PERR){g.reportError(PERR)}self.setFocusedPane(pane)}},self.setFocusedPane=function setFocusedPaneFn(pane){self.paneManager.setFocusedPane(pane)},self.zoomin=function zoominFn(item,forLoad){try{g.PAssert(2830,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var oldItem=g.focusedItem;self._zoom(item,forLoad),item.isDemandLoad()&&item.notifyDemandLoadUpdate(!0);var pane=g.focusedPane;forLoad||g.sendEvent("Menu","ZoomIn"),!platform.mobile&&pane.paneContent&&pane.isWriteable&&(pane.item().hasChildren()?g.setSelection(pane.paneContent,0,0):g.clearSelection()),pane.rootElement?pane.setScrollOffset():setTimeout(function(){pane.setScrollOffset()},0),forLoad||tracker.performAction(TrackerType.Zoom,{itemID:item.id,oldItemID:oldItem.id,zoomOut:!1,time:g.zoomTime})},self.zoomout=function zoomoutFn(item,zoomedOutFrom){try{g.PAssert(2831,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var oldItem=g.focusedItem;self._zoom(item,!1),g.sendEvent("Menu","ZoomOut"),g.focusedPane.isWriteable&&g.selectChildren(zoomedOutFrom,zoomedOutFrom.getParsedText().length,0),g.scrollToTop(zoomedOutFrom.getSpan(),0),tracker.performAction(TrackerType.Zoom,{itemID:item.id,oldItemID:oldItem.id,zoomOut:!0,time:g.zoomTime})},self._zoom=function _zoomFn(item,forLoad){try{g.PAssert(2832,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var oldItem=g.focusedItem;oldItem&&oldItem.id===item.id||(g.focusedPane.item(item),g.focusedPane.notifyOfZoom(),g.focusedItem=item,forLoad||self.paneManager.updatePaneStateForPane(g.focusedPane))},self.onHotkeyButtonClick=function onHotkeyButtonClickFn(e){self.showHelp(HelpMode.Hotkeys),g.sendEvent("Menu","HelpHotkeys"),e.preventDefault(),e.stopPropagation()};var fullscreenClickHandled=!1;self.handleFullscreenClick=function handleFullscreenClickFn(){fullscreenClickHandled||(g.removeClass(self.grabber,"none"),fullscreenClickHandled=!0)},self.cancelFullscreenClick=function cancelFullscreenClickFn(){fullscreenClickHandled&&(g.addClass(self.grabber,"none"),fullscreenClickHandled=!1,g.menus.closeAllMenus())},self.applyFnToSelection=function applyFnToSelectionFn(fn,params){var toggle=params&&params.toggle||params===!0,value=params&&void 0!==params.value?params.value:!0,applyParams={restoreSelection:params.restoreSelection};if(self.applyToSelection(function(item){toggle&&item[fn]()!==value&&(toggle=!1),toggle||item[fn](value)},applyParams),toggle){var emptyValue=emptyValue=params&&void 0!==params.emptyValue?params.emptyValue:!1;self.applyToSelection(function(item){item[fn](emptyValue)},applyParams)}},self.applyPriorityToSelection=function applyPriorityToSelectionFn(pri,toggle){toggle?self.applyFnToSelection("priority",{toggle:!0,value:pri,emptyValue:VMLIFlag.None,restoreSelection:!0}):self.applyFnToSelection("priority",{value:pri,restoreSelection:!0})},self.insertCharacter=function insertCharacterFn(character,withSpace){var text;if(android.isEnabled()){text=android.getInputText();var prevChar=text[android.getSelectionStart()-1];withSpace&&" "!==prevChar&&0!==android.getSelectionStart()?android.insertText(android.getSelectionStart()," "+character):android.insertText(android.getSelectionStart(),character)}else{g.restrictSelectionToText();var range=g.getSelectionRange();if(range){var item=g.getItemForElement(range.startContainer);if(item){text=item.getRawText();var prevChar=text[range.startOffset-1];withSpace&&" "!==prevChar&&0!==range.startOffset&&g.fireKeyEvent(void 0,{normCode:KeyCode.Space}),g.fireKeyEvent(void 0,{normCode:character.charCodeAt(0)})}}}},self.applyToSelection=function applyToSelectionFn(action,options){var restoreSelection=options&&options.restoreSelection,passExtraInfo=options&&options.passExtraInfo,selectionInfo=void 0;if(platform.android||android.isEnabled()){var nextItem=android.getCurrentVMLI(),endItem=android.getCurrentVMLI();if(void 0===nextItem||void 0===endItem)return!0}else{if(!g.hasSelection())return!0;var selectNode=g.getSelectionNode();if(selectNode&&g.hasClass(selectNode,"search"))return!0;var pane=g.getPaneForElement(selectNode);if(!pane)return!0;if(g.restrictSelectionToText(),!g.hasSelection())return!0;var range=g.getSelectionRange();if(g.hasClass(range.startContainer.parentNode,"timelineItemTime"))return!0;restoreSelection&&(selectionInfo=g.saveSelectionItem(range));var nextItem=g.getItemForElement(range.startContainer),endItem=g.getItemForElement(range.endContainer);if(void 0===nextItem||void 0===endItem)return!0}tracker.beginAction(),nextItem!==endItem&&0===range.endOffset&&(endItem=g.getPreviousItem(endItem,g.focusedPane,{includeNotes:!0}));for(var items=g.getItemsBetween(nextItem,endItem,g.focusedPane),i=0;i<items.length;++i){var actionRetVal=passExtraInfo?action(items[i],i,items.length):action(items[i]);if(actionRetVal===!1)break}return self.paneManager.runForEachPane(function(pane){pane!==g.focusedPane&&pane.vmSearch.updateSearch(!0)}),tracker.endAction(),selectionInfo&&g.restoreSelectionItem(selectionInfo),items.length};var prevMove={over:void 0,wasPointer:!1};self.updateCursor=function updateCursorFn(ctrlPressed){prevMove&&prevMove.over&&(ctrlPressed&&("A"===prevMove.over.tagName||g.hasClass(prevMove.over,"tag"))?(prevMove.wasPointer=!0,prevMove.over.style.cursor="pointer"):!ctrlPressed&&prevMove.wasPointer&&(prevMove.wasPointer=!1,prevMove.over.style.cursor="text"))},platform.touch||(self.mousemove=function mousemove(e){if(!g.disableMouseMove&&(e.pageX!==prevMove.pageX||e.pageY!==prevMove.pageY)){prevMove.pageX=e.pageX,prevMove.pageY=e.pageY;var to=e.srcElement||e.target;platform.normalizeMouse(e),(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&("A"===to.tagName||g.hasClass(to,"tag")||g.hasClass(to,"contact"))?(prevMove.wasPointer&&(prevMove.over.style.cursor="text"),prevMove.wasPointer=!0,to.style.cursor="pointer"):prevMove.wasPointer&&(prevMove.wasPointer=!1,prevMove.over.style.cursor="text"),prevMove.over=to,self.lastActivity=Date.now()}},g.element("container").addEventListener("mousemove",self.mousemove)),self.onTapDocuments=function onTapDocumentsFn(e){g.sendEvent("Menu","buttonDocuments"),g.menus.toggleDocumentsMenu(),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleDocumentsMenu,data:[{value:!0}]}),e.preventDefault(),e.stopPropagation()},self.onTapAddPane=function onTapAddPaneFn(e){g.sendEvent("Menu","buttonAddPane"),g.menus.toggleAddPaneMenu(),e.preventDefault(),e.stopPropagation()},self.onTapOptionsMenu=function onTapOptionsMenuFn(e){g.sendEvent("Menu","buttonOptionsMenu"),g.menus.toggleOptionsMenu(),e.preventDefault(),e.stopPropagation()},self.showSearchSeparator=function showSearchSeparatorFn(){return!platform.mobile||g.phoneMenu.showSearchSeparator()},self.onTapSettingsPhone={onStart:function onStartFn(e){g.ScreenManager.checkSwipeStart(e)},onMove:function onMoveFn(e){g.ScreenManager.checkSwipeMove(e)},onEnd:function onEndFn(e){g.ScreenManager.checkSwipeEnd(e)}},self.onTapCloseFeedback=function onTapCloseFeedbackFn(e){self.showFeedback(!1),e.preventDefault()},self.help=new VMIntro,self.showHelp=function showHelpFn(helpState){self.help.initState(helpState||HelpMode.Intro),self.helpButtonHidden(helpState===HelpMode.Intro)};var activityTimeout=0,updateTimeout=0;if(self.isDemoMode()||setupPageVisibility(),self.updatePaneWidth=function updatePaneWidthFn(){var pane=self.paneManager.getPaneAtIndex(0);pane&&pane.rootElement&&(platform.mobile?(self.paneWidth=platform.windowWidth(),self.paneHeight=platform.windowHeight()):(self.paneWidth=pane.rootElement.getBoundingClientRect().width,self.paneHeight=pane.scrollElement.getBoundingClientRect().height))},platform.mobile||(platform.windowWidth.subscribe(self.updatePaneWidth),self.paneManager.subscribeToPaneChanges(self.updatePaneWidth.bind(self))),g.shouldWriteLocal()){var setting="version"+(platform.mobile?"Mobile":"Desktop"),prevVersion=+util.storage.getItem(setting),ver=platform[setting];if(!g.isFirstRun&&!g.isDemoMode()&&(!prevVersion||ver>prevVersion))for(var messages=platform.getUpdateMessages(prevVersion),i=0;i<messages.length;++i)g.messageQueue.pushMessage({text:messages[i],hold:!0,action:MessageAction.Blog});util.storage.setItem(setting,ver)}return self.init(),self};return util.defineBase(VMMain),VMMain}),define("ModalReportBug",["ko","globals","util","platform","ModalBase"],function(ko,g,util,platform,ModalBase){function ModalReportBug(){this._super.constructor.call(this,Modals.ReportBug),this.bugDescription=ko.observable(""),this.init()}var ModalReportBugFns={init:function initFn(){this.registerModal(this.onModalOpen.bind(this))},onModalOpen:function onModalOpenFn(){platform.mobile||setTimeout(function(){document.getElementById("bugDescription").focus()})},onTapCancelBug:function onTapCancelBugFn(){g.menus.closeModal(this.id),g.blurActiveElement(),platform.mobile&&g.vmMain.clearSelected()},onTapSaveBug:function onTapSaveBugFn(){var appInfo={};g.getAppInfo(appInfo),appInfo.eventStream=void 0;var desc=this.bugDescription()||g.element("bugDescription").value;if(desc&&desc.length>2){var notes=desc+"\r\n\r\n\r\n"+JSON.stringify(appInfo,void 0,3),name=desc.substr(0,Math.min(desc.length,120)),bug={name:name,notes:notes};bug.email=g.getUserIdentifier();var sendBug=function(){g.XHR_PrivateAPI({type:"POST",path:"/feedback/suggestion",data:bug,cb:function cbFn(xhr){log("XHR Response: ",xhr.status,xhr),this.bugDescription("")}.bind(this)})}.bind(this);"Unknown"!==bug.email?sendBug():g.getClientInfo(function(info){info&&(bug.email=info.ip),sendBug()}),g.menus.closeModal(Modals.ReportBug),g.messageQueue.pushMessage({text:"Thanks for taking the time to send us feedback!"}),g.sendEvent("Menu","SendFeedback"),g.blurActiveElement(),platform.mobile&&g.vmMain.clearSelected()}},onTapSocialTwitter:function onTapSocialTwitterFn(e){g.openUrl("http://twitter.com/MooDoApp",e),g.sendEvent("Menu","FeedbackTwitter")},onTapSocialFacebook:function onTapSocialFacebookFn(e){g.openUrl("http://facebook.com/MooDoApp",e),g.sendEvent("Menu","FeedbackFacebook")},onTapSocialGoogle:function onTapSocialGoogleFn(e){g.openUrl("http://google.com/+MooDoApp",e),g.sendEvent("Menu","FeedbackGoogle")},onTapSocialUserVoice:function onTapSocialUserVoiceFn(e){g.openUrl("http://feedback.moo.do/",e),g.sendEvent("Menu","FeedbackUserVoice")}};return util.inherit(ModalBase,ModalReportBug),util.extend(ModalReportBug.prototype,ModalReportBugFns),ModalReportBug}),define("dimport",["globals","platform","data","tracker","VMLI","parse","goog","International"],function(g,platform,d,tracker,VMLI,parser,goog,International){function dimport(){this.workflowy={login:this.workflowyLogin.bind(this),"import":this.workflowyImport.bind(this),save:this.workflowySave.bind(this)},this.wunderlist={login:this.wunderlistLogin.bind(this),"import":this.wunderlistImport.bind(this),save:this.wunderlistSave.bind(this)},this.opml={login:this.opmlLogin.bind(this),"import":this.opmlImport.bind(this),save:this.opmlSave.bind(this)},this.json={login:this.jsonLogin.bind(this),"import":this.jsonImport.bind(this),save:this.jsonSave.bind(this)},this.text={login:this.textLogin.bind(this),"import":this.textImport.bind(this),save:this.textSave.bind(this)},this.gtasks={login:this.gtasksLogin.bind(this),"import":this.gtasksImport.bind(this),save:this.gtasksSave.bind(this)},this.trello={preload:this.trelloPreload.bind(this),login:this.trelloLogin.bind(this),"import":this.trelloImport.bind(this),save:this.trelloSave.bind(this)},this.toodledo={login:this.toodledoLogin.bind(this),"import":this.toodledoImport.bind(this),save:this.toodledoSave.bind(this)},this.todoist={login:this.todoistLogin.bind(this),"import":this.todoistImport.bind(this),save:this.todoistSave.bind(this)}}return dimport.prototype={workflowyLogin:function workflowyLoginFn(username,password,cb,error){try{g.PAssert(2833,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2834,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR_PrivateAPI({type:"POST",path:"/oauth/workflowy",data:{username:username,password:password},cb:function cbFn(xhr){if(200===xhr.status){try{this.workflowy.data=JSON.parse(xhr.response)}catch(err){error("Error parsing response from remote server.",err)}!this.workflowy.data||this.workflowy.data.error?error("Invalid username or password."):cb()}else error("Error contacting remote server.")}.bind(this)})},workflowyImport:function workflowyImportFn(cb,error){try{g.PAssert(2835,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2836,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}cb(this.workflowy.data)},workflowyIterateItem:function workflowyIterateItemFn(item,parentVMLI){var IS_COMPLETE_VALUE=673732;try{g.PAssert(2837,item&&void 0!==item.lm&&void 0!==item.nm,"All items must exist and have stars and text, children and notes are optional",item)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2839,parentVMLI,"A valid parent must always be defined")}catch(PERR){g.reportError(PERR)}if(item&&parentVMLI){var isComplete=item.lm===IS_COMPLETE_VALUE;if(!isComplete){var itemVMLI=new VMLI({text:item.nm,isComplete:isComplete},{parent:parentVMLI,forceSave:!0,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(itemVMLI),item.no){var noteVMLI=new VMLI({text:item.no},{parent:itemVMLI,forceSave:!0,changeType:ChangeType.AllLocal});itemVMLI.insertItem(noteVMLI)}if(item.ch)for(var i=0;i<item.ch.length;++i){var entry=item.ch[i];this.workflowyIterateItem(entry,itemVMLI)}}}},workflowySave:function workflowySaveFn(data,cb,error){try{g.PAssert(2840,data,"Workflowy requires having valid data")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2841,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2842,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}try{var project=data.projectTreeData.mainProjectTreeInfo;tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(2843,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Workflowy Import"},{parent:docRoot,forceSave:!0,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var i=0;i<project.rootProjectChildren.length;++i){var entry=project.rootProjectChildren[i];this.workflowyIterateItem(entry,impRoot)}g.vmMain.parseSubtree(impRoot,ChangeType.Local|ChangeType.All),tracker.endAction(),cb()}catch(err){error(void 0,err)}},wunderlistLogin:function wunderlistLoginFn(username,password,cb,error){try{g.PAssert(2844,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2845,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"POST",url:"https://api.wunderlist.com/login",data:{email:username,password:password},cb:function cbFn(xhr){if(200===xhr.status){var data;try{data=JSON.parse(xhr.response)}catch(err){error("Error parsing response from remote server.",err)}this.wunderlist.token=data.token,cb(data)}else error(403===xhr.status?"Incorrect username or password.":xhr.status+": Error contacting remote server.")}.bind(this)})},wunderlistImport:function wunderlistImportFn(cb,error){try{g.PAssert(2846,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2847,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}this.wunderlistGetLists(function(lists){this.wunderlistGetTasks(function(tasks){for(var data={inbox:{title:"inbox",items:{},p:0}},i=0;i<lists.length;++i){var list=lists[i];data[list.id]={title:list.title,items:{},p:list.position}}for(var i=0;i<tasks.length;++i){var task=tasks[i];if(task.parent_id){var taskParent=data[task.list_id].items[task.parent_id];taskParent?(taskParent.items||(taskParent.items=[]),taskParent.items.push(task)):data[task.list_id].items[task.parent_id]={items:[task]}
}else{var prevData=data[task.list_id].items[task.id];data[task.list_id].items[task.id]=task,prevData&&(data[task.list_id].items[task.id].items=prevData.items)}}cb(data)}.bind(this),error)}.bind(this),error)},wunderlistGetLists:function wunderlistGetListsFn(cb,error){try{g.PAssert(2848,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2849,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://api.wunderlist.com/me/lists",headers:{Authorization:this.wunderlist.token},cb:function cbFn(xhr){if(200===xhr.status){var data;try{data=JSON.parse(xhr.response)}catch(err){error(void 0,err)}cb(data)}else error("Error contacting remote server.")}.bind(this)})},wunderlistGetTasks:function wunderlistGetTasksFn(cb,error){try{g.PAssert(2850,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2851,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://api.wunderlist.com/me/tasks",headers:{Authorization:this.wunderlist.token},cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);cb(data)}else error("Error contacting remote server.")}.bind(this)})},wunderlistSave:function wunderlistSaveFn(data,cb,error){try{g.PAssert(2852,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2853,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}try{tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(2854,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Wunderlist Import"},{parent:docRoot,forceSave:!0,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var listId in data){var list=data[listId],listText=list.title,listVMLI=new VMLI({text:listText},{parent:impRoot,forceSave:!0,changeType:ChangeType.AllLocal});impRoot.insertItem(listVMLI);for(var taskId in list.items){var task=list.items[taskId],taskVMLI=new VMLI({text:task.title,isComplete:!!task.completed_at,dateCompleted:task.completed_at,isStarred:task.starred},{parent:listVMLI,forceSave:!0,changeType:ChangeType.AllLocal});if(listVMLI.insertItem(taskVMLI),task.note){var noteVMLI=new VMLI({text:task.note},{parent:taskVMLI,forceSave:!0,changeType:ChangeType.AllLocal});taskVMLI.insertItem(noteVMLI)}if(task.items)for(var j=0;j<task.items.length;++j){var subtask=task.items[j],subtaskVMLI=new VMLI({text:subtask.title,isComplete:!!subtask.completed_at,dateCompleted:subtask.completed_at,isStarred:subtask.starred},{parent:taskVMLI,forceSave:!0,changeType:ChangeType.AllLocal});taskVMLI.insertItem(subtaskVMLI)}}}g.vmMain.parseSubtree(impRoot,ChangeType.Local|ChangeType.All),tracker.endAction(),cb()}catch(err){error(void 0,err)}},opmlLogin:function opmlLoginFn(user,pw,cb,error){try{g.PAssert(2855,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2856,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}var input=g.element("importFileUploadButton");input.onchange=cb,input.click()},opmlImport:function opmlImportFn(cb,error){try{g.PAssert(2857,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2858,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}try{var fReader=new FileReader,fileImport=document.forms.importFileUpload.importFile.files[0];fileImport?(fReader.onload=function(e){var data=e.target.result,xml;if((data.startsWith("<?xml ")||data.startsWith("<opml "))&&(xml=g.loadXML(data)),xml){var res=parser.parseOPML(xml,fileImport.name);res?cb():error("Error parsing OPML. Please validate your data.")}else error("Unable to load XML lib. Please update or try another browser.")},fReader.onerror=error,fReader.readAsText(fileImport)):error("You must select a file before importing.")}catch(err){error(void 0,err)}},opmlSave:function opmlSaveFn(data,cb,error){try{g.PAssert(2859,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2860,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},jsonLogin:function jsonLoginFn(user,pw,cb,error){try{g.PAssert(2861,cb,"JSON requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2862,error,"JSON requires an error callback")}catch(PERR){g.reportError(PERR)}var input=g.element("importFileUploadButton");input.onchange=cb,input.click()},jsonImport:function jsonImportFn(cb,error){try{var fReader=new FileReader,fileImport=document.forms.importFileUpload.importFile.files[0];fileImport?(fReader.onload=function(e){var data=e.target.result;if(data)try{var parsedObj=JSON.parse(data),res=parser.parseJSON(parsedObj);res?cb():error("Error parsing JSON. Please validate your data.")}catch(errParse){error(void 0,errParse)}else error("Unable to import your requested file. Please try again.")},fReader.onerror=error,fReader.readAsText(fileImport)):error("You must select a file before importing.")}catch(err){error(void 0,err)}},jsonSave:function jsonSaveFn(data,cb,error){try{g.PAssert(2863,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2864,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},textLogin:function textLoginFn(user,pw,cb,error){try{g.PAssert(2865,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2866,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},textImport:function textImportFn(cb,error){var data=document.getElementById("importFileDataBox").textContent,xml;if(data.startsWith("<?xml ")||data.startsWith("<opml "))try{if(xml=g.loadXML(data)){var res=parser.parseOPML(xml,"Import Data");if(res)return void cb()}}catch(errParse){}if(data.startsWith("{")&&data.endsWith("}"))try{var parsedObj=JSON.parse(data),res=parser.parseJSON(parsedObj);if(res)return void cb()}catch(errParse){}error("Text Import Not Supported")},textSave:function textSaveFn(data,cb,error){try{g.PAssert(2867,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2868,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},gtasksLogin:function gtasksLoginFn(username,password,cb,error){try{g.PAssert(2869,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2870,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}goog.runAuthenticate([GScope.TasksRO],!1,!1,function(token){token&&!token.error?(this.gtasks.token=token,cb(token)):error("Unable to authenticate with Google. Please try again.",token)}.bind(this))},gtasksImport:function gtasksImportFn(cb,error){try{g.PAssert(2871,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2872,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var info={roots:[],remoteItems:{},unassigned:[]};this.gtasksGetLists(function(listData){try{g.PAssert(2873,g.isArray(listData),"List data must be an array")}catch(PERR){g.reportError(PERR)}for(var numLists=listData.length,listsCreated=0,i=0;i<listData.length;++i){var list=listData[i];info.remoteItems[list.id]={id:list.id,text:list.title,isComplete:!1,dateCompleted:void 0,isArchived:!1,due:void 0,notes:void 0,parent:void 0,items:[]},info.roots.push(list.id),this.gtasksGetTasks(list,function(taskData,activeList){if(taskData){try{g.PAssert(2874,g.isArray(taskData),"List data must be an array")}catch(PERR){g.reportError(PERR)}if(g.isArray(taskData)){for(var j=0;j<taskData.length;++j){var task=taskData[j];if(task&&"completed"!==task.status){info.remoteItems[task.id]={id:task.id,text:task.title,isComplete:"completed"===task.status,dateCompleted:task.completed?new Date(task.completed):void 0,isArchived:task.hidden,due:task.due?new Date(task.due):void 0,notes:task.notes,parent:task.parent||activeList.id,items:[]};var parent=info.remoteItems[task.parent||activeList.id];parent?parent.items.push(task.id):info.unassigned.push(task.id)}}listsCreated++,listsCreated===numLists&&cb(info)}else error("Invalid task list returned.")}else listsCreated++}.bind(this),error)}}.bind(this),error)},gtasksGetLists:function gtasksGetListsFn(cb,error){try{g.PAssert(2875,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2876,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var maxResults=2e3;g.XHR({type:"GET",url:"https://www.googleapis.com/tasks/v1/users/@me/lists?maxResults="+maxResults+"&key="+window.gapiKey+"&access_token="+goog.getAccessToken(!0),cb:function cbFn(xhr){if(200===xhr.status)try{var data=JSON.parse(xhr.response);try{g.PAssert(2877,data&&data.items,"Must have a valid set of data to get tasks from")}catch(PERR){g.reportError(PERR)}data&&data.items?cb(data.items):error("Error getting data from remote server.")}catch(err){error(err)}else error("Error contacting remote server.")}.bind(this)})},gtasksGetTasks:function gtasksGetTasksFn(list,cb,error){try{g.PAssert(2878,list,"GTasks requires a valid list to get tasks from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2879,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2880,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var maxResults=2500;g.XHR({type:"GET",url:"https://www.googleapis.com/tasks/v1/lists/"+list.id+"/tasks?maxResults="+maxResults+"&key="+window.gapiKey+"&access_token="+goog.getAccessToken(!0),cb:function cbFn(xhr){if(200===xhr.status)try{var data=JSON.parse(xhr.response);try{g.PAssert(2881,data,"Must have a valid array of tasks")}catch(PERR){g.reportError(PERR)}data&&data.items?cb(data.items,list):cb([],list)}catch(err){error(err)}else error("Error contacting remote server.")}.bind(this)})},gtasksSave:function gtasksSaveFn(data,cb,error){function traverse(node,parentVMLI){var itemText=node.text;node.due&&(itemText+=" @"+node.due.toString(International.getFormat(DFormat.MonthDay)));var itemVMLI=new VMLI({text:itemText,isComplete:node.isComplete,dateCompleted:node.dateCompleted?node.dateCompleted.getTime():node.dateCompleted,isArchived:node.isArchived},{parent:parentVMLI,forceSave:!0,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(itemVMLI),node.notes){var notesVMLI=new VMLI({text:node.notes},{parent:itemVMLI,forceSave:!0,changeType:ChangeType.AllLocal});itemVMLI.insertItem(notesVMLI)}for(var i=0;i<node.items.length;++i)traverse(data.remoteItems[node.items[i]],itemVMLI)}try{g.PAssert(2882,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2883,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}try{try{g.PAssert(2884,0===data.unassigned.length,"We should never have unassigned tasks")}catch(PERR){g.reportError(PERR)}tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(2885,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Google Tasks Import"},{parent:docRoot,forceSave:!0,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var i=0;i<data.roots.length;++i)traverse(data.remoteItems[data.roots[i]],impRoot);g.vmMain.parseSubtree(impRoot,ChangeType.Local|ChangeType.All),tracker.endAction(),cb()}catch(err){error(void 0,err)}},trelloPreload:function trelloPreloadFn(cb,error){var appKey="667ecf0c3d3e029c51d205b7173f6c38";this.trello.isLoaded?cb():(this.trello.isLoaded=!1,g.addScript("https://code.jquery.com/jquery-1.7.1.min.js","jqueryScript",function(){g.addScript("https://api.trello.com/1/client.js?key="+appKey,"trelloScript",function(){try{g.PAssert(2886,window.Trello,"The Trello client lib must have been loaded correctly")}catch(PERR){g.reportError(PERR)}window.Trello?(this.trello.isLoaded=!0,cb()):error("Error loading Trello API, please try again.")}.bind(this),error)}.bind(this),error))},trelloLogin:function trelloLoginFn(username,password,cb,error){try{g.PAssert(2887,Trello,"The Trello client lib must have been loaded correctly")}catch(PERR){g.reportError(PERR)}Trello.authorize({type:platform.appPlatform===AppPlatform.Chrome?"redirect":"popup",name:"Moo.do",persist:!1,expiration:"1hour",success:cb,error:error})},trelloImport:function trelloImportFn(cb,error){var data=[];try{Trello.get("members/me/boards",function(boards){for(var doneBoards=0,totalLists=0,doneLists=0,totalCards=0,doneCards=0,i=0;i<boards.length;++i){var board=boards[i],boardItem={text:board.name,items:[]};data.push(boardItem),function handleBoard(boardItem){Trello.get("boards/"+board.id+"/lists",function(lists){totalLists+=lists.length;for(var j=0;j<lists.length;++j){var list=lists[j],listItem={text:list.name,items:[]};boardItem.items.push(listItem),function handleList(listItem){Trello.get("lists/"+list.id+"/cards",function(cards){totalCards+=cards.length;for(var k=0;k<cards.length;++k){var card=cards[k],cardItem={text:card.name};if(card.labels&&card.labels.length>0){for(var labelText="",z=0;z<card.labels.length;++z){var label=card.labels[z];labelText+=TagPrefix+(label.name.length>0?label.name:label.color)+" "}cardItem.text=labelText+cardItem.text}if(card.due&&(cardItem.text+=" "+DatePrefix+new Date(card.due).toString(International.getFormat(DFormat.MonthDay))),card.desc&&card.desc.length>0){cardItem.items=[];for(var descEntries=card.desc.split("\n"),z=0;z<descEntries.length;++z){var entry=descEntries[z];entry&&entry.length>0&&cardItem.items.push({text:entry})}}if(card.idChecklists&&card.idChecklists.length>0){cardItem.items||(cardItem.items=[]);for(var z=0;z<card.idChecklists.length;++z){var checklistId=card.idChecklists[z];!function handleChecklist(cardItem){Trello.get("checklists/"+checklistId+"/",function(checklist){doneCards++;for(var checklistItem={text:checklist.name,isCollapsed:!0,items:[]},x=0;x<checklist.checkItems.length;++x){var check=checklist.checkItems[x],isComplete="complete"===check.state;if(!isComplete){var checkItem={text:check.name,isComplete:isComplete};checklistItem.items.push(checkItem)}}cardItem.items.push(checklistItem),doneCards===totalCards&&doneLists===totalLists&&doneBoards===boards.length&&cb(data)},error)}(cardItem)}}else doneCards++;listItem.items.push(cardItem)}doneLists++,doneCards===totalCards&&doneLists===totalLists&&doneBoards===boards.length&&cb(data)},error)}(listItem)}doneBoards++},error)}(boardItem)}},error)}catch(err){error(err)}},trelloSave:function trelloSaveFn(data,cb,error){function traverse(node,parentVMLI){var nodeVMLI=new VMLI({text:node.text,isComplete:node.isComplete,isCollapsed:node.isCollapsed},{parent:parentVMLI,forceSave:!0,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(nodeVMLI),node.items)for(var i=0;i<node.items.length;++i)traverse(node.items[i],nodeVMLI);return nodeVMLI}try{tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(2888,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Trello Import"},{parent:docRoot,forceSave:!0,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var i=0;i<data.length;++i)traverse(data[i],impRoot);tracker.endAction()}catch(err){return error(err)}cb()},toodledoLogin:function toodledoLoginFn(username,password,cb,error){var clientID="DuchessToodledoClientID",state="Dchs"+(new Date).getTime(),url="https://api.toodledo.com/3/account/authorize.php?response_type=code&client_id="+clientID+"&state="+state+"&scope=basic%20tasks%20notes%20outlines%20lists";window.open(url,"toodledo","height=600,width=550");var handleRelayMessage=function(e){var validOrigin=e.origin===location.origin;validOrigin&&(window.removeEventListener("message",handleRelayMessage),e.data.error?error(e.data.error):(this.toodledo.token=e.data.access_token,cb()))}.bind(this);window.addEventListener("message",handleRelayMessage)},toodledoImport:function toodledoImportFn(cb,error){},toodledoSave:function toodledoSaveFn(data,cb,error){},todoistLogin:function todoistLoginFn(username,password,cb,error){try{g.PAssert(2889,cb,"Todoist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2890,error,"Todoist requires an error callback")}catch(PERR){g.reportError(PERR)}var baseLoginURL="https://todoist.com/API/login?",baseGoogleLoginURL="https://todoist.com/API/loginWithGoogle?",loginURL;if(username&&password)loginURL=baseLoginURL+"email="+username+"&password="+password;else{var email=goog.getCurrentUserEmail(),token=goog.getAccessToken(!0);loginURL=baseGoogleLoginURL+"email="+email+"&oauth2_token="+token}g.JSONP({url:loginURL,cb:function cbFn(user){user&&user.api_token?(this.todoist.token=user.api_token,cb()):error("LOGIN_ERROR"===user?"Your login credentials were incorrect. If you use sign-in with Google through Todoist for this account, please remove your login info above.":"Error talking to the remote server.")}.bind(this)})},todoistImport:function todoistImportFn(cb,error){var baseURL="https://todoist.com/API/",projectsURL=baseURL+"getProjects?token="+this.todoist.token,uncompletedURL=baseURL+"getUncompletedItems?token="+this.todoist.token,output=[],totalProjects=0,seenProjects=0,totalItems=0,seenItems=0,priorityMap=[VMLIFlag.None,VMLIFlag.None,VMLIFlag.P2,VMLIFlag.P1,VMLIFlag.P0];g.JSONP({url:projectsURL,cb:function cbFn(projects){if(projects&&g.isArray(projects))for(var i=0;i<projects.length;++i){var project=projects[i],projectItem={text:project.name,isCollapsed:project.collapsed,items:[]};output.push(projectItem),function handleProject(projectItem){function handleItems(items,isCompleted){if(items&&g.isArray(items)){totalItems+=items.length;for(var j=0;j<items.length;++j){var item=items[j],itemText=item.content;item.due_date&&(itemText+=" @"+item.due_date.toString(International.getFormat(DFormat.MonthDay)));var itemItem={text:itemText,isCompleted:isCompleted,priority:priorityMap[item.priority]};projectItem.items.push(itemItem),seenItems++}seenProjects===totalProjects&&seenItems===totalItems&&cb(output)}else error("Error receiving data.")}totalProjects++,g.JSONP({url:uncompletedURL+"&project_id="+project.id+"&js_date=0",cb:function cbFn(items){seenProjects++,handleItems(items,!1)}.bind(this)})}(projectItem)}else error("Error receiving data.")}.bind(this)})},todoistSave:function todoistSaveFn(data,cb,error){function traverse(node,parentVMLI){var nodeVMLI=new VMLI({text:node.text,isComplete:node.isComplete,isCollapsed:node.isCollapsed,priority:node.priority},{parent:parentVMLI,forceSave:!0,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(nodeVMLI),node.items)for(var i=0;i<node.items.length;++i)traverse(node.items[i],nodeVMLI);return nodeVMLI}try{tracker.beginAction();var docRoot=d.getRootModel();try{g.PAssert(2891,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=new VMLI({text:"Todoist Import"},{parent:docRoot,forceSave:!0,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var i=0;i<data.length;++i)traverse(data[i],impRoot);tracker.endAction()}catch(err){return error(err)}cb()}},dimport}),define("ModalImportData",["ko","globals","util","platform","ModalBase","dimport"],function(ko,g,util,platform,ModalBase,dimport){function ModalImportData(){this._super.constructor.call(this,Modals.ImportData),this.importName=ko.observable("JSON"),this.importDisplayMessage=ko.observable(""),this.importing=ko.observable(!1),this.preloadDisable=ko.observable(!1),this.importer=new dimport,this.init()}var ModalImportDataFns={init:function initFn(){this.registerModal(this.onModalOpen.bind(this))},onModalOpen:function onModalOpenFn(importer){importer&&this.selectImporter(importer),this.importDisplayMessage("")},closeImport:function closeImportFn(){g.menus.closeModal(this.id)},disableImportCancelButton:function disableImportCancelButtonFn(){return this.importing()},disableImportImportButton:function disableImportImportButtonFn(){return this.importing()||this.preloadDisable()>0},isAreaVisible:function isAreaVisibleFn(area){switch(this.importName()){case"Wunderlist":return"LoginArea"===area;case"Workflowy":return"LoginArea"===area;case"OPML":return"UploadArea"===area;case"JSON":return"UploadArea"===area;case"Text":return"TextArea"===area;case"Google Tasks":return"OAuthArea"===area;case"Trello":return"OAuthArea"===area;case"Todoist":return"LoginArea"===area;case"Toodledo":return"OAuthArea"===area;default:try{g.PAssert(2892,!1,"Must add valid importer")}catch(PERR){g.reportError(PERR)}}return!1},highlightImportButton:function highlightImportButtonFn(el){var btnParent=document.getElementById("importLocations");if(btnParent)for(var i=0;i<btnParent.children.length;++i){var btn=btnParent.children[i];btn!==el?g.removeClass(btn,"mat-selected"):g.addClass(btn,"mat-selected")}},onTapRunImportWunderlist:function onTapRunImportWunderlistFn(){this.selectImporter("Wunderlist")},onTapRunImportWorkflowy:function onTapRunImportWorkflowyFn(){this.selectImporter("Workflowy")},onTapRunImportOPML:function onTapRunImportOPMLFn(){this.selectImporter("OPML")},onTapRunImportJSON:function onTapRunImportJSONFn(){this.selectImporter("JSON")},onTapRunImportText:function onTapRunImportTextFn(){this.selectImporter("Text")},onTapRunImportGTasks:function onTapRunImportGTasksFn(){this.selectImporter("GTasks")},onTapRunImportTrello:function onTapRunImportTrelloFn(){this.selectImporter("Trello")},onTapRunImportTodoist:function onTapRunImportTodoistFn(){this.selectImporter("Todoist"),this.importDisplayMessage("To use your current Google account you don't need to re-enter your email or password. Just click Import.")},onTapRunImportToodledo:function onTapRunImportToodledoFn(){this.selectImporter("Toodledo")},selectImporter:function selectImporterFn(name){this.importName("GTasks"===name?"Google Tasks":name),document.getElementById("importEmail").value="",document.getElementById("importPW").value="",this.importDisplayMessage("");var el=document.getElementById("import"+name);this.highlightImportButton(el);var importFn=this.getImporterFromName(this.importName());importFn&&importFn.preload&&(this.preloadDisable(this.preloadDisable()+1),importFn.preload(function(){this.preloadDisable(this.preloadDisable()-1)}.bind(this),function(err){this.preloadDisable(this.preloadDisable()-1),this.onImportError(err)}.bind(this)))},getImporterFromName:function getImporterFromNameFn(name){var importFn;switch(name){case"Wunderlist":importFn=this.importer.wunderlist;break;case"Workflowy":importFn=this.importer.workflowy;break;case"OPML":importFn=this.importer.opml;break;case"JSON":importFn=this.importer.json;break;case"Text":importFn=this.importer.text;break;case"Google Tasks":importFn=this.importer.gtasks;break;case"Trello":importFn=this.importer.trello;break;case"Todoist":importFn=this.importer.todoist;break;case"Toodledo":importFn=this.importer.toodledo;break;default:try{g.PAssert(2893,!1,"Must add valid importer: ",name)}catch(PERR){g.reportError(PERR)}}return importFn},onImportError:function onImportErrorFn(msg,err){try{var message=msg;message&&g.isString(message)||(message="There was an unexpected error. Please double check your data."),this.importing(!1),this.importDisplayMessage(message),g.reportError(err||msg,msg)}catch(errErr){g.reportError(errErr),this.importing(!1)}g.sendEvent("ImportFail",this.importName())},onTapRunImport:function onTapRunImportFn(){if(!this.importing()){var importFn=this.getImporterFromName(this.importName());if(importFn){g.sendEvent("Menu","Import"+this.importName()),this.importing(!0);try{this.importDisplayMessage("Importing..."),setTimeout(function(){var loginName=document.getElementById("importEmail").value,loginPW=document.getElementById("importPW").value;importFn.login(loginName,loginPW,function(){importFn.import(function(data){importFn.save(data,function(){this.importDisplayMessage("Your data was imported successfully!"),this.importing(!1),setTimeout(function(){g.menus.closeModal(Modals.ImportData)}.bind(this),500),g.sendEvent("ImportSuccess",this.importName())}.bind(this),this.onImportError.bind(this))}.bind(this),this.onImportError.bind(this))}.bind(this),this.onImportError.bind(this))}.bind(this),0)}catch(err){this.onImportError("There was an issue importing your data. Please try again later.",err)}}}},importTitle:function importTitleFn(){var name=this.importName();return"OPML"!==name&&"JSON"!==name&&"Text"!==name?"Import data from "+this.importName():"Upload "+name+" File"},importMessage:function importMessageFn(){return this.importDisplayMessage()}};return util.inherit(ModalBase,ModalImportData),util.extend(ModalImportData.prototype,ModalImportDataFns),ModalImportData});var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(view){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},URL=view.URL||view.webkitURL||view,save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=doc.createEvent("MouseEvents");event.initMouseEvent("click",!0,!1,view,0,0,0,0,0,!1,!1,!1,!1,0,null),node.dispatchEvent(event)},webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},force_saveable_type="application/octet-stream",fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){for(var i=deletion_queue.length;i--;){var file=deletion_queue[i];"string"==typeof file?URL.revokeObjectURL(file):file.remove()}deletion_queue.length=0},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},FileSaver=function(blob,name){var filesaver=this,type=blob.type,blob_changed=!1,object_url,target_view,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);return deletion_queue.push(object_url),object_url},dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){(blob_changed||!object_url)&&(object_url=get_object_url(blob)),target_view?target_view.location.href=object_url:window.open(object_url,"_blank"),filesaver.readyState=filesaver.DONE,dispatch_all()},abortable=function(func){return function(){return filesaver.readyState!==filesaver.DONE?func.apply(this,arguments):void 0}},create_if_not_found={create:!0,exclusive:!1},slice;return filesaver.readyState=filesaver.INIT,name||(name="download"),can_use_save_link?(object_url=get_object_url(blob),save_link.href=object_url,save_link.download=name,click(save_link),filesaver.readyState=filesaver.DONE,void dispatch_all()):(view.chrome&&type&&type!==force_saveable_type&&(slice=blob.slice||blob.webkitSlice,blob=slice.call(blob,0,blob.size,force_saveable_type),blob_changed=!0),webkit_req_fs&&"download"!==name&&(name+=".download"),(type===force_saveable_type||webkit_req_fs)&&(target_view=view),req_fs?(fs_min_size+=blob.size,void req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL(),deletion_queue.push(file),filesaver.readyState=filesaver.DONE,dispatch(filesaver,"writeend",event)},writer.onerror=function(){var error=writer.error;error.code!==error.ABORT_ERR&&fs_error()},"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]}),writer.write(blob),filesaver.abort=function(){writer.abort(),filesaver.readyState=filesaver.DONE},filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:!1},abortable(function(file){file.remove(),save()}),abortable(function(ex){ex.code===ex.NOT_FOUND_ERR?save():fs_error()}))}),fs_error)}),fs_error)):void fs_error())},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name)};return FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE,dispatch(filesaver,"abort")},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,view.addEventListener("unload",process_deletion_queue,!1),saveAs}(self);define("FileSaver",function(){}),define("ModalExportData",["ko","globals","util","platform","data","ModalBase","FileSaver"],function(ko,g,util,platform,d,ModalBase){function ModalExportData(){this._super.constructor.call(this,Modals.ExportData),this.mode=ko.observable("html"),this.exportedContent="",this.exportedPreview=ko.observable(""),this.exportArchived=ko.observable(!0),this.exportArchived.subscribe(this.exportData.bind(this)),this.exportKeyHandler=void 0,this.init()}var ModalExportDataFns={init:function initFn(){this.registerModal(this.onModalOpen.bind(this),this.onModalClose.bind(this))},onModalOpen:function onModalOpenFn(){this.exportData(),this.exportKeyHandler=this.onExportKeydown.bind(this),document.addEventListener("keydown",this.exportKeyHandler,!0)},onModalClose:function onModalCloseFn(){document.removeEventListener("keydown",this.exportKeyHandler,!0),this.exportKeyHandler=void 0},onTapCloseExport:function onTapCloseExportFn(){g.menus.closeModal(this.id)},exportData:function exportDataFn(){var content,preview,root=d.getRootItem();if("html"===this.mode())content=d.toHtml(root,this.exportArchived()),preview=content;else if("plain"===this.mode()){var tab="&nbsp;&nbsp;&nbsp;&nbsp;";content=d.toPlainText(root,0,this.exportArchived()),preview=content.replace(/\n/g,"<br>").replace(/\t/g,tab)}else"json"===this.mode()&&(content=d.toJSON(root,!1,this.exportArchived()),preview=content);this.exportedContent=content,this.exportedPreview(preview)},onTapHTML:function onTapHTMLFn(e){this.mode("html"),this.exportData(),this.highlightExportButton(e)},onTapPlain:function onTapPlainFn(e){this.mode("plain"),this.exportData(),this.highlightExportButton(e)},onTapJSON:function onTapJSONFn(e){this.mode("json"),this.exportData(),this.highlightExportButton(e)},highlightExportButton:function highlightExportButtonFn(e){e.srcElement||(e.srcElement=e.target);var btnParent=document.getElementById("exportTypes");if(btnParent)for(var i=0;i<btnParent.children.length;++i){var btn=btnParent.children[i];g.hasClass(btn,"mat-list-button")&&(btn!==e.srcElement?g.removeClass(btn,"mat-selected"):g.addClass(btn,"mat-selected"))}},onTapOpen:function onTapOpenFn(){var content="plain"===this.mode()?this.exportedPreview():this.exportedContent,newWin=open("url");newWin.document.write(content)},onTapSelect:function onTapSelectFn(){var range=g.createSelectionRange();range.selectNodeContents(document.getElementById("exportedContent")),g.setSelectionRange(range)},onTapSaveExport:function onTapSaveExportFn(){var ext;"html"===this.mode()?ext="html":"plain"===this.mode()?ext="txt":"json"===this.mode()&&(ext="json");try{var blob=new Blob([this.exportedContent],{type:"text/plain;charset=utf-8"});saveAs(blob,"moodo."+ext)}catch(err){g.reportError(err)}},onExportKeydown:function onExportKeydownFn(e){return platform.normalizeKeys(e),(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.normCode===KeyCode.A?(this.onTapSelect(),e.preventDefault(),e.stopPropagation(),!1):void 0}};return util.inherit(ModalBase,ModalExportData),util.extend(ModalExportData.prototype,ModalExportDataFns),ModalExportData}),define("VMDebug",["ko","globals","platform","data","ModalReportBug","ModalImportData","ModalExportData"],function(ko,g,platform,d,ModalReportBug,ModalImportData,ModalExportData){function VMDebug(){this.init()}return VMDebug.prototype={init:function initFn(){new ModalReportBug,new ModalImportData,new ModalExportData},addPadding:function addPaddingFn(){var padSize=platform.windowHeight()-platform.getKBSize()+g.topBarHeight;
platform.android&&(padSize=platform.getKBSize()+20),g.element("feedbackScroller").style.paddingBottom=padSize+"px"},removePadding:function removePaddingFn(){document.getElementById("feedbackScroller").style.paddingBottom=""}},VMDebug}),define("VMTimeline",["ko","globals","platform"],function(ko,g,platform){function VMTimeline(){this.notificationItems={},this.numNotificationItemsChanged=0,this.scheduleTimeout=void 0,this.delayNotifications=!1}return window.__FULL_NOTIFICATION_UPDATES=0,window.__SINGLE_NOTIFICATION_UPDATES=0,VMTimeline.prototype={addNotification:function addNotificationFn(item){try{g.PAssert(2894,item,"Must provide a valid item to schedule notifications for")}catch(PERR){g.reportError(PERR)}this.notificationItems[item.id]=item,this.numNotificationItemsChanged++,this.scheduleTimeout||(this.scheduleTimeout=setTimeout(this.pushNotificationsToNative.bind(this),500))},removeNotification:function removeNotificationFn(item){try{g.PAssert(2895,item,"Must provide a valid item to unschedule notifications for")}catch(PERR){g.reportError(PERR)}this.notificationItems[item.id]&&(this.notificationItems[item.id]=void 0,this.numNotificationItemsChanged++,this.scheduleTimeout||(this.scheduleTimeout=setTimeout(this.pushNotificationsToNative.bind(this),500)))},clearNotifications:function clearNotificationsFn(){for(var prop in this.notificationItems)this.notificationItems.hasOwnProperty(prop)&&(this.notificationItems[prop]=void 0,this.numNotificationItemsChanged++);this.scheduleTimeout||(this.scheduleTimeout=setTimeout(this.pushNotificationsToNative.bind(this),500))},shouldNotify:function shouldNotifyFn(item,now){return now||(now=new Date),!item.isComplete()&&!item.allDayDate()&&!item.isArchived()&&(item.date()&&item.date()>now||item.repeatDate())},updateNotifications:function updateNotificationsFn(item){if(!this.delayNotifications&&platform.supportsNotifications()&&!g.isDemoMode()&&g.vmSettings.enabledNotifications()){var now=new Date;item?(window.__SINGLE_NOTIFICATION_UPDATES++,this.shouldNotify(item,now)?this.addNotification(item):this.removeNotification(item)):(window.__FULL_NOTIFICATION_UPDATES++,this.clearNotifications(),g.searchVMLIs({item:g.vmMain.root(),includeArchived:!1,each:function eachFn(item){this.shouldNotify(item,now)&&this.addNotification(item)}.bind(this)}))}},pushNotificationsToNative:function pushNotificationsToNativeFn(){try{g.PAssert(2896,platform.supportsNotifications(),"Platform must support notifications")}catch(PERR){g.reportError(PERR)}var notifications=[];for(var prop in this.notificationItems)if(this.notificationItems.hasOwnProperty(prop)){var item=this.notificationItems[prop];if(item){var entries=item.getNotificationEntries();if(entries)if(g.isArray(entries))for(var i=0;i<entries.length;++i)notifications.push(entries[i]);else notifications.push(entries)}else delete this.notificationItems[prop]}g.nativeBridge.isEnabled()&&g.nativeBridge.sendToApp("scheduledItems",notifications),this.numNotificationItemsChanged=0,this.scheduleTimeout=void 0},notifyPositionChanged:function notifyPositionChangedFn(item){g.vmMain.paneManager.applyFnToPanes("notifyPositionChanged",PaneMode.Timeline,item)},notifyStateChanged:function notifyStateChangedFn(item,type){type===PropChangeType.Date?this.dateUpdated(item):(g.vmMain.paneManager.applyFnToPanes("notifyStateChanged",PaneMode.Timeline,item,type),(!type||g.isAtLeastOneFlagSet(type,PropChangeType.Complete|PropChangeType.Archive))&&this.updateNotifications())},dateUpdated:function dateUpdatedFn(item){g.vmMain.root()&&this.updateNotifications(item),g.vmMain.paneManager.applyFnToPanes("notifyStateChanged",PaneMode.Timeline,item,PropChangeType.Date)},reloadTimelines:function reloadTimelinesFn(){g.vmMain.paneManager.applyFnToPanes("reloadTimeline",PaneMode.Timeline)},load:function loadFn(){},startLoading:function startLoadingFn(){this.delayNotifications=!0,g.vmMain.paneManager.applyFnToPanes("startLoading",PaneMode.Timeline)},endLoading:function endLoadingFn(){g.vmMain.paneManager.applyFnToPanes("endLoading",PaneMode.Timeline),this.delayNotifications=!1,this.updateNotifications()}},VMTimeline}),define("TemplateCache",["ko","globals"],function(ko,g){window.__TOTAL_TEMPLATES=0;var self={},cachedTemplatesDomDataKey="__cached_template__";self.templateSources=function templateSourcesFn(domElem){var templateSources={elem:domElem,__proto__:new ko.templateSources.domElement(domElem)};return templateSources.text=function(value){return 0===arguments.length?templateSources.elem.text:void(templateSources.elem.text=value)},templateSources.nodes=function(value){try{g.PAssert(2898,0===arguments.length)}catch(PERR){g.reportError(PERR)}if(0===arguments.length){var templateData=ko.utils.domData.get(templateSources.elem,cachedTemplatesDomDataKey);if(!templateData){for(var templateText=templateSources.text().replace(/(\r\n|\n|\r|\s*(?=<)|\s*$)/gm,""),parsedNodes=ko.utils.parseHtmlFragment(templateText),compiledNodes=document.createElement("div"),i=0;i<parsedNodes.length;i++)compiledNodes.appendChild(parsedNodes[i]);return ko.utils.domData.set(templateSources.elem,cachedTemplatesDomDataKey,{cachedNodes:compiledNodes}),compiledNodes}return templateData.cachedNodes}},templateSources},self.templateEngine=function templateEngineFn(){var templateEngine={__proto__:new ko.nativeTemplateEngine};return templateEngine.cachedDoc=void 0,templateEngine.makeTemplateSource=function(template,templateDocument){try{g.PAssert(2899,"string"==typeof template)}catch(PERR){g.reportError(PERR)}var incomingDoc=templateDocument||document,cachedDoc=templateEngine.cachedDoc;if(!templateEngine.cachedDoc){try{g.PAssert(2900,incomingDoc)}catch(PERR){g.reportError(PERR)}cachedDoc={doc:incomingDoc,cachedTemplates:{}},templateEngine.cachedDoc=cachedDoc}try{g.PAssert(2901,cachedDoc)}catch(PERR){g.reportError(PERR)}var elem=cachedDoc.cachedTemplates[template];if(!elem){var domElem=cachedDoc.doc.getElementById(template);try{g.PAssert(2902,domElem)}catch(PERR){g.reportError(PERR)}if(domElem)try{elem=new self.templateSources(domElem);try{g.PAssert(2903,elem)}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}else g.reportError(new Error('Unable to find element for template "'+template+'". '+domElem));cachedDoc.cachedTemplates[template]=elem,window.__TOTAL_TEMPLATES++}return elem},templateEngine};var engine=self.templateEngine();return engine instanceof ko.templateEngine&&ko.setTemplateEngine(engine),self}),define("VMAutocompleteItem",["ko","data","globals"],function(ko,d,g){function VMAutocompleteItem(p){this.id=p.id,this.text=ko.observable(p.text||""),this.index=p.index,this.object=p.object,this.isVisible=ko.observable(!0),this.isSelected=ko.observable(!1),this.element=void 0,this.init()}return VMAutocompleteItem.prototype={init:function initFn(){},html:function htmlFn(){var searchText=g.autocomplete.text(),text=this.text();try{g.PAssert(2904,g.isString(searchText),"Search text must be a string: ",searchText)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2905,g.isString(text),"Item text must be a string: ",text)}catch(PERR){g.reportError(PERR)}if(void 0!==text&&void 0!==searchText&&searchText.length>0){var index=text.toLowerCase().indexOf(searchText.toLowerCase()),newText="";return newText=index>=0?text.substr(0,index)+"<b>"+text.substr(index,searchText.length)+"</b>"+text.substr(index+searchText.length):text}return text},onLoad:function onLoadFn(element){this.element=element}},VMAutocompleteItem}),define("AutocompleteDates",["ko","data","globals","platform"],function(ko,d,g,platform){function AutocompleteDates(){this.soft=["now","soon","later","someday"],this.softDays=["today","tomorrow"],this.dayModifiers=["next"],this.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],this.months=["january","february","march","april","may","june","july","august","september","october","november","december"],this.repeatStart=["every"],this.repeatModifier=["first","other","last"],this.dict=this.soft.concat(this.repeatStart).concat(this.softDays).concat(this.repeatModifier).concat(this.dayModifiers).concat(this.days).concat(this.months),this.NextWordOptions={None:0,DayName:1,Days:2,Time:4,Repeat:8},this.nextDateWord=ko.observable(this.NextWordOptions.None),this.init()}return AutocompleteDates.prototype={init:function initFn(){},showAllDates:function showAllDatesFn(){return""===g.autocomplete.text()},showRepeat:function showRepeatFn(){return g.isFlagSet(this.nextDateWord(),this.NextWordOptions.Repeat)},showDate:function showDateFn(){return this.nextDateWord()===this.NextWordOptions.None||g.isFlagSet(this.nextDateWord(),this.NextWordOptions.DayName)},showDays:function showDaysFn(){return g.isFlagSet(this.nextDateWord(),this.NextWordOptions.Days)},showTime:function showTimeFn(){return g.isFlagSet(this.nextDateWord(),this.NextWordOptions.Time)},getShortMonth:function getShortMonthFn(index){return Date.CultureInfo.abbreviatedMonthNames[index]},getLongMonth:function getLongMonthFn(index){return Date.CultureInfo.monthNames[index]},getShortDay:function getShortDayFn(index){return Date.CultureInfo.abbreviatedDayNames[index]},getLongDay:function getLongDayFn(index){return Date.CultureInfo.dayNames[index]},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return item},getItemTextLength:function getItemTextLengthFn(item){return item?item.length:0},getItemStyledText:function getItemStyledTextFn(item){return item},findMatchLike:function findMatchLikeFn(like){for(var lower=like.toLowerCase(),results=[],i=0;i<this.dict.length;++i)0===this.dict[i].indexOf(lower)&&results.push(this.dict[i]);return results},findMatchExact:function findMatchExactFn(text){if(this.dict.indexOf(text)>=0){if(!platform.mobile)return text;if(this.nextWordOptions(text)===this.NextWordOptions.None)return text}return void 0},nextWordOptions:function nextWordOptionsFn(text){var words=text.toLowerCase().split(" "),lastWord=words[words.length-1];if(""===lastWord&&(lastWord=words[words.length-2]),this.soft.indexOf(lastWord)>=0)return this.NextWordOptions.None;if(this.repeatStart.indexOf(lastWord)>=0)return this.NextWordOptions.DayName|this.NextWordOptions.Repeat;if(this.repeatModifier.indexOf(lastWord)>=0)return this.NextWordOptions.DayName;if(this.softDays.indexOf(lastWord)>=0)return this.NextWordOptions.Time;if(this.dayModifiers.indexOf(lastWord)>=0)return this.NextWordOptions.DayName;if(this.days.indexOf(lastWord)>=0)return this.NextWordOptions.Time;if(this.months.indexOf(lastWord)>=0)return this.NextWordOptions.Days;var isInt=parseInt(lastWord,10);return isNaN(isInt)?lastWord.indexOf(":")>=0?this.NextWordOptions.Time:this.NextWordOptions.None:this.NextWordOptions.Time},getMonthList:function getMonthListFn(){var monthsInPast=1,monthsInFuture=5,currentIndex=(new Date).getMonth(),startIndex=currentIndex-monthsInPast;0>startIndex&&(startIndex=12+startIndex);for(var endIndex=startIndex+monthsInPast+monthsInFuture,output=[],i=startIndex;endIndex>i;++i){var monthIndex=i%12;output.push(monthIndex)}return output},getDayList:function getDayListFn(){return[0,1,2,3,4,5,6]},getSoftList:function getSoftListFn(){return this.repeatStart.concat(this.soft)},onTapDate:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var el=e.srcElement;if("SPAN"===el.nodeName){var parentDiv=el.parentNode;if(g.hasClass(parentDiv,"disabled"))return;var text=el.id?el.id+" ":el.textContent,next=this.nextWordOptions(text);this.nextDateWord(next);var hide=next===this.NextWordOptions.None;g.autocomplete.trackingTag.index+=text.length,g.autocomplete.onTapped(text,text.length,hide)}}}},AutocompleteDates}),define("VMNoneManager",["ko","globals"],function(ko,g){function VMNoneManager(){}return VMNoneManager.prototype={init:function initFn(){},previewTemplate:function previewTemplateFn(){return void 0},getItemStyledText:function getItemStyledTextFn(item){return item},getItemText:function getItemTextFn(){return void 0},getItemTextLength:function getItemTextLengthFn(){return 0},findMatchExact:function findMatchExactFn(str){return void 0},findMatchLike:function findMatchLikeFn(str,maxCount){return void 0}},VMNoneManager}),define("VMAutocomplete",["ko","data","globals","goog","platform","android","tracker","VMAutocompleteItem","AutocompleteDates","VMNoneManager"],function(ko,d,g,goog,platform,android,tracker,VMAutocompleteItem,AutocompleteDates,VMNoneManager){function VMAutocomplete(){try{g.PAssert(2906,!g.autocomplete,"Autocomplete is a singleton")}catch(PERR){g.reportError(PERR)}g.autocomplete=this,this.isEnabled=!0,this.items=ko.observableArray(),this.isVisible=ko.observable(!1),this.contactsEnabled=ko.observable(!0),this.element=void 0,this.trackingItem=void 0,this.trackingTag=void 0,this._activeOwner=void 0,this.selectedIndex=ko.observable(-1).extend({notify:"always"}),this.exactMatch=ko.observable(!1),this.text=ko.observable(""),this.lastParams=void 0,this.autocompleteDates=new AutocompleteDates,this.previousSelectionRect={},this.mode=ko.observable(void 0),this._validProviders=[],this._provider=void 0,this.registerProvider(ACProvider.None,new VMNoneManager),this.registerProvider(ACProvider.Contact,d.contactManager),this.registerProvider(ACProvider.DatePicker,this.autocompleteDates),this.registerProvider(ACProvider.DateList,this.autocompleteDates),this.registerProvider(ACProvider.Tag,d.tagManager),this._prefixes=[ContactPrefix,DatePrefix,TagPrefix],this._prefixMap={},this._prefixMap[ContactPrefix]=ACProvider.Contact,this._prefixMap[TagPrefix]=ACProvider.Tag,this._prefixMap[DatePrefix]=platform.mobile&&platform.app?ACProvider.DatePicker:ACProvider.DateList,g.vmMain.pluginManager.runForEachPlugin(function(plugin){plugin.registerAutocomplete()}),this.mode(ACProvider.None),this.init()}return VMAutocomplete.prototype={showDates:function showDatesFn(){return this.mode()===ACProvider.DatePicker&&(""===this.text()||this.autocompleteDates.nextDateWord())},showList:function showListFn(){return!(this.exactMatch()||this.showDates()||this.mode()===ACProvider.Contact&&!this.contactsEnabled())},showPreview:function showPreviewFn(){return this.mode()&&this._provider.previewTemplate()&&this.items().length>0&&this.selectedIndex()>=0&&this.selectedItem()&&(!platform.mobile||this.exactMatch())},showEnableContactsUI:function showEnableContactsUIFn(){return this.mode()===ACProvider.Contact&&this.isVisible()&&!this.contactsEnabled()},hasContent:function hasContentFn(){return this.showDates()||this.showList()||this.showPreview()||!this.contactsEnabled()},previewTemplate:function previewTemplateFn(){try{g.PAssert(2907,this._provider,"Provider must be valid")}catch(PERR){g.reportError(PERR)}return this._provider.previewTemplate()},autocompleteWidth:function autocompleteWidthFn(){return this.mode()&&this._provider.autocompleteWidth?this._provider.autocompleteWidth()+"px":void 0},selectedItem:function selectedItemFn(){try{g.PAssert(2908,this.selectedIndex()>=0,"Should always have a valid selection index")}catch(PERR){g.reportError(PERR)}if(this.selectedIndex()<0)return void 0;try{g.PAssert(2909,void 0!==this.items()[this.selectedIndex()],"Autocomplete should always have valid entries")}catch(PERR){g.reportError(PERR)}return this.items()[this.selectedIndex()]},init:function initFn(){this.onkeydown=this.onkeydown.bind(this),window.addEventListener("closeKeyboard",this.hide.bind(this)),this.element=document.getElementById("autocomplete"),g.applyBindings(this,"autocomplete"),platform.isTouchDevice&&this.element.addEventListener(platform.touchStartEvent,function(e){return this.showPreview()||g.preventScrollPropagation(this.element)?void 0:(e.preventDefault(),!1)}.bind(this))},registerProvider:function registerProviderFn(provider,obj){try{g.PAssert(2910,!this._validProviders[provider],"Registering a provider that has already been registered")}catch(PERR){g.reportError(PERR)}this._validProviders[provider]=obj},registerPrefix:function registerPrefixFn(provider,prefix){try{g.PAssert(2911,!this._prefixMap[prefix],"Should only register a prefix once")}catch(PERR){g.reportError(PERR)}this._prefixes.push(prefix),this._prefixMap[prefix]=provider},setProviderMode:function setProviderModeFn(mode){if(this.mode()!==mode){this._provider=this._validProviders[mode];try{g.PAssert(2912,this._provider,"Provider must be valid",mode)}catch(PERR){g.reportError(PERR)}this.clear(),this.mode(mode)}},getProviderForPrefix:function getProviderForPrefixFn(prefix){var provider=this._prefixMap[prefix]||ACProvider.None;return provider},show:function showFn(elTapped){var sel,completionElement=elTapped;if(!completionElement&&(sel=document.getSelection(),sel&&sel.anchorNode)){var isContact=g.findParent(sel.anchorNode,"contact",2);completionElement=isContact||g.findParent(sel.anchorNode,"date",2)||g.findParent(sel.anchorNode,"tag",2),isContact&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenContact,data:[{}]})}if(this.completionElement=completionElement,this.showList()){try{g.PAssert(2914,this.element.children.length>0,"Must always have an items element when showing list")}catch(PERR){g.reportError(PERR)}this.element.children[0].style.maxHeight=""}var windowBounds=document.documentElement.getBoundingClientRect(),selectionRect;if(completionElement)selectionRect=completionElement.getBoundingClientRect();else if(android.isEnabled())selectionRect=this._activeOwner.getSpan().getBoundingClientRect();else if(sel.rangeCount>0){var selectionRect=g.getSelectionCoords();selectionRect.bottom=selectionRect.top+15}if(selectionRect){var yDiff=Math.abs(selectionRect.top-this.previousSelectionRect.top);if(yDiff>10||!this.isVisible()||elTapped){platform.mobile?selectionRect.left=0:selectionRect.left-=10;var position={left:selectionRect.left,top:selectionRect.bottom};if(!platform.mobile){var newHeight=g.adjustHeightToBeInsideBounds(windowBounds,position,250,600,10),width=this.mode()===ACProvider.Contact?550:250;if(position.left=g.adjustLeftToBeInsideBounds(windowBounds,position.left,width,10),this.showList()){try{g.PAssert(2915,this.element.children.length>0,"Must always have an items element when showing list")}catch(PERR){g.reportError(PERR)}this.element.children[0].style.maxHeight=newHeight+"px"}}var translate="translate("+position.left+"px, "+position.top+"px)";if(g.isDemoMode()&&window.__AUTOCOMPLETE_SCALE&&(translate+=" scale("+window.__AUTOCOMPLETE_SCALE+")"),this.element.style[platform.transform.style]=translate,this.isVisible(!0),platform.mobile&&this._activeOwner){var time=150,bottomOfItem=0;if(this.mode()===ACProvider.Contact&&elTapped)this.element.style.top="",g.isKeyboardOpen?(this.element.style.paddingBottom="30px",this.element.style.bottom=android.isEnabled()?platform.getKBTop()+"px":0):(this.element.style.paddingBottom=0,this.element.style.bottom=0);else{var amtMoved=g.scrollToTop(this._activeOwner.getSpan(),time),bounds=completionElement?completionElement.getBoundingClientRect():this._activeOwner.getSpan().getBoundingClientRect();bottomOfItem=bounds.bottom-amtMoved,this.element.style.paddingBottom="",this.element.style.top=bottomOfItem+4+"px",this.element.style.bottom=platform.getKBTop()+"px",this.mode()===ACProvider.Contact?g.phoneMenu.contactMode(!0):this.mode()===ACProvider.DatePicker?g.phoneMenu.dateMode(!0):this.mode()===ACProvider.Tag&&g.phoneMenu.tagMode(!0)}g.keyboardToolbar.isVisible(!1);var trans=platform.windowHeight()-platform.kbsize-bottomOfItem;g.setTransform(this.element,0,trans),requestAnimationFrame(function(){g.setTransform(this.element,0,0,time,"ease-out")}.bind(this))}this.previousSelectionRect=selectionRect,tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenAutocomplete})}}},clear:function clearFn(){this.items.removeAll(),this.selectedIndex(-1),this.trackingTag=!1},hide:function hideFn(){if(this.isVisible()){var time=200;if(platform.mobile){var trans=platform.windowHeight()-platform.kbsize;g.setTransform(this.element,0,trans,time,"ease-out"),setTimeout(function(){this.selectedIndex(-1),this.isVisible(!1),g.phoneMenu.normalMode(!0),g.isKeyboardOpen&&g.keyboardToolbar.isVisible(!0),this.clear()}.bind(this),time)}else this.selectedIndex(-1),this.isVisible(!1);tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseAutocomplete})}},onkeydown:function onkeydownFn(e){if(!this.isEnabled)return!0;if(0===this.items().length||!this.isVisible()||this.exactMatch()&&e.normCode!==KeyCode.Escape)return!0;if(e.normCode===KeyCode.UpArrow||e.normCode===KeyCode.DownArrow){if(this.items().length>1){var newIndex=this.selectedIndex()+(e.normCode===KeyCode.DownArrow?1:-1);this.selectedIndex(0>newIndex?this.items().length+newIndex:newIndex>=this.items().length?newIndex%this.items().length:newIndex);var listEle=document.getElementById("autocompleteItems");return g.scrollIntoView(listEle.children[this.selectedIndex()],200),!1}this.hide()}else{if(e.normCode===KeyCode.Enter){if(this.selectedIndex()>=0){var item=this.items()[this.selectedIndex()];this.onTapped(this._provider.getItemText(item),this._provider.getItemTextLength(item),!0)}return this.hide(),!1}if(e.normCode===KeyCode.Escape)return this.hide(),!1}return!0},onTap:{onClick:function onClickFn(e){var item=ko.dataFor(e.srcElement);item&&item!==this&&this.onTapped(this._provider.getItemText(item),this._provider.getItemTextLength(item),!0),e.preventDefault(),e.stopImmediatePropagation()}},onTapped:function onTappedFn(text,textLength,hide){try{g.PAssert(2916,!text||g.isString(text),"Text must be a valid string",text)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2917,textLength,g.isNumber(textLength),"TextLength must be a valid number",textLength)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2918,void 0===hide||g.isBoolean(hide),"Hide must be a boolean value",hide)}catch(PERR){g.reportError(PERR)}this.trackingTag&&(this.text(text),this._activeOwner&&this._activeOwner.onAutocompleteTapped(text,textLength,this.trackingTag)),hide&&this.hide()},find:function findFn(words,start,num,forceSpace){if(start+num>words.length-1)return void 0;if(this.mode()===ACProvider.None)return void 0;try{g.PAssert(2919,this._provider,"Must have a valid AC provider in use")}catch(PERR){g.reportError(PERR)}var text=words[start];isNaN(num)&&(num=0);for(var i=0;num>i&&words[start+i+1];i++)text+=" "+words[start+i+1];forceSpace&&void 0!==words[start+num+1]&&(text+=" ");var results=this._provider.findMatchLike(text,25);return results.length>0?this.find(words,start,num+1,forceSpace)||{text:text,results:results}:void 0},setItems:function setItemsFn(items){this.items(items)},checkPrefixes:function checkPrefixesFn(word){for(var i=0;i<this._prefixes.length;i++)if(word.startsWith(this._prefixes[i]))return this._prefixes[i].length},getAutocompleteInfo:function getAutocompleteInfoFn(words,selectionStart){for(var provider=ACProvider.None,lineIndex=0,startWord=-1,startChar=-1,prefixLength=0,i=0;i<words.length&&selectionStart>=lineIndex;++i){var word=words[i],tempLength=this.checkPrefixes(word);tempLength&&(startWord=i,startChar=lineIndex,prefixLength=tempLength),lineIndex+=word.length+1}return startWord>=0&&(provider=this.getProviderForPrefix(words[startWord].substr(0,prefixLength)),words[startWord]=words[startWord].substr(prefixLength)),{startWord:startWord,startChar:startChar,provider:provider,prefixLength:prefixLength}},update:function updateFn(params){if(!this.isEnabled)return!0;try{g.PAssert(2920,params,"Params must be passed in")}catch(PERR){g.reportError(PERR)}this.lastParams=params,this._activeOwner=params.owner||this._activeOwner;var text=this._activeOwner.getACText()||"",selectionStart=params.start,fromArrows=params.fromArrows;this.trackingTag=!1;var words=text.split(" "),forceSpace=!1;try{var range=g.getSelectionRange();if(range){var offsets=g.getSelectOffsetsInSpan(this._activeOwner.getSpan(),range);offsets&&(forceSpace=" "===text[offsets.startText-1])}}catch(err){g.reportError(err)}var acInfo;if(acInfo=this._activeOwner.getAutocompleteInfo?this._activeOwner.getAutocompleteInfo(words,selectionStart):this.getAutocompleteInfo(words,selectionStart),this.setProviderMode(acInfo.provider),acInfo.provider!==ACProvider.None){try{g.PAssert(2921,selectionStart>=acInfo.startChar,"Start of autocomplete word must be before selection start")}catch(PERR){g.reportError(PERR)}var result=this.find(words,acInfo.startWord,0,forceSpace),addAmount=acInfo.prefixLength;" "===text[selectionStart-1]&&addAmount++;var doShow=!1;if(result&&acInfo.startChar+addAmount+result.text.length>=selectionStart){var exactMatch=this._provider.findMatchExact(result.text);this.exactMatch(!!exactMatch),exactMatch?(this.setItems([exactMatch]),this.trackingTag=!0,fromArrows||platform.mobile||(doShow=!0)):(this.trackingTag={text:result.text,index:acInfo.startChar+acInfo.prefixLength,replaceLength:this._provider.autocompleteReplace?acInfo.prefixLength:0,length:result.text.length},this.text(result.text),this.setItems(result.results),fromArrows||(doShow=!0)),this.selectedIndex(0)}else if(!result&&this.mode()===ACProvider.Contact&&!g.settings.get(Settings.syncContacts)&&!fromArrows){for(var hasSpace=!1,i=acInfo.startChar;selectionStart>i;++i)if(" "===text[i]){hasSpace=!0;break}hasSpace||(this.trackingTag=void 0,g.isDemoMode()||this.contactsEnabled(!1),doShow=!0)}doShow&&this.show()}if(this.autocompleteDates.nextDateWord(this.autocompleteDates.NextWordOptions.None),this.trackingTag===!1){try{g.PAssert(2922,!doShow,"Should never show then hide autocomplete in the same call")}catch(PERR){g.reportError(PERR)}this.hide()}},isItemSelected:function isItemSelectedFn(index){return this.selectedIndex()===index()},renderItem:function renderItemFn(item){var searchText=this.text(),itemText=this._provider.getItemStyledText(item,searchText);if(void 0!==itemText&&void 0!==searchText&&searchText.length>0){var index;g.isString(itemText)?index=itemText.toUpperCase().indexOf(searchText.toUpperCase()):(index=itemText.index,itemText=itemText.text);var newText;return newText=index>=0?itemText.substr(0,index)+"<b>"+itemText.substr(index,searchText.length)+"</b>"+itemText.substr(index+searchText.length):itemText}return g.isString(itemText)?itemText:itemText.text},onMouseover:function onMouseoverFn(UNUSED,e){if(this.showList()){var index=0,ele=e.srcElement||e.target,item=ko.dataFor(ele);if(item&&item!==this){index=this.items.indexOf(item);try{g.PAssert(2923,index>=0,"Must be able to compute a valid selection index")}catch(PERR){g.reportError(PERR)}this.selectedIndex(index)}}},onTapEnableContacts:{onClick:function onClickFn(e){g.vmSettings.enableSyncContacts(function(value){value&&(this.contactsEnabled(!0),g.settings.set(Settings.syncContacts,!0),this.lastParams&&(this.update(this.lastParams),this.show(this.completionElement)))}.bind(this)),e.preventDefault(),e.stopImmediatePropagation()}}},VMAutocomplete}),define("ScreenManager",["ko","globals","platform"],function(ko,g,platform){function ScreenManager(){this._isSwiping=!1,this.swipePoints=[],this.lastOffset=0,this.isOutlineOpen=g.vmMain.outline.isVisible,this.paneWidth=.85,this.init()}return ScreenManager.prototype={init:function initFn(){},isSwiping:function isSwipingFn(){return this._isSwiping},startSwipe:function startSwipeFn(){this._isSwiping||(this._isSwiping=!0)},updateSwipe:function updateSwipeFn(diff,time){try{g.PAssert(2924,this.isSwiping(),"Must be swiping to perform an update")}catch(PERR){g.reportError(PERR)}var returnValue=!1;if(platform.ios||platform.android||platform.mobileie){var offset=this.lastOffset-diff,max=platform.windowWidth.peek()*this.paneWidth;offset=Math.max(Math.min(offset,max),0),this.swipePoints.splice(0,0,{time:time,x:diff}),this.swipePoints.length>20&&this.swipePoints.splice(this.swipePoints.length-1,1),this.lastOffset!==offset?(this.lastOffset=offset,returnValue=offset):returnValue=this.lastOffset}return returnValue},endSwipe:function endSwipeFn(){try{g.PAssert(2925,this.isSwiping(),"Must be swiping to end a swipe")}catch(PERR){g.reportError(PERR)}for(var snapIndex=-1,now=Date.now(),timeThresh=300,velThresh=200,sum=0,totalTime=0,i=0;i<this.swipePoints.length;i++){var p=this.swipePoints[i];if(!(now-p.time<timeThresh))break;sum+=p.x,totalTime=now-p.time}var v=sum/(totalTime/1e3);snapIndex=-velThresh>v?1:v>velThresh?0:Math.round(this.lastOffset/platform.windowWidth());var oldOutlineOpen=this.isOutlineOpen();return this.isOutlineOpen(snapIndex>0),this.updatePanePosition(),platform.ios&&g.preventClick(),this._isSwiping&&(this._isSwiping=!1),oldOutlineOpen!==this.isOutlineOpen()},updatePanePosition:function updatePanePositionFn(){var x=this.isOutlineOpen()?platform.windowWidth()*this.paneWidth:0;g.focusedPane.updatePosition(x,!0)},checkSwipeStart:function checkSwipeStartFn(e){var returnValue=!1;return g.canRevealMenu=!0,g.isKeyboardOpen&&!this.isOutlineOpen()&&(g.revealTimeout=setTimeout(function(){g.canRevealMenu=!1,g.revealTimeout=void 0},400)),this.swipePoints.length=0,platform.ie&&!platform.mobile||platform.mobile&&(this.lastOffset=this.isOutlineOpen()?platform.windowWidth()*this.paneWidth:0,this.isOutlineOpen()&&e.eventX>this.paneWidth*platform.windowWidth()&&(e.preventDefault(),returnValue=!0)),returnValue},checkSwipeMove:function checkSwipeMoveFn(e){var returnValue=!1;if(g.revealTimeout&&(clearTimeout(g.revealTimeout),g.revealTimeout=void 0),g.canRevealMenu)if(platform.ie&&!platform.mobile);else if(platform.mobile){var hasHoriz=!this.isOutlineOpen()&&e.diffX>5||this.isOutlineOpen()&&e.diffX<-5;if(this.isSwiping()||Math.abs(e.distanceY)<10&&hasHoriz){this.isSwiping()||this.startSwipe(),e.preventDefault(),e.stopImmediatePropagation();var x=this.updateSwipe(-e.xThisFrame,e.timeStamp);g.focusedPane.updatePosition(x),returnValue=!0}}return returnValue},checkSwipeClick:function checkSwipeClickFn(e){return g.canRevealMenu&&this.isOutlineOpen()&&e.eventX>this.paneWidth*platform.windowWidth()?(this._isSwiping=!1,this.closeOutline(),!0):this._isSwiping},checkSwipeEnd:function checkSwipeEndFn(e){var returnValue=!1;return g.canRevealMenu&&this.isSwiping()&&(returnValue=this.endSwipe(e)),g.canRevealMenu=!0,returnValue},openOutline:function openOutlineFn(){g.focusedPane.updatePosition(platform.windowWidth()*this.paneWidth,!0),this.isOutlineOpen(!0)},closeOutline:function closeOutlineFn(){g.focusedPane.updatePosition(0,!0),this.isOutlineOpen(!1)},toggleOutline:function toggleOutlineFn(){this.isOutlineOpen()?this.closeOutline():this.openOutline()}},ScreenManager}),define("VMTooltip",["ko","globals","platform"],function(ko,g,platform){function VMTooltip(){this.listenerElement=void 0,this.displayElement=void 0,this.element=void 0,this.arrowElement=void 0,this.displayTimeout=void 0,this.extraTimeout=void 0,this.displayText=ko.observable(""),this.displayExtra=ko.observable(""),this.arrowClass=ko.observable("notVisible"),this.arrowX=ko.observable(0),this.tipExtras={},g.applyBindings(this,"tooltip"),this.init()}var displayDelay=400,extraDelay=1e3;return VMTooltip.prototype={init:function initFn(){},onLoad:function onLoadFn(){this.element=document.getElementById("tooltip"),this.tooltipArrow=document.getElementById("tooltipArrow"),platform.touch||(this.listenerElement=document.getElementById("outerWrapper"),this.listenerElement&&(this.listenerElement.addEventListener("mouseover",this.handleEleOver.bind(this),!0),this.listenerElement.addEventListener("mouseout",this.handleEleOut.bind(this),!0)))},register:function registerFn(elem,text){this.update(elem,text)},update:function updateFn(elem,text){elem.setAttribute("tooltip",text)},tipIn:function tipInFn(e){this.displayElement!==e.srcElement&&(clearTimeout(this.displayTimeout),this.displayTimeout=setTimeout(this.displayTip.bind(this),displayDelay,{element:e.srcElement,offset:{y:5}}))},adjustBounds:function adjustBoundsFn(options){var arrowSize=40,time=0,windowBounds=document.documentElement.getBoundingClientRect(),targetBounds;this.displayElement?targetBounds=this.displayElement.getBoundingClientRect():options&&options.bottom&&(targetBounds={left:0,width:platform.windowWidth(),top:platform.windowHeight()},g.vmMain.gdriveStatus()!==DriveStatus.Online&&(targetBounds.top-=20),options.above=!0);
var width=g.width(this.element),x=targetBounds.left+targetBounds.width/2-width/2,y;y=options&&options.above?targetBounds.top-g.height(this.element):targetBounds.bottom;var offset=options&&options.offset;offset?(offset.x?x+=offset.x:offset.right?x=windowBounds.right-width-offset.right:offset.left&&(x=offset.left),offset.y&&(y+=offset.y)):options&&options.above?y-=5:y+=5;var newX=x;x+width>windowBounds.right?newX=windowBounds.right-width-8:0>x&&(newX=8);var arrow=options&&options.arrow;if(arrow){var arrowX=(width-arrowSize)/2;newX!==x&&(arrowX+=x-newX),this.arrowClass(arrow),this.arrowX(arrowX+"px")}else this.arrowClass("notVisible");options&&options.time&&(time=options.time),g.setTransform(this.element,newX,y,time)},displayTip:function displayTipFn(options){try{g.PAssert(2926,options,"When display a tooltip, must pass in some info")}catch(PERR){g.reportError(PERR)}if(options){clearTimeout(this.displayTimeout),this.displayTimeout=void 0,clearTimeout(this.extraTimeout),this.extraTimeout=void 0;var element=this.displayElement=options.element,text;options.text?text=options.text:element&&(text=element.getAttribute("tooltip"));try{g.PAssert(2927,text,"When display a tooltip, elements should always have valid data set")}catch(PERR){g.reportError(PERR)}if(text&&(this.displayText(text),this.element.style["max-width"]=options.maxWidth?options.maxWidth+"px":"",this.adjustBounds(options),!platform.mobile)){try{g.PAssert(2928,this.displayElement,"Display element must be valid")}catch(PERR){g.reportError(PERR)}this.extraTimeout=setTimeout(this.showExtra.bind(this),extraDelay)}}},tipOut:function tipOutFn(e){e.srcElement||(e.srcElement=e.target);var isAncestor=!1,newTarget=e.toElement||e.relatedTarget;newTarget&&(isAncestor=g.isAncestor(newTarget,e.srcElement)),isAncestor||e.srcElement===newTarget||newTarget===this.element||this.hideTip()},handleEleOver:function handleEleOverFn(e){e.srcElement||(e.srcElement=e.target);var infoText=e.srcElement.getAttribute("tooltip");infoText&&this.tipIn(e)},handleEleOut:function handleEleOutFn(e){e.srcElement||(e.srcElement=e.target),this.tipOut(e)},showExtra:function showExtraFn(){var extraString;try{g.PAssert(2929,this.displayElement,"There should be a display element when showing extra information")}catch(PERR){g.reportError(PERR)}if(this.displayElement){if(this.displayElement.id){var idString="#"+this.displayElement.id;this.tipExtras[idString]&&(extraString=idString)}if(!extraString)for(var i=0;i<this.displayElement.classList.length;++i){var classString="."+this.displayElement.classList[i];if(this.tipExtras[classString]){extraString=classString;break}}if(extraString){var extraInfo=this.tipExtras[extraString];extraInfo&&(this.displayExtra(extraInfo),this.adjustBounds())}clearTimeout(this.extraTimeout),this.extraTimeout=void 0}},hideTip:function hideTipFn(){this.displayElement=void 0,clearTimeout(this.displayTimeout),this.displayTimeout=void 0,clearTimeout(this.extraTimeout),this.extraTimeout=void 0,this.displayText(""),this.displayExtra("")},onTap:function onTapFn(e){g.intro.nextStep(),e.stopImmediatePropagation(),e.preventDefault()}},VMTooltip}),define("AppCache",["ko","globals","platform"],function(ko,g,platform){function AppCache(){this.updateWaitTime=g.minutes(120),this.notifiedOfNew=!1,this.isFinished=!1,this.showCancel=ko.observable(!1),this.downloadingTimeout=0,this.lastUpdate=0,this.startStatus=window.applicationCache?window.applicationCache.status:-2,this.continuedUpdate=!1,this.updateActionDone=!1,this.fnToRun=[],this.requiredUpdate=!1,this.appUpdatePending=!1,this.runUpdate=!1,this.init()}return AppCache.prototype={init:function initFn(){log("Cache Status: "+this.startStatus),window.applicationCache?(window.applicationCache.addEventListener("noupdate",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("cached",this.onFirstUpdateReady.bind(this)),window.applicationCache.addEventListener("downloading",this.onUpdateDownloading.bind(this)),window.applicationCache.addEventListener("updateready",this.onUpdateReady.bind(this)),window.applicationCache.addEventListener("obsolete",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("error",this.onUpdateError.bind(this)),window.applicationCache.status>=window.applicationCache.UPDATEREADY||document.documentElement.attributes.getNamedItem("manifest")||this.onCacheLoadFinished()):this.onCacheLoadFinished()},isVisible:function isVisibleFn(value){value&&g.isDemoMode()&&g.reload()},update:function updateFn(){if(Date.now()-this.lastUpdate>this.updateWaitTime&&window.applicationCache.status===window.applicationCache.IDLE){this.lastUpdate=Date.now();try{applicationCache.update()}catch(err){g.reportError(err)}}},checkForUpdate:function checkForUpdateFn(forceUpdate,runUpdate){this.requiredUpdate=!!forceUpdate,this.runUpdate=!!runUpdate,this.appUpdatePending?this.appUpdatePending&&this.runUpdate&&g.reload():this.update()},endRunUpdate:function endRunUpdateFn(){this.runUpdate=!1},runOnFinish:function runOnFinishFn(cb,isTerminal){try{g.PAssert(2930,0===this.fnToRun.length,"Only a single callback is allowed to be run at this point.")}catch(PERR){g.reportError(PERR)}this.isFinished?setTimeout(cb,0):this.fnToRun.push(cb)},onUpdateReady:function onUpdateReadyFn(){log("Cache: New version available"),this.appUpdatePending=!0,this.startStatus===window.applicationCache.UNCACHED&&log("Cache Update from UNCACHED state. ERROR."),this.onCacheLoadFinished(),this.updateAction()},onFirstUpdateReady:function onFirstUpdateReadyFn(){log("Cache: first update")},onUpdateError:function onUpdateErrorFn(ev){platform.demo||g.vmMain&&!g.vmMain.isOnline()||log("Update Error: ",ev),this.isVisible(!1),this.onCacheLoadFinished()},onUpdateDownloading:function onUpdateDownloadingFn(){log("Cache: New version downloading")},onCacheLoadFinished:function onCacheLoadFinishedFn(){if(log("Cache: No update"),!this.isFinished){this.isFinished=!0;for(var i=0;i<this.fnToRun.length;++i)this.fnToRun[i]()}},notifyOfUpdate:function notifyOfUpdateFn(){this.notifiedOfNew||(this.notifiedOfNew=!0,g.setAppCacheUpdateState(!0),this.startStatus!==window.applicationCache.UNCACHED&&(g.StopSpinner(),this.isVisible(!0)))},updateAction:function updateActionFn(){this.runUpdate||!platform.isPageVisible()?g.reload():this.requiredUpdate?g.menus.alert({text:"A software update is required to continue. Please reload to update.",actionText:"RELOAD",action:g.reload}):this.isVisible(!0),g.sendEvent("AppCache","Update")}},AppCache}),define("NativeAPI",["ko","globals","util"],function(ko,g,util){function NativeAPI(name){try{g.PAssert(2931,void 0===window.__MoodoBridge[name],"Registering an Inbound API that already exists on the window object",name)}catch(PERR){g.reportError(PERR)}this._name=name,this._publicObj={},this._privateObj={},window.__MoodoBridge[name]=this._publicObj,this.init()}return NativeAPI.prototype={init:function initFn(){},registerFunction:function registerFunctionFn(name,fn,isPublic){try{g.PAssert(2932,name,"Name must be provided to register function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2933,fn,"A valid function must be provided to register")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2934,void 0===this._privateObj[name],"Re-registering an api function on private obj",name)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2935,void 0===this._publicObj[name],"Re-registering an api function on public obj",name)}catch(PERR){g.reportError(PERR)}this._privateObj[name]=fn.bind(this._privateObj),isPublic&&(this._publicObj[name]=this._privateObj[name])},registerVariable:function registerVariableFn(name,value,isPublic){try{g.PAssert(2936,name,"Name must be provided to register variable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2937,!isPublic,"Public variables are not currently supported")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2938,void 0===this._privateObj[name],"Re-registering an api variable on private obj")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2939,void 0===this._publicObj[name],"Re-registering an api variable on public obj")}catch(PERR){g.reportError(PERR)}this._privateObj[name]=value}},util.defineBase(NativeAPI),NativeAPI}),define("NativeOutAPI",["ko","globals","util"],function(ko,g,util){function NativeOutAPI(name){this._name=name,this._apiLoaded=!1,this._apiError=!1,this._listeners=void 0,this._requiredFns=[],this._missingFns=void 0,this.init()}var checkTimeout=1e3;return NativeOutAPI.prototype={init:function initFn(){g.isObject(window[this._name])?this.onAPILoaded():(util.forceBind("_checkAPI",this),setTimeout(this._checkAPI,checkTimeout))},_checkAPI:function _checkAPIFn(){try{g.PAssert(2940,!this._apiLoaded,"Should not be checking for API load if already loaded")}catch(PERR){g.reportError(PERR)}g.isObject(window[this._name])&&this.onAPILoaded(),this._apiLoaded||setTimeout(this._checkAPI,checkTimeout)},onAPILoaded:function onAPILoadedFn(){this._apiLoaded=!0;for(var i=0;i<this._requiredFns.length;++i)g.isFunction(window[this._name][name])||(this._apiError=!0,this._addMissingFn(name));this.notifyListeners()},requestNotification:function requestNotificationFn(cb){this._apiLoaded?setTimeout(cb,0):this._listeners?this._listeners.push(cb):this._listeners=[cb]},notifyListeners:function notifyListenersFn(){try{g.PAssert(2941,this._apiLoaded,"API must be loaded to notify listeners")}catch(PERR){g.reportError(PERR)}if(this._listeners)for(var i=0;i<this._listeners.length;++i)this._listeners[i]();this._listeners=void 0},requireFunction:function requireFunctionFn(name){try{g.PAssert(2942,this._requiredFns.indexOf(name)<0,"Should not double require a single function")}catch(PERR){g.reportError(PERR)}this._requiredFns.push(name),this._apiLoaded&&(g.isFunction(window[this._name][name])||(this._apiError=!0,this._addMissingFn(name)))},_addMissingFn:function _addMissingFnFn(name){if(this._missingFns){try{g.PAssert(2943,this._missingFns.indexOf(name)<0,"Should not be missing the same function multiple times")}catch(PERR){g.reportError(PERR)}this._missingFns.push(name)}else this._missingFns=[name]},call:function callFn(name){try{g.PAssert(2944,this._apiLoaded,"Trying to call an API function before it is loaded",name)}catch(PERR){g.reportError(PERR)}if(this._apiLoaded){var args=Array.prototype.slice.call(arguments,1);try{return window[this._name][name].apply(window[this._name],args)}catch(err){g.reportError(err)}}return void 0}},util.defineBase(NativeOutAPI),NativeOutAPI}),define("NativeBridge",["globals","platform","tracker","android","goog","gdata","NativeAPI","NativeOutAPI"],function(g,platform,tracker,android,goog,gdata,NativeAPI,NativeOutAPI){function NativeBridge(){if(platform.app)try{this.backlog=[],this._iOS7Queue=[],this._iOS7QueueTimeout=void 0,this.flushingBacklog=!1,this.isPokingBackground=!1,this.setupFns=[],this.setupFns[AppPlatform.iOS]=this.setupiOS.bind(this),this.setupFns[AppPlatform.Android]=this.setupAndroid.bind(this),this.setupFns[AppPlatform.WinPhone]=void 0,this.setupFns[AppPlatform.Chrome]=this.setupChrome.bind(this),this.sendFns=[],this.sendFns[AppPlatform.iOS]=this.sendToAppiOS.bind(this),this.sendFns[AppPlatform.Android]=this.sendToAppAndroid.bind(this),this.sendFns[AppPlatform.WinPhone]=void 0,this.sendFns[AppPlatform.Chrome]=this.sendToAppChrome.bind(this),this.setupFn=this.setupFns[platform.appPlatform],this.sendFn=this.sendFns[platform.appPlatform],this.init(),this._isEnabled=!0}catch(err){log("Native API Bridge Disabled"),g.reportError(err)}else this._isEnabled=!1;if(platform.app||platform.embed){try{g.PAssert(2945,void 0===window.__MoodoBridge,"Must not have a previous bridge in place")}catch(PERR){g.reportError(PERR)}window.__MoodoBridge={},this._canRegisterAPIs=!0,this._inboundAPIs={},this._outboundAPIs={}}}return NativeBridge.prototype={init:function initFn(){try{g.PAssert(2946,this.setupFn,"Must have a valid setup function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2947,this.sendFn,"Must have a valid send function")}catch(PERR){g.reportError(PERR)}this.setupFn&&this.sendFn&&(this.initAppEvents(),this.setupFn(),this.backlog=g.nativeBacklog,this.flushBacklog(),window.__testNative=function(method,data){log("Sending To App: "+method),this.nativeBridge.sendToApp(method,data)}.bind(this))},isEnabled:function isEnabledFn(){return this._isEnabled},flushBacklog:function flushBacklogFn(){this.flushingBacklog=!0;for(var i=0;i<this.backlog.length;++i){var entry=this.backlog[i];this.sendToApp(entry.method,entry.data)}this.flushingBacklog=!1},addToBacklog:function addToBacklogFn(method,data){try{g.PAssert(2948,!this.flushingBacklog,"Should never be adding to backload while flushing it")}catch(PERR){g.reportError(PERR)}this.flushingBacklog||this.backlog.push({method:method,data:data})},registerInboundAPI:function registerInboundAPIFn(name){try{g.PAssert(2949,!this._inboundAPIs[name],"Should not have already registered an outbound API with this name")}catch(PERR){g.reportError(PERR)}if(this._canRegisterAPIs){var api=new NativeAPI(name);return this._inboundAPIs[name]=api,api}return void 0},registerOutboundAPI:function registerOutboundAPIFn(name){try{g.PAssert(2950,!this._outboundAPIs[name],"Should not have already registered an outbound API with this name")}catch(PERR){g.reportError(PERR)}if(this._canRegisterAPIs){var api=new NativeOutAPI(name);return this._outboundAPIs[name]=api,api}return void 0},initAppEvents:function initAppEventsFn(){window.appEvents=this.appEvents,window.reportLowMemory=this.appEvents.reportLowMemory,window._SENDJSMESSAGE_=this.handleNativeMessage},setupChrome:function setupChromeFn(){window.addEventListener("message",this.onChromeMessage.bind(this))},setupAndroid:function setupAndroidFn(){},setupiOS:function setupiOSFn(){platform.ioswk?this.setupiOS8():this.setupiOS7(),gdata.registerSaveNotify(this.onSaveChange.bind(this))},setupiOS7:function setupiOS7Fn(){this.iframeApp=document.createElement("IFRAME"),this.iframeApp.setAttribute("height","1px"),this.iframeApp.setAttribute("width","1px"),this.iframeApp.id="appComm",document.documentElement.appendChild(this.iframeApp)},setupiOS8:function setupiOS8Fn(){},onSaveChange:function onSaveChangeFn(numChanged){this.isPokingBackground&&(this.sendToApp("pokeChanged",numChanged>0?"true":"false"),this.isPokingBakground=!1)},onChromeMessage:function onChromeMessageFn(e){if(0===e.origin.indexOf("chrome")){this.appWindow&&this.appOrigin||(this.appWindow=event.source,this.appOrigin=event.origin,setTimeout(this.flushBacklog.bind(this),0));var index=e.data.indexOf(":"),action=e.data.substr(0,index),data=e.data.substr(index+1);switch(action){case"chrome":switch(log("Chrome Message: ",action,"->",data),data){case"start":this.sendToApp("loaded");break;default:log("Unhandled Chrome Message: ",data)}break;default:this.handleNativeMessage(action,data)}}},sendToApp:function sendToAppFn(method,data){try{g.PAssert(2951,platform.app,"Only use native bridge when creating an app")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2952,this.sendFn,"Must have a valid send method for the native bridge")}catch(PERR){g.reportError(PERR)}var returnValue=!1;try{var dataString;data&&(dataString=g.isString(data)?data:JSON.stringify(data)),this.sendFn&&(this.sendFn(method,dataString),returnValue=!0)}catch(err){g.reportError(err)}return returnValue},sendToAppiOS:function sendToAppiOSFn(method,data){platform.ioswk?this.sendToAppiOS8(method,data):this.sendToAppiOS7(method,data)},sendToAppiOS7:function sendToAppiOS7Fn(method,data){if(this.iframeApp){var href="duchess://"+method;void 0!==data&&(href+="//"+data),this._addiOS7Queue(href)}else this.addToBacklog(method,data)},_addiOS7Queue:function _addiOS7QueueFn(href){this._iOS7Queue.push(href),this._iOS7QueueTimeout||(this._iOS7QueueTimeout=setTimeout(this._pumpiOS7Queue.bind(this),17))},_pumpiOS7Queue:function _pumpiOS7QueueFn(){var href=this._iOS7Queue.shift();try{g.PAssert(2953,href,"Must have a valid href",href)}catch(PERR){g.reportError(PERR)}this.iframeApp.src=href,this._iOS7QueueTimeout=this._iOS7Queue.length>0?setTimeout(this._pumpiOS7Queue.bind(this),17):void 0},sendToAppiOS8:function sendToAppiOS8Fn(method,data){if(window.webkit.messageHandlers&&window.webkit.messageHandlers.MoodoEvents){var str=method;void 0!==data&&(str+="//"+data),window.webkit.messageHandlers.MoodoEvents.postMessage(str)}else this.addToBacklog(method,data)},sendToAppAndroid:function sendToAppAndroidFn(method,data){window.AppInterface&&void 0!==window.AppInterface.sendAppMessage&&null!==window.AppInterface.sendAppMessage?window.AppInterface.sendAppMessage(method,data):this.addToBacklog(method,data)},sendToAppChrome:function sendToAppChromeFn(method,data){if(this.appWindow){var msg=method+":";void 0!==data&&(msg+=data),this.appWindow.postMessage(msg,"*")}else this.addToBacklog(method,data)},handleNativeMessage:function handleNativeMessageFn(method,data){try{window.appEvents[method]?window.appEvents[method](data):g.reportError(new Error("Calling invalid JS method from native: "+method))}catch(err){g.reportError(err)}},appEvents:{undo:function undoFn(){log("Native Undo"),g.sendEvent("Hotkey","ShakeUndo"),tracker.undoAction()},redo:function redoFn(){log("Native Redo"),g.sendEvent("Hotkey","ShakeRedo"),tracker.redoAction()},kbsize:function kbsizeFn(e){e>0&&e!==platform.kbsize&&(platform.setKBSize(e),g.keyboardToolbar&&g.keyboardToolbar.updatePosition())},closeKeyboard:function closeKeyboardFn(){g.blurActiveElement(),g.vmMain&&g.vmMain.clearSelected()},enterBackground:function enterBackgroundFn(){g.AppCache&&g.AppCache.checkForUpdate(!1,!0),g.onunload()},enterForeground:function enterForegroundFn(){gdata.poke(),g.checkForRemoteChanges(),g.AppCache&&g.AppCache.endRunUpdate()},pokeBackground:function pokeBackgroundFn(){g.nativeBridge.isPokingBackground=!0,gdata.poke()},reportLowMemory:function reportLowMemoryFn(msg){g.handleLowMemory(msg)},statusBarTap:function statusBarTapFn(){var firstItem=g.getFirstPaneItem(g.focusedPane);firstItem&&g.scrollToTop(firstItem.getSpan(),200)},features:function featuresFn(features){try{var featuresObj=JSON.parse(features);featuresObj.oauth&&goog.addOAuthMethod(OAuthSchemeType.Native),featuresObj.customKeyboard&&android.isEnabled()&&android.notifyCustomKeyboard(featuresObj.customKeyboard);try{g.PAssert(2954,featuresObj.notifications,"Notifications should always be available on all platforms")}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}},notifyOAuth:function notifyOAuthFn(info){try{goog.handleNativeOAuthResponse(JSON.parse(info))}catch(err){g.reportError(err)}}}},NativeBridge}),define("BillingManager",["ko","globals","util","platform","goog","ModalBase"],function(ko,g,util,platform,goog,ModalBase){function BillingManager(){this._isEnabled=ko.observable(!1),this._premiumStatus=ko.observable(PremiumStatus.Unknown),overridePremiumStatus&&(this._isEnabled(!0),this._premiumStatus(PremiumStatus.Active)),this._billingIdentifier=void 0,this._clientToken=void 0,this._btClient=void 0,this.isHidden=ko.observable(!0),this._isDialogOpened=!1,this._isUILocked=ko.observable(!1),this._braintreeRequested=!1,this._braintreeLoaded=!1,this._clientTokenRequested=!1,this._clientTokenLoaded=!1,this.pricingSelected=ko.observable(Pricing.None),this.daysLeftInTrial=ko.observable(-1),this.init()}var premiumWhitelist=[],Pricing={None:-1,Monthly:0,Yearly:1},premiumPlans=[],overridePremiumStatus=!1||platform.demo,MS_IN_DAY=864e5,BillingManagerFns={init:function initFn(){if(this._premiumStatus.subscribe(function(newValue){this.hasPremiumFeatures()&&g.vmMain&&g.vmMain.pluginManager&&g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.PremiumSub)}.bind(this)),!overridePremiumStatus)if(this.isPremiumEnabled()){var localStoredPremiumStatus=g.settings.get(Settings.premiumStatus);if(void 0!==localStoredPremiumStatus&&(log("Premium Status (Local): ",localStoredPremiumStatus),this.setPremiumStatus(localStoredPremiumStatus),localStoredPremiumStatus===PremiumStatus.Trial)){var trialStart=g.settings.get(Settings.trialStart)||Date.now(),trialDuration=g.settings.get(Settings.trialDuration)||0;this._updateTrialDaysLeft(trialStart,trialDuration)}this.checkRemotePremiumStatus()}else void 0===this.getBillingIdentifier()&&this.onBillingIdentifierAvailable(function(){this._isEnabled(!1),this.checkRemotePremiumStatus()}.bind(this))},checkRemotePremiumStatus:function checkRemotePremiumStatusFn(){try{g.PAssert(2955,!g.isDemoMode(),"Should not be querying for premium status in demo mode")}catch(PERR){g.reportError(PERR)}this.onBillingIdentifierAvailable(function(){log("Have Billing Identifier: ",this.getBillingIdentifier()),g.XHR_PrivateAPI({type:"POST",path:"/billing/getStatus",data:{email:this.getBillingIdentifier()},requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){if(200===xhr.status)try{var statusData=JSON.parse(xhr.response).data;if(log("Premium Status (Remote): ",statusData),this.setPremiumStatus(statusData.premiumStatus),statusData.premiumStatus===PremiumStatus.Trial){try{g.PAssert(2956,void 0!==statusData.trialStart,"Must have a valid trialStart set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2957,void 0!==statusData.trialDuration,"Must have a valid trialDuration set")}catch(PERR){g.reportError(PERR)}if(statusData.trialStart&&statusData.trialDuration)try{var trialStart=new Date(statusData.trialStart).getTime();g.settings.set(Settings.trialStart,trialStart),g.settings.set(Settings.trialDuration,statusData.trialDuration),this._updateTrialDaysLeft(trialStart,statusData.trialDuration)}catch(err2){g.reportError(err2)}else this.setPremiumStatus(PremiumStatus.TrialOver),g.settings.set(Settings.trialStart,Date.now()),g.settings.set(Settings.trialDuration,0)}else statusData.premiumStatus===PremiumStatus.TrialOver&&this.daysLeftInTrial(-1)}catch(err){g.reportError(err)}}.bind(this)})}.bind(this))},_updateTrialDaysLeft:function _updateTrialDaysLeftFn(trialStart,trialDuration){try{g.PAssert(2958,this._premiumStatus()===PremiumStatus.Trial,"Should only be updating trial days remaining during the trial peroid")}catch(PERR){g.reportError(PERR)}var remainingDays=trialDuration-Math.ceil((Date.now()-trialStart)/MS_IN_DAY);try{g.PAssert(2959,90>=remainingDays,"Sanity check on trial length",remainingDays)}catch(PERR){g.reportError(PERR)}this.daysLeftInTrial(remainingDays),0>remainingDays&&this.setPremiumStatus(PremiumStatus.TrialOver)},_processPaymentNonce:function _processPaymentNonceFn(err,nonce,isCustom){if(!err&&nonce){var planID=premiumPlans[this.pricingSelected()];try{g.PAssert(2960,planID,"Must have selected a valid plan to signup")}catch(PERR){g.reportError(PERR)}planID&&g.XHR_PrivateAPI({type:"POST",path:"/billing/signup",data:{email:this.getBillingIdentifier(),nonce:nonce,planID:planID,isCustom:!!isCustom},requireAuth:!0,cb:function cbFn(xhr){200===xhr.status?(log("Billing Success!"),this.setPremiumStatus(PremiumStatus.Active)):log("Billing Failure :("),this.unlockUI()}.bind(this)})}},getBillingIdentifier:function getBillingIdentifierFn(){if(!this._billingIdentifier){var user=goog.getCurrentUserEmail()||g.settings.get(Settings.activeUser);user&&(this._billingIdentifier=user)}return this._billingIdentifier},onBillingIdentifierAvailable:function onBillingIdentifierAvailableFn(cb){if(this._billingIdentifier)setTimeout(cb,0);else var infoSub=goog.authenticatedUserInfo.subscribe(function(){infoSub.dispose(),infoSub=void 0,setTimeout(cb,0)})},isPremiumEnabled:function isPremiumEnabledFn(){return this._isEnabled()},hasPremium:function hasPremiumFn(){return this.isPremiumEnabled()&&(this._premiumStatus()===PremiumStatus.Active||this._premiumStatus()===PremiumStatus.PastDue)},hasPremiumFeatures:function hasPremiumFeaturesFn(){return this.hasPremium()||this._premiumStatus()===PremiumStatus.Trial},isTrialState:function isTrialStateFn(){return this.isPremiumEnabled()&&(this._premiumStatus()===PremiumStatus.Trial||this._premiumStatus()===PremiumStatus.TrialOver)},setPremiumStatus:function setPremiumStatusFn(status){try{g.PAssert(2961,g.isNumber(status),"Status must be a valid number",status)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2962,status>0&&8>status,"Should be a valid status identifier",status)}catch(PERR){g.reportError(PERR)}var oldStatus=this._premiumStatus();status!==oldStatus&&(this._premiumStatus(status),g.settings.set(Settings.premiumStatus,status),g.fireCustomEvent("premiumStatusChanged"))},getPremiumStatus:function getPremiumStatusFn(){return this._premiumStatus()},initUI:function initUIFn(){try{g.PAssert(2963,!g.isDemoMode(),"Should not be opening premium UI in demo mode")}catch(PERR){g.reportError(PERR)}g.isDemoMode()||(this._ensureBraintreeLib(),this._ensureClientToken())},modalOpen:function modalOpenFn(){this._isDialogOpened=!0,this._ensureBraintreeLib(),this._ensureClientToken()},modalClose:function modalCloseFn(){},titleText:function titleTextFn(){return this.hasPremium()?"You are a pro":"Become a pro"},subtext:function subtextFn(){return this.hasPremium()?"You are subscribed to the monthly premium plan for $4.99 per month.":"Moo.do is available on every device with realtime collaboration and offline support for free. Signing up for Premium opens up our full suite of plugins and premium features."},trialText:function trialTextFn(){return this.daysLeftInTrial()>0?"You have "+this.daysLeftInTrial()+" days left in your free trial of Moo.do Premium.":"Your free trial has ended. Sign up below to continue using premium features or send us an email at support@moo.do if you need further time to evaluate Moo.do."},isMonthlySelected:function isMonthlySelectedFn(){return this.pricingSelected()===Pricing.Monthly},isYearlySelected:function isYearlySelectedFn(){return this.pricingSelected()===Pricing.Yearly},selectedPrice:function selectedPriceFn(){return this.pricingSelected()===Pricing.Monthly?"Pay $4.99 / month":"Pay $49.99 / year"},clearSubForm:function clearSubFormFn(){var numberEle=document.getElementById("ppfNumber"),expirationEle=document.getElementById("ppfExpiration");numberEle&&(numberEle.value=""),expirationEle&&(expirationEle.value="")},lockUI:function lockUIFn(){try{g.PAssert(2964,!this._isUILocked(),"Should always transition when locking")}catch(PERR){g.reportError(PERR)}this._isUILocked(!0)},unlockUI:function unlockUIFn(){try{g.PAssert(2965,this._isUILocked(),"Should always transition when locking")}catch(PERR){g.reportError(PERR)}this._isUILocked(!1)},isUILocked:function isUILockedFn(){return this._isUILocked()},onTapMonthly:function onTapMonthlyFn(){this.pricingSelected(Pricing.Monthly),this.isHidden(!1)},onTapYearly:function onTapYearlyFn(){this.pricingSelected(Pricing.Yearly),this.isHidden(!1)},onTapCancel:function onTapCancelFn(){g.menus.closeModal(Modals.PremiumSignup,!1)},onTapSubmit:function onTapSubmitFn(){if(this._isDialogOpened=!1,this._btClient){this.lockUI();var numberEle=document.getElementById("ppfNumber"),expirationEle=document.getElementById("ppfExpiration");this._btClient.tokenizeCard({number:numberEle.value,expirationDate:expirationEle.value},function(err,nonce){this._processPaymentNonce(err,nonce,!0)}.bind(this))}else doSubmit&&!this._btClient;this.clearSubForm()},setError:function setErrorFn(){},setValidationError:function setValidationErrorFn(fieldID){},onTapCancelSubscription:function onTapCancelSubscriptionFn(){g.menus.confirm("Are you sure you want to cancel your subscription?",function(result){result?g.XHR_PrivateAPI({type:"POST",path:"/billing/cancel",data:{email:this.getBillingIdentifier()},requireAuth:!0,cb:function cbFn(xhr){if(200===xhr.status)log("Billing successfully canceled"),this.setPremiumStatus(PremiumStatus.CanceledUser);else{var errorMessage;errorMessage=400===xhr.status?"There was an error validating your information, please re-check and try again.":"There was a server error, please try again in a few minutes or contact support.",this.setError(errorMessage)}}.bind(this)}):g.menus.closeModal(Modals.PremiumSignup,!1)}.bind(this))},_notifyDependencyLoaded:function _notifyDependencyLoadedFn(){this._braintreeLoaded&&this._clientTokenLoaded&&(this._btClient=new braintree.api.Client({clientToken:this._clientToken}),braintree.setup(this._clientToken,"dropin",{container:"braintreeDropin",paymentMethodNonceReceived:function paymentMethodNonceReceivedFn(e,nonce){nonce?this._processPaymentNonce(void 0,nonce):this._processPaymentNonce({error:!0},void 0)}.bind(this)}))},_notifyDependencyLoadError:function _notifyDependencyLoadErrorFn(){this._isDialogOpened},_ensureBraintreeLib:function _ensureBraintreeLibFn(){this._braintreeRequested||(this._braintreeRequested=!0,g.addScriptHack("https://js.braintreegateway.com/v2/braintree.js","braintreeScript",function(){window.braintree?(this._braintreeLoaded=!0,this._notifyDependencyLoaded()):(this._braintreeRequested=!1,this._notifyDependencyLoadError())}.bind(this),function(){this._braintreeRequested=!1,this._notifyDependencyLoadError()}.bind(this)))},_ensureClientToken:function _ensureClientTokenFn(){var clientId=this.getBillingIdentifier();clientId?this._clientTokenRequested||(this._clientTokenRequested=!0,g.XHR_PrivateAPI({type:"POST",path:"/billing/getToken",data:{email:clientId},requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){if(200===xhr.status){this._clientTokenLoaded=!0;try{var response=JSON.parse(xhr.responseText).data;response&&response.token?(this._clientToken=response.token,this._notifyDependencyLoaded()):this._notifyDependencyLoadError()}catch(err){g.reportError(err),this._notifyDependencyLoadError()}}else this._clientTokenRequested=!1,this._notifyDependencyLoadError()}.bind(this)})):this._notifyDependencyLoadError()}};return util.inherit(ModalBase,BillingManager),util.extend(BillingManager.prototype,BillingManagerFns),BillingManager}),"undefined"==typeof DETAILED_STATS&&(DETAILED_STATS=!1),"beta.moo.do"===window.location.host&&window.location.hash.indexOf("mailbird")<0&&window.location.hash.indexOf("demo=true")<0&&(window.location.host="www.moo.do"),Date.Config={DEBUG:!0,DisableCache:!0},Error.stackTraceLimit=150;try{window.__checkpoints|=1,window.__SESSION_ID=Math.round(1e4*Math.random())+"|"+Date.now();var empty=function(){};window.appEvents=window.appEvents||{kbsize:empty,enterBackground:empty,enterForeground:empty,statusBarTap:empty,closeKeyboard:empty,undo:empty,redo:empty,notifyOAuth:empty,features:empty,reportLowMemory:empty,pokeBackground:empty},window.console||(window.console={log:function(){}});var bindLog=!1;window.log=bindLog?function(){}:window.console.log.bind(window.console),window.__log=bindLog?function(){}:window.console.log.bind(window.console),window.performance&&window.performance.now?(window.log.start=window.performance.now(),window.log.now=function(){return window.performance.now()-window.log.start}):(window.log.start=Date.now(),window.performance={now:function(){return Date.now()-window.log.start}},window.log.now=window.performance.now),window.console.timeStamp||(Object.defineProperty?Object.defineProperty(window.console,"timeStamp",{value:function(){}}):window.console.timeStamp=function(){}),window.console.time||(Object.defineProperty?Object.defineProperty(console,"time",{value:function(){}}):window.console.time=function(){}),window.console.timeEnd||(Object.defineProperty?Object.defineProperty(window.console,"timeEnd",{value:function(){}}):window.console.timeEnd=function(){}),window.console.trace||(Object.defineProperty?Object.defineProperty(window.console,"trace",{value:function(){}}):window.console.trace=function(){}),window.LogLevels={Off:0,Error:1,Warning:2,Timing:4,Data:8,Status:16,Search:32,Timeline:64,Input:128,Tracker:256,Profile:512,PageLoad:1024,Toolbar:2048,Picker:4096,Intro:8192,Import:16384,Version:32768,Settings:65536,Selection:131072,ScrMgr:262144,NativeAuth:524288,DateRoll:1048576,DebugDOM:2097152,RepeatDate:4194304,Connection:8388608,Plugin:16777216,Folders:33554432,Verbose:67108864},window.LogLevel=LogLevels.Error|LogLevels.Warning,window.ShouldLog=function(mask){return window.DEBUG===mask},window.inspectLocal=function(input){if(!input)return void log("Must specify either an item ID or item object to inspect");
var item=input;return"string"==typeof input&&(item=window.getModel(input)),log("---- Inspecting Item:",item.id,"----"),log("  RawText:",item.getRawText()),log("  ParsedText:",item.getParsedText()),log("  StyledText:",item.getStyledText()),log('  Parent: "'+item.parent().id+'"'),log("  Date:",item.date()),log("  AllDayDate:",item.allDayDate()),log("--------------------------------------------"),item}}catch(err){console.log("Error in main header",err),window.__ERRORINMAINHEADER=err}!function(){var rqConfig;rqConfig={paths:{ko:"lib/knockout-3.2.0",date:"lib/date",FileSaver:"lib/FileSaver",IndexedDBShim:"lib/IndexedDBShim.min",database:"lib/db"},waitSeconds:0},require.config(rqConfig)}(),window.gapiKey="AIzaSyB9HEdSJ-nhLJG_ssSSqhI2DX74GSiKSao";var gapiCalled=!1,gapiLoadError=!1;requirejs(["ko","data","globals","util","SettingsManager","gdata","goog","platform","android","edit","VMMain","VMSetup","VMDebug","VMTimeline","VMSearch","VMMessageQueue","TemplateCache","VMAutocomplete","VMMenus","ScreenManager","VMTooltip","AppCache","NativeBridge","copypaste","International","RepeatDate","BillingManager","DuchessHelpers"],function(ko,d,g,util,SettingsManager,gdata,goog,platform,android,edit,VMMain,VMSetup,VMDebug,VMTimeline,VMSearch,VMMessageQueue,TemplateCache,VMAutocomplete,VMMenus,ScreenManager,VMTooltip,AppCache,NativeBridge,copypaste,International,RepeatDate,BillingManager){g.checkpoint(Checkpoint.RequireLoaded),window.__ERRORINMAINHEADER&&g.reportError(window.__ERRORINMAINHEADER),g.nativeBridge=new NativeBridge,g.billingManager=new BillingManager,g.runOnLoad(function(){function onorientationchange(){platform.updateOrientation(),platform.mobile&&(g.keyboardToolbar&&g.keyboardToolbar.isVisible()&&g.keyboardToolbar.updatePosition(!0),document.body.scrollTop=0,g.keyboardToolbar&&g.keyboardToolbar.hideTopBarIfLandscape(),android.isEnabled()&&android.updateInputBounds(android.getCurrentVMLI()))}function initialize(){initializeCalled||(initializeCalled=!0,g.checkpoint(Checkpoint.InitializeMain),g.openMainPage(),g.registerEvent("ItemCreated","ItemAction","Create"),g.registerEvent("ItemCompleted","ItemAction","Complete"),d.initData(onInitializedData),onInitializedData())}function onInitializedData(){try{if(initializeDataCalled||!initializeCalled||!d.localDataLoaded())return;initializeDataCalled=!0,g.checkpoint(Checkpoint.OnInitializedData),goog.loadClientDefaultFile(),g.isDemoMode()||g.vmMain.setupDateRollover(),g.vmMain.loadData(),g.timeline.load(),g.StopSpinner(),setTimeout(function(){g.menus&&g.menus.bind(),platform.mobile&&(g.ScreenManager=new ScreenManager),new VMAutocomplete})}catch(err){g.reportError(err)}}function addHotkey(keyCode,primary,shift,callback,stopPropagation){platform.app&&primary!==Primary.Both&&(primary=Primary.Either),_addHotkey(keyCode,primary,shift,callback,stopPropagation)}function _addHotkey(keyCode,primary,shift,callback,stopPropagation){if(hotkeys[keyCode]=hotkeys[keyCode]||[],primary===Primary.Either)return _addHotkey(keyCode,Primary.No,shift,callback),void _addHotkey(keyCode,Primary.Yes,shift,callback);if(shift===Shift.Either)return _addHotkey(keyCode,primary,Shift.No,callback),void _addHotkey(keyCode,primary,Shift.Yes,callback);try{g.PAssert(2969,!platform.windows||primary!==Primary.Both,"Should never require AltGr combo on windows")}catch(PERR){g.reportError(PERR)}var hotkey={mods:{},call:callback};(primary===Primary.Yes||primary===Primary.Both)&&(hotkey.mods[platformPrimaryKey]=!0),(primary===Primary.No||primary===Primary.Both)&&(hotkey.mods[platformSecondaryKey]=!0),shift===Shift.Yes&&(hotkey.mods[Mods.Shift]=!0),hotkeys[keyCode].push(hotkey),hotkey.stopPropagation=stopPropagation}function ignoreKeyOnBody(e){return(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.normCode===KeyCode.A}try{g.checkpoint(Checkpoint.PageLoad);try{g.PAssert(2966,"loading"!==document.readyState,"Should only be calling mainjs after document is loaded"+document.readyState)}catch(PERR){g.reportError(PERR)}if("loading"===document.readyState){var errString="ERROR: MainJS running before document load! "+document.readyState;ShouldLog(LogLevels.Error)&&log(errString),g.reportError(new Error(errString))}window.scriptErrors=window.scriptErrors||{};for(var scriptError in window.scriptErrors)g.fireCustomEvent("scriptLoadError",{src:scriptError,id:window.scriptErrors[scriptError],firstChance:!0});if(window.handleLoadError=function handleLoadErrorSecondChanceFn(e){try{window.scriptErrors[e.target.src]=e.target.id,g.fireCustomEvent("scriptLoadError",{src:e.target.src,id:e.target.id,firstChance:!1})}catch(err){g.reportError(err)}},window.oncontextmenu=function(e){platform.normalizeMouse(e),"TEXTAREA"!==e.srcElement.tagName&&"INPUT"!==e.srcElement.tagName&&e.preventDefault()},platform.demo&&g.enableDemoMode(),g.isDemoMode()||platform.offline)var testFn;else{var e=document.createElement("script");e.type="text/javascript",e.src="https://apis.google.com/js/client.js?onload=GoogleApiLoaded",e.async=1,e.id="gapiScript",e.onerror=window.handleLoadError,document.getElementsByTagName("head")[0].appendChild(e),function(i,s,o,g,r,a,m){i.GoogleAnalyticsObject=r,i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date,a=s.createElement(o),m=s.getElementsByTagName(o)[0],a.async=1,a.src=g,m.parentNode.insertBefore(a,m)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-37740918-2",{cookieDomain:"auto",siteSpeedSampleRate:50}),ga("require","displayfeatures"),ga("send","pageview")}if(g.isDemoMode()){var panesStart=util.getURLParam("panes");panesStart&&(g.demoPanes=panesStart.split(":"))}else g.removeDOM("preventInteraction");setTimeout(function(){g.sendEvent("PageLoad","NewPage")},0);var setupEvent=function(name){document.documentElement.addEventListener(name,function(e){g.reportEvent(e)},!0)};setupEvent("keydown"),setupEvent("keyup"),setupEvent("keypress"),setupEvent("MSPointerDown"),setupEvent("MSPointerUp"),setupEvent("MSPointerHover"),setupEvent("MSPointerCancel"),setupEvent("mousedown"),setupEvent("mouseup"),setupEvent("touchstart"),setupEvent("touchend"),g.tooltip=new VMTooltip,g.AppCache=new AppCache,g.StartSpinner();var erroredPlatform=platform.blockClient();if(void 0!==erroredPlatform){g.errorPlatformInfo=erroredPlatform;var text,showSignup=!1;if(erroredPlatform.platform?erroredPlatform.update?"Firefox"===erroredPlatform.platform?text='Please update your Firefox browser to use Moo.do. Moo.do requires at least Firefox 16. See <a href="https://support.mozilla.org/en-US/kb/update-firefox-latest-version">https://support.mozilla.org/en-US/kb/update-firefox-latest-version</a> for more information.':"Chrome"===erroredPlatform.platform?text='Please update your Chrome browser to use Moo.do. Moo.do requires at least Chrome 26. See <a href="https://support.google.com/chrome/answer/95414">https://support.google.com/chrome/answer/95414</a> for more information.':"Native Android"===erroredPlatform.platform?text="Please update your Android device to use Moo.do. Moo.do requires at least Android 2.1.":"Internet Explorer"===erroredPlatform.platform?text='Please update your Internet Explorer browser to use Moo.do. Moo.do requires at least Internet Explorer 10. See <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">http://windows.microsoft.com/en-us/internet-explorer/download-ie</a> for more information.':"Safari"===erroredPlatform.platform?text=platform.mobile?"Please update your "+platform.OSName+" to use Moo.do. Moo.do requires at least iOS 6.":'Please update your Safari browser to use Moo.do. Moo.do requires at least Safari 6.1. See <a href="http://support.apple.com/kb/HT6103">http://support.apple.com/kb/HT6103</a> for more information.':(text="Please update your browser to use Moo.do. If you are unable to update your browser, please let us know. Thanks!",showSignup=!0):(showSignup=!0,text="Sorry, we don't support "+erroredPlatform.platform+" yet. Please let us know that you're interested in using "+erroredPlatform.platform+" and we will make it a higher priority. Thanks!"):erroredPlatform.version?text="There was a mandatory update, please update to the latest version of Moo.do. Thanks!":erroredPlatform.cacheUpdate&&(text="There was an issue while updating the app, "+platform.actionVerb()+" to try again.",g.AppCache.update(),erroredPlatform.error&&setTimeout(function(){g.AppCache.runOnFinish(function(){util.insertURLParam("cacheError",!0)},!0)},100)),text){var submitFn=function(){return g.requestNotification(navigator.userAgent)},refreshFn=function(){g.AppCache.runOnFinish(function(){g.reload()},!0)};g.applyBindings({platformError:text,showSignup:showSignup,onTapRefresh:refreshFn,onTapSubmit:submitFn},"OSError")}return g.StopSpinner(),g.removeDOM("outerWrapper"),g.removeDOM("setupWrapper"),void g.removeDOM("templates")}if(util.removeURLParam("cacheError",!0),g.removeDOM("OSError"),g.localDocChangeRequested=!1,!g.isDemoMode()){var notifiedDocChange=!1;g.settings.registerForChangeNotification(Settings.gdocId,function(oldValue,newValue){!g.localDocChangeRequested&&oldValue&&oldValue!==newValue&&(notifiedDocChange||(notifiedDocChange=!0,g.menus.alert({text:"The document was changed in another tab. Please close this tab or reload.",actionText:"RELOAD",action:g.reload})))})}new VMMenus,g.vmDebug=new VMDebug,g.vmSetup=new VMSetup,window.addEventListener("remoteDataLoaded",function(){var fileForceID=util.getURLParam("file"),stateInfo=util.getURLParam("state");if(fileForceID||stateInfo){if(!fileForceID)try{var stateObj=JSON.parse(stateInfo);"open"===stateObj.action&&stateObj.ids&&stateObj.ids.length>=0&&(fileForceID=stateObj.ids[0])}catch(err){g.reportError(err)}var currentDocID=goog.getDocId();fileForceID&&currentDocID!==fileForceID&&g.menus.alert({text:"You have requested to view another document.",actionText:"OPEN IT",action:function actionFn(){try{g.PAssert(2968,g.vmMain&&g.vmMain.vmPicker,"VMMain must be initialized before loading another doc")}catch(PERR){g.reportError(PERR)}g.vmMain.vmPicker.requestOpenDocument(fileForceID)}})}});var windowResize=function(e){var w=document.body.clientWidth,h=document.body.clientHeight,oldWidth=platform.windowWidth(),oldHeight=platform.windowHeight();if(platform.ipad&&!platform.app&&e!==!0&&e!==!1&&setTimeout(windowResize,0,!0),(w!==oldWidth||h!==oldHeight)&&(platform.windowWidth(w),platform.windowHeight(h),g.documentHeight=h,g.isMainPageOpen)){var heightDelta=h-oldHeight,kbClosed=(platform.android||platform.mobileie)&&h>oldHeight&&(!platform.app||heightDelta<=platform.kbsize)&&g.vmMain&&g.vmMain.isLoaded;if(kbClosed&&g.blurActiveElement(),g.autocomplete&&kbClosed&&g.autocomplete.hide(),oldWidth!==w&&e&&platform.mobile&&(g.menus&&g.menus.onResize(),g.ScreenManager&&g.ScreenManager.updatePanePosition(),g.isKeyboardOpen&&g.focusedPane.addPadding(),g.vmMain.updatePaneWidth(),g.vmMain.selected().length>0)){var item=g.vmMain.selected()[0];g.scrollToTop(item.getSpan())}platform.mobile||g.fireCustomEvent("windowResize")}};if(windowResize(!1),onorientationchange(),g.isDemoMode()||!platform.offline&&window.gapi&&window.gapi.auth&&!gapiCalled&&GoogleApiLoaded(),platform.mobile?(g.removeDOM("desktopMenu"),g.removeDOM("contextMenuItem"),g.removeDOM("contextMenuDocuments"),g.removeDOM("contextMenuOptions"),g.removeDOM("contextMenuAddPane"),g.removeDOM("contextMenuLink"),g.removeDOM("exportData"),g.removeDOM("importData"),g.removeDOM("settings")):(g.removeDOM("phoneMenu"),g.removeDOM("mobileKeyboardToolbar"),g.removeDOM("mobileSettings"),platform.touch||(g.removeDOM("itemMenuPhone"),g.removeDOM("rightMenuPhone"))),window.onblur=function(){g.hasFocus=!1},window.onfocus=function(){g.hasFocus=!0,goog.onFocusHandler()},new VMMain,g.timeline=new VMTimeline,window.addEventListener("resize",windowResize),window.addEventListener("orientationchange",onorientationchange),document.addEventListener("focusout",function(e){platform.ios&&platform.app&&g.fireCustomEvent("closeKeyboard")},!0),platform.mobileie){document.addEventListener("focusin",function(e){if("HTML"===e.target.tagName)if(android.isEnabled())if(android.isVisible())android.finishInput(!1);else{var activeSearch=g.getActiveSearch();activeSearch&&activeSearch.isFocused()&&activeSearch.onblur()}else log("Skipping Close - Not Android")});var lastScroll=0,preventScrollInterval;window.addEventListener("scroll",function(){lastScroll=Date.now(),preventScrollInterval||(preventScrollInterval=setInterval(function(){Date.now()-lastScroll>5e3&&(clearInterval(preventScrollInterval),preventScrollInterval=void 0),window.scrollTo(0,0)},15))})}window.addEventListener("dragstart",function(dragEvent){return dragEvent.preventDefault(),!1}),window.addEventListener("dragover",function(dragEvent){return dragEvent.preventDefault(),!1});var initializeCalled=!1,initializeDataCalled=!1;g.vmSetup.loginState.subscribe(function(loginState){loginState==LoginState.LOGGED_IN?(initialize(),g.openMainPage()):loginState==LoginState.LOGGED_OUT&&(g.isSetupPageOpen||(g.isSetupPageOpen=!0,util.hasURLParam("login","true")||g.openSetupPage(),g.vmSetup.openLogin())),g.vmMain.setGDriveStatus(platform.offline||!navigator.onLine?DriveStatus.Offline:DriveStatus.Connecting)}),g.vmSetup.init(),g.isDemoMode()&&initialize();var loginState=g.getLoginState();if(loginState!=LoginState.LOGGED_OUT?d.initData(initialize):!g.isDemoMode()&&platform.app&&g.nativeBridge.sendToApp("loaded"),!platform.mobile){var hotkeys={},hotkeySearch=function(){var targetPane=g.focusedPane||g.vmMain.paneManager.getPaneAtIndex(0);targetPane&&(targetPane.vmSearch.isFocused()||g.saveSelection("StoredSearch"),g.selectElement(targetPane.vmSearch.elSearch,!1),g.sendEvent("Hotkey","Search"))},hotkeyOutline=function(){g.focusedPane.toggleOutlineVisibility(),g.sendEvent("Hotkey","Outline")},hotkeyP0=function(){g.vmMain.applyPriorityToSelection(VMLIFlag.P0,!0),g.sendEvent("Hotkey","Important")},hotkeyP1=function(){g.vmMain.applyPriorityToSelection(VMLIFlag.P1,!0),g.sendEvent("Hotkey","Important")},hotkeyP2=function(){g.vmMain.applyPriorityToSelection(VMLIFlag.P2,!0),g.sendEvent("Hotkey","Important")},hotkeyStar=function(){g.vmMain.applyFnToSelection("isStarred",{toggle:!0,restoreSelection:!0}),g.sendEvent("Hotkey","Star")},hotkeyComplete=function(){g.vmMain.applyFnToSelection("isComplete",{toggle:!0,restoreSelection:!0}),g.sendEvent("Hotkey","Complete")},hotkeyZoomIn=function(){g.vmMain.applyToSelection(function(item){return item.isNote()||g.vmMain.zoomin(item),!1}),g.sendEvent("Hotkey","ZoomIn")},hotkeyZoomOut=function(){var item=g.focusedItem;item&&item.parent()&&g.vmMain.zoomout(item.parent(),item),g.sendEvent("Hotkey","ZoomOut")},hotkeyCollapse=function(){g.vmMain.applyToSelection(function(item){g.focusedPane.supportCollapsing&&item.toggleCollapsed()}),g.sendEvent("Hotkey","Collapse")},hotkeyCollapseAll=function(){if(g.focusedItem&&g.focusedPane&&g.focusedPane.supportCollapsing){for(var numChildren=g.focusedItem.numChildren(),children=g.focusedItem.items(),numCollapsed=0,numUncollapsed=0,i=0;numChildren>i;++i)children[i].hasChildren()&&(children[i].isCollapsed()?numCollapsed++:numUncollapsed++);for(var doCollapse=numUncollapsed>=numCollapsed,i=0;numChildren>i;++i)children[i].hasChildren()&&children[i].isCollapsed(doCollapse)}g.sendEvent("Hotkey","CollapseAll")},hotkeyIndent=function(e){e.target!==document.body&&(g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1}),g.sendEvent("Hotkey","Indent"))},hotkeyUnindent=function(e){e.target!==document.body&&(g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0}),g.sendEvent("Hotkey","Unindent"))},hotkeyBackspace=function(e){return e.target!==document.body?!1:void 0},hotkeyFireEvent=function(e){var name=g.enumToString(KeyCode,e.normCode);return name?g.fireCustomEvent("key"+name):void g.sendEvent("Hotkey","FireEvent_"+name)},hotkeyClosePane=function(e){var removedID=g.vmMain.paneManager.removeFocusedPane();if(void 0!==removedID){var tracker=require("tracker");tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:removedID}),g.sendEvent("Hotkey","ClosePane"),g.tooltip.hideTip(),e.stopImmediatePropagation()}},hotkeyNOP=function(){},hotkeyPassthrough=function(){return!1},Mods={Ctrl:0,Opt:1,Meta:2,Alt:3,Shift:4},Primary={No:0,Yes:1,Either:2,Both:3},Shift={No:0,Yes:1,Either:2},platformPrimaryKey=platform.mac?Mods.Meta:Mods.Ctrl,platformSecondaryKey=platform.mac?Mods.Ctrl:Mods.Alt;addHotkey(KeyCode.E,Primary.No,Shift.No,hotkeySearch),addHotkey(KeyCode.F,Primary.No,Shift.No,hotkeySearch),addHotkey(KeyCode.O,Primary.No,Shift.No,hotkeyOutline),addHotkey(KeyCode.Slash,Primary.Either,Shift.Either,hotkeyComplete),addHotkey(KeyCode.D1,Primary.No,Shift.No,hotkeyP0),addHotkey(KeyCode.D2,Primary.No,Shift.No,hotkeyP1),addHotkey(KeyCode.D3,Primary.No,Shift.No,hotkeyP2),addHotkey(KeyCode.D8,Primary.Either,Shift.Either,hotkeyStar),addHotkey(KeyCode.Enter,Primary.Either,Shift.No,hotkeyZoomIn),addHotkey(KeyCode.Enter,Primary.Either,Shift.Yes,hotkeyZoomOut),addHotkey(KeyCode.Space,Primary.No,Shift.No,hotkeyCollapse),addHotkey(KeyCode.Space,Primary.No,Shift.Yes,hotkeyCollapseAll),addHotkey(KeyCode.Comma,Primary.No,Shift.No,hotkeyCollapse),addHotkey(KeyCode.Comma,Primary.No,Shift.Yes,hotkeyCollapseAll),addHotkey(KeyCode.Period,Primary.No,Shift.No,hotkeyCollapse),addHotkey(KeyCode.Period,Primary.No,Shift.Yes,hotkeyCollapseAll),addHotkey(KeyCode.LBracket,Primary.Either,Shift.No,hotkeyUnindent),addHotkey(KeyCode.RBracket,Primary.Either,Shift.No,hotkeyIndent),platform.mac?(addHotkey(KeyCode.UpArrow,Primary.Both,Shift.No,edit.moveUp,!0),addHotkey(KeyCode.DownArrow,Primary.Both,Shift.No,edit.moveDown,!0)):(addHotkey(KeyCode.UpArrow,Primary.No,Shift.Yes,edit.moveUp,!0),addHotkey(KeyCode.DownArrow,Primary.No,Shift.Yes,edit.moveDown,!0)),addHotkey(KeyCode.A,Primary.Either,Shift.Yes,edit.handleSelectAllItem,!0),platform.mac&&addHotkey(KeyCode.L,Primary.No,Shift.No,edit.handleSelectAllItem,!0),addHotkey(KeyCode.Escape,void 0,Shift.No,hotkeyFireEvent),addHotkey(KeyCode.F4,void 0,Shift.Yes,hotkeyClosePane),addHotkey(KeyCode.BackSpace,void 0,Shift.No,hotkeyBackspace),addHotkey(KeyCode.Tilde,Primary.Either,Shift.No,hotkeyPassthrough),addHotkey(KeyCode.B,Primary.Yes,Shift.No,hotkeyNOP),addHotkey(KeyCode.I,Primary.Yes,Shift.No,hotkeyNOP),addHotkey(KeyCode.U,Primary.Either,Shift.No,hotkeyNOP),addHotkey(KeyCode.S,Primary.Either,Shift.No,hotkeyNOP),g.globalKeyDown=function(e){platform.normalizeKeys(e);var result=hotkeys[e.normCode];if(result)if(g.isFunction(result)){try{g.PAssert(2970,!1,"We should not be using this option")}catch(PERR){g.reportError(PERR)}result(e)}else{for(var valid,i=0;i<result.length;i++){var entry=result[i],noMods=!entry.mods,ctrlValid,optValid,metaValid,altValid,shiftValid;if(noMods||(ctrlValid=!!entry.mods[Mods.Ctrl]==!!e.ctrlKey,optValid=!!entry.mods[Mods.Opt]==!!e.optKey,metaValid=!!entry.mods[Mods.Meta]==!!e.metaKey,altValid=!!entry.mods[Mods.Alt]==!!e.altKey,shiftValid=!!entry.mods[Mods.Shift]==!!e.shiftKey),noMods||ctrlValid&&optValid&&metaValid&&altValid&&shiftValid){valid=entry;break}}if(valid){var ret=valid.call(e);if(valid.stopPropagation&&e.stopPropagation(),ret!==!1)return e.handled=!0,e.preventDefault(),!1}}else e.normCode===KeyCode.Ctrl&&g.vmMain.updateCursor(!0);if(platform.android&&e.srcElement===document.body){if(ignoreKeyOnBody(e))return e.preventDefault(),!1;edit.keydown(null,e)}},g.globalKeyUp=function(e){platform.normalizeKeys(e),e.normCode===KeyCode.Ctrl&&g.vmMain.updateCursor(!1)},document.addEventListener("keydown",g.globalKeyDown,!0),document.addEventListener("keyup",g.globalKeyUp,!0)}var liveReloadAddress}catch(mainErr){g.handleCriticalError(),g.reportError(mainErr,"Critical Error")}})}),define("main",function(){});
//# sourceMappingURL=main-min.js.map