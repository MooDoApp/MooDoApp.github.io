function _objectWithoutProperties(obj,keys){var target={};for(var i in obj)keys.indexOf(i)>=0||Object.prototype.hasOwnProperty.call(obj,i)&&(target[i]=obj[i]);return target}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj)keys.indexOf(i)>=0||Object.prototype.hasOwnProperty.call(obj,i)&&(target[i]=obj[i]);return target}function GoogleApiLoaded(){if(!gapiCalled){if(gapiCalled=!0,gapi.auth.init(),window.location.hash.indexOf("offline=true")>=0||window.location.hash.indexOf("offline%22:true")>=0||window.location.hash.indexOf('offline":true')>=0||window.location.hash.indexOf("demo=true")>=0)return void log("%cOffline","color: pink");ShouldLog(LogLevels.Timing)&&log("GAPI Callback - Loaded:",log.now()),require(["globals"],function(g){g.loadGoogleAPI("drive","v2",function(){g.vmMain&&g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.DriveAPI)})}),require(["globals"],function(g){g.vmMain&&g.vmMain.pluginManager&&g.vmMain.pluginManager.isAuthorized(PluginID.Gmail)&&g.loadGoogleAPI("gmail","v1",function(){g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GmailAPI)})}),gapi.load("drive-realtime",function(){ShouldLog(LogLevels.Timing)&&log("Drive-Realtime API - Loaded: ",window.performance.now()),gapi&&gapi.drive&&gapi.drive.realtime?require(["globals","goog"],function(g,goog){goog.loadClientDefaultFile(),g.fireCustomEvent("gapiDriveLoaded"),g.removeDOM("blockedError")}):require(["globals","platform"],function(g,platform){var errorString;errorString=gapi?gapi.drive?gapi.drive.realtime?"all exist":"gapi.drive.realtime":"gapi.drive":"gapi",gapiCalled=!1,gapiLoadError=!0;var displayBlockedMessage=function(noBlocked){g.reportError(new Error("Drive returned load, but unable to load "+errorString));var msgEle=document.getElementById("blockedMessage");msgEle.innerText=platform.app||noBlocked?"There was an error loading the Google APIs, "+platform.actionVerb()+" to try again.":"You may be running an extension that blocked drive.google.com from loading. Please re-load the page if you are not using an extension and the issue will resolve itself.";var errEle=document.getElementById("blockedError");g.removeClass(errEle,"none"),errEle.addEventListener("mousedown",function(){g.reload()}),g.vmMain&&g.vmMain.gdriveStatus(DriveStatus.Offline)};g.XHR({type:"GET",timeout:7e3,url:"https://api.moo.do/private/v1/info",cb:function cbFn(xhr){var isServerValid=!1;if(200===xhr.status){var data;try{data=JSON.parse(xhr.response),data.success===!0&&(isServerValid=!0)}catch(err){}displayBlockedMessage(isServerValid?!1:!0)}else displayBlockedMessage(!0)}})})}),require(["globals","util","platform","goog","VMSetup","data"],function(g,util,platform,goog,VMSetup,d){ShouldLog(LogLevels.Timing)&&log("Goog Callback - Loaded: ",log.now()),g.fireCustomEvent("gapiLoaded");var setTokenFromHash=!1;(!platform.ie||platform.mobile)&&(setTokenFromHash=goog.checkTokenInHash());var hasLoginParam=util.hasURLParam("login","true"),hasUserParam=util.hasURLParam("user"),doLogin=setTokenFromHash||hasLoginParam||hasUserParam||g.getLoginState()==LoginState.LOGGED_IN,skipLogin=!1;if(hasUserParam){var forceUser=util.getURLParam("user"),activeUser=g.settings.get(Settings.activeUser);util.removeURLParam("user",!0),forceUser!==activeUser&&(g.settings.set(Settings.activeUser,forceUser),void 0!==activeUser&&(d.clearData(function(){g.reload()},{Default:[Settings.activeUser]}),skipLogin=!0))}skipLogin||goog.runAuthenticate(goog.requestScopes,!0,!1,function(token){ShouldLog(LogLevels.Timing)&&log("Goog Authorized - Callback: ",log.now()),hasLoginParam&&util.removeURLParam("login",!0),token&&!token.error?(doLogin&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),goog.loadClientDefaultFile(),g.openMainPage()),goog.ensureRequiredScopesAreRequested()):goog.requiredScopes!==goog.requestScopes?(g.settings.reset(Settings.authScopes),goog.runAuthenticate(goog.requiredScopes,!0,!1,function(token2){token2&&!token2.error?doLogin&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),goog.loadClientDefaultFile(),g.runOnLoad(function(){g.openMainPage()})):(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_OUT):g.setLoginState(LoginState.LOGGED_OUT),g.runOnLoad(function(){g.openSetupPage()}))})):(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_OUT):g.setLoginState(LoginState.LOGGED_OUT),g.runOnLoad(function(){g.openSetupPage()}))})})}}var requirejs,require,define;!function(undef){function hasProp(obj,prop){return hasOwn.call(obj,prop)}function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,lastIndex,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&"."===name.charAt(0))if(baseName){for(baseParts=baseParts.slice(0,baseParts.length-1),name=name.split("/"),lastIndex=name.length-1,config.nodeIdCompat&&jsSuffixRegExp.test(name[lastIndex])&&(name[lastIndex]=name[lastIndex].replace(jsSuffixRegExp,"")),name=baseParts.concat(name),i=0;i<name.length;i+=1)if(part=name[i],"."===part)name.splice(i,1),i-=1;else if(".."===part){if(1===i&&(".."===name[2]||".."===name[0]))break;i>0&&(name.splice(i-1,2),i-=2)}name=name.join("/")}else 0===name.indexOf("./")&&(name=name.substring(2));if((baseParts||starMap)&&map){for(nameParts=name.split("/"),i=nameParts.length;i>0;i-=1){if(nameSegment=nameParts.slice(0,i).join("/"),baseParts)for(j=baseParts.length;j>0;j-=1)if(mapValue=map[baseParts.slice(0,j).join("/")],mapValue&&(mapValue=mapValue[nameSegment])){foundMap=mapValue,foundI=i;break}if(foundMap)break;!foundStarMap&&starMap&&starMap[nameSegment]&&(foundStarMap=starMap[nameSegment],starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return name}function makeRequire(relName,forceSync){return function(){var args=aps.call(arguments,0);return"string"!=typeof args[0]&&1===args.length&&args.push(null),req.apply(undef,args.concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(hasProp(waiting,name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!hasProp(defined,name)&&!hasProp(defining,name))throw new Error("No "+name);return defined[name]}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;return index>-1&&(prefix=name.substring(0,index),name=name.substring(index+1,name.length)),[prefix,name]}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var main,req,makeMap,handlers,defined={},waiting={},config={},defining={},hasOwn=Object.prototype.hasOwnProperty,aps=[].slice,jsSuffixRegExp=/\.js$/;makeMap=function(name,relName){var plugin,parts=splitPrefix(name),prefix=parts[0];return name=parts[1],prefix&&(prefix=normalize(prefix,relName),plugin=callDep(prefix)),prefix?name=plugin&&plugin.normalize?plugin.normalize(name,makeNormalize(relName)):normalize(name,relName):(name=normalize(name,relName),parts=splitPrefix(name),prefix=parts[0],name=parts[1],prefix&&(plugin=callDep(prefix))),{f:prefix?prefix+"!"+name:name,n:name,pr:prefix,p:plugin}},handlers={require:function(name){return makeRequire(name)},exports:function(name){var e=defined[name];return"undefined"!=typeof e?e:defined[name]={}},module:function(name){return{id:name,uri:"",exports:defined[name],config:makeConfig(name)}}},main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,args=[],callbackType=typeof callback,usingExports;if(relName=relName||name,"undefined"===callbackType||"function"===callbackType){for(deps=!deps.length&&callback.length?["require","exports","module"]:deps,i=0;i<deps.length;i+=1)if(map=makeMap(deps[i],relName),depName=map.f,"require"===depName)args[i]=handlers.require(name);else if("exports"===depName)args[i]=handlers.exports(name),usingExports=!0;else if("module"===depName)cjsModule=args[i]=handlers.module(name);else if(hasProp(defined,depName)||hasProp(waiting,depName)||hasProp(defining,depName))args[i]=callDep(depName);else{if(!map.p)throw new Error(name+" missing "+depName);map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName]}ret=callback?callback.apply(defined[name],args):void 0,name&&(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name]?defined[name]=cjsModule.exports:ret===undef&&usingExports||(defined[name]=ret))}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync,alt){if("string"==typeof deps)return handlers[deps]?handlers[deps](callback):callDep(makeMap(deps,callback).f);if(deps&&!deps.splice){if(config=deps,config.deps&&req(config.deps,config.callback),!callback)return;callback.splice?(deps=callback,callback=relName,relName=null):deps=undef}return callback=callback||function(){},"function"==typeof relName&&(relName=forceSync,forceSync=alt),forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},0),req},req.config=function(cfg){return req(cfg)},requirejs._defined=defined,define=function(name,deps,callback){if("string"!=typeof name)throw new Error("Incorrect module build - no module name");deps&&deps.splice||(callback=deps,deps=[]),hasProp(defined,name)||hasProp(waiting,name)||(waiting[name]=[name,deps,callback])},define.amd={jQuery:!0}}(),define("lib/almond",function(){}),function(){!function(p){var s=this||(0,eval)("this"),v=s.document,L=s.navigator,w=s.jQuery,D=s.JSON;!function(p){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?p(module.exports||exports,require):"function"==typeof define&&define.amd?define("ko",["exports","require"],p):p(s.ko={})}(function(M,N){function H(a,d){return null===a||typeof a in R?a===d:!1}function S(a,d){var c;return function(){c||(c=setTimeout(function(){c=p,a()},d))}}function T(a,d){var c;return function(){clearTimeout(c),c=setTimeout(a,d)}}function I(b,d,c,e){a.d[b]={init:function(b,h,k,f,m){var l,q;return a.s(function(){var f=a.a.c(h()),k=!c!=!f,z=!q;(z||d||k!==l)&&(z&&a.Y.la()&&(q=a.a.ia(a.f.childNodes(b),!0)),k?(z||a.f.T(b,a.a.ia(q)),a.Ca(e?e(m,f):m,b)):a.f.ja(b),l=k)},null,{o:b}),{controlsDescendantBindings:!0}}},a.h.ha[b]=!1,a.f.Q[b]=!0}var a="undefined"!=typeof M?M:{};a.b=function(b,d){for(var c=b.split("."),e=a,g=0;g<c.length-1;g++)e=e[c[g]];e[c[c.length-1]]=d},a.A=function(a,d,c){a[d]=c},a.version="3.2.0",a.b("version",a.version),a.a=function(){function b(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c])}function d(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function c(a,b){return a.__proto__=b,a}var e={__proto__:[]}instanceof Array,g={},h={};g[L&&/Firefox\/2/i.test(L.userAgent)?"KeyboardEvent":"UIEvents"]=["keyup","keydown","keypress"],g.MouseEvents="click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave".split(" "),b(g,function(a,b){if(b.length)for(var c=0,d=b.length;d>c;c++)h[b[c]]=a});var k={propertychange:!0},f=v&&function(){for(var a=3,b=v.createElement("div"),c=b.getElementsByTagName("i");b.innerHTML="<!--[if gt IE "+ ++a+"]><i></i><![endif]-->",c[0];);return a>4?a:p}();return{vb:["authenticity_token",/^__RequestVerificationToken(_.*)?$/],u:function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)},m:function(a,b){if("function"==typeof Array.prototype.indexOf)return Array.prototype.indexOf.call(a,b);for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},qb:function(a,b,c){for(var d=0,f=a.length;f>d;d++)if(b.call(c,a[d],d))return a[d];return null},ua:function(m,b){var c=a.a.m(m,b);c>0?m.splice(c,1):0===c&&m.shift()},rb:function(m){m=m||[];for(var b=[],c=0,d=m.length;d>c;c++)0>a.a.m(b,m[c])&&b.push(m[c]);return b},Da:function(a,b){a=a||[];for(var c=[],d=0,f=a.length;f>d;d++)c.push(b(a[d],d));return c},ta:function(a,b){a=a||[];for(var c=[],d=0,f=a.length;f>d;d++)b(a[d],d)&&c.push(a[d]);return c},ga:function(a,b){if(b instanceof Array)a.push.apply(a,b);else for(var c=0,d=b.length;d>c;c++)a.push(b[c]);return a},ea:function(b,c,d){var f=a.a.m(a.a.Xa(b),c);0>f?d&&b.push(c):d||b.splice(f,1)},xa:e,extend:d,za:c,Aa:e?c:d,G:b,na:function(a,b){if(!a)return a;var c={},d;for(d in a)a.hasOwnProperty(d)&&(c[d]=b(a[d],d,a));return c},Ka:function(b){for(;b.firstChild;)a.removeNode(b.firstChild)},oc:function(b){b=a.a.S(b);for(var c=v.createElement("div"),d=0,f=b.length;f>d;d++)c.appendChild(a.R(b[d]));return c},ia:function(b,c){for(var d=0,f=b.length,e=[];f>d;d++){var k=b[d].cloneNode(!0);e.push(c?a.R(k):k)}return e},T:function(b,c){if(a.a.Ka(b),c)for(var d=0,f=c.length;f>d;d++)b.appendChild(c[d])},Lb:function(b,c){var d=b.nodeType?[b]:b;if(0<d.length){for(var f=d[0],e=f.parentNode,k=0,g=c.length;g>k;k++)e.insertBefore(c[k],f);for(k=0,g=d.length;g>k;k++)a.removeNode(d[k])}},ka:function(a,b){if(a.length){for(b=8===b.nodeType&&b.parentNode||b;a.length&&a[0].parentNode!==b;)a.shift();if(1<a.length){var c=a[0],d=a[a.length-1];for(a.length=0;c!==d;)if(a.push(c),c=c.nextSibling,!c)return;a.push(d)}}return a},Nb:function(a,b){7>f?a.setAttribute("selected",b):a.selected=b},cb:function(a){return null===a||a===p?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")},vc:function(a,b){return a=a||"",b.length>a.length?!1:a.substring(0,b.length)===b},cc:function(a,b){if(a===b)return!0;if(11===a.nodeType)return!1;if(b.contains)return b.contains(3===a.nodeType?a.parentNode:a);if(b.compareDocumentPosition)return 16==(16&b.compareDocumentPosition(a));for(;a&&a!=b;)a=a.parentNode;return!!a},Ja:function(b){return a.a.cc(b,b.ownerDocument.documentElement)},ob:function(b){return!!a.a.qb(b,a.a.Ja)},t:function(a){return a&&a.tagName&&a.tagName.toLowerCase()},n:function(b,c,d){var e=f&&k[c];if(!e&&w)w(b).bind(c,d);else if(e||"function"!=typeof b.addEventListener){if("undefined"==typeof b.attachEvent)throw Error("Browser doesn't support addEventListener or attachEvent");var g=function(a){d.call(b,a)},h="on"+c;b.attachEvent(h,g),a.a.w.da(b,function(){b.detachEvent(h,g)})}else b.addEventListener(c,d,!1)},oa:function(b,c){if(!b||!b.nodeType)throw Error("element must be a DOM node when calling triggerEvent");var d;if("input"===a.a.t(b)&&b.type&&"click"==c.toLowerCase()?(d=b.type,d="checkbox"==d||"radio"==d):d=!1,w&&!d)w(b).trigger(c);else if("function"==typeof v.createEvent){if("function"!=typeof b.dispatchEvent)throw Error("The supplied element doesn't support dispatchEvent");d=v.createEvent(h[c]||"HTMLEvents"),d.initEvent(c,!0,!0,s,0,0,0,0,0,!1,!1,!1,!1,0,b),b.dispatchEvent(d)}else if(d&&b.click)b.click();else{if("undefined"==typeof b.fireEvent)throw Error("Browser doesn't support triggering events");b.fireEvent("on"+c)}},c:function(b){return a.C(b)?b():b},Xa:function(b){return a.C(b)?b.v():b},Ba:function(b,c,d){if(c){var f=/\S+/g,e=b.className.match(f)||[];a.a.u(c.match(f),function(b){a.a.ea(e,b,d)}),b.className=e.join(" ")}},bb:function(b,c){var d=a.a.c(c);(null===d||d===p)&&(d="");var f=a.f.firstChild(b);!f||3!=f.nodeType||a.f.nextSibling(f)?a.f.T(b,[b.ownerDocument.createTextNode(d)]):f.data=d,a.a.fc(b)},Mb:function(a,b){if(a.name=b,7>=f)try{a.mergeAttributes(v.createElement("<input name='"+a.name+"'/>"),!1)}catch(c){}},fc:function(a){f>=9&&(a=1==a.nodeType?a:a.parentNode,a.style&&(a.style.zoom=a.style.zoom))},dc:function(a){if(f){var b=a.style.width;a.style.width=0,a.style.width=b}},sc:function(b,c){b=a.a.c(b),c=a.a.c(c);for(var d=[],f=b;c>=f;f++)d.push(f);return d},S:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c]);return b},yc:6===f,zc:7===f,L:f,xb:function(b,c){for(var d=a.a.S(b.getElementsByTagName("input")).concat(a.a.S(b.getElementsByTagName("textarea"))),f="string"==typeof c?function(a){return a.name===c}:function(a){return c.test(a.name)},e=[],k=d.length-1;k>=0;k--)f(d[k])&&e.push(d[k]);return e},pc:function(b){return"string"==typeof b&&(b=a.a.cb(b))?D&&D.parse?D.parse(b):new Function("return "+b)():null},eb:function(b,c,d){if(!D||!D.stringify)throw Error("Cannot find JSON.stringify(). Some browsers (e.g., IE < 8) don't support it natively, but you can overcome this by adding a script reference to json2.js, downloadable from http://www.json.org/json2.js");return D.stringify(a.a.c(b),c,d)},qc:function(c,d,f){f=f||{};var e=f.params||{},k=f.includeFields||this.vb,g=c;if("object"==typeof c&&"form"===a.a.t(c))for(var g=c.action,h=k.length-1;h>=0;h--)for(var r=a.a.xb(c,k[h]),E=r.length-1;E>=0;E--)e[r[E].name]=r[E].value;d=a.a.c(d);var y=v.createElement("form");y.style.display="none",y.action=g,y.method="post";for(var p in d)c=v.createElement("input"),c.type="hidden",c.name=p,c.value=a.a.eb(a.a.c(d[p])),y.appendChild(c);b(e,function(a,b){var c=v.createElement("input");c.type="hidden",c.name=a,c.value=b,y.appendChild(c)}),v.body.appendChild(y),f.submitter?f.submitter(y):y.submit(),setTimeout(function(){y.parentNode.removeChild(y)},0)}}}(),a.b("utils",a.a),a.b("utils.arrayForEach",a.a.u),a.b("utils.arrayFirst",a.a.qb),a.b("utils.arrayFilter",a.a.ta),a.b("utils.arrayGetDistinctValues",a.a.rb),a.b("utils.arrayIndexOf",a.a.m),a.b("utils.arrayMap",a.a.Da),a.b("utils.arrayPushAll",a.a.ga),a.b("utils.arrayRemoveItem",a.a.ua),a.b("utils.extend",a.a.extend),a.b("utils.fieldsIncludedWithJsonPost",a.a.vb),a.b("utils.getFormFields",a.a.xb),a.b("utils.peekObservable",a.a.Xa),a.b("utils.postJson",a.a.qc),a.b("utils.parseJson",a.a.pc),a.b("utils.registerEventHandler",a.a.n),a.b("utils.stringifyJson",a.a.eb),a.b("utils.range",a.a.sc),a.b("utils.toggleDomNodeCssClass",a.a.Ba),a.b("utils.triggerEvent",a.a.oa),a.b("utils.unwrapObservable",a.a.c),a.b("utils.objectForEach",a.a.G),a.b("utils.addOrRemoveItem",a.a.ea),a.b("unwrap",a.a.c),Function.prototype.bind||(Function.prototype.bind=function(a){var d=this,c=Array.prototype.slice.call(arguments);return a=c.shift(),function(){return d.apply(a,c.concat(Array.prototype.slice.call(arguments)))}}),a.a.e=new function(){function a(b,h){var k=b[c];if(!k||"null"===k||!e[k]){if(!h)return p;k=b[c]="ko"+d++,e[k]={}}return e[k]}var d=0,c="__ko__"+(new Date).getTime(),e={};return{get:function(c,d){var e=a(c,!1);return e===p?p:e[d]},set:function(c,d,e){(e!==p||a(c,!1)!==p)&&(a(c,!0)[d]=e)},clear:function(a){var b=a[c];return b?(delete e[b],a[c]=null,!0):!1},F:function(){return d++ +c}}},a.b("utils.domData",a.a.e),a.b("utils.domData.clear",a.a.e.clear),a.a.w=new function(){function b(b,d){var f=a.a.e.get(b,c);return f===p&&d&&(f=[],a.a.e.set(b,c,f)),f}function d(c){var e=b(c,!1);if(e)for(var e=e.slice(0),f=0;f<e.length;f++)e[f](c);if(a.a.e.clear(c),a.a.w.cleanExternalData(c),g[c.nodeType])for(e=c.firstChild;c=e;)e=c.nextSibling,8===c.nodeType&&d(c)}var c=a.a.e.F(),e={1:!0,8:!0,9:!0},g={1:!0,9:!0};return{da:function(a,c){if("function"!=typeof c)throw Error("Callback must be a function");b(a,!0).push(c)},Kb:function(d,e){var f=b(d,!1);f&&(a.a.ua(f,e),0==f.length&&a.a.e.set(d,c,p))},R:function(b){if(e[b.nodeType]&&(d(b),g[b.nodeType])){var c=[];a.a.ga(c,b.getElementsByTagName("*"));for(var f=0,m=c.length;m>f;f++)d(c[f])}return b},removeNode:function(b){a.R(b),b.parentNode&&b.parentNode.removeChild(b)},cleanExternalData:function(a){w&&"function"==typeof w.cleanData&&w.cleanData([a])}}},a.R=a.a.w.R,a.removeNode=a.a.w.removeNode,a.b("cleanNode",a.R),a.b("removeNode",a.removeNode),a.b("utils.domNodeDisposal",a.a.w),a.b("utils.domNodeDisposal.addDisposeCallback",a.a.w.da),a.b("utils.domNodeDisposal.removeDisposeCallback",a.a.w.Kb),function(){a.a.ba=function(b){var d;if(w){if(w.parseHTML)d=w.parseHTML(b)||[];else if((d=w.clean([b]))&&d[0]){for(b=d[0];b.parentNode&&11!==b.parentNode.nodeType;)b=b.parentNode;b.parentNode&&b.parentNode.removeChild(b)}}else{var c=a.a.cb(b).toLowerCase();for(d=v.createElement("div"),c=c.match(/^<(thead|tbody|tfoot)/)&&[1,"<table>","</table>"]||!c.indexOf("<tr")&&[2,"<table><tbody>","</tbody></table>"]||(!c.indexOf("<td")||!c.indexOf("<th"))&&[3,"<table><tbody><tr>","</tr></tbody></table>"]||[0,"",""],b="ignored<div>"+c[1]+b+c[2]+"</div>","function"==typeof s.innerShiv?d.appendChild(s.innerShiv(b)):d.innerHTML=b;c[0]--;)d=d.lastChild;d=a.a.S(d.lastChild.childNodes)}return d},a.a.$a=function(b,d){if(a.a.Ka(b),d=a.a.c(d),null!==d&&d!==p)if("string"!=typeof d&&(d=d.toString()),w)w(b).html(d);else for(var c=a.a.ba(d),e=0;e<c.length;e++)b.appendChild(c[e])}}(),a.b("utils.parseHtmlFragment",a.a.ba),a.b("utils.setHtml",a.a.$a),a.D=function(){function b(c,d){if(c)if(8==c.nodeType){var g=a.D.Gb(c.nodeValue);null!=g&&d.push({bc:c,mc:g})}else if(1==c.nodeType)for(var g=0,h=c.childNodes,k=h.length;k>g;g++)b(h[g],d)}var d={};return{Ua:function(a){if("function"!=typeof a)throw Error("You can only pass a function to ko.memoization.memoize()");var b=(4294967296*(1+Math.random())|0).toString(16).substring(1)+(4294967296*(1+Math.random())|0).toString(16).substring(1);return d[b]=a,"<!--[ko_memo:"+b+"]-->"},Rb:function(a,b){var g=d[a];if(g===p)throw Error("Couldn't find any memo with ID "+a+". Perhaps it's already been unmemoized.");try{return g.apply(null,b||[]),!0}finally{delete d[a]}},Sb:function(c,d){var g=[];b(c,g);for(var h=0,k=g.length;k>h;h++){var f=g[h].bc,m=[f];d&&a.a.ga(m,d),a.D.Rb(g[h].mc,m),f.nodeValue="",f.parentNode&&f.parentNode.removeChild(f)}},Gb:function(a){return(a=a.match(/^\[ko_memo\:(.*?)\]$/))?a[1]:null}}}(),a.b("memoization",a.D),a.b("memoization.memoize",a.D.Ua),a.b("memoization.unmemoize",a.D.Rb),a.b("memoization.parseMemoText",a.D.Gb),a.b("memoization.unmemoizeDomNodeAndDescendants",a.D.Sb),a.La={throttle:function(b,d){b.throttleEvaluation=d;var c=null;return a.j({read:b,write:function(a){clearTimeout(c),c=setTimeout(function(){b(a)},d)}})},rateLimit:function(a,d){var c,e,g;"number"==typeof d?c=d:(c=d.timeout,e=d.method),g="notifyWhenChangesStop"==e?T:S,a.Ta(function(a){return g(a,c)})},notify:function(a,d){a.equalityComparer="always"==d?null:H}};var R={undefined:1,"boolean":1,number:1,string:1};a.b("extenders",a.La),a.Pb=function(b,d,c){this.target=b,this.wa=d,this.ac=c,this.Cb=!1,a.A(this,"dispose",this.K)},a.Pb.prototype.K=function(){this.Cb=!0,this.ac()},a.P=function(){a.a.Aa(this,a.P.fn),this.M={}};var G="change",A={U:function(b,d,c){var e=this;c=c||G;var g=new a.Pb(e,d?b.bind(d):b,function(){a.a.ua(e.M[c],g),e.nb&&e.nb()});return e.va&&e.va(c),e.M[c]||(e.M[c]=[]),e.M[c].push(g),g},notifySubscribers:function(b,d){if(d=d||G,this.Ab(d))try{a.k.Ea();for(var c=this.M[d].slice(0),e=0,g;g=c[e];++e)g.Cb||g.wa(b)}finally{a.k.end()}},Ta:function(b){var d=this,c=a.C(d),e,g,h;d.qa||(d.qa=d.notifySubscribers,d.notifySubscribers=function(a,b){b&&b!==G?"beforeChange"===b?d.kb(a):d.qa(a,b):d.lb(a)});var k=b(function(){c&&h===d&&(h=d()),e=!1,d.Pa(g,h)&&d.qa(g=h)});d.lb=function(a){e=!0,h=a,k()},d.kb=function(a){e||(g=a,d.qa(a,"beforeChange"))}},Ab:function(a){return this.M[a]&&this.M[a].length},yb:function(){var b=0;return a.a.G(this.M,function(a,c){b+=c.length}),b},Pa:function(a,d){return!this.equalityComparer||!this.equalityComparer(a,d)},extend:function(b){var d=this;return b&&a.a.G(b,function(b,e){var g=a.La[b];"function"==typeof g&&(d=g(d,e)||d)}),d}};a.A(A,"subscribe",A.U),a.A(A,"extend",A.extend),a.A(A,"getSubscriptionsCount",A.yb),a.a.xa&&a.a.za(A,Function.prototype),a.P.fn=A,a.Db=function(a){return null!=a&&"function"==typeof a.U&&"function"==typeof a.notifySubscribers},a.b("subscribable",a.P),a.b("isSubscribable",a.Db),a.Y=a.k=function(){function b(a){c.push(e),e=a}function d(){e=c.pop()}var c=[],e,g=0;return{Ea:b,end:d,Jb:function(b){if(e){if(!a.Db(b))throw Error("Only subscribable things can act as dependencies");e.wa(b,b.Vb||(b.Vb=++g))}},B:function(a,c,f){try{return b(),a.apply(c,f||[])}finally{d()}},la:function(){return e?e.s.la():void 0},ma:function(){return e?e.ma:void 0}}}(),a.b("computedContext",a.Y),a.b("computedContext.getDependenciesCount",a.Y.la),a.b("computedContext.isInitial",a.Y.ma),a.b("computedContext.isSleeping",a.Y.Ac),a.p=function(b){function d(){return 0<arguments.length?(d.Pa(c,arguments[0])&&(d.X(),c=arguments[0],d.W()),this):(a.k.Jb(d),c)}var c=b;return a.P.call(d),a.a.Aa(d,a.p.fn),d.v=function(){return c},d.W=function(){d.notifySubscribers(c)},d.X=function(){d.notifySubscribers(c,"beforeChange")},a.A(d,"peek",d.v),a.A(d,"valueHasMutated",d.W),a.A(d,"valueWillMutate",d.X),d},a.p.fn={equalityComparer:H};var F=a.p.rc="__ko_proto__";a.p.fn[F]=a.p,a.a.xa&&a.a.za(a.p.fn,a.P.fn),a.Ma=function(b,d){return null===b||b===p||b[F]===p?!1:b[F]===d?!0:a.Ma(b[F],d)},a.C=function(b){return a.Ma(b,a.p)},a.Ra=function(b){return"function"==typeof b&&b[F]===a.p||"function"==typeof b&&b[F]===a.j&&b.hc?!0:!1},a.b("observable",a.p),a.b("isObservable",a.C),a.b("isWriteableObservable",a.Ra),a.b("isWritableObservable",a.Ra),a.aa=function(b){if(b=b||[],"object"!=typeof b||!("length"in b))throw Error("The argument passed when initializing an observable array must be an array, or null, or undefined.");return b=a.p(b),a.a.Aa(b,a.aa.fn),b.extend({trackArrayChanges:!0})},a.aa.fn={remove:function(b){for(var d=this.v(),c=[],e="function"!=typeof b||a.C(b)?function(a){return a===b}:b,g=0;g<d.length;g++){var h=d[g];e(h)&&(0===c.length&&this.X(),c.push(h),d.splice(g,1),g--)}return c.length&&this.W(),c},removeAll:function(b){if(b===p){var d=this.v(),c=d.slice(0);return this.X(),d.splice(0,d.length),this.W(),c}return b?this.remove(function(c){return 0<=a.a.m(b,c)}):[]},destroy:function(b){var d=this.v(),c="function"!=typeof b||a.C(b)?function(a){return a===b}:b;this.X();for(var e=d.length-1;e>=0;e--)c(d[e])&&(d[e]._destroy=!0);this.W()},destroyAll:function(b){return b===p?this.destroy(function(){return!0}):b?this.destroy(function(d){return 0<=a.a.m(b,d)}):[]},indexOf:function(b){var d=this();return a.a.m(d,b)},replace:function(a,d){var c=this.indexOf(a);c>=0&&(this.X(),this.v()[c]=d,this.W())}},a.a.u("pop push reverse shift sort splice unshift".split(" "),function(b){a.aa.fn[b]=function(){var a=this.v();return this.X(),this.sb(a,b,arguments),a=a[b].apply(a,arguments),this.W(),a}}),a.a.u(["slice"],function(b){a.aa.fn[b]=function(){var a=this();return a[b].apply(a,arguments)}}),a.a.xa&&a.a.za(a.aa.fn,a.p.fn),a.b("observableArray",a.aa);var J="arrayChange";a.La.trackArrayChanges=function(b){function d(){if(!c){c=!0;var d=b.notifySubscribers;b.notifySubscribers=function(a,b){return b&&b!==G||++g,d.apply(this,arguments)};var f=[].concat(b.v()||[]);e=null,b.U(function(c){if(c=[].concat(c||[]),b.Ab(J)){var d;(!e||g>1)&&(e=a.a.Fa(f,c,{sparse:!0})),d=e,d.length&&b.notifySubscribers(d,J)}f=c,e=null,g=0})}}if(!b.sb){var c=!1,e=null,g=0,h=b.U;b.U=b.subscribe=function(a,b,c){return c===J&&d(),h.apply(this,arguments)},b.sb=function(b,d,m){function l(a,b,c){return q[q.length]={status:a,value:b,index:c}}if(c&&!g){var q=[],h=b.length,t=m.length,z=0;switch(d){case"push":z=h;case"unshift":for(d=0;t>d;d++)l("added",m[d],z+d);break;case"pop":z=h-1;case"shift":h&&l("deleted",b[z],z);break;case"splice":d=Math.min(Math.max(0,0>m[0]?h+m[0]:m[0]),h);for(var h=1===t?h:Math.min(d+(m[1]||0),h),t=d+t-2,z=Math.max(h,t),u=[],r=[],E=2;z>d;++d,++E)h>d&&r.push(l("deleted",b[d],d)),t>d&&u.push(l("added",m[E],d));a.a.wb(r,u);break;default:return}e=q}}}},a.s=a.j=function(b,d,c){function e(){a.a.G(v,function(a,b){b.K()}),v={}}function g(){e(),C=0,u=!0,n=!1}function h(){var a=f.throttleEvaluation;a&&a>=0?(clearTimeout(P),P=setTimeout(k,a)):f.ib?f.ib():k()}function k(b){if(t){if(E)throw Error("A 'pure' computed must not be called recursively")}else if(!u){if(w&&w()){if(!z)return void s()}else z=!1;if(t=!0,y)try{var c={};a.k.Ea({wa:function(a,b){c[b]||(c[b]=1,++C)},s:f,ma:p}),C=0,q=r.call(d)}finally{a.k.end(),t=!1}else try{var e=v,m=C;a.k.Ea({wa:function(a,b){u||(m&&e[b]?(v[b]=e[b],++C,delete e[b],--m):v[b]||(v[b]=a.U(h),++C))},s:f,ma:E?p:!C}),v={},C=0;try{var l=d?r.call(d):r()}finally{a.k.end(),m&&a.a.G(e,function(a,b){b.K()}),n=!1}f.Pa(q,l)&&(f.notifySubscribers(q,"beforeChange"),q=l,!0!==b&&f.notifySubscribers(q))}finally{t=!1}C||s()}}function f(){if(0<arguments.length){if("function"!=typeof O)throw Error("Cannot write a value to a ko.computed unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters.");return O.apply(d,arguments),this}return a.k.Jb(f),n&&k(!0),q}function m(){return n&&!C&&k(!0),q}function l(){return n||C>0}var q,n=!0,t=!1,z=!1,u=!1,r=b,E=!1,y=!1;if(r&&"object"==typeof r?(c=r,r=c.read):(c=c||{},r||(r=c.read)),"function"!=typeof r)throw Error("Pass a function that returns the value of the ko.computed");var O=c.write,x=c.disposeWhenNodeIsRemoved||c.o||null,B=c.disposeWhen||c.Ia,w=B,s=g,v={},C=0,P=null;d||(d=c.owner),a.P.call(f),a.a.Aa(f,a.j.fn),f.v=m,f.la=function(){return C},f.hc="function"==typeof c.write,f.K=function(){s()},f.Z=l;var A=f.Ta;return f.Ta=function(a){A.call(f,a),f.ib=function(){f.kb(q),n=!0,f.lb(f)}},c.pure?(y=E=!0,f.va=function(){y&&(y=!1,k(!0))},f.nb=function(){f.yb()||(e(),y=n=!0)}):c.deferEvaluation&&(f.va=function(){m(),delete f.va}),a.A(f,"peek",f.v),a.A(f,"dispose",f.K),a.A(f,"isActive",f.Z),a.A(f,"getDependenciesCount",f.la),x&&(z=!0,x.nodeType&&(w=function(){return!a.a.Ja(x)||B&&B()})),y||c.deferEvaluation||k(),x&&l()&&x.nodeType&&(s=function(){a.a.w.Kb(x,s),g()},a.a.w.da(x,s)),f},a.jc=function(b){return a.Ma(b,a.j)},A=a.p.rc,a.j[A]=a.p,a.j.fn={equalityComparer:H},a.j.fn[A]=a.j,a.a.xa&&a.a.za(a.j.fn,a.P.fn),a.b("dependentObservable",a.j),a.b("computed",a.j),a.b("isComputed",a.jc),a.Ib=function(b,d){return"function"==typeof b?a.s(b,d,{pure:!0}):(b=a.a.extend({},b),b.pure=!0,a.s(b,d))},a.b("pureComputed",a.Ib),function(){function b(a,g,h){if(h=h||new c,a=g(a),"object"!=typeof a||null===a||a===p||a instanceof Date||a instanceof String||a instanceof Number||a instanceof Boolean)return a;var k=a instanceof Array?[]:{};return h.save(a,k),d(a,function(c){var d=g(a[c]);switch(typeof d){case"boolean":case"number":case"string":case"function":k[c]=d;break;case"object":case"undefined":var l=h.get(d);k[c]=l!==p?l:b(d,g,h)}}),k}function d(a,b){if(a instanceof Array){for(var c=0;c<a.length;c++)b(c);"function"==typeof a.toJSON&&b("toJSON")}else for(c in a)b(c)}function c(){this.keys=[],this.hb=[]}a.Qb=function(c){if(0==arguments.length)throw Error("When calling ko.toJS, pass the object you want to convert.");return b(c,function(b){for(var c=0;a.C(b)&&10>c;c++)b=b();return b})},a.toJSON=function(b,c,d){return b=a.Qb(b),a.a.eb(b,c,d)},c.prototype={save:function(b,c){var d=a.a.m(this.keys,b);d>=0?this.hb[d]=c:(this.keys.push(b),this.hb.push(c))},get:function(b){return b=a.a.m(this.keys,b),b>=0?this.hb[b]:p}}}(),a.b("toJS",a.Qb),a.b("toJSON",a.toJSON),function(){a.i={q:function(b){switch(a.a.t(b)){case"option":return!0===b.__ko__hasDomDataOptionValue__?a.a.e.get(b,a.d.options.Va):7>=a.a.L?b.getAttributeNode("value")&&b.getAttributeNode("value").specified?b.value:b.text:b.value;case"select":return 0<=b.selectedIndex?a.i.q(b.options[b.selectedIndex]):p;default:return b.value}},ca:function(b,d,c){switch(a.a.t(b)){case"option":switch(typeof d){case"string":a.a.e.set(b,a.d.options.Va,p),"__ko__hasDomDataOptionValue__"in b&&delete b.__ko__hasDomDataOptionValue__,b.value=d;break;default:a.a.e.set(b,a.d.options.Va,d),b.__ko__hasDomDataOptionValue__=!0,b.value="number"==typeof d?d:""}break;case"select":(""===d||null===d)&&(d=p);for(var e=-1,g=0,h=b.options.length,k;h>g;++g)if(k=a.i.q(b.options[g]),k==d||""==k&&d===p){e=g;break}(c||e>=0||d===p&&1<b.size)&&(b.selectedIndex=e);break;default:(null===d||d===p)&&(d=""),b.value=d}}}}(),a.b("selectExtensions",a.i),a.b("selectExtensions.readValue",a.i.q),a.b("selectExtensions.writeValue",a.i.ca),a.h=function(){function b(b){b=a.a.cb(b),123===b.charCodeAt(0)&&(b=b.slice(1,-1));var c=[],d=b.match(e),k,n,t=0;if(d){d.push(",");for(var z=0,u;u=d[z];++z){var r=u.charCodeAt(0);if(44===r){if(0>=t){k&&c.push(n?{key:k,value:n.join("")}:{unknown:k}),k=n=t=0;continue}}else if(58===r){if(!n)continue}else if(47===r&&z&&1<u.length)(r=d[z-1].match(g))&&!h[r[0]]&&(b=b.substr(b.indexOf(u)+1),d=b.match(e),d.push(","),z=-1,u="/");
else if(40===r||123===r||91===r)++t;else if(41===r||125===r||93===r)--t;else if(!k&&!n){k=34===r||39===r?u.slice(1,-1):u;continue}n?n.push(u):n=[u]}}return c}var d=["true","false","null","undefined"],c=/^(?:[$_a-z][$\w]*|(.+)(\.\s*[$_a-z][$\w]*|\[.+\]))$/i,e=RegExp("\"(?:[^\"\\\\]|\\\\.)*\"|'(?:[^'\\\\]|\\\\.)*'|/(?:[^/\\\\]|\\\\.)*/w*|[^\\s:,/][^,\"'{}()/:[\\]]*[^\\s,\"'{}()/:[\\]]|[^\\s]","g"),g=/[\])"'A-Za-z0-9_$]+$/,h={"in":1,"return":1,"typeof":1},k={};return{ha:[],V:k,Wa:b,ya:function(f,m){function e(b,m){var f;if(!z){var u=a.getBindingHandler(b);if(u&&u.preprocess&&!(m=u.preprocess(m,b,e)))return;(u=k[b])&&(f=m,0<=a.a.m(d,f)?f=!1:(u=f.match(c),f=null===u?!1:u[1]?"Object("+u[1]+")"+u[2]:f),u=f),u&&h.push("'"+b+"':function(_z){"+f+"=_z}")}t&&(m="function(){return "+m+" }"),g.push("'"+b+"':"+m)}m=m||{};var g=[],h=[],t=m.valueAccessors,z=m.bindingParams,u="string"==typeof f?b(f):f;return a.a.u(u,function(a){e(a.key||a.unknown,a.value)}),h.length&&e("_ko_property_writers","{"+h.join(",")+" }"),g.join(",")},lc:function(a,b){for(var c=0;c<a.length;c++)if(a[c].key==b)return!0;return!1},pa:function(b,c,d,e,k){b&&a.C(b)?!a.Ra(b)||k&&b.v()===e||b(e):(b=c.get("_ko_property_writers"))&&b[d]&&b[d](e)}}}(),a.b("expressionRewriting",a.h),a.b("expressionRewriting.bindingRewriteValidators",a.h.ha),a.b("expressionRewriting.parseObjectLiteral",a.h.Wa),a.b("expressionRewriting.preProcessBindings",a.h.ya),a.b("expressionRewriting._twoWayBindings",a.h.V),a.b("jsonExpressionRewriting",a.h),a.b("jsonExpressionRewriting.insertPropertyAccessorsIntoJson",a.h.ya),function(){function b(a){return 8==a.nodeType&&h.test(g?a.text:a.nodeValue)}function d(a){return 8==a.nodeType&&k.test(g?a.text:a.nodeValue)}function c(a,c){for(var f=a,e=1,k=[];f=f.nextSibling;){if(d(f)&&(e--,0===e))return k;k.push(f),b(f)&&e++}if(!c)throw Error("Cannot find closing comment tag to match: "+a.nodeValue);return null}function e(a,b){var d=c(a,b);return d?0<d.length?d[d.length-1].nextSibling:a.nextSibling:null}var g=v&&"<!--test-->"===v.createComment("test").text,h=g?/^\x3c!--\s*ko(?:\s+([\s\S]+))?\s*--\x3e$/:/^\s*ko(?:\s+([\s\S]+))?\s*$/,k=g?/^\x3c!--\s*\/ko\s*--\x3e$/:/^\s*\/ko\s*$/,f={ul:!0,ol:!0};a.f={Q:{},childNodes:function(a){return b(a)?c(a):a.childNodes},ja:function(c){if(b(c)){c=a.f.childNodes(c);for(var d=0,f=c.length;f>d;d++)a.removeNode(c[d])}else a.a.Ka(c)},T:function(c,d){if(b(c)){a.f.ja(c);for(var f=c.nextSibling,e=0,k=d.length;k>e;e++)f.parentNode.insertBefore(d[e],f)}else a.a.T(c,d)},Hb:function(a,c){b(a)?a.parentNode.insertBefore(c,a.nextSibling):a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)},Bb:function(c,d,f){f?b(c)?c.parentNode.insertBefore(d,f.nextSibling):f.nextSibling?c.insertBefore(d,f.nextSibling):c.appendChild(d):a.f.Hb(c,d)},firstChild:function(a){return b(a)?!a.nextSibling||d(a.nextSibling)?null:a.nextSibling:a.firstChild},nextSibling:function(a){return b(a)&&(a=e(a)),a.nextSibling&&d(a.nextSibling)?null:a.nextSibling},gc:b,xc:function(a){return(a=(g?a.text:a.nodeValue).match(h))?a[1]:null},Fb:function(c){if(f[a.a.t(c)]){var k=c.firstChild;if(k)do if(1===k.nodeType){var g;g=k.firstChild;var h=null;if(g)do if(h)h.push(g);else if(b(g)){var t=e(g,!0);t?g=t:h=[g]}else d(g)&&(h=[g]);while(g=g.nextSibling);if(g=h)for(h=k.nextSibling,t=0;t<g.length;t++)h?c.insertBefore(g[t],h):c.appendChild(g[t])}while(k=k.nextSibling)}}}}(),a.b("virtualElements",a.f),a.b("virtualElements.allowedBindings",a.f.Q),a.b("virtualElements.emptyNode",a.f.ja),a.b("virtualElements.insertAfter",a.f.Bb),a.b("virtualElements.prepend",a.f.Hb),a.b("virtualElements.setDomNodeChildren",a.f.T),function(){a.J=function(){this.Yb={}},a.a.extend(a.J.prototype,{nodeHasBindings:function(b){switch(b.nodeType){case 1:return null!=b.getAttribute("data-bind")||a.g.getComponentNameForNode(b);case 8:return a.f.gc(b);default:return!1}},getBindings:function(b,d){var c=this.getBindingsString(b,d),c=c?this.parseBindingsString(c,d,b):null;return a.g.mb(c,b,d,!1)},getBindingAccessors:function(b,d){var c=this.getBindingsString(b,d),c=c?this.parseBindingsString(c,d,b,{valueAccessors:!0}):null;return a.g.mb(c,b,d,!0)},getBindingsString:function(b){switch(b.nodeType){case 1:return b.getAttribute("data-bind");case 8:return a.f.xc(b);default:return null}},parseBindingsString:function(b,d,c,e){try{var g=this.Yb,h=b+(e&&e.valueAccessors||""),k;if(!(k=g[h])){var f,m="with($context){with($data||{}){return{"+a.h.ya(b,e)+"}}}";f=new Function("$context","$element",m),k=g[h]=f}return k(d,c)}catch(l){throw l.message="Unable to parse bindings.\nBindings value: "+b+"\nMessage: "+l.message,l}}}),a.J.instance=new a.J}(),a.b("bindingProvider",a.J),function(){function b(a){return function(){return a}}function d(a){return a()}function c(b){return a.a.na(a.k.B(b),function(a,c){return function(){return b()[c]}})}function e(a,b){return c(this.getBindings.bind(this,a,b))}function g(b,c,d){var f,e=a.f.firstChild(c),k=a.J.instance,g=k.preprocessNode;if(g){for(;f=e;)e=a.f.nextSibling(f),g.call(k,f);e=a.f.firstChild(c)}for(;f=e;)e=a.f.nextSibling(f),h(b,f,d)}function h(b,c,d){var e=!0,k=1===c.nodeType;k&&a.f.Fb(c),(k&&d||a.J.instance.nodeHasBindings(c))&&(e=f(c,null,b,d).shouldBindDescendants),e&&!l[a.a.t(c)]&&g(b,c,!k)}function k(b){var c=[],d={},f=[];return a.a.G(b,function y(e){if(!d[e]){var k=a.getBindingHandler(e);k&&(k.after&&(f.push(e),a.a.u(k.after,function(c){if(b[c]){if(-1!==a.a.m(f,c))throw Error("Cannot combine the following bindings, because they have a cyclic dependency: "+f.join(", "));y(c)}}),f.length--),c.push({key:e,zb:k})),d[e]=!0}}),c}function f(b,c,f,g){var m=a.a.e.get(b,q);if(!c){if(m)throw Error("You cannot apply bindings multiple times to the same element.");a.a.e.set(b,q,!0)}!m&&g&&a.Ob(b,f);var l;if(c&&"function"!=typeof c)l=c;else{var h=a.J.instance,n=h.getBindingAccessors||e,s=a.j(function(){return(l=c?c(f,b):n.call(h,b,f))&&f.I&&f.I(),l},null,{o:b});l&&s.Z()||(s=null)}var v;if(l){var w=s?function(a){return function(){return d(s()[a])}}:function(a){return l[a]},A=function(){return a.a.na(s?s():l,d)};A.get=function(a){return l[a]&&d(w(a))},A.has=function(a){return a in l},g=k(l),a.a.u(g,function(c){var d=c.zb.init,e=c.zb.update,k=c.key;if(8===b.nodeType&&!a.f.Q[k])throw Error("The binding '"+k+"' cannot be used with virtual elements");try{"function"==typeof d&&a.k.B(function(){var a=d(b,w(k),A,f.$data,f);if(a&&a.controlsDescendantBindings){if(v!==p)throw Error("Multiple bindings ("+v+" and "+k+") are trying to control descendant bindings of the same element. You cannot use these bindings together on the same element.");v=k}}),"function"==typeof e&&a.j(function(){e(b,w(k),A,f.$data,f)},null,{o:b})}catch(g){throw g.message='Unable to process binding "'+k+": "+l[k]+'"\nMessage: '+g.message,g}})}return{shouldBindDescendants:v===p}}function m(b){return b&&b instanceof a.N?b:new a.N(b)}a.d={};var l={script:!0};a.getBindingHandler=function(b){return a.d[b]},a.N=function(b,c,d,f){var e=this,k="function"==typeof b&&!a.C(b),g,m=a.j(function(){var g=k?b():b,l=a.a.c(g);return c?(c.I&&c.I(),a.a.extend(e,c),m&&(e.I=m)):(e.$parents=[],e.$root=l,e.ko=a),e.$rawData=g,e.$data=l,d&&(e[d]=l),f&&f(e,c,l),e.$data},null,{Ia:function(){return g&&!a.a.ob(g)},o:!0});m.Z()&&(e.I=m,m.equalityComparer=null,g=[],m.Tb=function(b){g.push(b),a.a.w.da(b,function(b){a.a.ua(g,b),g.length||(m.K(),e.I=m=p)})})},a.N.prototype.createChildContext=function(b,c,d){return new a.N(b,this,c,function(a,b){a.$parentContext=b,a.$parent=b.$data,a.$parents=(b.$parents||[]).slice(0),a.$parents.unshift(a.$parent),d&&d(a)})},a.N.prototype.extend=function(b){return new a.N(this.I||this.$data,this,null,function(c,d){c.$rawData=d.$rawData,a.a.extend(c,"function"==typeof b?b():b)})};var q=a.a.e.F(),n=a.a.e.F();a.Ob=function(b,c){return 2!=arguments.length?a.a.e.get(b,n):(a.a.e.set(b,n,c),void(c.I&&c.I.Tb(b)))},a.ra=function(b,c,d){return 1===b.nodeType&&a.f.Fb(b),f(b,c,m(d),!0)},a.Wb=function(d,f,e){return e=m(e),a.ra(d,"function"==typeof f?c(f.bind(null,e,d)):a.a.na(f,b),e)},a.Ca=function(a,b){1!==b.nodeType&&8!==b.nodeType||g(m(a),b,!0)},a.pb=function(a,b){if(!w&&s.jQuery&&(w=s.jQuery),b&&1!==b.nodeType&&8!==b.nodeType)throw Error("ko.applyBindings: first parameter should be your view model; second parameter should be a DOM node");b=b||s.document.body,h(m(a),b,!0)},a.Ha=function(b){switch(b.nodeType){case 1:case 8:var c=a.Ob(b);if(c)return c;if(b.parentNode)return a.Ha(b.parentNode)}return p},a.$b=function(b){return(b=a.Ha(b))?b.$data:p},a.b("bindingHandlers",a.d),a.b("applyBindings",a.pb),a.b("applyBindingsToDescendants",a.Ca),a.b("applyBindingAccessorsToNode",a.ra),a.b("applyBindingsToNode",a.Wb),a.b("contextFor",a.Ha),a.b("dataFor",a.$b)}(),function(b){function d(d,f){var e=g.hasOwnProperty(d)?g[d]:b,l;e||(e=g[d]=new a.P,c(d,function(a){h[d]=a,delete g[d],l?e.notifySubscribers(a):setTimeout(function(){e.notifySubscribers(a)},0)}),l=!0),e.U(f)}function c(a,b){e("getConfig",[a],function(c){c?e("loadComponent",[a,c],function(a){b(a)}):b(null)})}function e(c,d,g,l){l||(l=a.g.loaders.slice(0));var h=l.shift();if(h){var n=h[c];if(n){var t=!1;if(n.apply(h,d.concat(function(a){t?g(null):null!==a?g(a):e(c,d,g,l)}))!==b&&(t=!0,!h.suppressLoaderExceptions))throw Error("Component loaders must supply values by invoking the callback, not by returning values synchronously.")}else e(c,d,g,l)}else g(null)}var g={},h={};a.g={get:function(a,c){var e=h.hasOwnProperty(a)?h[a]:b;e?setTimeout(function(){c(e)},0):d(a,c)},tb:function(a){delete h[a]},jb:e},a.g.loaders=[],a.b("components",a.g),a.b("components.get",a.g.get),a.b("components.clearCachedDefinition",a.g.tb)}(),function(){function b(b,c,d,e){function k(){0===--u&&e(h)}var h={},u=2,r=d.template;d=d.viewModel,r?g(c,r,function(c){a.g.jb("loadTemplate",[b,c],function(a){h.template=a,k()})}):k(),d?g(c,d,function(c){a.g.jb("loadViewModel",[b,c],function(a){h[f]=a,k()})}):k()}function d(a,b,c){if("function"==typeof b)c(function(a){return new b(a)});else if("function"==typeof b[f])c(b[f]);else if("instance"in b){var e=b.instance;c(function(){return e})}else"viewModel"in b?d(a,b.viewModel,c):a("Unknown viewModel value: "+b)}function c(b){switch(a.a.t(b)){case"script":return a.a.ba(b.text);case"textarea":return a.a.ba(b.value);case"template":if(e(b.content))return a.a.ia(b.content.childNodes)}return a.a.ia(b.childNodes)}function e(a){return s.DocumentFragment?a instanceof DocumentFragment:a&&11===a.nodeType}function g(a,b,c){"string"==typeof b.require?N||s.require?(N||s.require)([b.require],c):a("Uses require, but no AMD loader is present"):c(b)}function h(a){return function(b){throw Error("Component '"+a+"': "+b)}}var k={};a.g.tc=function(b,c){if(!c)throw Error("Invalid configuration for "+b);if(a.g.Qa(b))throw Error("Component "+b+" is already registered");k[b]=c},a.g.Qa=function(a){return a in k},a.g.wc=function(b){delete k[b],a.g.tb(b)},a.g.ub={getConfig:function(a,b){b(k.hasOwnProperty(a)?k[a]:null)},loadComponent:function(a,c,d){var e=h(a);g(e,c,function(c){b(a,e,c,d)})},loadTemplate:function(b,d,f){if(b=h(b),"string"==typeof d)f(a.a.ba(d));else if(d instanceof Array)f(d);else if(e(d))f(a.a.S(d.childNodes));else if(d.element)if(d=d.element,s.HTMLElement?d instanceof HTMLElement:d&&d.tagName&&1===d.nodeType)f(c(d));else if("string"==typeof d){var k=v.getElementById(d);k?f(c(k)):b("Cannot find element with ID "+d)}else b("Unknown element type: "+d);else b("Unknown template value: "+d)},loadViewModel:function(a,b,c){d(h(a),b,c)}};var f="createViewModel";a.b("components.register",a.g.tc),a.b("components.isRegistered",a.g.Qa),a.b("components.unregister",a.g.wc),a.b("components.defaultLoader",a.g.ub),a.g.loaders.push(a.g.ub),a.g.Ub=k}(),function(){function b(b,e){var g=b.getAttribute("params");if(g){var g=d.parseBindingsString(g,e,b,{valueAccessors:!0,bindingParams:!0}),g=a.a.na(g,function(d){return a.s(d,null,{o:b})}),h=a.a.na(g,function(d){return d.Z()?a.s(function(){return a.a.c(d())},null,{o:b}):d.v()});return h.hasOwnProperty("$raw")||(h.$raw=g),h}return{$raw:{}}}a.g.getComponentNameForNode=function(b){return b=a.a.t(b),a.g.Qa(b)&&b},a.g.mb=function(c,d,g,h){if(1===d.nodeType){var k=a.g.getComponentNameForNode(d);if(k){if(c=c||{},c.component)throw Error('Cannot use the "component" binding on a custom element matching a component');var f={name:k,params:b(d,g)};c.component=h?function(){return f}:f}}return c};var d=new a.J;9>a.a.L&&(a.g.register=function(a){return function(b){return v.createElement(b),a.apply(this,arguments)}}(a.g.register),v.createDocumentFragment=function(b){return function(){var d=b(),g=a.g.Ub,h;for(h in g)g.hasOwnProperty(h)&&d.createElement(h);return d}}(v.createDocumentFragment))}(),function(){var b=0;a.d.component={init:function(d,c,e,g,h){function k(){var a=f&&f.dispose;"function"==typeof a&&a.call(f),m=null}var f,m;return a.a.w.da(d,k),a.s(function(){var e=a.a.c(c()),g,n;if("string"==typeof e?g=e:(g=a.a.c(e.name),n=a.a.c(e.params)),!g)throw Error("No component name specified");var t=m=++b;a.g.get(g,function(b){if(m===t){if(k(),!b)throw Error("Unknown component '"+g+"'");var c=b.template;if(!c)throw Error("Component '"+g+"' has no template");c=a.a.ia(c),a.f.T(d,c);var c=n,e=b.createViewModel;b=e?e.call(b,c,{element:d}):c,c=h.createChildContext(b),f=b,a.Ca(c,d)}})},null,{o:d}),{controlsDescendantBindings:!0}}},a.f.Q.component=!0}();var Q={"class":"className","for":"htmlFor"};a.d.attr={update:function(b,d){var c=a.a.c(d())||{};a.a.G(c,function(c,d){d=a.a.c(d);var h=!1===d||null===d||d===p;h&&b.removeAttribute(c),8>=a.a.L&&c in Q?(c=Q[c],h?b.removeAttribute(c):b[c]=d):h||b.setAttribute(c,d.toString()),"name"===c&&a.a.Mb(b,h?"":d.toString())})}},function(){a.d.checked={after:["value","attr"],init:function(b,d,c){function e(){var e=b.checked,k=q?h():e;if(!a.Y.ma()&&(!f||e)){var g=a.k.B(d);m?l!==k?(e&&(a.a.ea(g,k,!0),a.a.ea(g,l,!1)),l=k):a.a.ea(g,k,e):a.h.pa(g,c,"checked",k,!0)}}function g(){var c=a.a.c(d());b.checked=m?0<=a.a.m(c,h()):k?c:h()===c}var h=a.Ib(function(){return c.has("checkedValue")?a.a.c(c.get("checkedValue")):c.has("value")?a.a.c(c.get("value")):b.value}),k="checkbox"==b.type,f="radio"==b.type;if(k||f){var m=k&&a.a.c(d())instanceof Array,l=m?h():p,q=f||m;f&&!b.name&&a.d.uniqueName.init(b,function(){return!0}),a.s(e,null,{o:b}),a.a.n(b,"click",e),a.s(g,null,{o:b})}}},a.h.V.checked=!0,a.d.checkedValue={update:function(b,d){b.value=a.a.c(d())}}}(),a.d.css={update:function(b,d){var c=a.a.c(d());"object"==typeof c?a.a.G(c,function(c,d){d=a.a.c(d),a.a.Ba(b,c,d)}):(c=String(c||""),a.a.Ba(b,b.__ko__cssValue,!1),b.__ko__cssValue=c,a.a.Ba(b,c,!0))}},a.d.enable={update:function(b,d){var c=a.a.c(d());c&&b.disabled?b.removeAttribute("disabled"):c||b.disabled||(b.disabled=!0)}},a.d.disable={update:function(b,d){a.d.enable.update(b,function(){return!a.a.c(d())})}},a.d.event={init:function(b,d,c,e,g){var h=d()||{};a.a.G(h,function(k){"string"==typeof k&&a.a.n(b,k,function(b){var h,l=d()[k];if(l){try{var q=a.a.S(arguments);e=g.$data,q.unshift(e),h=l.apply(e,q)}finally{!0!==h&&(b.preventDefault?b.preventDefault():b.returnValue=!1)}!1===c.get(k+"Bubble")&&(b.cancelBubble=!0,b.stopPropagation&&b.stopPropagation())}})})}},a.d.foreach={Eb:function(b){return function(){var d=b(),c=a.a.Xa(d);return c&&"number"!=typeof c.length?(a.a.c(d),{foreach:c.data,as:c.as,includeDestroyed:c.includeDestroyed,afterAdd:c.afterAdd,beforeRemove:c.beforeRemove,afterRender:c.afterRender,beforeMove:c.beforeMove,afterMove:c.afterMove,templateEngine:a.O.Oa}):{foreach:d,templateEngine:a.O.Oa}}},init:function(b,d){return a.d.template.init(b,a.d.foreach.Eb(d))},update:function(b,d,c,e,g){return a.d.template.update(b,a.d.foreach.Eb(d),c,e,g)}},a.h.ha.foreach=!1,a.f.Q.foreach=!0,a.d.hasfocus={init:function(b,d,c){function e(e){b.__ko_hasfocusUpdating=!0;var f=b.ownerDocument;if("activeElement"in f){var g;try{g=f.activeElement}catch(h){g=f.body}e=g===b}f=d(),a.h.pa(f,c,"hasfocus",e,!0),b.__ko_hasfocusLastValue=e,b.__ko_hasfocusUpdating=!1}var g=e.bind(null,!0),h=e.bind(null,!1);a.a.n(b,"focus",g),a.a.n(b,"focusin",g),a.a.n(b,"blur",h),a.a.n(b,"focusout",h)},update:function(b,d){var c=!!a.a.c(d());b.__ko_hasfocusUpdating||b.__ko_hasfocusLastValue===c||(c?b.focus():b.blur(),a.k.B(a.a.oa,null,[b,c?"focusin":"focusout"]))}},a.h.V.hasfocus=!0,a.d.hasFocus=a.d.hasfocus,a.h.V.hasFocus=!0,a.d.html={init:function(){return{controlsDescendantBindings:!0}},update:function(b,d){a.a.$a(b,d())}},I("if"),I("ifnot",!1,!0),I("with",!0,!1,function(a,d){return a.createChildContext(d)});var K={};a.d.options={init:function(b){if("select"!==a.a.t(b))throw Error("options binding applies only to SELECT elements");for(;0<b.length;)b.remove(0);return{controlsDescendantBindings:!0}},update:function(b,d,c){function e(){return a.a.ta(b.options,function(a){return a.selected})}function g(a,b,c){var d=typeof b;return"function"==d?b(a):"string"==d?a[b]:c}function h(c,d){if(q.length){var e=0<=a.a.m(q,a.i.q(d[0]));a.a.Nb(d[0],e),n&&!e&&a.k.B(a.a.oa,null,[b,"change"])}}var k=0!=b.length&&b.multiple?b.scrollTop:null,f=a.a.c(d()),m=c.get("optionsIncludeDestroyed");d={};var l,q;q=b.multiple?a.a.Da(e(),a.i.q):0<=b.selectedIndex?[a.i.q(b.options[b.selectedIndex])]:[],f&&("undefined"==typeof f.length&&(f=[f]),l=a.a.ta(f,function(b){return m||b===p||null===b||!a.a.c(b._destroy)}),c.has("optionsCaption")&&(f=a.a.c(c.get("optionsCaption")),null!==f&&f!==p&&l.unshift(K)));var n=!1;d.beforeRemove=function(a){b.removeChild(a)},f=h,c.has("optionsAfterRender")&&(f=function(b,d){h(0,d),a.k.B(c.get("optionsAfterRender"),null,[d[0],b!==K?b:p])}),a.a.Za(b,l,function(d,e,f){return f.length&&(q=f[0].selected?[a.i.q(f[0])]:[],n=!0),e=b.ownerDocument.createElement("option"),d===K?(a.a.bb(e,c.get("optionsCaption")),a.i.ca(e,p)):(f=g(d,c.get("optionsValue"),d),a.i.ca(e,a.a.c(f)),d=g(d,c.get("optionsText"),f),a.a.bb(e,d)),[e]},d,f),a.k.B(function(){c.get("valueAllowUnset")&&c.has("value")?a.i.ca(b,a.a.c(c.get("value")),!0):(b.multiple?q.length&&e().length<q.length:q.length&&0<=b.selectedIndex?a.i.q(b.options[b.selectedIndex])!==q[0]:q.length||0<=b.selectedIndex)&&a.a.oa(b,"change")}),a.a.dc(b),k&&20<Math.abs(k-b.scrollTop)&&(b.scrollTop=k)}},a.d.options.Va=a.a.e.F(),a.d.selectedOptions={after:["options","foreach"],init:function(b,d,c){a.a.n(b,"change",function(){var e=d(),g=[];a.a.u(b.getElementsByTagName("option"),function(b){b.selected&&g.push(a.i.q(b))}),a.h.pa(e,c,"selectedOptions",g)})},update:function(b,d){if("select"!=a.a.t(b))throw Error("values binding applies only to SELECT elements");var c=a.a.c(d());c&&"number"==typeof c.length&&a.a.u(b.getElementsByTagName("option"),function(b){var d=0<=a.a.m(c,a.i.q(b));a.a.Nb(b,d)})}},a.h.V.selectedOptions=!0,a.d.style={update:function(b,d){var c=a.a.c(d()||{});a.a.G(c,function(c,d){d=a.a.c(d),(null===d||d===p||!1===d)&&(d=""),b.style[c]=d})}},a.d.submit={init:function(b,d,c,e,g){if("function"!=typeof d())throw Error("The value for a submit binding must be a function");a.a.n(b,"submit",function(a){var c,e=d();try{c=e.call(g.$data,b)}finally{!0!==c&&(a.preventDefault?a.preventDefault():a.returnValue=!1)}})}},a.d.text={init:function(){return{controlsDescendantBindings:!0}},update:function(b,d){a.a.bb(b,d())}},a.f.Q.text=!0,function(){if(s&&s.navigator)var b=function(a){return a?parseFloat(a[1]):void 0},d=s.opera&&s.opera.version&&parseInt(s.opera.version()),c=s.navigator.userAgent,e=b(c.match(/^(?:(?!chrome).)*version\/([^ ]*) safari/i)),g=b(c.match(/Firefox\/([^ ]*)/));if(10>a.a.L)var h=a.a.e.F(),k=a.a.e.F(),f=function(b){var c=this.activeElement;(c=c&&a.a.e.get(c,k))&&c(b)},m=function(b,c){var d=b.ownerDocument;a.a.e.get(d,h)||(a.a.e.set(d,h,!0),a.a.n(d,"selectionchange",f)),a.a.e.set(b,k,c)};a.d.textInput={init:function(b,c,f){function k(c,d){a.a.n(b,c,d)}function h(){var d=a.a.c(c());(null===d||d===p)&&(d=""),v!==p&&d===v?setTimeout(h,4):b.value!==d&&(s=d,b.value=d)}function u(){y||(v=b.value,y=setTimeout(r,4))}function r(){clearTimeout(y),v=y=p;var d=b.value;s!==d&&(s=d,a.h.pa(c(),f,"textInput",d))}var s=b.value,y,v;10>a.a.L?(k("propertychange",function(a){"value"===a.propertyName&&r()}),8==a.a.L&&(k("keyup",r),k("keydown",r)),8<=a.a.L&&(m(b,r),k("dragend",u))):(k("input",r),5>e&&"textarea"===a.a.t(b)?(k("keydown",u),k("paste",u),k("cut",u)):11>d?k("keydown",u):4>g&&(k("DOMAutoComplete",r),k("dragdrop",r),k("drop",r))),k("change",r),a.s(h,null,{o:b})}},a.h.V.textInput=!0,a.d.textinput={preprocess:function(a,b,c){c("textInput",a)}}}(),a.d.uniqueName={init:function(b,d){if(d()){var c="ko_unique_"+ ++a.d.uniqueName.Zb;a.a.Mb(b,c)}}},a.d.uniqueName.Zb=0,a.d.value={after:["options","foreach"],init:function(b,d,c){if("input"!=b.tagName.toLowerCase()||"checkbox"!=b.type&&"radio"!=b.type){var e=["change"],g=c.get("valueUpdate"),h=!1,k=null;g&&("string"==typeof g&&(g=[g]),a.a.ga(e,g),e=a.a.rb(e));var f=function(){k=null,h=!1;var e=d(),f=a.i.q(b);a.h.pa(e,c,"value",f)};!a.a.L||"input"!=b.tagName.toLowerCase()||"text"!=b.type||"off"==b.autocomplete||b.form&&"off"==b.form.autocomplete||-1!=a.a.m(e,"propertychange")||(a.a.n(b,"propertychange",function(){h=!0}),a.a.n(b,"focus",function(){h=!1}),a.a.n(b,"blur",function(){h&&f()})),a.a.u(e,function(c){var d=f;a.a.vc(c,"after")&&(d=function(){k=a.i.q(b),setTimeout(f,0)},c=c.substring(5)),a.a.n(b,c,d)});var m=function(){var e=a.a.c(d()),f=a.i.q(b);if(null!==k&&e===k)setTimeout(m,0);else if(e!==f)if("select"===a.a.t(b)){var g=c.get("valueAllowUnset"),f=function(){a.i.ca(b,e,g)};f(),g||e===a.i.q(b)?setTimeout(f,0):a.k.B(a.a.oa,null,[b,"change"])}else a.i.ca(b,e)};a.s(m,null,{o:b})}else a.ra(b,{checkedValue:d})},update:function(){}},a.h.V.value=!0,a.d.visible={update:function(b,d){var c=a.a.c(d()),e="none"!=b.style.display;c&&!e?b.style.display="":!c&&e&&(b.style.display="none")}},function(b){a.d[b]={init:function(d,c,e,g,h){return a.d.event.init.call(this,d,function(){var a={};return a[b]=c(),a},e,g,h)}}}("click"),a.H=function(){},a.H.prototype.renderTemplateSource=function(){throw Error("Override renderTemplateSource")},a.H.prototype.createJavaScriptEvaluatorBlock=function(){throw Error("Override createJavaScriptEvaluatorBlock")},a.H.prototype.makeTemplateSource=function(b,d){if("string"==typeof b){d=d||v;var c=d.getElementById(b);if(!c)throw Error("Cannot find template with ID "+b);return new a.r.l(c)}if(1==b.nodeType||8==b.nodeType)return new a.r.fa(b);throw Error("Unknown template type: "+b)},a.H.prototype.renderTemplate=function(a,d,c,e){return a=this.makeTemplateSource(a,e),this.renderTemplateSource(a,d,c)},a.H.prototype.isTemplateRewritten=function(a,d){return!1===this.allowTemplateRewriting?!0:this.makeTemplateSource(a,d).data("isRewritten")},a.H.prototype.rewriteTemplate=function(a,d,c){a=this.makeTemplateSource(a,c),d=d(a.text()),a.text(d),a.data("isRewritten",!0)},a.b("templateEngine",a.H),a.fb=function(){function b(b,c,d,k){b=a.h.Wa(b);for(var f=a.h.ha,m=0;m<b.length;m++){var l=b[m].key;if(f.hasOwnProperty(l)){var q=f[l];if("function"==typeof q){if(l=q(b[m].value))throw Error(l)}else if(!q)throw Error("This template engine does not support the '"+l+"' binding within its templates")}}return d="ko.__tr_ambtns(function($context,$element){return(function(){return{ "+a.h.ya(b,{valueAccessors:!0})+" } })()},'"+d.toLowerCase()+"')",k.createJavaScriptEvaluatorBlock(d)+c}var d=/(<([a-z]+\d*)(?:\s+(?!data-bind\s*=\s*)[a-z0-9\-]+(?:=(?:\"[^\"]*\"|\'[^\']*\'))?)*\s+)data-bind\s*=\s*(["'])([\s\S]*?)\3/gi,c=/\x3c!--\s*ko\b\s*([\s\S]*?)\s*--\x3e/g;return{ec:function(b,c,d){c.isTemplateRewritten(b,d)||c.rewriteTemplate(b,function(b){return a.fb.nc(b,c)},d)},nc:function(a,g){return a.replace(d,function(a,c,d,e,l){return b(l,c,d,g)}).replace(c,function(a,c){return b(c,"<!-- ko -->","#comment",g)})},Xb:function(b,c){return a.D.Ua(function(d,k){var f=d.nextSibling;f&&f.nodeName.toLowerCase()===c&&a.ra(f,b,k)})}}}(),a.b("__tr_ambtns",a.fb.Xb),function(){a.r={},a.r.l=function(a){this.l=a},a.r.l.prototype.text=function(){var b=a.a.t(this.l),b="script"===b?"text":"textarea"===b?"value":"innerHTML";if(0==arguments.length)return this.l[b];var d=arguments[0];"innerHTML"===b?a.a.$a(this.l,d):this.l[b]=d};var b=a.a.e.F()+"_";a.r.l.prototype.data=function(c){return 1===arguments.length?a.a.e.get(this.l,b+c):void a.a.e.set(this.l,b+c,arguments[1])};var d=a.a.e.F();a.r.fa=function(a){this.l=a},a.r.fa.prototype=new a.r.l,a.r.fa.prototype.text=function(){if(0==arguments.length){var b=a.a.e.get(this.l,d)||{};return b.gb===p&&b.Ga&&(b.gb=b.Ga.innerHTML),b.gb}a.a.e.set(this.l,d,{gb:arguments[0]})},a.r.l.prototype.nodes=function(){return 0==arguments.length?(a.a.e.get(this.l,d)||{}).Ga:void a.a.e.set(this.l,d,{Ga:arguments[0]})},a.b("templateSources",a.r),a.b("templateSources.domElement",a.r.l),a.b("templateSources.anonymousTemplate",a.r.fa)}(),function(){function b(b,c,d){var e;for(c=a.f.nextSibling(c);b&&(e=b)!==c;)b=a.f.nextSibling(e),d(e,b)}function d(c,d){if(c.length){var e=c[0],g=c[c.length-1],h=e.parentNode,n=a.J.instance,t=n.preprocessNode;if(t){if(b(e,g,function(a,b){var c=a.previousSibling,d=t.call(n,a);d&&(a===e&&(e=d[0]||b),a===g&&(g=d[d.length-1]||c))}),c.length=0,!e)return;e===g?c.push(e):(c.push(e,g),a.a.ka(c,h))}b(e,g,function(b){1!==b.nodeType&&8!==b.nodeType||a.pb(d,b)}),b(e,g,function(b){1!==b.nodeType&&8!==b.nodeType||a.D.Sb(b,[d])}),a.a.ka(c,h)}}function c(a){return a.nodeType?a:0<a.length?a[0]:null}function e(b,e,h,l,q){q=q||{};var n=b&&c(b),n=n&&n.ownerDocument,t=q.templateEngine||g;if(a.fb.ec(h,t,n),h=t.renderTemplate(h,l,q,n),"number"!=typeof h.length||0<h.length&&"number"!=typeof h[0].nodeType)throw Error("Template engine must return an array of DOM nodes");switch(n=!1,e){case"replaceChildren":a.f.T(b,h),n=!0;break;case"replaceNode":a.a.Lb(b,h),n=!0;break;case"ignoreTargetNode":break;default:throw Error("Unknown renderMode: "+e)}return n&&(d(h,l),q.afterRender&&a.k.B(q.afterRender,null,[h,l.$data])),h}var g;a.ab=function(b){if(b!=p&&!(b instanceof a.H))throw Error("templateEngine must inherit from ko.templateEngine");g=b},a.Ya=function(b,d,h,l,q){if(h=h||{},(h.templateEngine||g)==p)throw Error("Set a template engine before calling renderTemplate");if(q=q||"replaceChildren",l){var n=c(l);return a.j(function(){var g=d&&d instanceof a.N?d:new a.N(a.a.c(d)),p=a.C(b)?b():"function"==typeof b?b(g.$data,g):b,g=e(l,q,p,g,h);"replaceNode"==q&&(l=g,n=c(l))},null,{Ia:function(){return!n||!a.a.Ja(n)},o:n&&"replaceNode"==q?n.parentNode:n})}return a.D.Ua(function(c){a.Ya(b,d,h,c,"replaceNode")})},a.uc=function(b,c,g,h,q){function n(a,b){d(b,s),g.afterRender&&g.afterRender(b,a)}function t(c,d){s=q.createChildContext(c,g.as,function(a){a.$index=d});var f=a.C(b)?b():"function"==typeof b?b(c,s):b;return e(null,"ignoreTargetNode",f,s,g)}var s;return a.j(function(){var b=a.a.c(c)||[];"undefined"==typeof b.length&&(b=[b]),b=a.a.ta(b,function(b){return g.includeDestroyed||b===p||null===b||!a.a.c(b._destroy)}),a.k.B(a.a.Za,null,[h,b,t,g,n])},null,{o:h})};var h=a.a.e.F();a.d.template={init:function(b,c){var d=a.a.c(c());return"string"==typeof d||d.name?a.f.ja(b):(d=a.f.childNodes(b),d=a.a.oc(d),new a.r.fa(b).nodes(d)),{controlsDescendantBindings:!0}},update:function(b,c,d,e,g){var n=c(),t;c=a.a.c(n),d=!0,e=null,"string"==typeof c?c={}:(n=c.name,"if"in c&&(d=a.a.c(c["if"])),d&&"ifnot"in c&&(d=!a.a.c(c.ifnot)),t=a.a.c(c.data)),"foreach"in c?e=a.uc(n||b,d&&c.foreach||[],c,b,g):d?(g="data"in c?g.createChildContext(t,c.as):g,e=a.Ya(n||b,g,c,b)):a.f.ja(b),g=e,(t=a.a.e.get(b,h))&&"function"==typeof t.K&&t.K(),a.a.e.set(b,h,g&&g.Z()?g:p)}},a.h.ha.template=function(b){return b=a.h.Wa(b),1==b.length&&b[0].unknown||a.h.lc(b,"name")?null:"This template engine does not support anonymous templates nested within its templates"},a.f.Q.template=!0}(),a.b("setTemplateEngine",a.ab),a.b("renderTemplate",a.Ya),a.a.wb=function(a,d,c){if(a.length&&d.length){var e,g,h,k,f;for(e=g=0;(!c||c>e)&&(k=a[g]);++g){for(h=0;f=d[h];++h)if(k.value===f.value){k.moved=f.index,f.moved=k.index,d.splice(h,1),e=h=0;break}e+=h}}},a.a.Fa=function(){function b(b,c,e,g,h){var k=Math.min,f=Math.max,m=[],l,q=b.length,n,p=c.length,s=p-q||1,u=q+p+1,r,v,w;for(l=0;q>=l;l++)for(v=r,m.push(r=[]),w=k(p,l+s),n=f(0,l-1);w>=n;n++)r[n]=n?l?b[l-1]===c[n-1]?v[n-1]:k(v[n]||u,r[n-1]||u)+1:n+1:l+1;for(k=[],f=[],s=[],l=q,n=p;l||n;)p=m[l][n]-1,n&&p===m[l][n-1]?f.push(k[k.length]={status:e,value:c[--n],index:n}):l&&p===m[l-1][n]?s.push(k[k.length]={status:g,value:b[--l],index:l}):(--n,--l,h.sparse||k.push({status:"retained",value:c[n]}));return a.a.wb(f,s,10*q),k.reverse()}return function(a,c,e){return e="boolean"==typeof e?{dontLimitMoves:e}:e||{},a=a||[],c=c||[],a.length<=c.length?b(a,c,"added","deleted",e):b(c,a,"deleted","added",e)}}(),a.b("utils.compareArrays",a.a.Fa),function(){function b(b,d,g,h,k){var f=[],m=a.j(function(){var l=d(g,k,a.a.ka(f,b))||[];0<f.length&&(a.a.Lb(f,l),h&&a.k.B(h,null,[g,l,k])),f.length=0,a.a.ga(f,l)},null,{o:b,Ia:function(){return!a.a.ob(f)}});return{$:f,j:m.Z()?m:p}}var d=a.a.e.F();a.a.Za=function(c,e,g,h,k){function f(b,d){x=q[d],r!==d&&(A[b]=x),x.Na(r++),a.a.ka(x.$,c),s.push(x),w.push(x)}function m(b,c){if(b)for(var d=0,e=c.length;e>d;d++)c[d]&&a.a.u(c[d].$,function(a){b(a,d,c[d].sa)})}e=e||[],h=h||{};var l=a.a.e.get(c,d)===p,q=a.a.e.get(c,d)||[],n=a.a.Da(q,function(a){return a.sa}),t=a.a.Fa(n,e,h.dontLimitMoves),s=[],u=0,r=0,v=[],w=[];e=[];for(var A=[],n=[],x,B=0,D,F;D=t[B];B++)switch(F=D.moved,D.status){case"deleted":F===p&&(x=q[u],x.j&&x.j.K(),v.push.apply(v,a.a.ka(x.$,c)),h.beforeRemove&&(e[B]=x,w.push(x))),u++;break;case"retained":f(B,u++);break;case"added":F!==p?f(B,F):(x={sa:D.value,Na:a.p(r++)},s.push(x),w.push(x),l||(n[B]=x))}m(h.beforeMove,A),a.a.u(v,h.beforeRemove?a.R:a.removeNode);for(var B=0,l=a.f.firstChild(c),G;x=w[B];B++){for(x.$||a.a.extend(x,b(c,g,x.sa,k,x.Na)),u=0;t=x.$[u];l=t.nextSibling,G=t,u++)t!==l&&a.f.Bb(c,t,G);!x.ic&&k&&(k(x.sa,x.$,x.Na),x.ic=!0)}m(h.beforeRemove,e),m(h.afterMove,A),m(h.afterAdd,n),a.a.e.set(c,d,s)}}(),a.b("utils.setDomNodeChildrenFromArrayMapping",a.a.Za),a.O=function(){this.allowTemplateRewriting=!1},a.O.prototype=new a.H,a.O.prototype.renderTemplateSource=function(b){var d=(9>a.a.L?0:b.nodes)?b.nodes():null;return d?a.a.S(d.cloneNode(!0).childNodes):(b=b.text(),a.a.ba(b))},a.O.Oa=new a.O,a.ab(a.O.Oa),a.b("nativeTemplateEngine",a.O),function(){a.Sa=function(){var a=this.kc=function(){if(!w||!w.tmpl)return 0;try{if(0<=w.tmpl.tag.tmpl.open.toString().indexOf("__"))return 2}catch(a){}return 1}();this.renderTemplateSource=function(b,e,g){if(g=g||{},2>a)throw Error("Your version of jQuery.tmpl is too old. Please upgrade to jQuery.tmpl 1.0.0pre or later.");var h=b.data("precompiled");return h||(h=b.text()||"",h=w.template(null,"{{ko_with $item.koBindingContext}}"+h+"{{/ko_with}}"),b.data("precompiled",h)),b=[e.$data],e=w.extend({koBindingContext:e},g.templateOptions),e=w.tmpl(h,b,e),e.appendTo(v.createElement("div")),w.fragments={},e},this.createJavaScriptEvaluatorBlock=function(a){return"{{ko_code ((function() { return "+a+" })()) }}"},this.addTemplate=function(a,b){v.write("<script type='text/html' id='"+a+"'>"+b+"</script>")},a>0&&(w.tmpl.tag.ko_code={open:"__.push($1 || '');"},w.tmpl.tag.ko_with={open:"with($1) {",close:"} "})},a.Sa.prototype=new a.H;var b=new a.Sa;0<b.kc&&a.ab(b),a.b("jqueryTmplTemplateEngine",a.Sa)}()})}()}(),define("util",[],function(){function setURLPart(part,str){part===URLPart.Search?window.location.search=str:part===URLPart.Hash&&(window.location.hash=str)}function getStringForPart(part){return part===URLPart.Search?window.location.search:part===URLPart.Hash?window.location.hash:void 0}function getURLPartForParam(param){return URLParamMap[param]}function _replyThen(impl){return function(success,failure,context){}}function _replyExecute(impl){return function(success,failure,context){}}function dummyStorageGetFn(){}var self={};window.URLPart={Search:1,Hash:2};var URLParamMap={demo:URLPart.Hash,login:URLPart.Hash,user:URLPart.Hash,premium:URLPart.Hash,access_token:URLPart.Hash,error:URLPart.Hash,expires_in:URLPart.Hash,expires_at:URLPart.Hash,issued_at:URLPart.Hash,scope:URLPart.Hash,token_type:URLPart.Hash,id_token:URLPart.Hash,data:URLPart.Hash,script:URLPart.Hash,dmode:URLPart.Hash,jasmine:URLPart.Hash,touch:URLPart.Hash,noverify:URLPart.Hash,file:URLPart.Hash,sinfo:URLPart.Hash,panes:URLPart.Hash,offline:URLPart.Hash,live:URLPart.Hash,test:URLPart.Hash,nolocal:URLPart.Hash,nosync:URLPart.Hash,rdebug:URLPart.Hash,rsession:URLPart.Hash,cacheError:URLPart.Hash,versionError:URLPart.Hash,invite:URLPart.Hash,state:URLPart.Search};
self.hasURLParam=function hasURLParamFn(key,value){var str=key+"=";value&&(str+=value);var part=getURLPartForParam(key);part||log("Invalid URL Part");var rawString=getStringForPart(part);return rawString.indexOf(str)>=0},self.getURLParam=function getURLParamFn(key,forcePart){var part=forcePart?forcePart:getURLPartForParam(key);if(part===URLPart.Search){key=key.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+key+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(window.location.href);return null===results?void 0:decodeURIComponent(results[1].replace(/\+/g," "))}if(part===URLPart.Hash){for(var queryString=window.location.hash.substring(1),regex=/([^&=]+)=([^&]*)/g,m;m=regex.exec(queryString);)if(decodeURIComponent(m[1])===key)return decodeURIComponent(m[2]);return void 0}log("Invalid URL part")},self.insertURLParam=function insertURLParamFn(key,value,noReload){key=encodeURIComponent(key),value=encodeURIComponent(value);for(var part=getURLPartForParam(key),rawString=getStringForPart(part),params=rawString.substr(1).split("&"),i=params.length-1;i>=0;i--){var param=params[i].split("=");if(param[0]==key){param[1]=value,params[i]=param.join("=");break}}0>i&&(params[params.length]=[key,value].join("=")),setURLPart(part,params.join("&")),part!==URLPart.Hash||noReload||window.location.reload()},self.removeURLParam=function removeURLParamFn(key,noReload){key=encodeURIComponent(key);for(var part=getURLPartForParam(key),rawString=getStringForPart(part),params=rawString.substr(1).split("&"),i=params.length-1;i>=0;i--){var param=params[i].split("=");if(param[0]==key){params.splice(i,1);break}}setURLPart(part,params.join("&")),part!==URLPart.Hash||noReload||window.location.reload()};var __bindMap;self.forceBind=function forceBindFn(fnName,obj){var hasEntry,bindFn=obj[fnName].bind(obj);return obj[fnName]=bindFn,bindFn},self.destroy=function destroyFn(obj){},self.extend=function extendFn(target,source){if(source)for(var prop in source)source.hasOwnProperty(prop)&&(target[prop]=source[prop]);return target},self.inherit=function inheritFn(base,sub){sub.prototype=Object.create(base.prototype),sub.prototype.constructor=sub,sub.prototype._super=base.prototype},self.defineBase=function defineBaseFn(base){base.prototype.constructor=base},self.genPromise=function genPromiseFn(impl){impl.then=_replyThen(impl),impl.execute=_replyExecute(impl)};var dummyStorage={getItem:function(){},setItem:function(){},removeItem:function(){},clear:function(){}};try{self.__storage=window.localStorage||dummyStorage}catch(err){self.__storage=dummyStorage}return self.storage={getItem:(self.__storage.getItem||function(key,cb){return this.get(key,cb||dummyStorageGetFn)}).bind(self.__storage),setItem:(self.__storage.setItem||function(key,value){var obj={};obj[key]=value,this.set(obj)}).bind(self.__storage),removeItem:(self.__storage.removeItem||function(key,cb){this.remove(key,cb)}).bind(self.__storage),clear:(self.__storage.clear||function(cb){this.clear(cb)}).bind(self.__storage)},self}),define("Listener",[],function(){var Listener=function(target,cb){this.target=target,this.cb=cb};return Listener.prototype={dispose:function disposeFn(){this.target.unlisten(this.cb)}},Listener}),define("Trigger",["globals","Listener"],function(g,Listener){var Trigger=function(onUpdate){this._listeners=[],this._enabled=!0,onUpdate&&this._listeners.push(onUpdate)};return Trigger.prototype={listen:function listenFn(cb){return this._addListener(cb),new Listener(this,cb)},_addListener:function _addListenerFn(cb){this._listeners.push(cb)},_hasListener:function _hasListenerFn(cb){return this._listeners.indexOf(cb)>=0},unlisten:function unlistenFn(cb){this._listeners.remove(cb)},enable:function enableFn(){this._enabled=!0},disable:function disableFn(){this._enabled=!1},notify:function notifyFn(){if(this._enabled)for(var i=0;i<this._listeners.length;++i)arguments.length>0?this._listeners[i](arguments[0]):this._listeners[i]()}},Trigger}),define("Constants",[],function(){var Constants={EmailOpenTime:250,EmailPreviewSizeMin:400,EmailPreviewSizeMax:800,GmailPaneMaxWidth:400,EmailOpenTimeMobile:150,OverviewWidth:240,OverviewItemHeight:32,RightMenuWidth:50,TrialDuration:14,PaneSpaceSize:10,MSPerHour:36e5,MaxBatchSize:45,TooltipDelay:400,MobileOverviewWidth:.85,MobileBottomHeight:44,RootItemName:"Outline",SettingsSections:{Plugins:"plugins",Account:"account",Early:"early",Linked:"linked",Invite:"invite"},ItemAnimationMode:{None:0,Normal:1,Move:2,Search:3},MatchState:{Unknown:void 0,No:0,Yes:1,Negated:2,ChildYes:3},EmailResponseMode:{None:0,Reply:1,ReplyAll:2,Forward:3},PluginType:{Unknown:0,Storage:1,Calendar:2,Email:3},SyncResult:{Success:0,FailureOAuth:1,FailureNoWrite:2,FailureNoRead:3,FailureNetwork:4,FailureUnknown:5},Primary:{No:0,Yes:1,Either:2,Both:3,Never:4},Shift:{No:0,Yes:1,Either:2},FavoriteGroup:{EmailRoot:1},DropEffect:{Copy:"copy",Move:"move"},HoveredID:{Plugin:"plugin",Collapser:"collapser",Checkbox:"checkbox",Bullet:"bullet"},AgendaViewMode:{All:"All",Day:"Day",Week:"Week"},HTTPStatusCode:{Network:0,Success:200,Created:201,PermRedirect:308,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,Conflict:409,Gone:410},PluginAction:{Gmail:{Archive:1,Unarchive:2,Trash:3,Untrash:4,AddLabel:5,RemoveLabel:6,Star:7,Unstar:8,MarkRead:9,MarkUnread:10,SetPriority:11,Move:12,Snooze:13,ScheduleSend:14,DiscardDraft:15}},HelpMode:{None:0,Normal:1,Intro:2,Hotkeys:3},Pricing:{None:-1,EarlyMonthly:0,EarlyYearly:1,RegMonthly:2,RegYearly:3},LoginFlags:{None:0,NewUser:1,OldUserNewTrial:2,TrialOver:4},Analytics:{Dimensions:{PremiumStatus:"dimension1"}},Feature:{ClonePane:"clonePane"},GmailSortType:{TimeReceived:"Time",Priority:"Priority"},MaxGmailSyncTime:{Premium:30,Free:2},MessageListVisibility:{Hide:"hide",Show:"show"},LabelListVisibility:{Hide:"labelHide",Show:"labelShow",ShowIfUnread:"labelShowIfUnread"},GoogleError:{FailedPrecondition:"failedPrecondition",InsufficientPermissions:"insufficientPermissions"},KeyboardToolbarMode:{Item:0,Search:1,Modal:2},TopBarMode:{Normal:"Normal",Multiselect:"Selected",Contact:"Contacts",Date:"Date",Tag:"Tag",Note:"Note"}};return Constants}),define("platform",["ko","util","Trigger","Constants"],function(ko,util,Trigger,C){function platform(){this.versionRequired=[],this.versionAvailable=[],this.versionRequired[AppPlatform.iOS]=4,this.versionAvailable[AppPlatform.iOS]=5,this.versionRequired[AppPlatform.Android]=4,this.versionAvailable[AppPlatform.Android]=5,this.versionRequired[AppPlatform.WinPhone]=1,this.versionAvailable[AppPlatform.WinPhone]=1,this.versionRequired[AppPlatform.Chrome]=1,this.versionAvailable[AppPlatform.Chrome]=1,this.versionRequired[AppPlatform.Electron]=1,this.versionAvailable[AppPlatform.Electron]=1,this.versionMobile=2,this.versionDesktop=7,this.versionMobileMessages={2:"Design update: Switch panes in the bottom bar, swipe items, search filters, and more! See the blog for full changes."},this.versionDesktopMessages={},this.appSubVersion=void 0,this.setDeployEnvironments(),this.appStoreLinks=[],this.appStoreLinks[AppPlatform.iOS]="https://itunes.apple.com/us/app/moo.do-organize-your-way/id889830074?ls=1&mt=8",this.appStoreLinks[AppPlatform.Android]="https://play.google.com/store/apps/details?id=moo.do",this.appStoreLinks[AppPlatform.WinPhone]=void 0,this.appStoreLinks[AppPlatform.Chrome]="https://chrome.google.com/webstore/detail/moodo/iffimmolghilclfndeiebgppddmagofk",this.appStoreLinks[AppPlatform.Electron]=void 0,this.appReviewLinks=[],this.appReviewLinks[AppPlatform.iOS]=void 0,this.appReviewLinks[AppPlatform.Android]=void 0,this.appReviewLinks[AppPlatform.WinPhone]=void 0,this.appReviewLinks[AppPlatform.Chrome]=void 0,this.appReviewLinks[AppPlatform.Electron]=void 0,this.appPlatform=void 0,this.appStoreLink=void 0,this.appReviewLink=void 0,this.requireCustomRedirect=!1,this.b=document.documentElement,this.orientation=Orientation.Portrait,this.windowWidth=ko.observable(document.body?document.body.clientWidth:0),this.windowHeight=ko.observable(document.body?document.body.clientHeight:0),this.onResize=new Trigger,this.kbsize=void 0,this.kbsizePortrait=void 0,this.kbsizeLandscape=void 0,this.hasBeenPortrait=!1,this.appState=void 0,this.isHosted=!1,this.hostedBy=void 0,this.pageVisibilityHidden=void 0,this.pageVisibilityChange=void 0,this.isPhantom=!1,this.isDevURL="dev.moo.do"===window.location.hostname||"beta.moo.do"===window.location.hostname,this._features={},this.init(),this.app&&(this.customRedirectState={app:!0,appv:this.appv,webview:this.getAppState("webview")}),this.keyboardOpenTime=this.app||this.android?200:this.winphone?200:this.mobileie?600:0}return window.Orientation={Portrait:0,Landscape:1},window.PlatformConfig={DesktopWindows:0,DesktopMac:1,DesktopOther:2,ChromeApp:3,AndroidBrowser:4,AndroidApp:5,iOSBrowser:6,iOSApp:7,WinPhoneBrowser:8,WinPhoneApp:9,MobileOther:10,Unknown:11,EmbedDesktopApp:12,EmbedMobileApp:13,ElectronMac:14,ElectronWindows:15},window.AppPlatform={iOS:0,Android:1,WinPhone:2,Chrome:3,Embed:4,Electron:5},window.EmbedApps={Mailbird:"mailbird"},window.DeployVariable={Environment:"Environment",APIHost:"APIHost",APIProtocol:"APIProtocol"},platform.prototype={getDeployVar:function getDeployVarFn(key){return this.deployEnvironment[key]},setDeployEnvironments:function setDeployEnvironmentsFn(){this.deployEnvironment={},"dev.moo.do"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="dev",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api-dev.moo.do"):"beta.moo.do"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="beta",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api-beta.moo.do"):"localhost"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="local",this.deployEnvironment[DeployVariable.APIProtocol]="http:",this.deployEnvironment[DeployVariable.APIHost]="//localhost:9024"):(this.deployEnvironment[DeployVariable.Environment]="production",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api.moo.do")},getKBSize:function getKBSizeFn(){return!this.app&&this.android?0:this.kbsize?this.kbsize:Math.ceil(window.innerHeight/2)},setKBSize:function setKBSizeFn(size){this.kbsize=parseInt(size)},getLocaleInfo:function getLocaleInfoFn(obj){try{obj.lang=navigator.language||navigator.userLanguage}catch(err){obj.lang="EXCEPTION"}},getPlatformInfo:function getPlatformInfoFn(obj){obj.os=this.OSName,obj.browser=this.browser,obj.majorVersion=this.majorVersion,obj.minorVersion=this.minorVersion,obj.appVersionRequired=this.versionRequired[this.appPlatform],obj.app=this.app,obj.appPlatform=this.appPlatform,obj.standalone=this.standalone,obj.packagedApp=this.packagedApp,obj.requireCustomRedirect=this.requireCustomRedirect,obj.isMobile=this.mobile,obj.isMobileBrowser=this.isMobileBrowser,obj.isPhone=this.phone,obj.isTouch=this.touch,obj.isTouchDevice=this.isTouchDevice,obj.usePointerEvents=this.usePointerEvents,obj.kbsize=this.kbsize,obj.appState=this.appState,obj.isHosted=this.isHosted,obj.hostedBy=this.hostedBy,obj.embed=this.embed,obj.bodyClass=this.b.className,obj.rawUA=navigator.userAgent,obj.referrer=document.referrer,obj.devicePixelRatio=window.devicePixelRatio,obj.pageVisibilityChange=!!this.pageVisibilityChange,obj.appSubVersion=this.appSubVersion,this.getLocaleInfo(obj)},getUserPlatformConfig:function getUserPlatformConfigFn(obj){var pConfig=PlatformConfig.Unknown;if(this.app)switch(this.appPlatform){case AppPlatform.iOS:pConfig=PlatformConfig.iOSApp;break;case AppPlatform.Android:pConfig=PlatformConfig.AndroidApp;break;case AppPlatform.WinPhone:pConfig=PlatformConfig.WinPhoneApp;break;case AppPlatform.Chrome:pConfig=PlatformConfig.ChromeApp;break;case AppPlatform.Electron:pConfig="Windows"===this.OSName?PlatformConfig.ElectronWindows:PlatformConfig.ElectronMac;break;case AppPlatform.Embed:pConfig=this.mobile?PlatformConfig.EmbedMobileApp:PlatformConfig.EmbedDesktopApp}else switch(this.OSName){case"Windows":pConfig=this.phone?PlatformConfig.WinPhoneBrowser:PlatformConfig.DesktopWindows;break;case"iPad":case"iPod":case"iPhone":pConfig=PlatformConfig.iOSBrowser;break;case"MacOS":pConfig=PlatformConfig.DesktopMac;break;case"Android":pConfig=PlatformConfig.AndroidBrowser;break;case"Linux":default:pConfig=this.phone?PlatformConfig.MobileOther:PlatformConfig.DesktopOther}obj.platformConfig=pConfig},init:function initFn(){this.initAppState(),this.initHostState(),this.initFeatures();var userAgent=navigator.userAgent,bodyClass="";if(this.OSName="Unknown OS",this.app&&(bodyClass+=" app"),-1!==userAgent.indexOf("Win")?(this.OSName="Windows",this.windows=!0,-1!==userAgent.indexOf("Windows Phone")&&(this.phone=!0,this.touch=!0,this.mobile=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.WinPhone],this.app&&(this.appPlatform=AppPlatform.WinPhone))):-1!==userAgent.indexOf("iPad")?(this.OSName="iPad",this.ios=!0,this.ipad=!0,this.phone=!0,this.touch=!0,this.mobile=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("iPhone")?(this.OSName="iPhone",this.ios=!0,this.iphone=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("iPod")?(this.OSName="iPod",this.ios=!0,this.ipod=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==userAgent.indexOf("Mac")?(this.OSName="MacOS",this.mac=!0):-1!==userAgent.indexOf("X11")?(this.OSName="UNIX",this.unix=!0):-1!==userAgent.indexOf("Android")?(this.OSName="Android",this.android=!0,this.touch=!0,this.mobile=!0,this.phone=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.Android],this.app&&(this.appPlatform=AppPlatform.Android),bodyClass+=" android"):-1!==userAgent.indexOf("Linux")&&(this.OSName="Linux",this.linux=!0),this.ios){this.ios7=-1!==userAgent.indexOf("OS 7"),this.ios70=-1!==userAgent.indexOf("OS 7_0"),this.ios71=-1!==userAgent.indexOf("OS 7_1");var webview=this.appState&&this.appState.webview;"ioswk"===webview?this.ioswk=!0:this.iosui=!0,this.ios7&&(bodyClass+=" ios7")}if(this.majorVersion=1e3,this.minorVersion=1e3,-1!==userAgent.indexOf("MSIE")||-1!==userAgent.indexOf("Trident")){this.browser="Trident",this.ie=!0,this.winphone=!!userAgent.match(/IEMobile/i);var re;if(re=new RegExp(this.winphone||"Microsoft Internet Explorer"===navigator.appName?"MSIE ([0-9]{1,}[.0-9]{0,})":"Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),null!==re.exec(userAgent))this.majorVersion=parseFloat(RegExp.$1);else{var take2=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})");null!==take2.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}}else if(-1!==userAgent.indexOf("Chrome")||-1!==userAgent.indexOf("CriOS")){this.browser="Chrome",this.isChrome=!0;var re=new RegExp("Chrome/([0-9]{1,}).");null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1)),-1!==userAgent.indexOf("Edge")&&(this.ieEdge=!0),this.app&&this.appPlatform!==AppPlatform.Android&&(this.appPlatform=AppPlatform.Chrome)}else if(-1!==userAgent.indexOf("Android")){this.browser="Native Android";var re=new RegExp("Linux; Android ([0-9]{1,}).([0-9]{1,}).");null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else if(-1!==userAgent.indexOf("Firefox")){this.browser="Firefox",this.isFirefox=!0;var re=new RegExp("Firefox/([0-9]{1,}).");null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1))}else if(-1!==userAgent.indexOf("Safari")||"iPad"===this.OSName||"iPhone"===this.OSName||"iPod"===this.OSName){this.browser="Safari",this.safari=!0;var re;re=new RegExp(this.mobile?"OS ([0-9]{1,})_([0-9]{1,})":"Version/([0-9]{1,}).([0-9]{1,})."),null!==re.exec(userAgent)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else-1!==userAgent.indexOf("Opera")&&(this.browser="Opera");this.appState&&"electron"===this.appState.appType&&(this.appPlatform=AppPlatform.Electron,bodyClass+=" electron"),this.appReviewLink=this.appReviewLinks[this.appPlatform],this.isTouchDevice=!!("ontouchstart"in window||window.navigator.msMaxTouchPoints),this.isMobileBrowser=this.checkMobileBrowser(),this.usePointerEvents=!!window.navigator.msPointerEnabled,this.isTouchDevice&&this.isMobileBrowser&&(this.usePointerEvents?(this.touchStartEvent="MSPointerDown",this.touchMoveEvent="MSPointerMove",this.touchEndEvent="MSPointerUp",this.touchCancelEvent="MSPointerCancel"):(this.touchStartEvent="touchstart",this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",this.touchCancelEvent="touchcancel")),this.usePointerEvents?(this.downEvent="MSPointerDown",this.moveEvent="MSPointerMove",this.upEvent="MSPointerUp"):(this.downEvent="mousedown",this.moveEvent="mousemove",this.upEvent="mouseup"),util.hasURLParam("touch","false")?(this.touch=!1,this.phone=!1,this.mobile=!1,this.ios=!1,this.android=!1):(this.isTouchDevice&&this.isMobileBrowser||util.hasURLParam("touch","true"))&&(this.touch=!0,this.phone=!0,this.mobile=!0),this.windows&&(bodyClass+=" windows",this.ie&&(bodyClass+=" ie",this.demo||(this.mobro=this.isMobro()))),"Firefox"===this.browser&&(bodyClass+=" firefox",require(["globals"],function(g){g.runOnLoad(function(){setTimeout(function(){try{document.queryCommandEnabled("enableObjectResizing")&&document.execCommand("enableObjectResizing",!1,"false")}catch(err){g.reportError(err)}},500)})})),this.safari&&(bodyClass+=" safari"),this.phone&&(bodyClass+=" phone"),this.ipad&&(bodyClass+=" ipad"),this.embed===EmbedApps.Mailbird&&(bodyClass+=" mailbird"),this.demo&&(bodyClass+=" demoMode"),this.mobileie=this.ie&&this.mobile,this.mobile&&!this.app&&this.calcKeyboardSize(),this.isChrome&&this.app&&(this.isPackagedApp=!0),this.cmdChar=this.mac?"⌘":"ctrl",this.priModKey=this.mac?"⌘":"Ctrl",this.secModKeyForce=this.mac?"Ctrl":"Alt",this.secModKey=this.app?this.priModKey:this.secModKeyForce,this.noErrorStacks="iPad"===platform.OSName||"iPhone"===platform.OSName||"iPod"===platform.OSName,this.standalone=!!window.navigator.standalone||window.navigator.userAgent.indexOf("FluidApp")>=0,(this.standalone||this.app||this.mobro)&&(this.requireCustomRedirect=!0),bodyClass&&bodyClass.length>0&&(this.b.className+=bodyClass),this.URL=window.URL||window.webkitURL,this.transition=this.addPrefix("transition"),this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin","transform-origin"),this.userSelect=this.addPrefix("userSelect","user-select"),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(callback){return window.setTimeout(callback,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(id){clearTimeout(id)},this.ie&&(document.documentElement.addEventListener("MSHoldVisual",function(e){e.preventDefault()},!1),document.documentElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1)),document.documentElement.addEventListener("keydown",this.normalizeKeys,!0),document.documentElement.addEventListener("keypress",this.normalizeKeys,!0),document.documentElement.addEventListener("keyup",this.normalizeKeys,!0),document.documentElement.addEventListener(this.downEvent,this.normalizeMouse,!0),document.documentElement.addEventListener(this.moveEvent,this.normalizeMouse,!0),document.documentElement.addEventListener(this.upEvent,this.normalizeMouse,!0);var hidden,visibilitychange;"undefined"!=typeof document.hidden?(hidden="hidden",visibilitychange="visibilitychange"):["moz","ms","webkit"].forEach(function(v){return"undefined"!==document[v+"Hidden"]?(hidden=v+"Hidden",visibilitychange=v+"visibilitychange",!1):void 0}),void 0!==hidden&&(this.pageVisibilityHidden=hidden,this.pageVisibilityChange=visibilitychange),this.initRedirectString()},supportsNotifications:function supportsNotificationsFn(){var doesSupport=!1;return this.app?(this.ios||this.android||this.isChrome)&&(doesSupport=!0):this.embed===EmbedApps.Mailbird&&(doesSupport=!0),doesSupport},supportsHTML5Notifications:function supportsHTML5NotificationsFn(){return this.appPlatform===AppPlatform.Electron},supportsWebworkers:function supportsWebworkersFn(){var doesSupport=!1;return window.Worker&&(doesSupport=!0),doesSupport},supportsIDBWebworkers:function supportsIDBWebworkersFn(){var doesSupport=!1;if(this.supportsWebworkers())switch(this.browser){case"Firefox":doesSupport=this.majorVersion>=37;break;case"Chrome":doesSupport=this.majorVersion>=24}return doesSupport},isMobro:function isMobroFn(){var supported=null,errorName;try{new ActiveXObject("")}catch(e){errorName=e.name}try{supported=!!new ActiveXObject("htmlfile")}catch(e){supported=!1}return supported="ReferenceError"!==errorName&&supported===!1?!1:!0,!supported},calcKeyboardSize:function calcKeyboardSizeFn(){this.ios?this.iphone||this.ipod?(this.kbsizePortrait=216,this.kbsizeLandscape=162,this.ios71&&(this.kbsizePortrait+=44,this.kbsizeLandscape+=44)):this.ipad&&(this.kbsizePortrait=264,this.kbsizeLandscape=352,this.kbsizePortrait+=44,this.kbsizeLandscape+=44):this.android?(this.kbsizePortrait=Math.ceil(window.innerHeight/2.5),this.kbsizeLandscape=Math.ceil(window.innerWidth/2)):this.mobileie&&(this.kbsizePortrait=226,this.kbsizeLandscape=200)},normalizeKeys:function normalizeKeysFn(ev){void 0!==ev.normCode&&(ev.synthetic||ev instanceof KeyboardEvent)||(ev.normCode=null===ev.keyCode||0===ev.keyCode?null!==ev.charCode?ev.charCode:ev.which:ev.keyCode,46===ev.normCode&&"keypress"===ev.type&&(ev.normCode=190))},normalizeMouse:function normalizeMouseFn(ev){ev.hasOwnProperty("srcElement")||(ev.srcElement=ev.target)},initAppState:function initAppStateFn(){var appState=location.hash.substring(1);if(appState)for(var regex=/([^&=]+)=([^&]*)/g,m;null!==(m=regex.exec(appState));)if("state"===decodeURIComponent(m[1])){var uri=decodeURIComponent(m[2]);if(uri){try{appState=JSON.parse(uri)}catch(err){log("Error parsing AppState: ",uri),appState=void 0}appState&&(this.app=appState.app===!0,this.appv=appState.appv,this.debugApp=appState.debug,this.live=appState.live,this.offline=appState.offline,this.syncContacts=appState.syncContacts,this.test=appState.test,this.embed=appState.embed,this.appState=appState)}break}this.live=this.live||util.hasURLParam("live","true"),this.test=!1,this.offline=this.offline||this.test||util.hasURLParam("offline","true")||!1,this.demo=util.hasURLParam("demo","true")||!1,this.script=util.hasURLParam("script")},getAppState:function getAppStateFn(field){return this.appState?this.appState[field]:void 0},_enableFeature:function _enableFeatureFn(feature){this._features[feature]=!0},_disableFeature:function _disableFeatureFn(feature){this._features[feature]=!1},initFeatures:function initFeaturesFn(){this._enableFeature(C.Feature.ClonePane),this.embed===EmbedApps.Mailbird&&"true"===this.getAppState("sidebar")&&this._disableFeature(C.Feature.ClonePane)},checkMobileBrowser:function checkMobileBrowserFn(){var check=!1;if(this.android&&this.app)check=!0;else if(!this.embed&&(function(a){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))&&(check=!0)}(navigator.userAgent||navigator.vendor||window.opera),!check)){var mediaQuery="(max-device-width: 620px)";window.matchMedia&&window.matchMedia(mediaQuery).matches&&(check=!0)}return check},initHostState:function initHostStateFn(){try{this.isHosted=window.self!==window.top}catch(e){this.isHosted=!0}this.isHosted&&(this.hostedBy=document.referrer)},initRedirectString:function initRedirectStringFn(){var useLocationHost=!1||this.isDevURL||this.app&&this.debugApp||!this.app&&this.standalone,host,loc;host=useLocationHost?window.location.host:"www.moo.do",loc=this.app&&this.appPlatform===AppPlatform.Chrome?"oauthRelay.html":"app/",this.customRedirectString=window.location.protocol+"//"+host+"/"+loc},addPrefix:function addPrefixFn(p,dashed){var prefix="",v=["ms","webkit","moz","o"],s=this.b.style;if(dashed||(dashed=p),"string"==typeof s[p])prefix="";else for(var i=0;i<v.length;i++)if("string"==typeof s["-"+v[i]+"-"+dashed]){prefix=v[i];break}var styleString=prefix.length>0?p.charAt(0).toUpperCase()+p.slice(1):p;if(prefix){var reactPrefix=prefix.length>0?prefix.charAt(0).toUpperCase()+prefix.slice(1):p;return{prop:"-"+prefix+"-"+dashed,style:prefix+styleString,react:reactPrefix+styleString}}return{prop:p,style:styleString,react:styleString}},blockClient:function blockClientFn(){switch(this.browser){case"Firefox":if(this.majorVersion<16)return{platform:"Firefox",browser:this.browser,update:!0};break;case"Chrome":if(this.majorVersion<26)return{platform:"Chrome",browser:this.browser,update:!0};break;case"Native Android":if(this.majorVersion<4)return{platform:"Native Android",browser:"NativeAndroid",update:!0};break;case"Opera":return{platform:this.browser,browser:this.browser,update:!1};case"Trident":if(this.majorVersion<10)return{platform:"Internet Explorer",browser:this.browser,update:!0};break;case"Safari":if(this.mobile&&this.majorVersion<6)return{platform:"Safari",browser:this.browser,update:!0};if(!this.mobile&&(6===this.majorVersion&&this.minorVersion<1||this.majorVersion<6))return{platform:"Safari",browser:this.browser,update:!0}}if(this.app){if(this.appv<this.versionRequired[this.appPlatform])return log("App Version out of date."),{version:this.versionRequired[this.appPlatform]};if(this.appv>this.versionAvailable[this.appPlatform])return log("App is newer than the javascript, forcing an app cache update: "+this.appv+" vs. "+this.versionAvailable[this.appPlatform]),{cacheUpdate:!0,error:!1}}if("1475571972531"!==document.body.getAttribute("ver")){var cErr=util.hasURLParam("cacheError");if(require(["globals"],function(g){g.reportError(new Error("VersionMismatch, CacheError: "+cErr)),!cErr&&this.app&&g.nativeBridge.sendToApp("resetCache")}.bind(this)),!cErr)return{cacheUpdate:!0,error:!0}}},actionVerb:function actionVerbFn(){return this.touch?"tap":"click"},actionVerbCaps:function actionVerbCapsFn(){return this.touch?"Tap":"Click"},updateOrientation:function updateOrientationFn(){var orientation=90===Math.abs(window.orientation)?Orientation.Landscape:Orientation.Portrait;return this.orientation===Orientation.Portrait&&(this.hasBeenPortrait=!0),this.orientation=orientation,this.app||(this.kbsize=this.orientation===Orientation.Portrait?this.kbsizePortrait:this.kbsizeLandscape),this.orientation},isPageVisible:function isPageVisibleFn(){return!this.pageVisibilityHidden||!document[this.pageVisibilityHidden]},getUpdateMessages:function getUpdateMessagesFn(prevVersion){for(var ret=[],versionName=this.mobile?"versionMobile":"versionDesktop",i=(prevVersion||0)+1;i<=this[versionName];i++){var m=this[versionName+"Messages"][i];m&&ret.push(m)}return ret},isFeatureEnabled:function isFeatureEnabledFn(feature){return this._features[feature]},emailPreviewSize:function emailPreviewSizeFn(){return Math.max(Math.min(C.EmailPreviewSizeMax,this.windowWidth()-C.GmailPaneMaxWidth),C.EmailPreviewSizeMin)},recordAppSubVersion:function recordAppSubVersionFn(version){this.appSubVersion=version}},new platform}),define("RingBuffer",["require","exports","module"],function(require,exports,module){function RingBuffer(limit){this._limit=limit,this._offset=0,this._buffer=[]}return RingBuffer.prototype={get:function getFn(i){return this._buffer[i]},push:function pushFn(data){this._buffer[this._offset]=data,this._offset=(this._limit+this._offset+1)%this._limit},peek:function peekFn(){var lastValueOffset=(this._limit+this._offset-1)%this._limit;return this._buffer[lastValueOffset]},pop:function popFn(){var lastValueOffset=(this._limit+this._offset-1)%this._limit,lastValue=this._buffer[lastValueOffset];return lastValue&&(this._buffer[lastValueOffset]=void 0,this._offset=lastValueOffset),lastValue},hasData:function hasDataFn(){return!!this.peek()},reset:function resetFn(){this._offset=0,this._buffer=[]},buffer:function bufferFn(){return this._buffer},limit:function limitFn(limit){this._limit=limit},ordered:function orderedFn(){return this._buffer.slice(this._offset).concat(this._buffer.slice(0,this._offset))},entries:function entriesFn(){for(var arr=this.ordered(),i=0;i<arr.length;++i)console.log("---- Entry ["+i+"] ----"),console.log(arr[i])}},RingBuffer}),function(window,document,Math){function IScroll(el,options){this.wrapper="string"==typeof el?document.querySelector(el):el,this.scroller=this.wrapper.children[0],this.scrollerStyle=this.scroller.style,this.options={resizeScrollbars:!0,mouseWheelSpeed:20,snapThreshold:.334,startX:0,startY:0,scrollY:!0,directionLockThreshold:5,momentum:!0,bounce:!0,bounceTime:600,bounceEasing:"",preventDefault:!0,preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT)$/},HWCompositing:!0,useTransition:!0,useTransform:!0};for(var i in options)this.options[i]=options[i];this.translateZ=this.options.HWCompositing&&utils.hasPerspective?" translateZ(0)":"",this.options.useTransition=utils.hasTransition&&this.options.useTransition,this.options.useTransform=utils.hasTransform&&this.options.useTransform,this.options.eventPassthrough=this.options.eventPassthrough===!0?"vertical":this.options.eventPassthrough,this.options.preventDefault=!this.options.eventPassthrough&&this.options.preventDefault,this.options.scrollY="vertical"==this.options.eventPassthrough?!1:this.options.scrollY,this.options.scrollX="horizontal"==this.options.eventPassthrough?!1:this.options.scrollX,this.options.freeScroll=this.options.freeScroll&&!this.options.eventPassthrough,this.options.directionLockThreshold=this.options.eventPassthrough?0:this.options.directionLockThreshold,this.options.bounceEasing="string"==typeof this.options.bounceEasing?utils.ease[this.options.bounceEasing]||utils.ease.circular:this.options.bounceEasing,this.options.resizePolling=void 0===this.options.resizePolling?60:this.options.resizePolling,this.options.tap===!0&&(this.options.tap="tap"),"scale"==this.options.shrinkScrollbars&&(this.options.useTransition=!1),this.options.invertWheelDirection=this.options.invertWheelDirection?-1:1,3==this.options.probeType&&(this.options.useTransition=!1),this.x=0,this.y=0,this.directionX=0,this.directionY=0,this._events={},this._init(),this.refresh(),this.scrollTo(this.options.startX,this.options.startY),this.enable()
}function createDefaultScrollbar(direction,interactive,type){var scrollbar=document.createElement("div"),indicator=document.createElement("div");return type===!0&&(scrollbar.style.cssText="position:absolute;z-index:9999",indicator.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:absolute;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);border-radius:3px"),indicator.className="iScrollIndicator","h"==direction?(type===!0&&(scrollbar.style.cssText+=";height:7px;left:2px;right:2px;bottom:0",indicator.style.height="100%"),scrollbar.className="iScrollHorizontalScrollbar"):(type===!0&&(scrollbar.style.cssText+=";width:7px;bottom:2px;top:2px;right:1px",indicator.style.width="100%"),scrollbar.className="iScrollVerticalScrollbar"),scrollbar.style.cssText+=";overflow:hidden",interactive||(scrollbar.style.pointerEvents="none"),scrollbar.appendChild(indicator),scrollbar}function Indicator(scroller,options){this.wrapper="string"==typeof options.el?document.querySelector(options.el):options.el,this.wrapperStyle=this.wrapper.style,this.indicator=this.wrapper.children[0],this.indicatorStyle=this.indicator.style,this.scroller=scroller,this.options={listenX:!0,listenY:!0,interactive:!1,resize:!0,defaultScrollbars:!1,shrink:!1,fade:!1,speedRatioX:0,speedRatioY:0};for(var i in options)this.options[i]=options[i];this.sizeRatioX=1,this.sizeRatioY=1,this.maxPosX=0,this.maxPosY=0,this.options.interactive&&(this.options.disableTouch||(utils.addEvent(this.indicator,"touchstart",this),utils.addEvent(window,"touchend",this)),this.options.disablePointer||(utils.addEvent(this.indicator,utils.prefixPointerEvent("pointerdown"),this),utils.addEvent(window,utils.prefixPointerEvent("pointerup"),this)),this.options.disableMouse||(utils.addEvent(this.indicator,"mousedown",this),utils.addEvent(window,"mouseup",this))),this.options.fade&&(this.wrapperStyle[utils.style.transform]=this.scroller.translateZ,this.wrapperStyle[utils.style.transitionDuration]=utils.isBadAndroid?"0.001s":"0ms",this.wrapperStyle.opacity="0")}var rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)},utils=function(){function _prefixStyle(style){return _vendor===!1?!1:""===_vendor?style:_vendor+style.charAt(0).toUpperCase()+style.substr(1)}var me={},_elementStyle=document.createElement("div").style,_vendor=function(){for(var vendors=["t","webkitT","MozT","msT","OT"],transform,i=0,l=vendors.length;l>i;i++)if(transform=vendors[i]+"ransform",transform in _elementStyle)return vendors[i].substr(0,vendors[i].length-1);return!1}();me.getTime=Date.now||function getTime(){return(new Date).getTime()},me.extend=function(target,obj){for(var i in obj)target[i]=obj[i]},me.addEvent=function(el,type,fn,capture){el.addEventListener(type,fn,!!capture)},me.removeEvent=function(el,type,fn,capture){el.removeEventListener(type,fn,!!capture)},me.prefixPointerEvent=function(pointerEvent){return window.MSPointerEvent?"MSPointer"+pointerEvent.charAt(9).toUpperCase()+pointerEvent.substr(10):pointerEvent},me.momentum=function(current,start,time,lowerMargin,wrapperSize,deceleration){var distance=current-start,speed=Math.abs(distance)/time,destination,duration;return deceleration=void 0===deceleration?6e-4:deceleration,destination=current+speed*speed/(2*deceleration)*(0>distance?-1:1),duration=speed/deceleration,lowerMargin>destination?(destination=wrapperSize?lowerMargin-wrapperSize/2.5*(speed/8):lowerMargin,distance=Math.abs(destination-current),duration=distance/speed):destination>0&&(destination=wrapperSize?wrapperSize/2.5*(speed/8):0,distance=Math.abs(current)+destination,duration=distance/speed),{destination:Math.round(destination),duration:duration}};var _transform=_prefixStyle("transform");return me.extend(me,{hasTransform:_transform!==!1,hasPerspective:_prefixStyle("perspective")in _elementStyle,hasTouch:"ontouchstart"in window,hasPointer:window.PointerEvent||window.MSPointerEvent,hasTransition:_prefixStyle("transition")in _elementStyle}),me.isBadAndroid=/Android /.test(window.navigator.appVersion)&&!/Chrome\/\d/.test(window.navigator.appVersion),me.extend(me.style={},{transform:_transform,transitionTimingFunction:_prefixStyle("transitionTimingFunction"),transitionDuration:_prefixStyle("transitionDuration"),transitionDelay:_prefixStyle("transitionDelay"),transformOrigin:_prefixStyle("transformOrigin")}),me.hasClass=function(e,c){var re=new RegExp("(^|\\s)"+c+"(\\s|$)");return re.test(e.className)},me.addClass=function(e,c){if(!me.hasClass(e,c)){var newclass=e.className.split(" ");newclass.push(c),e.className=newclass.join(" ")}},me.removeClass=function(e,c){if(me.hasClass(e,c)){var re=new RegExp("(^|\\s)"+c+"(\\s|$)","g");e.className=e.className.replace(re," ")}},me.offset=function(el){for(var left=-el.offsetLeft,top=-el.offsetTop;el=el.offsetParent;)left-=el.offsetLeft,top-=el.offsetTop;return{left:left,top:top}},me.preventDefaultException=function(el,exceptions){for(var i in exceptions)if(exceptions[i].test(el[i]))return!0;return!1},me.extend(me.eventType={},{touchstart:1,touchmove:1,touchend:1,mousedown:2,mousemove:2,mouseup:2,pointerdown:3,pointermove:3,pointerup:3,MSPointerDown:3,MSPointerMove:3,MSPointerUp:3}),me.extend(me.ease={},{quadratic:{style:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",fn:function(k){return k*(2-k)}},circular:{style:"cubic-bezier(0.1, 0.57, 0.1, 1)",fn:function(k){return Math.sqrt(1- --k*k)}},back:{style:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",fn:function(k){var b=4;return(k-=1)*k*((b+1)*k+b)+1}},bounce:{style:"",fn:function(k){return(k/=1)<1/2.75?7.5625*k*k:2/2.75>k?7.5625*(k-=1.5/2.75)*k+.75:2.5/2.75>k?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375}},elastic:{style:"",fn:function(k){var f=.22,e=.4;return 0===k?0:1==k?1:e*Math.pow(2,-10*k)*Math.sin(2*(k-f/4)*Math.PI/f)+1}}}),me.tap=function(e,eventName){var ev=document.createEvent("Event");ev.initEvent(eventName,!0,!0),ev.pageX=e.pageX,ev.pageY=e.pageY,e.target.dispatchEvent(ev)},me.click=function(e){var target=e.target,ev;/(SELECT|INPUT|TEXTAREA)/i.test(target.tagName)||(ev=document.createEvent("MouseEvents"),ev.initMouseEvent("click",!0,!0,e.view,1,target.screenX,target.screenY,target.clientX,target.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null),ev._constructed=!0,target.dispatchEvent(ev))},me}();IScroll.prototype={version:"5.1.3",_init:function(){this._initEvents(),(this.options.scrollbars||this.options.indicators)&&this._initIndicators(),this.options.mouseWheel&&this._initWheel(),this.options.snap&&this._initSnap(),this.options.keyBindings&&this._initKeys()},destroy:function(){this._initEvents(!0),this._execEvent("destroy")},_transitionEnd:function(e){e.target==this.scroller&&this.isInTransition&&(this._transitionTime(),this.resetPosition(this.options.bounceTime)||(this.isInTransition=!1,this._execEvent("scrollEnd")))},_start:function(e){if(!(1!=utils.eventType[e.type]&&0!==e.button||!this.enabled||this.initiated&&utils.eventType[e.type]!==this.initiated)){!this.options.preventDefault||utils.isBadAndroid||utils.preventDefaultException(e.target,this.options.preventDefaultException)||e.preventDefault();var point=e.touches?e.touches[0]:e,pos;this.initiated=utils.eventType[e.type],this.moved=!1,this.distX=0,this.distY=0,this.directionX=0,this.directionY=0,this.directionLocked=0,this._transitionTime(),this.startTime=utils.getTime(),this.options.useTransition&&this.isInTransition?(this.isInTransition=!1,pos=this.getComputedPosition(),this._translate(Math.round(pos.x),Math.round(pos.y)),this._execEvent("scrollEnd")):!this.options.useTransition&&this.isAnimating&&(this.isAnimating=!1,this._execEvent("scrollEnd")),this.startX=this.x,this.startY=this.y,this.absStartX=this.x,this.absStartY=this.y,this.pointX=point.pageX,this.pointY=point.pageY,this._execEvent("beforeScrollStart")}},_move:function(e){if(this.enabled&&utils.eventType[e.type]===this.initiated){this.options.preventDefault&&e.preventDefault();var point=e.touches?e.touches[0]:e,deltaX=point.pageX-this.pointX,deltaY=point.pageY-this.pointY,timestamp=utils.getTime(),newX,newY,absDistX,absDistY;if(this.pointX=point.pageX,this.pointY=point.pageY,this.distX+=deltaX,this.distY+=deltaY,absDistX=Math.abs(this.distX),absDistY=Math.abs(this.distY),!(timestamp-this.endTime>300&&10>absDistX&&10>absDistY)){if(this.directionLocked||this.options.freeScroll||(this.directionLocked=absDistX>absDistY+this.options.directionLockThreshold?"h":absDistY>=absDistX+this.options.directionLockThreshold?"v":"n"),"h"==this.directionLocked){if("vertical"==this.options.eventPassthrough)e.preventDefault();else if("horizontal"==this.options.eventPassthrough)return void(this.initiated=!1);deltaY=0}else if("v"==this.directionLocked){if("horizontal"==this.options.eventPassthrough)e.preventDefault();else if("vertical"==this.options.eventPassthrough)return void(this.initiated=!1);deltaX=0}deltaX=this.hasHorizontalScroll?deltaX:0,deltaY=this.hasVerticalScroll?deltaY:0,newX=this.x+deltaX,newY=this.y+deltaY,(newX>0||newX<this.maxScrollX)&&(newX=this.options.bounce?this.x+deltaX/3:newX>0?0:this.maxScrollX),(newY>0||newY<this.maxScrollY)&&(newY=this.options.bounce?this.y+deltaY/3:newY>0?0:this.maxScrollY),this.directionX=deltaX>0?-1:0>deltaX?1:0,this.directionY=deltaY>0?-1:0>deltaY?1:0,this.moved||this._execEvent("scrollStart"),this.moved=!0,this._translate(newX,newY),timestamp-this.startTime>300&&(this.startTime=timestamp,this.startX=this.x,this.startY=this.y,1==this.options.probeType&&this._execEvent("scroll")),this.options.probeType>1&&this._execEvent("scroll")}}},_end:function(e){if(this.enabled&&utils.eventType[e.type]===this.initiated){this.options.preventDefault&&!utils.preventDefaultException(e.target,this.options.preventDefaultException)&&e.preventDefault();var point=e.changedTouches?e.changedTouches[0]:e,momentumX,momentumY,duration=utils.getTime()-this.startTime,newX=Math.round(this.x),newY=Math.round(this.y),distanceX=Math.abs(newX-this.startX),distanceY=Math.abs(newY-this.startY),time=0,easing="";if(this.isInTransition=0,this.initiated=0,this.endTime=utils.getTime(),!this.resetPosition(this.options.bounceTime)){if(this.scrollTo(newX,newY),!this.moved)return this.options.tap&&utils.tap(e,this.options.tap),this.options.click&&utils.click(e),void this._execEvent("scrollCancel");if(this._events.flick&&200>duration&&100>distanceX&&100>distanceY)return void this._execEvent("flick");if(this.options.momentum&&300>duration&&(momentumX=this.hasHorizontalScroll?utils.momentum(this.x,this.startX,duration,this.maxScrollX,this.options.bounce?this.wrapperWidth:0,this.options.deceleration):{destination:newX,duration:0},momentumY=this.hasVerticalScroll?utils.momentum(this.y,this.startY,duration,this.maxScrollY,this.options.bounce?this.wrapperHeight:0,this.options.deceleration):{destination:newY,duration:0},newX=momentumX.destination,newY=momentumY.destination,time=Math.max(momentumX.duration,momentumY.duration),this.isInTransition=1),this.options.snap){var snap=this._nearestSnap(newX,newY);this.currentPage=snap,time=this.options.snapSpeed||Math.max(Math.max(Math.min(Math.abs(newX-snap.x),1e3),Math.min(Math.abs(newY-snap.y),1e3)),300),newX=snap.x,newY=snap.y,this.directionX=0,this.directionY=0,easing=this.options.bounceEasing}return newX!=this.x||newY!=this.y?((newX>0||newX<this.maxScrollX||newY>0||newY<this.maxScrollY)&&(easing=utils.ease.quadratic),void this.scrollTo(newX,newY,time,easing)):void this._execEvent("scrollEnd")}}},resetPosition:function(time){var x=this.x,y=this.y;return time=time||0,!this.hasHorizontalScroll||this.x>0?x=0:this.x<this.maxScrollX&&(x=this.maxScrollX),!this.hasVerticalScroll||this.y>0?y=0:this.y<this.maxScrollY&&(y=this.maxScrollY),x==this.x&&y==this.y?!1:(this.scrollTo(x,y,time,this.options.bounceEasing),!0)},disable:function(){this.enabled=!1},enable:function(){this.enabled=!0},refresh:function(){var rf=this.wrapper.offsetHeight;this.wrapperWidth=this.wrapper.clientWidth,this.wrapperHeight=this.wrapper.clientHeight,this.scrollerWidth=this.scroller.offsetWidth,this.scrollerHeight=this.scroller.offsetHeight,this.maxScrollX=this.wrapperWidth-this.scrollerWidth,this.maxScrollY=this.wrapperHeight-this.scrollerHeight,this.hasHorizontalScroll=this.options.scrollX&&this.maxScrollX<0,this.hasVerticalScroll=this.options.scrollY&&this.maxScrollY<0,this.hasHorizontalScroll||(this.maxScrollX=0,this.scrollerWidth=this.wrapperWidth),this.hasVerticalScroll||(this.maxScrollY=0,this.scrollerHeight=this.wrapperHeight),this.endTime=0,this.directionX=0,this.directionY=0,this.wrapperOffset=utils.offset(this.wrapper),this._execEvent("refresh"),this.resetPosition()},manualRefresh:function(forceHeight){var rf=this.wrapper.offsetHeight;this.wrapperWidth=this.wrapper.clientWidth,this.wrapperHeight=this.wrapper.clientHeight,this.scrollerWidth=this.wrapperWidth,this.scrollerHeight=forceHeight,this.maxScrollX=this.wrapperWidth-this.scrollerWidth,this.maxScrollY=this.wrapperHeight-this.scrollerHeight,this.hasHorizontalScroll=this.options.scrollX&&this.maxScrollX<0,this.hasVerticalScroll=this.options.scrollY&&this.maxScrollY<0,this.hasHorizontalScroll||(this.maxScrollX=0,this.scrollerWidth=this.wrapperWidth),this.hasVerticalScroll||(this.maxScrollY=0,this.scrollerHeight=this.wrapperHeight),this.endTime=0,this.directionX=0,this.directionY=0,this.wrapperOffset=utils.offset(this.wrapper),this._execEvent("refresh"),this.resetPosition()},on:function(type,fn){this._events[type]||(this._events[type]=[]),this._events[type].push(fn)},off:function(type,fn){if(this._events[type]){var index=this._events[type].indexOf(fn);index>-1&&this._events[type].splice(index,1)}},_execEvent:function(type){if(this._events[type]){var i=0,l=this._events[type].length;if(l)for(;l>i;i++)this._events[type][i].apply(this,[].slice.call(arguments,1))}},scrollBy:function(x,y,time,easing){x=this.x+x,y=this.y+y,time=time||0,this.scrollTo(x,y,time,easing)},scrollTo:function(x,y,time,easing){easing=easing||utils.ease.circular,this.isInTransition=this.options.useTransition&&time>0,!time||this.options.useTransition&&easing.style?(this._transitionTimingFunction(easing.style),this._transitionTime(time),this._translate(x,y)):this._animate(x,y,time,easing.fn)},scrollToElement:function(el,time,offsetX,offsetY,easing){if(el=el.nodeType?el:this.scroller.querySelector(el)){var pos=utils.offset(el);pos.left-=this.wrapperOffset.left,pos.top-=this.wrapperOffset.top,offsetX===!0&&(offsetX=Math.round(el.offsetWidth/2-this.wrapper.offsetWidth/2)),offsetY===!0&&(offsetY=Math.round(el.offsetHeight/2-this.wrapper.offsetHeight/2)),pos.left-=offsetX||0,pos.top-=offsetY||0,pos.left=pos.left>0?0:pos.left<this.maxScrollX?this.maxScrollX:pos.left,pos.top=pos.top>0?0:pos.top<this.maxScrollY?this.maxScrollY:pos.top,time=void 0===time||null===time||"auto"===time?Math.max(Math.abs(this.x-pos.left),Math.abs(this.y-pos.top)):time,this.scrollTo(pos.left,pos.top,time,easing)}},_transitionTime:function(time){if(time=time||0,this.scrollerStyle[utils.style.transitionDuration]=time+"ms",!time&&utils.isBadAndroid&&(this.scrollerStyle[utils.style.transitionDuration]="0.001s"),this.indicators)for(var i=this.indicators.length;i--;)this.indicators[i].transitionTime(time)},_transitionTimingFunction:function(easing){if(this.scrollerStyle[utils.style.transitionTimingFunction]=easing,this.indicators)for(var i=this.indicators.length;i--;)this.indicators[i].transitionTimingFunction(easing)},_translate:function(x,y){if(this.options.useTransform?this.scrollerStyle[utils.style.transform]="translate("+x+"px,"+y+"px)"+this.translateZ:(x=Math.round(x),y=Math.round(y),this.scrollerStyle.left=x+"px",this.scrollerStyle.top=y+"px"),this.x=x,this.y=y,this.indicators)for(var i=this.indicators.length;i--;)this.indicators[i].updatePosition()},_initEvents:function(remove){var eventType=remove?utils.removeEvent:utils.addEvent,target=this.options.bindToWrapper?this.wrapper:window;this.options.click&&eventType(this.wrapper,"click",this,!0),this.options.disableMouse||(eventType(this.wrapper,"mousedown",this),eventType(target,"mousemove",this),eventType(target,"mousecancel",this),eventType(target,"mouseup",this)),utils.hasPointer&&!this.options.disablePointer&&(eventType(this.wrapper,utils.prefixPointerEvent("pointerdown"),this),eventType(target,utils.prefixPointerEvent("pointermove"),this),eventType(target,utils.prefixPointerEvent("pointercancel"),this),eventType(target,utils.prefixPointerEvent("pointerup"),this)),utils.hasTouch&&!this.options.disableTouch&&(eventType(this.wrapper,"touchstart",this),eventType(target,"touchmove",this),eventType(target,"touchcancel",this),eventType(target,"touchend",this)),eventType(this.scroller,"transitionend",this),eventType(this.scroller,"webkitTransitionEnd",this),eventType(this.scroller,"oTransitionEnd",this),eventType(this.scroller,"MSTransitionEnd",this)},getComputedPosition:function(){var matrix=window.getComputedStyle(this.scroller,null),x,y;return this.options.useTransform?(matrix=matrix[utils.style.transform].split(")")[0].split(", "),x=+(matrix[12]||matrix[4]),y=+(matrix[13]||matrix[5])):(x=+matrix.left.replace(/[^-\d.]/g,""),y=+matrix.top.replace(/[^-\d.]/g,"")),{x:x,y:y}},_initIndicators:function(){function _indicatorsMap(fn){for(var i=that.indicators.length;i--;)fn.call(that.indicators[i])}var interactive=this.options.interactiveScrollbars,customStyle="string"!=typeof this.options.scrollbars,indicators=[],indicator,that=this;this.indicators=[],this.options.scrollbars&&(this.options.scrollY&&(indicator={el:createDefaultScrollbar("v",interactive,this.options.scrollbars),interactive:interactive,defaultScrollbars:!0,customStyle:customStyle,resize:this.options.resizeScrollbars,shrink:this.options.shrinkScrollbars,fade:this.options.fadeScrollbars,listenX:!1},this.wrapper.appendChild(indicator.el),indicators.push(indicator)),this.options.scrollX&&(indicator={el:createDefaultScrollbar("h",interactive,this.options.scrollbars),interactive:interactive,defaultScrollbars:!0,customStyle:customStyle,resize:this.options.resizeScrollbars,shrink:this.options.shrinkScrollbars,fade:this.options.fadeScrollbars,listenY:!1},this.wrapper.appendChild(indicator.el),indicators.push(indicator))),this.options.indicators&&(indicators=indicators.concat(this.options.indicators));for(var i=indicators.length;i--;)this.indicators.push(new Indicator(this,indicators[i]));this.options.fadeScrollbars&&(this.on("scrollEnd",function(){_indicatorsMap(function(){this.fade()})}),this.on("scrollCancel",function(){_indicatorsMap(function(){this.fade()})}),this.on("scrollStart",function(){_indicatorsMap(function(){this.fade(1)})}),this.on("beforeScrollStart",function(){_indicatorsMap(function(){this.fade(1,!0)})})),this.on("refresh",function(){_indicatorsMap(function(){this.refresh()})}),this.on("destroy",function(){_indicatorsMap(function(){this.destroy()}),delete this.indicators})},_initWheel:function(){utils.addEvent(this.wrapper,"wheel",this),utils.addEvent(this.wrapper,"mousewheel",this),utils.addEvent(this.wrapper,"DOMMouseScroll",this),this.on("destroy",function(){utils.removeEvent(this.wrapper,"wheel",this),utils.removeEvent(this.wrapper,"mousewheel",this),utils.removeEvent(this.wrapper,"DOMMouseScroll",this)})},_wheel:function(e){if(this.enabled){e.preventDefault(),e.stopPropagation();var wheelDeltaX,wheelDeltaY,newX,newY,that=this;if(void 0===this.wheelTimeout&&that._execEvent("scrollStart"),clearTimeout(this.wheelTimeout),this.wheelTimeout=setTimeout(function(){that._execEvent("scrollEnd"),that.wheelTimeout=void 0},400),"deltaX"in e)1===e.deltaMode?(wheelDeltaX=-e.deltaX*this.options.mouseWheelSpeed,wheelDeltaY=-e.deltaY*this.options.mouseWheelSpeed):(wheelDeltaX=-e.deltaX,wheelDeltaY=-e.deltaY);else if("wheelDeltaX"in e)wheelDeltaX=e.wheelDeltaX/120*this.options.mouseWheelSpeed,wheelDeltaY=e.wheelDeltaY/120*this.options.mouseWheelSpeed;else if("wheelDelta"in e)wheelDeltaX=wheelDeltaY=e.wheelDelta/120*this.options.mouseWheelSpeed;else{if(!("detail"in e))return;wheelDeltaX=wheelDeltaY=-e.detail/3*this.options.mouseWheelSpeed}if(wheelDeltaX*=this.options.invertWheelDirection,wheelDeltaY*=this.options.invertWheelDirection,this.hasVerticalScroll||(wheelDeltaX=wheelDeltaY,wheelDeltaY=0),this.options.snap)return newX=this.currentPage.pageX,newY=this.currentPage.pageY,wheelDeltaX>0?newX--:0>wheelDeltaX&&newX++,wheelDeltaY>0?newY--:0>wheelDeltaY&&newY++,void this.goToPage(newX,newY);newX=this.x+Math.round(this.hasHorizontalScroll?wheelDeltaX:0),newY=this.y+Math.round(this.hasVerticalScroll?wheelDeltaY:0),newX>0?newX=0:newX<this.maxScrollX&&(newX=this.maxScrollX),newY>0?newY=0:newY<this.maxScrollY&&(newY=this.maxScrollY),this.scrollTo(newX,newY,0),this.options.probeType>1&&this._execEvent("scroll")}},_initSnap:function(){this.currentPage={},"string"==typeof this.options.snap&&(this.options.snap=this.scroller.querySelectorAll(this.options.snap)),this.on("refresh",function(){var i=0,l,m=0,n,cx,cy,x=0,y,stepX=this.options.snapStepX||this.wrapperWidth,stepY=this.options.snapStepY||this.wrapperHeight,el;if(this.pages=[],this.wrapperWidth&&this.wrapperHeight&&this.scrollerWidth&&this.scrollerHeight){if(this.options.snap===!0)for(cx=Math.round(stepX/2),cy=Math.round(stepY/2);x>-this.scrollerWidth;){for(this.pages[i]=[],l=0,y=0;y>-this.scrollerHeight;)this.pages[i][l]={x:Math.max(x,this.maxScrollX),y:Math.max(y,this.maxScrollY),width:stepX,height:stepY,cx:x-cx,cy:y-cy},y-=stepY,l++;x-=stepX,i++}else for(el=this.options.snap,l=el.length,n=-1;l>i;i++)(0===i||el[i].offsetLeft<=el[i-1].offsetLeft)&&(m=0,n++),this.pages[m]||(this.pages[m]=[]),x=Math.max(-el[i].offsetLeft,this.maxScrollX),y=Math.max(-el[i].offsetTop,this.maxScrollY),cx=x-Math.round(el[i].offsetWidth/2),cy=y-Math.round(el[i].offsetHeight/2),this.pages[m][n]={x:x,y:y,width:el[i].offsetWidth,height:el[i].offsetHeight,cx:cx,cy:cy},x>this.maxScrollX&&m++;this.goToPage(this.currentPage.pageX||0,this.currentPage.pageY||0,0),this.options.snapThreshold%1===0?(this.snapThresholdX=this.options.snapThreshold,this.snapThresholdY=this.options.snapThreshold):(this.snapThresholdX=Math.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].width*this.options.snapThreshold),this.snapThresholdY=Math.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].height*this.options.snapThreshold))}}),this.on("flick",function(){var time=this.options.snapSpeed||Math.max(Math.max(Math.min(Math.abs(this.x-this.startX),1e3),Math.min(Math.abs(this.y-this.startY),1e3)),300);this.goToPage(this.currentPage.pageX+this.directionX,this.currentPage.pageY+this.directionY,time)})},_nearestSnap:function(x,y){if(!this.pages.length)return{x:0,y:0,pageX:0,pageY:0};var i=0,l=this.pages.length,m=0;if(Math.abs(x-this.absStartX)<this.snapThresholdX&&Math.abs(y-this.absStartY)<this.snapThresholdY)return this.currentPage;for(x>0?x=0:x<this.maxScrollX&&(x=this.maxScrollX),y>0?y=0:y<this.maxScrollY&&(y=this.maxScrollY);l>i;i++)if(x>=this.pages[i][0].cx){x=this.pages[i][0].x;break}for(l=this.pages[i].length;l>m;m++)if(y>=this.pages[0][m].cy){y=this.pages[0][m].y;break}return i==this.currentPage.pageX&&(i+=this.directionX,0>i?i=0:i>=this.pages.length&&(i=this.pages.length-1),x=this.pages[i][0].x),m==this.currentPage.pageY&&(m+=this.directionY,0>m?m=0:m>=this.pages[0].length&&(m=this.pages[0].length-1),y=this.pages[0][m].y),{x:x,y:y,pageX:i,pageY:m}},goToPage:function(x,y,time,easing){easing=easing||this.options.bounceEasing,x>=this.pages.length?x=this.pages.length-1:0>x&&(x=0),y>=this.pages[x].length?y=this.pages[x].length-1:0>y&&(y=0);var posX=this.pages[x][y].x,posY=this.pages[x][y].y;time=void 0===time?this.options.snapSpeed||Math.max(Math.max(Math.min(Math.abs(posX-this.x),1e3),Math.min(Math.abs(posY-this.y),1e3)),300):time,this.currentPage={x:posX,y:posY,pageX:x,pageY:y},this.scrollTo(posX,posY,time,easing)},next:function(time,easing){var x=this.currentPage.pageX,y=this.currentPage.pageY;x++,x>=this.pages.length&&this.hasVerticalScroll&&(x=0,y++),this.goToPage(x,y,time,easing)},prev:function(time,easing){var x=this.currentPage.pageX,y=this.currentPage.pageY;x--,0>x&&this.hasVerticalScroll&&(x=0,y--),this.goToPage(x,y,time,easing)},_initKeys:function(e){var keys={pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40},i;if("object"==typeof this.options.keyBindings)for(i in this.options.keyBindings)"string"==typeof this.options.keyBindings[i]&&(this.options.keyBindings[i]=this.options.keyBindings[i].toUpperCase().charCodeAt(0));else this.options.keyBindings={};for(i in keys)this.options.keyBindings[i]=this.options.keyBindings[i]||keys[i];utils.addEvent(window,"keydown",this),this.on("destroy",function(){utils.removeEvent(window,"keydown",this)})},_key:function(e){if(this.enabled){var snap=this.options.snap,newX=snap?this.currentPage.pageX:this.x,newY=snap?this.currentPage.pageY:this.y,now=utils.getTime(),prevTime=this.keyTime||0,acceleration=.25,pos;switch(this.options.useTransition&&this.isInTransition&&(pos=this.getComputedPosition(),this._translate(Math.round(pos.x),Math.round(pos.y)),this.isInTransition=!1),this.keyAcceleration=200>now-prevTime?Math.min(this.keyAcceleration+acceleration,50):0,e.keyCode){case this.options.keyBindings.pageUp:this.hasHorizontalScroll&&!this.hasVerticalScroll?newX+=snap?1:this.wrapperWidth:newY+=snap?1:this.wrapperHeight;break;case this.options.keyBindings.pageDown:this.hasHorizontalScroll&&!this.hasVerticalScroll?newX-=snap?1:this.wrapperWidth:newY-=snap?1:this.wrapperHeight;break;case this.options.keyBindings.end:newX=snap?this.pages.length-1:this.maxScrollX,newY=snap?this.pages[0].length-1:this.maxScrollY;break;case this.options.keyBindings.home:newX=0,newY=0;break;case this.options.keyBindings.left:newX+=snap?-1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.up:newY+=snap?1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.right:newX-=snap?-1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.down:newY-=snap?1:5+this.keyAcceleration>>0;break;default:return}if(snap)return void this.goToPage(newX,newY);newX>0?(newX=0,this.keyAcceleration=0):newX<this.maxScrollX&&(newX=this.maxScrollX,this.keyAcceleration=0),newY>0?(newY=0,this.keyAcceleration=0):newY<this.maxScrollY&&(newY=this.maxScrollY,this.keyAcceleration=0),this.scrollTo(newX,newY,0),this.keyTime=now}},_animate:function(destX,destY,duration,easingFn){function step(){var now=utils.getTime(),newX,newY,easing;return now>=destTime?(that.isAnimating=!1,that._translate(destX,destY),void(that.resetPosition(that.options.bounceTime)||that._execEvent("scrollEnd"))):(now=(now-startTime)/duration,easing=easingFn(now),newX=(destX-startX)*easing+startX,newY=(destY-startY)*easing+startY,that._translate(newX,newY),that.isAnimating&&rAF(step),void(3==that.options.probeType&&that._execEvent("scroll")))}var that=this,startX=this.x,startY=this.y,startTime=utils.getTime(),destTime=startTime+duration;this.isAnimating=!0,step()},handleEvent:function(e){switch(e.type){case"touchstart":case"pointerdown":case"MSPointerDown":case"mousedown":this._start(e);break;case"touchmove":case"pointermove":case"MSPointerMove":case"mousemove":this._move(e);break;case"touchend":case"pointerup":case"MSPointerUp":case"mouseup":case"touchcancel":case"pointercancel":case"MSPointerCancel":case"mousecancel":this._end(e);break;case"transitionend":case"webkitTransitionEnd":case"oTransitionEnd":case"MSTransitionEnd":this._transitionEnd(e);break;case"wheel":case"DOMMouseScroll":case"mousewheel":this._wheel(e);break;case"keydown":this._key(e);break;case"click":e._constructed||(e.preventDefault(),e.stopPropagation())}}},Indicator.prototype={handleEvent:function(e){switch(e.type){case"touchstart":case"pointerdown":case"MSPointerDown":case"mousedown":this._start(e);break;case"touchmove":case"pointermove":case"MSPointerMove":case"mousemove":this._move(e);break;case"touchend":case"pointerup":case"MSPointerUp":case"mouseup":case"touchcancel":case"pointercancel":case"MSPointerCancel":case"mousecancel":this._end(e)}},destroy:function(){this.options.interactive&&(utils.removeEvent(this.indicator,"touchstart",this),utils.removeEvent(this.indicator,utils.prefixPointerEvent("pointerdown"),this),utils.removeEvent(this.indicator,"mousedown",this),utils.removeEvent(window,"touchmove",this),utils.removeEvent(window,utils.prefixPointerEvent("pointermove"),this),utils.removeEvent(window,"mousemove",this),utils.removeEvent(window,"touchend",this),utils.removeEvent(window,utils.prefixPointerEvent("pointerup"),this),utils.removeEvent(window,"mouseup",this)),this.options.defaultScrollbars&&this.wrapper.parentNode.removeChild(this.wrapper)},_start:function(e){var point=e.touches?e.touches[0]:e;e.preventDefault(),e.stopPropagation(),this.transitionTime(),this.initiated=!0,this.moved=!1,this.lastPointX=point.pageX,this.lastPointY=point.pageY,this.startTime=utils.getTime(),this.options.disableTouch||utils.addEvent(window,"touchmove",this),this.options.disablePointer||utils.addEvent(window,utils.prefixPointerEvent("pointermove"),this),this.options.disableMouse||utils.addEvent(window,"mousemove",this),this.scroller._execEvent("beforeScrollStart")},_move:function(e){var point=e.touches?e.touches[0]:e,deltaX,deltaY,newX,newY,timestamp=utils.getTime();this.moved||this.scroller._execEvent("scrollStart"),this.moved=!0,deltaX=point.pageX-this.lastPointX,this.lastPointX=point.pageX,deltaY=point.pageY-this.lastPointY,this.lastPointY=point.pageY,newX=this.x+deltaX,newY=this.y+deltaY,this._pos(newX,newY),1==this.scroller.options.probeType&&timestamp-this.startTime>300?(this.startTime=timestamp,this.scroller._execEvent("scroll")):this.scroller.options.probeType>1&&this.scroller._execEvent("scroll"),e.preventDefault(),e.stopPropagation()},_end:function(e){if(this.initiated){if(this.initiated=!1,e.preventDefault(),e.stopPropagation(),utils.removeEvent(window,"touchmove",this),utils.removeEvent(window,utils.prefixPointerEvent("pointermove"),this),utils.removeEvent(window,"mousemove",this),this.scroller.options.snap){var snap=this.scroller._nearestSnap(this.scroller.x,this.scroller.y),time=this.options.snapSpeed||Math.max(Math.max(Math.min(Math.abs(this.scroller.x-snap.x),1e3),Math.min(Math.abs(this.scroller.y-snap.y),1e3)),300);(this.scroller.x!=snap.x||this.scroller.y!=snap.y)&&(this.scroller.directionX=0,this.scroller.directionY=0,this.scroller.currentPage=snap,this.scroller.scrollTo(snap.x,snap.y,time,this.scroller.options.bounceEasing))}this.moved&&this.scroller._execEvent("scrollEnd")}},transitionTime:function(time){time=time||0,this.indicatorStyle[utils.style.transitionDuration]=time+"ms",!time&&utils.isBadAndroid&&(this.indicatorStyle[utils.style.transitionDuration]="0.001s")},transitionTimingFunction:function(easing){this.indicatorStyle[utils.style.transitionTimingFunction]=easing},refresh:function(){this.transitionTime(),this.indicatorStyle.display=this.options.listenX&&!this.options.listenY?this.scroller.hasHorizontalScroll?"block":"none":this.options.listenY&&!this.options.listenX?this.scroller.hasVerticalScroll?"block":"none":this.scroller.hasHorizontalScroll||this.scroller.hasVerticalScroll?"block":"none",this.scroller.hasHorizontalScroll&&this.scroller.hasVerticalScroll?(utils.addClass(this.wrapper,"iScrollBothScrollbars"),utils.removeClass(this.wrapper,"iScrollLoneScrollbar"),this.options.defaultScrollbars&&this.options.customStyle&&(this.options.listenX?this.wrapper.style.right="8px":this.wrapper.style.bottom="8px")):(utils.removeClass(this.wrapper,"iScrollBothScrollbars"),utils.addClass(this.wrapper,"iScrollLoneScrollbar"),this.options.defaultScrollbars&&this.options.customStyle&&(this.options.listenX?this.wrapper.style.right="2px":this.wrapper.style.bottom="2px"));var r=this.wrapper.offsetHeight;this.options.listenX&&(this.wrapperWidth=this.wrapper.clientWidth,this.options.resize?(this.indicatorWidth=Math.max(Math.round(this.wrapperWidth*this.wrapperWidth/(this.scroller.scrollerWidth||this.wrapperWidth||1)),8),this.indicatorStyle.width=this.indicatorWidth+"px"):this.indicatorWidth=this.indicator.clientWidth,this.maxPosX=this.wrapperWidth-this.indicatorWidth,"clip"==this.options.shrink?(this.minBoundaryX=-this.indicatorWidth+8,this.maxBoundaryX=this.wrapperWidth-8):(this.minBoundaryX=0,this.maxBoundaryX=this.maxPosX),this.sizeRatioX=this.options.speedRatioX||this.scroller.maxScrollX&&this.maxPosX/this.scroller.maxScrollX),this.options.listenY&&(this.wrapperHeight=this.wrapper.clientHeight,this.options.resize?(this.indicatorHeight=Math.max(Math.round(this.wrapperHeight*this.wrapperHeight/(this.scroller.scrollerHeight||this.wrapperHeight||1)),8),this.indicatorStyle.height=this.indicatorHeight+"px"):this.indicatorHeight=this.indicator.clientHeight,this.maxPosY=this.wrapperHeight-this.indicatorHeight,"clip"==this.options.shrink?(this.minBoundaryY=-this.indicatorHeight+8,this.maxBoundaryY=this.wrapperHeight-8):(this.minBoundaryY=0,this.maxBoundaryY=this.maxPosY),this.maxPosY=this.wrapperHeight-this.indicatorHeight,this.sizeRatioY=this.options.speedRatioY||this.scroller.maxScrollY&&this.maxPosY/this.scroller.maxScrollY),this.updatePosition()
},updatePosition:function(){var x=this.options.listenX&&Math.round(this.sizeRatioX*this.scroller.x)||0,y=this.options.listenY&&Math.round(this.sizeRatioY*this.scroller.y)||0;this.options.ignoreBoundaries||(x<this.minBoundaryX?("scale"==this.options.shrink&&(this.width=Math.max(this.indicatorWidth+x,8),this.indicatorStyle.width=this.width+"px"),x=this.minBoundaryX):x>this.maxBoundaryX?"scale"==this.options.shrink?(this.width=Math.max(this.indicatorWidth-(x-this.maxPosX),8),this.indicatorStyle.width=this.width+"px",x=this.maxPosX+this.indicatorWidth-this.width):x=this.maxBoundaryX:"scale"==this.options.shrink&&this.width!=this.indicatorWidth&&(this.width=this.indicatorWidth,this.indicatorStyle.width=this.width+"px"),y<this.minBoundaryY?("scale"==this.options.shrink&&(this.height=Math.max(this.indicatorHeight+3*y,8),this.indicatorStyle.height=this.height+"px"),y=this.minBoundaryY):y>this.maxBoundaryY?"scale"==this.options.shrink?(this.height=Math.max(this.indicatorHeight-3*(y-this.maxPosY),8),this.indicatorStyle.height=this.height+"px",y=this.maxPosY+this.indicatorHeight-this.height):y=this.maxBoundaryY:"scale"==this.options.shrink&&this.height!=this.indicatorHeight&&(this.height=this.indicatorHeight,this.indicatorStyle.height=this.height+"px")),this.x=x,this.y=y,this.scroller.options.useTransform?this.indicatorStyle[utils.style.transform]="translate("+x+"px,"+y+"px)"+this.scroller.translateZ:(this.indicatorStyle.left=x+"px",this.indicatorStyle.top=y+"px")},_pos:function(x,y){0>x?x=0:x>this.maxPosX&&(x=this.maxPosX),0>y?y=0:y>this.maxPosY&&(y=this.maxPosY),x=this.options.listenX?Math.round(x/this.sizeRatioX):this.scroller.x,y=this.options.listenY?Math.round(y/this.sizeRatioY):this.scroller.y,this.scroller.scrollTo(x,y)},fade:function(val,hold){if(!hold||this.visible){clearTimeout(this.fadeTimeout),this.fadeTimeout=null;var time=val?250:500,delay=val?0:300;val=val?"1":"0",this.wrapperStyle[utils.style.transitionDuration]=time+"ms",this.fadeTimeout=setTimeout(function(val){this.wrapperStyle.opacity=val,this.visible=+val}.bind(this,val),delay)}}},IScroll.utils=utils,"undefined"!=typeof module&&module.exports?module.exports=IScroll:window.IScroll=IScroll}(window,document,Math),define("IScroll",function(global){return function(){var ret,fn;return ret||global.IScroll}}(this)),function(){var $D=Date,lang=Date.CultureStrings?Date.CultureStrings.lang:null,loggedKeys={},getText={getFromKey:function(key,countryCode){var output;return output=Date.CultureStrings&&Date.CultureStrings[countryCode]&&Date.CultureStrings[countryCode][key]?Date.CultureStrings[countryCode][key]:getText.buildFromDefault(key),"/"===key.charAt(0)&&(output=getText.buildFromRegex(key,countryCode)),output},getFromObjectValues:function(obj,countryCode){var key,output={};for(key in obj)obj.hasOwnProperty(key)&&(output[key]=getText.getFromKey(obj[key],countryCode));return output},getFromObjectKeys:function(obj,countryCode){var key,output={};for(key in obj)obj.hasOwnProperty(key)&&(output[getText.getFromKey(key,countryCode)]=obj[key]);return output},getFromArray:function(arr,countryCode){for(var output=[],i=0;i<arr.length;i++)i in arr&&(output[i]=getText.getFromKey(arr[i],countryCode));return output},buildFromDefault:function(key){var output,length,split,last;switch(key){case"name":output="en-US";break;case"englishName":output="English (United States)";break;case"nativeName":output="English (United States)";break;case"twoDigitYearMax":output=2049;break;case"firstDayOfWeek":output=0;break;default:output=key,split=key.split("_"),length=split.length,length>1&&"/"!==key.charAt(0)&&(last=split[length-1].toLowerCase(),("initial"===last||"abbr"===last)&&(output=split[0]))}return output},buildFromRegex:function(key,countryCode){var output;return output=Date.CultureStrings&&Date.CultureStrings[countryCode]&&Date.CultureStrings[countryCode][key]?new RegExp(Date.CultureStrings[countryCode][key],"i"):new RegExp(key.replace(new RegExp("/","g"),""),"i")}},shallowMerge=function(obj1,obj2){for(var attrname in obj2)obj2.hasOwnProperty(attrname)&&(obj1[attrname]=obj2[attrname])},__=function(key,language){var countryCode=language?language:lang;return loggedKeys[key]=key,"object"==typeof key?key instanceof Array?getText.getFromArray(key,countryCode):getText.getFromObjectKeys(key,countryCode):getText.getFromKey(key,countryCode)},buildInfo={buildFromMethodHash:function(obj){var key;for(key in obj)obj.hasOwnProperty(key)&&(obj[key]=buildInfo[obj[key]]());return obj},timeZoneDST:function(){var DST={CHADT:"+1345",NZDT:"+1300",AEDT:"+1100",ACDT:"+1030",AZST:"+0500",IRDT:"+0430",EEST:"+0300",CEST:"+0200",BST:"+0100",PMDT:"-0200",ADT:"-0300",NDT:"-0230",EDT:"-0400",CDT:"-0500",MDT:"-0600",PDT:"-0700",AKDT:"-0800",HADT:"-0900"};return __(DST)},timeZoneStandard:function(){var standard={LINT:"+1400",TOT:"+1300",CHAST:"+1245",NZST:"+1200",NFT:"+1130",SBT:"+1100",AEST:"+1000",ACST:"+0930",JST:"+0900",CWST:"+0845",CT:"+0800",ICT:"+0700",MMT:"+0630",BST:"+0600",NPT:"+0545",IST:"+0530",PKT:"+0500",AFT:"+0430",MSK:"+0400",IRST:"+0330",FET:"+0300",EET:"+0200",CET:"+0100",GMT:"+0000",UTC:"+0000",CVT:"-0100",GST:"-0200",BRT:"-0300",NST:"-0330",AST:"-0400",EST:"-0500",CST:"-0600",MST:"-0700",PST:"-0800",AKST:"-0900",MIT:"-0930",HST:"-1000",SST:"-1100",BIT:"-1200"};return __(standard)},timeZones:function(data){var zone;data.timezones=[];for(zone in data.abbreviatedTimeZoneStandard)data.abbreviatedTimeZoneStandard.hasOwnProperty(zone)&&data.timezones.push({name:zone,offset:data.abbreviatedTimeZoneStandard[zone]});for(zone in data.abbreviatedTimeZoneDST)data.abbreviatedTimeZoneDST.hasOwnProperty(zone)&&data.timezones.push({name:zone,offset:data.abbreviatedTimeZoneDST[zone],dst:!0});return data.timezones},days:function(){return __(["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"])},dayAbbr:function(){return __(["Sun","Mon","Tue","Wed","Thu","Fri","Sat"])},dayShortNames:function(){return __(["Su","Mo","Tu","We","Th","Fr","Sa"])},dayFirstLetters:function(){return __(["S_Sun_Initial","M_Mon_Initial","T_Tues_Initial","W_Wed_Initial","T_Thu_Initial","F_Fri_Initial","S_Sat_Initial"])},months:function(){return __(["January","February","March","April","May","June","July","August","September","October","November","December"])},monthAbbr:function(){return __(["Jan_Abbr","Feb_Abbr","Mar_Abbr","Apr_Abbr","May_Abbr","Jun_Abbr","Jul_Abbr","Aug_Abbr","Sep_Abbr","Oct_Abbr","Nov_Abbr","Dec_Abbr"])},formatPatterns:function(){return getText.getFromObjectValues({shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss",monthDay:"MMMM dd",monthDayShortTime:"MM/dd",monthDayYear:"MM/dd/yy",yearMonth:"MMMM, yyyy"},Date.i18n.currentLanguage())},regex:function(){return getText.getFromObjectValues({thisMorning:"/(this )(morn(ing)?)\\b/",thisEvening:"/(this )(even(ing)?)\\b/",jan:"/jan(uary)?/",feb:"/feb(ruary)?/",mar:"/mar(ch)?/",apr:"/apr(il)?/",may:"/may/",jun:"/jun(e)?/",jul:"/jul(y)?/",aug:"/aug(ust)?/",sep:"/sep(t(ember)?)?/",oct:"/oct(ober)?/",nov:"/nov(ember)?/",dec:"/dec(ember)?/",sun:"/^sun(day)?/",mon:"/^mon(day)?/",tue:"/^tue(s(day)?)?/",wed:"/^wed(nesday)?/",thu:"/^thu(rsday)?/",fri:"/^fri(day)?/",sat:"/^sat(urday)?/",future:"/^next/",past:"/^last|past|prev(ious)?/",yesterday:"/^yesterday/",today:"/^today/",tomorrow:"/^tom(orrow)?/",soon:"/^soon/",later:"/^later/",someday:"/^someday/",now:"/^now/",shortMeridian:"/^(a|p)/",longMeridian:"/^(a\\.?m?\\.?|p\\.?m?\\.?)/",timezone:"/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\\s*(\\+|\\-)\\s*\\d\\d\\d\\d?)|gmt|utc)/",ordinalSuffix:"/^\\s*(st|nd|rd|th)/",timeContext:"/^\\s*(\\:|a(?!u|p)|p)/"},Date.i18n.currentLanguage())}},CultureInfo=function(){var info=getText.getFromObjectValues({name:"name",englishName:"englishName",nativeName:"nativeName",amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:"firstDayOfWeek",twoDigitYearMax:"twoDigitYearMax",dateElementOrder:"mdy"},Date.i18n.currentLanguage()),constructedInfo=buildInfo.buildFromMethodHash({dayNames:"days",abbreviatedDayNames:"dayAbbr",shortestDayNames:"dayShortNames",firstLetterDayNames:"dayFirstLetters",monthNames:"months",abbreviatedMonthNames:"monthAbbr",formatPatterns:"formatPatterns",regexPatterns:"regex",abbreviatedTimeZoneDST:"timeZoneDST",abbreviatedTimeZoneStandard:"timeZoneStandard"});return shallowMerge(info,constructedInfo),buildInfo.timeZones(info),info};$D.i18n={__:function(key,lang){return __(key,lang)},currentLanguage:function(){return lang||"en-US"},setLanguage:function(code,force,cb){if(force||"en-US"===code||Date.CultureStrings&&Date.CultureStrings[code])lang=code,Date.CultureStrings=Date.CultureStrings||{},Date.CultureStrings.lang=code,Date.CultureInfo=new CultureInfo;else if(!Date.CultureStrings||!Date.CultureStrings[code])return!1;$D.Parsing.Normalizer.buildReplaceData(),$D.Grammar&&$D.Grammar.buildGrammarFormats(),cb&&cb()},getLoggedKeys:function(){return loggedKeys},updateCultureInfo:function(){Date.CultureInfo=new CultureInfo}},$D.i18n.updateCultureInfo()}(),function(){var $D=Date,$P=$D.prototype,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)};$D.console="undefined"!=typeof window&&"undefined"!=typeof window.console&&"undefined"!=typeof window.console.log?console:{log:function(){},error:function(){}},$D.Config=$D.Config||{},$D.initOverloads=function(){$D.now?$D._now||($D._now=$D.now):$D._now=function now(){return(new Date).getTime()},$D.now=function(returnObj){return returnObj?$D.present():$D._now()},$P.toISOString||($P.toISOString=function(){return this.getUTCFullYear()+"-"+p(this.getUTCMonth()+1)+"-"+p(this.getUTCDate())+"T"+p(this.getUTCHours())+":"+p(this.getUTCMinutes())+":"+p(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}),void 0===$P._toString&&($P._toString=$P.toString)},$D.initOverloads(),$D.today=function(){return(new Date).clearTime()},$D.present=function(){return new Date},$D.compare=function(date1,date2){if(isNaN(date1)||isNaN(date2))throw new Error(date1+" - "+date2);if(date1 instanceof Date&&date2 instanceof Date)return date2>date1?-1:date1>date2?1:0;throw new TypeError(date1+" - "+date2)},$D.equals=function(date1,date2){return 0===date1.compareTo(date2)},$D.getDayName=function(n){return Date.CultureInfo.dayNames[n]},$D.getDayNumberFromName=function(name){for(var n=Date.CultureInfo.dayNames,m=Date.CultureInfo.abbreviatedDayNames,o=Date.CultureInfo.shortestDayNames,s=name.toLowerCase(),i=0;i<n.length;i++)if(n[i].toLowerCase()===s||m[i].toLowerCase()===s||o[i].toLowerCase()===s)return i;return-1},$D.getMonthNumberFromName=function(name){for(var n=Date.CultureInfo.monthNames,m=Date.CultureInfo.abbreviatedMonthNames,s=name.toLowerCase(),i=0;i<n.length;i++)if(n[i].toLowerCase()===s||m[i].toLowerCase()===s)return i;return-1},$D.getMonthName=function(n){return Date.CultureInfo.monthNames[n]},$D.isLeapYear=function(year){return year%4===0&&year%100!==0||year%400===0},$D.getDaysInMonth=function(year,month){return!month&&$D.validateMonth(year)&&(month=year,year=Date.today().getFullYear()),[31,$D.isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month]},$P.getDaysInMonth=function(){return $D.getDaysInMonth(this.getFullYear(),this.getMonth())},$D.getTimezoneAbbreviation=function(offset,dst){var p,n=dst?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard;for(p in n)if(n.hasOwnProperty(p)&&n[p]===offset)return p;return null},$D.getTimezoneOffset=function(name,dst){var i,a=[],z=Date.CultureInfo.timezones;for(name||(name=(new Date).getTimezone()),i=0;i<z.length;i++)z[i].name===name.toUpperCase()&&a.push(i);if(!z[a[0]])return null;if(1===a.length||!dst)return z[a[0]].offset;for(i=0;i<a.length;i++)if(z[a[i]].dst)return z[a[i]].offset},$D.getQuarter=function(d){d=d||new Date;var q=[1,2,3,4];return q[Math.floor(d.getMonth()/3)]},$D.getDaysLeftInQuarter=function(d){d=d||new Date;var qEnd=new Date(d);return qEnd.setMonth(qEnd.getMonth()+3-qEnd.getMonth()%3,0),Math.floor((qEnd-d)/864e5)},$P.ensureTimeOfDay=function(){0===this.getMilliseconds()&&this.setTime(this.getTime()+1)};var validate=function(n,min,max,name){if(name=name?name:"Object","undefined"==typeof n)return!1;if("number"!=typeof n)throw new TypeError(n+" is not a Number.");return min>n||n>max?!1:!0};$D.validateMillisecond=function(value){return validate(value,0,999,"millisecond")},$D.validateSecond=function(value){return validate(value,0,59,"second")},$D.validateMinute=function(value){return validate(value,0,59,"minute")},$D.validateHour=function(value){return validate(value,0,23,"hour")},$D.validateDay=function(value,year,month){return void 0===year||null===year||void 0===month||null===month?!1:validate(value,1,$D.getDaysInMonth(year,month),"day")},$D.validateWeek=function(value){return validate(value,0,53,"week")},$D.validateMonth=function(value){return validate(value,0,11,"month")},$D.validateYear=function(value){return validate(value,-271822,275760,"year")},$D.validateTimezone=function(value){var timezones={ACDT:1,ACST:1,ACT:1,ADT:1,AEDT:1,AEST:1,AFT:1,AKDT:1,AKST:1,AMST:1,AMT:1,ART:1,AST:1,AWDT:1,AWST:1,AZOST:1,AZT:1,BDT:1,BIOT:1,BIT:1,BOT:1,BRT:1,BST:1,BTT:1,CAT:1,CCT:1,CDT:1,CEDT:1,CEST:1,CET:1,CHADT:1,CHAST:1,CHOT:1,ChST:1,CHUT:1,CIST:1,CIT:1,CKT:1,CLST:1,CLT:1,COST:1,COT:1,CST:1,CT:1,CVT:1,CWST:1,CXT:1,DAVT:1,DDUT:1,DFT:1,EASST:1,EAST:1,EAT:1,ECT:1,EDT:1,EEDT:1,EEST:1,EET:1,EGST:1,EGT:1,EIT:1,EST:1,FET:1,FJT:1,FKST:1,FKT:1,FNT:1,GALT:1,GAMT:1,GET:1,GFT:1,GILT:1,GIT:1,GMT:1,GST:1,GYT:1,HADT:1,HAEC:1,HAST:1,HKT:1,HMT:1,HOVT:1,HST:1,ICT:1,IDT:1,IOT:1,IRDT:1,IRKT:1,IRST:1,IST:1,JST:1,KGT:1,KOST:1,KRAT:1,KST:1,LHST:1,LINT:1,MAGT:1,MART:1,MAWT:1,MDT:1,MET:1,MEST:1,MHT:1,MIST:1,MIT:1,MMT:1,MSK:1,MST:1,MUT:1,MVT:1,MYT:1,NCT:1,NDT:1,NFT:1,NPT:1,NST:1,NT:1,NUT:1,NZDT:1,NZST:1,OMST:1,ORAT:1,PDT:1,PET:1,PETT:1,PGT:1,PHOT:1,PHT:1,PKT:1,PMDT:1,PMST:1,PONT:1,PST:1,PYST:1,PYT:1,RET:1,ROTT:1,SAKT:1,SAMT:1,SAST:1,SBT:1,SCT:1,SGT:1,SLST:1,SRT:1,SST:1,SYOT:1,TAHT:1,THA:1,TFT:1,TJT:1,TKT:1,TLT:1,TMT:1,TOT:1,TVT:1,UCT:1,ULAT:1,UTC:1,UYST:1,UYT:1,UZT:1,VET:1,VLAT:1,VOLT:1,VOST:1,VUT:1,WAKT:1,WAST:1,WAT:1,WEDT:1,WEST:1,WET:1,WST:1,YAKT:1,YEKT:1,Z:1};return 1===timezones[value]},$D.validateTimezoneOffset=function(value){return value>-841&&721>value},$D.validateSetExplicitTime=function(value){return!0}}(),function(){var $D=Date,$P=$D.prototype,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)},validateConfigObject=function(obj){var result={},self=this,prop,testFunc;testFunc=function(prop,func,value){if("day"===prop){var month=void 0!==obj.month?obj.month:self.getMonth(),year=void 0!==obj.year?obj.year:self.getFullYear();return $D[func](value,year,month)}return $D[func](value)};for(prop in obj)if(hasOwnProperty.call(obj,prop)){var func="validate"+prop.charAt(0).toUpperCase()+prop.slice(1);$D[func]&&null!==obj[prop]&&testFunc(prop,func,obj[prop])&&(result[prop]=obj[prop])}return result};$P.clearTime=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},$P.setTimeToNow=function(){var n=new Date;return this.setHours(n.getHours()),this.setMinutes(n.getMinutes()),this.setSeconds(n.getSeconds()),this.setMilliseconds(n.getMilliseconds()),this},$P.clone=function(){return new Date(this.getTime())},$P.compareTo=function(date){return Date.compare(this,date)},$P.equals=function(date){return Date.equals(this,void 0!==date?date:new Date)},$P.between=function(start,end){return this.getTime()>=start.getTime()&&this.getTime()<=end.getTime()},$P.isAfter=function(date){return 1===this.compareTo(date||new Date)},$P.isBefore=function(date){return-1===this.compareTo(date||new Date)},$P.isToday=$P.isSameDay=function(date){return this.clone().clearTime().equals((date||new Date).clone().clearTime())},$P.addMilliseconds=function(value){return value?(this.setTime(this.getTime()+1*value),this):this},$P.addSeconds=function(value){return value?this.addMilliseconds(1e3*value):this},$P.addMinutes=function(value){return value?this.addMilliseconds(6e4*value):this},$P.addHours=function(value){return value?this.addMilliseconds(36e5*value):this},$P.addDays=function(value){return value?(this.setDate(this.getDate()+1*value),this):this},$P.addWeekdays=function(value){if(!value)return this;var day=this.getDay(),weeks=Math.ceil(Math.abs(value)/7);if((0===day||6===day)&&value>0&&(this.next().monday(),this.addDays(-1),day=this.getDay()),0>value){for(;0>value;)this.addDays(-1),day=this.getDay(),0!==day&&6!==day&&value++;return this}return(value>5||value>=6-day)&&(value+=2*weeks),this.addDays(value)},$P.addWeeks=function(value){return value?this.addDays(7*value):this},$P.addMonths=function(value){if(!value)return this;var n=this.getDate();return this.setDate(1),this.setMonth(this.getMonth()+1*value),this.setDate(Math.min(n,$D.getDaysInMonth(this.getFullYear(),this.getMonth()))),this},$P.addQuarters=function(value){return value?this.addMonths(3*value):this},$P.addYears=function(value){return value?this.addMonths(12*value):this},$P.add=function(config){if("number"==typeof config)return this._orient=config,this;var changed,x=config;return x.day&&x.day-this.getDate()!==0&&this.setDate(x.day),x.milliseconds&&this.addMilliseconds(x.milliseconds),x.seconds&&this.addSeconds(x.seconds),x.minutes&&this.addMinutes(x.minutes),x.hours&&this.addHours(x.hours),x.weeks&&this.addWeeks(x.weeks),x.months&&this.addMonths(x.months),x.years&&this.addYears(x.years),x.days&&this.addDays(x.days),x.setExplicitTime&&this.ensureTimeOfDay(),this},$P.getWeek=function(utc){var self,target=new Date(this.valueOf());utc?(target.addMinutes(target.getTimezoneOffset()),self=target.clone()):self=this;var dayNr=(self.getDay()+6)%7;target.setDate(target.getDate()-dayNr+3);var firstThursday=target.valueOf();return target.setMonth(0,1),4!==target.getDay()&&target.setMonth(0,1+(4-target.getDay()+7)%7),1+Math.ceil((firstThursday-target)/6048e5)},$P.getISOWeek=function(){return p(this.getWeek(!0))},$P.setWeek=function(n){return n-this.getWeek()===0?1!==this.getDay()?this.moveToDayOfWeek(1,this.getDay()>1?-1:1):this:this.moveToDayOfWeek(1,this.getDay()>1?-1:1).addWeeks(n-this.getWeek())},$P.setQuarter=function(qtr){var month=Math.abs(3*(qtr-1)+1);return this.setMonth(month,1)},$P.getQuarter=function(){return Date.getQuarter(this)},$P.getDaysLeftInQuarter=function(){return Date.getDaysLeftInQuarter(this)},$P.moveToNthOccurrence=function(dayOfWeek,occurrence){if("Weekday"===dayOfWeek){if(occurrence>0)this.moveToFirstDayOfMonth(),this.is().weekday()&&(occurrence-=1);else{if(!(0>occurrence))return this;this.moveToLastDayOfMonth(),this.is().weekday()&&(occurrence+=1)}return this.addWeekdays(occurrence)}var shift=0;if(occurrence>0)shift=occurrence-1;else if(-1===occurrence)return this.moveToLastDayOfMonth(),this.getDay()!==dayOfWeek&&this.moveToDayOfWeek(dayOfWeek,-1),this;return this.moveToFirstDayOfMonth().addDays(-1).moveToDayOfWeek(dayOfWeek,1).addWeeks(shift)};var moveToN=function(getFunc,addFunc,nVal){return function(value,orient){var diff=(value-this[getFunc]()+nVal*(orient||1))%nVal;return this[addFunc](0===diff?diff+=nVal*(orient||1):diff)}};$P.moveToDayOfWeek=moveToN("getDay","addDays",7),$P.moveToMonth=moveToN("getMonth","addMonths",12),$P.getOrdinate=function(){var num=this.getDate();return ord(num)},$P.getOrdinalNumber=function(){return Math.ceil((this.clone().clearTime()-new Date(this.getFullYear(),0,1))/864e5)+1},$P.getTimezone=function(){return $D.getTimezoneAbbreviation(this.getUTCOffset(),this.isDaylightSavingTime())},$P.setTimezoneOffset=function(offset){var here=this.getTimezoneOffset(),there=-6*Number(offset)/10;return there||0===there?this.addMinutes(here-there):this},$P.setTimezone=function(offset){return this.setTimezoneOffset($D.getTimezoneOffset(offset))},$P.hasDaylightSavingTime=function(){return Date.today().set({month:0,day:1}).getTimezoneOffset()!==Date.today().set({month:6,day:1}).getTimezoneOffset()},$P.isDaylightSavingTime=function(){return Date.today().set({month:0,day:1}).getTimezoneOffset()!==this.getTimezoneOffset()},$P.getUTCOffset=function(offset){var n=-10*(offset||this.getTimezoneOffset())/6,r;return 0>n?(r=(n-1e4).toString(),r.charAt(0)+r.substr(2)):(r=(n+1e4).toString(),"+"+r.substr(1))},$P.getElapsed=function(date){return(date||new Date)-this},$P.set=function(config){config=validateConfigObject.call(this,config);var key;for(key in config)if(hasOwnProperty.call(config,key)){var name=key.charAt(0).toUpperCase()+key.slice(1),addFunc,getFunc;"week"!==key&&"month"!==key&&"timezone"!==key&&"timezoneOffset"!==key&&(name+="s"),addFunc="add"+name,getFunc="get"+name,"month"===key?addFunc+="s":"year"===key&&(getFunc="getFullYear"),"day"!==key&&"timezone"!==key&&"timezoneOffset"!==key&&"week"!==key&&"hour"!==key&&"setExplicitTime"!==key?this[addFunc](config[key]-this[getFunc]()):("timezone"===key||"timezoneOffset"===key||"week"===key||"hour"===key)&&this["set"+name](config[key])}return config.day&&this.addDays(config.day-this.getDate()),this},$P.moveToFirstDayOfMonth=function(){return this.set({day:1})},$P.moveToLastDayOfMonth=function(){return this.set({day:$D.getDaysInMonth(this.getFullYear(),this.getMonth())})};var ord=function(n){switch(1*n){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}},parseStandardFormats=function(format){var y,c=Date.CultureInfo.formatPatterns;switch(format){case"d":return this.toString(c.shortDate);case"D":return this.toString(c.longDate);case"F":return this.toString(c.fullDateTime);case"m":return this.toString(c.monthDay);case"r":case"R":return y=this.clone().addMinutes(this.getTimezoneOffset()),y.toString(c.rfc1123)+" GMT";case"s":return this.toString(c.sortableDateTime);case"t":return this.toString(c.shortTime);case"T":return this.toString(c.longTime);case"u":return y=this.clone().addMinutes(this.getTimezoneOffset()),y.toString(c.universalSortableDateTime);case"y":return this.toString(c.yearMonth);default:return!1}},parseFormatStringsClosure=function(context){return function(m){if("\\"===m.charAt(0))return m.replace("\\","");switch(m){case"hh":return p(context.getHours()<13?0===context.getHours()?12:context.getHours():context.getHours()-12);case"h":return context.getHours()<13?0===context.getHours()?12:context.getHours():context.getHours()-12;case"HH":return p(context.getHours());case"H":return context.getHours();case"mm":return p(context.getMinutes());case"m":return context.getMinutes();case"ss":return p(context.getSeconds());case"s":return context.getSeconds();case"yyyy":return p(context.getFullYear(),4);case"yy":return p(context.getFullYear());case"y":return context.getFullYear();case"E":case"dddd":return Date.CultureInfo.dayNames[context.getDay()];case"ddd":return Date.CultureInfo.abbreviatedDayNames[context.getDay()];case"dd":return p(context.getDate());case"d":return context.getDate();case"MMMM":return Date.CultureInfo.monthNames[context.getMonth()];case"MMM":return Date.CultureInfo.abbreviatedMonthNames[context.getMonth()];case"MM":return p(context.getMonth()+1);case"M":return context.getMonth()+1;case"t":return context.getHours()<12?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return context.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"S":return ord(context.getDate());case"W":return context.getWeek();case"WW":return context.getISOWeek();case"Q":return"Q"+context.getQuarter();case"q":return String(context.getQuarter());case"z":return context.getTimezone();case"Z":case"X":return Date.getTimezoneOffset(context.getTimezone());case"ZZ":return-60*context.getTimezoneOffset();case"u":return context.getDay();case"L":return $D.isLeapYear(context.getFullYear())?1:0;case"B":return"@"+(context.getUTCSeconds()+60*context.getUTCMinutes()+3600*(context.getUTCHours()+1))/86.4;default:return m}}};$P.toString=function(format,ignoreStandards){if(!ignoreStandards&&format&&1===format.length){var output=parseStandardFormats.call(this,format);if(output)return output}var parseFormatStrings=parseFormatStringsClosure(this);return format?format.replace(/((\\)?(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|S|q|Q|WW?W?W?)(?![^\[]*\]))/g,parseFormatStrings).replace(/\[|\]/g,""):this._toString()}}(),function(){var $D=Date,$P=$D.prototype,$N=Number.prototype;$P._orient=1,$P._nth=null,$P._is=!1,$P._same=!1,$P._isSecond=!1,$N._dateElement="days",$P.next=function(){return this._move=!0,this._orient=1,this},$D.next=function(){return $D.today().next()},$P.last=$P.prev=$P.previous=function(){return this._move=!0,this._orient=-1,this},$D.last=$D.prev=$D.previous=function(){return $D.today().last()},$P.is=function(){return this._is=!0,this},$P.same=function(){return this._same=!0,this._isSecond=!1,this},$P.today=function(){return this.same().day()},$P.weekday=function(){return this._nth?df("Weekday").call(this):this._move?this.addWeekdays(this._orient):this._is?(this._is=!1,!this.is().sat()&&!this.is().sun()):!1},$P.weekend=function(){return this._is?(this._is=!1,this.is().sat()||this.is().sun()):!1},$P.at=function(time){return"string"==typeof time?$D.parse(this.toString("d")+" "+time):this.set(time)},$N.fromNow=$N.after=function(date){var c={};return c[this._dateElement]=this,(date?date.clone():new Date).add(c)},$N.ago=$N.before=function(date){var c={},s="s"!==this._dateElement[this._dateElement.length-1]?this._dateElement+"s":this._dateElement;return c[s]=-1*this,(date?date.clone():new Date).add(c)};var dx="sunday monday tuesday wednesday thursday friday saturday".split(/\s/),mx="january february march april may june july august september october november december".split(/\s/),px=[],pxf=[],nth="final first second third fourth fifth".split(/\s/),de;$P.toObject=function(){for(var o={},i=0;i<px.length;i++)this["get"+pxf[i]]&&(o[px[i].toLowerCase()]=this["get"+pxf[i]]());return o},$D.fromObject=function(config){return config.week=null,Date.today().set(config)};var df=function(n){return function(){if(this._is)return this._is=!1,this.getDay()===n;if(this._move&&(this._move=null),null!==this._nth){this._isSecond&&this.addSeconds(-1*this._orient),this._isSecond=!1;var ntemp=this._nth;this._nth=null;var temp=this.clone().moveToLastDayOfMonth();if(this.moveToNthOccurrence(n,ntemp),this>temp)throw new RangeError($D.getDayName(n)+" does not occur "+ntemp+" times in the month of "+$D.getMonthName(temp.getMonth())+" "+temp.getFullYear()+".");return this}return this.moveToDayOfWeek(n,this._orient)}},sdf=function(n){return function(){var t=$D.today(),shift=n-t.getDay();return(0===n&&1===Date.CultureInfo.firstDayOfWeek&&0!==t.getDay()||0>shift)&&(shift+=7),t.addDays(shift)}},month_instance_functions=function(n){return function(){return this._is?(this._is=!1,this.getMonth()===n):this.moveToMonth(n,this._orient)}},month_static_functions=function(n){return function(){return $D.today().set({month:n,day:1})}},processTerms=function(names,staticFunc,instanceFunc){for(var i=0;i<names.length;i++)$D[names[i].toUpperCase()]=$D[names[i].toUpperCase().substring(0,3)]=i,$D[names[i]]=$D[names[i].substring(0,3)]=staticFunc(i),$P[names[i]]=$P[names[i].substring(0,3)]=instanceFunc(i)};processTerms(dx,sdf,df),processTerms(mx,month_static_functions,month_instance_functions);for(var ef=function(j){return function(){if(this._isSecond)return this._isSecond=!1,this;if(this._same){this._same=this._is=!1;var o1=this.toObject(),o2=(arguments[0]||new Date).toObject(),v="",k=j.toLowerCase();k="s"===k[k.length-1]?k.substring(0,k.length-1):k;for(var m=px.length-1;m>-1;m--){if(v=px[m].toLowerCase(),o1[v]!==o2[v])return!1;if(k===v)break}return!0}return"s"!==j.substring(j.length-1)&&(j+="s"),this._move&&(this._move=null),this["add"+j](this._orient)}},nf=function(n){return function(){return this._dateElement=n,this}},k=0;k<px.length;k++)de=px[k].toLowerCase(),"weekday"!==de&&($P[de]=$P[de+"s"]=ef(px[k]),$N[de]=$N[de+"s"]=nf(de+"s"));$P._ss=ef("Second");for(var nthfn=function(n){return function(dayOfWeek){return this._same?this._ss(arguments[0]):dayOfWeek||0===dayOfWeek?this.moveToNthOccurrence(dayOfWeek,n):(this._nth=n,2!==n||void 0!==dayOfWeek&&null!==dayOfWeek?this:(this._isSecond=!0,this.addSeconds(this._orient)))}},l=0;l<nth.length;l++)$P[nth[l]]=nthfn(0===l?-1:l)}(),function(){Date.Parsing={Exception:function(s){this.message="Parse error at '"+s.substring(0,10)+" ...'"}};var $P=Date.Parsing,dayOffsets={standard:[0,31,59,90,120,151,181,212,243,273,304,334],leap:[0,31,60,91,121,152,182,213,244,274,305,335]};$P.isLeapYear=function(year){return year%4===0&&year%100!==0||year%400===0};var utils={multiReplace:function(str,hash){var key;for(key in hash)if(Object.prototype.hasOwnProperty.call(hash,key)){var regex;"function"==typeof hash[key]||(regex=hash[key]instanceof RegExp?hash[key]:new RegExp(hash[key],"g")),str=str.replace(regex,key)}return str},getDayOfYearFromWeek:function(obj){var d,jan4,offset;return obj.weekDay=obj.weekDay||0===obj.weekDay?obj.weekDay:1,d=new Date(obj.year,0,4),jan4=0===d.getDay()?7:d.getDay(),offset=jan4+3,obj.dayOfYear=7*obj.week+(0===obj.weekDay?7:obj.weekDay)-offset,obj},getDayOfYear:function(obj,dayOffset){obj.dayOfYear||(obj=utils.getDayOfYearFromWeek(obj));for(var i=0;i<=dayOffset.length;i++){if(obj.dayOfYear<dayOffset[i]||i===dayOffset.length){obj.day=obj.day?obj.day:obj.dayOfYear-dayOffset[i-1];break}obj.month=i}return obj},adjustForTimeZone:function(obj,date){var offset;return"Z"===obj.zone.toUpperCase()||0===obj.zone_hours&&0===obj.zone_minutes?offset=-date.getTimezoneOffset():(offset=60*obj.zone_hours+(obj.zone_minutes||0),"+"===obj.zone_sign&&(offset*=-1),offset-=date.getTimezoneOffset()),date.setMinutes(date.getMinutes()+offset),date},setDefaults:function(obj){return obj.year=obj.year||Date.today().getFullYear(),obj.hours=obj.hours||0,obj.minutes=obj.minutes||0,obj.seconds=obj.seconds||0,obj.milliseconds=obj.milliseconds||0,(obj.month||!obj.week&&!obj.dayOfYear)&&(obj.month=obj.month||0,obj.day=obj.day||1),obj},dataNum:function(data,mod,explict,postProcess){var dataNum=1*data;return mod?postProcess?data?1*mod(data):data:data?mod(dataNum):data:explict?data&&"undefined"!=typeof data?dataNum:data:data?dataNum:data},timeDataProcess:function(obj){var timeObj={};for(var x in obj.data)obj.data.hasOwnProperty(x)&&(timeObj[x]=obj.ignore[x]?obj.data[x]:utils.dataNum(obj.data[x],obj.mods[x],obj.explict[x],obj.postProcess[x]));return obj.data.secmins&&(obj.data.secmins=60*obj.data.secmins.replace(",","."),timeObj.minutes?timeObj.seconds||(timeObj.seconds=obj.data.secmins):timeObj.minutes=obj.data.secmins,delete obj.secmins),timeObj},buildTimeObjectFromData:function(data){var time=utils.timeDataProcess({data:{year:data[1],month:data[5],day:data[7],week:data[8],dayOfYear:data[10],hours:data[15],zone_hours:data[23],zone_minutes:data[24],zone:data[21],zone_sign:data[22],weekDay:data[9],minutes:data[16],seconds:data[19],milliseconds:data[20],secmins:data[18]},mods:{month:function(data){return data-1},weekDay:function(data){return data=Math.abs(data),7===data?0:data},minutes:function(data){return data.replace(":","")},seconds:function(data){return Math.floor(1*data.replace(":","").replace(",","."))},milliseconds:function(data){return 1e3*data.replace(",",".")}},postProcess:{minutes:!0,seconds:!0,milliseconds:!0},explict:{zone_hours:!0,zone_minutes:!0},ignore:{zone:!0,zone_sign:!0,secmins:!0}});return time},addToHash:function(hash,keys,data){keys=keys,data=data;for(var len=keys.length,i=0;len>i;i++)hash[keys[i]]=data[i];return hash},combineRegex:function(r1,r2){return new RegExp("(("+r1.source+")\\s("+r2.source+"))")},getDateNthString:function(add,last,inc){return add?Date.today().addDays(inc).toString("d"):last?Date.today().last()[inc]().toString("d"):void 0},buildRegexData:function(array){for(var arr=[],len=array.length,i=0;len>i;i++)arr.push(Array.isArray(array[i])?this.combineRegex(array[i][0],array[i][1]):array[i]);return arr
}};$P.processTimeObject=function(obj){var date,dayOffset;return utils.setDefaults(obj),dayOffset=$P.isLeapYear(obj.year)?dayOffsets.leap:dayOffsets.standard,obj.month||!obj.week&&!obj.dayOfYear?obj.dayOfYear=dayOffset[obj.month]+obj.day:utils.getDayOfYear(obj,dayOffset),date=new Date(obj.year,obj.month,obj.day,obj.hours,obj.minutes,obj.seconds,obj.milliseconds),obj.zone&&utils.adjustForTimeZone(obj,date),date},$P.Numeric={isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},regex:/\b([0-1]?[0-9])([0-3]?[0-9])([0-2]?[0-9]?[0-9][0-9])\b/i,parse:function(s){var data,i,time={},order=Date.CultureInfo.dateElementOrder.split("");if(!this.isNumeric(s)||"+"===s[0]&&"-"===s[0])return null;if(s.length<5&&s.indexOf(".")<0&&s.indexOf("/")<0)return time.year=s,$P.processTimeObject(time);if(data=s.match(this.regex),!data||!data.length)return null;for(i=0;i<order.length;i++)switch(order[i]){case"d":time.day=data[i+1];break;case"m":time.month=data[i+1]-1;break;case"y":time.year=data[i+1]}return $P.processTimeObject(time)}},$P.Normalizer={regexData:function(){var $R=Date.CultureInfo.regexPatterns;return utils.buildRegexData([$R.tomorrow,$R.yesterday,[$R.past,$R.mon],[$R.past,$R.tue],[$R.past,$R.wed],[$R.past,$R.thu],[$R.past,$R.fri],[$R.past,$R.sat],[$R.past,$R.sun]])},basicReplaceHash:function(){var $R=Date.CultureInfo.regexPatterns;return{January:$R.jan,February:$R.feb,March:$R.mar,April:$R.apr,May:$R.may,June:$R.jun,July:$R.jul,August:$R.aug,September:$R.sep,October:$R.oct,November:$R.nov,December:$R.dec,"":/\bat\b/gi," ":/\s{2,}/,"9am":$R.thisMorning,"7pm":$R.thisEvening}},keys:function(){return[utils.getDateNthString(!0,!1,1),utils.getDateNthString(!0,!1,-1),utils.getDateNthString(!1,!0,"monday"),utils.getDateNthString(!1,!0,"tuesday"),utils.getDateNthString(!1,!0,"wednesday"),utils.getDateNthString(!1,!0,"thursday"),utils.getDateNthString(!1,!0,"friday"),utils.getDateNthString(!1,!0,"saturday"),utils.getDateNthString(!1,!0,"sunday")]},buildRegexFunctions:function(){var $R=Date.CultureInfo.regexPatterns,__=Date.i18n.__,tomorrowRE=new RegExp("(\\b\\d\\d?("+__("AM")+"|"+__("PM")+")? )("+$R.tomorrow.source.slice(1)+")","i"),todayRE=new RegExp($R.today.source+"(?!\\s*([+-]))\\b");this.replaceFuncs=[[todayRE,function(full){return full.length>1?Date.today().toString("d"):full}],[tomorrowRE,function(full,m1){var t=Date.today().addDays(1).toString("d");return t+" "+m1}]]},buildReplaceData:function(){this.buildRegexFunctions(),this.replaceHash=utils.addToHash(this.basicReplaceHash(),this.keys(),this.regexData())},stringReplaceFuncs:function(s){for(var i=0;i<this.replaceFuncs.length;i++)s=s.replace(this.replaceFuncs[i][0],this.replaceFuncs[i][1]);return s},parse:function(s){s=this.stringReplaceFuncs(s),s=utils.multiReplace(s,this.replaceHash);try{var n=s.split(/([\s\-\.\,\/\x27]+)/);3===n.length&&$P.Numeric.isNumeric(n[0])&&$P.Numeric.isNumeric(n[2])&&n[2].length>=4&&"d"===Date.CultureInfo.dateElementOrder[0]&&(s="1/"+n[0]+"/"+n[2])}catch(e){}return s}},$P.Normalizer.buildReplaceData()}(),function(){for(var $P=Date.Parsing,_=$P.Operators={rtoken:function(r){return function(s){var mx=s.match(r);if(mx)return[mx[0],s.substring(mx[0].length)];throw new $P.Exception(s)}},token:function(){return function(s){return _.rtoken(new RegExp("^\\s*"+s+"\\s*"))(s)}},stoken:function(s){return _.rtoken(new RegExp("^"+s))},until:function(p){return function(s){for(var qx=[],rx=null;s.length;){try{rx=p.call(this,s)}catch(e){qx.push(rx[0]),s=rx[1];continue}break}return[qx,s]}},many:function(p){return function(s){for(var rx=[],r=null;s.length;){try{r=p.call(this,s)}catch(e){return[rx,s]}rx.push(r[0]),s=r[1]}return[rx,s]}},optional:function(p){return function(s){var r=null;try{r=p.call(this,s)}catch(e){return[null,s]}return[r[0],r[1]]}},not:function(p){return function(s){try{p.call(this,s)}catch(e){return[null,s]}throw new $P.Exception(s)}},ignore:function(p){return p?function(s){var r=null;return r=p.call(this,s),[null,r[1]]}:null},product:function(){for(var px=arguments[0],qx=Array.prototype.slice.call(arguments,1),rx=[],i=0;i<px.length;i++)rx.push(_.each(px[i],qx));return rx},cache:function(rule){var cache={},cache_length=0,cache_keys=[],CACHE_MAX=Date.Config.CACHE_MAX||500,r=null,cacheCheck=function(){if(cache_length===CACHE_MAX)for(var i=0;10>i;i++){var key=cache_keys.shift();key&&(delete cache[key],cache_length--)}};return function(s){cacheCheck();try{r=cache[s]=cache[s]||rule.call(this,s)}catch(e){r=cache[s]=e}if(cache_length++,cache_keys.push(s),r instanceof $P.Exception)throw r;return r}},any:function(){var px=arguments;return function(s){for(var r=null,i=0;i<px.length;i++)if(null!=px[i]){try{r=px[i].call(this,s)}catch(e){r=null}if(r)return r}throw new $P.Exception(s)}},each:function(){var px=arguments;return function(s){for(var rx=[],r=null,i=0;i<px.length;i++)if(null!=px[i]){try{r=px[i].call(this,s)}catch(e){throw new $P.Exception(s)}rx.push(r[0]),s=r[1]}return[rx,s]}},all:function(){var px=arguments,_=_;return _.each(_.optional(px))},sequence:function(px,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,1===px.length?px[0]:function(s){for(var r=null,q=null,rx=[],i=0;i<px.length;i++){try{r=px[i].call(this,s)}catch(e){break}rx.push(r[0]);try{q=d.call(this,r[1])}catch(ex){q=null;break}s=q[1]}if(!r)throw new $P.Exception(s);if(q)throw new $P.Exception(q[1]);if(c)try{r=c.call(this,r[1])}catch(ey){throw new $P.Exception(r[1])}return[rx,r?r[1]:s]}},between:function(d1,p,d2){d2=d2||d1;var _fn=_.each(_.ignore(d1),p,_.ignore(d2));return function(s){var rx=_fn.call(this,s);return[[rx[0][0],r[0][2]],rx[1]]}},list:function(p,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,p instanceof Array?_.each(_.product(p.slice(0,-1),_.ignore(d)),p.slice(-1),_.ignore(c)):_.each(_.many(_.each(p,_.ignore(d))),px,_.ignore(c))},set:function(px,d,c){return d=d||_.rtoken(/^\s*/),c=c||null,function(s){for(var r=null,p=null,q=null,rx=null,best=[[],s],last=!1,i=0;i<px.length;i++){q=null,p=null,r=null,last=1===px.length;try{r=px[i].call(this,s)}catch(e){continue}if(rx=[[r[0]],r[1]],r[1].length>0&&!last)try{q=d.call(this,r[1])}catch(ex){last=!0}else last=!0;if(last||0!==q[1].length||(last=!0),!last){for(var qx=[],j=0;j<px.length;j++)i!==j&&qx.push(px[j]);p=_.set(qx,d).call(this,q[1]),p[0].length>0&&(rx[0]=rx[0].concat(p[0]),rx[1]=p[1])}if(rx[1].length<best[1].length&&(best=rx),0===best[1].length)break}if(0===best[0].length)return best;if(c){try{q=c.call(this,best[1])}catch(ey){throw new $P.Exception(best[1])}best[1]=q[1]}return best}},forward:function(gr,fname){return function(s){return gr[fname].call(this,s)}},replace:function(rule,repl){return function(s){var r=rule.call(this,s);return[repl,r[1]]}},process:function(rule,fn){return function(s){var r=rule.call(this,s);return[fn.call(this,r[0]),r[1]]}},min:function(min,rule){return function(s){var rx=rule.call(this,s);if(rx[0].length<min)throw new $P.Exception(s);return rx}}},_generator=function(op){function gen(){var args=null,rx=[],px,i;return arguments.length>1?args=Array.prototype.slice.call(arguments):arguments[0]instanceof Array&&(args=arguments[0]),args?(px=args.shift(),px.length>0?(args.unshift(px[i]),rx.push(op.apply(null,args)),args.shift(),rx):void 0):op.apply(null,arguments)}return gen},gx="optional not ignore cache".split(/\s/),i=0;i<gx.length;i++)_[gx[i]]=_generator(_[gx[i]]);for(var _vector=function(op){return function(){return arguments[0]instanceof Array?op.apply(null,arguments[0]):op.apply(null,arguments)}},vx="each any all".split(/\s/),j=0;j<vx.length;j++)_[vx[j]]=_vector(_[vx[j]])}(),function(){var $D=Date,flattenAndCompact=function(ax){for(var rx=[],i=0;i<ax.length;i++)ax[i]instanceof Array?rx=rx.concat(flattenAndCompact(ax[i])):ax[i]&&rx.push(ax[i]);return rx},parseMeridian=function(){if(this.meridian&&(this.hour||0===this.hour)){if("a"===this.meridian&&this.hour>11&&Date.Config.strict24hr)throw"Invalid hour and meridian combination";if("p"===this.meridian&&this.hour<12&&Date.Config.strict24hr)throw"Invalid hour and meridian combination";"p"===this.meridian&&this.hour<12?this.hour=this.hour+12:"a"===this.meridian&&12===this.hour&&(this.hour=0)}else this.meridian||!this.hour&&0!==this.hour||this.hour<8&&(this.hour=this.hour+12)},setDefaults=function(){var now=new Date;!this.hour&&!this.minute||this.month||this.year||this.day||(this.day=now.getDate()),this.year||(this.year=now.getFullYear(),this.month<now.getMonth()&&this.year++),this.month||0===this.month||(this.month=now.getMonth()),this.day||(this.day=1),this.hour||(this.hour=0),this.minute||(this.minute=0),this.second||(this.second=0),this.millisecond||(this.millisecond=0)},finishUtils={getToday:function(){return this.now||-1!=="hour minute second".indexOf(this.unit)?new Date:$D.today()},setDaysFromWeekday:function(today,orient){var gap;return orient=orient||1,this.unit="day",gap=$D.getDayNumberFromName(this.weekday)-today.getDay(),this.days=gap?gap+7*orient:7*orient,this},setMonthsFromMonth:function(today,orient){var gap;return orient=orient||1,this.unit="month",gap=this.month-today.getMonth(),this.months=gap?(gap+12*orient)%12:12*orient,this.month=null,this},setDMYFromWeekday:function(){var d=Date[this.weekday]();return this.day=d.getDate(),this.month||(this.month=d.getMonth()),this.year=d.getFullYear(),this},setUnitValue:function(orient){!this.value&&this.operator&&null!==this.operator&&this[this.unit+"s"]&&null!==this[this.unit+"s"]?this[this.unit+"s"]=this[this.unit+"s"]+("add"===this.operator?1:-1)+(this.value||0)*orient:(null==this[this.unit+"s"]||null!=this.operator)&&(this.value||(this.value=1),this[this.unit+"s"]=this.value*orient)},generateDateFromWeeks:function(){var weekday=void 0!==this.weekday?this.weekday:"today",d=Date[weekday]().addWeeks(this.weeks);return this.now&&d.setTimeToNow(),d}};$D.Translator={hour:function(s){return function(){this.hour=Number(s),this.setExplicitTime=!0}},minute:function(s){return function(){this.minute=Number(s),this.setExplicitTime=!0}},second:function(s){return function(){this.second=Number(s),this.setExplicitTime=!0}},secondAndMillisecond:function(s){return function(){var mx=s.match(/^([0-5][0-9])\.([0-9]{1,3})/);this.second=Number(mx[1]),this.millisecond=Number(mx[2]),this.setExplicitTime=!0}},meridian:function(s){return function(){this.meridian=s.slice(0,1).toLowerCase(),this.setExplicitTime=!0}},timezone:function(s){return function(){var n=s.replace(/[^\d\+\-]/g,"");n.length?this.timezoneOffset=Number(n):this.timezone=s.toLowerCase()}},day:function(x){var s=x[0];return function(){if(this.day=Number(s.match(/\d+/)[0]),this.day<1)throw"invalid day"}},month:function(s){return function(){if(this.month=3===s.length?"jan feb mar apr may jun jul aug sep oct nov dec".indexOf(s)/4:Number(s)-1,this.month<0)throw"invalid month"}},year:function(s){return function(){var n=Number(s);this.year=s.length>2?n:n+(n+2e3<Date.CultureInfo.twoDigitYearMax?2e3:1900)}},rday:function(s){return function(){switch(s){case"yesterday":this.days=-1;break;case"someday":this.days=14;break;case"later":this.days=5;break;case"soon":this.days=2;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0,this.now=!0}}},finishExact:function(x){var d;x=x instanceof Array?x:[x];for(var i=0;i<x.length;i++)x[i]&&x[i].call(this);if(setDefaults.call(this),parseMeridian.call(this),this.day>$D.getDaysInMonth(this.year,this.month))throw new RangeError(this.day+" is not a valid value for days.");return d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond),this.setExplicitTime&&d.ensureTimeOfDay(),this.year<100&&d.setFullYear(this.year),this.timezone?d.set({timezone:this.timezone}):this.timezoneOffset&&d.set({timezoneOffset:this.timezoneOffset}),d},finish:function(x){var today,expression,orient,givenYean,temp;if(x=x instanceof Array?flattenAndCompact(x):[x],0===x.length)return null;for(var i=0;i<x.length;i++)"function"==typeof x[i]&&x[i].call(this);if(this.now&&!this.unit&&!this.operator)return new Date;if(today=finishUtils.getToday.call(this),givenYear=!!this.year,expression=!!(this.days&&null!==this.days||this.orient||this.operator),orient="past"===this.orient||"subtract"===this.operator?-1:1,this.month&&"week"===this.unit&&(this.value=this.month+1,delete this.month,delete this.day),!this.month&&0!==this.month||-1==="year day hour minute second".indexOf(this.unit)||(this.value||(this.value=this.month+1),this.month=null,expression=!0),expression||!this.weekday||this.day||this.days||finishUtils.setDMYFromWeekday.call(this),expression&&this.weekday&&"month"!==this.unit&&"week"!==this.unit&&finishUtils.setDaysFromWeekday.call(this,today,orient),!this.weekday||"week"===this.unit||this.day||this.days||(temp=Date[this.weekday](),this.day=temp.getDate(),temp.getMonth()!==today.getMonth()&&(this.month=temp.getMonth())),this.month&&"day"===this.unit&&this.operator&&(this.value||(this.value=this.month+1),this.month=null),null!=this.value&&null!=this.month&&null!=this.year&&(this.day=1*this.value),this.month&&!this.day&&this.value&&(today.set({day:1*this.value}),expression||(this.day=1*this.value)),this.month||!this.value||"month"!==this.unit||this.now||(this.month=this.value,expression=!0),expression&&(this.month||0===this.month)&&"year"!==this.unit&&finishUtils.setMonthsFromMonth.call(this,today,orient),this.unit||(this.unit="day"),finishUtils.setUnitValue.call(this,orient),parseMeridian.call(this),!this.month&&0!==this.month||this.day||(this.day=1),!this.orient&&!this.operator&&"week"===this.unit&&this.value&&!this.day&&!this.month)return Date.today().setWeek(this.value);if("week"===this.unit&&this.weeks&&!this.day&&!this.month)return finishUtils.generateDateFromWeeks.call(this);if(expression&&this.timezone&&this.day&&this.days&&(this.day=this.days),!givenYear&&this.month<today.getMonth()&&(this.year=today.getFullYear()+1),expression&&(this.hour||this.minute||this.second)&&(this.hours=this.hour,this.minutes=this.minute,this.seconds=this.second),expression?today.add(this):today.set(this),this.timezone){this.timezone=this.timezone.toUpperCase();var offset=$D.getTimezoneOffset(this.timezone),timezone;today.hasDaylightSavingTime()&&(timezone=$D.getTimezoneAbbreviation(offset,today.isDaylightSavingTime()),timezone!==this.timezone&&today.addHours(today.isDaylightSavingTime()?-1:1)),today.setTimezoneOffset(offset)}return today}}}(),function(){var $D=Date;$D.Grammar={};var _=$D.Parsing.Operators,g=$D.Grammar,t=$D.Translator,_fn;_fn=function(){return _.each(_.any.apply(null,arguments),_.not(g.ctoken2("timeContext")))},g.datePartDelimiter=_.rtoken(/^([\s\-\.\,\/\x27]+)/),g.timePartDelimiter=_.stoken(":"),g.whiteSpace=_.rtoken(/^\s*/),g.generalDelimiter=_.rtoken(/^(([\s\,]|at|@|on)+)/);var _C={};g.ctoken=function(keys){var fn=_C[keys];if(!fn){for(var c=Date.CultureInfo.regexPatterns,kx=keys.split(/\s+/),px=[],i=0;i<kx.length;i++)px.push(_.replace(_.rtoken(c[kx[i]]),kx[i]));fn=_C[keys]=_.any.apply(null,px)}return fn},g.ctoken2=function(key){return _.rtoken(Date.CultureInfo.regexPatterns[key])};var cacheProcessRtoken=function(key,token,type,eachToken){g[key]=_.cache(eachToken?_.process(_.each(_.rtoken(token),_.optional(g.ctoken2(eachToken))),type):_.process(_.rtoken(token),type))},cacheProcessCtoken=function(token,type){return _.cache(_.process(g.ctoken2(token),type))},_F={},_get=function(f){return _F[f]=_F[f]||g.format(f)[0],_F[f]};g.allformats=function(fx){var rx=[];if(fx instanceof Array)for(var i=0;i<fx.length;i++)rx.push(_get(fx[i]));else rx.push(_get(fx));return rx},g.formats=function(fx){if(fx instanceof Array){for(var rx=[],i=0;i<fx.length;i++)rx.push(_get(fx[i]));return _.any.apply(null,rx)}return _get(fx)};var grammarFormats={timeFormats:function(){var i,RTokenKeys=["h","hh","H","HH","m","mm","s","ss","ss.s","z","zz"],RToken=[/^(0[0-9]|1[0-2]|[1-9])/,/^(0[0-9]|1[0-2])/,/^([0-1][0-9]|2[0-3]|[0-9])/,/^([0-1][0-9]|2[0-3])/,/^([0-5][0-9]|[0-9])/,/^[0-5][0-9]/,/^([0-5][0-9]|[0-9])/,/^[0-5][0-9]/,/^[0-5][0-9]\.[0-9]{1,3}/,/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/,/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/],tokens=[t.hour,t.hour,t.hour,t.hour,t.minute,t.minute,t.second,t.second,t.secondAndMillisecond,t.timezone,t.timezone];for(i=0;i<RTokenKeys.length;i++)cacheProcessRtoken(RTokenKeys[i],RToken[i],tokens[i]);g.hms=_.cache(_.sequence([g.H,g.m,g.s],g.timePartDelimiter)),g.t=cacheProcessCtoken("shortMeridian",t.meridian),g.tt=cacheProcessCtoken("longMeridian",t.meridian),g.zzz=cacheProcessCtoken("timezone",t.timezone),g.timeSuffix=_.each(_.ignore(g.whiteSpace),_.set([g.tt,g.zzz])),g.time=_.each(_.optional(_.ignore(_.stoken("T"))),g.hms,g.timeSuffix)},dateFormats:function(){cacheProcessRtoken("d",/^([0-2]\d|3[0-1]|\d)/,t.day,"ordinalSuffix"),cacheProcessRtoken("dd",/^([0-2]\d|3[0-1])/,t.day,"ordinalSuffix"),g.rday=_.cache(_.process(g.ctoken("yesterday tomorrow soon later someday today now"),t.rday)),g.ddd=g.dddd=_.cache(_.process(g.ctoken("sun mon tue wed thu fri sat"),function(s){return function(){this.weekday=s}})),cacheProcessRtoken("M",/^(1[0-2]|0\d|\d)/,t.month),cacheProcessRtoken("MM",/^(1[0-2]|0\d)/,t.month),g.MMM=g.MMMM=_.cache(_.process(g.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),t.month)),cacheProcessRtoken("y",/^(\d+)/,t.year),cacheProcessRtoken("yy",/^(\d\d)/,t.year),cacheProcessRtoken("yyy",/^(\d\d?\d?\d?)/,t.year),cacheProcessRtoken("yyyy",/^(\d\d\d\d)/,t.year),g.day=_fn(g.d,g.dd),g.month=_fn(g.M,g.MMM),g.year=_fn(g.yyyy,g.yy);var _setfn=function(){return _.set(arguments,g.datePartDelimiter)};g.mdy=_setfn(g.ddd,g.month,g.day,g.year),g.ymd=_setfn(g.ddd,g.year,g.month,g.day),g.dmy=_setfn(g.ddd,g.day,g.month,g.year),g.date=function(s){return(g[Date.CultureInfo.dateElementOrder]||g.mdy).call(this,s)}},relative:function(){g.orientation=_.process(g.ctoken("past future"),function(s){return function(){this.orient=s}}),g.operator=_.process(g.ctoken("add subtract"),function(s){return function(){this.operator=s}})}};g.buildGrammarFormats=function(){_C={},grammarFormats.timeFormats(),grammarFormats.dateFormats(),grammarFormats.relative(),g.value=_.process(_.rtoken(/^([-+]?\d+)?(st|nd|rd|th)?/),function(s){return function(){this.value=s.replace(/\D/g,"")}}),g.expression=_.set([g.rday,g.time,g.value,g.orientation,g.ddd,g.MMM]),g.format=_.process(_.many(_.any(_.process(_.rtoken(/^(dd?d?d?(?!e)|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(fmt){if(g[fmt])return g[fmt];throw $D.Parsing.Exception(fmt)}),_.process(_.rtoken(/^[^dMyhHmstz]+/),function(s){return _.ignore(_.stoken(s))}))),function(rules){return _.process(_.each.apply(null,rules),t.finishExact)}),g._start=_.process(_.set([g.date,g.expression,g.time],g.generalDelimiter,g.whiteSpace),t.finish)},g.buildGrammarFormats(),g._formats=g.formats(["M-d H","ddd H"]),g.start=function(s){try{var r=g._formats.call({},s);if(0===r[1].length)return r}catch(e){}return g._start.call({},s)}}(),function(){function parse(s){var d;return s?s instanceof Date?s.clone():(s.length>=4&&"0"!==s.charAt(0)&&"+"!==s.charAt(0)&&"-"!==s.charAt(0)&&(d=$D.Parsing.Numeric.parse(s)),d instanceof Date&&!isNaN(d.getTime())?d:(s=$D.Parsing.Normalizer.parse(parseUtils.removeOrds(s)),d=parseUtils.grammarParser(s))):null}var $D=Date,parseUtils={removeOrds:function(s){var ords=s.match(/\b(\d+)(?:st|nd|rd|th)\b/);return s=ords&&2===ords.length?s.replace(ords[0],ords[1]):s},grammarParser:function(s){var r=null;try{r=$D.Grammar.start.call({},s.replace(/^\s*(\S*(\s+\S+)*)\s*$/,"$1"))}catch(e){return null}return 0===r[1].length?r[0]:null}};$D._parse||($D._parse=$D.parse),$D.parse=parse,Date.getParseFunction=function(fx){var fns=Date.Grammar.allformats(fx);return function(s){for(var r=null,i=0;i<fns.length;i++){try{r=fns[i].call({},s)}catch(e){continue}if(0===r[1].length)return r[0]}return null}},$D.parseExact=function(s,fx){return $D.getParseFunction(fx)(s)}}(),function(){var $D=Date,$P=$D.prototype,p=function(s,l){return l||(l=2),("000"+s).slice(-1*l)},normalizer={substitutes:function(m){switch(m){case"d":case"%d":return"dd";case"D":case"%a":return"ddd";case"j":case"l":case"%A":return"dddd";case"S":return"S";case"F":case"%B":return"MMMM";case"m":case"%m":return"MM";case"M":case"%b":case"%h":return"MMM";case"n":return"M";case"Y":case"%Y":return"yyyy";case"y":case"%y":return"yy";case"g":case"%I":return"h";case"G":return"H";case"h":return"hh";case"H":case"%H":return"HH";case"i":case"%M":return"mm";case"s":case"%S":return"ss";case"%r":return"hh:mm tt";case"%R":return"H:mm";case"%T":return"H:mm:ss";case"%X":return"t";case"%x":case"%e":return"d";case"%D":return"MM/dd/yy";case"%n":return"\\n";case"%t":return"\\t";case"e":case"T":case"%z":case"%Z":return"z";case"Z":return"ZZ";case"N":case"w":case"%w":return"u";case"W":case"%V":return"W"}},interpreted:function(m,x){var y;switch(m){case"%u":return x.getDay()+1;case"z":return x.getOrdinalNumber();case"%j":return p(x.getOrdinalNumber(),3);case"%U":var d1=x.clone().set({month:0,day:1}).addDays(-1).moveToDayOfWeek(0),d2=x.clone().addDays(1).moveToDayOfWeek(0,-1);return d1>d2?"00":p((d2.getOrdinalNumber()-d1.getOrdinalNumber())/7+1);case"%W":return p(x.getWeek());case"t":return $D.getDaysInMonth(x.getFullYear(),x.getMonth());case"o":case"%G":return x.setWeek(x.getISOWeek()).toString("yyyy");case"%g":return x._format("%G").slice(-2);case"a":case"%p":return t("tt").toLowerCase();case"A":return t("tt").toUpperCase();case"u":return p(x.getMilliseconds(),3);case"I":return x.isDaylightSavingTime()?1:0;case"O":return x.getUTCOffset();case"P":return y=x.getUTCOffset(),y.substring(0,y.length-2)+":"+y.substring(y.length-2);case"B":var now=new Date;return Math.floor((3600*now.getHours()+60*now.getMinutes()+now.getSeconds()+60*(now.getTimezoneOffset()+60))/86.4);case"c":return x.toISOString().replace(/\"/g,"");case"U":return $D.strtotime("now");case"%c":return t("d")+" "+t("t");case"%C":return Math.floor(x.getFullYear()/100+1)}},shouldOverrideDefaults:function(m){switch(m){case"%e":return!0;default:return!1}},parse:function(m,context){var formatString,c=context||new Date;return(formatString=normalizer.substitutes(m))?formatString:(formatString=normalizer.interpreted(m,c),formatString?formatString:m)}};$D.normalizeFormat=function(format,context){return format.replace(/(%|\\)?.|%%/g,function(t){return normalizer.parse(t,context)})},$D.strftime=function(format,time){var d=Date.parse(time);return d._format(format)},$D.strtotime=function(time){var d=$D.parse(time);return Math.round($D.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds(),d.getUTCMilliseconds())/1e3)};var formatReplace=function(context){return function(m){var formatString,override=!1;return"\\"===m.charAt(0)||"%%"===m.substring(0,2)?m.replace("\\","").replace("%%","%"):(override=normalizer.shouldOverrideDefaults(m),formatString=$D.normalizeFormat(m,context),formatString?context.toString(formatString,override):void 0)}};$P._format=function(format){var formatter=formatReplace(this);return format?format.replace(/(%|\\)?.|%%/g,formatter):this._toString()},$P.format||($P.format=$P._format)}(),function(){var gFn=function(attr){return function(){return this[attr]}},sFn=function(attr){return function(val){return this[attr]=val,this}},attrs=["years","months","days","hours","minutes","seconds","milliseconds"],addSetFuncs=function(context,attrs){for(var i=0;i<attrs.length;i++){var $a=attrs[i],$b=$a.slice(0,1).toUpperCase()+$a.slice(1);context.prototype[$a]=0,context.prototype["get"+$b]=gFn($a),context.prototype["set"+$b]=sFn($a)}},TimeSpan=function(days,hours,minutes,seconds,milliseconds){if(1===arguments.length&&"number"==typeof days){var orient=0>days?-1:1,millsLeft=Math.abs(days);this.setDays(Math.floor(millsLeft/864e5)*orient),millsLeft%=864e5,this.setHours(Math.floor(millsLeft/36e5)*orient),millsLeft%=36e5,this.setMinutes(Math.floor(millsLeft/6e4)*orient),millsLeft%=6e4,this.setSeconds(Math.floor(millsLeft/1e3)*orient),millsLeft%=1e3,this.setMilliseconds(millsLeft*orient)}else this.set(days,hours,minutes,seconds,milliseconds);return this.getTotalMilliseconds=function(){return 864e5*this.getDays()+36e5*this.getHours()+6e4*this.getMinutes()+1e3*this.getSeconds()},this.compareTo=function(time){var t1=new Date(1970,1,1,this.getHours(),this.getMinutes(),this.getSeconds()),t2;return t2=null===time?new Date(1970,1,1,0,0,0):new Date(1970,1,1,time.getHours(),time.getMinutes(),time.getSeconds()),t2>t1?-1:t1>t2?1:0},this.equals=function(time){return 0===this.compareTo(time)},this.add=function(time){return null===time?this:this.addSeconds(time.getTotalMilliseconds()/1e3)},this.subtract=function(time){return null===time?this:this.addSeconds(-time.getTotalMilliseconds()/1e3)},this.addDays=function(n){return new TimeSpan(this.getTotalMilliseconds()+864e5*n)},this.addHours=function(n){return new TimeSpan(this.getTotalMilliseconds()+36e5*n)},this.addMinutes=function(n){return new TimeSpan(this.getTotalMilliseconds()+6e4*n)},this.addSeconds=function(n){return new TimeSpan(this.getTotalMilliseconds()+1e3*n)},this.addMilliseconds=function(n){return new TimeSpan(this.getTotalMilliseconds()+n)},this.get12HourHour=function(){return this.getHours()>12?this.getHours()-12:0===this.getHours()?12:this.getHours()},this.getDesignator=function(){return this.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator},this.toString=function(format){this._toString=function(){return null!==this.getDays()&&this.getDays()>0?this.getDays()+"."+this.getHours()+":"+this.p(this.getMinutes())+":"+this.p(this.getSeconds()):this.getHours()+":"+this.p(this.getMinutes())+":"+this.p(this.getSeconds())},this.p=function(s){return s.toString().length<2?"0"+s:s};var me=this;return format?format.replace(/dd?|HH?|hh?|mm?|ss?|tt?/g,function(format){switch(format){case"d":return me.getDays();case"dd":return me.p(me.getDays());case"H":return me.getHours();case"HH":return me.p(me.getHours());case"h":return me.get12HourHour();case"hh":return me.p(me.get12HourHour());case"m":return me.getMinutes();case"mm":return me.p(me.getMinutes());case"s":return me.getSeconds();case"ss":return me.p(me.getSeconds());case"t":return(me.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator).substring(0,1);case"tt":return me.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator}}):this._toString()},this};addSetFuncs(TimeSpan,attrs.slice(2)),TimeSpan.prototype.set=function(days,hours,minutes,seconds,milliseconds){this.setDays(days||this.getDays()),this.setHours(hours||this.getHours()),this.setMinutes(minutes||this.getMinutes()),this.setSeconds(seconds||this.getSeconds()),this.setMilliseconds(milliseconds||this.getMilliseconds())},Date.prototype.getTimeOfDay=function(){return this.getMilliseconds()+1e3*this.getSeconds()+6e4*this.getMinutes()+36e5*this.getHours()},Date.prototype.hasTimeOfDay=function(){return 0!==this.getHours()||0!==this.getMinutes()||0!==this.getSeconds()||0!==this.getMilliseconds()},Date.prototype.isRepeatDate=function(){return!1},Date.TimeSpan=TimeSpan,"undefined"!=typeof window&&(window.TimeSpan=TimeSpan)}(),function(){var attrs=["years","months","days","hours","minutes","seconds","milliseconds"],gFn=function(attr){return function(){return this[attr]}},sFn=function(attr){return function(val){return this[attr]=val,this}},addSetFuncs=function(context,attrs){for(var i=0;i<attrs.length;i++){var $a=attrs[i],$b=$a.slice(0,1).toUpperCase()+$a.slice(1);context.prototype[$a]=0,context.prototype["get"+$b]=gFn($a),context.prototype["set"+$b]=sFn($a)}},setMonthsAndYears=function(orient,d1,d2,context){function inc(){d1.addMonths(-orient),context.months++,12===context.months&&(context.years++,context.months=0)}if(1===orient)for(;d1>d2;)inc();else for(;d2>d1;)inc();context.months--,context.months*=orient,context.years*=orient},adjustForDST=function(orient,startDate,endDate){var hasDSTMismatch=!1==(startDate.isDaylightSavingTime()===endDate.isDaylightSavingTime());hasDSTMismatch&&1===orient?startDate.addHours(-1):hasDSTMismatch&&startDate.addHours(1)},TimePeriod=function(years,months,days,hours,minutes,seconds,milliseconds){if(7===arguments.length)this.set(years,months,days,hours,minutes,seconds,milliseconds);else if(2===arguments.length&&arguments[0]instanceof Date&&arguments[1]instanceof Date){var startDate=arguments[0].clone(),endDate=arguments[1].clone(),orient=startDate>endDate?1:-1;this.dates={start:arguments[0].clone(),end:arguments[1].clone()},setMonthsAndYears(orient,startDate,endDate,this),adjustForDST(orient,startDate,endDate);var diff=endDate-startDate;if(0!==diff){var ts=new TimeSpan(diff);this.set(this.years,this.months,ts.getDays(),ts.getHours(),ts.getMinutes(),ts.getSeconds(),ts.getMilliseconds())}}return this};addSetFuncs(TimePeriod,attrs),TimePeriod.prototype.set=function(years,months,days,hours,minutes,seconds,milliseconds){this.setYears(years||this.getYears()),this.setMonths(months||this.getMonths()),this.setDays(days||this.getDays()),this.setHours(hours||this.getHours()),this.setMinutes(minutes||this.getMinutes()),this.setSeconds(seconds||this.getSeconds()),this.setMilliseconds(milliseconds||this.getMilliseconds())},Date.TimePeriod=TimePeriod,"undefined"!=typeof window&&(window.TimePeriod=TimePeriod)}(),define("date",function(){});var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(view){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},URL=view.URL||view.webkitURL||view,save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=doc.createEvent("MouseEvents");event.initMouseEvent("click",!0,!1,view,0,0,0,0,0,!1,!1,!1,!1,0,null),node.dispatchEvent(event)},webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},force_saveable_type="application/octet-stream",fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){for(var i=deletion_queue.length;i--;){var file=deletion_queue[i];"string"==typeof file?URL.revokeObjectURL(file):file.remove()}deletion_queue.length=0},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},FileSaver=function(blob,name){var filesaver=this,type=blob.type,blob_changed=!1,object_url,target_view,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);return deletion_queue.push(object_url),object_url},dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){(blob_changed||!object_url)&&(object_url=get_object_url(blob)),target_view?target_view.location.href=object_url:window.open(object_url,"_blank"),filesaver.readyState=filesaver.DONE,dispatch_all()},abortable=function(func){return function(){return filesaver.readyState!==filesaver.DONE?func.apply(this,arguments):void 0}},create_if_not_found={create:!0,exclusive:!1},slice;return filesaver.readyState=filesaver.INIT,name||(name="download"),can_use_save_link?(object_url=get_object_url(blob),save_link.href=object_url,save_link.download=name,click(save_link),filesaver.readyState=filesaver.DONE,void dispatch_all()):(view.chrome&&type&&type!==force_saveable_type&&(slice=blob.slice||blob.webkitSlice,blob=slice.call(blob,0,blob.size,force_saveable_type),blob_changed=!0),webkit_req_fs&&"download"!==name&&(name+=".download"),(type===force_saveable_type||webkit_req_fs)&&(target_view=view),req_fs?(fs_min_size+=blob.size,void req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL(),deletion_queue.push(file),filesaver.readyState=filesaver.DONE,dispatch(filesaver,"writeend",event)
},writer.onerror=function(){var error=writer.error;error.code!==error.ABORT_ERR&&fs_error()},"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]}),writer.write(blob),filesaver.abort=function(){writer.abort(),filesaver.readyState=filesaver.DONE},filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:!1},abortable(function(file){file.remove(),save()}),abortable(function(ex){ex.code===ex.NOT_FOUND_ERR?save():fs_error()}))}),fs_error)}),fs_error)):void fs_error())},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name)};return FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE,dispatch(filesaver,"abort")},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,view.addEventListener("unload",process_deletion_queue,!1),saveAs}(self);define("FileSaver",function(){}),define("globals",["ko","platform","Constants","util","RingBuffer","IScroll","date","FileSaver"],function(ko,platform,C,util,RingBuffer,IScroll){function murmurhash3_32_gc(key,seed){var remainder,bytes,h1,h1b,c1,c2,k1,i;for(remainder=3&key.length,bytes=key.length-remainder,h1=seed,c1=3432918353,c2=461845907,i=0;bytes>i;)k1=255&key.charCodeAt(i)|(255&key.charCodeAt(++i))<<8|(255&key.charCodeAt(++i))<<16|(255&key.charCodeAt(++i))<<24,++i,k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1,h1=h1<<13|h1>>>19,h1b=5*(65535&h1)+((5*(h1>>>16)&65535)<<16)&4294967295,h1=(65535&h1b)+27492+(((h1b>>>16)+58964&65535)<<16);switch(k1=0,remainder){case 3:k1^=(255&key.charCodeAt(i+2))<<16;case 2:k1^=(255&key.charCodeAt(i+1))<<8;case 1:k1^=255&key.charCodeAt(i),k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1}return h1^=key.length,h1^=h1>>>16,h1=2246822507*(65535&h1)+((2246822507*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>13,h1=3266489909*(65535&h1)+((3266489909*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>16,h1>>>0}function sanitizePaneState(stateObj){try{for(var stateOut=JSON.parse(JSON.stringify(stateObj)),i=0;i<stateOut.length;++i)""!==stateOut[i].search&&(stateOut[i].search="HasSearch");return JSON.stringify(stateOut)}catch(err){return"Failed to sanitize pane state"}}function sanitizeLocalSettings(settingsIn){try{var settingsOut=JSON.parse(settingsIn);return delete settingsOut.values.Default.paneState,delete settingsOut.values.Default.gdocTitle,settingsOut}catch(err){return"Failed to parse settings"}}function sanitizeKey(keyIn){switch(keyIn){case KeyCode.BackSpace:return"BACKSPACE";case KeyCode.Delete:return"DELETE";case KeyCode.Enter:return"ENTER";case KeyCode.Escape:return"ESCAPE";default:return"CHAR"}}function sanitizeURL(url){return url.replace(/&?access_token=[^&]*/g,"")}function getExtraReportData(info){platform.getUserPlatformConfig(info)}function rollbarIgnoreFn(isUncaught,args,payload){return payload&&payload.data&&payload.data.body&&payload.data.body.trace&&payload.data.body.trace.frames&&payload.data.body.trace.frames[0]&&rollbarIgnoreFiles.indexOf(payload.data.body.trace.frames[0].filename)>=0?!0:!1}function generateRemoteDebugKey(){var user=self.settings.get(Settings.activeUser);return user?"MooDoRDebug"+(new Date).getTime()+"_"+user:"Unknown"}function wrapFn(func){function wrapper(){try{return func.apply(this,arguments)}catch(err){self.reportError(err)}}return wrapper}function tagEvent(e,info,handlers){e.id||(e.id=eventID++)}function createClickEle(x,y,color){var ele=document.createElement("div");ele.style.position="fixed",ele.style.width="10px",ele.style.height="10px",ele.style.left=x-5+"px",ele.style.top=y-5+"px",ele.style.backgroundColor=color,document.documentElement.appendChild(ele)}function fnCatch(cb){try{self.PAssert(2599,cb,"Must specify a callback")}catch(PERR){self.reportError(PERR)}return function dbgCatch(){try{if(cb)return cb.apply(void 0,arguments)}catch(err){self.reportError(err,arguments)}}}function deepEqual(x,y){return x&&y&&"object"==typeof x&&"object"==typeof y?Object.keys(x).length===Object.keys(y).length&&Object.keys(x).reduce(function(isEqual,key){return isEqual&&x[key]===y[key]},!0):x===y}function handleAPILoadRequest(prevData,result){try{self.PAssert(2605,prevData.isLoaded===!1,"Must not be loading the same API multiple times")}catch(PERR){self.reportError(PERR)}if(result&&result.error){if(2===prevData.numRetries)for(var i=0;i<prevData.timeoutCBs.length;++i)try{prevData.timeoutCBs[i]()}catch(err){self.reportError(err)}prevData.numRetries++,prevData.lastTimeout=retryTimeouts[prevData.numRetries]||3e3,prevData.timer=setTimeout(function(){prevData.timer=void 0,window.gapi.client.load(prevData.api,prevData.version,handleAPILoadRequest.bind(window,prevData))},1e3*prevData.lastTimeout)}else{for(var i=0;i<prevData.successCBs.length;++i)try{prevData.successCBs[i]()}catch(err){self.reportError(err)}prevData.successCBs=[],prevData.timeoutCBs=[],prevData.isLoaded=!0}}function readyStateCallback(e,callback,error){e.onloadDone=!1,e.onload=function(){e.onloadDone=!0,callback&&callback()},e.onreadystatechange=function(){"loaded"!==e.readyState||e.onloadDone||(e.onloadDone=!0,callback&&callback())},error&&(e.onerror=error)}function makeString(args){for(var str="",i=0;i<args.length;++i)str+=" "+self.safeStringify(args[i]);return str}function isItemValidForPass(item,isTest){return item?isTest?item.lastFindPass===currentFindPass:item.lastFindPass<currentFindPass:!1}function markItemForPass(item,isTest){if(item){var isItemValid=isItemValidForPass(item,isTest);try{self.PAssert(2687,isItemValid,"Item should always be valid")}catch(PERR){self.reportError(PERR)}return item.lastFindPass=currentFindPass,isItemValid}return!1}function _getPreviousItem(item,pane,options){var found,isTest=options&&options.isTest,ignoreSearch=options&&options.ignoreSearch,sameLevel=options&&options.sameLevel,includeNotes=options&&options.includeNotes;if(!markItemForPass(item,isTest))return void 0;var prev=item.parent();if(!prev)return void 0;if(item.isNote())return item.parent();var index=prev.getChildIndex(item);if(index>0)for(;!found;){for(var newChild=!1,i=index-1;i>=0;i--){var prevChild=prev.getChild(i),isChildValid=markItemForPass(prevChild,isTest);if(!isChildValid){try{self.PAssert(2689,!1,"Invalid child found during findPreviousItem")}catch(PERR){self.reportError(PERR)}return void 0}if(sameLevel||!prevChild.hasChildren()||pane&&prevChild.isCollapsed(pane,!1)){if(ignoreSearch||!pane||!prevChild.isHidden(pane,!1)){found=prevChild,newChild=!0;break}}else if(ignoreSearch||!pane||!prevChild.isHidden(pane,!1)){prev=prevChild,index=prevChild.numChildren(),newChild=!0;break}}if(sameLevel)break;newChild||(found=prev)}else sameLevel||(found=item.parent());includeNotes&&found&&found.hasNote()&&(found=found.getNote());try{self.PAssert(2690,!sameLevel||!found||found.parent()===item.parent(),"Previous item must share the same parent")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2691,isTest||!found||pane&&found.isCollapsed(pane,!1)||item===_getNextItem(found,pane,{isTest:!0,ignoreSearch:ignoreSearch,sameLevel:sameLevel}),"Previous/Next should always match")}catch(PERR){self.reportError(PERR)}return found}function _getNextItem(item,pane,options){var next,isTest=options&&options.isTest,ignoreSearch=options&&options.ignoreSearch,sameLevel=options&&options.sameLevel,includeNotes=options&&options.includeNotes;if(!item)return void 0;if(includeNotes&&item.hasNote())return item.getNote();if(item.isNote()&&(item=item.parent()),!(sameLevel||!item.hasChildren()||pane&&item.isCollapsed(pane,!1)))for(var numChildren=item.numChildren(),i=0;numChildren>i;++i){var candidate=item.getChild(i),isChildValid=markItemForPass(candidate,isTest);if(!isChildValid){try{self.PAssert(2693,!1,"Invalid child found during findNextItem A")}catch(PERR){self.reportError(PERR)}return void 0}if(ignoreSearch||!pane||!candidate.isHidden(pane,!1)){next=candidate,options&&options.numLevels++;break}}for(var cItem=item;!next;){var isParentValid=markItemForPass(cItem,isTest);if(!isParentValid){try{self.PAssert(2694,!1,"Invalid parent found during findNextItem B")}catch(PERR){self.reportError(PERR)}break}var parent=cItem.parent();if(!parent)break;var index=parent.getChildIndex(cItem),numChildren=parent.numChildren();if(!pane||!parent.isCollapsed(pane,!1))for(var i=index+1;numChildren>i;++i){var candidate=parent.getChild(i),isChildValid=markItemForPass(candidate,isTest);if(!isChildValid){try{self.PAssert(2696,!1,"Invalid child found during findNextItem C")}catch(PERR){self.reportError(PERR)}return void 0}if(ignoreSearch||!pane||!candidate.isHidden(pane,!1)){next=candidate;break}}if(cItem=parent,options&&!next&&options.numLevels--,sameLevel||pane&&cItem===pane.getItem())break}try{self.PAssert(2697,!sameLevel||!next||next.parent()===item.parent(),"Next item must share the same parent")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2698,isTest||!next||item===_getPreviousItem(next,pane,{isTest:!0,ignoreSearch:ignoreSearch,sameLevel:sameLevel}),"Previous/Next should always match")}catch(PERR){self.reportError(PERR)}return next}function performScroll(){var minSpeed=0,maxSpeedAdd=6;if(lastState.pane){var delta=minSpeed+maxSpeedAdd*lastState.speed,changed=lastState.pane.addScrollDelta(delta);runScroll&&changed?requestAnimationFrame(performScroll):(lastState.speed=0,lastState.pane=void 0,runScroll=!1)}}function addScrollPadding(element){if(element){var scrollObj=self.dataFor(element);scrollObj&&scrollObj.addPadding&&scrollObj.addPadding()}}function searchVMLIArray(options,array,depth){for(var pane=options.pane,noCollapsed=options.noCollapsed,overview=options.overview,i=0;i<array.length;++i){var item=array[i];if(!options.headers||item.showInOverview(options.includeArchived)){if((!options.comparator||options.comparator(item))&&options.each){var ret=options.each(item);if(ret===!1)return!1}overview&&!isNaN(options.collapseAfterDepth)&&(depth<options.collapseAfterDepth&&1===pane.getPerPaneState(item.id,PerPaneStateField.CollapsedOverview)?pane.setPerPaneState(item.id,PerPaneStateField.CollapsedOverview,void 0):depth>=options.collapseAfterDepth&&void 0===pane.getPerPaneState(item.id,PerPaneStateField.CollapsedOverview)&&pane.setPerPaneState(item.id,PerPaneStateField.CollapsedOverview,1)),noCollapsed&&item.isCollapsed(pane,overview)||searchFromVMLI(item,options,depth+1)}}}function searchFromVMLI(startItem,options,depth){depth=depth||0;var ret;options.includeNotes&&!options.headers&&startItem.hasNote()&&(!options.comparator||options.comparator(startItem.getNote()))&&options.each&&(ret=options.each(startItem.getNote())),ret!==!1&&(ret=searchVMLIArray(options,startItem.items.get(),depth),ret!==!1&&options.includeArchived&&startItem.hasArchivedChildren()&&searchVMLIArray(options,startItem.archivedItems(!0),depth))}function getMapping(obj,map){try{self.PAssert(2768,"string"!=typeof obj,"Should only pass objects to the obj mapping function",obj)}catch(PERR){self.reportError(PERR)}var target={};for(var i in obj){try{self.PAssert(2769,obj.hasOwnProperty(i),"This should always be the case, the prototype shouldn't be extended")}catch(PERR){self.reportError(PERR)}if(void 0!==obj[i]&&null!==obj[i]){var mappedField=map[i];if(mappedField)target[mappedField]=obj[i];else{try{self.PAssert(2770,!1,"Incoming field should be added to the field map",i)}catch(PERR){self.reportError(PERR)}target[i]=obj[i]}}}return target}function fireKeyEventInternal(ele,etype,key){try{self.PAssert(2781,void 0!==key,"Must pass in valid key data to type")}catch(PERR){self.reportError(PERR)}if(ele||(ele=Sel.getStartElement()),document.createEvent&&ele){var eventObj=document.createEvent("Event");eventObj.normCode=key.normCode,eventObj.shiftKey=!!key.shiftKey,eventObj.altKey=!!key.altKey,eventObj.ctrlKey=!!key.ctrlKey,eventObj.metaKey=!!key.metaKey,eventObj.synthetic=!0,eventObj.initEvent(etype,!0,!0),ele.dispatchEvent(eventObj)}else if(ele)try{self.PAssert(2782,!1,"Unable to fire key event")}catch(PERR){self.reportError(PERR)}else try{self.PAssert(2783,!1,"No element available to fire key event on")}catch(PERR){self.reportError(PERR)}}function fireClickEventInternal(ele,etype,button,optData){try{self.PAssert(2784,void 0!==button,"Must pass in a valid button to click with")}catch(PERR){self.reportError(PERR)}if(ele||(ele=NativeSel.getSelectionNode()),document.createEvent&&ele){var evObj=document.createEvent("Event");if(evObj.button=button,evObj.synthetic=!0,optData)for(var id in optData)evObj[id]=optData[id];evObj.initEvent(etype,!0,!0),ele.dispatchEvent(evObj)}else if(ele)try{self.PAssert(2785,!1,"Unable to fire click event")}catch(PERR){self.reportError(PERR)}else try{self.PAssert(2786,!1,"No element available to fire click event on")}catch(PERR){self.reportError(PERR)}}function loadDone(){document.removeEventListener("DOMContentLoaded",loadDone,!1),window.removeEventListener("load",loadDone,!1);for(var i=0;i<onLoadCallbacks.length;++i)onLoadCallbacks[i]();onLoadCallbacks=void 0}function generateQueryString(data){var queryString="";if("object"==typeof data){var queryArr=[];for(var key in data)queryArr[queryArr.length]=encodeURIComponent(key)+"="+encodeURIComponent(data[key]);queryString=queryArr.join("&").replace(/%20/g,"+")}else{try{self.PAssert(2820,"string"==typeof data,"Only Objects or Strings are currently supported")}catch(PERR){self.reportError(PERR)}queryString=data}return queryString}function ensureStatsXHR(url){var sanitizedURL=sanitizeURL(url),baseURL=sanitizedURL.split("?")[0];return __xhrRequests[baseURL]||(__xhrRequests[baseURL]={requests:0,retries:0,failures:0}),__xhrRequests[baseURL]}function notifyStatsXHRRequest(url){var stats=ensureStatsXHR(url);stats.requests++}function notifyStatsXHRRetry(url){var stats=ensureStatsXHR(url);stats.retries++}function notifyStatsXHRFailure(url){var stats=ensureStatsXHR(url);stats.failures++}function notifyXHR(xhr){var notifier;if(notifier=shouldNotifyXHR(xhr.url)){xhr.iid=idXHR++;var _rsc=xhr.onreadystatechange;xhr.onreadystatechange=function(){_rsc&&_rsc.apply(xhr,arguments),notifier(xhr)}}}function shouldNotifyXHR(url){return url?notifyURLs[url.split("?")[0]]:!1}function shouldSetXHRTimeout(xhr){var shouldSetTimeout=!1;if(xhr&&xhr.url){var URLMatch=xhr.url.split("?")[0];timeoutURLs.indexOf(URLMatch)>=0&&(shouldSetTimeout=!0)}return shouldSetTimeout}var self={vmMain:void 0,vmDebug:void 0,topBarHeight:platform.android?48:44,agendaPadding:34,archivedPadding:34,keyboardToolbarHeight:40,maxPaneWidth:900,minPaneWidth:400,itemTransitionTime:100,iOSDragTime:400,iOSDragTimeKeyboardOpen:200,overviewWidthPerc:.85,scrollbarWidth:12,hasFocus:!0,zoomTime:0,demoMode:!1,intro:void 0,focusedPane:void 0,focusedItem:void 0,ClickThreshold:5,isFirstRun:!1,isReconnected:!1,noLocalWrites:!1,isLoadingRemote:!1,isSendingEmail:!1,isSavingDrafts:!1,isKeyboardOpen:!1,itemMenuOpenedOn:void 0,errorPlatformInfo:void 0,nativeBacklog:[],nativeBridge:{sendToApp:function(method,data){self.nativeBacklog.push({method:method,data:data})}},elements:{},SPThresholdLeft:8,SPThresholdRight:42,MobileSideTapThreshold:40,MobileSideTapThresholdKeyboardOpen:15,minItemHeight:32,colorBlue:"#09d",colorLightBlue:"#02b1ff",colorRed:"#d43",colorLightRed:"#f34433",MinItemWidth:50};self.paneTop=platform.mobile?self.topBarHeight:38,self.overviewPaddingStart=12,self.overviewPaddingIncrement=18;var android={isEnabled:function(){return!!platform.android}},VMLI,VMPane,NativeSel,Sel;require(["android","VMLI","VMPane","NativeSel","Sel"],function(droidLoad,VMLILoad,VMPaneLoad,NativeSelLoad,SelLoad){android=droidLoad,VMLI=VMLILoad,VMPane=VMPaneLoad,NativeSel=NativeSelLoad,Sel=SelLoad}),window.ScrollDuration={Snap:0,Default:200,Slow:500},window.KeyCode={BackSpace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,LeftArrow:37,UpArrow:38,RightArrow:39,DownArrow:40,Delete:46,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D8:56,Colon:58,LAngle:60,RAngle:62,At:64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LeftMeta:91,RightMeta:93,NumPlus:107,F1:112,F4:115,F12:123,Equals:187,Comma:188,Dash:189,Period:190,Slash:191,Tilde:192,LBracket:219,RBracket:221,Apos:222},window.ButtonCode={None:-1,Left:0,Middle:1,Right:2},window.Direction={Up:-1,None:0,Down:1},window.TextSpace="﻿",window.AttachChar=" ",window.EmbedAttachChar=" ",window.DriveStatus={Offline:0,Connecting:1,Saving:2,Saved:3,Reconnecting:4},window.PaneMode={Outline:"PaneOutline",Timeline:"PaneTimeline",Archived:"PaneArchived",Drive:"PaneDrive",Gmail:"PaneGmail"},window.MessageAction={Default:0,Reload:1,LoginScreen:2,Demo:3,ResetClient:4,None:5,SyncContacts:6,OpenURL:7,Okay:8,Blog:9,Undo:10,Contact:11,OpenSettings:12,OpenAccountSettings:13,OpenGoogleDrive:14,OpenDisplaySettings:15,StartDemo:16,OpenLinkedSettings:17},window.MessageType={Info:0,Warning:1,Error:2,Fatal:3,Subtitle:4,Intro:5,RequiredUpdate:6,InfoGray:7},window.MessageID={Undefined:0,ConnectionError:1,OfflineUndo:2,FatalError:3,DocChange:4,OfflineWarn:5,OnlineInfo:6,CacheReset:7,RequiredUpdate:8,Updated:9,SyncContacts:10,ExitDemo:11,Reauthorize:12,ShareFailure:13,ThisIsDemo:14,MailbirdClick:15,InviteFailure:16,InviteSuccess:17,PremiumRequired:18,TrialOver:19,TrialEndSoon:20,DisabledFolderDrop:21,WarnLargeFile:22,InviteInvalid:23,NoSharingWarning:24,LostPermission:25,CalendarSync:26,CalendarListSync:27,EmailSendFail:28,EmailUpdateFail:29,EmailLabelFail:30,EmailSyncFail:31,OldUserNewTrial:32,DemoPluginClick:33,PromptScriptStart:34,SnoozeOffline:35,NeedDrivePermission:36,NeedGmailPermission:37,LostLinked:38,GmailDisabled:39,LocalWritesDisabled:40},window.VMLIFlag={None:0,Header:1,Collapsed:2,Selected:4,Highlighted:8,NumList:16,Note:32,Multiline:64,Archived:128,Complete:4096,P2:8192,P1:16384,P0:32768,Starred:65536,HasPageToken:131072,DisplayComplete:262144},window.UninitializedVersion=-1,window.VersionType={Structure:1,Text:2},window.SaveFlag={None:0,Prop:1,Text:2,All:3},window.RepeatFreq={Once:0,Daily:1,Weekly:2,Monthly:3,DayOfMonth:4,Yearly:5,EndOfMonthOffset:6,NthMonthInst:7},window.DateType={Once:1,Repeat:2},window.ChangeType={None:0,Local:1,Remote:2,Auto:4,Structure:33554432,Text:67108864,Property:134217728,Rollover:1048576,UndoRedo:2097152,PluginLoad:4194304,All:234881024,AllLocal:234881025,AllRemote:234881026,Valid:242221063},window.StorageType={InMemory:1,LocalStorage:2,IndexedDB:3},window.LoginState={NONE:0,LOGGED_OUT:1,LOGGED_IN:2},window.ReturnValue={Success:0,Error:1,FatalError:2},window.OAuthSchemeType={Invalid:-1,None:0,Web:1,Native:2,Count:2},window.ACProvider={None:0,Contact:1,DatePicker:2,DateList:3,Tag:4,Search:5},window.DataSource={Paste:1,Drop:2,Plugin:3},window.PluginID={Moodo:"Moodo",Contacts:"Contacts",Drive:"Drive",Mailbird:"Mailbird",Gmail:"Gmail",GCalendar:"GCalendar"},window.PluginSettingsID={},window.PluginLoad={None:0,Preview:1,Full:2,Runtime:4,Autocomplete:8},window.PluginDependency={DemoMode:"DemoMode",DriveAPI:"DriveAPI",GmailAPI:"GmailAPI",CalendarAPI:"CalendarAPI",GoogleLogin:"GoogleLogin",PremiumSub:"PremiumSub",EarlyAccess:"EarlyAccess",LocalLoaded:"LocalLoaded"},window.PluginRenderTypes={Generic:0,StyledText:1,UnstyledText:2,AutocompleteText:3,AgendaEntry:4,Measure:5},window.PluginRenderers={Unknown:-1,DriveFile:0,EmailThread:1,CalendarEvent:2},window.PerPaneStateField={Element:"element",OverviewElement:"oelement",Collapsed:"collapsed",CollapsedOverview:"collapsedOverview",CollapsedSearch:"collapsedSearch",NumLines:"numLines",NumLinesOverview:"numLinesOverview"},window.Modals={ReportBug:"reportBug",ImportData:"importData",ExportData:"exportData",RevisionHistory:"revisionHistory",ShareDoc:"shareDoc",MobileSettings:"mobileSettings",Settings:"settings",Confirm:"confirm",Alert:"alert",Options:"options",Billing:"billing",DeleteAccount:"deleteAccount",EmailPreview:"emailPreview",ReportProblem:"reportProblem",Welcome:"welcome",EmailReply:"emailReply"},window.PremiumStatus={Unknown:0,Never:1,Trial:2,TrialOver:3,Active:4,PastDue:5,CanceledUser:6,CanceledPastDue:7},function(){function ec(code){return code}window.PrivateAPIErrorCodes={Success:0,UnknownFailure:ec(1),Unexpected:ec(2),DatabaseReadError:ec(3),DatabaseWriteError:ec(4),MissingParameter:ec(5),InvalidParameter:ec(6),UnauthorizedUser:ec(7),ErrorSendingEmail:ec(8),AlreadyReferred:ec(9),ErrorContactingRemote:ec(10),BraintreeUnknown:ec(11),InvalidToken:ec(12),InvalidReferralCode:ec(13),NoSignupFound:ec(14),TrialOver:ec(15)}}(),window.DataChangeType={Add:1,Remove:2,Change:3},window.SearchResultStatus={Done:1,TooMany:2,None:3,Error:4},window.Settings={theme:"theme",syncContacts:"syncContacts",lastContactSync:"lastContactSync",lastTaskSync:"lastTaskSync",disableNotifications:"disableNotifications",rootFolderId:"rootFolderId",attachFolderId:"attachFolderId",authScopes:"authScopes",localIntegrity:"localIntegrity",localDataVersion:"localDataVersion",localRecoverVersion:"localRecoverVersion",shownTutorial:"shownTutorial",gdocId:"gdocId",gdocTitle:"gdocTitle",activeUser:"activeUser",userId:"userId",displayName:"displayName",noSounds:"noSounds",lastServerVersion:"lastServerVersion",helpPaneState:"helpPaneState",closedImport:"closedImport",oauthScheme:"oauthScheme",premiumStatus:"zzp",enableOfflineAuth:"enableOfflineAuth",trialStart:"pzs",trialDuration:"pzd",premiumEndDate:"ped",notifiedTrialOver:"notifiedTrialOver",notifiedTrialEndSoon:"notifiedTrialEndSoon",trialOverHidden:"trialOverHidden",showBullets:"showBullets",bulletColor:"bulletColor",showVerticalLines:"showVerticalLines",verticalLinesColor:"verticalLinesColor",boldHeaders:"boldHeaders",itemPadding:"itemPadding",notePadding:"notePadding",itemLineHeight:"itemLineHeight",noteLineHeight:"noteLineHeight",itemIndentSize:"itemIndentSize",fontSize:"fontSize",noteFontSize:"noteFontSize",tagColor:"tagColor",dateColor:"dateColor",contactColor:"contactColor",linkColor:"linkColor",underlineP:"underlineP",layoutTheme:"layoutTheme",grayscale:"grayscale",helpState:"helpState"},self.inMaskOnly=function inMaskOnlyFn(data,mask){return 0===(~mask&data)},self.isFlagSet=function isFlagSetFn(data,mask){return(data&mask)===mask},self.isOneFlagSet=function isOneFlagSetFn(data,mask){var mmv=data&mask;return 0!==mmv&&0===(mmv&mmv-1)},self.isAtLeastOneFlagSet=function isAtLeastOneFlagSetFn(data,mask){return 0!==(data&mask)},self.forEachFlagSet=function forEachFlagSetFn(data,fn){for(;0!==data;){var flag=Math.abs(data&-data);fn(flag),data&=data-1}},self.PCMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Complete,self.PMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2,self.fieldMapIn={isArchived:"a",dateCreated:"c",date:"d",duration:"e",formats:"f",durationText:"g",favorites:"h",items:"i",isNote:"k",modifiedOffline:"l",isCollapsed:"m",note:"n",modifiedOfflineText:"o",priority:"p",repeatDate:"r",dateText:"s",text:"t",versionText:"u",version:"v",isDeleted:"x",isComplete:"z",archivedItems:"ai",allDayDate:"ad",id:"id",isStarred:"*",dateCompleted:"^"},self.priorityMapOut={},self.priorityMapOut[VMLIFlag.None]=" ",self.priorityMapOut[VMLIFlag.P0]=" p0",self.priorityMapOut[VMLIFlag.P1]=" p1",self.priorityMapOut[VMLIFlag.P2]=" p2",window.NumListPrefix="#.",window.NumListPrefixOther="1.",window.DatePrefix="@",window.ContactPrefix="+",window.TagPrefix="#";var charMapHTML={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};self.escape=function escapeFn(text){return String(text).replace(/[&\"<>]/g,function(c){return charMapHTML[c]})},self.escapeRegExp=function escapeRegExpFn(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},self.stripTagsBasic=function stripTagsBasicFn(str){return str.replace(/<.*>/g,"")},self.trimPunc=function trimPuncFn(str){return str.replace(/[:,\.\'\"\)\]]$/g,"")},self.getTransitionClass=function getTransitionClassFn(time){var trans;switch(time){case 50:trans="trans05";break;case 100:trans="trans1";break;case 200:trans="trans2";break;case 300:trans="trans3";break;case 400:trans="trans4";break;case 500:trans="trans5";break;case 1e3:trans="trans10";break;default:console.log("ERROR: no time for ",time)}return trans},self.setTransformStyle=function setTransformStyleFn(element,x,y){try{self.PAssert(2549,element,"Must provide a valid element")}catch(PERR){self.reportError(PERR)}if(element){try{self.PAssert(2550,void 0!==x,"Must supply a valid X offset")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2551,void 0!==y,"Must supply a valid Y offset")}catch(PERR){self.reportError(PERR)}element.style[platform.transform.style]=platform.ie?"translate("+x+"px, "+y+"px)":"translate3d("+x+"px, "+y+"px, 0px)"}},self.setTransitionStyle=function setTransitionStyleFn(element,property,time,easing){try{self.PAssert(2552,element,"Must provide a valid element")}catch(PERR){self.reportError(PERR)}element&&(easing=easing||"ease",element.style[platform.transition.style]=property+" "+time+"ms "+easing,setTimeout(function(){element.style[platform.transition.style]=""},time))};var IE_ANIM_WORKAROUND=!1;self.setTransform=function setTransformFn(element,x,y,time,easing){time>0?IE_ANIM_WORKAROUND?self.setTransformStyle(element,x,y):(self.setTransitionStyle(element,platform.transform.prop,time,easing),self.setTransformStyle(element,x,y)):x||y?self.setTransformStyle(element,x,y):element.style[platform.transform.style]="none"},self.reload=function reloadFn(forceFetch){try{self.PAssert(2553,!appCacheUpdating,"Page should not be reloaded while waiting for an appcache update to finish.")}catch(PERR){self.reportError(PERR)}appCacheUpdating&&self.reportError(new Error("Page requesting reload while waiting for AppCache update.")),window.location.reload(forceFetch)},self.isSetupPageOpen=!1,self.isMainPageOpen=!1,self.openMainPage=function openMainPageFn(){self.isSetupPageOpen&&(self.isSetupPageOpen=!1),self.isMainPageOpen||(self.isMainPageOpen=!0);var outer=document.getElementById("outerWrapper"),setup=document.getElementById("setupWrapper");outer&&setup&&(self.removeClass(outer,"none"),self.addClass(setup,"none"))},self.openSetupPage=function openSetupPageFn(){self.isMainPageOpen&&(self.isMainPageOpen=!1),self.addClass(document.getElementById("outerWrapper"),"none"),self.removeClass(document.getElementById("setupWrapper"),"none")};var wasAppCacheUpdated=!1,appCacheUpdating=!1;self.setAppCacheUpdateState=function setAppCacheUpdateStateFn(state){appCacheUpdating=state,state&&(wasAppCacheUpdated=!0)},self.isEmpty=function isEmptyFn(object){for(var i in object)return!1;return!0},self.isEmail=function isEmailFn(string){var isEmail=!1;if(string){var regex=new RegExp(/\S+@\S+\.\S+/i),results=regex.exec(string);isEmail=!!results}return isEmail},self.removeDOM=function removeDOMFn(id){var domElem=document.getElementById(id);try{self.PAssert(2554,domElem,"DOM Element must exist to remove it")}catch(PERR){self.reportError(PERR)}domElem&&domElem.parentNode.removeChild(domElem)},self.isRunningScript=function isRunningScriptFn(){return self.AScript&&self.AScript.isRunning};var isOffline=!1;self.goOnline=function goOnlineFn(){isOffline=!1},self.goOffline=function goOfflineFn(){isOffline=!0},self.isOffline=function isOfflineFn(){return isOffline},self.preventLocalWrites=function preventLocalWritesFn(){ShouldLog(LogLevels.Warning)&&log("---- WARNING: Local Writes Disabled ----"),self.noLocalWrites=!0},self.shouldWriteLocal=function shouldWriteLocalFn(){return!self.noLocalWrites},self.enableDemoMode=function enableDemoModeFn(){self.demoMode=!0;var dmode=util.getURLParam("dmode");dmode&&self.runOnLoad(function(){self.enableMinMode(dmode)}),self.preventLocalWrites()},self.isDemoMode=function isDemoModeFn(){return self.demoMode},window.DisplayMode={Default:0,InIframe:1,NoPaneHeaders:2,Invisible:4,NoScrollbars:8,NoBackground:16,NoPaneTop:32,NoInteraction:64,NoPanePadding:128,NoPaneStyle:256,NoRightClick:512,ShowDemoExit:1024,PromptStart:4096,FullMin:8191},self.activeDisplayMode=DisplayMode.Default,self.isDisplayModeActive=function isDisplayModeActiveFn(mode){return(self.activeDisplayMode&mode)===mode},self.isDemoInIframe=function isDemoInIframeFn(){return this.isDisplayModeActive(DisplayMode.InIframe)},self.enableMinMode=function enableMinModeFn(mode){try{if(self.addClass(document.body,"minMode"),self.isMinMode=!0,mode=parseInt(mode),platform.touch||(mode&DisplayMode.InIframe&&self.addClass(document.documentElement,"inIframe"),mode&DisplayMode.Invisible&&self.addClass(document.documentElement,"invisible"),mode&DisplayMode.NoPaneHeaders&&self.addClass(document.body,"noPaneHeaders"),mode&DisplayMode.NoPaneTop&&self.addClass(document.body,"noPaneTopBox"),mode&DisplayMode.NoPaneStyle&&self.addClass(document.body,"noPaneStyle")),mode&DisplayMode.NoPanePadding&&(self.addClass(document.body,"noPanePadding"),self.noPanePadding=!0),mode&DisplayMode.NoScrollbars&&(self.noScrollbars=!0),mode&DisplayMode.NoBackground&&self.addClass(document.documentElement,"noBackground"),mode&DisplayMode.NoInteraction){var outer=document.getElementById("outerWrapper"),div=document.createElement("div");div.id="preventInteraction",outer.appendChild(div),mode&DisplayMode.PromptStart&&self.setupClick(div,void 0,function(){var msg=self.toasts.getMessageById(MessageID.PromptScriptStart);msg&&(msg.doAction(),msg.hide())})}mode&DisplayMode.ShowDemoExit&&setTimeout(function(){self.toasts.pushMessage(MessageID.ExitDemo)},0),mode&DisplayMode.PromptStart&&setTimeout(function(){self.toasts.pushMessage(MessageID.PromptScriptStart)},0),self.activeDisplayMode=mode}catch(err){self.reportError(err)}},self.setDimension=function setDimensionFn(name,value){window.ga&&!self.isDemoMode()&&ga("set",name,value)},self.sendEvent=function sendEventFn(category,action,value){try{self.PAssert(2555,void 0===value||self.isNumber(value),"Values must be numeric")}catch(PERR){self.reportError(PERR)}if(window.ga&&!self.isDemoMode())try{ga("send","event",category,action,self.getAnonUserIdentifier(),value)}catch(err){self.reportError(err,"Category: "+category+" Action: "+action+" Value: "+value)}},self.sendTimeEvent=function sendTimeEventFn(category,variable,value){try{self.PAssert(2556,self.isNumber(value),"Values must be numeric")}catch(PERR){self.reportError(PERR)}if(window.ga&&!self.isDemoMode())try{ga("send","timing",category,variable,value,self.getAnonUserIdentifier())}catch(err){self.reportError(err,"Category: "+category+" Variable: "+variable+" Value: "+value)}};var currentTimeEvent;self.startTimeEvent=function startTimeEventFn(category,variable){if(window.log&&window.log.now){try{self.PAssert(2557,void 0===currentTimeEvent,"This function needs to be updated to allow nested timing events")}catch(PERR){self.reportError(PERR)}currentTimeEvent={startTime:log.now(),category:category,variable:variable}}},self.endTimeEvent=function endTimeEventFn(){if(window.log&&window.log.now){try{self.PAssert(2558,void 0!==currentTimeEvent,"Must have started a timing event")}catch(PERR){self.reportError(PERR)}if(currentTimeEvent){var elapsedTime=log.now()-currentTimeEvent.startTime;self.sendTimeEvent(currentTimeEvent.category,currentTimeEvent.variable,elapsedTime),currentTimeEvent=void 0}}};var aggregateEvents={};self.registerEvent=function registerEventFn(name,category,action){try{self.PAssert(2559,!aggregateEvents.hasOwnProperty(name),"Should only register an event once")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2560,void 0!==name,"Must specify a name for the event")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2561,void 0!==category,"Must specify a category for the event")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2562,void 0!==action,"Must specify an action for the event")}catch(PERR){self.reportError(PERR)}var registerEvent={category:category,action:action,label:self.getAnonUserIdentifier(),count:0};aggregateEvents[name]=registerEvent},self.aggregateEvent=function aggregateEventFn(name,count){try{self.PAssert(2563,aggregateEvents.hasOwnProperty(name),"Must register an event before using it")
}catch(PERR){self.reportError(PERR)}void 0===count&&(count=1),aggregateEvents[name]&&(aggregateEvents[name].count+=count)};var isPageDataCleared=!1;self.pageDataCleared=function pageDataClearedFn(){isPageDataCleared=!0},self.onunload=function onunloadFn(){log("Unloading the page");try{for(var evName in aggregateEvents){var ev=aggregateEvents[evName];self.sendEvent(ev.category,ev.action,ev.count),ev.count=0}self.vmMain&&self.vmMain.failedGapiLoad?self.sendEvent("ScriptLoad","GapiFailed"):gapiCalled||self.sendEvent("ScriptLoad","GapiNotLoaded");var Dispatcher=require("Dispatcher");if(Dispatcher&&Dispatcher.fireEvent("onUnload",[]),self.vmMain&&self.vmMain.paneManager.updatePaneScrollState(),isPageDataCleared)self.vmMain&&self.vmMain.pluginManager&&self.vmMain.pluginManager.onShutdown(!1);else{self.vmMain&&self.vmMain.pluginManager&&self.vmMain.pluginManager.onShutdown(!0);try{var gdata=require("gdata");gdata&&self.settings&&self.settings.set(Settings.lastServerVersion,gdata.getServerVersion())}catch(err){}}if(self.isLoadingRemote)return"We are still syncing your changes. Do you still want to quit?";if(self.isSendingEmail)return"Some emails have not been sent. Closing Moo.do will stop them from sending. Do you still want to quit?";if(self.isSavingDrafts)return"Your drafts are still being saved. Do you still want to quit?"}catch(errOutside){self.reportError(errOutside)}},platform.demo||(window.onbeforeunload=self.onunload);var lastSetLoginState=LoginState.LOGGED_OUT;self.getLoginState=function getLoginStateFn(){var state=lastSetLoginState;if(self.shouldWriteLocal())try{var savedState=util.storage.getItem("loginState");null!==savedState&&void 0!==savedState&&(state=parseInt(savedState))}catch(err){self.reportError(err)}try{self.PAssert(2564,state===LoginState.NONE||state===LoginState.LOGGED_OUT||state===LoginState.LOGGED_IN,"Invalid login state set")}catch(PERR){self.reportError(PERR)}return state},self.setLoginState=function setLoginStateFn(value){try{self.PAssert(2565,null!==value&&void 0!==value&&!isNaN(value),"Should always be a valid LoginState enum value")}catch(PERR){self.reportError(PERR)}if(lastSetLoginState=value,self.shouldWriteLocal())try{(isNaN(value)||null===value||void 0===value)&&(value=LoginState.LOGGED_OUT);try{self.PAssert(2566,value===LoginState.NONE||value===LoginState.LOGGED_OUT||value===LoginState.LOGGED_IN,"Invalid login state set")}catch(PERR){self.reportError(PERR)}util.storage.setItem("loginState",value)}catch(err){self.reportError(err)}};var noSync,syncReport,snapshots;self.applyBindings=function applyBindingsFn(model,eleID){var elem=document.getElementById(eleID);try{self.PAssert(2582,model,"A valid model must be defined when apply bindings")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2583,elem,"A valid element must be defined when apply bindings")}catch(PERR){self.reportError(PERR)}if(elem&&model)try{ko.applyBindings(model,elem)}catch(err){throw err.message+=" | Binding on: "+self.elementToString(elem),self.reportError(err),err}else{var errStr="Invalid model or element passed to applyBindings | ";errStr+=elem?"NoModel - Elem: "+self.elementToString(elem):model?"NoElem - Elem: #"+eleID:"NoModelNoElem - Elem: #"+eleID,self.reportError(new Error(errStr))}},ko.bindingHandlers.load={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel,context){try{self.PAssert(2584,viewModel,"Must always be passing in a valid view model to load - "+self.elementToString(element))}catch(PERR){self.reportError(PERR)}try{self.PAssert(2585,viewModel.onLoad,"If no load function is specified, remove the binding from the template - "+self.elementToString(element))}catch(PERR){self.reportError(PERR)}var pIndex=context.$parents.length-2,paneRoot;pIndex>=0&&(paneRoot=context.$parents[pIndex]),viewModel&&viewModel.onLoad&&viewModel.onLoad(element,paneRoot)}},ko.bindingHandlers.check={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){var obs=valueAccessor();obs()&&self.addClass(element,"checked"),self.setupClick(element,viewModel,{onClick:function onClickFn(e){obs(!obs()),obs()?self.addClass(element,"checked"):self.removeClass(element,"checked"),e.preventDefault(),e.stopPropagation()}})},update:function updateFn(element,valueAccessor){var obs=valueAccessor();obs()?self.addClass(element,"checked"):self.removeClass(element,"checked")}};var onRippleTap={timeout:0,onStart:function onStartFn(e){e.pressedAlready||(this.pressed=!0,e.pressedAlready=!0,this.timeout=setTimeout(function(){self.addClass(this,"pressed"),this.pressed||setTimeout(function(){self.removeClass(this,"pressed")}.bind(this),60)}.bind(this),120))},onFirstMove:function onFirstMoveFn(){this.pressed&&(clearTimeout(this.timeout),self.removeClass(this,"pressed"),this.pressed=!1)},onEnd:function onEndFn(){this.pressed&&(self.removeClass(this,"pressed"),this.pressed=!1)}};ko.bindingHandlers.ripple={init:function initFn(element){self.setupClick(element,void 0,onRippleTap)}},ko.bindingHandlers.tap={init:function initFn(element,valueAccessor,allBindingsAccessor,viewModel){self.setupClick(element,viewModel,valueAccessor())}},ko.bindingHandlers.stopBinding={init:function initFn(){return{controlsDescendantBindings:!0}}},ko.bindingHandlers.tooltip={init:function initFn(element,valueAccessor){platform.mobile||self.setupMouseOver(element,ko.utils.unwrapObservable(valueAccessor()),!1)},update:function updateFn(element,valueAccessor){platform.mobile||self.setupMouseOver(element,ko.utils.unwrapObservable(valueAccessor()),!0)}},self.setupMouseOver=function setupMouseOverFn(element,value,isUpdate){try{self.PAssert(2586,!platform.mobile)}catch(PERR){self.reportError(PERR)}self.tooltip?isUpdate?self.tooltip.update(element,value):self.tooltip.register(element,value):self.reportError(new Error("Tooltips registered before VMTooltip created"))},"function"!=typeof String.prototype.startsWith&&(Object.defineProperty?Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function valueFn(searchString,position){return position=position||0,this.lastIndexOf(searchString,position)===position}}):String.prototype.startsWith=function(str){return 0===this.lastIndexOf(str,0)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(str){return-1!==this.indexOf(str,this.length-str.length)}),"function"!=typeof String.prototype.prevIndexOf&&(String.prototype.prevIndexOf=function(ch,offset){for(var idx=-1,i=offset-1;i>=0;--i)if(this[i]===ch){idx=i;break}return idx}),ko.bindingHandlers.css2=ko.bindingHandlers.css,self.findFirstDiff=function findFirstDiffFn(str1,str2,ignoreCase,preferFirst){if(!str1)return preferFirst?0:str2.length;if(!str2)return preferFirst?str1.length:0;for(var minLen=Math.min(str1.length,str2.length),i=0;minLen>i;++i)if(ignoreCase){if(str1.charAt(i).toLowerCase()!==str2.charAt(i).toLowerCase())return i}else if(str1.charAt(i)!==str2.charAt(i))return i;return preferFirst?str1.length:str2.length},self.findMatchingLength=function findMatchingLengthFn(str1,str2,ignoreCase){if(!str1||!str2)return 0;for(var minLen=Math.min(str1.length,str2.length),i=0;minLen>i;++i)if(ignoreCase){if(str1.charAt(i).toLowerCase()!==str2.charAt(i).toLowerCase())return i}else if(str1.charAt(i)!==str2.charAt(i))return i;return minLen},self.TEMP_PREFIX="~T^";var idx=0;self.generateTempId=function generateTempIdFn(){return self.TEMP_PREFIX+Date.now()+ ++idx},self.isTempId=function isTempIdFn(id){return id&&id[0]===self.TEMP_PREFIX[0]&&id[1]===self.TEMP_PREFIX[1]&&id[2]===self.TEMP_PREFIX[2]},self.isLocalItem=function isLocalItemFn(item){try{self.PAssert(2587,item.id,"All items should have an ID even if it is a temp one")}catch(PERR){self.reportError(PERR)}return self.isTempId(item.id)},self.requestNotification=function requestNotificationFn(platform){var reqForm=document.forms.requestNotification,reqResult=document.getElementById("notificationResult"),email=reqForm.email.value;return void 0===email||null===email||email.length<5?reqResult.innerText="Please enter a valid email address.":self.XHR_PrivateAPI({type:"POST",path:"/feedback/notification",data:{email:email,platform:platform},cb:function cbFn(xhr){200===xhr.status?(reqForm.email.value="",reqResult.innerText="Thanks for your interest!"):reqResult.innerText="There was an error processing your request, please try again in a few minutes."}}),!1};var cachedID;self.getUserIdentifier=function getUserIdentifierFn(){if(!cachedID){var goog=require("goog"),user=(goog?goog.getCurrentUserEmail():void 0)||(self.settings?self.settings.get(Settings.activeUser):void 0);if(!user)return"me";cachedID=user}return cachedID};var anonID;self.getAnonUserIdentifier=function getAnonUserIdentifierFn(){if(!anonID){var userID=self.getUserIdentifier();anonID=userID[0]+userID[1]+userID[2]+murmurhash3_32_gc(userID,17124123)}return anonID},self.getLoadedScripts=function getLoadedScriptsFn(obj){try{for(var scriptElements=document.getElementsByTagName("script"),scripts=[],i=0;i<scriptElements.length;++i){var ele=scriptElements[i];ele.src&&scripts.push(ele.src)}obj.loadedScripts=scripts}catch(err){obj.loadedScripts="ERROR: "+err.message}},self.getAppStats=function getAppStatsFn(obj){if(obj.numPanes=window.__TOTAL_PANES,obj.numItems=window.__TOTAL_ITEMS,obj.numArchivedItems=window.__TOTAL_ARCHIVED_ITEMS,obj.numArchiveParents=window.__TOTAL_ARCHIVE_PARENTS,obj.parseTextCalls=window.__PARSE_STATS,obj.notificationUpdatesFull=window.__FULL_NOTIFICATION_UPDATES,obj.notificationUpdatesSingle=window.__SINGLE_NOTIFICATION_UPDATES,obj.XHRStats=self.getXHRStats(),self.vmMain&&self.vmMain.pluginManager){try{obj.pluginStats=self.vmMain.pluginManager.getStats()}catch(err){obj.pluginStats="Error: "+err.message}try{obj.pluginState=self.vmMain.pluginManager.getState()}catch(err){obj.pluginState="Error: "+err.message}}if(self.vmMain&&self.vmMain.recurringTaskManager)try{obj.taskStats=self.vmMain.recurringTaskManager.getStats()}catch(err){obj.taskStats="Error: "+err.message}if(DETAILED_STATS)try{obj.previewCacheStats=require("gdata").getPreviewCacheStats()}catch(err){obj.previewCacheStats="Error: "+err.message}try{obj.measureStats=require("Measure").getMeasureStats()}catch(err){obj.measureStats="Error: "+err.message}},self.getRunningState=function getRunningStateFn(obj){var paneState;try{paneState=self.vmMain.paneManager.getPaneState()}catch(err){log("Failed to get paneState")}obj.isDebug=!1,obj.isDemo=self.isDemoMode(),obj.localWrites=self.shouldWriteLocal(),obj.currentLocalWrites=function(){try{util.storage.setItem("poke",Math.random())}catch(err){return!1}return!0},obj.isReconnected=self.isReconnected,obj.url=sanitizeURL(window.location.href),obj.paneState=sanitizePaneState(paneState),obj.localSettings=self.settings?sanitizeLocalSettings(self.settings.getRawSettings()):"Not Initialized",obj.loginState=self.getLoginState(),obj.checkpoints=window.__checkpoints,obj.gapiLoadError=gapiLoadError,obj.DOMReadyState=document.readyState,obj.isKeyboardOpen=self.isKeyboardOpen,obj.jsVersion=window.__jsVersion,obj.htmlVersion=document&&document.body?document.body.getAttribute("ver"):"UNKNOWN",obj.windowWidth=window.innerWidth,obj.windowHeight=window.innerHeight,obj.eventStream=self.getEventStream(),obj.trackerStream=self.getTrackerStream(),obj.criticalErrorReported=self.criticalErrorReported(),self.getLoadedScripts(obj);try{obj.nativesel=self.parseExtra(window.getSelection())}catch(err){obj.nativesel="Error: "+err.message}try{obj.apiStats=self.getGoogleAPIStats()}catch(err){obj.apiStats="Error: "+err.message}try{obj.customsel=require("Sel").dumpState()}catch(err){obj.customsel="Error: "+err.message}try{obj.errorPlatformInfo=JSON.stringify(self.errorPlatformInfo)}catch(err){obj.errorPlatformInfo="Error: "+err.message}if(android&&android.isEnabled())try{obj.androidInfo=android.getDebugInfo(obj)}catch(err){obj.androidInfo="Error: "+err.message}try{obj.validScreens=JSON.stringify(window.Screens)}catch(err){obj.validScreens="Error: "+err.message}self.vmMain?(obj.isBatchingUpdateItems=self.vmMain.isUpdatingItems(),obj.lastActivity=self.vmMain.lastActivity,obj.rootId=self.vmMain.root()?self.vmMain.root().id:"Undefined Root"):obj.rootId="VMMain Not Initialized"},self.getPremiumInfo=function getPremiumInfoFn(obj){if(self.billingManager){var premiumInfo={premiumStatus:self.billingManager.getPremiumStatus(),billingIdentifier:self.billingManager.getBillingIdentifier(),btRequested:self.billingManager._braintreeRequested,btLoaded:self.billingManager._braintreeLoaded,ctRequested:self.billingManager._clientTokenRequested,ctLoaded:self.billingManager._clientTokenLoaded,lastSignupError:self.billingManager._lastSignupError};obj.premiumInfo=premiumInfo}else obj.premiumInfo="Billing Manager Not Loaded"},self.computeRealtimeLoadStatus=function computeRealtimeLoadStatusFn(){var status={gapi:!!window.gapi,auth:!(!window.gapi||!window.gapi.auth),client:!(!window.gapi||!window.gapi.client),clientDrive:!!(window.gapi&&window.gapi.client&&window.gapi.client.drive),drive:!(!window.gapi||!window.gapi.drive),realtime:!!(window.gapi&&window.gapi.drive&&window.gapi.drive.realtime),load:!!(window.gapi&&window.gapi.drive&&window.gapi.drive.realtime&&self.isFunction(window.gapi.drive.realtime.load))};return status},self.getAppInfo=function getAppInfoFn(obj){var gapiStatus="Loaded";self.vmMain&&self.vmMain.failedGapiLoad?gapiStatus="ErrorLoading":gapiCalled||(gapiStatus="NotLoaded");var reportTime=Date.now();obj.gapiStatus=gapiStatus,obj.sessionID=window.__SESSION_ID,obj.sessionStart=window.__SESSION_BEGIN,obj.reportTime=reportTime,obj.runningTime=reportTime-window.__SESSION_BEGIN,obj.appCacheUpdated=wasAppCacheUpdated,obj.realtimeLoadStatus=this.computeRealtimeLoadStatus(),platform.getPlatformInfo(obj),self.getRunningState(obj),self.getAppStats(obj),self.getPremiumInfo(obj);try{require("gdata").getState(obj)}catch(err){obj.gState="ERROR"}try{require("goog").getUserName(obj)}catch(err){obj.fname="ERROR",obj.lname="ERROR"}try{require("goog").getTokenStats(obj)}catch(err){obj.tokenStats="ERROR"}try{if(window.gapi&&window.gapi.auth){var token=gapi.auth.getToken();token?(obj.tokenScope=token.scope,obj.hasIDToken=!!token.id_token):(obj.tokenScope="NO TOKEN",obj.hasIDToken="NO TOKEN")}else obj.tokenScope="NOT LOADED"}catch(err){obj.tokenScope="ERROR"}try{obj.linkedAccounts=require("AccountManager").getInfo()}catch(err){obj.linkedAccounts="ERROR"}try{obj.cacheState=require("CacheManager").getInfo()}catch(err){obj.cacheState="ERROR"}try{obj.hostedDomain=require("goog").getCurrentUserDomain()}catch(err){obj.hostedDomain="ERROR"}},self.reportSignup=function reportSignupFn(email,info,cb){try{self.PAssert(2588,email,"Must specify a valid email address to signup with")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2589,info,"Must provide valid signup info in addition to an email address")}catch(PERR){self.reportError(PERR)}email&&info&&(info.email=email,getExtraReportData(info),self.XHR_PrivateAPI({type:"POST",path:"/tracking/signup",data:info,requireAuth:!0,cb:function cbFn(xhr){200!==xhr.status?(ShouldLog(LogLevels.Error)&&log("Failed to report signup",xhr.responseText,xhr),cb&&cb(!1)):cb&&cb(!0)}}))};var hasCriticalError=!1;self.criticalErrorReported=function criticalErrorReportedFn(){return hasCriticalError},self.handleCriticalError=function handleCriticalErrorFn(){hasCriticalError=!0;try{if(self.isDemoMode())self.reload();else{var errorNode=document.createElement("div");errorNode.id="criticalError",errorNode.textContent="There was a critical error while loading the app, "+platform.actionVerb()+" to reload.",platform.isTouchDevice?errorNode.addEventListener(platform.touchStartEvent,function(){self.reload()},!0):errorNode.addEventListener(platform.upEvent,function(){self.reload()},!0),self.prependChild(document.body,errorNode),self.removeDOM("outerWrapper"),self.removeDOM("setupWrapper"),self.removeDOM("templates")}}catch(err){self.reportError(err)}},self.safeStringify=function safeStringifyFn(obj){try{return JSON.stringify(obj)}catch(err){}},self.reportEvent=function reportEventFn(e){if(!self.isDemoMode()){var eventString=self.parseExtra(e);eventString&&self.eventStream.push(eventString)}},self.getEventStream=function getEventStreamFn(){return self.eventStream.ordered()},window.__getEventStream=self.getEventStream,self.getTrackerStream=function getTrackerStreamFn(){try{var tracker=require("tracker");return tracker.stringifyGroups()}catch(err){log("Error getting tracker stream: ",err.message)}},self.parseExtra=function parseExtraFn(extra){var extraString;if(extra)try{var info;if(extra instanceof window.KeyboardEvent){var targetEle=self.elementToString(extra.target||extra.srcElement),skipElements=["[INPUT#importPW]","[INPUT#importEmail]","[TEXTAREA#bugDescription.bugDescription editable]"];skipElements.indexOf(targetEle)<0&&(info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),target:targetEle,keyCode:sanitizeKey(extra.keyCode),normCode:sanitizeKey(extra.normCode),ctrlKey:extra.ctrlKey,shiftKey:extra.shiftKey,metaKey:extra.metaKey,altKey:extra.altKey,tstamp:Date.now()})}else if(extra instanceof window.MouseEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),clientX:extra.clientX,clientY:extra.clientY,ctrlKey:extra.ctrlKey,shiftKey:extra.shiftKey,metaKey:extra.metaKey,altKey:extra.altKey,which:extra.which,button:extra.button,tstamp:Date.now()};else if(window.TouchEvent&&extra instanceof window.TouchEvent){info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),tstamp:Date.now()};var touch=extra.touches[0];touch&&(info.clientX=touch.clientX,info.clientY=touch.clientY)}else if(window.PointerEvent&&extra instanceof window.PointerEvent)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),clientX:extra.clientX,clientY:extra.clientY,tstamp:Date.now()};else if(extra instanceof window.Event)info={type:extra.type,currentTarget:self.elementToString(extra.currentTarget),relatedTarget:self.elementToString(extra.relatedTarget),target:self.elementToString(extra.target||extra.srcElement),tstamp:Date.now()};else if(extra instanceof window.Selection)if(0===extra.rangeCount)info={rangeCount:0};else{var range=extra.getRangeAt(0),startElement=range.startContainer,startWasTextNode=!1,endElement=range.endContainer,endWasTextNode=!1;startElement.nodeType===Node.TEXT_NODE&&(startElement=startElement.parentNode,startWasTextNode=!0),endElement.nodeType===Node.TEXT_NODE&&(endElement=endElement.parentNode,endWasTextNode=!0),info={rangeCount:extra.rangeCount,startContainer:self.getElementPath(startElement),startWasTextNode:startWasTextNode,startOffset:range.startOffset,endContainer:self.getElementPath(endElement),endWasTextNode:endWasTextNode,endOffset:range.endOffset}}else info=extra;extraString=info?self.safeStringify(info):void 0}catch(err){log("Error parsing extra "+err.message)}return extraString},window.__jsVersion="1475571972531";var rollbarIgnoreFiles=["http://a.visadd.com/script/layer"];require(["goog"],function(){Rollbar.configure({payload:{environment:platform.getDeployVar(DeployVariable.Environment),person:{id:self.getUserIdentifier()},client:{javascript:{source_map_enabled:!0,code_version:__jsVersion,guess_uncaught_frames:!0}}},checkIgnore:rollbarIgnoreFn})}),window.__MAX_ERRORS_REPORTED=50;var numReported=0,isReporting=!1,isRollbarConfigured=!1;self.handleJSError=function handleJSErrorFn(msg,stack,extra,noMsg,errorLevel){function reportError(){if(numReported++,numReported<=window.__MAX_ERRORS_REPORTED){var appInfo={};if(!isReporting){isReporting=!0;try{self.getAppInfo(appInfo)}catch(appInfoErr){Rollbar.error(appInfoErr)}isReporting=!1}appInfo.numReported=numReported;var data={url:sanitizeURL(window.location.href),logs:logs,info:appInfo,user:user,extra:extraString,jsVersion:window.__jsVersion,htmlVersion:document&&document.body?document.body.getAttribute("ver"):"UNKNOWN"};if(window.Rollbar){var errObj={message:msg,stack:stack};errorLevel===LogLevels.Error?Rollbar.error(errObj,data):errorLevel===LogLevels.Warning&&Rollbar.warning(errObj,data)}else data.msg=msg,data.stack=stack,self.XHR_PrivateAPI({type:"POST",path:"/feedback/error",data:data,cb:function cbFn(xhr){200!==xhr.status?log("Failed to report remote error",xhr.responseText,xhr):log("Reported Remote Error: ",xhr.responseText)}})}}if(noMsg||window.__error("JS Error: "+msg,"  Stack: ",stack,"  Extra: ",extra),msg||stack){errorLevel||(errorLevel=LogLevels.Error);try{var logs=window.__LOG_BUFFER.ordered().join("\r\n"),user=self.getUserIdentifier();isRollbarConfigured||("me"!==user&&(isRollbarConfigured=!0),Rollbar.configure({payload:{person:{id:user}},checkIgnore:rollbarIgnoreFn}));var extraString=self.parseExtra(extra);reportError()}catch(err){log("Badness happened reporting errors to server: ",err);try{Rollbar.error({message:msg,stack:stack}),Rollbar.error(err)}catch(fatalRollbarErr){log("More badness happened reporting errors to rollbar: ",fatalRollbarErr)}}}else;},window.onerror=function(errorMsg,url,lineNumber,colNumber,errorObj){errorObj?(log("Reported Global OnError: "+errorMsg+" Script: "+url+" Line: "+lineNumber+" Column: "+colNumber),self.reportError(errorObj)):(log("Unreported Global OnError: "+errorMsg+" Script: "+url+" Line: "+lineNumber+" Column: "+colNumber),self.reportError(errorMsg))},self.reportError=function reportErrorFn(err,extra,errorLevel){!err||extra||err.message||err.stack?err&&err.e&&self.isString(err.e)&&(err={message:err.e,stack:self.getCurrentStack("")}):(extra=err,err=void 0),err||(err={message:"Undefined error passed to reporter",stack:self.getCurrentStack("")}),self.handleJSError(err.message,err.stack,extra,!1,errorLevel)},window.__SendInfo=function(text){return self.handleJSError("Remote Client Info",void 0,text,!0),"Thank you for providing your client info!"},window.__CreateDebugSession=function(key){if(window.remote)return"Debug session already started";var debugKey=key||generateRemoteDebugKey();window.rcon=window.console,self.handleJSError("Remote Debug Session",void 0,debugKey,!0),self.addScript("http://jsconsole.com/remote.js?"+debugKey,"rDebugScript");var profileRunning=!1,profileIndex=0,profileName="";return window.rdbg={startProfile:function startProfileFn(forceName){try{return profileRunning?"Profiler already running":(profileName=forceName?forceName:"RDBGProfile_"+profileIndex,window.rcon.profile(profileName),profileRunning=!0,"Profiler Started: "+profileName)}catch(err){return"Error starting profile: "+err.message}},stopProfile:function stopProfileFn(){try{if(profileRunning){window.rcon.profileEnd(profileName),profileRunning=!1;var retString="Profile Completed: "+profileName;return profileName="",profileIndex++,retString}return"Profiler not running, use startProfile()"}catch(err){return"Error stopping profile: "+err.message}}},"Your remote debug session has started: "+debugKey},(util.hasURLParam("rsession")||util.hasURLParam("rdebug","true"))&&setTimeout(function(){var useKey=util.getURLParam("rsession")||generateRemoteDebugKey();window.__CreateDebugSession(useKey),log("%c---- REMOTE DEBUGGING ENABLED: "+useKey+" ----","color: green")},2e3),window.Checkpoint={MainRun:1,RequireLoaded:2,PageLoad:4,LocalDocLoad:8,InitData:16,DBLoaded:32,OnInitializedData:64,InitializeMain:128,LoadDefaultFile:256,DocLoadRequested:512,DocLoaded:1024,MaskRequired:2047},self.checkpoint=function checkpointFn(chk){window.__checkpoints|=chk},self.hasSentLowMemoryWarning=ko.observable(!1),self.handleLowMemory=function handleLowMemoryFn(e){self.hasSentLowMemoryWarning()||(self.hasSentLowMemoryWarning(!0),log("Low Memory Event: ",e),self.isNumber(e)&&(e=Math.round(e/1024/1024)+"MB"))};var fnRegex=/function\s+([^(]*?)\s*\(([^)]*)\)/,supportSimpleStack=!0;self.getCurrentStack=function getCurrentStackFn(message){var msg;if(supportSimpleStack||platform.noErrorStacks)try{msg=JSON.stringify(message)}catch(err){log("Error stringifying stack message",err,message)}if(supportSimpleStack){var err=new Error(msg||message);if(err.stack)return err.stack}supportSimpleStack=!1;try{for(var callstack=["GenError: "+(msg||message)],currentFunction=arguments.callee.caller,DEPTH_LIMIT=75,depth=0;currentFunction&&depth++<DEPTH_LIMIT;){var fn=currentFunction.toString(),fnMatch=fnRegex.exec(fn),fnName;fnName=fnMatch&&3===fnMatch.length&&""!==fnMatch[1]&&void 0!==fnMatch[1]?"at "+fnMatch[1]+"("+fnMatch[2].replace(/[\r\n]/g,"")+")":fnMatch&&3===fnMatch.length?"at <anonymous> ("+fnMatch[2].replace(/[\r\n]/g,"")+")":"at <anonymous> (<unknown>)",callstack.push(fnName),currentFunction=currentFunction.caller}return callstack.join("\n")}catch(err2){log("Error generating stack trace",err2)}return""};var remoteUpdateWait=12e5,lastUpdateTime=0;self.checkForRemoteChanges=function checkForRemoteChangesFn(){var currentTime=Date.now();if(lastUpdateTime-currentTime>=remoteUpdateWait)try{self.AppCache&&self.AppCache.checkForUpdate(),self.vmMain&&self.vmMain.vmPicker&&self.vmMain.vmPicker.refreshFiles()}catch(err){self.reportError(err)}finally{lastUpdateTime=currentTime}},function wrapAsyncCallbacks(){var _helper=function _helperFn(fnName){var originalFn=window[fnName];window[fnName]=function wrapAsyncFn(){var args=Array.prototype.slice.call(arguments),originalCallback=args[0];return"function"==typeof originalCallback&&(args[0]=wrapFn(originalCallback)),originalFn.apply?originalFn.apply(this,args):originalFn(args[0],args[1])}};_helper("setTimeout"),_helper("setInterval")}();var logBufferLength=platform.mobile?30:50;window.__LOG_BUFFER=new RingBuffer(logBufferLength);var oldLog=window.log,logErrorReported;self.isDemoMode()||(window.log=function(){try{window.__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," "))}catch(err){window.__LOG_BUFFER.push(Date.now()+": Invalid Log Arguments")}console.log.apply(console,arguments)},window.__log=function(){try{window.__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," "))}catch(err){window.__LOG_BUFFER.push(Date.now()+": Invalid Log Arguments")}});try{window.console.error=function(){try{var message=arguments[0],stack=arguments[1];2===arguments.length&&self.isString(message)&&self.isString(stack)?self.reportError({message:message,stack:stack}):window.__error.apply(window,arguments)}catch(err){window.__error.apply(window,arguments),self.reportError(err)}}}catch(errorErr){self.reportError(errorErr),log("Unable to override console.error")}for(var i in oldLog)window.log[i]=oldLog[i];self.getObjectInfo=function getObjectInfoFn(obj){try{if(obj&&obj.constructor)return obj.constructor.name}catch(err){self.reportError(err)}return typeof obj},self.packedFnToString=function packedFnToStringFn(packedFn){for(var str="",i=0;i<packedFn.length;++i)str+=packedFn[i]+".";return str},self.unpackFn=function unpackFnFn(packedFn,obj){try{self.PAssert(2591,self.isFunction(packedFn)||self.isArray(packedFn),"Must supply either a valid function or packed function")}catch(PERR){self.reportError(PERR)}var unpackedFn=0/0;if(self.isFunction(packedFn))unpackedFn=packedFn;else if(packedFn)try{unpackedFn=obj||window;for(var i=0;i<packedFn.length;++i){try{self.PAssert(2592,self.isString(packedFn[i]),"Packed fns must only contain strings: "+i)}catch(PERR){self.reportError(PERR)}try{self.PAssert(2593,unpackedFn,"Must be able to unpack each step in object chain: "+packedFn[i]+" in "+self.packedFnToString(packedFn))}catch(PERR){self.reportError(PERR)}if(!unpackedFn){unpackedFn=0/0;break}unpackedFn=unpackedFn[packedFn[i]]}}catch(err){self.reportError(err),unpackedFn=0/0}return unpackedFn},self.isFunction=function isFunctionFn(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)},self.isArray=function isArrayFn(obj){return"[object Array]"===Object.prototype.toString.call(obj)},self.isString=function isStringFn(obj){return"string"==typeof obj},self.isObject=function isObjectFn(obj){return"object"==typeof obj&&null!==obj&&!self.isArray(obj)},self.isNumber=function isNumberFn(obj){return"number"==typeof obj&&!isNaN(obj)},self.isBoolean=function isBooleanFn(obj){return obj===!0||obj===!1},self.parseInt=function parseIntFn(num){return parseInt(num,10)},self.isValidChangeType=function isValidChangeTypeFn(changeType){if(void 0!==changeType&&null!==changeType){var type=changeType&~ChangeType.All;if(self.inMaskOnly(changeType,ChangeType.Valid))return type===ChangeType.None||self.isOneFlagSet(type,ChangeType.Local|ChangeType.Remote|ChangeType.Auto)}return!1},self.isRemoteChange=function isRemoteChangeFn(changeType){try{self.PAssert(2594,self.isValidChangeType(changeType),"Must supply a valid changeType")}catch(PERR){self.reportError(PERR)}var type=changeType&~ChangeType.All;return self.isValidChangeType(changeType)&&self.isFlagSet(type,ChangeType.Remote)},self.isUndoRedoChange=function isUndoRedoChangeFn(changeType){try{self.PAssert(2595,self.isValidChangeType(changeType),"Must supply a valid changeType")}catch(PERR){self.reportError(PERR)}var type=changeType&~ChangeType.All;return self.isValidChangeType(changeType)&&self.isFlagSet(type,ChangeType.UndoRedo)},self.isLocalChange=function isLocalChangeFn(changeType){try{self.PAssert(2596,self.isValidChangeType(changeType),"Must supply a valid changeType")}catch(PERR){self.reportError(PERR)}var type=changeType&~ChangeType.All;return self.isValidChangeType(changeType)&&self.isFlagSet(type,ChangeType.Local)},self.isAutoChange=function isAutoChangeFn(changeType){try{self.PAssert(2597,self.isValidChangeType(changeType),"Must supply a valid changeType")}catch(PERR){self.reportError(PERR)}var type=changeType&~ChangeType.All;return self.isValidChangeType(changeType)&&self.isFlagSet(type,ChangeType.Auto)},self.changeToString=function changeToStringFn(changeType){try{self.PAssert(2598,void 0!==changeType,"Must supply a valid changeType")}catch(PERR){self.reportError(PERR)}var flags=[];self.forEachFlagSet(changeType,function(flag){switch(flag){case ChangeType.Local:flags.push("Local");break;case ChangeType.Remote:flags.push("Remote");break;case ChangeType.Auto:flags.push("Auto");break;case ChangeType.Structure:flags.push("Structure");break;case ChangeType.Text:flags.push("Text");break;case ChangeType.Property:flags.push("Property");break;case ChangeType.Rollover:flags.push("Rollover");break;case ChangeType.UndoRedo:flags.push("UndoRedo");break;case ChangeType.PluginLoad:flags.push("PluginLoad");break;default:flags.push("Unknown:"+flag)}});var str;return str=0===flags.length?"None":flags.join(" "),"[ "+str+" ]"},self.isDOMNode=function isDOMNodeFn(obj){return window.HTMLElement?obj instanceof HTMLElement:obj&&obj.tagName&&obj.nodeType===Node.ELEMENT_NODE},self.isTextNode=function isTextNodeFn(obj){return obj&&obj.nodeType===Node.TEXT_NODE},self.ensureDOMNode=function ensureDOMNodeFn(obj){var domNode;return self.isDOMNode(obj)?domNode=obj:self.isTextNode(obj)&&(domNode=obj.parentElement),domNode},self.enumToString=function enumToStringFn(en,value){for(var k in en)if(en[k]===value)return k;return null},self.elementToString=function elementToStringFn(ele,includeLength){if(ele){var nodeString=ele.nodeName;return ele.id&&(nodeString+="#"+ele.id),ele.className&&(nodeString+="."+ele.className.replace(/ /g,".")),includeLength&&ele.innerText&&(nodeString+=":"+ele.innerText.length),nodeString}return"UNDEFINED"},self.getElementPath=function getElementPathFn(ele,includeLength){var isFirst=!0,path="";try{for(;ele&&"container"!==ele.id&&ele!==document.documentElement&&ele!==document.body;)path+=isFirst?self.elementToString(ele,includeLength)+" ":self.elementToString(ele)+" ",isFirst=!1,ele=ele.nodeType===Node.TEXT_NODE?ele.parentNode:ele.parentElement}catch(err){path+=err.message}return path};var eventID,replaceFunction,dblClickTime=300;
self.setupClick=function setupClickFn(obj,item,params){function move(e){var xThisFrame=e.eventX-this.lastX,yThisFrame=e.eventY-this.lastY;if(0!==xThisFrame||0!==yThisFrame){var firstMove=!this.moved;if(this.lastX=e.eventX,this.lastY=e.eventY,e.distanceX=this.distanceX=this.distanceX+Math.abs(xThisFrame),e.distanceY=this.distanceY=this.distanceY+Math.abs(yThisFrame),(this.moved||e.distanceX>self.ClickThreshold||e.distanceY>self.ClickThreshold)&&(this.moved=!0,e.moved=this.moved),(params.onMove||params.onFirstMove)&&(e.diffX=e.eventX-this.startX,e.diffY=e.eventY-this.startY,e.xThisFrame=xThisFrame,e.yThisFrame=yThisFrame,e.startX=this.startX,e.startY=this.startY,e.startClientX=this.startClientX,e.startClientY=this.startClientY,e.startSrc=this.startSrc,firstMove&&params.onFirstMove&&params.onFirstMove.call(item,e),params.onMove)){var handled=!1;handled=params.onMove.call(item,e),handled&&e.stopImmediatePropagation()}}}function end(e){var now=Date.now(),lastTouch=this.lastTouch||now,delta=Math.max(0,now-lastTouch);this.numClicks?this.numClicks++:this.numClicks=1,e.moved=this.moved,e.timeDelta=delta,e.diffX=this.lastX-this.startX,e.diffY=this.lastY-this.startY,e.startX=this.startX,e.startY=this.startY,e.startSrc=this.startSrc,this.startSrc=void 0,dblClickTime>delta&&delta>0&&params.onDoubleClick&&!this.moved&&params.onDoubleClick.call(item,e),isNaN(e.button)||e.button===ButtonCode.Left?(this.lastTouch=now,!params.onClick||this.moved||platform.mac&&e.ctrlKey||params.onClick.call(item,e),params.onEnd&&params.onEnd.call(item,e)):e.button===ButtonCode.Middle&&params.onMiddleClick&&!this.moved&&params.onMiddleClick.call(item,e),setTimeout(function(){this.lastTouch=void 0,this.numClicks=void 0}.bind(this),dblClickTime)}function cancel(e){params.onCancel&&params.onCancel.call(item,e)}function start(e){e.timeStart=this.timeStart=Date.now(),e.srcElement||(e.srcElement=e.target),this.startSrc=e.srcElement,e.startSrc=e.srcElement,this.moved=!1,e.startX=this.startX=e.eventX,e.startY=this.startY=e.eventY,e.startClientX=this.startClientX=e.clientX,e.startClientY=this.startClientY=e.clientY,this.lastX=e.eventX,this.lastY=e.eventY,this.distanceX=0,this.distanceY=0,(isNaN(e.button)||e.button===ButtonCode.Left||e.button===ButtonCode.Right)&&((isNaN(e.button)||e.button===ButtonCode.Left)&&params.onStart?params.onStart.call(item,e):e.button===ButtonCode.Right&&params.onRightStart&&params.onRightStart.call(item,e)),isNaN(e.changeLastY)||(this.lastY+=e.changeLastY)}function touchMove(e){var touch=platform.ie?e:e.touches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,move.call(obj,e),e.returnFalse?!1:void 0}function touchUp(e){document.removeEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.removeEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.removeEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture);var touch=platform.ie?e:e.changedTouches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,gesture&&gesture.stop(),end.call(obj,e),e.returnFalse?!1:void 0}function touchCancel(e){return document.removeEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.removeEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.removeEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&gesture.stop(),cancel.call(obj,e),e.returnFalse?!1:void 0}function touchStart(e){if(!e.handled){this.lastInputTouch=!0;var touch=platform.ie?e:e.touches[0];return e.eventX=touch.pageX,e.eventY=touch.pageY,e.clientX=touch.clientX,e.clientY=touch.clientY,start.call(obj,e),e.ignore||(document.addEventListener(platform.touchMoveEvent,touchMoveHandler,useCapture),document.addEventListener(platform.touchEndEvent,touchEndHandler,useCapture),document.addEventListener(platform.touchCancelEvent,touchCancelHandler,useCapture),gesture&&(log("Add Gesture Pointer: ",e.id,self.elementToString(e.target),self.elementToString(obj)),gesture.addPointer(e.pointerId))),e.returnFalse?!1:void 0}}function mouseMove(e){return this.lastInputTouch?void 0:(e.eventX=e.pageX,e.eventY=e.pageY,move.call(obj,e),e.returnFalse?!1:void 0)}function mouseUp(e){return e.handled||this.lastInputTouch?void 0:(document.removeEventListener(platform.moveEvent,mouseMoveHandler,useCapture),document.removeEventListener(platform.upEvent,mouseUpHandler,useCapture),e.button===ButtonCode.Left&&end.call(obj,e),e.returnFalse?!1:void 0)}function mouseDown(e){return e.handled||this.lastInputTouch?void 0:(this.lastInputTouch=!1,e.eventX=e.pageX,e.eventY=e.pageY,start.call(obj,e),e.ignore||(e.button===ButtonCode.Left&&document.addEventListener(platform.moveEvent,mouseMoveHandler,useCapture),document.addEventListener(platform.upEvent,mouseUpHandler,useCapture)),e.returnFalse?!1:void 0)}function contextMenu(e){e.handled||this.lastInputTouch||(e.srcElement||(e.srcElement=e.target),params.onRightClick&&params.onRightClick.call(item,e))}function killMousedown(e){return android.isEnabled()&&android.isTargetBox(e)||(e.preventDefault(),e.stopImmediatePropagation()),!1}try{self.PAssert(2600,obj,"Expecting an object to bind the click handlers to.")}catch(PERR){self.reportError(PERR)}item||(item=obj);var useCapture=!1;self.isFunction(params)?params={onClick:params}:params&&params.useCapture&&(useCapture=params.useCapture);var touchStartHandler=fnCatch(touchStart),touchMoveHandler=fnCatch(touchMove),touchEndHandler=fnCatch(touchUp),touchCancelHandler=fnCatch(touchCancel),gesture,mouseDownHandler=fnCatch(mouseDown),mouseMoveHandler=fnCatch(mouseMove),mouseUpHandler=fnCatch(mouseUp),contextMenuHandler=fnCatch(contextMenu);return platform.isTouchDevice&&platform.isMobileBrowser?obj.addEventListener(platform.touchStartEvent,touchStartHandler,useCapture):obj.addEventListener(platform.downEvent,mouseDownHandler,useCapture),platform.usePointerEvents&&platform.mobile&&obj.addEventListener("mousedown",killMousedown,useCapture),params.onRightClick&&!platform.mobile&&obj.addEventListener("contextmenu",contextMenuHandler,useCapture),this},"function"!=typeof Array.prototype.pushOnlyUniques&&(Array.prototype.pushOnlyUniques=function(arr,comp){if(!arr)return this;for(var i=0,len=arr.length;len>i;++i){for(var isUnique=!0,u=0,len2=this.length;len2>u;++u)if(comp&&comp(arr[i],this[u])||!comp&&arr[i]===this[u]){isUnique=!1;break}isUnique&&this.push(arr[i])}return this}),"function"!=typeof Array.prototype.pushArray&&(Array.prototype.pushArray=function(arr){return this.push.apply(this,arr)}),"function"!=typeof Array.prototype.removeArray&&(Array.prototype.removeArray=function(arr){return this.filter(function(item){return!arr||arr.indexOf(item)<0})}),"function"!=typeof Array.prototype.removeAt&&(Array.prototype.removeAt=function(from){return this.splice(from,1)[0]}),"function"!=typeof Array.prototype.remove&&(Array.prototype.remove=function(obj,fromIndex){var index=this.indexOf(obj,fromIndex);return index>=0&&this.removeAt.call(this,index),index}),"function"!=typeof Array.prototype.equals&&(Array.prototype.equals=function(array){if(!array)return!1;if(this.length!==array.length)return!1;for(var i=0,l=this.length;l>i;i++)if(this[i]instanceof Array&&array[i]instanceof Array){if(!this[i].equals(array[i]))return!1}else if(this[i]!==array[i]&&!deepEqual(this[i],array[i]))return!1;return!0}),"function"!=typeof Array.prototype.indexOfWithProperty&&(Array.prototype.indexOfWithProperty=function(property,value){for(var i=0;i<this.length;i++)if(this[i][property]===value)return i;return-1}),"function"!=typeof Array.prototype.findInsertIndex&&(Array.prototype.findInsertIndex=function(ele,comp){try{self.PAssert(2603,void 0!==ele&&null!==ele,"Require a valid element to insert")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2604,comp,"Require a valid comparison function")}catch(PERR){self.reportError(PERR)}for(var low=0,high=this.length-1;high>=low;){var i=low+high>>1,c=comp(this[i],ele);if(0>c)low=i+1;else{if(!(c>0))return i;high=i-1}}return low}),self.numberComparator=function numberComparatorFn(a,b){return a-b},"function"!=typeof Array.prototype.findSorted&&(Array.prototype.findSorted=function(ele,comp){var index=this.findInsertIndex(ele,comp);return 0===comp(this[index],ele)?this[index]:void 0}),"function"!=typeof Array.prototype.insertSorted&&(Array.prototype.insertSorted=function(ele,comp){var idx=this.findInsertIndex(ele,comp);return this.splice.apply(this,[idx,0,ele]),idx}),ko.observableArray.fn.insertSorted=function(ele,comp){this.valueWillMutate();var idx=this.peek().insertSorted(ele,comp);return this.valueHasMutated(),idx},self.arrayUnion=function arrayUnionFn(a1,a2){for(var arr=[],i=0;i<a1.length;i++)arr.indexOf(a1[i])<0&&arr.push(a1[i]);for(var i=0;i<a2.length;i++)arr.indexOf(a2[i])<0&&arr.push(a2[i]);return arr},self.arrayIntersection=function arrayIntersectionFn(a1,a2){for(var arr=[],i=0;i<a1.length;i++)a2.indexOf(a1[i])>=0&&arr.push(a1[i]);return arr},self.mergeObjects=function mergeObjectsFn(target,src){var array=Array.isArray(src),dst=array&&[]||{};return array?(target=target||[],dst=dst.concat(target),src.forEach(function(e,i){"undefined"==typeof dst[i]?dst[i]=e:"object"==typeof e?dst[i]=self.mergeObjects(target[i],e):-1===target.indexOf(e)&&dst.push(e)})):(target&&"object"==typeof target&&Object.keys(target).forEach(function(key){dst[key]=target[key]}),Object.keys(src).forEach(function(key){dst[key]="object"==typeof src[key]&&src[key]&&target[key]?self.mergeObjects(target[key],src[key]):src[key]})),dst};var gapiMap={};self.loadGoogleAPI=function loadGoogleAPIFn(api,version,successCB,timeoutCB){try{self.PAssert(2606,api,"Must supply a valid API name")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2607,version,"Must supply a valid API version")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2608,successCB,"Must supply a valid cb")}catch(PERR){self.reportError(PERR)}if(window.gapi&&window.gapi.client){var prevData=gapiMap[api];if(prevData){try{self.PAssert(2609,prevData.version===version,"Must only load a single version of an API")}catch(PERR){self.reportError(PERR)}prevData.isLoaded?successCB():(prevData.successCBs.push(successCB),timeoutCB&&prevData.timeoutCBs.push(timeoutCB))}else gapiMap[api]=prevData={api:api,version:version,isLoaded:!1,numRetries:0,lastTimeout:0,timer:void 0,successCBs:[successCB],timeoutCBs:[]},timeoutCB&&prevData.timeoutCBs.push(timeoutCB),window.gapi.client.load(api,version,handleAPILoadRequest.bind(window,prevData))}else{var onGapiLoaded=function(){try{self.PAssert(2610,window.gapi&&window.gapi.client,"Must have properly loaded the gapi client lib")}catch(PERR){self.reportError(PERR)}self.removeCustomEventListener("gapiLoaded",onGapiLoaded),self.loadGoogleAPI(api,version,successCB,timeoutCB)};self.addCustomEventListener("gapiLoaded",onGapiLoaded)}},self.setupGoogleAPIListener=function setupGoogleAPIListenerFn(){window.addEventListener("online",function(){for(var api in gapiMap){var apiData=gapiMap[api];!apiData.isLoaded&&apiData.timer&&(clearTimeout(apiData.timer),apiData.timer=setTimeout(function(){window.gapi.client.load(apiData.api,apiData.version,handleAPILoadRequest.bind(window,apiData))},1e3*retryTimeouts[1]))}})},self.getGoogleAPIStats=function getGoogleAPIStatsFn(){var apiStats={};if(window.gapi&&window.gapi.client)for(var api in gapiMap){var apiData=gapiMap[api],stats={api:apiData.api,version:apiData.version,isLoaded:apiData.isLoaded,numRetries:apiData.numRetries,lastTimeout:apiData.lastTimeout,hasTimeout:!!apiData.timer};if(apiData.isLoaded)try{stats.isAccessible=!!window.gapi.client[api]}catch(err){stats.isAccessible=!1}else stats.isAccessible=!1;apiStats[api]=stats}else apiStats.error="GAPI Client not loaded";return apiStats},self.clamp=function clampFn(val,min,max){return Math.max(min,Math.min(max,val))},self.randParam=function randParamFn(){return"?t="+Date.now()},self.createPath=function createPathFn(filename){return window.location.protocol+"//"+window.location.host+"/"+filename},self.addScript=function addScriptFn(filename,id,callback,error){try{self.PAssert(2611,!id||null===document.getElementById(id),"Should never include the same script ID multiple times")}catch(PERR){self.reportError(PERR)}var e=document.createElement("script");e.type="text/javascript",e.src=filename,id&&(e.id=id),callback&&readyStateCallback(e,callback,error),"undefined"!=typeof e&&document.getElementsByTagName("head")[0].appendChild(e)},self.addScriptHack=function addScriptHackFn(filename,id,callback,error){window.define.amd=void 0,self.addScript(filename,id,function(){window.define.amd={jQuery:!0},callback&&callback()},function(){window.define.amd={jQuery:!0},error&&error()})},self.addStylesheet=function addStylesheetFn(filename,callback,error){var e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=filename,callback&&readyStateCallback(e,callback,error),"undefined"!=typeof e&&document.getElementsByTagName("head")[0].appendChild(e)},self.PAssert=function PAssertFn(tag,value){if(!value){var assertExtra={isAssert:!0,tag:tag};try{var argString=makeString(Array.prototype.slice.call(arguments,2));log(arguments.length>2?"Assert Failure "+tag+": "+argString:"Assert Failure "+tag),self.reportError(new Error("Assert Failure: "+argString),assertExtra,LogLevels.Warning)}catch(err){log("Exception in PAssert "+tag+": ",err),self.reportError(err,assertExtra)}}},self.getElementParent=function getElementParentFn(el){for(;el;){if(self.hasClass(el,"item"))return el;el=el.parentNode}};var currentFindPass=0;self.getPreviousItem=function getPreviousItemFn(item,pane,options){return currentFindPass++,_getPreviousItem(item,pane,options)},self.getNextItem=function getNextItemFn(item,pane,options){return currentFindPass++,_getNextItem(item,pane,options)},self.getFirstItem=function getFirstItemFn(item1,item2){try{self.PAssert(2705,item1.belongsToSameItemStore(item2),"Must match item stores")}catch(PERR){self.reportError(PERR)}if(item1.id===item2.id||item2.parent().id===item1.id)return item1;if(item1.parent().id===item2.id)return item2;var p=item1,prevP=void 0,q,prevQ;do{q=item2,prevQ=void 0;do{if(p.id===q.id){if(void 0===prevP)return item1;if(void 0===prevQ)return item2;try{self.PAssert(2706,p.id===prevQ.parent().id,"Must share a common parent")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2707,p.id===prevP.parent().id,"Must share a common parent")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2708,prevP.id!==prevQ.id,"If both previous items match, they should have been the common ancestor")}catch(PERR){self.reportError(PERR)}return prevP.getIndex()<prevQ.getIndex()?item1:item2}prevQ=q}while(void 0!==(q=q.parent()));prevP=p}while(void 0!==(p=p.parent()));try{self.PAssert(2709,!1,"One item must appear first in the tree")}catch(PERR){self.reportError(PERR)}return void 0},self.animateTransform=function animateTransformFn(element,options){function onComplete(){options.clearTransform&&(element.style[platform.transform.style]="",element.style[platform.transformOrigin.style]=""),options.onComplete&&options.onComplete()}try{self.PAssert(2710,element,"Must supply a valid element to transform")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2711,options,"Options must always be defined")}catch(PERR){self.reportError(PERR)}if(element){var transform=options.transform;if(!isNaN(options.delay)){var delay=options.delay;return options.delay=void 0,void setTimeout(self.animateTransform,delay,element,options)}if(options.time){var trans=self.getTransitionClass(options.time);self.addClass(element,trans),setTimeout(function(){self.removeClass(element,trans),onComplete()},options.time)}else onComplete();isNaN(options.opacity)||(element.style.opacity=options.opacity),transform||isNaN(options.left)||isNaN(options.top)||(transform="translate3d("+options.left+"px, "+options.top+"px, 0)"),options.origin&&(element.style[platform.transformOrigin.style]=options.origin),element.style[platform.transform.style]=transform}},self.easeOut=function easeOutFn(t,b,c){return-c*t*(t-2)+b};var scrollTimeouts={};self.scrollTo=function scrollToFn(scrollPosX,scrollPosY,duration,element,cb){function scrollLoop(timestamp){startTime||(startTime=timestamp-20);var t=Math.min((timestamp-startTime)/duration,1);if(void 0!==scrollPosX){var scrollOffsetX=self.easeOut(t,scrollValueX,differenceX);element.scrollLeft=scrollOffsetX}if(void 0!==scrollPosY){var scrollOffsetY=self.easeOut(t,scrollValueY,differenceY);element.scrollTop=scrollOffsetY}1===t?(delete scrollTimeouts[key],cb&&cb()):scrollTimeouts[key]=requestAnimationFrame(scrollLoop)}try{self.PAssert(2712,void 0!==scrollPosX||void 0!==scrollPosY,"Must be scrolling something")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2713,void 0===scrollPosX||self.isNumber(scrollPosX),"Must provide a valid scrollPosX")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2714,void 0===scrollPosY||self.isNumber(scrollPosY),"Must provide a valid scrollPosY")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2715,self.isNumber(duration),"Must provide a valid duration")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2716,self.isDOMNode(element),"Must provide a valid element to scroll")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2717,!cb||self.isFunction(cb),"Must provide a valid scrollDone callback")}catch(PERR){self.reportError(PERR)}var key=element.getAttribute("data-moo-id")||element.id;try{self.PAssert(2718,key,"Should only scroll elements with ids")}catch(PERR){self.reportError(PERR)}if(scrollTimeouts[key]&&(cancelAnimationFrame(scrollTimeouts[key]),delete scrollTimeouts[key]),!element)return void self.reportError(new Error("Must specify an element to scroll to"));if(duration>0){if(void 0!==scrollPosX)var scrollValueX=element.scrollLeft,differenceX=scrollPosX-scrollValueX;if(void 0!==scrollPosY)var scrollValueY=element.scrollTop,differenceY=scrollPosY-scrollValueY;var startTime;(Math.abs(differenceX)>0||Math.abs(differenceY)>0)&&(scrollTimeouts[key]=requestAnimationFrame(scrollLoop))}else element&&(void 0!==scrollPosX&&(element.scrollLeft=scrollPosX),void 0!==scrollPosY&&(element.scrollTop=scrollPosY)),cb&&cb()},self.computeScrollSpeed=function computeScrollSpeedFn(min,max,val){return val=self.clamp(val,min,max),(max-min-(max-val))/(max-min)};var lastState={speed:0,pane:void 0},runScroll=!1;self.repeatScroll=function repeatScrollFn(speed,pane){try{self.PAssert(2719,pane&&!self.isString(pane),"Must pass a valid pane object to repeatScroll")}catch(PERR){self.reportError(PERR)}lastState.speed=speed,lastState.pane=pane,runScroll||(runScroll=!0,requestAnimationFrame(performScroll))},self.cancelRepeatScroll=function cancelRepeatScrollFn(){runScroll=!1},self.elementInPane=function elementInPaneFn(element){if(element)for(element.nodeType===Node.TEXT_NODE&&(element=element.parentNode);element;){if(self.hasClass(element,"pane")||self.hasClass(element,"paneOverview"))return!!element;element=element.parentElement}return!1},self.elementInPaneEdit=function elementInPaneEditFn(element){var isPaneEdit=!1,pane=self.getPaneForElement(element);return pane&&self.isAncestor(element,pane.getContentElement())&&(isPaneEdit=!0),isPaneEdit},self.elementInNonPaneEdit=function elementInNonPaneEditFn(element){var isNonPaneEdit=!1;if(element&&(element.nodeType===Node.TEXT_NODE&&(element=element.parentNode),!self.elementInPaneEdit(element)))for(;element;){if(self.isKeyboardInputElement(element)){isNonPaneEdit=!0;break}element=element.parentElement}return isNonPaneEdit},self.isNonPaneDropTarget=function isNonPaneDropTargetFn(element){var isTarget=!1;return self.elementInNonPaneEdit(element)?isTarget=!0:self.findParent(element,"validDropTarget")&&(isTarget=!0),isTarget},self.scrollIntoView=function scrollIntoViewFn(element,duration,callback){try{self.PAssert(2720,self.isDOMNode(element),"Must supply a valid DOM node to scroll into view")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2721,self.isNumber(duration)&&duration>=0,"Must supply a valid scroll duration")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2722,!callback||self.isFunction(callback),"Callback must be a function")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2723,!self.getReactCell(element),"Use methods on VMPane to scroll VMLIs")}catch(PERR){self.reportError(PERR)}var needsScroll=!1;if(element){var scrollView=self.findParent(element,"scroller")||self.findParent(element,"fancyScrollContent");try{self.PAssert(2724,scrollView,"Every element must be a child of a scroller to be able to scroll it into view")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2725,!self.hasClass(scrollView,"customScroller"),"Must not be scrolling this way, use methods on VMPane instead")}catch(PERR){self.reportError(PERR)}if(scrollView){var scrollBounds=scrollView.getBoundingClientRect(),scrollBottom=scrollBounds.bottom,bounds=element.getBoundingClientRect(),MagicNumber_1=80,MagicNumber_2=400,MagicNumber_3=120,boundsBottom=Math.min(bounds.bottom,bounds.top+MagicNumber_1),scrollTop=scrollView.scrollTop,scrollPosY;if(platform.mobile){var topPad=platform.orientation===Orientation.Landscape?self.topBarHeight:MagicNumber_3;scrollBottom=Math.max(scrollBounds.top+topPad,scrollBottom-MagicNumber_2)}bounds.top<scrollBounds.top?scrollPosY=scrollTop+bounds.top-scrollBounds.top:boundsBottom>scrollBottom&&bounds.top>scrollBounds.top&&(scrollPosY=scrollTop+boundsBottom-scrollBottom),void 0!==scrollPosY&&(self.scrollTo(void 0,scrollPosY,duration,scrollView,callback),needsScroll=!0)}}return needsScroll},self.isKeyboardInputElement=function isKeyboardInputElementFn(ele){if(ele){if("checkbox"===ele.type)return!1;if("INPUT"===ele.nodeName||"textarea"===ele.type||self.findParentAttr(ele,"contenteditable","true"))return!0}return!1},self.openKeyboardOnIndex=function openKeyboardOnIndexFn(e,pane,index,focusFn,blurFn){try{self.PAssert(2726,platform.mobile,"Should only be opening keyboard on mobile devices")}catch(PERR){self.reportError(PERR)}var scrollStart=pane.getScrollOffset(),performedScroll=!1;if(self.keyboardToolbar.preShow(),!self.isKeyboardOpen){var callback=function(){focusFn&&focusFn(),self.enforceScroll()};pane.addPadding(),platform.app&&!platform.ioswk||platform.android||platform.mobileie?performedScroll=pane.scrollIndexIntoView(index,platform.keyboardOpenTime,callback):(performedScroll=pane.scrollIndexIntoView(index,platform.keyboardOpenTime),callback()),self.keyboardToolbar.hideTopBarIfLandscape()}return performedScroll&&platform.app&&!platform.android||(focusFn&&focusFn(),self.keyboardToolbar.show(C.KeyboardToolbarMode.Item)),keyboardOpenedOn=pane,keyboardBlurFn=blurFn,keyboardStartScrollOffset=scrollStart,keyboardDestination=KeyboardDestination.Item,platform.ios&&self.preventClick(),e.preventDefault(),e.stopImmediatePropagation?e.stopImmediatePropagation():e.stopPropagation(),e.returnFalse=!0,self.enforceScroll(),performedScroll},self.openKeyboardOnElement=function openKeyboardOnElementFn(e,element,focusFn,blurFn){try{self.PAssert(2727,platform.mobile,"Should only be opening keyboard on mobile devices")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2728,self.isDOMNode(element),"Must supply a valid element")}catch(PERR){self.reportError(PERR)}var scrollView,scrollStart;if(element){scrollView=self.findParent(element,"scroller");try{self.PAssert(2729,!self.hasClass(element,"paneScroller"),"Must never scroll a custom scroller this way")}catch(PERR){self.reportError(PERR)}scrollStart=scrollView?scrollView.scrollTop:0}var performedScroll=!1;if(self.keyboardToolbar.preShow(),!self.isKeyboardOpen){var callback=function(){self.keyboardToolbar.show(C.KeyboardToolbarMode.Modal),focusFn&&focusFn(),self.enforceScroll()};addScrollPadding(scrollView),platform.app&&!platform.ioswk||platform.android||platform.mobileie?performedScroll=self.scrollIntoView(element,platform.keyboardOpenTime,callback):(performedScroll=self.scrollIntoView(element,platform.keyboardOpenTime),callback()),self.keyboardToolbar.hideTopBarIfLandscape()}return performedScroll&&platform.app&&!platform.android||(focusFn&&focusFn(),self.keyboardToolbar.show(C.KeyboardToolbarMode.Modal)),keyboardOpenedOn=scrollView,keyboardBlurFn=blurFn,keyboardStartScrollOffset=scrollStart,keyboardDestination=KeyboardDestination.Element,platform.ios&&self.preventClick(),e.stopImmediatePropagation(),e.returnFalse=!0,self.enforceScroll(),performedScroll};var KeyboardDestination={None:0,Item:1,Element:2},keyboardDestination=KeyboardDestination.None,keyboardOpenedOn=void 0,keyboardBlurFn=void 0,keyboardStartScrollOffset=0;self.closeKeyboard=function closeKeyboardFn(){Sel&&Sel.reset(),self.blurActiveElement()},self.onCloseKeyboardItem=function onCloseKeyboardItemFn(){self.isKeyboardOpen&&(keyboardOpenedOn.addPadding(),keyboardOpenedOn.setScrollOffset(keyboardStartScrollOffset,platform.keyboardOpenTime),self.isKeyboardOpen=!1,keyboardBlurFn&&keyboardBlurFn())},self.onCloseKeyboardElement=function onCloseKeyboardElementFn(){if(self.isKeyboardOpen){try{self.PAssert(2730,keyboardOpenedOn,"Must have a valid scroller")}catch(PERR){self.reportError(PERR)}self.scrollTo(void 0,keyboardStartScrollOffset,platform.keyboardOpenTime,keyboardOpenedOn),self.isKeyboardOpen=!1,keyboardBlurFn&&keyboardBlurFn()}},self.onCloseKeyboard=function onCloseKeyboardFn(){keyboardDestination===KeyboardDestination.Item?self.onCloseKeyboardItem():keyboardDestination===KeyboardDestination.Element&&self.onCloseKeyboardElement()},self.blurActiveElement=function blurActiveElementFn(ignoreSelectionChange){self.ignoreSelectionChange=!!ignoreSelectionChange,document.activeElement&&document.activeElement.blur(),setTimeout(function(){self.ignoreSelectionChange=!1},100)},self.preventScrollPropagation=function preventScrollPropagationFn(ele){try{self.PAssert(2731,self.isDOMNode(ele),"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2732,!self.hasClass(ele,"customScroller"),"Should not prevent scroll prop on pane")}catch(PERR){self.reportError(PERR)}return ele.scrollHeight===ele.clientHeight?!1:(0===ele.scrollTop?ele.scrollTop=1:ele.scrollTop+ele.offsetHeight>=ele.scrollHeight&&(ele.scrollTop=ele.scrollHeight-ele.offsetHeight-1),!0)},self.trimString=function trimStringFn(str){str=str.replace(/^\s\s*/,"");for(var ws=/\s/,i=str.length;ws.test(str.charAt(--i)););return str.slice(0,i+1)},self.enforceScroll=function enforceScrollFn(force,top){(force||(platform.ios||platform.android)&&(!platform.app||platform.ios71))&&(setTimeout(function(){window.scrollTo(0,top||0)},0),requestAnimationFrame(function(){window.scrollTo(0,top||0)}),window.scrollTo(0,top||0),document.body.scrollTop=0)},self.preventDefault=function preventDefaultFn(e){if(e&&e.preventDefault)e.preventDefault();else try{self.PAssert(2763,!1,"Invalid event object: "+e)}catch(PERR){self.reportError(PERR)}},self.preventClick=function preventClickFn(){self.addClass(self.element("outerWrapper"),"noClick"),window.ontouchstart=self.preventDefault,requestAnimationFrame(function(){window.ontouchstart=void 0,self.removeClass(self.element("outerWrapper"),"noClick")})},self.searchVMLIs=function searchVMLIsFn(options){try{self.PAssert(2764,options,"Must supply a valid options param")}catch(PERR){self.reportError(PERR)}self.vmMain.notifySearchStart();try{var startItem;if(options.itemStoreFilter){var storeMan=self.vmMain.itemStoreManager;storeMan.runForEachStore(function(itemStore){var item=options.item,searchRoot=item&&item.belongsToItemStore(itemStore)?item:itemStore.getRoot();searchFromVMLI(searchRoot,options)},options.itemStoreFilter)}else if(options.item){try{self.PAssert(2765,!options.itemStore&&!options.itemStoreFilter,"Should only specify one of item/itemStore/itemStoreFilter")}catch(PERR){self.reportError(PERR)}searchFromVMLI(options.item,options)}else if(options.itemStore){try{self.PAssert(2766,!options.itemStoreFilter,"Should only specify one of item/itemStore/itemStoreFilter")}catch(PERR){self.reportError(PERR)}searchFromVMLI(options.itemStore.getRoot(),options)}else{try{self.PAssert(2767,!1,"Must specify a valid search root, using the default root is deprecated")}catch(PERR){self.reportError(PERR)}startItem=self.vmMain.itemStoreManager.getDefaultItemStore().getRoot()}}catch(err){self.reportError(err)}self.vmMain.notifySearchEnd()},self.searchVMLIsAsArray=function searchVMLIsAsArrayFn(options){var arr=[];return options.each=function(item){arr.push(item)},self.searchVMLIs(options),arr},self.getActiveSearch=function getActiveSearchFn(){return self.focusedPane.search},self.invertObject=function invertObjectFn(obj){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(target[obj[i]]=i);return target},self.fieldMapOut=self.invertObject(self.fieldMapIn),self.translateFieldIn=function translateFieldInFn(field){try{self.PAssert(2771,self.fieldMapIn[field],"Incoming field should be added to the field map",field)}catch(PERR){self.reportError(PERR)}try{self.PAssert(2772,"string"==typeof field,"Should only pass strings to the field mapping function",field)}catch(PERR){self.reportError(PERR)}return self.fieldMapIn[field]||field},self.translateFieldOut=function translateFieldOutFn(field){try{self.PAssert(2773,self.fieldMapOut[field],"Incoming field should be added to the field map",field)}catch(PERR){self.reportError(PERR)}try{self.PAssert(2774,"string"==typeof field,"Should only pass strings to the field mapping function",field)}catch(PERR){self.reportError(PERR)}return self.fieldMapOut[field]||field},self.translateObjIn=function translateObjInFn(obj){return getMapping(obj,self.fieldMapIn)},self.translateObjOut=function translateObjOutFn(obj){return getMapping(obj,self.fieldMapOut)};var eventListeners={};self.addCustomEventListener=function addCustomEventListenerFn(name,fn,priority){try{self.PAssert(2775,name,"Must provide a valid event name")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2776,fn,"Must provide a valid event handler to add")}catch(PERR){self.reportError(PERR)}if(void 0!==priority){var evs=eventListeners[name],entry={fn:fn,pri:priority};evs?eventListeners[name].insertSorted(entry,function(left,right){return right>left?1:-1}):(eventListeners[name]=[entry],window.addEventListener(name,function(e){for(var i=0;i<eventListeners[name].length;++i){var ev=eventListeners[name][i],ret=ev.fn(e);if(ret===!1)break}}))}else window.addEventListener(name,fn)},self.removeCustomEventListener=function removeCustomEventListenerFn(name,fn,isPriority){try{self.PAssert(2777,name,"Must provide a valid event name")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2778,fn,"Must provide a valid event handler to remove")}catch(PERR){self.reportError(PERR)}if(isPriority){for(var evs=eventListeners[name],found=!1,i=0;i<evs.length;++i)if(evs[i].fn===fn){found=!0,evs.removeAt(i);break}0===evs.length;try{self.PAssert(2779,found,"Event listener should always be found when removing")}catch(PERR){self.reportError(PERR)}}else window.removeEventListener(name,fn)},self.fireCustomEvent=function fireCustomEventFn(name,data,target){if(document.createEvent){var eventObj=document.createEvent("Event");return data&&(eventObj.data=data),eventObj.initEvent(name,!0,!0),(target||window).dispatchEvent(eventObj)}try{self.PAssert(2780,!1,"Unable to fire custom event")}catch(PERR){self.reportError(PERR)}},self.fireKeyEvent=function fireKeyEventFn(ele,keyData,keyDataPress){fireKeyEventInternal(ele,"keydown",keyData),fireKeyEventInternal(ele,"keypress",keyDataPress||keyData),fireKeyEventInternal(ele,"keyup",keyData)},self.fireClickEvent=function fireClickEventFn(ele,button){fireClickEventInternal(ele,"mousedown",button),fireClickEventInternal(ele,"mouseup",button),fireClickEventInternal(ele,"mouseclick",button)},self.fireMouseUp=function fireMouseUpFn(ele,button){fireClickEventInternal(ele,"mouseclick",button)},self.fireDragStart=function fireDragStartFn(ele){fireClickEventInternal(ele,"mousedown",ButtonCode.Left,{offsetX:10,offsetY:10,clientX:10,clientY:10})},self.fireDragMove=function fireDragMoveFn(ele,x,y){if(ele||(ele=NativeSel.getSelectionNode()),document.createEvent){var evObj=document.createEvent("Event");
evObj.pageX=x,evObj.pageY=y,evObj.synthetic=!0,evObj.initEvent("mousemove",!0,!0),ele.dispatchEvent(evObj)}else try{self.PAssert(2787,!1,"Unable to fire click event")}catch(PERR){self.reportError(PERR)}},self.fireDragEnd=function fireDragEndFn(ele){fireClickEventInternal(ele,"mouseup",ButtonCode.Left)},self.clone=function cloneFn(obj,noFunctions){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(noFunctions&&self.isFunction(obj[i])||(target[i]=obj[i]));return target},self.cloneMouseEvent=function cloneMouseEventFn(e){return{altKey:e.altKey,button:e.button,buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,ctrlKey:e.ctrlKey,currentTarget:e.currentTarget,fromElement:e.fromElement,metaKey:e.metaKey,pageX:e.pageX,pageY:e.pageY,relatedTarget:e.relatedTarget,srcElement:e.srcElement,shiftKey:e.shiftKey,target:e.target,timestamp:e.timestamp,toElement:e.toElement,type:e.type,view:e.view,which:e.which,x:e.x,y:e.y,preventDefault:e.preventDefault.bind(e),stopPropagation:e.stopPropagation.bind(e),stopImmediatePropagation:e.stopImmediatePropagation.bind(e)}},self.loadXML=function loadXMLFn(xml){try{if("undefined"!=typeof window.DOMParser)return(new window.DOMParser).parseFromString(xml,"text/xml");if("undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")){var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");return xmlDoc.async="false",xmlDoc.loadXML(xml),xmlDoc}try{self.PAssert(2788,!1,"No XML parser found")}catch(PERR){self.reportError(PERR)}return void 0}catch(err){return void self.reportError(err)}},self.adjustOriginToBeInsideBounds=function adjustOriginToBeInsideBoundsFn(bounds,rect,xMin,yMin,xPad,yPad){var out={x:rect.left,y:rect.top};return xMin=xMin||0,yMin=yMin||0,xPad=xPad||0,yPad=yPad||0,rect.bottom+yPad>bounds.bottom&&(out.y=Math.max(yMin,rect.top-(rect.bottom+yPad-bounds.bottom))),rect.top-yPad<bounds.top&&(out.y=Math.max(yMin,rect.top)),rect.right+xPad>bounds.right&&(out.x=Math.max(xMin,rect.left-(rect.right+xPad-bounds.right))),out},self.adjustLeftToBeInsideBounds=function adjustLeftToBeInsideBoundsFn(bounds,left,width,leftPad){return left+width+leftPad>bounds.right&&(left=bounds.right-leftPad-width),left},self.adjustHeightToBeInsideBounds=function adjustHeightToBeInsideBoundsFn(bounds,rect,minHeight,maxHeight,yPad){if(rect.bottom+yPad>bounds.bottom&&(rect.bottom=bounds.bottom-yPad,rect.bottom-rect.top<minHeight)){var lineHeight=25,newTop=Math.max(0,rect.bottom-minHeight);rect.top=newTop}return Math.min(maxHeight,rect.bottom-rect.top)},self.setOrigin=function setOriginFn(rect,xOrigin,yOrigin){var xDiff=rect.left-xOrigin,yDiff=rect.top-yOrigin;rect.left-=xDiff,rect.right-=xDiff,rect.top-=yDiff,rect.bottom-=yDiff},self.copyStyles=function copyStylesFn(src,dst,styles){try{self.PAssert(2789,src,"Must have a valid source element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2790,dst,"Must have a valid dest element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2791,styles,"Must have a valid list of styles to copy")}catch(PERR){self.reportError(PERR)}var computedStyle=window.getComputedStyle(src);if(computedStyle){for(var values=[],i=0;i<styles.length;++i)values[i]=computedStyle[styles[i]];for(var i=0;i<values.length;++i)dst.style[styles[i]]=values[i]}},self.hasClass=function hasClassFn(elem,cls){try{self.PAssert(2792,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}return elem&&elem.classList?elem.classList.contains(cls):void 0},self.removeClass=function removeClassFn(elem,cls){try{self.PAssert(2793,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}elem&&elem.classList&&elem.classList.remove(cls)},self.addClass=function addClassFn(elem,cls){try{self.PAssert(2794,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}elem&&elem.classList&&elem.classList.add(cls)},self.toggleClass=function toggleClassFn(elem,cls){try{self.PAssert(2795,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}elem&&elem.classList&&elem.classList.toggle(cls)},self.css=function cssFn(elem,styles){try{self.PAssert(2796,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}if(elem)for(var style in styles)if(styles.hasOwnProperty(style)){var value=styles[style];"number"==typeof value&&(value+="px"),elem.style[style]=value}},self.findChild=function findChildFn(elem,cls){try{self.PAssert(2797,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}if(elem)for(var i=0;i<elem.childElementCount;++i){var child=elem.children[i];if(self.hasClass(child,cls))return child;var match=self.findChild(child,cls);if(match)return match}return void 0},self.getPluginForElement=function getPluginForElementFn(ele){return self.findParent(ele,"plugin",4)},self.findParentInItem=function findParentInItemFn(element,cls){for(;element&&!self.hasClass(element,"item");){if(self.hasClass(element,cls))return element;element=element.parentNode}},self.findParent=function findParentFn(elem,cls,num){try{self.PAssert(2798,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}if(num||(num=1e3),elem)for(var parent=elem,i=0;num>i&&parent;++i,parent=parent.parentNode)if(self.hasClass(parent,cls))return parent;return void 0},self.findParentID=function findParentIDFn(elem,id,num){try{self.PAssert(2800,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}if(num||(num=1e4),elem)for(var parent=elem,i=0;num>i&&parent;++i,parent=parent.parentNode)if(parent.id===id)return parent;return void 0},self.findParentAttr=function findParentAttrFn(elem,attr,value){try{self.PAssert(2801,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}if(elem)for(var parent=elem;parent&&parent.getAttribute;parent=parent.parentNode)if(parent.getAttribute(attr)===value)return parent;return void 0},self.isAncestor=function isAncestorFn(elem,candidate){try{self.PAssert(2802,elem,"Must have a valid element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2803,candidate,"Must have a valid candidate")}catch(PERR){self.reportError(PERR)}for(;elem&&elem!==candidate;)elem=elem.parentNode;return!!elem},self.firstChildTag=function firstChildTagFn(elem,tag){try{self.PAssert(2804,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2805,tag,"Must pass in a valid tag to check")}catch(PERR){self.reportError(PERR)}if(elem)for(var upper=tag.toUpperCase(),i=0;i<elem.childElementCount;++i)if(elem.children[i].tagName===upper)return elem.children[i];return void 0},self.insertAfter=function insertAfterFn(reference,newNode){try{self.PAssert(2807,reference,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2808,newNode,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}reference.parentNode.insertBefore(newNode,reference.nextSibling)},self.prependChild=function prependChildFn(parent,newNode){try{self.PAssert(2809,parent,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2810,newNode,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}parent.insertBefore(newNode,parent.firstChild)},self.getAncestorChain=function getAncestorChainFn(ele){for(var ancestors=[],depth=0,ancestor=ele;ancestor;)ancestor.push(ancestor),ancestor=ancestor.parentNode;return ancestors},self.findCommonAncestor=function findCommonAncestorFn(eles){for(var candidates=self.getAncestorChain(eles),candidateIndex=0,i=1;i<eles.length&&candidateIndex+1<candidates.length;++i)for(var ele=eles[i];ele;){ele=ele.parentNode;var newCandidateIndex=candidates.indexOf(ele,candidateIndex);if(newCandidateIndex>=0){candidateIndex=newCandidateIndex;break}}return candidates[candidateIndex]},self.isAttachedToDoc=function isAttachedToDocFn(ele){try{self.PAssert(2812,ele,"Must supply a valid element to check")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2813,ele.ownerDocument,"Checked element must have a valid owner document")}catch(PERR){self.reportError(PERR)}return ele.ownerDocument?ele.ownerDocument.body.contains(ele):!1},self.offset=function offsetFn(elem){try{self.PAssert(2814,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,docElem=elem.ownerDocument.documentElement,win=doc.defaultView,customAns={top:box.top+win.pageYOffset-docElem.clientTop,left:box.left+win.pageXOffset-docElem.clientLeft};return customAns},self.position=function positionFn(elem){var parent=elem.offsetParent,box=elem.getBoundingClientRect(),boxP=parent.getBoundingClientRect();return{left:box.left-boxP.left,top:box.top-boxP.top}},self.height=function heightFn(elem){try{self.PAssert(2816,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}var customHeight=elem.offsetHeight,cStyle=window.getComputedStyle(elem);return cStyle?("border-box"!==cStyle.boxSizing&&(customHeight-=parseFloat(cStyle.paddingTop)+parseFloat(cStyle.paddingBottom)),customHeight-=parseFloat(cStyle.borderTopWidth)+parseFloat(cStyle.borderBottomWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::height"),customHeight},self.width=function widthFn(elem){try{self.PAssert(2818,elem,"Must pass in a valid element")}catch(PERR){self.reportError(PERR)}var customWidth=elem.offsetWidth,cStyle=window.getComputedStyle(elem);return cStyle?("border-box"!==cStyle.boxSizing&&(customWidth-=parseFloat(cStyle.paddingLeft)+parseFloat(cStyle.paddingRight)),customWidth-=parseFloat(cStyle.borderLeftWidth)+parseFloat(cStyle.borderRightWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::width"),customWidth};var onLoadCallbacks;self.runOnLoad=function runOnLoadFn(cb){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(cb):(onLoadCallbacks||(onLoadCallbacks=[],document.addEventListener("DOMContentLoaded",loadDone,!1),window.addEventListener("load",loadDone,!1)),onLoadCallbacks[onLoadCallbacks.length]=cb)},self.sendFeedback=function sendFeedbackFn(name,message,cb){var appInfo={};self.getAppInfo(appInfo),appInfo.eventStream=void 0;var notes=message+"\r\n\r\n\r\n"+JSON.stringify(appInfo,void 0,3),bug={name:name,notes:notes};bug.email=self.getUserIdentifier(),bug.premiumStatus=self.billingManager.getPremiumStatus();var sendBug=function(){self.XHR_PrivateAPI({type:"POST",path:"/feedback/suggestion",data:bug,cb:function cbFn(xhr){log("XHR Response: ",xhr.status,xhr),cb()}.bind(this)})}.bind(this);sendBug()};var __xhrRequests={};self.getXHRStats=function getXHRStatsFn(){return __xhrRequests};var maxRetryCount=6,retryTimeouts=[0,5,15,35,80,170,400,1200],retryErrorCodes=[0,408,429,500,502,503,504];self.XHR=function XHRFn(params){function retry(){try{self.PAssert(2823,maxRetries>currentRetries,"Should not be calling retry once retries have been exhausted")}catch(PERR){self.reportError(PERR)}maxRetries>currentRetries?(currentRetries++,notifyStatsXHRRetry(url),setTimeout(sendXHR,1e3*retryTimeouts[currentRetries])):(notifyStatsXHRFailure(url),self.reportError(new Error("XHR Failed: "+url)))}function sendXHR(){var xhr=new XMLHttpRequest;if(xhr.timeout=timeout,xhr.onreadystatechange=function(){4===xhr.readyState&&(200!==xhr.status?maxRetries>currentRetries?(xhr.retry=retry,autoRetry&&retryErrorCodes.indexOf(xhr.status)>=0?xhr.retry():cb(xhr)):(notifyStatsXHRFailure(url),cb(xhr)):cb(xhr))},username&&password?xhr.open(type.toUpperCase(),url,!0,username,password):xhr.open(type.toUpperCase(),url,!0),headers)for(var key in headers)xhr.setRequestHeader(key,headers[key]);if(data){xhr.setRequestHeader("Accept","*/*"),headers&&headers["Content-Type"]||xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");var content;content=data instanceof Blob?data:generateQueryString(data),xhr.send(content)}else xhr.send()}try{self.PAssert(2821,params.url,"Must specify a valid URL to use")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2822,params.type,"Must specify a valid request type")}catch(PERR){self.reportError(PERR)}var url=params.url,type=params.type,cb=params.cb,data=params.data,headers=params.headers,autoRetry=params.autoRetry,timeout=params.timeout,maxRetries=Math.min(params.maxRetries||2,maxRetryCount),currentRetries=0,username=params.username,password=params.password;notifyStatsXHRRequest(url),sendXHR()},self.XHR_PrivateAPI=function XHR_PrivateAPIFn(params){try{self.PAssert(2824,params.type,"Must supply a valid type")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2825,params.path&&params.path.startsWith("/"),"Must supply a valid path"+params.path)}catch(PERR){self.reportError(PERR)}var goog=require("goog"),AccountManager=require("AccountManager"),protocol=platform.getDeployVar(DeployVariable.APIProtocol),host=platform.getDeployVar(DeployVariable.APIHost),basePath="/private/v1";if(params.requireAuth){try{self.PAssert(2826,AccountManager.isCurrentlyAuthorized("me"),"Must have a valid auth token before making API calls")}catch(PERR){self.reportError(PERR)}if(!AccountManager.isCurrentlyAuthorized("me"))return void AccountManager.onUserAuthorized("me",function(){self.XHR_PrivateAPI(params)});var id_token=AccountManager.getDefaultIDToken();try{self.PAssert(2827,id_token,"Must have a valid ID token")}catch(PERR){self.reportError(PERR)}var token=AccountManager.getDefaultAccessToken();try{self.PAssert(2828,token,"If account is authorized it must have a valid token")}catch(PERR){self.reportError(PERR)}var gid=AccountManager.getAccountGID("me");try{self.PAssert(2829,gid,"If account is authorized it must have a valid GID")}catch(PERR){self.reportError(PERR)}var accountToken=AccountManager.getAccountTokenSync("me");try{self.PAssert(2830,AccountManager.isTokenValid(accountToken),"Must have a valid account token: ",accountToken)}catch(PERR){self.reportError(PERR)}params.headers||(params.headers={});try{self.PAssert(2831,!params.headers.token,"Callers should not be setting access token themselves")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2832,!params.headers.id_token,"Callers should not be setting id_token themselves")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2833,!params.headers.gid,"Callers should not be setting user GID themselves")}catch(PERR){self.reportError(PERR)}id_token&&(params.headers.id_token=id_token),params.headers.token=token,params.headers.gid=gid}var XHRParams={type:params.type,url:protocol+host+basePath+params.path,data:params.data,cb:params.cb,headers:params.headers,autoRetry:params.autoRetry,maxRetries:params.maxRetries};self.XHR(XHRParams)},self.XHR_PublicAPI=function XHR_PublicAPIFn(params){};var isXHRWrapped=!1,idXHR=1,notifyURLs={};self.registerURLForNotifyXHR=function registerURLForNotifyXHRFn(url,cb){return notifyURLs[url]||(notifyURLs[url]=cb),isXHRWrapped};var ForceTimeoutDuration=70,timeoutURLs=["https://drive.google.com/otservice/save","https://drive.google.com/otservice/bind"];self.wrapXHR=function wrapXHRFn(){try{var __open=window.XMLHttpRequest.prototype.open,__send=window.XMLHttpRequest.prototype.send;window.XMLHttpRequest.prototype.open=function(method,url,async,user,password){this.url=url,void 0===async&&(async=!0);try{__open.call(this,method,url,async,user,password)}catch(openErr){throw self.reportError(openErr),openErr}},window.XMLHttpRequest.prototype.send=function(data){notifyXHR(this),!this.timeout&&shouldSetXHRTimeout(this)&&(this.timeout=self.seconds(ForceTimeoutDuration));try{this.url&&!this.url.startsWith("https://nikkomsgchannel")&&__send.call(this,data)}catch(sendErr){throw self.reportError(sendErr),sendErr}}}catch(err){return void self.reportError(err)}isXHRWrapped=!0},self.wrapXHR(),self.areObjectsEqual=function areObjectsEqualFn(obj1,obj2){return JSON.stringify(obj1)===JSON.stringify(obj2)},self.JSONP=function JSONPFn(params){try{self.PAssert(2834,params.url,"Must supply a valid URL to fetch")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2835,params.cb,"Must supply a valid callback")}catch(PERR){self.reportError(PERR)}var url=params.url,data=params.data,cb=params.cb;if(data){for(var queryString="",keys=Object.keys(data),i=0;i<keys.length;i++)queryString+=encodeURIComponent(keys[i])+"="+encodeURIComponent(data[keys[i]]),i!==keys.length-1&&(queryString+="&");url+="?"+queryString}var timestamp=Date.now(),generatedFunction="jsonp"+Math.round(timestamp+10001*Math.random());window[generatedFunction]=function(json){cb(json),delete window[generatedFunction]},url+=-1===url.indexOf("?")?"?":"&";var jsonpScript=document.createElement("script");jsonpScript.id=generatedFunction,jsonpScript.setAttribute("src",url+"callback="+generatedFunction),document.getElementsByTagName("head")[0].appendChild(jsonpScript)},self.element=function elementFn(id,reload){try{self.PAssert(2836,id,"Tried to get an element without an id")}catch(PERR){self.reportError(PERR)}(!self.elements[id]||reload)&&(self.elements[id]=document.getElementById(id));try{self.PAssert(2837,self.elements[id],"Tried to get an element that doesn't exist",id)}catch(PERR){self.reportError(PERR)}return self.elements[id]},self.openUrl=function openUrlFn(url,e,notBlank){try{self.PAssert(2838,url,"Must always provide a valid URL to open")}catch(PERR){self.reportError(PERR)}if(!url)return!1;if(platform.standalone){var a=document.createElement("a");a.setAttribute("href",url),a.setAttribute("target","_blank"),a.setAttribute("rel","noopener noreferrer");var dispatch=document.createEvent("HTMLEvents");dispatch.initEvent("click",!0,!0),a.dispatchEvent(dispatch)}else if(platform.app){var validProtocols,isValid,i,supportsFullProtocol=platform.ios&&platform.appv>=5||platform.android&&platform.appv>=5||platform.isChrome;supportsFullProtocol||!url.startsWith("http://")&&!url.startsWith("https://")?url.startsWith("/")&&(url=window.location.host+url):url=url.replace("http://","").replace("https://",""),platform.ios&&(url.startsWith("tel:")||url.startsWith("mailto:")||url.startsWith("callto:"))?open(url):self.nativeBridge.sendToApp("openURL",url),e&&(self.handlerPreventStop(e),e.returnFalse=!0)}else notBlank?open(url,"_self"):open(url,"_blank");return!0},self.isDateSoft=function isDateSoftFn(dateText){if(dateText)switch(dateText.toUpperCase()){case"NEXT":case"SOON":case"LATER":case"SOMEDAY":case"NOW":return!0}return!1},self.isDateValid=function isDateValidFn(date){return date&&date instanceof Date&&!isNaN(date.getTime())},self.getLocationOrigin=function getLocationOriginFn(){return window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")};var spellcheckEnabled;self.isSpellcheckEnabled=function isSpellcheckEnabledFn(){return spellcheckEnabled},self.handlerPreventStop=function handlerPreventStopFn(e){e.preventDefault(),e.stopImmediatePropagation?e.stopImmediatePropagation():e.stopPropagation()},self.handlerStopProp=function handlerStopPropFn(e){e.stopImmediatePropagation()},self.fFalse=function fFalseFn(){return!1},self.fTrue=function fTrueFn(){return!0},self.emptyFn=function emptyFnFn(){},self.weeks=function weeksFn(weeks){return 6048e5*weeks},self.days=function daysFn(days){return 864e5*days},self.hours=function hoursFn(hours){return 36e5*hours},self.minutes=function minutesFn(mins){return 6e4*mins},self.seconds=function secondsFn(secs){return 1e3*secs},self.toFileSize=function toFileSizeFn(bytes){if(bytes){var exp=Math.log(bytes)/Math.log(1024)|0,result=(bytes/Math.pow(1024,exp)).toFixed(2);return result+" "+(0===exp?"bytes":"KMGTPEZY"[exp-1]+"B")}return null},self.curry=function curryFn(fn){var args=[].slice.call(arguments,1);return function(){return fn.apply(this,args.concat(Array.prototype.slice.call(arguments,0)))}},self.saveFile=function saveFileFn(content,name){if(platform.appPlatform===AppPlatform.Chrome)try{self.nativeBridge.sendToApp("exportData",{content:content,filename:name})}catch(err){self.reportError(err)}else{var blob=new Blob([content],{type:"text/plain;charset=utf-8"});saveAs(blob,name)}},self.downloadFile=function downloadFileFn(url){if(document.createEvent){var link=document.createElement("a");link.href=url;var e=document.createEvent("MouseEvents");e.initEvent("click",!0,!0),link.dispatchEvent(e)}else window.open(url,"_self")},self.printPage=function printPageFn(url){if(!platform.app){var w=window.open(url);w.print()}},util.hasURLParam("nolocal","true")&&(self.noLocalWrites=!0),self.eventStream=new RingBuffer(25),window.__CHECK_OAUTH=function(){self.XHR({type:"GET",url:"https://accounts.google.com/o/oauth2/auth?scope=email&redirect_uri=http://moo.do&response_type=token&client_id=597847337936.apps.googleusercontent.com",cb:function cbFn(xhr){log("XHR OAuth: ",xhr)}})},self.createCustomScroller=function createCustomScrollerFn(element){var iScroller=new IScroll(element,{scrollbars:!0,shrinkScrollbars:"clip",bindToWrapper:!0,preventDefault:!1,scrollX:!1,scrollY:!0,deceleratopn:.005,probeType:3,useTransition:!1});return iScroller};var reactCells={};self.setReactCell=function setReactCellFn(item,id){try{self.PAssert(2840,!reactCells[id]||reactCells[id]===item,"Should never overwrite a react item, always clear first")}catch(PERR){self.reportError(PERR)}reactCells[id]=item},self.getReactCell=function getReactCellFn(element){var reactCell;if(element.nodeType!==Node.TEXT_NODE){var key=element.getAttribute("data-moo-id");reactCell=reactCells[key]}return reactCell},self.clearReactCell=function clearReactCellFn(item,id){try{self.PAssert(2841,reactCells[id]===item,"Must be clearing the same item that was set")}catch(PERR){self.reportError(PERR)}reactCells[id]=void 0};var reactElements={};return self.setDataFor=function setDataForFn(element,value,id){try{self.PAssert(2842,!reactElements[id]||reactElements[id]===value,"Should never overwrite a react element, always clear first")}catch(PERR){self.reportError(PERR)}reactElements[id]=value},self.clearDataFor=function clearDataForFn(id){delete reactElements[id]},self.dataFor=function dataForFn(element,checkParents,noKO){if(element.nodeType===Node.TEXT_NODE&&(element=element.parentNode),checkParents){for(var startElement=element;element&&element!==document;){var key=element.getAttribute("data-moo-id");if(reactElements[key])return reactElements[key];element=element.parentNode}return!noKO&&ko.dataFor(startElement)}if(element){var key=element.getAttribute("data-moo-id");return reactElements[key]||!noKO&&ko.dataFor(element)}},self.getItemForElement=function getItemForElementFn(el){var item=self.dataFor(el,!0,!0);try{self.PAssert(2843,!item||self.isVMLI(item),"Must always find a valid VMLI for a given element: "+self.elementToString(el))}catch(PERR){self.reportError(PERR)}return self.isVMLI(item)?item:void 0},self.getIndexForElement=function getIndexForElementFn(el){var itemParent=self.findParent(el,"item"),reactCell=self.getReactCellForElement(itemParent),index=reactCell?reactCell.getIndex():-1;return index},self.getPaneForElement=function getPaneForElementFn(el){var paneEl=self.findParent(el,"pane");if(paneEl)return self.dataFor(paneEl);var overviewEl=self.findParent(el,"paneOverviewScroller");return overviewEl?self.dataFor(overviewEl):void 0},self.getReactCellForElement=function getReactCellForElementFn(el){for(;el&&el!==document.body;){var reactCell=self.getReactCell(el);if(reactCell)return reactCell;el=el.parentNode}try{self.PAssert(2846,!1,"Should always be able to find a valid item for a given element",self.getElementPath(el))}catch(PERR){self.reportError(PERR)}},self.getCellForElement=function getCellForElementFn(el){var reactCell=self.getReactCellForElement(el);return reactCell?reactCell.getCell():void 0},self.classNames=function classNamesFn(){for(var args=arguments,classes=[],i=0;i<args.length;i++){var arg=args[i];if(arg)if("string"==typeof arg||"number"==typeof arg)classes.push(arg);else if("object"==typeof arg)for(var key in arg)arg.hasOwnProperty(key)&&arg[key]&&classes.push(key)}return classes.join(" ")},self.extend=function extendFn(target,source){for(var key in source)source.hasOwnProperty(key)&&(target[key]=source[key]);return target},self.isVMLI=function isVMLIFn(obj){return obj instanceof VMLI},self.isPane=function isPaneFn(obj){return obj instanceof VMPane},self.decodeURLObject=function decodeURLObjectFn(str){var obj;if(str){var decodedStr=self.b64_to_utf8(str);try{obj=JSON.parse(decodedStr)}catch(err){self.reportError(err)}}return obj},self.encodeMIMEHeader=function encodeMIMEHeaderFn(str){return"=?UTF-8?B?"+self.utf8_to_b64(str)+"?="},self.utf8_to_b64=function utf8_to_b64Fn(str){var b64;try{b64=window.btoa(unescape(encodeURIComponent(str)))}catch(err){self.reportError(err)}return b64},self.b64_to_utf8=function b64_to_utf8Fn(str){var utf8;try{utf8=decodeURIComponent(escape(window.atob(str)))}catch(err){self.reportError(err)}return utf8},self.qp_to_utf8=function qp_to_utf8Fn(str){var utf8;try{utf8=str.replace(/[\t\x20]$/gm,"").replace(/=(?:\r\n?|\n|$)/g,"").replace(/=([a-fA-F0-9]{2})/g,function($0,$1){var codePoint=parseInt($1,16);return String.fromCharCode(codePoint)})}catch(err){self.reportError(err)}return utf8},self.isHTTPStatusCode=function isHTTPStatusCodeFn(result,code){return result&&result.error&&result.error.code===code},self.timeouts={},self.hasTimeoutOnce=function hasTimeoutOnceFn(name){return!!self.timeouts[name]},self.timeoutOnce=function timeoutOnceFn(name,cb,time,arg,arg2,arg3){try{self.PAssert(2847,name,"Must supply a valid name")}catch(PERR){self.reportError(PERR)}try{self.PAssert(2848,self.isFunction(cb),"must supply a valid cb fn")}catch(PERR){self.reportError(PERR)}var t=self.timeouts[name];t&&clearTimeout(t),self.timeouts[name]=setTimeout(function(){delete self.timeouts[name],cb(arg,arg2,arg3)},time)},self.clearTimeoutOnce=function clearTimeoutOnceFn(name){var t=self.timeouts[name];t&&clearTimeout(t)},self.animFrameOnce=function animFrameOnceFn(name,cb){var t=self.timeouts[name];t&&cancelAnimationFrame(t),self.timeouts[name]=requestAnimationFrame(cb)},self.contentSetAuto=void 0,self.reEnableNone=function reEnableNoneFn(contentEle){try{self.PAssert(2849,contentEle,"Must have a valid element to set pointer-events on")}catch(PERR){self.reportError(PERR)}contentEle.style["pointer-events"]=""},self.elementFromPoint=function elementFromPointFn(x,y,target){return document.elementFromPoint(x,y)},self.parentTextForItem=function parentTextForItemFn(item){for(var parents=item.parents(),parentText="",i=1;i<parents.length;i++){i>1&&(parentText+="  |  ");var text=parents[i].generateTitleText(parents[i].getParsedText());parentText+=text}return parentText},self.scrollToAndHighlightItem=function scrollToAndHighlightItemFn(item,fromPane){item.highlight(),self.vmMain.paneManager.runForEachPane(function(pane){if(pane!==fromPane){var index=pane.indexOfItem(item);if(0>index&&pane.type===PaneMode.Outline&&item.isDescendantOf(pane.item.get())&&pane.search.isMatched(item)){self.vmMain.beginUpdateItems();for(var it=item.parent();it&&it!==pane.item.get();)it.isCollapsed(pane,!1)&&(pane.setIgnoreRestoreScroll(!0),it.setCollapsed(!1,pane,!1)),it=it.parent();self.vmMain.commitUpdateItems(),index=pane.indexOfItem(item)}index>=0&&pane.scrollIndexToMiddle(index,ScrollDuration.Default)}})},platform.demo&&self.enableDemoMode(),self.setupGoogleAPIListener(),self}),define("gdata",["ko","globals","Constants","data","platform","RingBuffer"],function(ko,g,C,d,platform,RingBuffer){function promptTrashDoc(){g.menus.alert({text:"You are using an out of date document - please contact support@moo.do for help.",actionText:"OKAY",callback:function callbackFn(){g.loadGoogleAPI("drive","v2",function(){gapi.client.drive.files.trash({fileId:g.settings.get(Settings.gdocId)}).execute(function(response){g.reportError(response.error?new Error("Error deleting out of date doc - "+response.error):new Error("Successfully deleted out of date doc - "+g.settings.get(Settings.gdocId))),d.clearData(function(){g.reload()})})})}})}function ensureWriteAction(){try{g.PAssert(2898,!self.inCompoundOperation,"Should never be in a compound operation after sync block finishes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2899,!self.wantCompoundOperation,"Should never want a compound operation after a sync block finishes")}catch(PERR){g.reportError(PERR)}if(self.inCompoundOperation){try{self.inCompoundOperation=!1,self.wantCompoundOperation=!1,g.vmMain.notifyDriveOperationError(),self.model.endCompoundOperation()}catch(err){g.reportError(err)}g.reportError(new Error("Compound operation open after sync block finished"))}ensureActionTimeout=void 0}function attachEvents(item){try{g.PAssert(2905,item,"Must have a valid local item to attach events to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2906,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2907,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2908,item.data,"Must have a valid remote item to attach events to")}catch(PERR){g.reportError(PERR)}item.data.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,item.onObjectChanged.bind(item))}function ensureRemoteItemsArray(item){self.beginWriteAction();try{g.PAssert(2948,item instanceof VMLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2949,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2950,item.data,"Must have valid remote item to attach events to and create")}catch(PERR){g.reportError(PERR)}var itemList=self.get(item.data,"items");return itemList||(itemList=self.model.createList(),self.set(item.data,"items",itemList)),itemList}function ensureRemoteArchiveArray(item){self.beginWriteAction();try{g.PAssert(2951,item instanceof VMLI)}catch(PERR){g.reportError(PERR)}try{g.PAssert(2952,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2953,item.data,"Must have valid remote item to attach events to and create")}catch(PERR){g.reportError(PERR)}var archivedList=self.get(item.data,"archivedItems");return archivedList||(archivedList=self.model.createList(),self.set(item.data,"archivedItems",archivedList)),archivedList}function setRemoteVersion(data){self.beginWriteAction();var v=self.getVersion(data,VersionType.Structure);v=v?v+1:1;var verStr;self.set(data,"version",v)}function setRemoteTextVersion(data){self.beginWriteAction();var v=self.getVersion(data,VersionType.Text);v=v?v+1:1;var verStr;self.set(data,"versionText",v)}function reportDocumentError(fn,type,data){data||(data=new Error("DocError: "+fn+"."+type)),self.docErrors.push({fn:fn,type:type,data:data}),g.reportError(data)}function saveChangesInternal(item,changes){try{g.PAssert(2996,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var itemData=self.canSave(item);if(itemData){if(g.isEmpty(changes))return void(ShouldLog(LogLevels.Warning)&&log("Skipped remote saving an empty object"));self.beginWriteAction(),d.addPendingUpdate(item.id);for(var prop in changes){try{g.PAssert(2997,changes.hasOwnProperty(prop),"Changes should only contain properties they own")}catch(PERR){g.reportError(PERR)}if(changes.hasOwnProperty(prop))switch(prop){case"text":try{g.PAssert(2998,g.isString(changes.text))}catch(PERR){g.reportError(PERR)}try{g.PAssert(2999,changes.text.indexOf(window.AttachChar)<0,"Remote syncd changes should never contain AttachChar")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3e3,item.isNote()||changes.text.indexOf("\n")<0,"Remote syncd changes should never contain newlines")}catch(PERR){g.reportError(PERR)}self.set(itemData,"text",changes.text);break;case"date":try{g.PAssert(3001,!changes.date||g.isNumber(changes.date),"Invalid date type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"date",changes.date);break;case"repeatDate":try{g.PAssert(3002,!changes.repeatDate||g.isString(changes.repeatDate),"Invalid repeat date type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"repeatDate",changes.repeatDate);break;case"dateCreated":try{g.PAssert(3003,g.isNumber(changes.dateCreated),"Invalid dateCreated type")
}catch(PERR){g.reportError(PERR)}self.set(itemData,"dateCreated",changes.dateCreated);break;case"dateCompleted":try{g.PAssert(3004,!changes.dateCompleted||g.isNumber(changes.dateCompleted),"Invalid dateCompleted type")}catch(PERR){g.reportError(PERR)}self.set(itemData,"dateCompleted",changes.dateCompleted);break;case"allDayDate":case"priority":case"isComplete":case"isStarred":case"favorites":self.set(itemData,prop,changes[prop]);break;case"isCollapsed":case"isArchived":case"isNote":case"note":try{g.PAssert(3005,!1,"These properties are not set this way")}catch(PERR){g.reportError(PERR)}self.set(itemData,prop,changes[prop]);break;case"modifiedOfflineText":case"dateText":case"durationText":case"duration":break;default:try{g.PAssert(3006,!1,"Attempting to remotely save an unknown field: ",prop)}catch(PERR){g.reportError(PERR)}}}setRemoteTextVersion(itemData)}}function getRetryInterval(count){return retryIntervals[Math.min(count,retryIntervals.length-1)]}function tryDriveReconnect(){try{g.PAssert(3009,driveRealtimeStatus===RealtimeStatus.Error||driveRealtimeStatus===RealtimeStatus.XHRError,"Invalid state for request reconnect: ",driveRealtimeStatus)}catch(PERR){g.reportError(PERR)}clearTimeout(driveReconnectTimer),driveReconnectTimer=void 0,g.goog.reconnectToActiveDocument()}function setDriveRealtimeStatus(newStatus){var oldStatus=driveRealtimeStatus;if(driveRealtimeStatus=newStatus,log("Change Realtime Status: ",oldStatus," -> ",newStatus),oldStatus!==newStatus)switch(oldStatus){case RealtimeStatus.Disconnected:try{g.PAssert(3012,newStatus===RealtimeStatus.Connecting,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}break;case RealtimeStatus.XHRError:case RealtimeStatus.Error:try{g.PAssert(3013,newStatus===RealtimeStatus.Reconnecting||newStatus===RealtimeStatus.Connected,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}newStatus===RealtimeStatus.Connected&&self.notifyReconnectSuccess();break;case RealtimeStatus.Connected:try{g.PAssert(3014,newStatus===RealtimeStatus.Error,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}newStatus===RealtimeStatus.Error&&(self.close(),self.setupReconnect());break;case RealtimeStatus.Connecting:case RealtimeStatus.Reconnecting:try{g.PAssert(3015,newStatus===RealtimeStatus.Error||newStatus===RealtimeStatus.Connected,"Invalid state switch",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}newStatus===RealtimeStatus.Error?(self.close(),self.setupReconnect()):newStatus===RealtimeStatus.XHRError?self.notifyReconnectFailure():newStatus===RealtimeStatus.Connected&&oldStatus===RealtimeStatus.Reconnecting&&self.notifyReconnectSuccess();break;default:try{g.PAssert(3016,!1,"Invalid status: ",oldStatus,newStatus)}catch(PERR){g.reportError(PERR)}}}function fwdOnLoaded(cb){try{g.PAssert(3017,cb,"Must pass a valid CB for doc loaded")}catch(PERR){g.reportError(PERR)}return function fwdOnloadedFn(doc){setDriveRealtimeStatus(RealtimeStatus.Connected),_connectIdentifier++,cb(doc)}}function fwdOnInitialized(cb){try{g.PAssert(3018,cb,"Must pass a valid CB for doc initialized")}catch(PERR){g.reportError(PERR)}return function fwdOnInitializedFn(doc){setDriveRealtimeStatus(RealtimeStatus.Connected),cb(doc)}}function fwdOnError(cb){try{g.PAssert(3019,cb,"Must pass a valid CB for doc error")}catch(PERR){g.reportError(PERR)}return function fwdOnErrorFn(err){var fatalError=cb(err);fatalError&&setDriveRealtimeStatus(RealtimeStatus.Error)}}function onRSCDrive(xhr){(!xhr||4===xhr.readyState&&200!==xhr.status)&&setDriveRealtimeStatus(RealtimeStatus.XHRError)}function entrySize(entry){try{g.PAssert(3036,!entry||g.isString(entry),"Must always be saving a string to remote cache")}catch(PERR){g.reportError(PERR)}return entry?entry.length:0}function getSizeOfEntryFields(entryObj){try{g.PAssert(3037,!entryObj||g.isObject(entryObj),"Must always pass in a valid object")}catch(PERR){g.reportError(PERR)}var sizes={};for(var field in entryObj)if(entryObj.hasOwnProperty(field)){var fieldSize;try{fieldSize=g.isString(entryObj[field])?entryObj[field].length:JSON.stringify(entryObj[field])}catch(err){g.reportError(err)}sizes[field]=fieldSize}}function createOp(){return{count:0,ops:{Map:{},List:{}}}}var self={isClosed:!0,initialized:!1,loadedOnce:!1,actionsPreventUndo:!1,wantCompoundOperation:!1,inCompoundOperation:!1,flushingDeferredActions:!1,deferredActionsCommitted:!1,hasPendingDeferredActions:!1,authenticatedUser:ko.observable(),numChanges:0,lastChangeTime:0},TrackRemoteOps=!1,cmpOpIndex=1;self.offlineTimeoutMS=platform.mobile?12e3:8e3;var CURRENT_VERSION=6;self.currentVersion=function currentVersionFn(){return CURRENT_VERSION};var deletedItemCache={},itemCache={};self.cacheItem=function cacheItemFn(item){try{g.PAssert(2850,void 0===itemCache[item.id]||itemCache[item.id]===item,"Should not be caching different items with the same ID")}catch(PERR){g.reportError(PERR)}if(itemCache[item.id]=item,deletedItemCache[item.id]){try{g.PAssert(2851,deletedItemCache[item.id]===item,"Should not be caching different items with the same ID in deleted")}catch(PERR){g.reportError(PERR)}delete deletedItemCache[item.id]}},self.getCacheItem=function getCacheItemFn(id){return itemCache[id]},self.getDeletedCacheItem=function getDeletedCacheItemFn(id){return deletedItemCache[id]},self.removeItemFromCache=function removeItemFromCacheFn(id){try{g.PAssert(2852,void 0!==itemCache[id],"Item cache should contain a valid entry for item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2853,void 0===deletedItemCache[id],"Should never already have item in deleted cache")}catch(PERR){g.reportError(PERR)}deletedItemCache[id]=itemCache[id],delete itemCache[id]},self.restoreDeletedItem=function restoreDeletedItemFn(id){try{g.PAssert(2854,void 0!==deletedItemCache[id],"Deleted item cache should contain a valid entry for item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2855,void 0===itemCache[id],"Should never already have an item in the item cache")}catch(PERR){g.reportError(PERR)}itemCache[id]=deletedItemCache[id],delete deletedItemCache[id]},self.getState=function getStateFn(obj){try{var gState={};if(self.doc)try{var model=self.doc.getModel();gState.isReadOnly=model.isReadOnly,gState.serverVersion=model.serverVersion,gState.size=model.bytesUsed,gState.saveDelay=self.doc.saveDelay}catch(err2){obj.docAccessError=!0}gState.lastPending=lastPending,gState.lastSaving=lastSaving,gState.isClosed=self.isClosed,gState.initialized=self.initialized,gState.numChanges=self.numChanges,gState.lastChanged=self.lastChangeTime,obj.gState=gState,obj.gDocErrors=self.docErrors,obj.gdataRealtimeStatus=self.getDriveRealtimeStatus()}catch(err){log("Error getting information in gdata::getState()"+err.message),obj.gState="EXCEPTION"}};var d,VMLI;self.checkRemoteIntegrity=function checkRemoteIntegrityFn(){function verifyChildren(children,isArchived){if(children)for(var j=0;j<children.length;++j){var child=children.get(j).id;child||(log(child,": Child does not have a valid reference in our remote database"),remoteDataError=!0),seen[child]?seen[child].ref?(log(child,": Item is referenced remotely multiple times"),log("   ",seen[child].ref),log("   ",item.id),remoteDataError=!0,self.beginWriteAction(),self.setItemParent(children.get(j),self.getCacheItem(seen[child.ref])),children.remove(j)):seen[child].ref=item.id:seen[child]={exist:!1,arch:isArchived,ref:item.id}}}self.beginAction(),ShouldLog(LogLevels.Timing)&&log("Verifying Remote Data: ",log.now());var remoteDataError=!1,localDataError=!1,seen={},rootSeen=!1;for(var itemID in itemCache){var item=itemCache[itemID];seen[item.id]?seen[item.id].exist?(log(item.id,": Duplicated IDs in the remote database",item),remoteDataError=!0):seen[item.id].exist=!0:seen[item.id]={exist:!0,ref:!1},item.id===self.rootID&&(rootSeen&&(log(item.id,": Multiple roots present remotely",item),remoteDataError=!0),rootSeen=!0,seen[item.id].isRoot=!0),self.getItemParent(item)||seen[item.id].isRoot||log(item.id,": Missing remote parent field",item);var childItems=self.get(item,"items");verifyChildren(childItems,!1);var childArchivedItems=self.get(item,"archivedItems");verifyChildren(childArchivedItems,!0);var note=self.get(item,"note");note&&(seen[note.id]?seen[note.id].ref?(log(note,": Note is referenced remotely multiple times: "),log("    ",seen[note.id].ref),log("    ",item.id),remoteDataError=!0,self.beginWriteAction(),self.set(item,"note",void 0)):seen[note.id].ref=item.id:seen[note.id]={exist:!1,isNote:!0,ref:item.id})}rootSeen||(log("No root present"),localDataError=!0);for(var entryID in seen){var entry=seen[entryID];if(!entry.exist){try{g.PAssert(2857,!1,"This should never happen as the database is inline with the item tree now")}catch(PERR){g.reportError(PERR)}log(entryID,": Item is referenced remotely as a child but does not exist in the database");var parent=itemCache[entry.ref];try{g.PAssert(2858,parent,"Parent must exist otherwise it couldn't reference this item")}catch(PERR){g.reportError(PERR)}if(entry.isNote)self.beginWriteAction(),self.set(parent,"note",void 0);else{var parentItems=self.getItemList(parent,entry.arch);try{g.PAssert(2859,parentItems,"If the item has been seen here, we will always have a valid parent list")}catch(PERR){g.reportError(PERR)}if(parentItems){var remoteIndex=parentItems.indexOf(entryID);if(remoteIndex>=0)self.beginWriteAction(),parentItems.remove(remoteIndex);else try{g.PAssert(2860,!1,"If we previously saw this item, we expect to be able to delete it from the parent list")}catch(PERR){g.reportError(PERR)}}}}entry.ref||entry.isRoot||(log(entryID,": Item exists remotely but is not referenced by a parent"),log("   : ",self.get(itemCache[entryID],"text")),this.removeItemFromCache(entryID)),entry.isRoot&&entry.ref&&(log(entryID,": Remote root has a parent"),localDataError=!0)}d.removeDeletedItems(seen),self.endAction(),ShouldLog(LogLevels.Timing)&&log("Done Verifying Remote Data: ",log.now())},self.migrateData=function migrateDataFn(){function reloadFn(){reqCount++,2===reqCount&&g.reload()}var stopDocLoad=!1,requireLocalReload=!1,requireRemoteReload=!1,trashDoc=!1,clearLocalData=!1,remoteVersion=self.root.get("dataVersion");try{g.PAssert(2870,g.isNumber(remoteVersion),"Remote data version must always be numeric",remoteVersion)}catch(PERR){g.reportError(PERR)}if(CURRENT_VERSION>remoteVersion){self.beginAction(),log("Migrating to latest version: ",remoteVersion);try{switch(remoteVersion){case 0:case 1:case 2:case 3:case 4:trashDoc=!0,log("Remote Migration Completed");break;case 5:break;default:try{g.PAssert(2871,!1,"Unknown remoteVersion: ",remoteVersion)}catch(PERR){g.reportError(PERR)}}}catch(err){requireRemoteReload=!0,g.reportError(err)}self.endAction(),self.model.getRoot().set("dataVersion",CURRENT_VERSION),log("Done Migrating Remote Data!",CURRENT_VERSION)}else remoteVersion>CURRENT_VERSION&&(requireLocalReload=!0,stopDocLoad=!0);if(d.hasLocalData){var localVersion=g.settings.get(Settings.localDataVersion)||0;try{g.PAssert(2873,g.isNumber(localVersion),"Local data version must be numeric",localVersion)}catch(PERR){g.reportError(PERR)}if(g.isNumber(localVersion)){if(CURRENT_VERSION>localVersion){try{switch(localVersion){case 0:case 1:case 2:case 3:case 4:stopDocLoad=!0,clearLocalData=!0,log("Local Migration Completed");break;case 5:g.vmMain.cacheManager.notifyMigrationRequired();break;default:try{g.PAssert(2874,!1,"Unknown localVersion",localVersion)}catch(PERR){g.reportError(PERR)}}}catch(err){requireLocalReload=!0,g.reportError(err)}g.settings.set(Settings.localDataVersion,CURRENT_VERSION),log("Done Migrating Local Data!",CURRENT_VERSION)}else if(localVersion>CURRENT_VERSION)try{g.PAssert(2875,!1,"localVersion is greater than our CURRENT_VERSION",localVersion,CURRENT_VERSION)}catch(PERR){g.reportError(PERR)}}else stopDocLoad=!0,g.menus.alert({text:"There was an error loading your document, please try loading a different document and contact support@moo.do.",actionText:"OKAY"})}else g.settings.set(Settings.localDataVersion,remoteVersion);if(trashDoc)promptTrashDoc();else if(clearLocalData)g.AppCache.runOnFinish(function(){d.clearDataAndReload()},!0);else if(requireLocalReload||requireRemoteReload)if(requireLocalReload&&!requireRemoteReload)g.AppCache.runOnFinish(function(){g.reload()},!0);else if(requireRemoteReload&&!requireLocalReload)self.registerSaveNotify(function(){g.reload()});else{var reqCount=0;g.AppCache.runOnFinish(reloadFn,!0),self.registerSaveNotify(reloadFn)}if(!stopDocLoad){var remoteRecoverVersion=self.model.getRoot().get("recoverVersion")||0,localRecoverVersion=g.settings.get(Settings.localRecoverVersion);void 0===localRecoverVersion?g.settings.set(Settings.localRecoverVersion,remoteRecoverVersion):remoteRecoverVersion>localRecoverVersion&&d.hasLocalData&&(stopDocLoad=!0,d.addDefaultSkipSetting(Settings.gdocId,"Default"),d.addDefaultSkipSetting(Settings.gdocTitle,"Default"),g.AppCache.runOnFinish(function(){d.clearDataAndReload()},!0))}return stopDocLoad},self.beginAction=function beginActionFn(preventUndo){if(self.model){try{g.PAssert(2888,!self.flushingDeferredActions,"Should never begin a new action while flushing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2889,!self.inCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2890,!self.wantCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2891,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}self.wantCompoundOperation=!0,self.actionsPreventUndo=!!preventUndo}};var ensureActionTimeout;self.beginWriteAction=function beginWriteActionFn(preventUndo){if(self.model){try{g.PAssert(2892,void 0===preventUndo||self.actionsPreventUndo===!!preventUndo,"Compound operations prevent undo must match",self.actionsPreventUndo,preventUndo)}catch(PERR){g.reportError(PERR)}if(!self.flushingDeferredActions){try{g.PAssert(2893,self.inCompoundOperation||self.wantCompoundOperation,"If performing an action, we should have already requested a compound operation")}catch(PERR){g.reportError(PERR)}if(!self.inCompoundOperation&&self.wantCompoundOperation)try{self.deferredActionsCommitted&&self.flushDeferredActions(),ensureActionTimeout=setTimeout(ensureWriteAction,0);var cmpName=void 0;self.model.beginCompoundOperation(cmpName,!self.actionsPreventUndo),self.inCompoundOperation=!0,self.wantCompoundOperation=!1,self.deferredActionsCommitted||self.executeDeferredActions()}catch(err){g.reportError(err)}else try{g.PAssert(2894,!self.wantCompoundOperation,"Should not nest compound operations")}catch(PERR){g.reportError(PERR)}}}},self.endAction=function endActionFn(){if(self.model){try{g.PAssert(2895,!self.flushingDeferredActions,"Should never end an action while flushing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2896,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2897,self.inCompoundOperation||self.wantCompoundOperation,"If ending an action, a beginning should have happened")}catch(PERR){g.reportError(PERR)}try{self.hasPendingDeferredActions&&(self.deferredActionsCommitted=!0),self.inCompoundOperation&&self.model.endCompoundOperation()}catch(err){g.goog.recoverFromError(err)}finally{self.inCompoundOperation=!1,self.wantCompoundOperation=!1,self.actionsPreventUndo=!1,clearTimeout(ensureActionTimeout),ensureActionTimeout=void 0}}};var DEFERRED_ACTION_TIMEOUT=800,deferredActions={},flushDeferredActionsTimeout;self.performDeferredAction=function performDeferredActionFn(item,action){try{g.PAssert(2900,item,"Must supply a valid item to perform the action on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2901,action,"Must supply a valid action to be performed")}catch(PERR){g.reportError(PERR)}if(self.model){try{g.PAssert(2902,!self.inCompoundOperation,"Cannot perform deferred action after a compound operation has started")}catch(PERR){g.reportError(PERR)}if(deferredActions[item.id])for(var prop in action)deferredActions[item.id].changes[prop]=action[prop];else deferredActions[item.id]={item:item,changes:action};self.hasPendingDeferredActions=!0,clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=setTimeout(self.flushDeferredActions,DEFERRED_ACTION_TIMEOUT)}},self.executeDeferredActions=function executeDeferredActionsFn(){self.flushingDeferredActions=!0;try{for(var id in deferredActions)saveChangesInternal(deferredActions[id].item,deferredActions[id].changes)}catch(err){g.reportError(err)}finally{self.flushingDeferredActions=!1,self.hasPendingDeferredActions=!1,deferredActions={},self.deferredActionsCommitted=!1}},self.flushDeferredActions=function flushDeferredActionsFn(){if(self.model&&!self.isClosed){try{g.PAssert(2903,!self.flushingDeferredActions,"Should never recursively call flushDeferredActions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2904,!self.inCompoundOperation,"Must flush deferred actions before starting a compound operation")}catch(PERR){g.reportError(PERR)}if(self.hasPendingDeferredActions){clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=void 0;try{var cmpName=void 0;self.model.beginCompoundOperation(cmpName),self.executeDeferredActions(),self.model.endCompoundOperation()}catch(err){g.reportError(err)}}}},self.hasDeferredAction=function hasDeferredActionFn(id){return!!deferredActions[id]},self.createNewItem=function createNewItemFn(item,hasItems,hasArchivedItems){self.beginWriteAction();try{g.PAssert(2909,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2910,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2911,self.inCompoundOperation,"Should always create an item inside of a compound operation")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2912,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2913,self.model,"Need a valid model to create collaborative items")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2914,!item.data,"When initializing a new item, it should have no gdata components already")}catch(PERR){g.reportError(PERR)}var map=self.model.createMap();item.data=map,item.data.connectIdentifier=self.connectIdentifier();try{g.PAssert(2915,item.getRawText().indexOf(window.AttachChar)<0,"Remote syncd changes should never contain AttachChar")}catch(PERR){g.reportError(PERR)}if(self.set(map,"text",item.getRawText()),hasItems){var collabList=self.model.createList();self.set(map,"items",collabList)}if(hasArchivedItems){var collabArchiveList=self.model.createList();self.set(map,"archivedItems",collabArchiveList)}return self.set(map,"dateCreated",item.dateCreated.getTime()),item.id=map.id,itemCache[map.id]||(itemCache[map.id]=map),map.id},self.initializeNewItem=function initializeNewItemFn(item){self.beginWriteAction();try{g.PAssert(2916,item instanceof VMLI,"Must pass in a valid instace of a local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2917,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2918,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2919,self.inCompoundOperation,"Should always initialize an item inside of a compound operation")}catch(PERR){g.reportError(PERR)}if(item.hasChildren()){var items=item.getItems(),collabList=ensureRemoteItemsArray(item);try{g.PAssert(2920,collabList,"Must have a valid collab list for normal init")}catch(PERR){g.reportError(PERR)}for(var i=0;i<items.length;++i){try{g.PAssert(2921,items[i].data,"Item must have a valid remote to be added to a collab list")}catch(PERR){g.reportError(PERR)}this.setItemParent(items[i].data,item.data),collabList.push(items[i].data)}}if(item.hasArchivedChildren()){var archivedItems=item.archivedItems(!0),collabArchivedList=ensureRemoteArchiveArray(item);try{g.PAssert(2922,collabArchivedList,"Must have a valid collab list for archived init")}catch(PERR){g.reportError(PERR)}for(var i=0;i<archivedItems.length;++i){try{g.PAssert(2923,archivedItems[i].data,"Item must have a valid remote to be added to a collab list")}catch(PERR){g.reportError(PERR)}this.setItemParent(archivedItems[i].data,item.data),collabArchivedList.push(archivedItems[i].data)}}if(item.hasNote()){var note=item.getNote();try{g.PAssert(2924,note.data,"Note must have a valid remote to be added to an item")}catch(PERR){g.reportError(PERR)}this.setItemParent(note.data,item.data),self.set(item.data,"note",note.data)}item.isNote()&&self.set(item.data,"isNote",!0),item.parent()&&this.setItemParent(item.data,item.parent().data),attachEvents(item)},self.attachEventsToItem=function attachEventsToItemFn(item){try{g.PAssert(2925,item instanceof VMLI,"Must pass in a valid local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2926,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2927,item.data,"Must have loaded data from gdrive before attaching events to item")}catch(PERR){g.reportError(PERR)}attachEvents(item)};var undoRedoStateChangeHandler;self.registerForUndoRedoStateChange=function registerForUndoRedoStateChangeFn(handler){self.model?(self.model.addEventListener(gapi.drive.realtime.EventType.UNDO_REDO_STATE_CHANGED,handler.stateChangeForUndoRedo),handler.stateChangeForUndoRedo({canUndo:self.model.canUndo,canRedo:self.model.canRedo})):undoRedoStateChangeHandler=handler},self.registerForSaveStateChange=function registerForSaveStateChangeFn(handler){try{g.PAssert(2928,self.doc,"Must have a valid doc to connect to")}catch(PERR){g.reportError(PERR)}self.doc.addEventListener(gapi.drive.realtime.EventType.DOCUMENT_SAVE_STATE_CHANGED,handler)},self.loadCollaborators=function loadCollaboratorsFn(){for(var collabs=self.doc.getCollaborators(),selfInfo,i=0;i<collabs.length;++i){var collab=collabs[i];collab.isMe&&(selfInfo=collab)}self.authenticatedUser(selfInfo)},self.undoAction=function undoActionFn(){self.flushDeferredActions();try{g.PAssert(2929,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2930,self.model.canUndo,"Remote model must be able to undo")}catch(PERR){g.reportError(PERR)}try{self.model.undo()}catch(err){g.reportError(err)}},self.redoAction=function redoActionFn(){self.flushDeferredActions();try{g.PAssert(2931,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2932,self.model.canRedo,"Remote model must be able to redo")}catch(PERR){g.reportError(PERR)}g.vmMain.beginUpdateItems();try{self.model.redo()}catch(err){g.reportError(err)}g.vmMain.commitUpdateItems()},self.getItemParent=function getItemParentFn(model){return model._mdParent},self.setItemParent=function setItemParentFn(model,parentModel){try{g.PAssert(2933,model,"Must provide a valid model when setting the item parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2934,!(model instanceof VMLI),"Must pass in a valid remote item for child")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2935,!(parentModel instanceof VMLI),"Must pass in a valid remote item for parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2936,!model||model.type===gapi.drive.realtime.CollaborativeTypes.COLLABORATIVE_MAP,"Model must be a valid Map")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2937,!parentModel||parentModel.type===gapi.drive.realtime.CollaborativeTypes.COLLABORATIVE_MAP,"Parent must be a valid Map")}catch(PERR){g.reportError(PERR)}model._mdParent=parentModel},self.getItemList=function getItemListFn(model,isArchived){self.beginWriteAction();try{g.PAssert(2945,!(model instanceof VMLI),"Must pass in a valid remote item")}catch(PERR){g.reportError(PERR)}return isArchived?self.get(model,"archivedItems"):self.get(model,"items")},self.ensureItemList=function ensureItemListFn(item,isArchived){self.beginWriteAction();try{g.PAssert(2946,item instanceof VMLI,"Must pass in a valid local item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2947,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}return isArchived?ensureRemoteArchiveArray(item):ensureRemoteItemsArray(item)},self.canSave=function canSaveFn(item){if(self.initialized){var data=item instanceof VMLI?item.data:item;try{g.PAssert(2954,data,"Must have a valid remote item to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2955,!self.isClosed,"Document must be open to make changes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2956,!data||data.connectIdentifier===self.connectIdentifier(),"Using remote item data that is out of date",data?data.connectIdentifier:-1,self.connectIdentifier())}catch(PERR){g.reportError(PERR)}return data&&!self.isClosed&&data.connectIdentifier===self.connectIdentifier()?data:!1}},self.deleteTree=function deleteTreeFn(item){self.beginWriteAction();try{g.PAssert(2957,item,"Must provide a valid item instance to deleteTree")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2958,!(item instanceof VMLI),"Must not be a VMLI, should be a remote item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2959,!g.isString(item),"Must pass in a valid remote item not an ID")}catch(PERR){g.reportError(PERR)}if(item){self.setItemParent(item,void 0);var localItem=d.getItem(item.id);localItem&&localItem.data&&localItem.data===item&&(localItem.data=void 0);var items=self.getItemList(item,!1);if(items)for(var i=0;i<items.length;++i){var child=items.get(i);self.deleteTree(child)}var archivedItems=self.getItemList(item,!0);if(archivedItems)for(var i=0;i<archivedItems.length;++i){var archivedChild=archivedItems.get(i);self.deleteTree(archivedChild)}self.removeItemFromCache(item.id)}};var DocumentErrorFn={NoteSet:"noteSet",ItemAdded:"itemAdded",ItemsAdded:"itemsAdded",ItemRemoved:"itemRemoved",ItemMoved:"itemMoved",ItemArchived:"itemArchived",ItemUnarchived:"itemUnarchived"},DocumentErrorType={Exception:"Exception",NoData:"NoData",NoSrcList:"NoSrcList",NoDstList:"NoDstList",InvalidSrcIndex:"InvalidSrcIndex",InvalidDstIndex:"InvalidDstIndex"};self.docErrors=[],self.noteSet=function noteSetFn(item,noteItem){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();try{g.PAssert(2960,item,"Must provide a valid item to set a note on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2961,!noteItem||noteItem.isNote(),"Must be removing a note or setting note with a valid note item")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return reportDocumentError(DocumentErrorFn.NoteSet,DocumentErrorType.NoData),ReturnValue.Error;var noteData;if(noteItem){if(noteData=self.canSave(noteItem),!noteData)return reportDocumentError(DocumentErrorFn.NoteSet,DocumentErrorType.NoData),ReturnValue.Error;self.set(noteData,"isNote",!0)}try{g.PAssert(2962,!noteItem||!self.get(itemData,"note"),"Should not set a note on an item that already has a note")}catch(PERR){g.reportError(PERR)}self.set(itemData,"note",noteData)}catch(err){throw reportDocumentError(DocumentErrorFn.NoteSet,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.itemAdded=function itemAddedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item,addedItem=params.addedItem,index=params.index,isArchived=params.isArchived,noVersion=params.noVersion;try{g.PAssert(2963,void 0!==item&&void 0!==addedItem&&void 0!==isArchived,"itemAdded is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2964,index>=-1||void 0===index,"Invalid index",index)}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return reportDocumentError(DocumentErrorFn.ItemAdded,DocumentErrorType.NoData),ReturnValue.Error;var addedData=self.canSave(addedItem);if(!addedData)return reportDocumentError(DocumentErrorFn.ItemAdded,DocumentErrorType.NoData),ReturnValue.Error;d.addPendingUpdate(item.id),d.addPendingUpdate(addedItem.id);try{g.PAssert(2965,!item.isNote(),"Should not add a child to a note")}catch(PERR){g.reportError(PERR)}var arr=self.ensureItemList(item,isArchived);try{g.PAssert(2966,arr,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2967,isNaN(index)||index<=arr.length,"Should not try to insert an item after the end of the array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2968,isNaN(index)||index>=0,"Should not try to insert an item at a negative index")}catch(PERR){g.reportError(PERR)}0>index||isNaN(index)||index>arr.length?arr.push(addedData):arr.insert(index,addedData),noVersion||setRemoteVersion(addedData),self.setItemParent(addedData,itemData),self.cacheItem(addedData)}catch(err){throw reportDocumentError(DocumentErrorFn.ItemAdded,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.itemsAdded=function itemsAddedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item;try{g.PAssert(2969,item instanceof VMLI,"Passed in item must be a VMLI")}catch(PERR){g.reportError(PERR)}var addedItems=params.addedItems,index=params.index,isArchived=params.isArchived,noVersion=params.noVersion;try{g.PAssert(2970,void 0!==item&&void 0!==addedItems&&void 0!==isArchived,"itemsAdded is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2971,isNaN(index)||index>=0,"Must provide a valid item index when adding an item to a remote list")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return reportDocumentError(DocumentErrorFn.ItemsAdded,DocumentErrorType.NoData),ReturnValue.Error;var arr=self.ensureItemList(item,isArchived);try{g.PAssert(2972,arr,"Must have a valid remote list to add the item to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2973,index<=arr.length,"Should not insert items after the end of the remote list")}catch(PERR){g.reportError(PERR)}for(var addedArr=new Array(addedItems.length),i=0;i<addedItems.length;++i){try{g.PAssert(2974,!addedItems[i].isNote(),"Should never be adding a note as a child")}catch(PERR){g.reportError(PERR)}addedArr[i]=addedItems[i].data,d.addPendingUpdate(addedItems[i].id),!noVersion&&addedArr[i]&&setRemoteVersion(addedArr[i]),self.setItemParent(addedArr[i],item),self.cacheItem(addedArr[i])}d.addPendingUpdate(item.id);try{g.PAssert(2975,!item.isNote(),"Should never be adding a child to a note")}catch(PERR){g.reportError(PERR)}if(0>index||isNaN(index)){try{g.PAssert(2976,isArchived,"Only archived items should be inserted into a list by pushing")}catch(PERR){g.reportError(PERR)}arr.pushAll(addedArr)}else arr.insertAll(index,addedArr)}catch(err){throw reportDocumentError(DocumentErrorFn.ItemsAdded,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.itemRemoved=function itemRemovedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item,index=params.index,numToRemove=params.numToRemove,isArchived=params.isArchived,noDelete=params.noDelete,noVersion=params.noVersion;try{g.PAssert(2977,void 0!==item&&void 0!==index&&void 0!==numToRemove&&void 0!==isArchived,"itemRemoved is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2978,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return reportDocumentError(DocumentErrorFn.ItemRemoved,DocumentErrorType.NoData),ReturnValue.Error;isNaN(numToRemove)&&(numToRemove=1);var arr=self.getItemList(itemData,isArchived);if(!arr)return reportDocumentError(DocumentErrorFn.ItemRemoved,DocumentErrorType.NoSrcList),ReturnValue.Error;try{g.PAssert(2979,index+numToRemove<=arr.length,"Should not be removing items past the end of the remote list")}catch(PERR){g.reportError(PERR)}for(var i=index;index+numToRemove>i;++i){var deleted=arr.get(i);d.addPendingUpdate(deleted.id),noVersion||setRemoteVersion(deleted),noDelete||self.deleteTree(deleted)}d.addPendingUpdate(item.id),1===numToRemove?arr.remove(index):arr.removeRange(index,index+numToRemove)
}catch(err){throw reportDocumentError(DocumentErrorFn.ItemRemoved,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.itemMoved=function itemMovedFn(params){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();var item=params.item,newInfo=params.newInfo,oldParent=params.oldParent,oldInfo=params.oldInfo,noVersion=params.noVersion;try{g.PAssert(2980,void 0!==item&&void 0!==newInfo&&void 0!==oldParent&&void 0!==oldInfo,"itemMoved is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2981,newInfo&&newInfo.index>=-1,"Must supply a valid new item index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2982,newInfo&&void 0!==newInfo.isArchived,"Must determine if this item is archived or not")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2983,oldParent,"Must specify a valid old parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2984,oldInfo&&oldInfo.index>=0,"Must supply a valid old item index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2985,oldInfo&&void 0!==oldInfo.isArchived,"Must determine if this item was archived or not")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.NoData),ReturnValue.Error;var oldParentData=self.canSave(oldParent);if(!oldParentData)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.NoData),ReturnValue.Error;var newParentData=self.canSave(item.parent());if(!newParentData)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.NoData),ReturnValue.Error;var srcList=self.getItemList(oldParentData,oldInfo.isArchived);if(!srcList)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.NoSrcList),ReturnValue.Error;if(oldInfo.index>=srcList.length)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.InvalidSrcIndex),ReturnValue.Error;var dstList=self.ensureItemList(item.parent(),newInfo.isArchived);if(!dstList)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.NoDstList),ReturnValue.Error;if(newInfo.index>dstList.length)return reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.InvalidDstIndex),ReturnValue.Error;var dstIndex=newInfo.index;(newInfo.index<0||isNaN(newInfo.index)||newInfo.index>dstList.length)&&(dstIndex=dstList.length),srcList.moveToList(oldInfo.index,dstList,dstIndex),self.setItemParent(itemData,newParentData),d.addPendingUpdate(item.id),d.addPendingUpdate(oldParent.id),d.addPendingUpdate(item.parent().id);try{g.PAssert(2986,!item.isNote(),"Should never move a note as a child")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2987,!item.parent().isNote(),"Notes should never have children")}catch(PERR){g.reportError(PERR)}noVersion||setRemoteVersion(itemData)}catch(err){throw reportDocumentError(DocumentErrorFn.ItemMoved,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.itemArchived=function itemArchivedFn(item,itemArchived,index){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();try{g.PAssert(2988,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);if(!itemData)return reportDocumentError(DocumentErrorFn.ItemArchived,DocumentErrorType.NoData),ReturnValue.Error;var archivedItemData=self.canSave(itemArchived);if(!archivedItemData)return reportDocumentError(DocumentErrorFn.ItemArchived,DocumentErrorType.NoData),ReturnValue.Error;var items=self.getItemList(itemData,!1);if(!items)return reportDocumentError(DocumentErrorFn.ItemArchived,DocumentErrorType.NoSrcList),ReturnValue.Error;var archivedItems=ensureRemoteArchiveArray(item);if(!archivedItems)return reportDocumentError(DocumentErrorFn.ItemArchived,DocumentErrorType.NoDstList),ReturnValue.Error;if(!(index<items.length))return reportDocumentError(DocumentErrorFn.ItemArchived,DocumentErrorType.InvalidSrcIndex),ReturnValue.Error;items.moveToList(index,archivedItems,archivedItems.length),d.addPendingUpdate(item.id),d.addPendingUpdate(itemArchived.id);try{g.PAssert(2989,!item.isNote(),"Parents should never be archiving notes")}catch(PERR){g.reportError(PERR)}setRemoteVersion(itemArchived.data)}catch(err){throw reportDocumentError(DocumentErrorFn.ItemArchived,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.itemUnarchived=function itemUnarchivedFn(item,itemUnarchived,removeIndex,insertIndex){if(!self.isConnected())return ReturnValue.Success;self.beginWriteAction();try{g.PAssert(2990,removeIndex>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{var itemData=self.canSave(item);try{g.PAssert(2991,itemData,"Must have valid item data when archiving an item")}catch(PERR){g.reportError(PERR)}if(!itemData)return reportDocumentError(DocumentErrorFn.ItemUnarchived,DocumentErrorType.NoData),ReturnValue.Error;var unarchivedItemData=self.canSave(itemUnarchived);if(!unarchivedItemData)return reportDocumentError(DocumentErrorFn.ItemUnarchived,DocumentErrorType.NoData),ReturnValue.Error;var items=self.get(itemData,"items");try{g.PAssert(2992,items,"Must be an items array present")}catch(PERR){g.reportError(PERR)}var archivedItems=self.get(itemData,"archivedItems");try{g.PAssert(2993,archivedItems,"Must be an archived items array present")}catch(PERR){g.reportError(PERR)}archivedItems.moveToList(removeIndex,items,insertIndex),d.addPendingUpdate(item.id),d.addPendingUpdate(itemUnarchived.id),setRemoteVersion(itemUnarchived.data)}catch(err){throw reportDocumentError(DocumentErrorFn.ItemUnarchived,DocumentErrorType.Exception,err),err}return ReturnValue.Success},self.saveChanges=function saveChangesFn(item,changes){if(self.isConnected()){if(changes&&changes.text){try{g.PAssert(2994,changes.text.indexOf(window.AttachChar)<0,"Remote syncd changes should never contain AttachChar")}catch(PERR){g.reportError(PERR)}try{g.PAssert(2995,item.isNote()||changes.text.indexOf("\n")<0,"Remove syncd changes should never contain newlines")}catch(PERR){g.reportError(PERR)}}self.inCompoundOperation||self.actionsPreventUndo?saveChangesInternal(item,changes):self.performDeferredAction(item,changes)}},self.resetDriveData=function resetDriveDataFn(){itemCache={},self.initialized=!1,self.doc=void 0,self.model=void 0,self.root=void 0,self.rootItem=void 0,self.rootID=void 0,window.__remoteDoc=void 0,self.cachesRemote=void 0,d.forEachModel(function(vmli){vmli.resetDriveData()}),g.vmMain.notifyDriveDisconnect(),self.inCompoundOperation=!1,self.wantCompoundOperation=!1,self.flushingDeferredActions=!1,self.deferredActionsCommitted=!1,clearTimeout(ensureActionTimeout),ensureActionTimeout=void 0,clearTimeout(flushDeferredActionsTimeout),flushDeferredActionsTimeout=void 0,self.hasPendingDeferredActions=!1,deferredActions={}},self.clearItemEventListeners=function clearItemEventListenersFn(){d.forEachModel(function(vmli){vmli.data&&vmli.data.removeAllEventListeners()})},self.close=function closeFn(forceClose){try{g.PAssert(3007,forceClose||driveRealtimeStatus===RealtimeStatus.Error,"Invalid state for document close: ",driveRealtimeStatus)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3008,!self.wantCompoundOperation,"Closing the doc with a deferred compound operation")}catch(PERR){g.reportError(PERR)}if(self.doc&&!self.isClosed){log("---- Closing Remote Document! ----"),self.isClosed=!0,g.vmMain.setGDriveStatus(DriveStatus.Offline);try{self.doc.close()}catch(err){log("Error Closing Doc: ",err)}self.resetDriveData()}else g.vmMain.isReconnecting()&&g.vmMain.setGDriveStatus(DriveStatus.Offline)};var retryCount=0,retryIntervals=[1e3,2e4,4e4,6e4,9e4],driveReconnectTimer;self.setupReconnect=function setupReconnectFn(){try{g.PAssert(3010,driveRealtimeStatus===RealtimeStatus.Error||driveRealtimeStatus===RealtimeStatus.XHRError,"Invalid state for setup reconnect: ",driveRealtimeStatus)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3011,!driveReconnectTimer,"Reconnect timer already active")}catch(PERR){g.reportError(PERR)}var retryTimeout=getRetryInterval(retryCount++);clearTimeout(driveReconnectTimer),driveReconnectTimer=setTimeout(tryDriveReconnect,retryTimeout)},self.notifyReconnectFailure=function notifyReconnectFailureFn(){self.setupReconnect()},self.notifyReconnectSuccess=function notifyReconnectSuccessFn(){retryCount=0,clearTimeout(driveReconnectTimer),driveReconnectTimer=void 0};var RealtimeStatus={Disconnected:0,Connecting:1,Connected:2,Reconnecting:3,Error:4,XHRError:5},driveRealtimeStatus=RealtimeStatus.Disconnected;self.getDriveRealtimeStatus=function getDriveRealtimeStatusFn(){return driveRealtimeStatus};var _connectIdentifier=1;self.connectIdentifier=function connectIdentifierFn(){return _connectIdentifier};var isXHRWrapped=!1;if(self.driveRealtimeLoad=function driveRealtimeLoadFn(id,onLoaded,onInitialized,onError){try{g.PAssert(3020,driveRealtimeStatus===RealtimeStatus.Disconnected||driveRealtimeStatus===RealtimeStatus.Error,"Loading realtime document from invalid state")}catch(PERR){g.reportError(PERR)}var prevStatus=driveRealtimeStatus;if(driveRealtimeStatus===RealtimeStatus.Disconnected?setDriveRealtimeStatus(RealtimeStatus.Connecting):(driveRealtimeStatus===RealtimeStatus.Error||driveRealtimeStatus===RealtimeStatus.XHRError)&&setDriveRealtimeStatus(RealtimeStatus.Reconnecting),prevStatus===RealtimeStatus.Disconnected||prevStatus===RealtimeStatus.Error||prevStatus===RealtimeStatus.XHRError){isXHRWrapped=g.registerURLForNotifyXHR("https://drive.google.com/otservice/gs",onRSCDrive);try{g.PAssert(3021,isXHRWrapped,"XHR must always be successfully wrapped")}catch(PERR){g.reportError(PERR)}g.checkpoint(Checkpoint.DocLoadRequested),gapi.drive.realtime.load(id,fwdOnLoaded(onLoaded),fwdOnInitialized(onInitialized),fwdOnError(onError))}},self.onInitialized=function onInitializedFn(model){log("Initializing",model),d||(d=require("data")),VMLI||(VMLI=require("VMLI"));var home=model.createMap(),homeItems=model.createList();self.set(home,"text",C.RootItemName),self.set(home,"items",homeItems),self.set(home,"archivedItems",model.createList()),self.set(home,"dateCreated",Date.now());var root=model.getRoot();root.set("dataVersion",CURRENT_VERSION),root.set("root",home);var openDoc=g.vmMain.docManager.getOpenDoc();try{g.PAssert(3022,openDoc,"Must have an open doc to be initializing a realtime doc")}catch(PERR){g.reportError(PERR)}openDoc.getDocumentFolder(function(docFolderID){root.set("docFolderID",docFolderID)}),root.set("settings",model.createMap()),root.set("caches",model.createMap())},self.onFirstInitialized=function onFirstInitializedFn(model){function createInitItem(model,text){var map=model.createMap();if(self.set(map,"text",text),parent){var parentList=self.get(parent,"items");parentList||(parentList=model.createList(),self.set(parent,"items",parentList)),parentList.push(map)}return map}var root=model.getRoot().get("root"),parent=createInitItem(model,"Welcome to Moo.do!",root);createInitItem(model,"Everything is just text in an outline, so it works like any text editor."),createInitItem(model,"Press Enter to add a new item, Tab to indent into a list, and Shift + Tab to unindent out of a list."),createInitItem(model,"See the Help at the right to learn more."),createInitItem(model,"Get started by deleting this and creating your own projects.")},DETAILED_STATS){var __RCacheStats={reads:0,writes:0,missedWrites:0,exists:0,updates:0,deletes:0,ensures:0,rchanges:0};self.getPreviewCacheStats=function getPreviewCacheStatsFn(){return __RCacheStats},window.__dumpRCacheStats=function(){log("---- RCache Stats ----"),log(" Reads: "+__RCacheStats.reads),log(" Writes: "+__RCacheStats.writes),log(" MWrites: "+__RCacheStats.missedWrites),log(" Exists: "+__RCacheStats.exists),log(" Updates: "+__RCacheStats.updates),log(" Deletes: "+__RCacheStats.deletes),log(" Ensures: "+__RCacheStats.ensures),log(" RChanges: "+__RCacheStats.rchanges),log("----------------------")}}var missedCacheWrites={},cacheMaxEntrySize=300;self.maxCacheEntrySize=function maxCacheEntrySizeFn(){return cacheMaxEntrySize},self.cacheChanged=function cacheChangedFn(cache,e){if(e.ocHandled||e.isLocal)return!1;for(var i=0;i<e.events.length;++i){var ev=e.events[i];switch(DETAILED_STATS&&__RCacheStats.rchanges++,ev.type){case gapi.drive.realtime.EventType.VALUES_ADDED:self.notifyListeners(cache,DataChangeType.Add,ev.property,ev.newValue);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:self.notifyListeners(cache,DataChangeType.Remove,ev.property,ev.newValue);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:self.notifyListeners(cache,DataChangeType.Change,ev.property,ev.newValue);break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:try{g.PAssert(3024,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}}};var cacheChangeListeners={};self.notifyListeners=function notifyListenersFn(cache,type,id,data){var listeners=cacheChangeListeners[cache];try{g.PAssert(3025,listeners&&listeners.length>0,"Should always have an interested party if we are receiving notifications")}catch(PERR){g.reportError(PERR)}try{var dataObj;data&&(dataObj=JSON.parse(data),dataObj.id=id);for(var i=0;i<listeners.length;++i)try{listeners[i](type,id,dataObj)}catch(err){g.reportError(err)}}catch(parseErr){g.reportError(parseErr)}},self.hookCacheListeners=function hookCacheListenersFn(){for(var cache in cacheChangeListeners)try{self.hookCacheListener(cache)}catch(err){g.reportError(err)}},self.hookCacheListener=function hookCacheListenerFn(cache){var remoteCache=self.cachesRemote.get(cache);try{g.PAssert(3026,remoteCache,"If we are listening for a cache, it must have been ensured first")}catch(PERR){g.reportError(PERR)}var success=!1;if(remoteCache){var dataCache=remoteCache.get("data");try{g.PAssert(3027,dataCache,"Malformed cache, must have a data entry present")}catch(PERR){g.reportError(PERR)}dataCache&&(dataCache.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,self.cacheChanged.bind(self,cache)),success=!0)}return success},self.registerForCacheChanges=function registerForCacheChangesFn(cache,cb){try{g.PAssert(3028,cb,"Must provide a valid callback function for cache changes")}catch(PERR){g.reportError(PERR)}var success=!1,listeners=cacheChangeListeners[cache];if(listeners){try{g.PAssert(3029,listeners.indexOf(cb)<0,"Should never double register a listener")}catch(PERR){g.reportError(PERR)}listeners.push(cb)}else cacheChangeListeners[cache]=[cb];return self.isCacheAvailable(cache)&&(success=self.hookCacheListener(cache)),success},self.unregisterForCacheChanges=function unregisterForCacheChangesFn(cache,cb){var listeners=cacheChangeListeners[cache];try{g.PAssert(3030,listeners,"Must have previously registered with a cache")}catch(PERR){g.reportError(PERR)}var removedIndex=listeners.remove(cb);try{g.PAssert(3031,removedIndex>=0,"Did not try to remove a valid listener")}catch(PERR){g.reportError(PERR)}return removedIndex>=0},self.loadDataCaches=function loadDataCachesFn(){self.cachesRemote=self.root.get("caches"),self.cachesRemote||(self.cachesRemote=self.model.createMap(),self.root.set("caches",self.cachesRemote)),self.writeMissedCacheEntries(),self.sendAvailableNotifications(),self.hookCacheListeners()},self.queryCache=function queryCacheFn(cache,key){try{g.PAssert(3032,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3033,!g.isTempId(key),"Should not query remote cache for local only items")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&__RCacheStats.reads++;var remoteCache=self.ensureCache(cache);if(remoteCache){var cacheEntry=JSON.parse(remoteCache.get("data").get(key));if(cacheEntry)return cacheEntry.id=key,cacheEntry}return void 0},self.hasCacheEntry=function hasCacheEntryFn(cache,key){try{g.PAssert(3034,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3035,!g.isTempId(key),"Should not query remote cache for local only items")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&__RCacheStats.exists++;var remoteCache=self.ensureCache(cache);return remoteCache?!!remoteCache.get("data").get(key):!1},self.updateCache=function updateCacheFn(cache,key,value){try{g.PAssert(3038,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3039,!g.isTempId(key),"Should never save a local only item to the remote cache")}catch(PERR){g.reportError(PERR)}var oldEntry,remoteCache=self.ensureCache(cache),origValue=value;try{try{g.PAssert(3040,!g.isString(value),"Should only be saving objects rather than raw strings in cache")}catch(PERR){g.reportError(PERR)}value=JSON.stringify(value)}catch(err){g.reportError(err),value=void 0}if(remoteCache){oldEntry=remoteCache.get("data").get(key);var oldSize=entrySize(oldEntry),newSize=entrySize(value);if(newSize<self.maxCacheEntrySize())try{var fieldSizes=getSizeOfEntryFields(origValue);try{g.PAssert(3041,newSize<self.maxCacheEntrySize(),"New cache entry too large",newSize,fieldSizes)}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}var sizeDiff=newSize-oldSize,cacheInfo=remoteCache.get("info");if(oldEntry?DETAILED_STATS&&__RCacheStats.updates++:cacheInfo.set("entries",cacheInfo.get("entries")+1),cacheInfo.set("size",cacheInfo.get("size")+sizeDiff),void 0!==value)DETAILED_STATS&&__RCacheStats.writes++,remoteCache.get("data").set(key,value);else{try{g.PAssert(3042,oldEntry,"Should never be setting undefined->undefined")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&__RCacheStats.deletes++,remoteCache.get("data").delete(key)}}else DETAILED_STATS&&__RCacheStats.missedWrites++,missedCacheWrites[key]=value;return oldEntry},self.ensureCache=function ensureCacheFn(cache){DETAILED_STATS&&__RCacheStats.ensures++;var remoteCache;if(self.cachesRemote&&(remoteCache=self.cachesRemote.get(cache),!remoteCache)){self.model.beginCompoundOperation(),remoteCache=self.model.createMap();var cacheInfo=self.model.createMap();cacheInfo.set("entries",0),cacheInfo.set("size",0),remoteCache.set("info",cacheInfo);var cacheData=self.model.createMap();remoteCache.set("data",cacheData),self.cachesRemote.set(cache,remoteCache),self.model.endCompoundOperation()}return remoteCache},self.clearCache=function clearCacheFn(cache){try{g.PAssert(3043,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}if(self.cachesRemote){var remoteCache=self.cachesRemote.get(cache);if(remoteCache){remoteCache.get("data").clear();var cacheInfo=remoteCache.get("info");try{g.PAssert(3044,cacheInfo,"Malformed cache, every cache must have an info object")}catch(PERR){g.reportError(PERR)}cacheInfo.set("entries",0),cacheInfo.set("size",0)}}},self.clearCaches=function clearCachesFn(){},self.getCacheSize=function getCacheSizeFn(cache){try{g.PAssert(3045,self.cachesRemote,"Caches must have been initialized")}catch(PERR){g.reportError(PERR)}if(self.cachesRemote){var remoteCache=self.cachesRemote.get(cache);if(remoteCache)return remoteCache.get("info").get("size")}return 0},self.isCacheAvailable=function isCacheAvailableFn(cache){return self.cachesRemote&&self.cachesRemote.get(cache)};var notifyOnCacheAvailable=[];self.requestNotifyWhenAvailable=function requestNotifyWhenAvailableFn(cb){try{g.PAssert(3046,notifyOnCacheAvailable.indexOf(cb)<0,"Should not push same callback multiple times")}catch(PERR){g.reportError(PERR)}self.cachesRemote||g.isDemoMode()?cb():notifyOnCacheAvailable.push(cb)},self.sendAvailableNotifications=function sendAvailableNotificationsFn(){for(var i=0;i<notifyOnCacheAvailable.length;++i)notifyOnCacheAvailable[i]();notifyOnCacheAvailable=[]},self.writeMissedCacheEntries=function writeMissedCacheEntriesFn(){for(var key in self.missedCacheWrites){var value=self.missedCacheWrites[key];log("XX Writing missed cache entry: ",key,value)}self.missedCacheWrites={}},self.poke=function pokeFn(){if(self.root&&!self.isClosed)try{var pk=self.root.get("poke");self.model.beginCompoundOperation("poke",!1),pk?self.root.set("poke",pk+1):self.root.set("poke",1),self.model.endCompoundOperation()}catch(err){log("Exception during poke, reconnecting: ",err),self.close(),self.setupReconnect()}},window.__poke=self.poke,self.rootChanged=function rootChangedFn(e){if(e.ocHandled||e.isLocal||self.root&&self.root.id!==e.target.id)return!1;for(var i=0;i<e.events.length;++i){var ev=e.events[i];switch(ev.type){case gapi.drive.realtime.EventType.VALUES_ADDED:case gapi.drive.realtime.EventType.VALUES_REMOVED:break;case gapi.drive.realtime.EventType.VALUE_CHANGED:if("dataVersion"===ev.property)ev.newValue>CURRENT_VERSION?g.AppCache.checkForUpdate(!0):ev.newVersion<CURRENT_VERSION&&g.reportError(new Error("Remote setting dataVersion to invalid value"+ev.newVersion));else if("recoverVersion"===ev.property){self.clearItemEventListeners();var localRecoverVersion=g.settings.get(Settings.localRecoverVersion);localRecoverVersion<ev.newValue&&(g.settings.set(Settings.localRecoverVersion,ev.newValue),d.addDefaultSkipSetting(Settings.gdocId,"Default"),d.addDefaultSkipSetting(Settings.gdocTitle,"Default"),self.close(!0),g.menus.alert({text:"A remote user has recovered this document. The app needs to restart to continue editing.",actionText:"OKAY",callback:d.clearDataAndReload}))}break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:try{g.PAssert(3047,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}}},self.isConnected=function isConnectedFn(){return self.initialized&&!self.isClosed&&!!self.model};var opGroups,activeOp,numGroupedOps,numUngroupedOps,alertUngroupedOps;self.onLoad=function onLoadFn(doc){try{try{window.__LOAD_HANDLES.push(g.getCurrentStack("Document Opened Handled"))}catch(err){g.reportError(err)}try{g.PAssert(3051,self.isClosed,"Document must not already be open when we are loading")}catch(PERR){g.reportError(PERR)}try{self.isClosed||g.reportError(new Error("Multi-Document Load"),window.__LOAD_REQUESTS.ordered())}catch(err){g.reportError(err)}self.initialized=!0,self.loadedOnce=!0,ShouldLog(LogLevels.Timing)&&log("Loading document from gdrive",log.now()),d||(d=require("data")),VMLI||(VMLI=require("VMLI")),self.doc=doc,self.model=doc.getModel(),self.root=self.model.getRoot(),self.root.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,self.rootChanged),self.isClosed=!1,self.registerForSaveStateChange(self.onSaveStateChange);var stopLoadingRemote=self.migrateData();return stopLoadingRemote?(log("---- Skipping Document Load! ----"),self.isClosed=!0,self.initialized=!1,self.doc=void 0,self.model=void 0,self.root=void 0,!1):(self.loadDataCaches(),self.rootItem=self.root.get("root"),self.rootItem?(self.rootID=self.rootItem.id,window.__remoteDoc=doc,undoRedoStateChangeHandler&&(self.registerForUndoRedoStateChange(undoRedoStateChangeHandler),undoRedoStateChangeHandler=void 0),g.vmMain&&g.vmMain.isLoaded?g.vmMain.loadGDriveData():g.requireGDriveDataCallback=!0,self.loadCollaborators(),!0):void g.menus.alert({text:"Moo.do has encountered an error. The developers have been notified to make sure this doesn't happen again. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",callback:function callbackFn(){d.clearData(function(){g.reload()})}}))}catch(err){g.reportError(err)}},self.getServerVersion=function getServerVersionFn(){return self.model&&!self.isClosed?self.model.serverVersion:void 0};var notifyOfSaveChange=[];self.registerSaveNotify=function registerSaveNotifyFn(fn){notifyOfSaveChange.push(fn)};var lastPending=!1,lastSaving=!1,saveTimeout;return self.onSaveStateChange=function onSaveStateChangeFn(e){if(lastPending!==e.isPending||lastSaving!==e.isSaving){if(e.isSaving||e.isPending)navigator.onLine?e.isSaving&&(e.isPending||g.vmMain.setGDriveStatus(DriveStatus.Saving),clearTimeout(saveTimeout),saveTimeout=setTimeout(self.onErrorSaving,self.offlineTimeoutMS)):g.vmMain.setGDriveStatus(DriveStatus.Offline);else{g.vmMain.setGDriveStatus(DriveStatus.Saved),d.clearPendingUpdates(),clearTimeout(saveTimeout),saveTimeout=void 0,g.toasts.clearMessage(MessageID.ConnectionError);for(var i=0;i<notifyOfSaveChange.length;++i)notifyOfSaveChange[i](self.numChanges);self.numChanges=0}lastPending=e.isPending,lastSaving=e.isSaving}},self.onErrorSaving=function onErrorSavingFn(){g.vmMain.setGDriveStatus(DriveStatus.Offline),saveTimeout=void 0},self.getVersion=function getVersionFn(map,type){try{g.PAssert(3052,!(map instanceof VMLI),"Must pass in a valid remote item: ",g.getObjectInfo(map))}catch(PERR){g.reportError(PERR)}var field,v;switch(type){case VersionType.Structure:v=map.get(g.translateFieldIn("version"));break;case VersionType.Text:v=map.get(g.translateFieldIn("versionText"));break;default:v=-2;try{g.PAssert(3053,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},self.get=function getFn(map,field){try{g.PAssert(3054,!(map instanceof VMLI),"Must pass in a valid remote item: ",g.getObjectInfo(map))}catch(PERR){g.reportError(PERR)}return map.get(g.translateFieldIn(field))},self.set=function setFn(map,field,value){self.beginWriteAction();try{g.PAssert(3055,!(map instanceof VMLI),"Must pass in a valid remote item: ",g.getObjectInfo(map))}catch(PERR){g.reportError(PERR)}return void 0===value&&(value=null),map.set(g.translateFieldIn(field),value)},self.delete=function deleteFn(map,field){self.beginWriteAction();try{g.PAssert(3056,!(map instanceof VMLI),"Must pass in a valid remote item: ",g.getObjectInfo(map))}catch(PERR){g.reportError(PERR)}return map.delete(g.translateFieldIn(field))},self.findInTree=function findInTreeFn(item){try{g.PAssert(3059,item,"Must provide a valid item to find")}catch(PERR){g.reportError(PERR)}var isArchived=!1,parent=self.getItemParent(item);if(parent){var itemList=self.getItemList(parent,!1),itemIndex=-1;if(itemList&&(itemIndex=itemList.indexOf(item)),0>itemIndex){var archivedItemList=self.getItemList(parent,!0);archivedItemList&&(itemIndex=archivedItemList.indexOf(item),itemIndex>=0&&(isArchived=!0))}}var output=void 0;return parent&&itemIndex>=0&&(output={parent:parent,index:itemIndex,isArchived:isArchived}),output},self});var idbModules={util:{}},cleanInterface=!1;!function(){var testObject={test:!0};if(Object.defineProperty)try{Object.defineProperty(testObject,"test",{enumerable:!1}),testObject.test&&(cleanInterface=!0)}catch(e){}}(),function(idbModules){function callback(fn,context,event){event.target=context,"function"==typeof context[fn]&&context[fn].apply(context,[event])}var StringList=function(){this.length=0,this._items=[],cleanInterface&&Object.defineProperty(this,"_items",{enumerable:!1})};if(StringList.prototype={contains:function(str){return-1!==this._items.indexOf(str)},item:function(key){return this._items[key]},indexOf:function(str){return this._items.indexOf(str)},push:function(item){this._items.push(item),this.length+=1;for(var i=0;i<this._items.length;i++)this[i]=this._items[i]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var i in this)i===String(parseInt(i,10))&&delete this[i];for(i=0;i<this._items.length;i++)this[i]=this._items[i]}},cleanInterface)for(var i in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(StringList.prototype,i,{enumerable:!1});idbModules.util.callback=callback,idbModules.util.StringList=StringList,idbModules.util.quote=function(arg){return'"'+arg+'"'}}(idbModules),function(idbModules){idbModules.Sca=window.Sca}(idbModules),function(idbModules){function validateKey(key){var type=typeof key;if("string"===type||"number"===type&&!isNaN(key)||key instanceof Date);else{if(!(key instanceof Array))throw idbModules.util.createDOMException("DataError","Not a valid key");for(var i=0;i<key.length;i++)validateKey(key[i])}}function getKeyPath(value,keyPath){try{return eval("value."+keyPath)}catch(e){return void 0}}function setKeyPath(value,keyPath,key){for(var props=keyPath.split("."),i=0;i<props.length-1;i++){var prop=props[i];value=value[prop]=value[prop]||{}}value[props[props.length-1]]=key}var collations=["","number","string","boolean","object","undefined"],getGenericEncoder=function(){return{encode:function(key){return collations.indexOf(typeof key)+"-"+JSON.stringify(key)},decode:function(key){return"undefined"==typeof key?void 0:JSON.parse(key.substring(2))}}},types={"boolean":getGenericEncoder(),object:getGenericEncoder(),number:{encode:function(key){return collations.indexOf("number")+"-"+key},decode:function(key){return parseFloat(key.substring(2))}},string:{encode:function(key){return collations.indexOf("string")+"-"+key},decode:function(key){return""+key.substring(2)}},undefined:{encode:function(key){return collations.indexOf("undefined")+"-undefined"},decode:function(key){return void 0}}};idbModules.Key={encode:function(key){return types[typeof key].encode(key)},encodeKey:function(key){return validateKey(key),types[typeof key].encode(key)},decode:function(key){return types[collations[key.substring(0,1)]].decode(key)},validateKey:validateKey,getKeyPath:getKeyPath,setKeyPath:setKeyPath}}(idbModules),function(idbModules){function createNativeEvent(type,debug){var event=new window.Event(type);return event.debug=debug,Object.defineProperty(event,"target",{writable:!0}),event}function ShimEvent(type,debug){this.type=type,this.debug=debug,this.bubbles=!1,this.cancelable=!1,this.eventPhase=0,this.timeStamp=(new Date).valueOf()}var useNativeEvent=!1;try{var test=createNativeEvent("test type","test debug"),target={test:"test target"};test.target=target,test instanceof window.Event&&"test type"===test.type&&"test debug"===test.debug&&test.target===target&&(useNativeEvent=!0)}catch(e){}useNativeEvent?(idbModules.Event=window.Event,idbModules.IDBVersionChangeEvent=window.Event,idbModules.util.createEvent=createNativeEvent):(idbModules.Event=ShimEvent,idbModules.IDBVersionChangeEvent=ShimEvent,idbModules.util.createEvent=function(type,debug){return new ShimEvent(type,debug)})}(idbModules),function(idbModules){function createNativeDOMException(name,message){var e=new DOMException.prototype.constructor(0,message);return e.name=name||"DOMException",e.message=message,e}function createNativeDOMError(name,message){name=name||"DOMError";var e=new DOMError(name,message);return e.name===name||(e.name=name),e.message===message||(e.message=message),e}function createError(name,message){var e=new Error(message);return e.name=name||"DOMException",e.message=message,e}function logError(name,message,error){var method}var test,runTest=!1,useNativeDOMException=!1,useNativeDOMError=!1;try{Object.getOwnPropertyDescription&&Object.getOwnPropertyDescription(DOMException.prototype,"name").set&&(runTest=!0),runTest&&(test=createNativeDOMException("test name","test message"),test instanceof DOMException&&"test name"===test.name&&"test message"===test.message&&(useNativeDOMException=!0))}catch(e){}try{test=createNativeDOMError("test name","test message"),test instanceof DOMError&&"test name"===test.name&&"test message"===test.message&&(useNativeDOMError=!0)}catch(e){}idbModules.util.logError=logError,useNativeDOMException?(idbModules.DOMException=DOMException,idbModules.util.createDOMException=function(name,message,error){return logError(name,message,error),createNativeDOMException(name,message)}):(idbModules.DOMException=Error,idbModules.util.createDOMException=function(name,message,error){return logError(name,message,error),createError(name,message)}),useNativeDOMError?(idbModules.DOMError=DOMError,idbModules.util.createDOMError=function(name,message,error){return logError(name,message,error),createNativeDOMError(name,message)}):(idbModules.DOMError=Error,idbModules.util.createDOMError=function(name,message,error){return logError(name,message,error),createError(name,message)})}(idbModules),function(idbModules){function IDBRequest(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"
}function IDBOpenDBRequest(){this.onblocked=this.onupgradeneeded=null}IDBOpenDBRequest.prototype=new IDBRequest,IDBOpenDBRequest.prototype.constructor=IDBOpenDBRequest,idbModules.IDBRequest=IDBRequest,idbModules.IDBOpenDBRequest=IDBOpenDBRequest}(idbModules),function(idbModules,undefined){function IDBKeyRange(lower,upper,lowerOpen,upperOpen){this.lower=lower,this.upper=upper,this.lowerOpen=lowerOpen,this.upperOpen=upperOpen}IDBKeyRange.only=function(value){return new IDBKeyRange(value,value,!1,!1)},IDBKeyRange.lowerBound=function(value,open){return new IDBKeyRange(value,undefined,open,undefined)},IDBKeyRange.upperBound=function(value,open){return new IDBKeyRange(undefined,value,undefined,open)},IDBKeyRange.bound=function(lower,upper,lowerOpen,upperOpen){return new IDBKeyRange(lower,upper,lowerOpen,upperOpen)},idbModules.IDBKeyRange=IDBKeyRange}(idbModules),function(idbModules,undefined){function IDBCursor(range,direction,store,cursorRequest,keyColumnName,valueColumnName){if(!range||range instanceof idbModules.IDBKeyRange||(range=new idbModules.IDBKeyRange(range,range,!1,!1)),this.__range=range,this.__req=cursorRequest,this.source=store,this.key=undefined,this.direction=direction,this.__keyColumnName=keyColumnName,this.__valueColumnName=valueColumnName,this.__valueDecoder="value"===valueColumnName?idbModules.Sca:idbModules.Key,!this.source.transaction.__active)throw idbModules.util.createDOMException("TransactionInactiveError","The transaction this IDBObjectStore belongs to is not active.");this.__offset=-1,this.__lastKeyContinued=undefined,this["continue"]()}IDBCursor.prototype.__find=function(key,tx,success,error,recordsToLoad){recordsToLoad=recordsToLoad||1;var me=this,sql=["SELECT * FROM ",idbModules.util.quote(me.source.name)],sqlValues=[];sql.push("WHERE ",me.__keyColumnName," NOT NULL"),!me.__range||me.__range.lower===undefined&&me.__range.upper===undefined||(sql.push("AND"),me.__range.lower!==undefined&&(sql.push(me.__keyColumnName+(me.__range.lowerOpen?" >":" >= ")+" ?"),sqlValues.push(idbModules.Key.encode(me.__range.lower))),me.__range.lower!==undefined&&me.__range.upper!==undefined&&sql.push("AND"),me.__range.upper!==undefined&&(sql.push(me.__keyColumnName+(me.__range.upperOpen?" < ":" <= ")+" ?"),sqlValues.push(idbModules.Key.encode(me.__range.upper)))),"undefined"!=typeof key&&(me.__lastKeyContinued=key,me.__offset=0),me.__lastKeyContinued!==undefined&&(sql.push("AND "+me.__keyColumnName+" >= ?"),sqlValues.push(idbModules.Key.encode(me.__lastKeyContinued)));var direction="prev"===me.direction||"prevunique"===me.direction?"DESC":"ASC";sql.push("ORDER BY ",me.__keyColumnName," "+direction),sql.push("LIMIT "+recordsToLoad+" OFFSET "+me.__offset),me.__prefetchedData=null,tx.executeSql(sql.join(" "),sqlValues,function(tx,data){data.rows.length>1?(me.__prefetchedData=data.rows,me.__prefetchedIndex=0,me.__decode(data.rows.item(0),success)):1===data.rows.length?me.__decode(data.rows.item(0),success):success(undefined,undefined)},function(tx,data){error(data)})},IDBCursor.prototype.__decode=function(rowItem,callback){var key=idbModules.Key.decode(rowItem[this.__keyColumnName]),val=this.__valueDecoder.decode(rowItem[this.__valueColumnName]),primaryKey=idbModules.Key.decode(rowItem.key);callback(key,val,primaryKey)},IDBCursor.prototype["continue"]=function(key){var recordsToPreloadOnContinue=idbModules.cursorPreloadPackSize||1e3,me=this;this.source.transaction.__addToTransactionQueue(function cursorContinue(tx,args,success,error){me.__offset++;var successCallback=function(key,val,primaryKey){me.key=key,me.value=val,me.primaryKey=primaryKey,success("undefined"!=typeof me.key?me:undefined,me.__req)};return me.__prefetchedData&&(me.__prefetchedIndex++,me.__prefetchedIndex<me.__prefetchedData.length)?void me.__decode(me.__prefetchedData.item(me.__prefetchedIndex),successCallback):void me.__find(key,tx,successCallback,error,recordsToPreloadOnContinue)})},IDBCursor.prototype.advance=function(count){if(0>=count)throw idbModules.util.createDOMException("Type Error","Count is invalid - 0 or negative",count);var me=this;this.source.transaction.__addToTransactionQueue(function cursorAdvance(tx,args,success,error){me.__offset+=count,me.__find(undefined,tx,function(key,value){me.key=key,me.value=value,success("undefined"!=typeof me.key?me:undefined,me.__req)},error)})},IDBCursor.prototype.update=function(valueToUpdate){var me=this;me.source.transaction.__assertWritable();var request=this.source.transaction.__createRequest();return idbModules.Sca.encode(valueToUpdate,function(encoded){me.source.transaction.__pushToQueue(request,function cursorUpdate(tx,args,success,error){me.__find(undefined,tx,function(key,value,primaryKey){for(var store=me.source,params=[encoded],sql="UPDATE "+idbModules.util.quote(store.name)+" SET value = ?",i=0;i<store.indexNames.length;i++){var index=store.__indexes[store.indexNames[i]];sql+=", "+index.name+" = ?",params.push(idbModules.Key.encode(idbModules.Key.getKeyPath(valueToUpdate,index.keyPath)))}sql+=" WHERE key = ?",params.push(idbModules.Key.encode(primaryKey)),tx.executeSql(sql,params,function(tx,data){me.__prefetchedData=null,1===data.rowsAffected?success(key):error("No rows with key found"+key)},function(tx,data){error(data)})},error)})}),request},IDBCursor.prototype["delete"]=function(){var me=this;return me.source.transaction.__assertWritable(),this.source.transaction.__addToTransactionQueue(function cursorDelete(tx,args,success,error){me.__find(undefined,tx,function(key,value,primaryKey){var sql="DELETE FROM  "+idbModules.util.quote(me.source.name)+" WHERE key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){me.__prefetchedData=null,1===data.rowsAffected?(me.__offset--,success(undefined)):error("No rows with key found"+key)},function(tx,data){error(data)})},error)})},idbModules.IDBCursor=IDBCursor}(idbModules),function(idbModules,undefined){function IDBIndex(store,indexProperties){this.objectStore=store,this.name=indexProperties.columnName,this.keyPath=indexProperties.keyPath,this.multiEntry=indexProperties.optionalParams&&indexProperties.optionalParams.multiEntry,this.unique=indexProperties.optionalParams&&indexProperties.optionalParams.unique}IDBIndex.__createIndex=function(store,index){store.__indexes[index.name]=index,store.indexNames.push(index.name);var transaction=store.transaction;transaction.__addToTransactionQueue(function createIndex(tx,args,success,failure){function error(tx,err){failure(idbModules.util.createDOMException(0,'Could not create index "'+index.name+'"',err))}var sql=["ALTER TABLE",idbModules.util.quote(store.name),"ADD",idbModules.util.quote(index.name),"BLOB"].join(" ");tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(store.name),[],function(tx,data){function initIndexForRow(i){if(i<data.rows.length)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=idbModules.Key.getKeyPath(value,index.keyPath);tx.executeSql("UPDATE "+idbModules.util.quote(store.name)+" set "+idbModules.util.quote(index.name)+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(tx,data){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else updateObjectStoreSchema()}function updateObjectStoreSchema(){for(var indexList={},i=0;i<store.indexNames.length;i++){var idx=store.__indexes[store.indexNames[i]];indexList[idx.name]={columnName:idx.name,keyPath:idx.keyPath,optionalParams:{unique:idx.unique,multiEntry:idx.multiEntry}}}tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[JSON.stringify(indexList),store.name],function(){success(index)},error)}initIndexForRow(0)},error)},error)})},IDBIndex.__deleteIndex=function(store,index){store.__indexes[index.name]=undefined,store.indexNames.splice(store.indexNames.indexOf(index.name),1)},IDBIndex.prototype.__fetchIndexData=function(key,opType){var me=this,hasKey;return 1===arguments.length?(opType=key,key=undefined,hasKey=!1):(key=idbModules.Key.encodeKey(key),hasKey=!0),me.objectStore.transaction.__addToTransactionQueue(function fetchIndexData(tx,args,success,error){var sql=["SELECT * FROM ",idbModules.util.quote(me.objectStore.name)," WHERE",idbModules.util.quote(me.name),"NOT NULL"],sqlValues=[];hasKey&&(sql.push("AND",idbModules.util.quote(me.name)," = ?"),sqlValues.push(key)),tx.executeSql(sql.join(" "),sqlValues,function(tx,data){var d;d="count"===opType?data.rows.length:0===data.rows.length?undefined:"key"===opType?idbModules.Key.decode(data.rows.item(0).key):idbModules.Sca.decode(data.rows.item(0).value),success(d)},error)})},IDBIndex.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this.objectStore,cursorRequest,this.name,"value");return cursorRequest},IDBIndex.prototype.openKeyCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this.objectStore,cursorRequest,this.name,"key");return cursorRequest},IDBIndex.prototype.get=function(key){if(0===arguments.length)throw new TypeError("No key was specified");return this.__fetchIndexData(key,"value")},IDBIndex.prototype.getKey=function(key){if(0===arguments.length)throw new TypeError("No key was specified");return this.__fetchIndexData(key,"key")},IDBIndex.prototype.count=function(key){return 0===arguments.length?this.__fetchIndexData("count"):this.__fetchIndexData(key,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){function IDBObjectStore(storeProperties,transaction){this.name=storeProperties.name,this.keyPath=storeProperties.keyPath||null,this.autoIncrement="string"==typeof storeProperties.autoInc?"true"===storeProperties.autoInc:!!storeProperties.autoInc,this.transaction=transaction,this.__indexes={},this.indexNames=new idbModules.util.StringList;var indexList="object"==typeof storeProperties.indexList?storeProperties.indexList:JSON.parse(storeProperties.indexList);for(var indexName in indexList)if(indexList.hasOwnProperty(indexName)){var index=new idbModules.IDBIndex(this,indexList[indexName]);this.__indexes[index.name]=index,this.indexNames.push(index.name)}}IDBObjectStore.__createObjectStore=function(db,store){db.__objectStores[store.name]=store,db.objectStoreNames.push(store.name);var transaction=db.__versionTransaction;idbModules.IDBTransaction.__assertVersionChange(transaction),transaction.__addToTransactionQueue(function createObjectStore(tx,args,success,failure){function error(tx,err){throw idbModules.util.createDOMException(0,'Could not create object store "'+store.name+'"',err)}var sql=["CREATE TABLE",idbModules.util.quote(store.name),"(key BLOB",store.autoIncrement?"UNIQUE, inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");tx.executeSql(sql,[],function(tx,data){tx.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[store.name,store.keyPath,store.autoIncrement,"{}"],function(){success(store)},error)},error)})},IDBObjectStore.__deleteObjectStore=function(db,store){db.__objectStores[store.name]=void 0,db.objectStoreNames.splice(db.objectStoreNames.indexOf(store.name),1);var transaction=db.__versionTransaction;idbModules.IDBTransaction.__assertVersionChange(transaction),transaction.__addToTransactionQueue(function deleteObjectStore(tx,args,success,failure){function error(tx,err){failure(idbModules.util.createDOMException(0,"Could not delete ObjectStore",err))}db.__db.transaction(function(tx){tx.executeSql("SELECT * FROM __sys__ where name = ?",[store.name],function(tx,data){data.rows.length>0&&tx.executeSql("DROP TABLE "+idbModules.util.quote(store.name),[],function(){tx.executeSql("DELETE FROM __sys__ WHERE name = ?",[store.name],function(){success()},error)},error)})})})},IDBObjectStore.prototype.__validateKey=function(value,key){if(this.keyPath){if("undefined"!=typeof key)throw idbModules.util.createDOMException("DataError","The object store uses in-line keys and the key parameter was provided",this);if(!value||"object"!=typeof value)throw idbModules.util.createDOMException("DataError","KeyPath was specified, but value was not an object");if(key=idbModules.Key.getKeyPath(value,this.keyPath),void 0===key){if(this.autoIncrement)return;throw idbModules.util.createDOMException("DataError","Could not eval key from keyPath")}}else if("undefined"==typeof key){if(this.autoIncrement)return;throw idbModules.util.createDOMException("DataError","The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",this)}idbModules.Key.validateKey(key)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,success,failure){function getNextAutoIncKey(callback){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(tx,data){callback(1!==data.rows.length?1:data.rows.item(0).seq+1)},function(tx,error){failure(idbModules.util.createDOMException("DataError","Could not get the auto increment value for key",error))})}var me=this;if(me.keyPath){var primaryKey=idbModules.Key.getKeyPath(value,me.keyPath);void 0===primaryKey&&me.autoIncrement?getNextAutoIncKey(function(primaryKey){try{idbModules.Key.setKeyPath(value,me.keyPath,primaryKey),success(primaryKey)}catch(e){failure(idbModules.util.createDOMException("DataError","Could not assign a generated value to the keyPath",e))}}):success(primaryKey)}else"undefined"==typeof key&&me.autoIncrement?getNextAutoIncKey(success):success(key)},IDBObjectStore.prototype.__insertData=function(tx,encoded,value,primaryKey,success,error){try{var paramMap={};"undefined"!=typeof primaryKey&&(paramMap.key=idbModules.Key.encodeKey(primaryKey));for(var i=0;i<this.indexNames.length;i++){var index=this.__indexes[this.indexNames[i]];paramMap[index.name]=idbModules.Key.encode(idbModules.Key.getKeyPath(value,index.keyPath))}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(var key in paramMap)sqlStart.push(idbModules.util.quote(key)+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(encoded);var sql=sqlStart.join(" ")+sqlEnd.join(" ");tx.executeSql(sql,sqlValues,function(tx,data){idbModules.Sca.encode(primaryKey,function(primaryKey){primaryKey=idbModules.Sca.decode(primaryKey),success(primaryKey)})},function(tx,err){error(idbModules.util.createDOMError("ConstraintError",err.message,err))})}catch(e){error(e)}},IDBObjectStore.prototype.add=function(value,key){var me=this;if(0===arguments.length)throw new TypeError("No value was specified");this.__validateKey(value,key),me.transaction.__assertWritable();var request=me.transaction.__createRequest();return me.transaction.__pushToQueue(request,function objectStoreAdd(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){idbModules.Sca.encode(value,function(encoded){me.__insertData(tx,encoded,value,primaryKey,success,error)})},error)}),request},IDBObjectStore.prototype.put=function(value,key){var me=this;if(0===arguments.length)throw new TypeError("No value was specified");this.__validateKey(value,key),me.transaction.__assertWritable();var request=me.transaction.__createRequest();return me.transaction.__pushToQueue(request,function objectStorePut(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){idbModules.Sca.encode(value,function(encoded){var sql="DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){me.__insertData(tx,encoded,value,primaryKey,success,error)},function(tx,err){error(err)})})},error)}),request},IDBObjectStore.prototype.get=function(key){var me=this;if(0===arguments.length)throw new TypeError("No key was specified");var primaryKey=idbModules.Key.encodeKey(key);return me.transaction.__addToTransactionQueue(function objectStoreGet(tx,args,success,error){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){var value;try{if(0===data.rows.length)return success();value=idbModules.Sca.decode(data.rows.item(0).value)}catch(e){}success(value)},function(tx,err){error(err)})})},IDBObjectStore.prototype["delete"]=function(key){var me=this;if(0===arguments.length)throw new TypeError("No key was specified");me.transaction.__assertWritable();var primaryKey=idbModules.Key.encodeKey(key);return me.transaction.__addToTransactionQueue(function objectStoreDelete(tx,args,success,error){tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){success()},function(tx,err){error(err)})})},IDBObjectStore.prototype.clear=function(){var me=this;return me.transaction.__assertWritable(),me.transaction.__addToTransactionQueue(function objectStoreClear(tx,args,success,error){tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name),[],function(tx,data){success()},function(tx,err){error(err)})})},IDBObjectStore.prototype.count=function(key){var me=this,hasKey=!1;return arguments.length>0&&(hasKey=!0,key=idbModules.Key.encodeKey(key)),me.transaction.__addToTransactionQueue(function objectStoreCount(tx,args,success,error){var sql="SELECT * FROM "+idbModules.util.quote(me.name)+(hasKey?" WHERE key = ?":""),sqlValues=[];hasKey&&sqlValues.push(key),tx.executeSql(sql,sqlValues,function(tx,data){success(data.rows.length)},function(tx,err){error(err)})})},IDBObjectStore.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest,cursor=new idbModules.IDBCursor(range,direction,this,cursorRequest,"key","value");return cursorRequest},IDBObjectStore.prototype.index=function(indexName){if(0===arguments.length)throw new TypeError("No index name was specified");var index=this.__indexes[indexName];if(!index)throw idbModules.util.createDOMException("NotFoundError",'Index "'+indexName+'" does not exist on '+this.name);return index},IDBObjectStore.prototype.createIndex=function(indexName,keyPath,optionalParameters){if(0===arguments.length)throw new TypeError("No index name was specified");if(1===arguments.length)throw new TypeError("No key path was specified");if(this.__indexes[indexName])throw idbModules.util.createDOMException("ConstraintError",'Index "'+indexName+'" already exists on '+this.name);this.transaction.__assertVersionChange(),optionalParameters=optionalParameters||{};var indexProperties={columnName:indexName,keyPath:keyPath,optionalParams:{unique:!!optionalParameters.unique,multiEntry:!!optionalParameters.multiEntry}},index=new idbModules.IDBIndex(this,indexProperties);return idbModules.IDBIndex.__createIndex(this,index),index},IDBObjectStore.prototype.deleteIndex=function(indexName){if(0===arguments.length)throw new TypeError("No index name was specified");var index=this.__indexes[indexName];if(!index)throw idbModules.util.createDOMException("NotFoundError",'Index "'+indexName+'" does not exist on '+this.name);this.transaction.__assertVersionChange(),idbModules.IDBIndex.__deleteIndex(this,index)},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(idbModules){function IDBTransaction(db,storeNames,mode){this.__active=!0,this.__running=!1,this.__requests=[],this.__storeNames=storeNames,this.mode=mode,this.db=db,this.error=null,this.onabort=this.onerror=this.oncomplete=null;var me=this;setTimeout(function(){me.__executeRequests()},0)}IDBTransaction.prototype.__executeRequests=function(){function transactionError(err){try{idbModules.util.logError("Error","An error occurred in a transaction",err),me.error=err;var evt=idbModules.util.createEvent("error");idbModules.util.callback("onerror",me,evt)}finally{me.abort()}}function transactionFinished(){var evt=idbModules.util.createEvent("complete");idbModules.util.callback("oncomplete",me,evt),idbModules.util.callback("__oncomplete",me,evt)}if(!this.__running){this.__running=!0;var me=this;me.db.__db.transaction(function executeRequests(tx){function success(result,req){req&&(q.req=req),q.req.readyState="done",q.req.result=result,delete q.req.error;var e=idbModules.util.createEvent("success");idbModules.util.callback("onsuccess",q.req,e),i++,executeNextRequest()}function error(tx,err){1===arguments.length&&(err=tx);try{q.req.readyState="done",q.req.error=err||"DOMError";var e=idbModules.util.createEvent("error",err);idbModules.util.callback("onerror",q.req,e)}finally{transactionError(err)}}function executeNextRequest(){if(i>=me.__requests.length)me.__requests=[],me.__active&&(me.__active=!1,transactionFinished());else try{q=me.__requests[i],q.op(tx,q.args,success,error)}catch(e){error(e)}}me.__tx=tx;var q=null,i=0;executeNextRequest()},transactionError)}},IDBTransaction.prototype.__createRequest=function(){var request=new idbModules.IDBRequest;return request.source=this.db,request.transaction=this,request},IDBTransaction.prototype.__addToTransactionQueue=function(callback,args){var request=this.__createRequest();return this.__pushToQueue(request,callback,args),request},IDBTransaction.prototype.__pushToQueue=function(request,callback,args){this.__assertActive(),this.__requests.push({op:callback,args:args,req:request})},IDBTransaction.prototype.__assertActive=function(){if(!this.__active)throw idbModules.util.createDOMException("TransactionInactiveError","A request was placed against a transaction which is currently not active, or which is finished")},IDBTransaction.prototype.__assertWritable=function(){if(this.mode===IDBTransaction.READ_ONLY)throw idbModules.util.createDOMException("ReadOnlyError","The transaction is read only")},IDBTransaction.prototype.__assertVersionChange=function(){IDBTransaction.__assertVersionChange(this)},IDBTransaction.__assertVersionChange=function(tx){if(!tx||tx.mode!==IDBTransaction.VERSION_CHANGE)throw idbModules.util.createDOMException("InvalidStateError","Not a version transaction")},IDBTransaction.prototype.objectStore=function(objectStoreName){if(0===arguments.length)throw new TypeError("No object store name was specified");if(!this.__active)throw idbModules.util.createDOMException("InvalidStateError","A request was placed against a transaction which is currently not active, or which is finished");if(-1===this.__storeNames.indexOf(objectStoreName)&&this.mode!==IDBTransaction.VERSION_CHANGE)throw idbModules.util.createDOMException("NotFoundError",objectStoreName+" is not participating in this transaction");var store=this.db.__objectStores[objectStoreName];if(!store)throw idbModules.util.createDOMException("NotFoundError",objectStoreName+" does not exist in "+this.db.name);return store.transaction=this,store},IDBTransaction.prototype.abort=function(){var me=this;me.__active=!1;var evt=idbModules.util.createEvent("abort");setTimeout(function(){idbModules.util.callback("onabort",me,evt)},0)},IDBTransaction.READ_ONLY="readonly",IDBTransaction.READ_WRITE="readwrite",IDBTransaction.VERSION_CHANGE="versionchange",idbModules.IDBTransaction=IDBTransaction}(idbModules),function(idbModules){function IDBDatabase(db,name,version,storeProperties){this.__db=db,this.__closed=!1,this.version=version,this.name=name,this.onabort=this.onerror=this.onversionchange=null,this.__objectStores={},this.objectStoreNames=new idbModules.util.StringList;for(var i=0;i<storeProperties.rows.length;i++){var store=new idbModules.IDBObjectStore(storeProperties.rows.item(i));this.__objectStores[store.name]=store,this.objectStoreNames.push(store.name)}}IDBDatabase.prototype.createObjectStore=function(storeName,createOptions){if(0===arguments.length)throw new TypeError("No object store name was specified");if(this.__objectStores[storeName])throw idbModules.util.createDOMException("ConstraintError",'Object store "'+storeName+'" already exists in '+this.name);this.__versionTransaction.__assertVersionChange(),createOptions=createOptions||{};var storeProperties={name:storeName,keyPath:createOptions.keyPath||null,autoInc:!!createOptions.autoIncrement,indexList:{}},store=new idbModules.IDBObjectStore(storeProperties,this.__versionTransaction);return idbModules.IDBObjectStore.__createObjectStore(this,store),store},IDBDatabase.prototype.deleteObjectStore=function(storeName){if(0===arguments.length)throw new TypeError("No object store name was specified");var store=this.__objectStores[storeName];if(!store)throw idbModules.util.createDOMException("NotFoundError",'Object store "'+storeName+'" does not exist in '+this.name);this.__versionTransaction.__assertVersionChange(),idbModules.IDBObjectStore.__deleteObjectStore(this,store)},IDBDatabase.prototype.close=function(){this.__closed=!0},IDBDatabase.prototype.transaction=function(storeNames,mode){if(this.__closed)throw idbModules.util.createDOMException("InvalidStateError","An attempt was made to start a new transaction on a database connection that is not open");if(mode="number"==typeof mode?1===mode?IDBTransaction.READ_WRITE:IDBTransaction.READ_ONLY:mode||IDBTransaction.READ_ONLY,mode!==IDBTransaction.READ_ONLY&&mode!==IDBTransaction.READ_WRITE)throw new TypeError("Invalid transaction mode: "+mode);if(storeNames="string"==typeof storeNames?[storeNames]:storeNames,0===storeNames.length)throw idbModules.util.createDOMException("InvalidAccessError","No object store names were specified");for(var i=0;i<storeNames.length;i++)if(!this.objectStoreNames.contains(storeNames[i]))throw idbModules.util.createDOMException("NotFoundError",'The "'+storeNames[i]+'" object store does not exist');var transaction=new idbModules.IDBTransaction(this,storeNames,mode);return transaction},idbModules.IDBDatabase=IDBDatabase}(idbModules),function(idbModules){function IDBFactory(){this.Event=idbModules.Event,this.DOMException=idbModules.DOMException,this.DOMError=idbModules.DOMError}var DEFAULT_DB_SIZE=2097152,sysdb,isShimReady=!1,isReadyCallbacks,shimInitSuccess=!1;IDBFactory.prototype.loadShim=function(){window.openDatabase&&(sysdb=window.openDatabase("__sysdb__",1,"System Database",DEFAULT_DB_SIZE),sysdb.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){this.notifyIsReady(!0)}.bind(this),function(){this.notifyIsReady(!1)}.bind(this))}.bind(this),function(){this.notifyIsReady(!1)}.bind(this)))},IDBFactory.prototype.notifyIsReady=function(success){if(isShimReady=!0,shimInitSuccess=success,isReadyCallbacks){for(var i=0;i<isReadyCallbacks.length;++i)isReadyCallbacks[i](shimInitSuccess);isReadyCallbacks=void 0}},IDBFactory.prototype.onIsReady=function(cb){isShimReady?setTimeout(function(){cb(shimInitSuccess)},0):isReadyCallbacks?isReadyCallbacks.push(cb):isReadyCallbacks=[cb]},IDBFactory.prototype.open=function(name,version){function dbCreateError(err){if(!calledDbCreateError){calledDbCreateError=!0;var evt=idbModules.util.createEvent("error",arguments);req.readyState="done",req.error=err||"DOMError",idbModules.util.callback("onerror",req,evt)}}function openDB(oldVersion){var db=window.openDatabase(name,1,name,DEFAULT_DB_SIZE);if(req.readyState="done","undefined"==typeof version&&(version=oldVersion||1),0>=version||oldVersion>version){var err=idbModules.util.createDOMError("VersionError","An attempt was made to open a database using a lower version than the existing version.",version);return void dbCreateError(err)}db.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){tx.executeSql("SELECT * FROM __sys__",[],function(tx,data){var e=idbModules.util.createEvent("success");req.source=req.result=new idbModules.IDBDatabase(db,name,version,data),version>oldVersion?sysdb.transaction(function(systx){systx.executeSql("UPDATE dbVersions set version = ? where name = ?",[version,name],function(){var e=idbModules.util.createEvent("upgradeneeded");e.oldVersion=oldVersion,e.newVersion=version,req.transaction=req.result.__versionTransaction=new idbModules.IDBTransaction(req.source,[],idbModules.IDBTransaction.VERSION_CHANGE),req.transaction.__addToTransactionQueue(function onupgradeneeded(tx,args,success){idbModules.util.callback("onupgradeneeded",req,e),success()}),req.transaction.__oncomplete=function(){req.transaction=null;var e=idbModules.util.createEvent("success");idbModules.util.callback("onsuccess",req,e)}},dbCreateError)},dbCreateError):idbModules.util.callback("onsuccess",req,e)},dbCreateError)},dbCreateError)},dbCreateError)}var req=new idbModules.IDBOpenDBRequest,calledDbCreateError=!1;if(0===arguments.length)throw new TypeError("Database name is required");if(2===arguments.length&&(version=parseFloat(version),isNaN(version)||!isFinite(version)||0>=version))throw new TypeError("Invalid database version: "+version);return name+="",sysdb.transaction(function(tx){tx.executeSql("SELECT * FROM dbVersions where name = ?",[name],function(tx,data){0===data.rows.length?tx.executeSql("INSERT INTO dbVersions VALUES (?,?)",[name,version||1],function(){openDB(0)},dbCreateError):openDB(data.rows.item(0).version)},dbCreateError)},dbCreateError),req},IDBFactory.prototype.deleteDatabase=function(name){function dbError(msg){if(!calledDBError){req.readyState="done",req.error="DOMError";var e=idbModules.util.createEvent("error");e.message=msg,e.debug=arguments,idbModules.util.callback("onerror",req,e),calledDBError=!0}}function deleteFromDbVersions(){sysdb.transaction(function(systx){systx.executeSql("DELETE FROM dbVersions where name = ? ",[name],function(){req.result=void 0;var e=idbModules.util.createEvent("success");e.newVersion=null,e.oldVersion=version,idbModules.util.callback("onsuccess",req,e)},dbError)},dbError)}var req=new idbModules.IDBOpenDBRequest,calledDBError=!1,version=null;if(0===arguments.length)throw new TypeError("Database name is required");return name+="",sysdb.transaction(function(systx){systx.executeSql("SELECT * FROM dbVersions where name = ?",[name],function(tx,data){if(0===data.rows.length){req.result=void 0;var e=idbModules.util.createEvent("success");return e.newVersion=null,e.oldVersion=version,void idbModules.util.callback("onsuccess",req,e)}version=data.rows.item(0).version;var db=window.openDatabase(name,1,name,DEFAULT_DB_SIZE);db.transaction(function(tx){tx.executeSql("SELECT * FROM __sys__",[],function(tx,data){var tables=data.rows;!function deleteTables(i){i>=tables.length?tx.executeSql("DROP TABLE __sys__",[],function(){deleteFromDbVersions()},dbError):tx.executeSql("DROP TABLE "+idbModules.util.quote(tables.item(i).name),[],function(){deleteTables(i+1)},function(){deleteTables(i+1)})}(0)},function(e){deleteFromDbVersions()})},dbError)})},dbError),req},IDBFactory.prototype.cmp=function(key1,key2){return idbModules.Key.encodeKey(key1)>idbModules.Key.encodeKey(key2)?1:key1===key2?0:-1},idbModules.shimIndexedDB=new IDBFactory,idbModules.IDBFactory=IDBFactory}(idbModules),function(window,idbModules){function shim(name,value){try{window[name]=value}catch(e){}if(window[name]!==value&&Object.defineProperty){try{Object.defineProperty(window,name,{value:value})}catch(e){}window[name]!==value&&window.console&&console.warn&&console.warn("Unable to shim "+name)}}"undefined"!=typeof window.openDatabase&&(shim("shimIndexedDB",idbModules.shimIndexedDB),window.shimIndexedDB&&(window.shimIndexedDB.__useShim=function(){try{window.shimIndexedDB.loadShim(),shim("dbProvider",idbModules.shimIndexedDB),shim("IDBFactory",idbModules.IDBFactory),shim("IDBDatabase",idbModules.IDBDatabase),shim("IDBObjectStore",idbModules.IDBObjectStore),shim("IDBIndex",idbModules.IDBIndex),shim("IDBTransaction",idbModules.IDBTransaction),shim("IDBCursor",idbModules.IDBCursor),shim("IDBKeyRange",idbModules.IDBKeyRange),shim("IDBRequest",idbModules.IDBRequest),shim("IDBOpenDBRequest",idbModules.IDBOpenDBRequest),shim("IDBVersionChangeEvent",idbModules.IDBVersionChangeEvent)}catch(err){console.log("Error loading SQL shim")}})),window.dbProvider=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB;var poorIndexedDbSupport=!1;(navigator.userAgent.match(/Android 2/)||navigator.userAgent.match(/Android 3/)||navigator.userAgent.match(/Android 4\.[0-3]/))&&(navigator.userAgent.match(/Chrome/)||(poorIndexedDbSupport=!0));
var forceSQL=window.location.hash.indexOf("forcesql=true")>=0;if(forceSQL||("undefined"==typeof window.indexedDB||null===window.indexedDB||poorIndexedDbSupport)&&"undefined"!=typeof window.openDatabase)window.shimIndexedDB.__useShim();else{window.IDBDatabase=window.IDBDatabase||window.webkitIDBDatabase,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBCursor=window.IDBCursor||window.webkitIDBCursor,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,window.IDBTransaction||(window.IDBTransaction={});try{window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite"}catch(e){}}}(window,idbModules),define("IndexedDBShim",function(){}),define("database",["IndexedDBShim"],function(idbpoly){var dbProvider=window.dbProvider,IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,transactionModes={readonly:"readonly",readwrite:"readwrite"},hasOwn=Object.prototype.hasOwnProperty;if(!dbProvider)return void console.log("IndexedDB is not available");var defaultMapper=function(value){return value},CallbackList=function(){var state,list=[],exec=function(context,args){if(list){args=args||[],state=state||[context,args];for(var i=0,il=list.length;il>i;i++)list[i].apply(state[0],state[1]);list=[]}};this.add=function(){for(var i=0,il=arguments.length;il>i;i++)list.push(arguments[i]);return state&&exec(),this},this.execute=function(){return exec(this,arguments),this}},Deferred=function(func){var state="progress",actions=[["resolve","done",new CallbackList,"resolved"],["reject","fail",new CallbackList,"rejected"],["notify","progress",new CallbackList]],deferred={},promise={state:function(){return state},then:function(){var handlers=arguments;return Deferred(function(newDefer){actions.forEach(function(action,i){var handler=handlers[i];deferred[action[1]]("function"==typeof handler?function(){var returned=handler.apply(this,arguments);returned&&"function"==typeof returned.promise&&returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify)}:newDefer[action[0]])})}).promise()},promise:function(obj){return obj?(Object.keys(promise).forEach(function(key){obj[key]=promise[key]}),obj):promise}};return actions.forEach(function(action,i){var list=action[2],actionState=action[3];promise[action[1]]=list.add,actionState&&list.add(function(){state=actionState}),deferred[action[0]]=list.execute}),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},Server=function(db,name){var that=this,closed=!1;this.add=function(table){if(closed)throw"Database has been closed";for(var records=[],counter=0,i=0;i<arguments.length-1;i++)if(Array.isArray(arguments[i+1]))for(var j=0;j<arguments[i+1].length;j++)records[counter]=arguments[i+1][j],counter++;else records[counter]=arguments[i+1],counter++;var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred();return records.forEach(function(record){var req;if(record.item&&record.key){var key=record.key;record=record.item,req=store.add(record,key)}else req=store.add(record);req.onsuccess=function(e){var target=e.target,keyPath=target.source.keyPath;null===keyPath&&(keyPath="__id__"),Object.defineProperty(record,keyPath,{value:target.result,enumerable:!0}),deferred.notify()}}),transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.update=function(table){if(closed)throw"Database has been closed";for(var records=[],i=0;i<arguments.length-1;i++)records[i]=arguments[i+1];var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred();return records.forEach(function(record){var req;if(record.item&&record.key){var key=record.key;record=record.item,req=store.put(record,key)}else req=store.put(record);req.onsuccess=function(e){deferred.notify()}}),transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.updateObject=function(table){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),records=arguments[1];for(var id in records)store.put(records[id]);return transaction.oncomplete=function(){deferred.resolve(records,that)},transaction.onerror=function(e){deferred.reject(records,e)},transaction.onabort=function(e){deferred.reject(records,e)},deferred.promise()},this.remove=function(table,key){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),req=store.delete(key);return transaction.oncomplete=function(){deferred.resolve(key)},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.clear=function(table){if(closed)throw"Database has been closed";var transaction=db.transaction(table,transactionModes.readwrite),store=transaction.objectStore(table),deferred=Deferred(),req=store.clear();return transaction.oncomplete=function(){deferred.resolve()},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.close=function(){if(closed)throw"Database has been closed";db.close(),closed=!0,delete dbCache[name]},this.get=function(table,id){if(closed)throw"Database has been closed";var transaction=db.transaction(table),store=transaction.objectStore(table),deferred=Deferred(),req=store.get(id);return req.onsuccess=function(e){deferred.resolve(e.target.result)},transaction.onerror=function(e){deferred.reject(e)},deferred.promise()},this.query=function(table,index){if(closed)throw"Database has been closed";return new IndexQuery(table,db,index)};for(var i=0,il=db.objectStoreNames.length;il>i;i++)!function(storeName){that[storeName]={};for(var i in that)hasOwn.call(that,i)&&"close"!==i&&(that[storeName][i]=function(i){return function(){var args=[storeName].concat([].slice.call(arguments,0));return that[i].apply(that,args)}}(i))}(db.objectStoreNames[i])},IndexQuery=function(table,db,indexName){var that=this,modifyObj=!1,runFastQuery=function(){var transaction=db.transaction(table,transactionModes.readonly),store=transaction.objectStore(table),index=store,results=[],deferred=Deferred();return store.openCursor().onsuccess=function(e){var cursor=e.target.result;cursor&&(results.push(cursor.value),cursor.continue())},transaction.oncomplete=function(){deferred.resolve(results)},transaction.onerror=deferred.reject,transaction.onabort=deferred.reject,deferred.promise()},runQuery=function(type,args,cursorType,direction,limitRange,filters,mapper){var transaction=db.transaction(table,modifyObj?transactionModes.readwrite:transactionModes.readonly),store=transaction.objectStore(table),index=indexName?store.index(indexName):store,keyRange=type?IDBKeyRange[type].apply(null,args):null,results=[],deferred=Deferred(),indexArgs=[keyRange],limitRange=limitRange?limitRange:null,filters=filters?filters:void 0,counter=0;"count"!==cursorType&&indexArgs.push(direction||"next");var modifyKeys=modifyObj?Object.keys(modifyObj):!1,modifyRecord=function(record){for(var i=0;i<modifyKeys.length;i++){var key=modifyKeys[i],val=modifyObj[key];val instanceof Function&&(val=val(record)),record[key]=val}return record};return index[cursorType].apply(index,indexArgs).onsuccess=function(e){var cursor=e.target.result;if("number"==typeof cursor)results=cursor;else if(cursor)if(null!==limitRange&&limitRange[0]>counter)counter=limitRange[0],cursor.advance(limitRange[0]);else if(null!==limitRange&&counter>=limitRange[0]+limitRange[1]);else{var matchFilter=!0,result="value"in cursor?cursor.value:cursor.key;filters&&filters.forEach(function(filter){filter&&filter.length&&(matchFilter=2===filter.length?result[filter[0]]===filter[1]:filter[0].apply(void 0,[result]))}),matchFilter&&(counter++,results.push(mapper(result)),modifyObj&&(result=modifyRecord(result),cursor.update(result))),cursor.continue()}},transaction.oncomplete=function(){deferred.resolve(results)},transaction.onerror=function(e){deferred.reject(e)},transaction.onabort=function(e){deferred.reject(e)},deferred.promise()},Query=function(type,args){var direction="next",cursorType="openCursor",filters=[],limitRange=null,mapper=defaultMapper,unique=!1,execute=function(){return runQuery(type,args,cursorType,unique?direction+"unique":direction,limitRange,filters,mapper)},fastExecute=function(){return runFastQuery()},limit=function(){return limitRange=Array.prototype.slice.call(arguments,0,2),1==limitRange.length&&limitRange.unshift(0),{execute:execute}},count=function(){return direction=null,cursorType="count",{execute:execute}},keys=function(){return cursorType="openKeyCursor",{desc:desc,execute:execute,filter:filter,distinct:distinct,map:map}},filter=function(){return filters.push(Array.prototype.slice.call(arguments,0,2)),{keys:keys,execute:execute,fastExecute:fastExecute,count:count,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}},desc=function(){return direction="prev",{keys:keys,execute:execute,filter:filter,distinct:distinct,modify:modify,map:map}},distinct=function(){return unique=!0,{keys:keys,count:count,execute:execute,filter:filter,desc:desc,modify:modify,map:map}},modify=function(update){return modifyObj=update,{execute:execute}},map=function(fn){return mapper=fn,{execute:execute,count:count,keys:keys,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}};return{execute:execute,count:count,keys:keys,filter:filter,desc:desc,distinct:distinct,modify:modify,limit:limit,map:map}};"only bound upperBound lowerBound".split(" ").forEach(function(name){that[name]=function(){return new Query(name,arguments)}}),this.filter=function(){var query=new Query(null,null);return query.filter.apply(query,arguments)},this.all=function(){return this.filter()}},createSchema=function(e,schema,db){"function"==typeof schema&&(schema=schema());for(var tableName in schema){var table=schema[tableName],store;if(!hasOwn.call(schema,tableName)||db.objectStoreNames.contains(tableName)){var target=e.currentTarget||e.target;store=target.transaction.objectStore(tableName)}else store=db.createObjectStore(tableName,table.key);for(var indexKey in table.indexes)if(!store.indexNames.contains(indexKey)){var index=table.indexes[indexKey];store.createIndex(indexKey,index.key||indexKey,Object.keys(index).length?index:{unique:!1})}}},open=function(e,server,version,schema){var db=e.target.result,s=new Server(db,server),upgrade,deferred=Deferred();return deferred.resolve(s),dbCache[server]=db,deferred.promise()},dbCache={},db={version:"0.9.0",open:function(options){var request,deferred=Deferred();return dbCache[options.server]?open({target:{result:dbCache[options.server]}},options.server,options.version,options.schema).done(deferred.resolve).fail(deferred.reject).progress(deferred.notify):(request=dbProvider.open(options.server,options.version),request?(request.onsuccess=function(e){open(e,options.server,options.version,options.schema).done(deferred.resolve).fail(deferred.reject).progress(deferred.notify)},request.onupgradeneeded=function(e){createSchema(e,options.schema,e.target.result)},request.onerror=function(e){deferred.reject(e)}):deferred.reject({target:{error:{name:"DBOpenError"}}})),deferred.promise()}};return db}),define("EventDispatcher",["globals"],function(g){var EventDispatcherFns={_ensureListeners:function _ensureListenersFn(){return this._listeners||(this._listeners={}),this._listeners},clearListeners:function clearListenersFn(){this._listeners=void 0},listen:function listenFn(){for(var sub=this._ensureListeners(),i=0;i<arguments.length-1;++i){try{g.PAssert(3060,"callbacks"!==arguments[i],"Invalid event name/grouping")}catch(PERR){g.reportError(PERR)}sub[arguments[i]]||(sub[arguments[i]]={callbacks:[]}),sub=sub[arguments[i]]}sub.callbacks.push(arguments[arguments.length-1])},isListening:function isListeningFn(){for(var sub=this._ensureListeners(),cb=arguments[arguments.length-1],i=0;i<arguments.length-1;++i)sub[arguments[i]]&&(sub=sub[arguments[i]]);return sub&&sub.callbacks&&sub.callbacks.indexOf(cb)>=0},unlisten:function unlistenFn(){for(var sub=this._ensureListeners(),cb=arguments[arguments.length-1],i=0;i<arguments.length-1;++i){try{g.PAssert(3061,"callbacks"!==arguments[i],"Invalid event name/grouping")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3062,sub[arguments[i]],"Cannot unlisten something that has never been listened")}catch(PERR){g.reportError(PERR)}sub[arguments[i]]&&(sub=sub[arguments[i]])}try{g.PAssert(3063,sub&&sub.callbacks&&sub.callbacks.indexOf(cb)>=0,"Cannot unlisten something that has never been listened")}catch(PERR){g.reportError(PERR)}sub.callbacks&&sub.callbacks.remove(cb)},fireEvent:function fireEventFn(){var ret=!0,sub=this._ensureListeners(),cbArgs=arguments[arguments.length-1];try{g.PAssert(3064,void 0===cbArgs||g.isArray(cbArgs),"Last argument to fireEvent must be an array")}catch(PERR){g.reportError(PERR)}for(var i=0;i<arguments.length-1;++i){try{g.PAssert(3065,"callbacks"!==arguments[i],"Invalid event name/grouping")}catch(PERR){g.reportError(PERR)}if(!sub[arguments[i]])break;sub=sub[arguments[i]];for(var j=0;j<sub.callbacks.length;++j)try{ret=sub.callbacks[j].apply(this,cbArgs)&&ret}catch(err){g.reportError(err)}}return ret}};return EventDispatcherFns}),define("Dispatcher",["util","EventDispatcher"],function(util,EventDispatcher){function Dispatcher(){}return util.defineBase(Dispatcher),util.extend(Dispatcher.prototype,EventDispatcher),new Dispatcher}),define("demo",["globals","Dispatcher"],function(g,Dispatcher){function demo(){this.cache={},this.loadedGapiData={},this._isRemoteHooked=!1,this.resetListener=void 0}return demo.prototype={setGapiData:function setGapiDataFn(id,data){try{g.PAssert(3066,g.isObject(data)&&!g.isArray(data),"Setting malformed data",id)}catch(PERR){g.reportError(PERR)}this.loadedGapiData[id]=[];for(var entryID in data)data[entryID].id=entryID,this.loadedGapiData[id].push(data[entryID])},setGapiDataDirect:function setGapiDataDirectFn(id,dataArr){try{g.PAssert(3067,g.isArray(dataArr),"Setting malformed data",id)}catch(PERR){g.reportError(PERR)}this.loadedGapiData[id]||(this.loadedGapiData[id]=dataArr)},clearGapiData:function clearGapiDataFn(){this.loadedGapiData={}},loadRemoteData:function loadRemoteDataFn(info,cb){try{g.PAssert(3068,info&&cb,"Must supply valid remote load info as well as a cb when data is loaded")}catch(PERR){g.reportError(PERR)}var rInfo=info.split(".");this.cache[rInfo[0]]?cb(JSON.parse(JSON.stringify(this.cache[rInfo[0]][rInfo[1]]))):g.XHR({type:"GET",url:window.location.protocol+"//"+window.location.host+"/data/"+rInfo[0]+".json",cb:function cbFn(xhr){if(200===xhr.status)try{var demoData=JSON.parse(xhr.responseText);this.cache[rInfo[0]]=demoData,rInfo[1]||(rInfo[1]="0");var demoEntry=demoData[rInfo[1]];if(demoEntry){var dataCopy=JSON.parse(JSON.stringify(demoEntry));cb(dataCopy)}else log("Invalid data slot")}catch(err){log("Error parsing demo data: "+err.message)}else log("Error getting demo data",xhr.status,xhr.responseText)}.bind(this)})},stubGapi:function stubGapiFn(){try{g.PAssert(3069,!window.gapi,"Should not have loaded gapi when stubbing")}catch(PERR){g.reportError(PERR)}var emptyFn=function(){},emptyImpl=function(){return{}},emptyPromise=function(){return{then:emptyFn,execute:emptyFn}},BatchTimeout=0,timeouts=[];Dispatcher.listen("resetEverything",function(){for(var i=0;i<timeouts.length;++i)clearTimeout(timeouts[i]);timeouts=[]});var replyBatch=function(success,failure){var timeout=setTimeout(function(){timeouts.remove(timeout),success({success:!0})},BatchTimeout);timeouts.push(timeout)},createRequest=function(data){return{then:function thenFn(success,failure,context){var path=require("apis").getAPIForRequest(data);return path(data.__rawParams).then(success,failure,context)},execute:function executeFn(){}}};window.gapi={auth:{getToken:function getTokenFn(){return{expires_in:3600,expires_at:(Date.now()+g.minutes(60))/1e3,access_token:"InvalidToken",scope:[GScope.UserInfoEmail,GScope.Calendar,GScope.GmailCompose,GScope.GmailModify]}}},client:{request:createRequest,load:emptyFn,setApiKey:emptyFn,newBatch:function newBatchFn(){return{add:emptyFn,then:replyBatch}},drive:{files:{get:emptyPromise,list:emptyPromise,trash:emptyPromise,insert:emptyPromise,patch:emptyPromise},permissions:{list:emptyPromise,insert:emptyPromise,"delete":emptyPromise},properties:{insert:emptyPromise},parents:{insert:emptyPromise},changes:{list:emptyPromise}},gmail:{users:{threads:{list:emptyPromise,get:emptyPromise,modify:emptyPromise,trash:emptyPromise,untrash:emptyPromise},labels:{list:emptyPromise,create:emptyPromise},history:{list:emptyPromise},messages:{get:emptyPromise,send:emptyPromise,trash:emptyPromise,untrash:emptyPromise},drafts:{create:emptyPromise,update:emptyPromise,send:emptyPromise,"delete":emptyPromise,list:emptyPromise},settings:{sendAs:{list:emptyPromise}}}},calendar:{settings:{list:emptyPromise},events:{get:emptyPromise,list:emptyPromise,patch:emptyPromise,insert:emptyPromise,"delete":emptyPromise},calendars:{insert:emptyPromise},calendarList:{list:emptyPromise}}}}},areRemoteFunctionsHooked:function areRemoteFunctionsHookedFn(){return this._isRemoteHooked},hookRemoteFunctions:function hookRemoteFunctionsFn(){function findById(arr,id){try{g.PAssert(3071,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var i=0;i<arr.length;++i)if(arr[i].id===id)return arr[i];return void 0}function findByParentId(arr,id){try{g.PAssert(3072,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var matches=[],i=0;i<arr.length;++i)(arr[i].parents[0].id===id||"root"===id&&arr[i].parents[0].isRoot)&&matches.push(arr[i]);return matches}function findByField(arr,field,value){try{g.PAssert(3073,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}var matches=[];if(g.isArray(value));else for(var i=0;i<arr.length;++i)arr[i][field]===value&&matches.push(arr[i]);return matches}function findByFieldContains(arr,field,value){try{g.PAssert(3074,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var matches=[],i=0;i<arr.length;++i)arr[i][field].indexOf(value)>=0&&matches.push(arr[i]);return matches}function filterData(arr,filter){try{g.PAssert(3075,arr,"Must load local or remote data to perform queries")}catch(PERR){g.reportError(PERR)}for(var i=0;i<arr.length;++i){var val=filter(arr[i]);if(val)return val}}function replyThen(impl){return function(success,failure,context){var data;try{data=impl(context)}catch(err){g.reportError(err)}var timeout=setTimeout(function(){timeouts.remove(timeout),data?success.call(context,{result:data}):failure.call(context,{error:!0})},API_TIMEOUT);timeouts.push(timeout)}}function replyExecute(impl){return function(success,failure,context){var data=impl(context),timeout=setTimeout(function(){timeouts.remove(timeout),data?success(data):failure({error:!0})},API_TIMEOUT);timeouts.push(timeout)}}function genPromise(impl){return{then:replyThen(impl),execute:replyExecute(impl)}}function loadAPI_Drive(){gapi.client.drive.files.get=function(params){function impl(context){var file=findById(_this.loadedGapiData.Drive,params.fileId);return file}return genPromise(impl)},gapi.client.drive.files.list=function(params){function impl(context){if("mimeType='application/vnd.google-apps.drive-sdk.597847337936' and trashed=false"===params.q)return{items:_this.loadedGapiData.documents};var parentsCheck=/\'(.*)\' in parents/g,searchCheck=/title contains \'([^\']*)\'/g,mimeCheck=/mimeType contains \'([^\']*)\'/g,parentsMatch=parentsCheck.exec(params.q),searchMatch=searchCheck.exec(params.q),mimeMatch=mimeCheck.exec(params.q),matches=_this.loadedGapiData.Drive;if(parentsMatch){var parentID=parentsMatch[1];matches=findByParentId(matches,parentID)}if(searchMatch){var searchString=searchMatch[1];matches=findByFieldContains(matches,"title",searchString)}if(mimeMatch){var mimeString=mimeMatch[1];matches=findByFieldContains(matches,"mimeType",mimeString)}return{items:matches}}return genPromise(impl)},gapi.client.drive.files.trash=function(params){return genPromise(emptyImpl)},gapi.client.drive.files.insert=function(params){return genPromise(emptyImpl)},gapi.client.drive.files.patch=function(params){return genPromise(emptyImpl)},gapi.client.drive.permissions.list=function(params){function impl(context){return{items:_this.loadedGapiData.permissions}}return genPromise(impl)},gapi.client.drive.permissions.insert=function(params){return genPromise(emptyImpl)},gapi.client.drive.permissions.delete=function(params){return genPromise(emptyImpl)},gapi.client.drive.properties.insert=function(params){return genPromise(emptyImpl)}}function loadAPI_Gmail(){gapi.client.gmail.users.threads.list=function(params){function impl(context){var threads=findByField(_this.loadedGapiData.Gmail,"hideInPane",void 0).filter(function(entry){return"me"!==params.userId?entry.accountID===params.userId:!0});return{threads:threads}}return genPromise(impl)},gapi.client.gmail.users.threads.modify=function(params){function impl(context){var thread=findById(_this.loadedGapiData.Gmail,params.id)[0];if(!thread)return{};if(thread.labelIds||(thread.labelIds=[]),params.removeLabelIds)for(var i=0;i<params.removeLabelIds.length;++i)thread.labelIds.remove(params.removeLabelIds[i]);params.addLabelIds&&thread.labelids.pushOnlyUniques(params.addLabelIds)}return genPromise(impl)},gapi.client.gmail.users.threads.get=function(params){function impl(context){return findById(_this.loadedGapiData.Gmail,params.id)}return genPromise(impl)},gapi.client.gmail.users.messages.get=function(params){function impl(context){return filterData(_this.loadedGapiData.Gmail,function(entry){for(var i=0;i<entry.messages.length;++i)if(entry.messages[i].id===params.id)return entry.messages[i]})}return genPromise(impl)},gapi.client.gmail.users.messages.send=function(params){function impl(context){return{id:g.generateTempId(),threadId:params.resource.threadId||g.generateTempId().substr(3),labelIds:["SENT","UNREAD"]}}return genPromise(impl)},gapi.client.gmail.users.labels.list=function(params){function impl(context){return{labels:_this.loadedGapiData.Gmail_Labels}}return genPromise(impl)},gapi.client.gmail.users.labels.create=function(params){function impl(context){var label=findByField(_this.loadedGapiData.Gmail_Labels,"name",params.resource.name)[0];if(label)return label;var newID=g.generateTempId().substr(3);return label={name:params.resource.name,id:newID},_this.loadedGapiData.Gmail_Labels.push(label),label}return genPromise(impl)},gapi.client.gmail.users.settings.sendAs.list=function(params){function impl(context){return{sendAs:[{displayName:"Demo User",isDefault:!0,isPrimary:!0,replyToAddress:"",sendAsEmail:"demo@moo.do",signature:""}]}}return genPromise(impl)}}function loadAPI_GCalendar(){gapi.client.calendar.calendarList.list=function(params){function impl(context){return{items:_this.loadedGapiData.calendarList}}return genPromise(impl)},gapi.client.calendar.events.get=function(params){function impl(context){return findById(_this.loadedGapiData.GCalendar,params.eventId)}return genPromise(impl)}}try{g.PAssert(3070,!this._isRemoteHooked,"Should not hook remote functions more than once")}catch(PERR){g.reportError(PERR)}this.stubGapi(),this._isRemoteHooked=!0;var API_TIMEOUT=0,timeouts=[],_this=this;Dispatcher.listen("resetEverything",function(){for(var i=0;i<timeouts.length;++i)clearTimeout(timeouts[i]);timeouts=[]}),loadAPI_Drive(),loadAPI_Gmail(),loadAPI_GCalendar()}},new demo}),define("VMContact",["ko","globals"],function(ko,g){function VMContact(p){try{g.PAssert(3076,g.isObject(p),"Should always supply a valid object to init a contact")}catch(PERR){g.reportError(PERR)}this.id=p.id,this.type="contact",this.text=p.text||"",this.phoneNumbers=p.phoneNumbers||[],this.emails=p.emails||[],this.init()}return VMContact.prototype={init:function initFn(){for(var i=0;i<this.phoneNumbers.length;i++)this.phoneNumbers[i].link=this.formatPhone(this.phoneNumbers[i].number),this.phoneNumbers[i].type=this.phoneNumbers[i].type[0];for(var i=0;i<this.emails.length;i++)this.emails[i].link="mailto:"+this.emails[i].address},_phoneRegex:/^(?:\+?1[-. ]?)?(?:\(?([0-9]{3})\)?[-. ]?)?([0-9]{3})[-. ]?([0-9]{4})$/,formatPhone:function formatPhoneFn(phonenum){if(this._phoneRegex.test(phonenum)){var parts=phonenum.match(this._phoneRegex),phoneLink="";return parts[1]&&(phoneLink+="+1-"+parts[1]+"-"),phoneLink+=parts[2]+"-"+parts[3],"tel:"+phoneLink}var parsedNum=phonenum.replace(/\D+/g,"");try{g.PAssert(3077,parsedNum&&""!==parsedNum,"Invalid phone number format: "+phonenum)}catch(PERR){g.reportError(PERR)}return phonenum.startsWith("+")&&(parsedNum="+"+parsedNum),"tel:"+parsedNum},onTapNumber:function onTapNumberFn(e){g.openUrl(this.link,e,!0)},onTapEmail:function onTapEmailFn(e){var plugin=g.vmMain.getDefaultEmailPlugin();if(plugin.isActive()){var initData={to:[{text:"",email:this.address}]};g.menus.openComposeEmail(plugin,void 0,void 0,initData)}else g.openUrl(this.link,e,!0)},onTap:{onClick:function onClickFn(e){g.hasClass(e.srcElement,"contactPhone")||g.hasClass(e.srcElement,"contactEmail")||g.autocomplete.onTapped(this.text,this.text.length,!0)}}},VMContact}),define("Observable",["util","Listener"],function(util,Listener){function Observable(value,onUpdate){this._value=value,this._listeners=[],onUpdate&&this._listeners.push(onUpdate)}return Observable.prototype={get:function getFn(){return this._value},set:function setFn(value,notify){var oldValue=this._value;return this._value=value,notify!==!1&&this.notify(value,oldValue,notify),value},hasListeners:function hasListenersFn(){return this._listeners.length>0},listen:function listenFn(cb){return this._listeners.push(cb),new Listener(this,cb)},unlisten:function unlistenFn(cb){this._listeners.remove(cb)},notify:function notifyFn(value,oldValue,shouldNotify){if(0===arguments.length&&(value=this._value,oldValue=this._value,shouldNotify=!0),value!==oldValue||shouldNotify===!0)for(var i=0;i<this._listeners.length;++i)0===arguments.length?this._listeners[i](this._value):this._listeners[i](value,oldValue)}},util.defineBase(Observable),Observable}),define("ObservableArray",["require","exports","module","globals","util","Listener","Observable"],function(require,exports,module){function ObservableArray(value,onUpdate){this._super.constructor.call(this,value,onUpdate),this._value=value||[],this.version=0}var g=require("globals"),util=require("util"),Listener=require("Listener"),Observable=require("Observable"),ObservableArrayFns={wrapKOArray:function wrapKOArrayFn(koArray){this._value=koArray(),koArray.subscribe(this.koChanged.bind(this))},koChanged:function koChangedFn(value){this.set(value)},notify:function notifyFn(value,oldValue,shouldNotify){0===arguments.length&&this.version++,this._super.notify.apply(this,arguments)},length:function lengthFn(){return this._value.length},set:function setFn(arr,notify){try{g.PAssert(3078,arr&&g.isArray(arr),"Value set on an Observable array must be an array",arr)}catch(PERR){g.reportError(PERR)}this._value=arr,this.version++,notify!==!1&&this.notify(this._value)},clear:function clearFn(notify){this.set([],notify)},remove:function removeFn(itemOrFn,notify){var ret=[];if(g.isFunction(itemOrFn))for(var i=0;i<this._value.length;i++){var value=this._value[i];itemOrFn(value)&&(ret.push(value),this._value.splice(i,1),i--)}else ret=this._value.remove(itemOrFn);return this.version++,notify!==!1&&this.notify(this._value),ret},removeAt:function removeAtFn(index,notify){var ret=this._value.removeAt(index);return this.version++,notify!==!1&&this.notify(this._value),ret},push:function pushFn(item,notify){var ret=this._value.push(item);return this.version++,notify!==!1&&this.notify(this._value),ret},insertSorted:function insertSortedFn(item,sortFn,notify){var ret=this._value.insertSorted(item,sortFn);return this.version++,notify!==!1&&this.notify(this._value),ret},splice:function spliceFn(index,remove,item,notify){var ret;return ret=item?this._value.splice(index,remove,item):this._value.splice(index,remove),this.version++,notify!==!1&&this.notify(this._value),ret},indexOf:function indexOfFn(item){return this._value.indexOf(item)},indexOfWithProperty:function indexOfWithPropertyFn(prop,value){return this._value.indexOfWithProperty(prop,value)}};return util.inherit(Observable,ObservableArray),util.extend(ObservableArray.prototype,ObservableArrayFns),ObservableArray}),define("VMContactManager",["globals","VMContact","Observable","ObservableArray"],function(g,VMContact,Observable,ObservableArray){function VMContactManager(){this._contactCache={},this._contacts=new ObservableArray,this._contactsByName={},this._contactNames={___info___:{count:0}},this.init()}return VMContactManager.prototype={init:function initFn(){},loadContacts:function loadContactsFn(contacts,isDemo){try{g.PAssert(3079,0===this._contacts.get().length,"Should only load contacts once")}catch(PERR){g.reportError(PERR)}var modifiedContact=!1;if(contacts){for(var contactsToLoad=[],i=0;i<contacts.length;++i){var contact=contacts[i];if(contact.name&&(contact.text=contact.name,contacts[i].text=contact.name,delete contacts[i].name,modifiedContact=!0),!isDemo&&contact.isDemo||contact.text&&!contact.phoneNumbers&&!contact.emails)modifiedContact=!0;else{if(contact.text){var escContact=g.escape(contact.text);this._contactNames[escContact]="",this._contactsByName[contact.text]=contact,contactsToLoad.push(contact)}try{g.PAssert(3080,contact.id,"Each contact must have a valid id")}catch(PERR){g.reportError(PERR)}}}contactsToLoad.sort(this.contactComparator),this._contactNames.___info___.count=contactsToLoad.length,this._contacts.set(contactsToLoad)}else this.clearContacts();return modifiedContact},addContact:function addContactFn(contact){try{g.PAssert(3081,contact.id,"Incoming contacts must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3082,contact.text,"All contacts are expected to have a text")}catch(PERR){g.reportError(PERR)}var existingContact=this._contactsByName[contact.text];if(contact.emails){for(var emails=[],i=0;i<contact.emails.length;i++){for(var email=contact.emails[i],found=!1,u=0;u<emails.length;u++)if(emails[u].address.toLowerCase()===email.address.toLowerCase()){found=!0;break}found||emails.push(email)}contact.emails=emails}if(existingContact)contact.emails&&(existingContact.emails||(existingContact.emails=[]),existingContact.emails.pushOnlyUniques(contact.emails,this.emailComparator)),contact.phoneNumbers&&(existingContact.phoneNumbers||(existingContact.phoneNumbers=[]),existingContact.phoneNumbers.pushOnlyUniques(contact.phoneNumbers,this.phoneComparator));else{if(this._contacts.insertSorted(contact,this.contactComparator),contact.text){var escContact=g.escape(contact.text);this._contactNames[escContact]="",this._contactsByName[contact.text]=contact}this._contactNames.___info___.count=this._contacts.get().length}this._contactCache[contact.id]&&(this._contactCache[contact.id]=new VMContact(contact))},updateContact:function updateContactFn(newContact){try{g.PAssert(3083,newContact.id,"Incoming contacts must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3084,newContact.text,"All contacts are expected to have a text")}catch(PERR){g.reportError(PERR)}for(var wasReplaced=!1,i=0;i<this._contacts.get().length;++i){var oldContact=this._contacts.get()[i];if(oldContact.id===newContact.id){oldContact.text=newContact.text,oldContact.emails=oldContact.phoneNumbers=void 0,this.addContact(newContact),wasReplaced=!0;break}}return wasReplaced?void 0:(this.addContact(newContact),!0)
},clearContacts:function clearContactsFn(){this._contactCache={},this._contacts.clear(),this._contactsByName={},this._contactNames={___info___:{count:0}}},numContacts:function numContactsFn(){var num=this._contacts.get().length;try{g.PAssert(3085,num===this._contactNames.___info___.count,"Contact names count should match contacts value")}catch(PERR){g.reportError(PERR)}return num},getContacts:function getContactsFn(){return this._contactNames},previewTemplate:function previewTemplateFn(){return"template-contact"},getItemStyledText:function getItemStyledTextFn(item){return item.text},getItemText:function getItemTextFn(item){return item.text},getItemTextLength:function getItemTextLengthFn(item){return item.text.length},contactComparator:function contactComparatorFn(a,b){return a.text&&b.text?a.text.localeCompare(b.text):a.text&&!b.text?1:!a.text&&b.text?-1:void 0},emailComparator:function emailComparatorFn(a,b){return a.address&&b.address?a.address.toLowerCase().localeCompare(b.address.toLowerCase()):a.address&&!b.address?1:!a.address&&b.address?-1:void 0},phoneComparator:function phoneComparatorFn(a,b){return a===b},ensureCacheObject:function ensureCacheObjectFn(contactData){try{g.PAssert(3086,contactData,"Must have valid data to store in cache")}catch(PERR){g.reportError(PERR)}if(this._contactCache[contactData.id])return this._contactCache[contactData.id];var newContactVM=new VMContact(contactData);return this._contactCache[contactData.id]=newContactVM,newContactVM},findMatchExact:function findMatchExactFn(name){var contactData=this._contactsByName[name];return contactData?this.ensureCacheObject(contactData):void 0},findMatchLike:function findMatchLikeFn(name,maxCount){try{g.PAssert(3087,void 0!==name,"Must provide a valid contact part")}catch(PERR){g.reportError(PERR)}for(var upper=name.toUpperCase(),results=[],contacts=this._contacts.get(),i=0;i<contacts.length;++i){var index=contacts[i].text.toUpperCase().indexOf(upper);if(index>=0&&(results.push(this.ensureCacheObject(contacts[i])),results.length>=maxCount))break}return results.sort(this.contactComparator),results},findContactByEmail:function findContactByEmailFn(email){for(var i=0;i<this._contacts.get().length;++i){var contact=this._contacts.get()[i];if(contact.emails)for(var u=0;u<contact.emails.length;++u)if(contact.emails[u].address===email)return contact}return void 0},findEmailsLike:function findEmailsLikeFn(email,maxCount){try{g.PAssert(3088,void 0!==email,"Must provide a valid email part")}catch(PERR){g.reportError(PERR)}maxCount=maxCount||20;for(var results=[],upper=email.toUpperCase(),i=0;i<this._contacts.get().length;++i){var contact=this._contacts.get()[i];if(contact&&contact.emails){var allEmails=!1;contact.text&&contact.text.toUpperCase().indexOf(upper)>=0&&(allEmails=!0);for(var j=0;j<contact.emails.length;++j){var cEmail=contact.emails[j].address;(allEmails||cEmail.toUpperCase().indexOf(upper)>=0)&&results.push({type:"contact",text:contact.text,email:cEmail})}}if(results.length>=maxCount)break}return results.sort(this.emailComparator),results}},VMContactManager}),define("ItemStore",["globals","util","Dispatcher"],function(g,util,Dispatcher){function ItemStore(id,isReadonly,isDestructible,trackGlobally,enabledFilters,parserFn,owner){this.id=id;try{g.PAssert(3089,g.isFunction(parserFn),"Must supply a valid parser")}catch(PERR){g.reportError(PERR)}this._readonly=!!isReadonly,this._isDestructible=!!isDestructible,this._enabledFilters=enabledFilters,this._trackGlobally=!!trackGlobally,this._constructor=void 0,this._parser=parserFn,this._owner=owner,this._root=void 0,this._data={},this._destroyed=!1,this.init()}return ItemStore.prototype={init:function initFn(){this._constructor=require("VMLI"),util.forceBind("updateItems",this),util.forceBind("_markPaneDirty",this)},getParser:function getParserFn(){return this._parser},areFiltersEnabled:function areFiltersEnabledFn(filters){return g.isAtLeastOneFlagSet(this._enabledFilters,filters)},getEnabledFilters:function getEnabledFiltersFn(){return this._enabledFilters},isOwner:function isOwnerFn(owner){return this._owner===owner},destroy:function destroyFn(){try{g.PAssert(3090,this._isDestructible,"Item store must be destructible to destroy")}catch(PERR){g.reportError(PERR)}this._destroyed=!0,this.clearStore(),this._root.destroy(),this._root=void 0,this._owner=void 0,util.destroy(this)},checkDestroyed:function checkDestroyedFn(){try{g.PAssert(3091,!this._destroyed,"Should not be using a destroyed item store")}catch(PERR){g.reportError(PERR)}},trackGlobally:function trackGloballyFn(){return this._trackGlobally},clearStore:function clearStoreFn(){if(this._isDestructible){g.vmMain.beginUpdateItems();for(var id in this._data)this._root&&id===this._root.id||this._data[id].destroy();g.vmMain.commitUpdateItems()}this._data={},this._root&&(this._root.items.set([]),this._data[this._root.id]=this._root)},createRoot:function createRootFn(id,text){return this.checkDestroyed(),this._root=this.createItem(id,text),this._root},setRoot:function setRootFn(root){this.checkDestroyed();try{g.PAssert(3092,root,"Must specify a valid root item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3093,root.belongsToItemStore(this),"Root item must belong to this item store")}catch(PERR){g.reportError(PERR)}this._root=root},createItem:function createItemFn(id,text,parentID,props,changeType){this.checkDestroyed();try{g.PAssert(3094,!this._data[id],"Should never double-create for the same item, should use update instead")}catch(PERR){g.reportError(PERR)}void 0===changeType&&(changeType=ChangeType.None);var parent;if(parentID){parent=this._data[parentID];try{g.PAssert(3095,parent,"Parent must be valid if defined")}catch(PERR){g.reportError(PERR)}}var itemData={id:id,text:text};if(props)for(var key in props)props.hasOwnProperty(key)&&(itemData[key]=props[key]);var item=new this._constructor(itemData,{store:this,parent:parent,changeType:changeType,canDestroy:this._isDestructible,noSave:this._readonly});return this._data[item.id]=item,item},createItemRaw:function createItemRawFn(p,extraInfo){this.checkDestroyed();try{g.PAssert(3096,!!extraInfo.canDestroy===this._isDestructible,"When creating raw items, canDestroy must match")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3097,!!extraInfo.noSave===this._readonly,"When creating raw items, noSave must match")}catch(PERR){g.reportError(PERR)}extraInfo.store=this;var item=new this._constructor(p,extraInfo);try{g.PAssert(3098,!this._data[item.id],"Should not create an item that already exists in this store")}catch(PERR){g.reportError(PERR)}return this._data[item.id]=item,item},destroyItem:function destroyItemFn(id){try{g.PAssert(3099,this._isDestructible,"ItemStore must be destructible to destroy items")}catch(PERR){g.reportError(PERR)}var item=this._data[id];try{g.PAssert(3100,item,"Must always destroy a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3101,!item.isDestroyed(),"Should never destroy an item twice")}catch(PERR){g.reportError(PERR)}item.parent()&&(item.parent().removeChild(item,ChangeType.Local),item.parent(void 0)),item.destroy(),delete this._data[id]},getItem:function getItemFn(id){return this.checkDestroyed(),this._data[id]},hasItem:function hasItemFn(id){return this.checkDestroyed(),!!this._data[id]},getRoot:function getRootFn(){return this.checkDestroyed(),this._root},isRoot:function isRootFn(item){return this.checkDestroyed(),this._root===item},getCount:function getCountFn(){return this.checkDestroyed(),Object.keys(this._data).length},forEach:function forEachFn(fn){this.checkDestroyed();for(var id in this._data)this._data[id]&&fn(this._data[id])},_markPaneDirty:function _markPaneDirtyFn(pane){pane.usesItemStore(this)&&pane.setItemsDirty()},updateItems:function updateItemsFn(){g.vmMain.paneManager.runForEachPane(this._markPaneDirty),g.vmMain.updateAllItems()},listenToItemStateChanged:function listenToItemStateChangedFn(){Dispatcher.listen("itemStateChanged",this.updateItems)}},util.defineBase(ItemStore),ItemStore}),define("data",["globals","util","Constants","gdata","database","demo","platform","VMContactManager","ItemStore"],function(g,util,C,gdata,database,demo,platform,VMContactManager,ItemStore){function transactionDoneCallback(){}function transactionErrorCallback(obj,e){log("Transaction Error: ",arguments),g.reportError(new Error("IDB Transaction Error"),e)}function removeItemSubtree(id){var item=self.getItem(id);if(item){var children=item.items;if(children)for(var i=0;i<children.length;++i)removeItemSubtree(children[i]);self.dbDeleteItem(item.id)}}function doArchive(item,archivedItem,value,changeType){try{g.PAssert(3143,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3144,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var saveFlags=g.isLocalChange(changeType)?SaveFlag.Prop:SaveFlag.None;item.save({items:item.getItemsArrayForSave()},saveFlags),archivedItem.save({isArchived:value},saveFlags)}function validateLocalModifiedState(item){try{g.PAssert(3163,item&&item.data,"Item must have valid remote data associated with it to be in the tree")}catch(PERR){g.reportError(PERR)}if(item&&item.data){if(!self.pendingRemoteUpdates[item.id]){var versionStructureMatch=item.getVersion(VersionType.Structure)===gdata.getVersion(item.data,VersionType.Structure),versionTextMatch=item.getVersion(VersionType.Text)===gdata.getVersion(item.data,VersionType.Text),changes={};versionStructureMatch||(changes.version=gdata.getVersion(item.data,VersionType.Structure),item.setVersion(VersionType.Structure,gdata.getVersion(item.data,VersionType.Structure))),versionTextMatch||(changes.versionText=gdata.getVersion(item.data,VersionType.Text),item.setVersion(VersionType.Text,gdata.getVersion(item.data,VersionType.Text))),this.modifiedOffline&&(changes.modifiedOffline=!1,item.modifiedOffline=!1),this.modifiedOfflineText&&!gdata.hasDeferredAction(item.id)&&(changes.modifiedOfflineText=!1,item.modifiedOfflineText=!1),g.isEmpty(changes)||(changes.id=item.id,self.dbUpdateItem({id:item.id,changes:changes,saveFlags:SaveFlag.None}))}for(var items=item.getItems(),i=0;i<items.length;++i)validateLocalModifiedState(items[i]);if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;++i)validateLocalModifiedState(archivedItems[i])}}function makePropString(item,field){var value=item[field];return value?',"'+field+'":'+value:""}function safeJSONText(text){return String(text).replace(/[\"\\]/g,function(chr){return charMapJSON[chr]}).replace(/\n/g,"\\n").replace(/\r/g,"\\\\r").replace(/\t/g,"\\\\t")}function makeJSON(item,hasPrev,allowArchived,includeNotes){var str="";hasPrev&&(str+=",");var model=self.getModel(item.id),text=safeJSONText(model.getParsedText()),item=self.getItem(item.id),dateString=makePropString(item,"date"),dateCompletedString=makePropString(item,"dateCompleted"),priorityString=makePropString(item,"priority"),isCompleteString=makePropString(item,"isComplete"),isStarredString=makePropString(item,"isStarred"),isArchivedString=makePropString(item,"isArchived"),isNoteString=makePropString(item,"isNote");if(str+='{"text": "'+text+'"'+dateString+dateCompletedString+priorityString+isCompleteString+isStarredString+isArchivedString+isNoteString,item.note&&includeNotes&&(str+=',"note":'+makeJSON(self.getItem(item.note),!1,allowArchived,includeNotes)),item.items&&item.items.length>0){str+=',"items":[';for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]);(!child.isArchived||child.isArchived&&allowArchived)&&(str+=makeJSON(child,i>0,allowArchived,includeNotes))}str+="]"}return str+="}"}var DB_CONTACTS="ctcs",self={pendingRemoteUpdates:{},itemCache:{},dbDataCache:{},loadedItemCount:0,hasLocalData:!1,freezeUpdates:!1,dbi:void 0,contactManager:new VMContactManager};self.forEachModel=function forEachModelFn(fn){try{g.PAssert(3102,fn,"Must pass a valid function to iterate on")}catch(PERR){g.reportError(PERR)}for(var id in self.itemCache)self.itemCache[id]&&fn(self.itemCache[id])},self.getModel=function getModelFn(id){try{g.PAssert(3103,g.isString(id),"ID must be a valid string: "+g.getObjectInfo(id))}catch(PERR){g.reportError(PERR)}try{g.PAssert(3104,id,"Tried to get a model with an invalid id")}catch(PERR){g.reportError(PERR)}return self.itemCache[id]},self.setModel=function setModelFn(model){try{g.PAssert(3105,model,"Tried to set an invalid model")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3106,model.id,"Tried to set a model with an invalid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3107,g.isString(model.id),"ID must be a valid string: "+g.getObjectInfo(model.id))}catch(PERR){g.reportError(PERR)}try{g.PAssert(3108,void 0===self.itemCache[model.id],"Must not be replacing a model with another copy")}catch(PERR){g.reportError(PERR)}self.itemCache[model.id]=model},self.clearModel=function clearModelFn(id){try{g.PAssert(3109,g.isString(id),"ID must be a valid string: ",g.getObjectInfo(id))}catch(PERR){g.reportError(PERR)}try{g.PAssert(3110,void 0!==self.itemCache[id],"Must not clear a model that does not exist")}catch(PERR){g.reportError(PERR)}self.itemCache[id]=void 0},self.getItem=function getItemFn(id){try{g.PAssert(3111,g.isString(id),"ID must be a valid string:"+g.getObjectInfo(id))}catch(PERR){g.reportError(PERR)}try{g.PAssert(3112,id,"Tried to get an item that doesn't exist")}catch(PERR){g.reportError(PERR)}return self.dbDataCache[id]},self.setItem=function setItemFn(id,data){try{g.PAssert(3113,g.isString(id),"ID must be a valid string: "+g.getObjectInfo(id))}catch(PERR){g.reportError(PERR)}try{g.PAssert(3114,id,"Tried to set an item with an invalid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3115,void 0===self.dbDataCache[id]||void 0===data,"Must not be replacing an item with another copy")}catch(PERR){g.reportError(PERR)}self.dbDataCache[id]=data},self.clearItems=function clearItemsFn(){self.dbDataCache={},self.itemCache={}},self.clearPlugins=function clearPluginsFn(){g.vmMain.pluginManager.onClearData()},self.getRootItem=function getRootItemFn(){return self.rootId?self.getItem(self.rootId):void 0},self.getRootModel=function getRootModelFn(){return self.rootId?self.getModel(self.rootId):void 0},self.createVMLI=function createVMLIFn(p,extraInfo){return g.vmMain.itemStoreManager.getDefaultItemStore().createItemRaw(p,extraInfo)},self.initializeIndexedDB=function initializeIndexedDBFn(handler){function initLocalDB(initSuccess){initSuccess&&database?database.open({server:"duchess",version:version,schema:{items:{key:{keyPath:"id"}},settings:{},caches:{key:{keyPath:"cid"}}}}).done(function(server){self.dbi=server;for(var i=0;i<cachesAvailableCBs.length;++i)cachesAvailableCBs[i](!0);cachesAvailableCBs=[],handler()}).fail(function(e){try{log("Error loading local DB client - "+e.target.error.name+": "+e.target.error.message)}catch(err2){log("Error loading local DB client - Invalid Error Message")}g.preventLocalWrites(),"Firefox"===platform.browser?e.target&&e.target.error&&"InvalidStateError"===e.target.error.name||g.reportError(new Error("DB Load Failure"),e):"Safari"===platform.browser?e.target&&e.target.error&&"DBOpenError"===e.target.error.name||g.reportError(new Error("DB Load Failure"),e):g.reportError(new Error("DB Load Failure"),e),"VersionError"===e.target.error.name&&(util.hasURLParam("versionError")||g.AppCache.runOnFinish(function(){util.insertURLParam("versionError",!0)},!0)),handler()}):(g.preventLocalWrites(),handler())}var version=3;window.indexedDB&&void 0!==window.indexedDB.onIsReady&&null!==window.indexedDB.onIsReady?window.indexedDB.onIsReady(initLocalDB):setTimeout(function(){initLocalDB(!0)},0)};var cachesAvailableCBs=[];self.onCachesAvailable=function onCachesAvailableFn(cb){self.dbi?cb(!0):g.shouldWriteLocal()?cachesAvailableCBs.push(cb):cb(!1)},self.openCacheDatabase=function openCacheDatabaseFn(id,version,schema,cb){var initDB=function(){database.open({server:id,version:version,schema:schema}).done(function(server){cb(server)}).fail(function(e){cb(void 0)})};window.indexedDB&&void 0!==window.indexedDB.onIsReady&&null!==window.indexedDB.onIsReady?initDB():setTimeout(initDB,0)};var openCaches={};self.openCacheTable=function openCacheTableFn(id){return self.dbi?(openCaches[id]=void 0===openCaches[id]?1:openCaches[id]+1,self.dbi.caches):void 0},self.closeCacheTable=function closeCacheTableFn(id){try{g.PAssert(3116,openCaches[id]>0,"Must have previously opened the cache to close it")}catch(PERR){g.reportError(PERR)}openCaches[id]--};var isLocalDataLoaded=!1;self.localDataLoaded=function localDataLoadedFn(){return isLocalDataLoaded},self.loadFromIndexedDB=function loadFromIndexedDBFn(callback){try{g.PAssert(3118,!isLocalDataLoaded,"Should never load local data twice")}catch(PERR){g.reportError(PERR)}if(ShouldLog(LogLevels.Timing)&&log("Loading DB: ",log.now()),self.dbDataCache={},g.shouldWriteLocal()&&self.dbi&&self.dbi.items){var usedWorker=!1,processedResults=!1,processResults=function(results){try{g.PAssert(3119,!processedResults,"Should only process load results once")}catch(PERR){g.reportError(PERR)}processedResults=!0,ShouldLog(LogLevels.Timing)&&log("Loaded DB: ",log.now()),self.loadedItemCount=results.length;for(var i=0;i<results.length;++i){var data=usedWorker?results[i]:g.translateObjOut(results[i]);self.setItem(results[i].id,data)}self.dbi.settings?self.dbi.settings.get("root").done(function(result){if(!g.criticalErrorReported()){if(isLocalDataLoaded=!0,result){try{g.PAssert(3120,self.getItem(result.root),"If there is a root item defined there should be a corresponding local item")}catch(PERR){g.reportError(PERR)}self.rootId=result.root}callback&&callback()}}).fail(callback):(log("Unable to load local settings DB"),callback&&callback())},preload=window.__preload;preload?preload.mainLoaded=!0:preload=window.__preload={mainLoaded:!0};var handleDataLoaded=function(results){clearTimeout(preload.mainTimeout),preload.mainTimeout=void 0,preload.dataResults=void 0,preload.worker&&(preload.worker.terminate(),preload.worker=void 0),results?processResults(results):(usedWorker=!1,preload.onDataLoaded=void 0,self.dbi.items.query().all().fastExecute().done(processResults))};preload.runDataLoad?(usedWorker=!0,preload.dataResults?processResults(preload.dataResults):(preload.onDataLoaded=handleDataLoaded,preload.mainTimeout=setTimeout(function(){g.reportError(new Error("Preload timeout"));try{g.PAssert(3121,!preload.dataResults,"Should not have results defined")}catch(PERR){g.reportError(PERR)}usedWorker=!1,preload.onDataLoaded=void 0,preload.worker&&(preload.worker.terminate(),preload.worker=void 0),self.dbi.items.query().all().fastExecute().done(processResults)},15e3))):self.dbi.items.query().all().fastExecute().done(processResults)}else log("Unable to load local items DB"),isLocalDataLoaded=!0,g.preventLocalWrites(),callback&&callback()};var updateTransaction;self.beginTransaction=function beginTransactionFn(){g.shouldWriteLocal()&&(updateTransaction={})},self.transactionUpdate=function transactionUpdateFn(id,data){try{g.PAssert(3122,g.shouldWriteLocal(),"Should never be writing during a transaction if local writes are disabled")}catch(PERR){g.reportError(PERR)}if(updateTransaction[id])for(var attr in data)updateTransaction[id][attr]=data[attr];else updateTransaction[id]=data},self.endTransaction=function endTransactionFn(){if(g.shouldWriteLocal()&&self.dbi&&self.dbi.items)try{self.dbi.items.updateObject(updateTransaction).done(transactionDoneCallback).fail(transactionErrorCallback)}catch(err){g.reportError(err),transactionErrorCallback()}else void 0!==updateTransaction&&g.reportError(new Error("Started a transaction and stopped writes halfway through"));updateTransaction=void 0},self.hasPendingDBTransaction=function hasPendingDBTransactionFn(){return!!updateTransaction},self.dbUpdateItem=function dbUpdateItemFn(params){function trackUpdates(){if(window.__UPDATES_ACTUAL++,callback){var args=Array.prototype.slice.call(arguments,1);callback(args)}}if(!self.freezeUpdates){self.hasLocalData||g.isLoadingRemote||params.skipLocalModification||(self.hasLocalData=!0);var changes=params.changes||{},id=params.id?params.id:changes.id,callback=params.callback,saveFlags=params.saveFlags;try{g.PAssert(3123,saveFlags===SaveFlag.None||saveFlags===SaveFlag.Prop||saveFlags===SaveFlag.Text||saveFlags===SaveFlag.All)}catch(PERR){g.reportError(PERR)}var item=self.getItem(id);if(g.shouldWriteLocal()){var translated;try{g.PAssert(3124,!saveFlags||void 0===changes.modifiedOffline&&void 0===changes.modifiedOfflineText,"Shouldn't be setting a modified flag while passing them in with changes")}catch(PERR){g.reportError(PERR)}if(g.isFlagSet(saveFlags,SaveFlag.Prop)){try{g.PAssert(3125,void 0===changes.modifiedOffline,"Shouldnt be passing in a value and assigning "+changes.modifiedOffline)}catch(PERR){g.reportError(PERR)}changes.modifiedOffline=!0;var model=self.getModel(id);model&&(model.modifiedOffline=!0)}if(g.isFlagSet(saveFlags,SaveFlag.Text)){try{g.PAssert(3126,void 0===changes.modifiedOfflineText,"Shouldnt be passing in a value and assigning "+changes.modifiedOfflineText)}catch(PERR){g.reportError(PERR)}changes.modifiedOfflineText=!0;var model=self.getModel(id);model&&(model.modifiedOfflineText=!0)}if(item){for(var prop in changes)if(changes.hasOwnProperty(prop)){var verStr;item[prop]=changes[prop]}translated=g.translateObjIn(item)}else{try{g.PAssert(3127,changes.id,"Item being modified does not already exist as expected",changes)}catch(PERR){g.reportError(PERR)}var verStr,verStr;self.setItem(id,changes),translated=g.translateObjIn(changes)}if(updateTransaction){try{g.PAssert(3129,!callback,"Callbacks not supported for updates inside of a transaction")}catch(PERR){g.reportError(PERR)}self.transactionUpdate(id,translated)}else try{callback?self.dbi.items.update(translated).done(callback).fail(callback):self.dbi.items.update(translated)}catch(err){"InvalidStateError"===err.name&&(g.toasts.pushMessage(MessageID.LocalWritesDisabled),g.preventLocalWrites()),g.reportError(err)}}else{if(item)for(var prop in changes)changes.hasOwnProperty(prop)&&(item[prop]=changes[prop]);else self.setItem(id,changes);callback&&callback()}}},self.dbDeleteItem=function dbDeleteItemFn(id,callback){if(!self.freezeUpdates&&(self.setItem(id,void 0),g.shouldWriteLocal()))try{callback?self.dbi.items.remove(id).done(callback).fail(callback):self.dbi.items.remove(id)}catch(err){g.reportError(err)}},self.setRoot=function setRootFn(id){if(!self.freezeUpdates){if(g.shouldWriteLocal())try{self.dbi.settings.update({key:"root",item:{root:id}})}catch(err){g.reportError(err)}return self.rootId=id,self.getRootItem()}},self.setPluginData=function setPluginDataFn(data){var plugins=Object.keys(data);demo.clearGapiData();for(var i=0;i<plugins.length;++i){var pluginID=plugins[i],plugin=g.vmMain.pluginManager.getPlugin(pluginID),pluginData=data[pluginID].data;pluginData&&(demo.setGapiData(pluginID,pluginData),plugin&&plugin.forceLoad())}};var demoId=0,loadedDemoData={};self.demoDataId=void 0,self.loadDemoData=function loadDemoDataFn(testData,forceLoad,handler){function insertIntoDB(root){root.id||(root.id="demo"+demoId++),self.setItem(root.id,root);var note=root.note;note&&(note.id||(note.id="demo"+demoId++),insertIntoDB(note),root.note=note.id);var items=root.items;if(items){for(var itemIDs=[],i=0;i<items.length;++i)items[i].id||(items[i].id="demo"+demoId++),itemIDs.push(items[i].id),insertIntoDB(items[i]);root.items=itemIDs}}function handleDataLoad(demoData){var root,plugins;demoData&&(root=demoData[0],plugins=demoData[1]),plugins&&(forceLoad&&self.clearPlugins(),self.setPluginData(plugins)),root&&(forceLoad&&(g.vmMain.itemStoreManager.runForEachStore(function(itemStore){itemStore.clearStore()}),self.clearItems()),insertIntoDB(root),self.setRoot(root.id),loadedDemoData[testData]={root:root,plugins:plugins},isLocalDataLoaded=!0,handler&&handler(root.id))}if(self.demoDataId=testData,demo.areRemoteFunctionsHooked()||demo.hookRemoteFunctions(),forceLoad||void 0===testData||""===testData||void 0===loadedDemoData[testData]){var num,root,i;demo.loadRemoteData(testData,handleDataLoad)}else{log("Use Preloaded demo data: ",testData);var demoData=loadedDemoData[testData];self.setRoot(demoData.root.id),demoData.plugins&&self.setPluginData(demoData.plugins),handler&&handler(demoData.root.id)}};var initDataCalled=!1;self.initData=function initDataFn(handler){if(initDataCalled)return!1;initDataCalled=!0,ShouldLog(LogLevels.Timing)&&log("Initializing User Item Data",log.now());try{g.isDemoMode()?setTimeout(function(){var testData=util.getURLParam("data");self.loadDemoData(testData,!1,handler)},0):(g.checkpoint(Checkpoint.InitData),self.initializeIndexedDB(function(){self.loadFromIndexedDB(function(){g.checkpoint(Checkpoint.DBLoaded),self.checkLocalIntegrity(function(checkError){self.loadLocalContacts(),checkError&&checkError.error&&g.reportError(new Error("Error during local integrity check")),handler()})})}))}catch(err){g.reportError(err)}return!0},self.initializeItem=function initializeItemFn(item){try{g.PAssert(3130,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var oldId=item.id,isNewItem=!oldId||g.isLocalItem(item)||!item.data;if(isNewItem){var newId=gdata.createNewItem(item,item.hasChildren(),item.hasArchivedChildren());oldId&&oldId!==newId&&self.modifyItemId(oldId,newId);for(var hasNewChildren=!1,num=item.numItems(),i=0;num>i;++i){var initializedChild=self.initializeItem(item.itemAtIndex(i));hasNewChildren=hasNewChildren||initializedChild}if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;++i){var initializedChild=self.initializeItem(archivedItems[i]);hasNewChildren=hasNewChildren||initializedChild}if(item.hasNote()){var initializedChild=self.initializeItem(item.getNote());hasNewChildren=hasNewChildren||initializedChild}if(gdata.initializeNewItem(item),oldId&&oldId!==newId){var parent=item.parent();parent&&parent.save(null,SaveFlag.None)}}return isNewItem},self.checkLocalIntegrity=function checkLocalIntegrityFn(callback){ShouldLog(LogLevels.Timing)&&log("Checking Local: ",log.now());var localDataError=!1,localData=!1;self.ensureLocalCache(function(){ShouldLog(LogLevels.Timing)&&log("Verifying Local Data",log.now());var rootSeen=!1,seen={};for(var id in self.dbDataCache)if(self.dbDataCache.hasOwnProperty(id)&&self.getItem(id)){var item=self.getItem(id);(item.i||item.t)&&(log("%cInvalid local properties on item: ","color: red",item),localDataError=!0),seen[item.id]?seen[item.id].exist?(log(item.id,": Duplicated IDs in the local database",item),localDataError=!0):(seen[item.id].exist=!0,seen[item.id].del=!!item.isDeleted):seen[item.id]={exist:!0,ref:!1,del:!!item.isDeleted},item.id===self.rootId&&(rootSeen&&(log(item.id,": Multiple roots present locally",item),localDataError=!0),rootSeen=!0,seen[item.id].isRoot=!0),void 0===item.text&&(log("Found item with no text",item.id),item.text="",self.dbUpdateItem({id:id,changes:{text:""},saveFlags:SaveFlag.None})),item.note&&(seen[item.note]?seen[item.note].ref?(log(item.id,": Item note is used twice - ",item.note),localDataError=!0):seen[item.note].ref=item.id:seen[item.note]={exist:!1,ref:item.id});for(var j=0;item.items&&j<item.items.length;++j){var seenArchived=-1;if(item.items[j]){var child=item.items[j],childInfo=self.getItem(child);if(childInfo){if(childInfo.isArchived&&(seenArchived=j),seenArchived>=0&&!childInfo.isArchived){log(child,": Unarchived child found after an archived one"),log("   ",item.id,": Parent with incorrectly ordered children"),localDataError=!0;var archivedItem=item.items.removeAt(seenArchived);item.items.insert(j,archivedItem),seenArchived=j,self.dbUpdateItem({id:item.id,changes:{items:item.items},saveFlags:SaveFlag.None})}}else log(child,": Child does not have a valid reference on our local database"),localDataError=!0;if(seen[child])if(seen[child].ref){log(child,": Item is referenced locally multiple times: ",childInfo?self.getItem(child).id:"UNDEFINED"),log("   ",seen[child].ref,": ",self.getItem(seen[child].ref).id),log("   ",item.id,": <CLIENTDATA>"),localDataError=!0;var newItems=item.items;newItems.removeAt(j),self.dbUpdateItem({id:id,changes:{items:newItems},saveFlags:SaveFlag.None})}else seen[child].ref=item.id;else seen[child]={exist:!1,ref:item.id}}else log(item.id,": Invalid item in local items array"),localDataError=!0}}!rootSeen&&self.hasLocalData&&(log("No root present"),localDataError=!0);for(var entryID in seen){var entry=seen[entryID];if(!entry.exist){log(entryID,": Item is referenced locally as a child but does not exist in the database");var item=self.getItem(entry.ref);try{g.PAssert(3131,item,"Parent of item must exist")}catch(PERR){g.reportError(PERR)}if(item){var newItems=item.items;newItems?newItems.remove(entryID):newItems=[],self.dbUpdateItem({id:item.id,changes:{items:newItems},saveFlags:SaveFlag.None})}}if(entry.ref||entry.isRoot||entry.del||(log(entryID,": Item exists locally but is not referenced by a parent"),removeItemSubtree(entryID)),entry.ref&&entry.del){log(entryID,": Item is referenced locally by a parent but has been deleted");var item=self.getItem(entry.ref);try{g.PAssert(3132,item)}catch(PERR){g.reportError(PERR)}var newItems=item.items;newItems?newItems.remove(entryID):newItems=[],self.dbUpdateItem({id:item.id,changes:{items:newItems},saveFlags:SaveFlag.None})}if(entry.isRoot&&entry.ref&&(log(entryID,": Local root has a parent"),localDataError=!0),entry.del&&!entry.ref){var item=self.getItem(entryID);g.isLocalItem(item)&&(log("Deleting Unreferenced Local Item: ",entryID),self.dbDeleteItem(entryID))}}ShouldLog(LogLevels.Timing)&&log("Done Verifying Local Data",log.now()),callback({error:localDataError,local:localData})})},self.removeDeletedItems=function removeDeletedItemsFn(remoteSeen){for(var id in self.dbDataCache){var localItem=self.getItem(id);localItem&&localItem.isDeleted&&(remoteSeen[id]||self.dbDeleteItem(id))}},self.defaultSkipSettings={Default:[Settings.authScopes,Settings.activeUser,Settings.userId,Settings.displayName,Settings.shownTutorial,Settings.helpPaneState,Settings.oauthScheme,Settings.enableOfflineAuth,Settings.premiumStatus,Settings.trialStart,Settings.trialDuration,Settings.theme,Settings.helpState]},self.addDefaultSkipSetting=function addDefaultSkipSettingFn(key,groupID){self.defaultSkipSettings[groupID]||(self.defaultSkipSettings[groupID]=[]),self.defaultSkipSettings[groupID].push(key)},self.clearDataAndReload=function clearDataAndReloadFn(switchingDocs){util.hasURLParam("sinfo")&&util.removeURLParam("sinfo"),self.clearData(function(){setTimeout(g.reload,0)},self.defaultSkipSettings,switchingDocs)},self.clearData=function clearDataFn(cb,skip,switchingDocs){self.freezeUpdates=!0,g.shouldWriteLocal()?setTimeout(function(){function clearLocalStorage(){if(!switchingDocs){self.clearContacts();var skipObj;skipObj=g.isArray(skip)?{Default:skip}:skip,g.settings.resetAll(skipObj),g.vmMain&&g.vmMain.pluginManager&&g.vmMain.pluginManager.onPurgeData()}g.vmMain&&g.vmMain.cacheManager&&(switchingDocs?g.vmMain.cacheManager.clearPerDocCaches(!0):g.vmMain.cacheManager.clearLocalCaches(!0)),setTimeout(function(){cb&&cb()},0)}function clearItems(){if(self.dbi.items)try{self.dbi.items.clear().done(function(){clearCaches()}).fail(function(){log("Failed to reset items!"+arguments),clearCaches()})}catch(err){g.reportError(err),clearCaches()}else clearCaches()}function clearCaches(){if(self.dbi.caches)try{self.dbi.caches.clear().done(function(){clearLocalStorage()}).fail(function(){log("Failed to reset items!"+arguments),clearLocalStorage()})}catch(err){g.reportError(err),clearLocalStorage()}else clearLocalStorage()}if(g.pageDataCleared(),!self.dbi)return void self.initializeIndexedDB(function(){self.clearData(cb,skip)});if(self.dbi.settings)try{self.dbi.settings.clear().done(function(){clearItems()}).fail(function(){log("Failed to reset settings!"+arguments),clearItems()})}catch(err){g.reportError(err),clearItems()
}else clearItems()},0):cb&&setTimeout(cb,0)};var localContactsLoaded=!1;self.clearLocalContacts=function clearLocalContactsFn(){if(localContactsLoaded=!1,g.shouldWriteLocal())try{util.storage.setItem(DB_CONTACTS,"[]")}catch(err){g.reportError(err)}self.contactManager.clearContacts(),g.settings.set(Settings.lastContactSync,void 0)},self.loadLocalContacts=function loadLocalContactsFn(){if(!localContactsLoaded&&(localContactsLoaded=!0,g.shouldWriteLocal()))try{var localContactsStr=util.storage.getItem(DB_CONTACTS),localContacts=localContactsStr?JSON.parse(localContactsStr):void 0;self.contactManager.loadContacts(localContacts,!1)}catch(err){g.reportError(err)}},self.areLocalContactsLoaded=function areLocalContactsLoadedFn(){return localContactsLoaded},self.saveContacts=function saveContactsFn(){g.shouldWriteLocal()&&util.storage.setItem(DB_CONTACTS,JSON.stringify(self.contactManager._contacts.get()))},self.clearContacts=function clearContactsFn(){g.settings.reset(Settings.lastContactSync),g.shouldWriteLocal()&&util.storage.removeItem(DB_CONTACTS,void 0)},self.insertItems=function insertItemsFn(item,items,index){try{g.PAssert(3133,item,"Must pass in a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3134,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3135,void 0===index||index>=0,"Must pass in a valid index")}catch(PERR){g.reportError(PERR)}item.save({items:item.getItemsArrayForSave()},SaveFlag.Prop),1===items.length?gdata.itemAdded({item:item,addedItem:items[0],index:index,isArchived:!1}):gdata.itemsAdded({item:item,addedItems:items,index:index,isArchived:!1})},self.removeItem=function removeItemFn(item,index,removedItem,isArchived,changeType){try{g.PAssert(3136,item,"Must pass in a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3137,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3138,void 0===index||index>=0,"Must pass in a valid index")}catch(PERR){g.reportError(PERR)}var saveFlags=g.isLocalChange(changeType)?SaveFlag.Prop:SaveFlag.None;item.save({items:item.getItemsArrayForSave()},saveFlags),g.isLocalChange(changeType)&&gdata.itemRemoved({item:item,index:index,numToRemove:1,isArchived:isArchived})},self.moveItem=function moveItemFn(params,changeType){var item=params.item,newInfo=params.newInfo,oldParent=params.oldParent,oldInfo=params.oldInfo,noVersion=params.noVersion,saveFlags=g.isLocalChange(changeType)?SaveFlag.Prop:SaveFlag.None;try{g.PAssert(3139,void 0!==item&&void 0!==newInfo&&void 0!==oldParent&&void 0!==oldInfo,"moveItem is missing parameters")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3140,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3141,oldParent.shouldSave(),"Old parent must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3142,item.parent().shouldSave(),"New parent must be marked as saveable")}catch(PERR){g.reportError(PERR)}oldParent.save({items:oldParent.getItemsArrayForSave()},saveFlags),item.parent().save({items:item.parent().getItemsArrayForSave()},saveFlags),oldInfo.isArchived!==newInfo.isArchived&&(item.isArchived(newInfo.isArchived,changeType),item.save({isArchived:newInfo.isArchived},saveFlags)),g.isLocalChange(changeType)&&(self.saveChanges(item,{},saveFlags),gdata.itemMoved({item:item,newInfo:newInfo,oldParent:oldParent,oldInfo:oldInfo,noVersion:noVersion}))},self.archiveItem=function archiveItemFn(item,index,archivedItem,changeType){try{g.PAssert(3145,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3146,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3147,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}doArchive(item,archivedItem,!0,changeType),g.isLocalChange(changeType)&&gdata.itemArchived(item,archivedItem,index)},self.unarchiveItem=function unarchiveItemFn(item,index,unarchivedItem,changeType){try{g.PAssert(3148,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3149,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3150,index>=0,"Must have a valid index to remove from")}catch(PERR){g.reportError(PERR)}doArchive(item,unarchivedItem,!1,changeType),g.isLocalChange(changeType)&&gdata.itemUnarchived(item,unarchivedItem,index,item.numItems()-1)},self.modifyItemId=function modifyItemIdFn(id,newId,callback){var item=self.getItem(id),model=self.getModel(id);try{g.PAssert(3151,model.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}if(item.id=newId,model.id=newId,self.pendingRemoteUpdates[id]&&(self.pendingRemoteUpdates[id]=void 0,self.pendingRemoteUpdates[newId]=!0),item.version=-1,item.versionText=-1,"root"===id)for(var i=item.items.length-1;i>=0;i--){var rootChild=self.getItem(item.items[i]);if(g.isLocalItem(rootChild)&&!rootChild.modifiedOffline&&!rootChild.modifiedOfflineText){item.items.removeAt(i);try{g.PAssert(3152,model.itemAtIndex(i).id===rootChild.id,"Item arrays should match")}catch(PERR){g.reportError(PERR)}model.getItems().removeAt(i)}}self.itemCache[newId]=self.itemCache[id],self.dbDataCache[newId]=item,self.dbDeleteItem(id),self.dbUpdateItem({changes:item,callback:callback,skipLocalModification:!0,saveFlags:SaveFlag.None}),self.dbDataCache[id]=void 0,delete self.dbDataCache[id],self.itemCache[id]=void 0,delete self.itemCache[id]},self.deleteItem=function deleteItemFn(item,changeType){try{g.PAssert(3153,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3154,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3155,!item.isDeleted(),"Should never try to delete an item that has already been deleted")}catch(PERR){g.reportError(PERR)}var localItem=self.getItem(item.id);if(localItem)item.isDeleted(!0,changeType),self.dbUpdateItem({id:item.id,changes:{isDeleted:!0},saveFlags:SaveFlag.Prop});else try{g.PAssert(3156,"Expected local item, didnt find one",item.id)}catch(PERR){g.reportError(PERR)}},self.undeleteItem=function undeleteItemFn(item,changeType){var localItem=self.getItem(item.id);if(localItem)item.isDeleted(!1,changeType),self.dbUpdateItem({id:item.id,changes:{isDeleted:void 0},saveFlags:SaveFlag.Prop});else try{g.PAssert(3157,"Expected local item, didnt find one",item.id)}catch(PERR){g.reportError(PERR)}},self.saveChanges=function saveChangesFn(item,changes,saveFlags){if(item){try{g.PAssert(3159,item.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}changes||(changes={}),self.dbUpdateItem({id:item.id,changes:changes,saveFlags:saveFlags})}else{log("Incoming item to save has no item!",item,changes);try{g.PAssert(3158,!1,"Incoming item to save has no item!")}catch(PERR){g.reportError(PERR)}}},self.addPendingUpdate=function addPendingUpdateFn(id){try{g.PAssert(3160,id,"Invalid ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3161,g.isString(id),"Must provide a valid id string")}catch(PERR){g.reportError(PERR)}self.pendingRemoteUpdates[id]||(self.pendingRemoteUpdates[id]=!0)},self.clearPendingUpdate=function clearPendingUpdateFn(id){delete self.pendingRemoteUpdates[id]},self.clearPendingUpdates=function clearPendingUpdatesFn(){for(var itemID in self.pendingRemoteUpdates){try{g.PAssert(3162,self.pendingRemoteUpdates.hasOwnProperty(itemID))}catch(PERR){g.reportError(PERR)}var item=self.getModel(itemID),itemData=self.getItem(itemID);if(itemData&&itemData.isDeleted)self.dbDeleteItem(itemID);else if(item&&item.data){var changes={id:itemID,modifiedOffline:!1};item.modifiedOffline=!1,gdata.hasDeferredAction(item.id)||(item.modifiedOfflineText=!1,changes.modifiedOfflineText=!1);var newVersion=gdata.getVersion(item.data,VersionType.Structure),newTextVersion=gdata.getVersion(item.data,VersionType.Text);newVersion!=item.getVersion(VersionType.Structure)&&(changes.version=newVersion,item.setVersion(VersionType.Structure,newVersion)),newTextVersion!=item.getVersion(VersionType.Text)&&(changes.versionText=newTextVersion,item.setVersion(VersionType.Text,newTextVersion)),self.dbUpdateItem({id:itemID,changes:changes,saveFlags:SaveFlag.None})}}self.pendingRemoteUpdates={},setTimeout(function(){validateLocalModifiedState(this.getRootModel())}.bind(this),0)};var charMapJSON={'"':'\\"',"\\":"\\\\"};return self.toDropHtml=function toDropHtmlFn(model){var str="";if(!model.isArchived()&&(str+="<li>"+g.escape(model.getParsedText())+"</li>",model.hasChildren())){str+="<ul>";for(var i=0;i<model.numChildren();++i)str+=self.toDropHtml(model.getChild(i));str+="</ul>"}return str},self.toHtml=function toHtmlFn(item,allowArchived,includeNotes){var str="<ul>";if(item.items)for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]),model=self.getModel(child.id),text=g.escape(model.getParsedText());if(!child.isArchived||child.isArchived&&allowArchived){if(str+="<li>"+text,child.note&&includeNotes){str+="<li>";var noteModel=self.getModel(child.note);str+=g.escape(noteModel.getParsedText()),str+="</li>"}child.items&&child.items.length>0&&(str+=self.toHtml(child,allowArchived,includeNotes)),str+="</li>"}}return str+="</ul>"},self.toPlainText=function toPlainTextFn(item,indent,allowArchived,includeNotes){isNaN(indent)&&(indent=0);var str="";if(item.items)for(var i=0;i<item.items.length;i++){var child=self.getItem(item.items[i]),model=self.getModel(child.id);if(!child.isArchived||child.isArchived&&allowArchived){for(var u=0;indent>u;u++)str+="	";if(str+=model.getParsedText()+"\n",child.note&&includeNotes){var childNote=self.getModel(child.note);str+=childNote.getParsedText()+"\n"}child.items&&child.items.length>0&&(str+=self.toPlainText(child,indent+1,allowArchived,includeNotes))}}return str},self.toJSON=function toJSONFn(item,hasPrev,allowArchived,includeNotes){var rootItem=makeJSON(item,hasPrev,allowArchived,includeNotes);return'{"moodoVer":'+(g.settings.get(Settings.localDataVersion)||gdata.currentVersion())+',"moodoRoot":'+rootItem+"}"},self.createRootItem=function createRootItemFn(id){self.setRoot(id),self.dbUpdateItem({changes:{id:id,text:C.RootItemName,items:[]},skipLocalModification:!0,saveFlags:SaveFlag.None,callback:function callbackFn(){}})},self.ensureLocalCache=function ensureLocalCacheFn(callback){var root=self.getRootItem();root?(self.loadedItemCount>1&&(self.hasLocalData=!0),callback()):callback()},self.printIndexedDB=function printIndexedDBFn(){var args,i,printAll},self}),define("AccountManager",["require","exports","module","globals","Constants","Trigger","goog","goog","goog","goog","goog","goog"],function(require,exports,module){function AccountManager(){this._isConnected=!1,this._linkedAccounts={},this.onAccountsUpdated=new Trigger,this._authCBList={},this._iteratingAuthList=!1,g.isDemoMode()&&setTimeout(function(){var demoScopes=[GScope.UserInfoEmail,GScope.Calendar,GScope.GmailCompose,GScope.GmailModify];this.addLinkedAccount("me","Moo.do User","InvalidGID",demoScopes,{expires_in:3600,expires_at:(Date.now()+g.minutes(60))/1e3,access_token:"InvalidToken",scope:demoScopes})}.bind(this))}var g=require("globals"),C=require("Constants"),Trigger=require("Trigger"),ErrorTimeout=g.seconds(15),UnauthorizedTimeout=g.seconds(2);return AccountManager.prototype={getInfo:function getInfoFn(){var info={};for(var id in this._linkedAccounts){var acc=this._linkedAccounts[id];if(acc){var token=void 0;this.isTokenValid(acc.token)&&(token={scope:acc.token.scope,hasIDToken:!!acc.token.id_token}),info[id]={scopes:acc.scopes,gid:acc.gid,error:acc.serverError,validToken:this.isTokenValid(acc.token),token:token}}else info[id]="UNDEFINED ACCOUNT"}return info},getDefaultAccessToken:function getDefaultAccessTokenFn(){var token=this.getAccountTokenSync("me");try{g.PAssert(3176,token,"Must verify that a valid token is available before requesting")}catch(PERR){g.reportError(PERR)}return token?token.access_token:void 0},getDefaultIDToken:function getDefaultIDTokenFn(){var token=this.getAccountTokenSync("me");try{g.PAssert(3177,token,"Must verify that a valid token is available before requesting")}catch(PERR){g.reportError(PERR)}return token?token.id_token:void 0},isDefaultEmail:function isDefaultEmailFn(email){return"me"===email||email===require("goog").getCurrentUserEmail()||email===g.settings.get(Settings.activeUser)},_generateState:function _generateStateFn(){return"Dchs"+(new Date).getTime()},_getRedirectURL:function _getRedirectURLFn(){return window.location.protocol+"//"+window.location.host+"/oauthRelay.html"},_createAuthURL:function _createAuthURLFn(email,scopes,state){var baseURL="https://accounts.google.com/o/oauth2/v2/auth?";try{g.PAssert(3178,g.isArray(scopes)&&scopes.length>0,"Must pass in a valid scopes array")}catch(PERR){g.reportError(PERR)}var params={scope:scopes.join(" ")+" profile",state:state,login_hint:email,redirect_uri:this._getRedirectURL(),response_type:"code",access_type:"offline",include_granted_scopes:!0,prompt:"consent",client_id:require("goog").CLIENT_ID},paramArr=[];for(var param in params)paramArr.push(param+"="+encodeURIComponent(params[param]));return baseURL+paramArr.join("&")},linkAccount:function linkAccountFn(email,scopes,cb){try{g.PAssert(3179,email,"Must provide a valid email to link")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3180,g.isArray(scopes),"Must always provide a valid scopes array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3181,scopes.indexOf(GScope.UserInfoEmail)>=0,"Must request profile scope")}catch(PERR){g.reportError(PERR)}var state=this._generateState(),authURL=this._createAuthURL(email,scopes,state);window.open(authURL,"googleauth","height=600,width=550");var handleRelayMessage=function(e){var validOrigin=g.getLocationOrigin(),validState=!1;try{validState=e.data.state===state}catch(err){g.reportError(err)}return validOrigin&&validState?(window.removeEventListener("message",handleRelayMessage),e.data.code?(log("OAuth Code Received: ",e.data.code),this._handleGoogleAuthorized(email,e.data,state,cb)):cb()):void 0}.bind(this);window.addEventListener("message",handleRelayMessage)},unlinkAccount:function unlinkAccountFn(email,gid,cb){if(!gid)return cb(!0);var requestData={email:email,gidLinked:gid};g.XHR_PrivateAPI({type:"POST",path:"/user/unlinkAccount",data:requestData,requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){return cb(xhr.status===C.HTTPStatusCode.Success?!0:!1)}.bind(this)})},_handleGoogleAuthorized:function _handleGoogleAuthorizedFn(email,data,state,cb){var requestData={email:email,state:state,code:data.code,redir:this._getRedirectURL()};g.XHR_PrivateAPI({type:"POST",path:"/user/linkAccount",data:requestData,requireAuth:!0,autoRetry:!0,maxRetries:1,cb:function cbFn(xhr){if(xhr.status!==C.HTTPStatusCode.Success||!xhr.response)return cb();try{var linkData=JSON.parse(xhr.response).data;try{g.PAssert(3182,linkData.gidLinked,"Must receive a valid GID back from the server")}catch(PERR){g.reportError(PERR)}var token=linkData.access_token;return this.addLinkedAccount(email,linkData.gidLinked,linkData.name,token.scope,token),cb(token)}catch(err){return g.reportError(err),cb()}}.bind(this)})},removeLinkedAccount:function removeLinkedAccountFn(email,cb){var oldData=this._linkedAccounts[email];try{g.PAssert(3183,oldData,"Must always have linked account data when removing")}catch(PERR){g.reportError(PERR)}return oldData?void this.unlinkAccount(email,oldData.gid,function(success){return delete this._linkedAccounts[email],this.onAccountsUpdated.notify(),cb(success)}.bind(this)):cb(!0)},addLinkedAccount:function addLinkedAccountFn(email,gid,name,scopes,token){try{g.PAssert(3185,void 0===scopes||scopes.indexOf(GScope.UserInfoEmail)>=0,"Must request profile scope")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3186,!this._linkedAccounts[email]||void 0===this._linkedAccounts[email].gid||this._linkedAccounts[email].gid===gid,"Google ID should never change")}catch(PERR){g.reportError(PERR)}var oldData=this._linkedAccounts[email];oldData&&(clearTimeout(oldData.refreshTimeout),oldData.refreshTimeout=void 0);var data={lastRefreshRequested:oldData?oldData.lastRefreshRequested:0,scopes:scopes||[],gid:gid,name:name};this._linkedAccounts[email]=data,token&&this.updateAccountToken(email,token),this.onAccountsUpdated.notify()},updateAccountToken:function updateAccountTokenFn(email,token){try{g.PAssert(3187,token,"Must provide a token when updating")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3188,this.isTokenValid(token),"Token must be valid to be updated")}catch(PERR){g.reportError(PERR)}var account=this._linkedAccounts[email];if(account){account.serverError=!1,account.token=token;var expiresMS=1e3*(g.parseInt(token.expires_in)-600);g.isDemoMode()||this._createTokenRefresh(email,account,expiresMS),this.notifyUserAuthorized(email,token.scope)}},_clearAccountToken:function _clearAccountTokenFn(email){var accountInfo=this._linkedAccounts[email];accountInfo&&(accountInfo.token=void 0,clearTimeout(accountInfo.refreshTimeout),accountInfo.refreshTimeout=void 0,this.onAccountsUpdated.notify())},updateServerLinkedAccount:function updateServerLinkedAccountFn(email,gid,name,scopes,token){this.addLinkedAccount(email,gid,name,scopes,token),token||(this._linkedAccounts[email].serverError=!0)},_getLinkedAccount:function _getLinkedAccountFn(email){return this._linkedAccounts[email]},getLinkedAccounts:function getLinkedAccountsFn(){var accounts=[];for(var email in this._linkedAccounts)accounts.push(email);return accounts},getAccountGID:function getAccountGIDFn(email){var gid;if(this.isDefaultEmail(email))gid=require("goog").getCurrentUserID()||g.settings.get(Settings.userId);else if(this._linkedAccounts[email])gid=this._linkedAccounts[email].gid;else try{g.PAssert(3189,!1,"Unknown account email requested: ",email)}catch(PERR){g.reportError(PERR)}return gid},getAccountEmail:function getAccountEmailFn(gid){var accountEmail;for(var email in this._linkedAccounts)if(this._linkedAccounts[email].gid===gid){accountEmail=email;break}return accountEmail||gid!==require("goog").getCurrentUserID()||(accountEmail="me"),accountEmail},getAccountName:function getAccountNameFn(email){var name;if(this.isDefaultEmail(email))name=g.vmMain.getUserName();else if(this._linkedAccounts[email]){var account=this._linkedAccounts[email];name=account.name?account.name:g.vmMain.getUserName()}else try{g.PAssert(3190,!1,"Unknown account name requested: ",email)}catch(PERR){g.reportError(PERR)}return name},isAccountValidLinked:function isAccountValidLinkedFn(email){var isValidLinked=!1;return this._linkedAccounts[email]&&(isValidLinked=!!this._linkedAccounts[email].token),isValidLinked},isLinkedAccountAuthorized:function isLinkedAccountAuthorizedFn(email,scope){var isAuthorized=!1,accountInfo=this._getLinkedAccount(email);return accountInfo&&accountInfo.token&&(!scope||accountInfo.scopes.indexOf(scope)>=0)&&(isAuthorized=!0),isAuthorized},isAuthorized:function isAuthorizedFn(email,scope){try{g.PAssert(3191,scope,"Must provide a valid scope to check authorization for")}catch(PERR){g.reportError(PERR)}var isAuthorized=!1;if(this._linkedAccounts[email]||this.isDefaultEmail(email)){var scopes=this.getAuthorizedScopes(email);scopes&&scopes.indexOf(scope)>=0&&(isAuthorized=!0)}else{var storedUser=g.settings.get(Settings.activeUser),storedScopes=require("goog").getAuthorizedScopes();email===storedUser&&(!scope||storedScopes.indexOf(scope)>=0)&&(isAuthorized=!0)}return isAuthorized},isCurrentlyAuthorized:function isCurrentlyAuthorizedFn(email){try{g.PAssert(3192,email,"Must provide a valid email")}catch(PERR){g.reportError(PERR)}var isAuthorized=!1;return g.isDemoMode()?isAuthorized=!0:this.hasValidAccessToken(email)&&(isAuthorized=!0),isAuthorized},_refreshToken:function _refreshTokenFn(email){var account=this._getLinkedAccount(email);try{g.PAssert(3193,account,"Must have properly linked account before requesting a token")}catch(PERR){g.reportError(PERR)}clearTimeout(account.refreshTimeout),account.refreshTimeout=void 0,this._getAccountToken(email,!0,function(token){if(token&&!token.error)this.updateAccountToken(email,token);else if(this._clearAccountToken(email),!account.serverError){try{g.PAssert(3194,!account.refreshTimeout,"Should not have a refresh timeout after failure")}catch(PERR){g.reportError(PERR)}this._createTokenRefresh(email,account,ErrorTimeout),account.serverError=!0}}.bind(this))},_createTokenRefresh:function _createTokenRefreshFn(email,account,timeoutMS){try{g.PAssert(3195,!account.refreshTimeout,"Should never reschedule an account token refresh")}catch(PERR){g.reportError(PERR)}account.refreshTimeout||(account.refreshTimeout=setTimeout(this._refreshToken.bind(this,email),timeoutMS),account.lastRefreshRequested=Date.now())},notifyUnauthorizedRequest:function notifyUnauthorizedRequestFn(email){if(!this.isDefaultEmail(email)&&this._linkedAccounts[email]){var account=this._getLinkedAccount(email);try{g.PAssert(3196,account,"Must have properly linked account before requesting a token")}catch(PERR){g.reportError(PERR)}if(account&&!account.refreshTimeout){var timeSinceRefresh=Date.now()-account.lastRefreshRequested;timeSinceRefresh>g.seconds(90)&&this._createTokenRefresh(email,account,UnauthorizedTimeout)}}},notifyUnauthorizedAccount:function notifyUnauthorizedAccountFn(email,scopes,optMessage){log("Unauthorized Request: ",email,scopes,optMessage),g.reportError(new Error("Unauthorized Request: "+email+" ["+scopes+"] "+optMessage)),this._invalidateAccountToken(email,function(success,refreshed){log(success?refreshed?"Account Token Refreshed for Invalidation":"Account Token Invalidated":"Account Token Failed Invalidation")})},getAccountToken:function getAccountTokenFn(email,cb){return this._getAccountToken(email,!1,cb)},_invalidateAccountToken:function _invalidateAccountTokenFn(email,cb,isRetry){var gid=this.getAccountGID(email);if(gid&&this._getLinkedAccount(email)){var requestData={gid:gid};this._clearAccountToken(email),this.onUserAuthorized("me",function(){g.XHR_PrivateAPI({type:"POST",path:"/user/invalidateAccountToken",data:requestData,requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){if(xhr.status===C.HTTPStatusCode.Success&&xhr.response)try{var tokenData=JSON.parse(xhr.response);if(tokenData.success&&tokenData.data){var token=tokenData.data;token&&!token.error?(this.updateAccountToken(email,token),cb(!0,!0)):cb(!0,!1)}else cb(!0,!1)}catch(err){g.reportError(err),cb(!0,!1)}else cb(!1,!1)}.bind(this)})}.bind(this))}else isRetry?cb(!1,!1):g.billingManager.onBillingIdentifierAvailable(function(){this._invalidateAccountToken(email,cb,!0)}.bind(this))},_getAccountToken:function _getAccountTokenFn(email,forceRefresh,cb){var account=this._getLinkedAccount(email);try{g.PAssert(3197,account,"Must have properly linked account before requesting a token")}catch(PERR){g.reportError(PERR)}if(account)if(!forceRefresh&&this.isTokenValid(account.token))setTimeout(cb,0,account.token);else{var state=this._generateState(),requestData={gid:account.gid,state:state};try{g.PAssert(3198,account.gid,"Must have a valid GID for account")}catch(PERR){g.reportError(PERR)}this.onUserAuthorized("me",function(){g.XHR_PrivateAPI({type:"POST",path:"/user/getAccountToken",data:requestData,requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){if(xhr.status===C.HTTPStatusCode.Success&&xhr.response)try{var tokenData=JSON.parse(xhr.response);tokenData.success?cb(tokenData.data):(this._clearAccountToken(email),cb())}catch(err){g.reportError(err),cb()}else this._clearAccountToken(email),cb()}.bind(this)})}.bind(this))}else cb()},_getAccountTokenRaw:function _getAccountTokenRawFn(email){var token;if(email&&!this.isDefaultEmail(email)){var account=this._getLinkedAccount(email);account&&(token=account.token)}else window.gapi&&window.gapi.auth&&(token=gapi.auth.getToken());return token},getAccountTokenSync:function getAccountTokenSyncFn(email){try{g.PAssert(3199,email,"Must provide a valid email to retreive the token for")}catch(PERR){g.reportError(PERR)}if(this.isDefaultEmail(email)){var token=this._getAccountTokenRaw(email);try{g.PAssert(3200,this.isTokenValid(token),"Must ensure token is valid before requesting sync")}catch(PERR){g.reportError(PERR)}return token}var account=this._getLinkedAccount(email);try{g.PAssert(3201,account,"Must have properly linked account before getting a token")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3202,this.isTokenValid(account.token),"Must ensure token is valid before requesting sync")}catch(PERR){g.reportError(PERR)}return account.token},getAccessTokenSync:function getAccessTokenSyncFn(email){var token=this.getAccountTokenSync(email);return token?token.access_token:void 0},getAuthorizedScopes:function getAuthorizedScopesFn(email){var scopes;if(this.isDefaultEmail(email))try{if(window.gapi&&window.gapi.auth){var token=window.gapi.auth.getToken();if(token){scopes=token.scope;try{g.PAssert(3203,g.isArray(scopes),"Must always be a valid scopes array on auth token")}catch(PERR){g.reportError(PERR)}}else g.settings.get(Settings.activeUser)===email&&(scopes=require("goog").getAuthorizedScopes().slice(0))}else scopes=[]}catch(err){g.reportError(err),scopes=[]}else if(this._linkedAccounts[email])scopes=this._linkedAccounts[email].scopes;else{try{g.PAssert(3204,!1,"Unknown account email requested: ",email)}catch(PERR){g.reportError(PERR)}scopes=[]}return scopes},setConnected:function setConnectedFn(){this._isConnected=!0},isConnected:function isConnectedFn(){return this._isConnected},notifyUserAuthorized:function notifyUserAuthorizedFn(email,scopes){try{g.PAssert(3205,g.isString(email),"Must provide a valid email addr for authorization")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3206,g.isArray(scopes),"Must provide a valid scopes array")}catch(PERR){g.reportError(PERR)}this._iteratingAuthList=!0;for(var cbList=this._authCBList[email],i=0;cbList&&i<cbList.length;++i)try{cbList[i]()}catch(err){g.reportError(err)}this._authCBList[email]=[],this._iteratingAuthList=!1;try{g.PAssert(3207,g.isDemoMode()||g.vmMain&&g.vmMain.pluginManager,"Must have initialized plugin manager before users are authorized")}catch(PERR){g.reportError(PERR)}g.vmMain&&g.vmMain.pluginManager&&(g.vmMain.pluginManager.notifyAuthorizationAdded(email),this.isDefaultEmail(email)&&g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GoogleLogin,scopes))},onUserAuthorized:function onUserAuthorizedFn(email,cb){try{g.PAssert(3208,!this._iteratingAuthList,"Should not queue additional authorizations while iterating")}catch(PERR){g.reportError(PERR)}this.isCurrentlyAuthorized(email)?cb():(this._authCBList[email]||(this._authCBList[email]=[]),this._authCBList[email].push(cb))},isTokenValid:function isTokenValidFn(token){try{g.PAssert(3209,!token||!g.isString(token),"Must supply a valid token object to check if valid")}catch(PERR){g.reportError(PERR)}var isValid=!1;if(token&&token.expires_at){var expireTime=1e3*g.parseInt(token.expires_at),checkTime=Date.now()+g.minutes(5);try{var expireDate=new Date(expireTime),sanityDate=(new Date).addHours(2);try{g.PAssert(3210,expireDate.isBefore(sanityDate),"Token lease must be under three hours: ",token.expires_at)}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}expireTime>checkTime&&(isValid=!0)}return isValid},hasValidAccessToken:function hasValidAccessTokenFn(email){var isValid=!1,token=this._getAccountTokenRaw(email);return token&&this.isTokenValid(token)&&(isValid=!0),isValid}},new AccountManager}),define("goog",["ko","data","globals","util","Constants","gdata","platform","RingBuffer","Dispatcher","AccountManager"],function(ko,d,g,util,C,gdata,platform,RingBuffer,Dispatcher,AccountManager){function showErrorMessage(errorResult){if(errorResult){var err=errorResult.error;err.code===C.HTTPStatusCode.Forbidden&&g.toasts.pushMessage({text:"Google Drive Error: "+err.message+".",action:MessageAction.OpenURL,actionText:"LEARN MORE",data:{url:"https://support.google.com/drive/answer/2500820"}})}else g.toasts.pushMessage({text:"There was an internal error in Google Drive. Please reload to try again.",action:MessageAction.Reload});g.vmMain.setGDriveStatus(DriveStatus.Offline)}function openDefaultRealtimeFile(callback){g.vmMain.setGDriveStatus(DriveStatus.Connecting),g.loadGoogleAPI("drive","v2",function(){if(!gapi.client.drive)return void showErrorMessage();var options={getAllPages:!0,maxResults:1},queryString="(title='"+self.LEGACY_DefaultDriveDocTitle+"' or properties has {key='"+self.DefaultProperty+"' and value='"+self.DefaultPropertyValue+"' and visibility='PRIVATE'}) and 'me' in owners and trashed=false",successCB=function(result){0===result.length?createDefaultRealtimeFile(callback):callback(result[0],!1)},failureCB=function(result){showErrorMessage(result)};g.vmMain.remoteAPI().driveFilesList(queryString,successCB,failureCB,options)})}function createDefaultFileStructure(cb){try{g.PAssert(3223,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3224,void 0===rootFolderID,"Must not already have a root folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3225,cb,"Must supply a valid callback when done creating the default file structure")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","drive","files","insert"],requestData={resource:{mimeType:self.FOLDER_MIMETYPE,title:self.DefaultFolderTitle,writersCanShare:!1,folderColorRgb:"#FF7537",properties:[{key:self.DefaultRootFolderProperty,value:self.DefaultRootFolderPropertyValue,visibility:"PRIVATE"}]}},successCB=function(result){return cb(result.id)},failureCB=function(result){return cb()};g.vmMain.remoteAPI().runRemoteSingleRequest(requestFn,requestData,successCB,failureCB)}function createAttachFileStructure(cb){try{g.PAssert(3226,!g.isDemoMode(),"Should not be creating attach folder in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3227,rootFolderID,"Must have already created and found the root folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3228,void 0===attachFolderID,"Must not already have an attach folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3229,cb,"Must supply a valid callback when done creating the attachment file structure")}catch(PERR){g.reportError(PERR)}var requestFn=gapi.client.drive.files.insert,requestData={resource:{mimeType:self.FOLDER_MIMETYPE,title:self.DefaultAttachTitle,writersCanShare:!1,folderColorRgb:"#FF7537",parents:[{id:rootFolderID}],properties:[{key:self.DefaultAttachFolderProperty,value:self.DefaultAttachFolderPropertyValue,visibility:"PRIVATE"}]}},successCB=function(result){return cb(result.id)},failureCB=function(result){return cb()};g.vmMain.remoteAPI().runRemoteSingleRequest(requestFn,requestData,successCB,failureCB)}function createDefaultRealtimeFile(callback){var defaultDoc=g.vmMain.docManager.createNewDoc();self.createAndSetupDocument(defaultDoc,!0,function(docInfo){if(!docInfo||docInfo.error)showErrorMessage();else{g.vmMain.docManager.setDoc(defaultDoc);var loadFileID=util.getURLParam("file");if(loadFileID)try{try{g.PAssert(3233,gapi.drive,"gapi.drive should exist")}catch(PERR){g.reportError(PERR)}util.removeURLParam("file");var openingDoc=g.vmMain.docManager.loadDocFromData({id:loadFileID},!1);openingDoc.open(),self.setDocInfo(loadFileID,void 0),gdata.driveRealtimeLoad(loadFileID,onDocLoaded,onDocInitialized,onDocLoadError);try{window.__LOAD_REQUESTS.push(g.getCurrentStack("File Request After Default Load"))}catch(err){g.reportError(err)}}catch(err){g.reportError(err)}else callback(docInfo,!0)}})}function onFirstDocInitialized(doc){log("First Run Drive Document"),onDocInitialized(doc),gdata.onFirstInitialized(doc),self.onHaveUserSignupData(function(){g.sendEvent("Subscribe","NewUser"),g.reportSignup(self.getCurrentUserEmail(),self.getCurrentUserSignupInfo())})}function onDocInitialized(doc){log("Drive Document Initialized"),gdata.onInitialized(doc),self.onHaveUserSignupData(function(){g.sendEvent("Documents","CreateNew")})}function onDocLoaded(doc){ShouldLog(LogLevels.Timing)&&log("Drive document load started: ",log.now()),g.checkpoint(Checkpoint.DocLoaded),g.vmMain.setGDriveStatus(DriveStatus.Saved);
var success=gdata.onLoad(doc);if(success){ShouldLog(LogLevels.Timing)&&log("Drive document load done: ",log.now()),self.startWatchdog();var folderID=doc.getModel().getRoot().get("docFolderID");if(!folderID){var openDoc=g.vmMain.docManager.getOpenDoc();try{g.PAssert(3241,openDoc,"Must have an open doc to load a realtime doc")}catch(PERR){g.reportError(PERR)}openDoc.getDocumentFolder(function(newFolderID){doc.getModel().getRoot().set("docFolderID",newFolderID)})}var attachFolderID=doc.getModel().getRoot().get("attachFolderID");attachFolderID||self.getAttachFolder(function(newFolderID){doc.getModel().getRoot().set("attachFolderID",newFolderID)}),doc.getModel().bytesUsed>=MAX_REALTIME_MODEL_SIZE*DocSizeWarnPercent?g.menus.alert({text:"Your document is nearing our maximum size. Consider starting a new document.",actionText:"OKAY"}):doc.getModel().bytesUsed>=MAX_REALTIME_MODEL_SIZE*DocSizeErrorPercent&&g.menus.alert({text:"Your document has reached our maximum allowed size. You must create a new document to continue editing.",actionText:"OKAY"}),self.isLoaded=!0,g.vmMain.notifySuccessfulLoad(),g.fireCustomEvent("docLoaded")}}function onDocLoadError(e){switch(ShouldLog(LogLevels.Error)&&log("Doc Load Error - ",JSON.stringify(e)),e.type){case gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED:try{g.PAssert(3242,!e.isFatal,"Token refresh required causes a non-fatal error")}catch(PERR){g.reportError(PERR)}self.recoverFromError();break;case gapi.drive.realtime.ErrorType.INVALID_COMPOUND_OPERATION:try{g.PAssert(3243,e.isFatal,"Invalid compound operation causes a fatal error")}catch(PERR){g.reportError(PERR)}ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+e.type+"] Fatal: "+e.isFatal),g.reportError(new Error("Invalid Compound Operation: "+g.safeStringify(e)));break;case gapi.drive.realtime.ErrorType.CONCURRENT_CREATION:case gapi.drive.realtime.ErrorType.CLIENT_ERROR:ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+e.type+"] Fatal: "+e.isFatal),g.reportError(new Error("Client Error: "+g.safeStringify(e))),self.clearDocInfo(),findAndLoadDoc();break;case gapi.drive.realtime.ErrorType.FORBIDDEN:case gapi.drive.realtime.ErrorType.NOT_FOUND:ShouldLog(LogLevels.Error)&&log("Unable to access or find the requested document"),g.reportError(new Error("DocError Forbidden/NotFound: "+g.safeStringify(e)));var shareInfo=g.decodeURLObject(util.getURLParam("sinfo"));e.type===gapi.drive.realtime.ErrorType.FORBIDDEN?g.menus.alert(shareInfo&&shareInfo.fromUser?{text:"Moo.do has lost access to your document. Please contact "+shareInfo.fromUser+" to ensure you have the correct permissions.",actionText:"RELOAD",callback:d.clearDataAndReload}:{text:"Moo.do has lost access to your document. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",callback:d.clearDataAndReload}):e.type===gapi.drive.realtime.ErrorType.NOT_FOUND&&g.menus.alert(shareInfo&&shareInfo.fromUser?{text:"Moo.do cannot find your document. Please contact "+shareInfo.fromUser+" to ensure the document still exists.",actionText:"RELOAD",callback:d.clearDataAndReload}:{text:"Moo.do cannot find your document. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",callback:d.clearDataAndReload}),g.vmMain.notifyFailedLoad();break;case gapi.drive.realtime.ErrorType.SERVER_ERROR:ShouldLog(LogLevels.Error)&&log("Received server error: "+g.safeStringify(e)),e.isFatal&&g.vmMain.setGDriveStatus(DriveStatus.Offline);break;default:ShouldLog(LogLevels.Error)&&log("Unkown Doc Error - "+g.safeStringify(e)),g.reportError(new Error("Unknown Doc Error: "+g.safeStringify(e)))}return e.isFatal}function loadDoc(id,title,newDoc){if(id){ShouldLog(LogLevels.Timing)&&log("Drive document requested: ",log.now());var openingDoc=g.vmMain.docManager.loadDocFromData({id:id,title:title},!1);openingDoc.open(),self.setDocInfo(id,title);try{var initFn=newDoc?onFirstDocInitialized:onDocInitialized;gdata.driveRealtimeLoad(id,onDocLoaded,initFn,onDocLoadError);try{window.__LOAD_REQUESTS.push(g.getCurrentStack("Normal Load ["+newDoc+"]"))}catch(err){g.reportError(err)}}catch(err){self.recoverFromError(err)}}else findAndLoadDoc()}function findAndLoadDoc(){openDefaultRealtimeFile(function(docInfo,newDoc){docInfo&&docInfo.id?loadDoc(docInfo.id,docInfo.title,newDoc):g.reportError(new Error("We should always find a valid document with a defined id"))})}function runUnlinkBatches(batchesArr,cb){function runBatch(index){batchesArr[index].then(function(response){batchesArr.length>index+1?setTimeout(function(){runBatch(index+1)},unlinkBatchTimeout):cb(!0)},function(){cb(!1)})}return 0===batchesArr.length?cb(!0):void runBatch(0)}function unlinkFolder(folderID,cb){var options={getAllPages:!0,maxPageResults:500},successCB=function(result){try{if(result.length>0){for(var batch=gapi.client.newBatch(),i=0;i<result.length;++i){var req=gapi.client.drive.children.delete({folderId:folderID,childId:result[i].id});batch.add(req)}cb(batch)}else cb(void 0)}catch(err){g.reportError(err),cb(void 0)}},failureCB=function(result,partialResponse){cb(void 0)};g.vmMain.remoteAPI().driveChildrenList(folderID,successCB,failureCB,options)}function saveAuthorizedScopes(){for(var scopeArr=[],i=0;i<authorizedScopes.length;++i){var scopeIndex=self.scopes.indexOf(authorizedScopes[i]),forceNoSave=noSaveScopes.indexOf(authorizedScopes[i])>=0;scopeIndex>=0&&!forceNoSave&&scopeArr.push(scopeIndex)}var saveString=JSON.stringify(scopeArr);g.settings.set(Settings.authScopes,saveString)}function handleContactsLoaded(numContacts){numContacts>0&&g.vmMain.runParseWorkerNewContacts()}function setAuthToken(token){try{g.PAssert(3258,token.expires_in,"Token must provide a valid expires_in value",token)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3259,token.expires_at,"Token must provide a valid expires_at value",token)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3260,token.issued_at,"Token must provide a valid issued_at value",token)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3261,token.id_token,"Token must provide a valid id_token value",token)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3262,token.access_token,"Token must provide a valid access_token value",token)}catch(PERR){g.reportError(PERR)}gapi.auth.setToken(token)}function setExternalAccessTokenInternal(){try{g.PAssert(3263,void 0!==externalToken,"Should always have a valid token value")}catch(PERR){g.reportError(PERR)}g.isString(externalToken.scope)&&(externalToken.scope=externalToken.scope.split(" ")),setAuthToken(externalToken)}function lockOAuthScheme(){isOAuthSchemeLocked=!0,g.settings.set(Settings.oauthScheme,currentOAuthSchemeType)}function getBestOAuthScheme(){for(var i=OAuthSchemeType.Count;i>=0;i--)if(availableOAuthSchemes[i])return i}function tokenRequestFilter(authFn){return function(config,cb){authFn(config,function(token){token&&!token.error&&lockOAuthScheme(),cb(token)})}}function setupOAuthScheme(){try{g.PAssert(3267,!isOAuthSchemeLocked,"Should not be setting up OAuth if locked into the current scheme")}catch(PERR){g.reportError(PERR)}if(!isOAuthSchemeLocked){var scheme=getBestOAuthScheme();if(scheme!==currentOAuthSchemeType)switch(currentOAuthSchemeType=scheme,scheme){case OAuthSchemeType.None:OAuthScheme={authorize:tokenRequestFilter(self.requestNoneOAuth)};break;case OAuthSchemeType.Web:try{g.PAssert(3268,self.isAuthAPILoaded(),"GAPI Auth should always be valid at this point")}catch(PERR){g.reportError(PERR)}OAuthScheme={authorize:tokenRequestFilter(gapi.auth.authorize)};break;case OAuthSchemeType.Native:OAuthScheme={authorize:tokenRequestFilter(self.requestNativeOAuth)};break;default:try{g.PAssert(3269,!1,"Invalid OAuth scheme type")}catch(PERR){g.reportError(PERR)}}}}function frameIdx(frame){return parseInt(frame.id.split("_")[1])}function handleAuthorization(token,partialAuth,callback){if(token&&!token.error){try{g.PAssert(3273,token.scope,"Scopes must be valid")}catch(PERR){g.reportError(PERR)}self.numTokenRequestSuccess++,g.isString(token.scope)&&(token.scope=token.scope.split(" ")),self.getActiveUser();var oldAuthorizedScopes=authorizedScopes,newAuthorizedScopes=ko.utils.arrayGetDistinctValues(token.scope);partialAuth&&newAuthorizedScopes.pushOnlyUniques(oldAuthorizedScopes),authorizedScopes=newAuthorizedScopes,oldAuthorizedScopes.equals(newAuthorizedScopes)||saveAuthorizedScopes();var expireMS=1e3*(parseInt(token.expires_in)-600);authorizedUntil=Date.now()+expireMS,clearTimeout(refreshAuthorizationTimer),refreshAuthorizationTimer=setTimeout(refreshAuthorization,expireMS),lastRefreshWait=DEFAULT_REFRESH_WAIT,gdata.poke();var runAuthLoaded=function(){g.vmMain.realtimeDocManager.notifyGoogleAuthorization(authorizedScopes),self.onHaveUserSignupData(AccountManager.notifyUserAuthorized.bind(AccountManager,"me",authorizedScopes))};g.vmMain?runAuthLoaded():Dispatcher.listen("VMMainLoaded",function(){runAuthLoaded(),Dispatcher.unlisten("VMMainLoaded",runAuthLoaded)}),setTimeout(function(){for(var iframes=document.getElementsByTagName("iframe"),i=0;i<iframes.length;++i)if(iframes[i].src.startsWith("https://accounts.google.com/o/oauth2/auth?"))if(""===iframes[i].id)iframes[i].id="auth_"+authIndex++;else{var idx=frameIdx(iframes[i]);idx!==authIndex&&idx!==authIndex-1&&iframes[i].parentElement.removeChild(iframes[i])}},0)}else log("Error authorizing token: "+(token?token.error:"UNDEFINED")),self.numTokenRequestFailed++;callback&&callback(token)}function generateValidScopes(scopeArr,isRefresh){for(var validScopes=[],i=0;i<scopeArr.length;++i){var scope=scopeArr[i],isKnownScope=self.scopes.indexOf(scope)>=0||!isRefresh&&scope===GScope.TasksRO;try{g.PAssert(3275,isKnownScope||knownScopes.indexOf(scope)>=0,"Unknown scope requested: ",scope)}catch(PERR){g.reportError(PERR)}legacyScopes.indexOf(scope)<0&&isKnownScope&&(!overlapScopes[scope]||scopeArr.indexOf(overlapScopes[scope])<0)&&validScopes.push(scope)}return validScopes}function sanityCheckScopeList(validScopes,userId){var sanityConfirmed=!0,MagicScopeNumber=7;userId&&!userId.endsWith("@gmail.com")&&validScopes.length>MagicScopeNumber&&(sanityConfirmed=!1),sanityConfirmed||(validScopes.remove(GScope.DriveInstall),validScopes.length>MagicScopeNumber&&(validScopes.remove(GScope.Contacts),validScopes.length>MagicScopeNumber&&g.reportError(new Error("Unfixable too many scoops! "+validScopes))))}function refreshAuthorization(cb){if(!OAuthScheme||!OAuthScheme.authorize)return cb(void 0),!1;try{g.PAssert(3277,authorizedScopes.length>=self.requiredScopes.length,"We lost some required scopes somewhere...")}catch(PERR){g.reportError(PERR)}refreshingAuth=!0;var currentToken=gapi.auth.getToken(),tokenString;if(currentToken){var validTime=1e3*parseInt(currentToken.expires_in),validElapsed=Math.min(Date.now()-1e3*parseInt(currentToken.issued_at),validTime);self.totalTokenLifetime+=validElapsed}var userId=self.getCurrentUserEmail()||g.settings.get(Settings.activeUser),validScopes=generateValidScopes(authorizedScopes,!0);sanityCheckScopeList(validScopes,userId);var config={client_id:self.CLIENT_ID,scope:validScopes.join(" "),immediate:!0,include_granted_scopes:!0,login_hint:userId,response_type:"token id_token",authuser:-1};return self.numTokensRequested++,OAuthScheme.authorize(config,function(token){tokenRefreshed=!0,refreshingAuth=!1,handleAuthorization(token,!1,cb)}),!0}function tryToLoadGapi(){if(self.isRealtimeAPILoaded())isLoadingScript=!1;else{var oldScript=document.getElementById("gapiScript");oldScript&&oldScript.parentNode.removeChild(oldScript),g.addScript("https://apis.google.com/js/client.js?onload=GoogleApiLoaded","gapiScript",function(){isLoadingScript=!1}),numTriesLoad-->0?setTimeout(tryToLoadGapi,RELOAD_TIMEOUT):isLoadingScript=!1}}function tryToRefreshToken(cb){tokenRefreshed?(gdata.poke(),setTimeout(function(){gdata.doc&&gdata.doc.saveDelay>=g.seconds(30)&&gdata.doc.saveDelay<=g.seconds(50)&&refreshAuthorization()},g.seconds(40)),g.toasts.clearMessage(MessageID.ConnectionError),cb&&cb()):(refreshAuthorization(),setTimeout(function(){tryToRefreshToken(cb)},RELOAD_TIMEOUT))}var self={CLIENT_ID:"597847337936.apps.googleusercontent.com",eventSubscribers:[],authenticatedUserInfo:ko.observable()};g.goog=self;var DEFAULT_REFRESH_WAIT=1e4,MAX_REFRESH_WAIT=16e4,MAX_REALTIME_MODEL_SIZE=10485760,DocSizeWarnPercent=.85,DocSizeErrorPercent=.95;self.APP_ID="597847337936",self.REALTIME_MIMETYPE="application/vnd.google-apps.drive-sdk",self.FOLDER_MIMETYPE="application/vnd.google-apps.folder",self.MoodoMimetype=self.REALTIME_MIMETYPE+"."+self.APP_ID,window.GScope={Calendar:"https://www.googleapis.com/auth/calendar",CalendarRO:"https://www.googleapis.com/auth/calendar.readonly",Contacts:"https://www.googleapis.com/auth/contacts.readonly",Drive:"https://www.googleapis.com/auth/drive.file",UserInfoEmail:"https://www.googleapis.com/auth/userinfo.email",DriveFull:"https://www.googleapis.com/auth/drive",TasksRO:"https://www.googleapis.com/auth/tasks.readonly",UserInfoProfile:"https://www.googleapis.com/auth/userinfo.profile",DriveInstall:"https://www.googleapis.com/auth/drive.install",DriveAppData:"https://www.googleapis.com/auth/drive.appdata",DriveMetadataRO:"https://www.googleapis.com/auth/drive.metadata.readonly",GmailRO:"https://www.googleapis.com/auth/gmail.readonly",GmailCompose:"https://www.googleapis.com/auth/gmail.compose",GmailModify:"https://www.googleapis.com/auth/gmail.modify"};var noSaveScopes=[GScope.TasksRO],legacyScopes=[GScope.UserInfoProfile,GScope.GmailRO],knownScopes=["https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/contacts",GScope.TasksRO],overlapScopes={};!function generateOverlapScopes(){overlapScopes[GScope.CalendarRO]=GScope.Calendar,overlapScopes[GScope.Drive]=GScope.DriveFull,overlapScopes[GScope.DriveMetadataRO]=GScope.DriveFull;var scope}(),self.LEGACY_DefaultDriveDocTitle="DuchessBeta",self.DefaultDocTitle="Moo.do Personal Document",self.DefaultFolderTitle="_Moo.do Shared Files (Do not delete)",self.DefaultAttachTitle="Shared Attachments",self.DefaultProperty="MooDoDefault",self.DefaultPropertyValue="TRUE",self.DefaultRootFolderProperty="MooDoDefaultRoot",self.DefaultRootFolderPropertyValue="TRUE",self.DefaultAttachFolderProperty="MooDoDefaultAttach",self.DefaultAttachFolderPropertyValue="TRUE",self.DocFolderTitlePrefix="Moodo_",self.DocFolderProperty="MooDoFolder",self.DocFolderPropertyPrefix="MDSF_",self.DocFolderTitleProperty="MooDoTitle",self.requiredScopes=[GScope.Drive,GScope.UserInfoEmail,GScope.DriveInstall,GScope.DriveAppData],self.requestScopes=[],self.scopes=[GScope.Calendar,GScope.CalendarRO,GScope.Contacts,GScope.Drive,GScope.UserInfoEmail,GScope.DriveFull,GScope.UserInfoProfile,GScope.DriveInstall,GScope.DriveAppData,GScope.DriveMetadataRO,GScope.GmailRO,GScope.GmailModify,GScope.GmailCompose];var authorizedScopes=[];self.getAuthorizedScopes=function getAuthorizedScopesFn(){return authorizedScopes};var docFields="items(id,title,properties)";self.isLoaded=!1,self.init=function initFn(){self.isAuthAPILoaded()?self.addOAuthMethod(OAuthSchemeType.Web):window.addEventListener("gapiLoaded",function(){self.addOAuthMethod(OAuthSchemeType.Web)});var lastOAuthScheme=g.settings.get(Settings.oauthScheme);if(void 0!==lastOAuthScheme&&lastOAuthScheme!=OAuthSchemeType.Web)try{var scheme=parseInt(lastOAuthScheme);self.addOAuthMethod(scheme)}catch(err){g.reportError(err)}setupOAuthScheme();var savedScopesString=g.settings.get(Settings.authScopes);if(savedScopesString){var savedScopes;try{savedScopes=JSON.parse(savedScopesString)}catch(err){g.reportError(err)}if(savedScopes){for(var i=0;i<savedScopes.length;++i){try{g.PAssert(3213,savedScopes[i]>=0,"Each saved scope should be a valid array index")}catch(PERR){g.reportError(PERR)}savedScopes[i]>=0&&self.requestScopes.push(self.scopes[savedScopes[i]])}self.requestScopes=ko.utils.arrayGetDistinctValues(self.requestScopes)}}else self.requestScopes=self.requiredScopes;authorizedScopes=self.requestScopes,platform.syncContacts&&util.getURLParam("access_token")&&!util.hasURLParam("error")&&(authorizedScopes.indexOf(GScope.Contacts)<0&&(authorizedScopes.push(GScope.Contacts),saveAuthorizedScopes()),g.settings.set(Settings.syncContacts,!0)),g.settings.registerForChangeNotification(Settings.syncContacts,void 0,function(oldValue,newValue){newValue&&self.authAndLoadContacts(!1,function(success){g.settings.set(Settings.syncContacts,success)})});try{g.PAssert(3214,void 0===self.authenticatedUserInfo(),"We should not have user info when initing goog")}catch(PERR){g.reportError(PERR)}var authGASub=self.authenticatedUserInfo.subscribe(function(newValue){void 0!==newValue&&(window.ga&&ga("set","&uid",g.getAnonUserIdentifier()),authGASub.dispose(),authGASub=void 0)})},self.ensureRequiredScopesAreRequested=function ensureRequiredScopesAreRequestedFn(){for(var needsAdditionalScopes=!1,i=0;i<self.requiredScopes.length;++i)if(authorizedScopes.indexOf(self.requiredScopes[i])<0){needsAdditionalScopes=!0;break}needsAdditionalScopes&&self.runAuthenticate(self.requiredScopes,!0,!1,function(token){!token||token.error?g.toasts.pushMessage({text:"We need additional permissions to give you the best experience.",actionText:"AUTHORIZE",action:function actionFn(){self.runAuthenticate(self.requiredScopes,!1,!1,function(token2){(!token2||token2.error)&&g.toasts.pushMessage({text:"There was an error authenticating. Please try again.",actionText:"AUTHORIZE",action:self.ensureRequiredScopesAreRequested})})}}):saveAuthorizedScopes()})},self.onHaveUserSignupData=function onHaveUserSignupDataFn(cb){if(self.authenticatedUserInfo())setTimeout(cb,0);else var infoSub=self.authenticatedUserInfo.subscribe(function(){infoSub.dispose(),infoSub=void 0,setTimeout(cb,0)})},self.getCurrentUserDomain=function getCurrentUserDomainFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().hd:void 0},self.getCurrentUserFirstName=function getCurrentUserFirstNameFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().given_name:void 0},self.getCurrentUserLastName=function getCurrentUserLastNameFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().family_name:void 0},self.getCurrentUserEmail=function getCurrentUserEmailFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().email:void 0},self.getCurrentUserID=function getCurrentUserIDFn(){return self.authenticatedUserInfo()?self.authenticatedUserInfo().id:void 0},self.getCurrentUserSignupInfo=function getCurrentUserSignupInfoFn(){var signupInfo={full:self.authenticatedUserInfo(),fname:self.getCurrentUserFirstName(),lname:self.getCurrentUserLastName()};return signupInfo},self.getUserName=function getUserNameFn(info){try{info.fname=self.getCurrentUserFirstName(),info.lname=self.getCurrentUserLastName()}catch(err){info.nameError=!0}};var watchdogWait=96e4,watchdogInterval;self.startWatchdog=function startWatchdogFn(){watchdogInterval||(watchdogInterval=setInterval(self.watchdogFn,watchdogWait))},self.stopWatchdog=function stopWatchdogFn(){clearInterval(watchdogInterval),watchdogInterval=void 0};var lastWatchdogTime=0;self.watchdogFn=function watchdogFnFn(){var currentTime=Date.now();if(lastWatchdogTime-currentTime>=watchdogWait){try{var token=gapi.auth.getToken();if(token){var expireTime=1e3*parseInt(token.expires_at);currentTime>expireTime?(ShouldLog(LogLevels.Error)&&log("Active token is no longer valid: "+currentTime+" vs. "+expireTime),refreshAuthorization(),g.reportError(new Error("Watchdog found expired token on client"))):gdata.poke()}else ShouldLog(LogLevels.Error)&&log("No active token on client!"),refreshAuthorization(),g.reportError(new Error("Watchdog found client with no token set"))}catch(err){g.reportError(err)}finally{lastWatchdogTime=currentTime}g.checkForRemoteChanges()}},self.hasPermission=function hasPermissionFn(scope){return authorizedScopes.indexOf(scope)>-1};var refreshAuthorizationTimer,authorizedUntil,refreshingAuth=!0;self.onFocusHandler=function onFocusHandlerFn(){authorizedUntil&&Date.now()>authorizedUntil&&!refreshingAuth&&refreshAuthorization()},self.onBlurHandler=function onBlurHandlerFn(){refreshAuthorizationTimer&&clearTimeout(refreshAuthorizationTimer)},self.getContactInfo=function getContactInfoFn(email,callback){function handleResponse(obj){if(obj)try{g.settings.set(Settings.lastContactSync,new Date(obj.feed.updated.$t))}catch(err){g.reportError(err)}callback(obj)}var accessToken=AccountManager.getAccessTokenSync(email);if(!accessToken)return void callback(void 0);var url="https://www.google.com/m8/feeds/contacts/default/full?v=3.0&alt=json",lastSync=g.settings.get(Settings.lastContactSync),forceLoad=d.areLocalContactsLoaded()&&0===d.contactManager.numContacts();if(lastSync&&!forceLoad){var syncDate=new Date(lastSync);url+="&updated-min="+syncDate.toString("yyyy-MM-ddTHH:mm:ss")}url+="&max-results=10000",url+="&access_token="+accessToken,g.JSONP({url:url,cb:handleResponse})},self.loadedContacts=!1,self.loadContacts=function loadContactsFn(callback){if(!self.loadedContacts){self.loadedContacts=!0,d.loadLocalContacts();var loadedContacts=d.contactManager.numContacts(),accountID="me";AccountManager.onUserAuthorized(accountID,function(){self.getContactInfo(accountID,function(data){if(!data)return void callback(-1);log("Loading Remote Contacts!",parseInt(data.feed.openSearch$totalResults.$t));var contactCount=0;if(data&&data.feed&&data.feed.entry&&data.feed.entry.length){contactCount=data.feed.entry.length;for(var entries=data.feed.entry,i=0;i<entries.length;i++){var entry=entries[i],contact={id:/\/([^\s\/]+$)/gi.exec(entry.id.$t)[1],text:""};if(entry.gd$name&&entry.gd$name.gd$fullName){var text=entry.gd$name.gd$fullName.$t;contact.text=text,"'"===contact.text[0]&&(contact.text=contact.text.substr(1))}if(entry.gd$email){for(var emails=entry.gd$email,u=0;u<emails.length;u++)delete emails[u].rel,!contact.text&&emails[u].primary&&(contact.text=emails[u].address);!contact.text&&emails.length>0&&(contact.text=emails[0].address),contact.emails=emails}if(entry.gd$phoneNumber){var phoneNumbers=entry.gd$phoneNumber;contact.phoneNumbers=[];for(var u=0;u<phoneNumbers.length;u++){var phoneNumber={number:phoneNumbers[u].$t};phoneNumber.type=phoneNumbers[u].rel?phoneNumbers[u].rel.replace("http://schemas.google.com/g/2005#",""):phoneNumbers[u].label,contact.phoneNumbers.push(phoneNumber)}}contact.text&&(0===loadedContacts?d.contactManager.addContact(contact):d.contactManager.updateContact(contact))}}contactCount>0&&d.saveContacts(),callback&&callback(contactCount)})})}},self.setDocInfo=function setDocInfoFn(id,title){g.settings.set(Settings.gdocId,id),g.settings.set(Settings.gdocTitle,title)},self.getDocId=function getDocIdFn(){return g.vmMain.docManager.getOpenDoc().id},self.clearDocInfo=function clearDocInfoFn(){g.settings.reset(Settings.gdocId),g.settings.reset(Settings.gdocTitle)};var rootFolderID,attachFolderID;self.getAttachFolder=function getAttachFolderFn(cb){function _getAttachFolder(){function ensureAttachFolderProps(folderInfo){}function createAttachFolder(){createAttachFileStructure(function(attachID){return attachID?(attachFolderID=attachID,g.settings.set(Settings.attachFolderId,attachFolderID),cb(attachFolderID)):cb()})}if(attachFolderID)cb(attachFolderID);else{var folderID=g.settings.get(Settings.attachFolderId);if(folderID){var successCB=function(result){return result?(attachFolderID=folderID,ensureAttachFolderProps(result),cb(folderID)):void createAttachFolder()},failureCB=function(result){return g.settings.set(Settings.attachFolderId,void 0),result&&result.error&&404===result.error.code?void createAttachFolder():cb()};g.vmMain.remoteAPI().driveFilesGet(folderID,successCB,failureCB)}else{var q="properties has {key='"+self.DefaultAttachFolderProperty+"' and value='"+self.DefaultAttachFolderPropertyValue+"' and visibility='PRIVATE'} and 'me' in owners and trashed=false",options={getAllPages:!0},successCB=function(result){if(result.length>0){try{g.PAssert(3219,1===result.length,"Must have a single root folder present")}catch(PERR){g.reportError(PERR)}var attachFolderInfo=result[0];return attachFolderID=attachFolderInfo.id,g.settings.set(Settings.attachFolderId,attachFolderID),ensureAttachFolderProps(attachFolderInfo),cb(attachFolderInfo.id)}createAttachFolder()},failureCB=function(result){return cb()};g.vmMain.remoteAPI().driveFilesList(q,successCB,failureCB,options)}}}try{g.PAssert(3217,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3218,cb,"Must provide a valid callback when getting the root folder")}catch(PERR){g.reportError(PERR)}rootFolderID?_getAttachFolder():g.loadGoogleAPI("drive","v2",function(){self.getRootFolder(_getAttachFolder)})},self.getRootFolder=function getRootFolderFn(cb){function ensureRootFolderProps(folderInfo){}function createRootFolder(){createDefaultFileStructure(function(rootID){return rootID?(rootFolderID=rootID,g.settings.set(Settings.rootFolderId,rootFolderID),cb(rootFolderID)):cb()})}try{g.PAssert(3220,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3221,cb,"Must provide a valid callback when getting the root folder")}catch(PERR){g.reportError(PERR)}if(rootFolderID)return cb(rootFolderID);var folderID=g.settings.get(Settings.rootFolderId);if(folderID){var successCB=function(result){return result?(rootFolderID=folderID,ensureRootFolderProps(result),cb(folderID)):void createRootFolder()},failureCB=function(result){return g.settings.set(Settings.rootFolderId,void 0),result&&result.error&&404===result.error.code?void createRootFolder():cb()};g.vmMain.remoteAPI().driveFilesGet(folderID,successCB,failureCB)}else{var q="properties has {key='"+self.DefaultRootFolderProperty+"' and value='"+self.DefaultRootFolderPropertyValue+"' and visibility='PRIVATE'} and 'me' in owners and trashed=false",options={getAllPages:!0},successCB=function(result){if(result.length>0){try{g.PAssert(3222,1===result.length,"Must have a single root folder present")}catch(PERR){g.reportError(PERR)}var rootFolderInfo=result[0];return rootFolderID=rootFolderInfo.id,g.settings.set(Settings.rootFolderId,rootFolderID),ensureRootFolderProps(rootFolderInfo),cb(rootFolderInfo.id)}createRootFolder()},failureCB=function(result){return cb()};g.vmMain.remoteAPI().driveFilesList(q,successCB,failureCB,options)}},self.createAndSetupDocument=function createAndSetupDocumentFn(doc,isDefault,cb){try{g.PAssert(3234,cb,"Must pass in a valid creation callback")}catch(PERR){g.reportError(PERR)}g.loadGoogleAPI("drive","v2",function(){var props;isDefault&&(props=[{key:self.DefaultProperty,value:self.DefaultPropertyValue,visibility:"PRIVATE"}]);var requestFn=["gapi","client","drive","files","insert"],requestData={fields:"createdDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,userPermission(id,role,type)",resource:{mimeType:self.REALTIME_MIMETYPE,title:doc.getTitle()||self.DefaultDocTitle,writersCanShare:!1,properties:props}},successCB=function(result){doc.updateData(result),doc.createDocumentFileStructure(function(folderInfo){return cb(result)})},failureCB=function(result){return cb(void 0)};g.vmMain.remoteAPI().runRemoteSingleRequest(requestFn,requestData,successCB,failureCB)})};var lastRefreshWait=DEFAULT_REFRESH_WAIT;self.recoverFromError=function recoverFromErrorFn(err){err&&(ShouldLog(LogLevels.Error)&&log("GDrive Error: ",err),g.reportError(err)),g.vmMain.setGDriveStatus(DriveStatus.Connecting),refreshAuthorization(function(token){if(!token||token.error){g.toasts.pushMessage(MessageID.ConnectionError),g.vmMain.setGDriveStatus(DriveStatus.Offline);var errorMessage="Unable to refresh authentication token - ",sendReport=!0;token?(errorMessage+=token.error,"immediate_failed"===token.error&&(sendReport=!1)):errorMessage+="No Token",sendReport?g.reportError(new Error(errorMessage)):ShouldLog(LogLevels.Error)&&log("Refresh Auth Failed: ",errorMessage),MAX_REFRESH_WAIT>lastRefreshWait&&(setTimeout(self.recoverFromError,lastRefreshWait),lastRefreshWait*=2)}})};var activeUserRequestQueue=[],activeUserRequested=!1;self.getActiveUser=function getActiveUserFn(cb){if(AccountManager.isCurrentlyAuthorized("me"))if(self.getCurrentUserEmail()){try{g.PAssert(3245,0===activeUserRequestQueue.length,"If we have the current user data, the request queue should be empty")}catch(PERR){g.reportError(PERR)}cb&&cb(self.getCurrentUserEmail(),self.getCurrentUserID())}else cb&&activeUserRequestQueue.push(cb),activeUserRequested||(activeUserRequested=!0,g.XHR({type:"GET",url:"https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token="+AccountManager.getDefaultAccessToken(),autoRetry:!0,cb:function cbFn(xhr){if(activeUserRequested=!1,200===xhr.status){var userInfoParsed={};try{userInfoParsed=JSON.parse(xhr.responseText)}catch(err){g.reportError(new Error("Error parsing user info"),xhr.responseText)}self.authenticatedUserInfo(userInfoParsed);var oldUserID=g.settings.get(Settings.userId);try{g.PAssert(3244,!oldUserID||oldUserID===userInfoParsed.id,"Cached copy of user ID should always be up to date or cleared")}catch(PERR){g.reportError(PERR)}g.settings.set(Settings.userId,userInfoParsed.id),g.settings.set(Settings.displayName,userInfoParsed.name);for(var i=0;i<activeUserRequestQueue.length;++i)activeUserRequestQueue[i](self.getCurrentUserEmail());activeUserRequestQueue=[]}}}));else cb&&activeUserRequestQueue.push(cb)};var loadedClientDefaultFile=!1;self.loadClientDefaultFile=function loadClientDefaultFileFn(){var mainLoaded=!!g.vmMain,driveLoaded=!!window.gapi&&!!window.gapi.drive&&!!window.gapi.drive.realtime;return!loadedClientDefaultFile&&mainLoaded&&driveLoaded&&AccountManager.isCurrentlyAuthorized("me")&&g.getLoginState()==LoginState.LOGGED_IN?(g.checkpoint(Checkpoint.LoadDefaultFile),loadedClientDefaultFile=!0,ShouldLog(LogLevels.Timing)&&log("Loading Default Client File: ",log.now()),g.vmMain.setGDriveStatus(DriveStatus.Connecting),self.getActiveUser(function(newUser){try{g.PAssert(3246,newUser,"The authenticated user should always be valid",newUser,g.settings.get(Settings.activeUser))}catch(PERR){g.reportError(PERR)}var prevUser=g.settings.get(Settings.activeUser);prevUser&&newUser&&newUser!==prevUser?d.clearData(function(){g.reload()}):!prevUser&&newUser&&g.settings.set(Settings.activeUser,newUser)}),loadDoc(g.settings.get(Settings.gdocId),g.settings.get(Settings.gdocTitle),!1),self.loadCalendarAndContacts(),!0):!1},self.reconnectToActiveDocument=function reconnectToActiveDocumentFn(){var mainLoaded=!!g.vmMain,driveLoaded=!!window.gapi&&!!window.gapi.drive&&!!window.gapi.drive.realtime,isLoggedIn=g.getLoginState()==LoginState.LOGGED_IN,token=AccountManager.getDefaultAccessToken();try{g.PAssert(3247,!gdata.isConnected(),"Should not try to reconnect if gdata is still connected")}catch(PERR){g.reportError(PERR)}mainLoaded&&driveLoaded&&isLoggedIn&&token&&!gdata.isConnected()&&!g.vmMain.isReconnecting()&&(g.vmMain.setGDriveStatus(DriveStatus.Reconnecting),g.isReconnected=!0,loadDoc(g.settings.get(Settings.gdocId),g.settings.get(Settings.gdocTitle),!1))},self.deleteAppDataFiles=function deleteAppDataFilesFn(cb){var successCB=function(result){for(var appBatch=gapi.client.newBatch(),numInAppBatch=0,i=0;i<result.length;++i){var req=gapi.client.drive.files.trash({fileId:result[i].id});appBatch.add(req),numInAppBatch++}numInAppBatch>0?appBatch.then(function(response){cb(!0)},function(){cb(!1)}):cb(!0)},failureCB=function(result,partialResponse){cb(!1)},q="'appfolder' in parents",options={getAllPages:!0};g.vmMain.remoteAPI().driveFilesList(q,successCB,failureCB,options)},self.deleteAllFiles=function deleteAllFilesFn(fileList,cb){for(var batch=gapi.client.newBatch(),numInBatch=0,i=0;i<fileList.length;++i)if(fileList[i].hasDriveBacking()){var fileData=fileList[i].getData();if(fileData.userPermission&&"owner"===fileData.userPermission.role){var req=gapi.client.drive.files.trash({fileId:fileList[i].id});
batch.add(req),numInBatch++}}numInBatch>0?batch.then(function(response){self.deleteAppDataFiles(cb)},function(){cb(!1)}):self.deleteAppDataFiles(cb)},self.DeleteErrorCode={None:0,RootFolder:1,UnlinkFailure:2,UnlinkException:3,MissingFolders:4,FolderException:5,MissingRoot:6},self.deleteAccount=function deleteAccountFn(cb){g.loadGoogleAPI("drive","v2",function(){self._deleteAccount(cb)})};var unlinkBatchTimeout=1500;self._deleteAccount=function _deleteAccountFn(cb){var numFoldersBatched=0,expectedFoldersBatched=0,unlinkBatches=[];self.getRootFolder(function(rootFolderID){function trashRootFolder(cb){gapi.client.drive.files.trash({fileId:rootFolderID}).execute(function(trashResponse){!trashResponse||trashResponse.error?cb(!1,self.DeleteErrorCode.RootFolder):cb(!0,self.DeleteErrorCode.None)})}if(rootFolderID){var q="'"+rootFolderID+"' in parents",options={getAllPages:!0,maxPageResults:999},successCB=function(result){try{if(expectedFoldersBatched=result.length,expectedFoldersBatched>0)for(var i=0;i<result.length;++i){var folderInfo=result[i];"owner"===folderInfo.userPermission.role?unlinkFolder(folderInfo.id,function(batch){batch&&unlinkBatches.push(batch),++numFoldersBatched===expectedFoldersBatched&&runUnlinkBatches(unlinkBatches,function(unlinkSuccess){try{unlinkSuccess?trashRootFolder(cb):cb(!1,self.DeleteErrorCode.UnlinkFailure)}catch(unlinkErr){g.reportError(unlinkErr),cb(!1,self.DeleteErrorCode.UnlinkException)}})}):expectedFoldersBatched--}else trashRootFolder(cb)}catch(err){g.reportError(err),cb(!1,self.DeleteErrorCode.FolderException)}},failureCB=function(result,partialresponse){cb(!1,self.DeleteErrorCode.MissingFolders)};g.vmMain.remoteAPI().driveFilesList(q,successCB,failureCB,options)}else cb(!1,self.DeleteErrorCode.MissingRoot)})},self.authAndLoadContacts=function authAndLoadContactsFn(retry,cb){g.settings.get(Settings.syncContacts)&&(authorizedScopes.indexOf(GScope.Contacts)<0?self.runAuthenticate([GScope.Contacts],!0,retry,function(token){!token||token.error?(g.toasts.pushMessage(MessageID.LostPermission),AccountManager.notifyUnauthorizedAccount("me",[GScope.Contacts],token?token.error:"Missing token"),g.settings.set(Settings.syncContacts,!1),cb&&cb(!1)):self.loadContacts(function(numContacts){handleContactsLoaded(numContacts),cb&&numContacts>0&&cb(!0)})}):self.loadContacts(function(numContacts){handleContactsLoaded(numContacts),cb&&numContacts>0&&cb(!0)}))},self.refreshContacts=function refreshContactsFn(cb){return d.clearLocalContacts(),self.loadedContacts=!1,g.settings.get(Settings.syncContacts)?(self.authAndLoadContacts(!0,function(success){cb&&cb()}.bind(this)),!0):!1},self.authDocSharing=function authDocSharingFn(){},self.loadCalendarAndContacts=function loadCalendarAndContactsFn(){window.gapi&&self.authAndLoadContacts(!1)},window.__LOAD_HANDLES=new RingBuffer(5),window.__LOAD_REQUESTS=new RingBuffer(5),self.checkTokenInHash=function checkTokenInHashFn(){function computeIssuedAt(){return""+Math.floor((Date.now()-g.minutes(1))/1e3)}function computeExpiresAt(expiresInStr,issuedAt){return""+Math.floor(g.parseInt(issuedAt)+1e3*g.parseInt(expiresInStr)/1e3)}var setToken=!1;if(util.hasURLParam("access_token"))try{var scopeString=util.getURLParam("scope"),scopes;scopeString&&(scopes=scopeString.split("+"));var issued_at=util.hasURLParam("issued_at")?util.getURLParam("issued_at"):computeIssuedAt(),expires_in=util.getURLParam("expires_in"),expires_at=util.hasURLParam("expires_at")?util.getURLParam("expires_at"):computeExpiresAt(expires_in,issued_at),token={access_token:util.getURLParam("access_token"),id_token:util.getURLParam("id_token"),issued_at:issued_at,expires_in:expires_in,expires_at:expires_at,scope:scopes,token_type:util.getURLParam("token_type")};setAuthToken(token),setToken=!0,util.removeURLParam("access_token",!0),util.removeURLParam("issued_at",!0),util.removeURLParam("expires_in",!0),util.removeURLParam("expires_at",!0),util.removeURLParam("scope",!0),util.removeURLParam("token_type",!0),util.removeURLParam("id_token",!0),util.hasURLParam("login")||util.insertURLParam("login",!0,!0),self.onHaveUserSignupData(AccountManager.notifyUserAuthorized.bind(AccountManager,"me",scopes))}catch(err){g.reportError(err)}return setToken};var externalToken;self.setExternalAccessToken=function setExternalAccessTokenFn(token){externalToken=token,self.isAuthAPILoaded()?setExternalAccessTokenInternal():window.addEventListener("gapiLoaded",setExternalAccessTokenInternal)};var nativeOAuthCount=0,nativeOAuthRequests={};self.requestNativeOAuth=function requestNativeOAuthFn(config,cb){try{g.PAssert(3264,config,"Must supply valid OAuth config")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3265,cb,"Must specify a callback function for OAuth respose")}catch(PERR){g.reportError(PERR)}var requestId=++nativeOAuthCount,nativeData={id:requestId,scope:config.scope,immediate:config.immediate,login_hint:config.login_hint,include_granted_scopes:!0,redirect_uri:config.redirect_uri},wasSent=g.nativeBridge.sendToApp("getOAuth",nativeData);nativeOAuthRequests[requestId]=cb},self.handleNativeOAuthResponse=function handleNativeOAuthResponseFn(data){var requestCallback=nativeOAuthRequests[data.id];if(requestCallback)nativeOAuthRequests[data.id]=void 0,data.success&&data.token&&!data.token.error?(self.setExternalAccessToken(data.token),requestCallback(data.token)):(log("Native Token Error: ",data),requestCallback(data.token));else try{g.PAssert(3266,!1,"OAuth callback without a valid handler")}catch(PERR){g.reportError(PERR)}},self.requestOfflineOAuth=function requestOfflineOAuthFn(config,cb){log("Request Offline OAuth: ",config),AccountManager.linkAccount(config.login_hint,config.scope,cb)};var noneOAuthRequests=[];self.requestNoneOAuth=function requestNoneOAuthFn(config,cb){noneOAuthRequests.push({config:config,cb:cb})};var isOAuthSchemeLocked=!1,availableOAuthSchemes=[];availableOAuthSchemes[OAuthSchemeType.None]=!0;var currentOAuthSchemeType=-1,OAuthScheme;self.addOAuthMethod=function addOAuthMethodFn(method){availableOAuthSchemes[method]||(availableOAuthSchemes[method]=!0,isOAuthSchemeLocked||setupOAuthScheme())},self.runAuthenticateOffline=function runAuthenticateOfflineFn(scopes,cb){var email=self.getCurrentUserEmail()||g.settings.get(Settings.activeUser)||void 0;try{g.PAssert(3270,email===util.getURLParam("user")||!util.getURLParam("user"),"Do not try to login a user that is not valid")}catch(PERR){g.reportError(PERR)}self.numTokensRequestedOffline++;var requestScopes=scopes.slice(0);requestScopes.indexOf(GScope.UserInfoEmail)<0&&requestScopes.push(GScope.UserInfoEmail);for(var isMissingAuth=!1,i=0;i<requestScopes.length;++i)if(!AccountManager.isLinkedAccountAuthorized(email,requestScopes[i])){isMissingAuth=!0;break}if(isMissingAuth){var authorizedScopes=AccountManager.getAuthorizedScopes(email);requestScopes.pushOnlyUniques(authorizedScopes),AccountManager.linkAccount(email,requestScopes,function(token){if(token&&!token.error){self.setExternalAccessToken(token);for(var i=0;i<requestScopes.length;++i)try{g.PAssert(3271,token.scope.indexOf(requestScopes[i])>=0,"Auth requested failed for scope: "+requestScopes[i])}catch(PERR){g.reportError(PERR)}}handleAuthorization(token,!0,cb)})}else AccountManager.getAccountToken(email,cb)},self.runAuthenticate=function runAuthenticateFn(requestScopes,runImmediate,retry,callback){if(!self.isAuthAPILoaded())return callback&&callback(),!1;var userId=self.getCurrentUserEmail()||g.settings.get(Settings.activeUser)||void 0;try{g.PAssert(3272,userId===util.getURLParam("user")||!util.getURLParam("user"),"Do not try to login a user that is not valid")}catch(PERR){g.reportError(PERR)}if(runImmediate&&!userId&&!util.hasURLParam("login",!0))return callback&&callback(),!1;var currentToken;try{currentToken=gapi.auth.getToken()}catch(err){g.reportError(err)}var requiredScopesToRequest;if(currentToken){if(g.isArray(currentToken.scope))requiredScopesToRequest=currentToken.scope.slice();else if(g.isString(currentToken.scope))try{requiredScopesToRequest=currentToken.scope.split(" ")}catch(err){g.reportError(err)}else requiredScopesToRequest=[];var numScopesAdded=0;if(currentToken.scope)for(var i=0;i<requestScopes.length;++i)currentToken.scope.indexOf(requestScopes[i])<0&&(requiredScopesToRequest.push(requestScopes[i]),numScopesAdded++);else requiredScopesToRequest=requestScopes,numScopesAdded=requestScopes.length;0===numScopesAdded&&(requiredScopesToRequest=[])}else requiredScopesToRequest=requestScopes;if(requiredScopesToRequest.length>0){var validScopes=generateValidScopes(requiredScopesToRequest);sanityCheckScopeList(validScopes,userId);var config={client_id:self.CLIENT_ID,scope:validScopes.join(" "),immediate:runImmediate,include_granted_scopes:!0,login_hint:userId,response_type:"token id_token",authuser:-1};platform.requireCustomRedirect&&!runImmediate&&(config.redirect_uri=platform.customRedirectString,platform.customRedirectState&&(requiredScopesToRequest.indexOf(GScope.Contacts)>=0&&(platform.customRedirectState.syncContacts=!0),config.state=JSON.stringify(platform.customRedirectState))),refreshingAuth=!0;var tokenString;self.numTokensRequested++,OAuthScheme.authorize(config,function(token){refreshingAuth=!1,ShouldLog(LogLevels.Timing)&&log("GAPI Authorized: ",log.now()),(!token||token.error)&&runImmediate&&retry?(self.numTokenRequestFailed++,self.runAuthenticate(requiredScopesToRequest,!1,!1,callback)):(token&&!token.error&&(platform.app||util.hasURLParam("login","true"))&&(g.vmSetup?g.vmSetup.setLoginState(LoginState.LOGGED_IN):g.setLoginState(LoginState.LOGGED_IN),self.loadClientDefaultFile()),handleAuthorization(token,!1,callback))})}else ShouldLog(LogLevels.Error)&&log("Authorization request with no scopes: ",requiredScopesToRequest),callback&&callback(currentToken);return!0};var authIndex=0;self.totalTokenLifetime=0,self.numTokensRequested=0,self.numTokensRequestedOffline=0,self.numTokenRequestSuccess=0,self.numTokenRequestFailed=0,self.getTokenStats=function getTokenStatsFn(obj){var stats={totalLifetime:self.totalTokenLifetime,avgerageLifetime:self.totalTokenLifetime/(self.numTokenRequestFailed+self.numTokenRequestSuccess),numRequested:self.numTokensRequested,numRequestedOffline:self.numTokensRequestedOffline,numRequestSuccess:self.numTokenRequestSuccess,numRequestFailed:self.numTokenRequestFailed};obj.tokenStats=stats};var tokenRefreshed=!1;self.isAuthAPILoaded=function isAuthAPILoadedFn(){return!!(window.gapi&&window.gapi.auth&&window.gapi.auth.authorize)},self.isDriveAPILoaded=function isDriveAPILoadedFn(){return!!(window.gapi&&window.gapi.client&&window.gapi.client.drive)},self.isRealtimeAPILoaded=function isRealtimeAPILoadedFn(){return!!(window.gapi&&window.gapi.client&&window.gapi.drive&&window.gapi.drive.realtime)};var RELOAD_TIMEOUT=1e4,numTriesLoad=0,isLoadingScript=!1;return self.goOnline=function goOnlineFn(cb){return numTriesLoad=2,self.isRealtimeAPILoaded()?(tokenRefreshed=!1,setTimeout(function(){tryToRefreshToken(cb)},2e3),!0):(isLoadingScript||(isLoadingScript=!0,setTimeout(tryToLoadGapi,2e3)),!1)},self.ensureDocConnection=function ensureDocConnectionFn(){self.isRealtimeAPILoaded()?tryToRefreshToken(function(){loadedClientDefaultFile?gdata.isConnected()||self.reconnectToActiveDocument():self.loadClientDefaultFile()}):self.goOnline()},self.init(),self}),define("LocalCache",["globals","util","platform"],function(g,util,platform){function LocalCache(cacheId,name,options){this._id=cacheId,this._name=name,this._isOpen=!1,this._isReady=!1,this._isAllLoaded=!1,this._storageError=!1,this._onReadyFns=[],this._onMetadataReadyFns=[],this._cache={},this._metadata={},this._useInMemoryStore=!options||!options.noInMemoryCache,this._isPerDoc=options&&options.isPerDoc,this.open()}var LocalCacheFns={getStats:function getStatsFn(cb){this.getFilterEntries(function(){return!0},function(entries){var stats={id:this._id,count:entries.length,size:JSON.stringify(entries).length};cb(stats)}.bind(this))},getState:function getStateFn(){return{isOpen:this._isOpen,isReady:this._isReady,isAllLoaded:this._isAllLoaded,storageError:this._storageError}},_cacheInMemory:function _cacheInMemoryFn(){return this._useInMemoryStore},_hasLoadedAll:function _hasLoadedAllFn(){return this._isAllLoaded},isPerDoc:function isPerDocFn(){return this._isPerDoc},getStorageType:function getStorageTypeFn(){try{g.PAssert(3278,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},open:function openFn(){this._isOpen=!0},close:function closeFn(){this._isOpen=!1,this._isReady=!1},isOpen:function isOpenFn(){return this._isOpen},isReady:function isReadyFn(){return this._isOpen&&this._isReady},isMetadataReady:function isMetadataReadyFn(){return this._isOpen&&this._isMetadataReady},notifyCacheReady:function notifyCacheReadyFn(success){if(success){this._storageError=!1,this._isReady=!0;for(var i=0;i<this._onReadyFns.length;++i)this._onReadyFns[i]();this._onReadyFns=[]}else this._storageError=!0,this._isReady=!1},notifyCacheMetadataReady:function notifyCacheMetadataReadyFn(success){if(success){this._isMetadataReady=!0;for(var i=0;i<this._onMetadataReadyFns.length;++i)this._onMetadataReadyFns[i]();this._onMetadataReadyFns=[]}else this._isMetadataReady=!1},onCacheReady:function onCacheReadyFn(cb){try{g.PAssert(3279,cb,"Must provide a valid cb")}catch(PERR){g.reportError(PERR)}if(this._isReady)setTimeout(cb,0);else{try{g.PAssert(3280,this._onReadyFns.indexOf(cb)<0,"Must not double register a cache ready fn")}catch(PERR){g.reportError(PERR)}this._onReadyFns.push(cb)}},onCacheMetadataReady:function onCacheMetadataReadyFn(cb){try{g.PAssert(3281,cb,"Must provide a valid cb")}catch(PERR){g.reportError(PERR)}if(this._isMetadataReady)setTimeout(cb,0);else{try{g.PAssert(3282,this._onMetadataReadyFns.indexOf(cb)<0,"Must not double register a cache metadata ready fn")}catch(PERR){g.reportError(PERR)}this._onMetadataReadyFns.push(cb)}},setMetadata:function setMetadataFn(key,value,cb){try{g.PAssert(3283,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._cacheInMemory()&&(this._metadata[key]=value)},removeMetadata:function removeMetadataFn(key,cb){try{g.PAssert(3284,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._cacheInMemory()&&delete this._metadata[key]},getMetadata:function getMetadataFn(key,cb){try{g.PAssert(3285,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}return this._cacheInMemory()?this._metadata[key]:void 0},_setRawInMemoryMetadata:function _setRawInMemoryMetadataFn(metadata){try{g.PAssert(3286,this._cacheInMemory(),"Must be running an in-memory cache")}catch(PERR){g.reportError(PERR)}this._metadata=metadata},_getRawInMemoryMetadata:function _getRawInMemoryMetadataFn(){return this._cacheInMemory()?this._metadata:void 0},_setRawInMemoryCache:function _setRawInMemoryCacheFn(cache){try{g.PAssert(3287,this._cacheInMemory(),"Must be running an in-memory cache")}catch(PERR){g.reportError(PERR)}this._cache=cache},_getRawInMemoryCache:function _getRawInMemoryCacheFn(){return this._cacheInMemory()?this._cache:void 0},count:function countFn(cb){try{g.PAssert(3288,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}return this._cacheInMemory()?Object.keys(this._cache).length:void 0},size:function sizeFn(cb){try{g.PAssert(3289,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}return this._cacheInMemory()?2*JSON.stringify(this._cache).length:void 0},loadAll:function loadAllFn(cb){try{g.PAssert(3290,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._isAllLoaded=!0},getEntrySync:function getEntrySyncFn(id){return this._cacheInMemory()?this._cache[id]:void 0},getEntry:function getEntryFn(id,cb){try{g.PAssert(3291,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}return this._cacheInMemory()?this._cache[id]:void 0},getBoundEntries:function getBoundEntriesFn(index,spanStart,spanEnd,cb){try{g.PAssert(3292,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}var entryList;if(this._cacheInMemory()){entryList=[];for(var id in this._cache)this._cache[id][index]>=spanStart&&this._cache[id][index]<=spanEnd&&entryList.push(this._cache[id])}return entryList},getFilterEntries:function getFilterEntriesFn(filterFn,cb){try{g.PAssert(3293,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}var entryList;if(this._cacheInMemory()){entryList=[];for(var id in this._cache)filterFn(this._cache[id])&&entryList.push(this._cache[id])}return entryList},removeEntry:function removeEntryFn(id,cb){try{g.PAssert(3294,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._cacheInMemory()&&delete this._cache[id]},hasEntry:function hasEntryFn(id,cb){try{g.PAssert(3296,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}return this._cacheInMemory()?this._cache.hasOwnProperty(id):!1},cacheEntry:function cacheEntryFn(id,data,cb){try{g.PAssert(3297,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._cacheInMemory()&&data&&(this._cache[id]=data)},clearCache:function clearCacheFn(cb){try{g.PAssert(3298,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._cache={}},clearMetadata:function clearMetadataFn(cb){try{g.PAssert(3299,!cb,"In memory query is sync")}catch(PERR){g.reportError(PERR)}this._metadata={}},clearBackingStore:function clearBackingStoreFn(cb){try{g.PAssert(3300,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},dumpData:function dumpDataFn(inMemory){console.log("-- Cache: ",this._id,"--"),console.log(this._cache)},onCacheError:function onCacheErrorFn(err){g.reportError(err)}};return util.defineBase(LocalCache),util.extend(LocalCache.prototype,LocalCacheFns),LocalCache}),define("LocalCacheMemory",["globals","util","data","LocalCache"],function(g,util,d,LocalCache){function LocalCacheMemory(cacheId,name,options){if(options){try{g.PAssert(3301,!options.noInMemoryCache,"Invalid in-memory cache option")}catch(PERR){g.reportError(PERR)}options.noInMemoryCache=!1}this._super.constructor.call(this,cacheId,name,options),this._db=void 0}var LocalCacheMemoryFns={getStorageType:function getStorageTypeFn(){return StorageType.InMemory},setMetadata:function setMetadataFn(key,value,cb){this._super.setMetadata.call(this,key,value),cb&&cb(!0)},removeMetadata:function removeMetadataFn(key,cb){this._super.removeMetadata.call(this,key),cb&&cb(!0)},getMetadata:function getMetadataFn(key,cb){var inMemEntry=this._super.getMetadata.call(this,key)||void 0;cb&&cb(inMemEntry)},count:function countFn(cb){try{g.PAssert(3302,cb,"Must provide a valid callback")}catch(PERR){g.reportError(PERR)}var inMemCount=this._super.count.call(this);cb&&cb(inMemCount)},size:function sizeFn(cb){try{g.PAssert(3303,cb,"Must provide a valid callback")}catch(PERR){g.reportError(PERR)}var inMemSize=this._super.size.call(this);cb&&cb(inMemSize)},loadAll:function loadAllFn(cb){this._super.loadAll.call(this),cb&&cb(!0)},getEntrySync:function getEntrySyncFn(id){try{g.PAssert(3304,id,"Must provide a valid ID to get")}catch(PERR){g.reportError(PERR)}var inMemEntry=this._super.getEntrySync.call(this,id)||void 0;return inMemEntry},getEntry:function getEntryFn(id,cb){try{g.PAssert(3305,id,"Must provide a valid ID to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3306,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}var inMemEntry=this._super.getEntry.call(this,id)||void 0;cb&&cb(inMemEntry,id)},getBoundEntries:function getBoundEntriesFn(index,spanStart,spanEnd,cb){try{g.PAssert(3307,index,"Must specify a valid index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3308,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}var inMemEntries=this._super.getBoundEntries.call(this,index,spanStart,spanEnd)||[];cb&&cb(inMemEntries)},getFilterEntries:function getFilterEntriesFn(filterFn,cb){try{g.PAssert(3309,g.isFunction(filterFn),"Must specify a valid filter function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3310,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}var inMemEntries=this._super.getFilterEntries.call(this,filterFn)||[];cb&&cb(inMemEntries)},removeEntry:function removeEntryFn(id,cb){try{g.PAssert(3311,id,"Must provide valid data id")}catch(PERR){g.reportError(PERR)}this._super.removeEntry.call(this,id),cb&&cb(!0)},hasEntry:function hasEntryFn(id,cb){var inMemEntry=this._super.hasEntry.call(this,id);cb&&cb(inMemEntry)},cacheEntry:function cacheEntryFn(id,data,cb){try{g.PAssert(3312,id,"Must provide valid data id")}catch(PERR){g.reportError(PERR)}this._super.cacheEntry.call(this,id,data),cb&&cb(!0)},clearCache:function clearCacheFn(cb){this._super.clearCache.call(this),cb&&cb(!0)},clearMetadata:function clearMetadataFn(cb){this._super.clearMetadata.call(this),cb&&cb(!0)},clearBackingStore:function clearBackingStoreFn(cb){cb&&cb(!0)}};return util.inherit(LocalCache,LocalCacheMemory),util.extend(LocalCacheMemory.prototype,LocalCacheMemoryFns),LocalCacheMemory}),define("LocalCacheIDB",["globals","util","data","LocalCache"],function(g,util,d,LocalCache){function LocalCacheIDB(cacheId,name,options){this._db=void 0,this._cacheTable=void 0,this._metadataTable=void 0,this._version=2,this._schema=this._getDefaultSchema(),this._super.constructor.call(this,cacheId,name,options)}var metadataPrefix="Meta_Moo_",LocalCacheIDBFns={_makeID:function _makeIDFn(id){return id},validID:function validIDFn(id){return!0},_metadataID:function _metadataIDFn(key){return key},getStorageType:function getStorageTypeFn(){return StorageType.IndexedDB},_migrateEntry:function _migrateEntryFn(data,successCB,failureCB){delete data.cid,this._cacheTable.update(data).done(successCB).fail(failureCB)},_migrateMetadata:function _migrateMetadataFn(metadata,successCB,failureCB){delete metadata.cid,this._super.setMetadata.call(this,metadata.id,metadata.value),this._metadataTable.update(metadata).done(successCB).fail(failureCB)},_runMigration:function _runMigrationFn(cb){d.onCachesAvailable(function(){var legacyTable=d.openCacheTable(this._id);legacyTable.query().bound(this._id,this._id+"￿").execute().done(function(entries){function _updateComplete(){updatesDoneRequesting&&numUpdatesSuccess+numUpdatesFail===numUpdatesExpected&&(log("Migration Completed: ",numUpdatesSuccess,numUpdatesFail,numUpdatesExpected,updatesDoneRequesting),d.closeCacheTable(tableID),cb(!0))}function updateCompleteSuccess(){numUpdatesSuccess++,_updateComplete()}function updateCompleteFailure(err){numUpdatesFail++,_updateComplete()}for(var updatesDoneRequesting=!1,numUpdatesSuccess=0,numUpdatesFail=0,numUpdatesExpected=0,tableID=this._id,i=0;entries&&i<entries.length;++i)legacyTable.remove(entries[i].cid),this._migrateEntry(entries[i],updateCompleteSuccess,updateCompleteFailure),numUpdatesExpected++;legacyTable.query().bound(metadataPrefix,metadataPrefix+"￿").execute().done(function(metadata){for(var i=0;metadata&&i<metadata.length;++i)metadata[i].cid.endsWith(this._id)&&(legacyTable.remove(metadata[i].cid),this._migrateMetadata(metadata[i],updateCompleteSuccess,updateCompleteFailure),numUpdatesExpected++);updatesDoneRequesting=!0,_updateComplete()}.bind(this))}.bind(this))}.bind(this))},open:function openFn(){this._super.open.call(this),d.openCacheDatabase(this._id,this._version,this._schema,function(db){try{g.PAssert(3313,!this._db,"Should not open the cache DB twice")}catch(PERR){g.reportError(PERR)}db&&(this._db=db,this._cacheTable=db.cache,this._metadataTable=db.metadata),g.vmMain.cacheManager.needsMigration()?this._runMigration(function(success){log("Cache data migrated: ",this._id),this.notifyCacheMetadataReady(!!db),this.notifyCacheReady(!!db)}.bind(this)):(this.notifyCacheMetadataReady(!!db),this.notifyCacheReady(!!db))}.bind(this))},close:function closeFn(){this._super.close.call(this),this._db.close(),this._db=void 0,this._cacheTable=void 0,this._metadataTable=void 0},isReady:function isReadyFn(){return this._super.isReady.call(this)&&this._db&&this._cacheTable},isMetadataReady:function isMetadataReadyFn(){return this._super.isReady.call(this)&&this._db&&this._metadataTable},notifyCacheReady:function notifyCacheReadyFn(success){this._super.notifyCacheReady.call(this,success)},notifyCacheMetadataReady:function notifyCacheMetadataReadyFn(success){this._super.notifyCacheMetadataReady.call(this,success)},setMetadata:function setMetadataFn(key,value,cb){if(this._super.setMetadata.call(this,key,value),this.isMetadataReady()){var entry={id:key,value:value};this._metadataTable.update(entry).done(function(){cb&&cb(!0)}).fail(function(obj,ev){this.onCacheError(ev),cb&&cb(!1)}.bind(this))}else cb&&cb(!1)},removeMetadata:function removeMetadataFn(key,cb){this._super.removeMetadata.call(this,key),this.isMetadataReady()?this._metadataTable.remove(this._metadataID(key)).done(function(){cb&&cb(!0)}).fail(function(err){log("IDB removeMetadata Error: ",err),cb&&cb(!1)}):cb&&cb(!1)},getMetadata:function getMetadataFn(key,cb){var inMemEntry=this._super.getMetadata.call(this,key);inMemEntry?cb(inMemEntry):this.isMetadataReady()?this._metadataTable.query().only(this._metadataID(key)).limit(1).execute().done(function(metadata){var value;metadata&&1===metadata.length&&(value=metadata[0].value),cb(value)}).fail(function(err){log("IDB getMetadata Error: ",err),cb(void 0)}):cb(void 0)},count:function countFn(cb){this.isReady()?this._cacheTable.query().all().count().execute().done(function(count){cb(count)}).fail(function(err){cb()}):cb()},size:function sizeFn(cb){this.isReady()?this._cacheTable.query().all().execute().done(function(entries){for(var size=0,i=0;i<entries.length;++i)size+=this._entrySize(entries[i]);cb(size)}).fail(function(err){cb()}):cb()},loadAll:function loadAllFn(cb){this.isReady()?this._cacheTable.query().all().execute().done(function(entries){for(var i=0;i<entries.length;++i)this._super.cacheEntry.call(this,entries[i].id,entries[i]);this._super.loadAll.call(this),cb(!0)}.bind(this)).fail(function(err){log("IDB loadAll Error: ",err),this._super.loadAll.call(this),cb(!1)}):cb(!1)},getEntrySync:function getEntrySyncFn(id){try{g.PAssert(3314,!1,"Sync access to IDB is not supported")}catch(PERR){g.reportError(PERR)}return void 0},getEntry:function getEntryFn(id,cb){try{g.PAssert(3315,id,"Must provide a valid ID to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3316,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}var inMemEntry=this._super.getEntry.call(this,id);inMemEntry?cb(inMemEntry):this.isReady()?this._cacheTable.query().only(this._makeID(id)).limit(1).execute().done(function(entries){var entry;entries&&1===entries.length&&(entry=entries[0],this._super.cacheEntry.call(this,id,entry)),cb(entry,id)}.bind(this)).fail(function(err){log("IDB getEntry Error: ",err),cb(void 0)}):cb(void 0)},getBoundEntries:function getBoundEntriesFn(index,spanStart,spanEnd,cb){try{g.PAssert(3317,index,"Must specify a valid index to query")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3318,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}this.isReady()?this._cacheTable.query().filter(function(entry){return entry[index]>=spanStart&&entry[index]<=spanEnd}).execute().done(function(entries){cb(entries)}.bind(this)).fail(function(err){cb(void 0)}.bind(this)):cb(void 0)},getFilterEntries:function getFilterEntriesFn(filterFn,cb){try{g.PAssert(3319,g.isFunction(filterFn),"Must specify a valid filter function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3320,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}this.isReady()?this._cacheTable.query().filter(filterFn).execute().done(function(entries){cb(entries)}.bind(this)).fail(function(err){cb(void 0)}.bind(this)):cb(void 0)},removeEntry:function removeEntryFn(id,cb){try{g.PAssert(3321,id,"Must provide valid data id")}catch(PERR){g.reportError(PERR)}this._super.removeEntry.call(this,id),this.isReady()?this._cacheTable.remove(this._makeID(id)).done(function(){cb&&cb(!0)}).fail(function(err){log("IDB removeEntry Error: ",err),cb&&cb(!1)}):cb&&cb(!1)},hasEntry:function hasEntryFn(id,cb){var inMemEntry=this._super.hasEntry.call(this,id);inMemEntry?cb(!0):this.isReady()?this._cacheTable.query().only(this._makeID(id)).limit(1).execute().done(function(entries){var entry;entries&&1===entries.length&&(entry=entries[0],this._super.cacheEntry.call(this,id,entry)),cb(!!entry)}.bind(this)).fail(function(err){log("IDB hasEntry Error: ",err),cb(!1)}):cb(!1)},_entrySize:function _entrySizeFn(rawEntry){var size=0;try{size=2*JSON.stringify(rawEntry).length}catch(err){g.reportError(err)}return size},cacheEntry:function cacheEntryFn(id,data,cb){try{g.PAssert(3322,id,"Must provide valid data id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3323,data.id,"Data must also contain a valid item id")}catch(PERR){g.reportError(PERR)}if(this._super.cacheEntry.call(this,id,data),this.isReady()){var entrySize;this._cacheTable.update(data).done(function(){cb&&cb(!0)}).fail(function(obj,ev){this.onCacheError(ev),cb&&cb(!1)}.bind(this))}else cb&&cb(!1)},clearCache:function clearCacheFn(cb){this._super.clearCache.call(this),this.isReady()?this._cacheTable.clear().done(function(){cb&&cb(!0)}).fail(function(err){log("IDB clearcache Error: ",err),cb&&cb(!1)}):cb&&cb(!1)},clearMetadata:function clearMetadataFn(cb){this._super.clearMetadata.call(this),this.isReady()?this._metadataTable.clear().done(function(){cb&&cb(!0)}.bind(this)).fail(function(err){log("IDB clearMetadata Error: ",err),cb&&cb(!1)}):cb&&cb(!1)},dumpData:function dumpDataFn(inMemory){inMemory?this._super.dumpData.call(this,inMemory):(console.log("-- Cache: ",this._id,"--"),this.isReady()?this._cacheTable.query().all().execute().done(function(entries){for(var i=0;i<entries.length;++i)console.log(entries[i])}).fail(function(err){console.log("Error running IDB query: ",err)}):console.log("Cache not ready"))},_getDefaultSchema:function _getDefaultSchemaFn(){return{cache:{key:{keyPath:"id"}},metadata:{key:{keyPath:"id"}}}},onCacheError:function onCacheErrorFn(ev){if(ev&&ev.target)try{var err=ev.target.error;"QuotaExceededError"===err.name&&g.vmMain.cacheManager.reportQuotaExceeded()}catch(errParse){g.reportError(errParse)}}};return util.inherit(LocalCache,LocalCacheIDB),util.extend(LocalCacheIDB.prototype,LocalCacheIDBFns),LocalCacheIDB}),define("LocalCacheLocalStorage",["globals","util","data","LocalCache","Dispatcher"],function(g,util,d,LocalCache,Dispatcher){function LocalCacheLocalStorage(cacheId,name,options){if(options){try{g.PAssert(3325,!options.noInMemoryCache,"Invalid in-memory cache option")}catch(PERR){g.reportError(PERR)}options.noInMemoryCache=!1,this.saveTime=isNaN(options.saveTime)?defaultSaveTime:options.saveTime,options.writeOnUnload&&Dispatcher.listen("onUnload",this.writeCache.bind(this)),options.clearBackingOnLoad&&(this.clearBackingOnLoad=!0,Dispatcher.listen("enterForeground",this.clearBackingStore.bind(this)))}else this.saveTime=defaultSaveTime;this._super.constructor.call(this,cacheId,name,options),this._saveTimeout=void 0,util.forceBind("writeCache",this)}var defaultSaveTime=5e3,dbPrefix="MDC_",LocalCacheLocalStorageFns={_localStorageKey:function _localStorageKeyFn(){return dbPrefix+this._id},_onWrite:function _onWriteFn(forceWrite){forceWrite||0===this.saveTime?(this._saveTimeout&&(clearTimeout(this._saveTimeout),this._saveTimeout=void 0),this.writeCache()):this.saveTime>=0&&(this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(this.writeCache,this.saveTime))},writeCache:function writeCacheFn(){var timeStart=performance.now(),cacheData={metadata:this._getRawInMemoryMetadata(),cache:this._getRawInMemoryCache()},cacheStr;try{cacheStr=JSON.stringify(cacheData),util.storage.setItem(this._localStorageKey(),cacheStr)}catch(err){g.reportError(err)}},close:function closeFn(){this._onWrite(!0),this._super.close.call(this)},getStorageType:function getStorageTypeFn(){return StorageType.LocalStorage},setMetadata:function setMetadataFn(key,value,cb){this._super.setMetadata.call(this,key,value),this._onWrite(),cb&&cb(!0)},getMetadata:function getMetadataFn(key,cb){var inMemEntry=this._super.getMetadata.call(this,key)||void 0;
cb&&cb(inMemEntry)},count:function countFn(cb){try{g.PAssert(3326,cb,"Must provide a valid callback")}catch(PERR){g.reportError(PERR)}var inMemCount=this._super.count.call(this);cb&&cb(inMemCount)},size:function sizeFn(cb){try{g.PAssert(3327,cb,"Must provide a valid callback")}catch(PERR){g.reportError(PERR)}var inMemSize=this._super.size.call(this);cb&&cb(inMemSize)},loadAll:function loadAllFn(cb){try{var cacheStr=util.storage.getItem(this._localStorageKey());if(cacheStr){var cacheData=JSON.parse(cacheStr);this._setRawInMemoryMetadata(cacheData.metadata),this._setRawInMemoryCache(cacheData.cache)}this._super.loadAll.call(this),this.clearBackingOnLoad&&this.clearBackingStore(),cb&&cb(!0)}catch(err){g.reportError(err),this._super.loadAll.call(this),cb&&cb(!1)}},getEntrySync:function getEntrySyncFn(id){try{g.PAssert(3328,id,"Must provide a valid ID to get")}catch(PERR){g.reportError(PERR)}var inMemEntry=this._super.getEntrySync.call(this,id)||void 0;return inMemEntry},getEntry:function getEntryFn(id,cb){try{g.PAssert(3329,id,"Must provide a valid ID to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3330,cb,"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}var inMemEntry=this._super.getEntry.call(this,id)||void 0;cb&&cb(inMemEntry,id)},getBoundEntries:function getBoundEntriesFn(index,spanStart,spanEnd,cb){var inMemEntries=this._super.getBoundEntries.call(this,index,spanStart,spanEnd);cb&&cb(inMemEntries)},getFilterEntries:function getFilterEntriesFn(filterFn,cb){var inMemEntries=this._super.getFilterEntries.call(this,filterFn);cb&&cb(inMemEntries)},removeEntry:function removeEntryFn(id,cb){try{g.PAssert(3331,id,"Must provide valid data id")}catch(PERR){g.reportError(PERR)}this._super.removeEntry.call(this,id),this._onWrite(),cb&&cb(!0)},hasEntry:function hasEntryFn(id,cb){var inMemEntry=this._super.hasEntry.call(this,id);cb&&cb(inMemEntry)},cacheEntry:function cacheEntryFn(id,data,cb){try{g.PAssert(3332,id,"Must provide valid data id")}catch(PERR){g.reportError(PERR)}this._super.cacheEntry.call(this,id,data),this._onWrite(),cb&&cb(!0)},clearCache:function clearCacheFn(cb){this._super.clearCache.call(this),this._onWrite(!0),cb&&cb(!0)},clearMetadata:function clearMetadataFn(cb){this._super.clearMetadata.call(this),this._onWrite(),cb&&cb(!0)},clearBackingStore:function clearBackingStoreFn(cb){util.storage.removeItem(this._localStorageKey()),cb&&cb(!0)}};return util.inherit(LocalCache,LocalCacheLocalStorage),util.extend(LocalCacheLocalStorage.prototype,LocalCacheLocalStorageFns),LocalCacheLocalStorage}),define("CacheManager",["globals","util","data","LocalCache","LocalCacheMemory","LocalCacheIDB","LocalCacheLocalStorage"],function(g,util,d,LocalCache,LocalCacheMemory,LocalCacheIDB,LocalCacheLocalStorage){var CacheManager=function(){this._reportedQuotaError=!1,this._migrationRequired=!1,this._registeredCaches={},this._storageReady=[],this.init()};return CacheManager.prototype={init:function initFn(){this._storageReady[StorageType.InMemory]=!0,this._storageReady[StorageType.LocalStorage]=!0},getInfo:function getInfoFn(){return{reportedQuoteError:this._reportedQuotaError,migrationRequired:this._migrationRequired,numCaches:Object.keys(this._registeredCaches).length}},registerLocalCache:function registerLocalCacheFn(id,name,storageType,options){try{g.PAssert(3333,id,"Must provide a valid cache ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3334,name,"Must have a valid cache name")}catch(PERR){g.reportError(PERR)}var cacheId=this._createCacheId(id,name);try{g.PAssert(3336,void 0===this._registeredCaches[cacheId],"Must not have a previously registered cache with the same id")}catch(PERR){g.reportError(PERR)}g.shouldWriteLocal()||(storageType=StorageType.InMemory);var cache;switch(storageType){case StorageType.InMemory:cache=new LocalCacheMemory(cacheId,name,options);break;case StorageType.LocalStorage:cache=new LocalCacheLocalStorage(cacheId,name,options);break;case StorageType.IndexedDB:cache=new LocalCacheIDB(cacheId,name,options)}try{g.PAssert(3337,cache,"Must have valid cache after creation")}catch(PERR){g.reportError(PERR)}return this._registeredCaches[id]=cache,this._storageReady[storageType]&&(cache.notifyCacheMetadataReady(!0),cache.notifyCacheReady(!0)),cache},clearLocalCache:function clearLocalCacheFn(id,clearMetadata){var cache=this._registeredCaches[id];try{g.PAssert(3338,cache,"Must have valid local cache")}catch(PERR){g.reportError(PERR)}cache.clearCache(),clearMetadata&&cache.clearMetadata()},clearLocalCaches:function clearLocalCachesFn(clearMetadata){for(var id in this._registeredCaches)this.clearLocalCache(id,clearMetadata)},clearPerDocCaches:function clearPerDocCachesFn(clearMetadata){for(var id in this._registeredCaches){var cache=this._registeredCaches[id];cache.isPerDoc()&&this.clearLocalCache(id,clearMetadata)}},_notifyIDBReady:function _notifyIDBReadyFn(success){},_createCacheId:function _createCacheIdFn(id,name){return id},notifyMigrationRequired:function notifyMigrationRequiredFn(){this._migrationRequired=!0},needsMigration:function needsMigrationFn(){return this._migrationRequired||5===g.settings.get(Settings.localDataVersion)},reportQuotaExceeded:function reportQuotaExceededFn(){this._reportedQuotaError||(this._reportedQuotaError=!0,g.reportError(new Error("Quota exceeded!")))}},new CacheManager}),define("VMLIElement",["globals","util"],function(g,util){function VMLIElement(parsedText,attrs){this._parsedText=parsedText,this._textLength=parsedText.length,this._attrs=attrs}var VMLIElementFns={getParsedText:function getParsedTextFn(){return this._parsedText},getOrigTextLength:function getOrigTextLengthFn(){return this._textLength},setParsedText:function setParsedTextFn(parsedText){this._parsedText=parsedText},getStyledText:function getStyledTextFn(pane,maxWidth){var styledText;if(this.getAttr("plugin")){try{g.PAssert(3339,this.getAttr("plugin-id"),"If a plugin is specified, must have the ID for that plugin as well")}catch(PERR){g.reportError(PERR)}var plugin=g.vmMain.pluginManager.getPlugin(this._attrs.plugin),attach=plugin.getAttachment(this.getAttr("plugin-id"));styledText=plugin._getDisplayText(attach,pane,maxWidth)}else styledText=g.escape(this._parsedText);return styledText},getAttrs:function getAttrsFn(){return this._attrs},getAttr:function getAttrFn(attr){var value;return this._attrs&&(value=this._attrs[attr]),value},hasAttrs:function hasAttrsFn(){return!!this._attrs},getClasses:function getClassesFn(){var classes;return this._attrs&&(classes=this._attrs.cls),classes},hasClasses:function hasClassesFn(){var classes=this.getClasses();return!!classes&&classes.length>0},hasClass:function hasClassFn(cls){var hasClass=!1,classes=this.getClasses();return classes&&(hasClass=classes.indexOf(cls)>=0),hasClass},getClassString:function getClassStringFn(){var classStr="",classes=this.getClasses();return classes&&(classStr=classes.join(" ")),classStr},addClass:function addClassFn(cls){this._attrs||(this._attrs={}),this._attrs.cls||(this._attrs.cls=[]),this._attrs.cls.push(cls)},mergeAttrs:function mergeAttrsFn(attrs){if(attrs){if(!this._attrs)return void(this._attrs=attrs);attrs.cls&&(this._attrs.cls?this._attrs.cls.pushArray(attrs.cls):this._attrs.cls=attrs.cls);try{g.PAssert(3340,void 0===this._attrs.plugin||void 0===attrs.plugin||this._attrs.plugin===attrs.plugin,"A single element cannot match multiple plugins")}catch(PERR){g.reportError(PERR)}this._attrs.plugin=this._attrs.plugin||attrs.plugin;try{g.PAssert(3341,void 0===this._attrs["plugin-id"]||void 0===attrs["plugin-id"]||this._attrs["plugin-id"]===attrs["plugin-id"],"A single element cannot match multiple plugins")}catch(PERR){g.reportError(PERR)}this._attrs["plugin-id"]=this._attrs["plugin-id"]||attrs["plugin-id"]}}};return util.extend(VMLIElement.prototype,VMLIElementFns),VMLIElement}),define("DuchessHelpers",["globals","VMLIElement"],function(g,VMLIElement){function enumToString(en,value){for(var k in en)if(en[k]===value)return k;return null}function DuchessHelpers(){}var punctuation=", . ? ! ) ( : ; [ ] ' \"".split(" "),cmdChar=-1===navigator.userAgent.indexOf("Mac")?"ctrl":"⌘",isParsing=0,charMap={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"},validProtocols=["http","https","evernote","onenote"];window.__PARSE_STATS={total:0,parseText:0,parseNote:0,parseSinglePlugin:0};var DAY_LENGTH=864e5,forceCompleteTime=new Date(9e12).getTime(),minStartDate=new Date(1401606e6),softDateRegexp=/^(today|tomorrow|yesterday|(?:sun|mon|tue(?:s)?|wed(?:nes)?|thu(?:rs)?|fri|sat(?:ur)?)(?:day)?)/i,timeRegexp=/^(?:(?:([0]?[1-9]|1[0-2])(?::([0-5]\d))?(?:\s)?(am?|pm?|\b))|(?:([0]?\d|1\d|2[0-3]):([0-5]\d)))$/i,tagRegexp=/(^#|[\(\s-]#)([^\s\),]+)/g,dateRegexp=/(?:^@|[\(\s]@)([^\s\)]{2,})(\s[^\s\)@]{1,})?(\s[^\s\)@]{1,})?/g,linkRegexp=/\b((?:(https?|evernote|onenote):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/g,minLinkRegexp=/(?:^|[\s\(\[])([^\(\[#@\s]+\.(?:com|org|net|io))/gi,pluginRegexp=/(?:(?:\u2001|\u2003)(p:[^\u2001\u2003]+)(?:\u2001|\u2003))/gi,dToken={repeat:/^(ev(ery)?|after)\b/i,recur:/^(other|first|second|third|fourth|1st|2nd|3rd|4th|last)$/i,day:/^(((sun|mon|tue(s)?|wed(nes)?|thu(rs)?|fri|sat(ur)?)(day)?)(?:,|\sand\s)?)$/i,daysOfWeek:/^(weekday|weekend)$/i,len:/^(day|week|month|year|morning|afternoon|night)$/i,count:/^((\d{1,2})|one|two|three|four|five|six|seven|eight|nine|ten)$/i,month:/^(jan(uary)?|feb(ruary)?|ma((r(ch)?)?|y)|apr(il)?|ju(ly|ne)|aug(ust)?|oct(ober)?|(sept|nov|dec)(ember)?)$/i,at:/^at$/i,of:/^of$/i,"in":/^in$/i,delim:/^and$/i,date:/^((\d{1,2})|([2-5]?1(st)?|[2-5]?2(nd)?|[2-5]?3(rd)?|(0|[1-5]?[4-9]|[1-5]0|1[1-3])(th)?))$/i,year:/^((\d\d)|(\d\d\d\d))$/i,time:timeRegexp,from:/^(from|starting)$/i,until:/^(until)$/i,measure:/^(days|weeks|months|years)$/i},dTokenValue={"1st":1,fir:1,"2nd":2,sec:2,"3rd":3,thi:3,"4th":4,fou:4,sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,days:RepeatFreq.Daily,weeks:RepeatFreq.Weekly,months:RepeatFreq.Monthly,years:RepeatFreq.Yearly},durationValue={h:1,hr:1,hrs:1,hour:1,hours:1,Hours:1,m:2,min:2,mins:2,Minutes:2,d:3,day:3,days:3,Days:3,"-":1,until:1,to:1,till:1,EndDate:1,"for":2,Duration:2},durationToken={duration:/^(-\s|(?:for|until|to|till)\b)/i,len:/^(\d{1,3}(?:\.\d{1,2})?)(h(?:(?:ou)?r(?:s)?)?|m(?:in(?:s)?)?|d(?:ay(?:s)?)?)$/i},lastToken,dateCharsConsumed=0,dateCharsFromString=0,dateTokens,dateTokenOffset=1,dateParsedDate;return DuchessHelpers.prototype={isFlagSet:function isFlagSetFn(data,mask){return(data&mask)===mask},trimPunc:function trimPuncFn(str){var outStr=str.replace(/[:,\.\'\"\)\]]$/g,"");return outStr},generateStyledLines:function generateStyledLinesFn(els,lines,pane,maxWidth){for(var lineEls=this.linesToEls(els,lines),arr=[],i=0;i<lineEls.length;++i)arr.push(this.generateHTML(lineEls[i],!1,pane,maxWidth));return arr},linesToEls:function linesToElsFn(els,lines){for(var arr=[],line=[],i=0;i<lines.length;++i){for(var strIndex=0,lineStart=lines[i].start,lineLength=lines[i].length,lineIndex=0,u=0;u<els.length;++u){var el=els[u],elLength=el.getParsedText().length,start=Math.max(lineStart-strIndex,0);if(elLength>start){var length=Math.min(elLength-start,lineLength-lineIndex);if(length>0){var text=el.getParsedText().substr(start,length);line.push(new VMLIElement(text,el.getAttrs())),lineIndex+=length}}strIndex+=elLength}arr.push(line),line=[]}return arr},replaceTextInEls:function replaceTextInElsFn(els,replacedParsedText,start,length){try{g.PAssert(3342,g.isArray(els),"Must supply a valid VMLIElement array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3343,replacedParsedText,"Must be replacing at least one of parsed or styled text")}catch(PERR){g.reportError(PERR)}for(var strIndex=0,i=0;i<els.length;++i){var el=els[i],text=el.getParsedText();if(start+length>=strIndex&&start<strIndex+el.getOrigTextLength()){var localStart=start-strIndex,localLength=Math.min(length,text.length-localStart),startText=text.substr(0,localStart),endText=text.substr(localStart+localLength);replacedParsedText&&el.setParsedText(startText+replacedParsedText+endText);break}strIndex+=el.getOrigTextLength()}},insertEl:function insertElFn(els,attrs,start,length){try{g.PAssert(3344,g.isArray(attrs.cls),"Must always pass in a valid classes array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3345,g.isNumber(start),"Must have a valid start")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3346,g.isNumber(length),"Must have a valid length")}catch(PERR){g.reportError(PERR)}for(var strIndex=0,newElement,i=0;i<els.length;++i){var el=els[i],text=el.getParsedText();if(start+length>=strIndex&&start<strIndex+el.getOrigTextLength()){var newEls=[],localStart=start-strIndex,localLength=Math.min(length,text.length),lastStart=localStart+length,lastLength=text.length-lastStart;if(localStart>0){var sText=text.substr(0,localStart);newEls.push(new VMLIElement(sText,el.getAttrs()))}var mText=text.substr(localStart,localLength);if(newElement=new VMLIElement(mText,el.getAttrs()),newElement.mergeAttrs(attrs),newEls.push(newElement),lastLength>0){var lText=text.substr(lastStart,lastLength);newEls.push(new VMLIElement(lText,el.getAttrs()))}Array.prototype.splice.apply(els,[i,1].concat(newEls));break}strIndex+=el.getOrigTextLength()}return newElement},generateHTML:function generateHTMLFn(els,convertSpaces,pane,maxWidth){for(var arr=[],i=0;i<els.length;++i){var el=els[i],attrs=el.getAttrs(),attrsStr="",clsStr,text=el.getStyledText(pane,maxWidth);if(convertSpaces&&(text=text&&text.replace(/ /g,"&nbsp;")),attrs){var start,end,cls=el.getClassString();el.hasClass("link")?(start="<span ",end='tooltip="'+cmdChar+' + click to open">'+text+"</span>"):el.hasClass("plugin")?(start="<span ",end="><span>"+text+"</span></span>"):(start="<span ",end=">"+text+"</span>");for(var key in attrs)attrs.hasOwnProperty(key)&&("cls"===key?clsStr='class="'+cls+'" ':attrsStr+=key+'="'+attrs[key]+'" ');arr.push(start+(clsStr?clsStr:"")+(attrsStr?" "+attrsStr:"")+end)}else arr.push(text)}return arr.join("")},getNowRelativeDate:function getNowRelativeDateFn(date){var retDate;switch(date.toUpperCase()){case"NOW":retDate=Date.today().add({hours:11});break;case"NEXT":retDate=Date.today().add({hours:12});break;case"SOON":retDate=Date.today().add({days:1,hours:12});break;case"LATER":retDate=Date.today().add({days:3,hours:12});break;case"SOMEDAY":retDate=Date.today().add({days:4,hours:12});break;default:try{g.PAssert(3347,!1,"Must supply a valid now relative date string")}catch(PERR){g.reportError(PERR)}}return retDate},_notifyParse:function _notifyParseFn(type){__PARSE_STATS.total++,__PARSE_STATS[type]++},parseSinglePlugin:function parseSinglePluginFn(gmailText){if(this._notifyParse("parseSinglePlugin"),!gmailText||0===gmailText.length)return{parsedText:void 0,els:[]};try{g.PAssert(3348,!isParsing,"We do not support recursive calls to parse")}catch(PERR){g.reportError(PERR)}isParsing++;var els,attachments;pluginRegexp.lastIndex=0;var match;if(null!==(match=pluginRegexp.exec(gmailText))){var obj=g.vmMain.pluginManager.parseAttachmentEmbedString(match[1]);try{g.PAssert(3349,obj,"Must have a valid object")}catch(PERR){g.reportError(PERR)}attachments=[obj],gmailText=window.AttachChar,els=[new VMLIElement(window.AttachChar,obj.displayElement.attrs)]}else els=[new VMLIElement(gmailText)];return isParsing--,{parsedText:gmailText,attachments:attachments,els:els}},parseNote:function parseNoteFn(noteText){return this._notifyParse("parseNote"),{parsedText:noteText,els:[new VMLIElement(noteText.split("\n")[0])]}},parseText:function parseTextFn(itemText,prevDate,prevRepeatDate,prevDateText,completedTime,changeType,contactsList,noRepeated){if(this._notifyParse("parseText"),!itemText||0===itemText.length)return{parsedText:void 0,els:[]};try{g.PAssert(3350,!isParsing,"We do not support recursive calls to parse")}catch(PERR){g.reportError(PERR)}isParsing++;var hasDiffParse=!1,parsedText=itemText,numContacts=0,els=[new VMLIElement(itemText)],match,tags,dates,attachments,durations,i,u;if(contactsList&&contactsList.___info___.count>0&&parsedText.indexOf(ContactPrefix)>=0){var words=parsedText.split(" "),lineIndex=0,matchedName;for(i=0;i<words.length;i++){if(0===words[i].indexOf(ContactPrefix)){matchedName=void 0;var combined=words[i].substring(1);for(u=1;;u++){if(""===contactsList[combined])matchedName=combined;else{var compStr=this.trimPunc(combined);""===contactsList[compStr]&&(matchedName=compStr)}if(!(i+u<words.length))break;combined+=" "+words[i+u]}matchedName&&(numContacts++,this.insertEl(els,{cls:["contact"]},lineIndex,matchedName.length+1))}lineIndex+=words[i].length+1}}for(tagRegexp.lastIndex=0;null!==(match=tagRegexp.exec(parsedText));){var matchIndex=match.index+match[1].length-1,matchLength=match[2].length+1;punctuation.indexOf(match[2].charAt(match[2].length-1))>=0&&matchLength--,tags?tags.push(match[2]):tags=[match[2]],this.insertEl(els,{cls:["tag"]},matchIndex,matchLength)}for(dateRegexp.lastIndex=0;null!==(match=dateRegexp.exec(parsedText));){var prefixLength=match[0].indexOf(DatePrefix),dateString,puncFound=!1;for(i=1;i<match.length&&match[i];++i)if(puncFound)match[i]=void 0;else{var lastChar=match[i][match[i].length-1];punctuation.indexOf(lastChar)>=0&&(match[i]=match[i].slice(0,-1),puncFound=!0)}var repeatDateInfo=!noRepeated&&this.parseRepeatDate(prevRepeatDate,prevDateText,completedTime,changeType,parsedText.substr(match.index+prefixLength+1)),parsedDateIndex;if(repeatDateInfo||match[1].startsWith("every")||"in"===match[1]){if(repeatDateInfo){parsedDateIndex=match.index+prefixLength,repeatDateInfo.replacedStartDate?(this.insertEl(els,{cls:["date"]},parsedDateIndex,repeatDateInfo.repLength+1),this.replaceTextInEls(els,repeatDateInfo.text,parsedDateIndex+1,repeatDateInfo.repLength),parsedText=parsedText.substr(0,parsedDateIndex+1)+repeatDateInfo.text+parsedText.substr(parsedDateIndex+repeatDateInfo.repLength+1),hasDiffParse=!0):this.insertEl(els,{cls:["date"]},parsedDateIndex,repeatDateInfo.repLength+prefixLength+1),dates?dates.push(repeatDateInfo):dates=[repeatDateInfo];break}}else{var dateStringInfo=[match[1]?match[1]:"",match[2]?match[2]:"",match[3]?match[3]:""];if(g.isDateSoft(dateStringInfo[0])){var isNowRelative=!0;"NEXT"===dateStringInfo[0].toUpperCase()&&this.runDateParse(dateStringInfo)&&(isNowRelative=!1),isNowRelative&&(prevDate=this.getNowRelativeDate(dateStringInfo[0]),dateStringInfo[1]="",dateStringInfo[2]="")}var newDateInfo=this.computeDateInfo(prevDate,prevDateText,changeType,dateStringInfo);if(newDateInfo.isValid){var dateObj;parsedDateIndex=match.index+prefixLength,newDateInfo.replacedDate?(this.insertEl(els,{cls:["date"]},parsedDateIndex,newDateInfo.oldText.length+1),this.replaceTextInEls(els,newDateInfo.text,parsedDateIndex+1,newDateInfo.oldText.length),parsedText=parsedText.substr(0,parsedDateIndex+1)+newDateInfo.text+parsedText.substr(parsedDateIndex+newDateInfo.oldText.length+1),hasDiffParse=!0,dateObj={type:DateType.Once,date:newDateInfo.date,origText:newDateInfo.oldText,text:newDateInfo.text,explicitTime:newDateInfo.date.hasTimeOfDay()}):(this.insertEl(els,{cls:["date"]},parsedDateIndex,newDateInfo.text.length+1),dateObj={type:DateType.Once,date:newDateInfo.date,origText:newDateInfo.oldText,text:newDateInfo.text,explicitTime:newDateInfo.date.hasTimeOfDay()}),dates?dates.push(dateObj):dates=[dateObj];var durationIndex=parsedDateIndex+newDateInfo.text.length+1,durationCandidate=parsedText.substr(durationIndex),durationInfo=this.parseDuration(newDateInfo.date,durationCandidate);durationInfo&&(this.insertEl(els,{cls:["duration"]},durationIndex,durationInfo.durationText.length+1),durations?durations.push(durationInfo):durations=[durationInfo]);break}}}if(linkRegexp.lastIndex=0,null!==(match=linkRegexp.exec(parsedText))){var hasProtocol=validProtocols.indexOf(match[2])>=0,linkHref=hasProtocol?match[0]:"http://"+match[0];this.insertEl(els,{cls:["link"],"data-href":linkHref},match.index,match[0].length)}else if(minLinkRegexp.lastIndex=0,null!==(match=minLinkRegexp.exec(parsedText))){var prefixLength=match[0].length-match[1].length,linkHref=match[1].startsWith("http")?match[1]:"http://"+match[1];this.insertEl(els,{cls:["link"],"data-href":linkHref},match.index+prefixLength,match[1].length)}for(pluginRegexp.lastIndex=0;null!==(match=pluginRegexp.exec(parsedText));){var obj=g.vmMain.pluginManager.parseAttachmentEmbedString(match[1]);try{g.PAssert(3351,obj,"Must have a valid object")}catch(PERR){g.reportError(PERR)}var createdEl=this.insertEl(els,obj.displayElement.attrs,match.index,match[0].length);this.replaceTextInEls(els,window.AttachChar,match.index,match[0].length);var elIndex=els.indexOf(createdEl);elIndex>0&&createdEl.addClass("padB"),elIndex<els.length-1&&createdEl.addClass("padA"),hasDiffParse=!0,attachments?attachments.push(obj):attachments=[obj]}attachments&&(pluginRegexp.lastIndex=0,parsedText=parsedText.replace(pluginRegexp,window.AttachChar));var ret={parsedText:hasDiffParse?parsedText:void 0,dates:dates,durations:durations,tags:tags,attachments:attachments,numContacts:numContacts,els:els};return isParsing--,ret},getDurationLength:function getDurationLengthFn(durationString){var parts=durationToken.len.exec(durationString),numUnits=parseFloat(parts[1]),len=0;switch(durationValue[parts[2].toLowerCase()]){case durationValue.Hours:len=g.hours(numUnits);break;case durationValue.Minutes:len=g.minutes(numUnits);break;case durationValue.Days:len=g.days(numUnits);break;default:try{g.PAssert(3352,!1,"Invalid duration length: "+parts[2])}catch(PERR){g.reportError(PERR)}}return len},parseDuration:function parseDurationFn(startDate,durationString){this.setDateTokens(durationString);var duration=0;if(this.checkAndParse(durationToken.duration))if(durationValue[lastToken.toLowerCase()]===durationValue.EndDate)if(this.checkAndParse(timeRegexp,2)){var timeInfo=this.getTimeFromString(lastToken),endDate=startDate.clone();endDate.setHours(timeInfo.hour),endDate.setMinutes(timeInfo.min),duration=endDate-startDate}else this.checkAndParseDate()&&(duration=dateParsedDate-startDate);else if(durationValue[lastToken.toLowerCase()]===durationValue.Duration)for(;this.checkAndParse(durationToken.len);)duration+=this.getDurationLength(lastToken);else try{g.PAssert(3353,!1,"Invalid duration token: "+lastToken)}catch(PERR){g.reportError(PERR)}else for(;this.checkAndParse(durationToken.len);)duration+=this.getDurationLength(lastToken);var durationInfo;return duration>0&&(durationInfo={durationText:durationString.substr(1,dateCharsConsumed).trim(),duration:duration}),durationInfo},getSoftText:function getSoftTextFn(date,diff){return 0>diff?diff>=-DAY_LENGTH?"yesterday":date.toString(Date.CultureInfo.formatPatterns.monthDayYear):DAY_LENGTH>=diff&&date.isToday()?"today":2*DAY_LENGTH>diff?"tomorrow":void 0},runDateParse:function runDateParseFn(dateStringInfo){var dateString=dateStringInfo.join(""),dt=Date.parse(dateString);return!dt&&dateStringInfo[1]&&(dateString=dateStringInfo[0]+dateStringInfo[1],dt=Date.parse(dateString)),!dt&&dateStringInfo[0]&&(dateString=dateStringInfo[0],dt=Date.parse(dateString)),{dt:dt,dateString:dateString}},computeDateInfo:function computeDateInfoFn(prevDate,prevDateText,changeType,dateStringInfo){var prevDateTime=new Date(prevDate).clearTime(),currentDateTime=(new Date).clearTime(),diff=prevDateTime-currentDateTime,dateString=prevDateText||dateStringInfo.join(""),finalString=dateString,replacedDate=!1,newDate,transString;if(this.isFlagSet(changeType,ChangeType.Auto)){if(newDate=new Date(prevDate),void 0!==prevDate&&(0>diff||diff>=0&&2*DAY_LENGTH>diff)){var softMatch;if(softDateRegexp.lastIndex=0,null!==(softMatch=softDateRegexp.exec(dateString))){if(transString=this.getSoftText(newDate,diff),transString&&!dateString.toUpperCase().startsWith(transString.toUpperCase())){if(void 0===prevDateText){var parseInfo=this.runDateParse(dateStringInfo);dateString=parseInfo.dateString}finalString=dateString.replace(softMatch[0],transString),replacedDate=!0}}else if(null!==(softMatch=timeRegexp.exec(dateString))){if(transString=this.getSoftText(newDate,diff),transString&&"today"!==transString){if(void 0===prevDateText){var parseInfo=this.runDateParse(dateStringInfo);dateString=parseInfo.dateString}finalString=transString+" "+dateString,replacedDate=!0}}else if(void 0===prevDate||void 0===prevDateText){var parseInfo=this.runDateParse(dateStringInfo);parseInfo.dateString!==prevDateText&&(newDate=parseInfo.dt,dateString=parseInfo.dateString,finalString=parseInfo.dateString)}}else if(void 0===prevDate||void 0===prevDateText){var isRollover=this.isFlagSet(changeType,ChangeType.Rollover);if(g.isDemoMode()||!this.isFlagSet(changeType,ChangeType.Auto)||isRollover){var parseInfo=this.runDateParse(dateStringInfo);newDate=parseInfo.dt,finalString=parseInfo.dateString,isRollover||(dateString=parseInfo.dateString)}else void 0===prevDate&&(newDate=void 0)}}else if(this.isFlagSet(changeType,ChangeType.Local)||this.isFlagSet(changeType,ChangeType.Remote))if(this.isFlagSet(changeType,ChangeType.PluginLoad))newDate=prevDate?new Date(prevDate):void 0;else{var parseInfo=this.runDateParse(dateStringInfo);newDate=parseInfo.dt,dateString=parseInfo.dateString,finalString=parseInfo.dateString}else{var parseInfo=this.runDateParse(dateStringInfo);newDate=parseInfo.dt,dateString=parseInfo.dateString,finalString=parseInfo.dateString}try{g.PAssert(3354,!newDate||!isNaN(newDate.getTime()),"Must be a valid parsed date")}catch(PERR){g.reportError(PERR)}return{isValid:!!newDate,oldText:dateString,text:finalString,date:newDate,replacedDate:replacedDate}},getRepeatStartDate:function getRepeatStartDateFn(repeatDateStr){if(repeatDateStr&&"string"==typeof repeatDateStr){var tokens=repeatDateStr.split("|");if(tokens.length>3&&"1"===tokens[0])return new Date(parseInt(tokens[1]))}return void 0},setDateTokens:function setDateTokensFn(dateString){lastToken=void 0,dateTokens=dateString.split(" "),dateTokenOffset=1,dateCharsConsumed=dateTokens[0].length,dateCharsFromString=0,dateParsedDate=void 0},checkAndParse:function checkAndParseFn(tokenType,numTokens){var isValid=!1;if(numTokens=void 0!==numTokens&&numTokens>1?Math.min(dateTokens.length-dateTokenOffset,numTokens):numTokens,void 0===numTokens||1===numTokens)dateTokenOffset<dateTokens.length&&(isValid=dateTokens[dateTokenOffset].match(tokenType),isValid&&(lastToken=dateTokens[dateTokenOffset],dateTokenOffset++,dateCharsConsumed+=lastToken.length+1));else if(numTokens>1&&dateTokenOffset+numTokens<=dateTokens.length)for(var consumeToken=numTokens;consumeToken>0;consumeToken--){for(var currentString="",i=0;consumeToken>i;++i)currentString+=dateTokens[dateTokenOffset+i],i+1!==consumeToken&&(currentString+=" ");if(isValid=currentString.match(tokenType)){lastToken=currentString,dateTokenOffset+=consumeToken,dateCharsConsumed+=currentString.length+1;break}}return isValid},checkAndParseDate:function checkAndParseDateFn(){var isValid=!1;if(dateTokenOffset+1<dateTokens.length&&!dateTokens[dateTokenOffset+1].match(dToken.at)){var twoParsedDate=Date.parse(dateTokens[dateTokenOffset]+" "+dateTokens[dateTokenOffset+1]);twoParsedDate&&(isValid=!0,lastToken=dateTokens[dateTokenOffset]+dateTokens[dateTokenOffset+1],dateParsedDate=twoParsedDate,dateTokenOffset+=2,dateCharsConsumed+=lastToken.length+2)}if(!isValid&&dateTokenOffset<dateTokens.length){var parsedDate=Date.parse(dateTokens[dateTokenOffset]);parsedDate&&(isValid=!0,lastToken=dateTokens[dateTokenOffset],dateParsedDate=parsedDate,dateTokenOffset++,dateCharsConsumed+=lastToken.length+1)}return isValid},computeStartDate:function computeStartDateFn(dayOrd,wkOrd,monthOrd,yearOrd,time,fromDate){var minStart=fromDate||new Date,startDate=(fromDate?new Date(fromDate):new Date).clearTime();if(void 0!==yearOrd&&(startDate.setMonth(yearOrd),startDate.isBefore(minStart)&&(startDate.addYears(1),startDate.setMonth(yearOrd))),void 0!==monthOrd&&monthOrd>0&&31>=monthOrd){var maxDays=Date.getDaysInMonth(startDate.getFullYear(),startDate.getMonth());(monthOrd>maxDays||monthOrd<startDate.getDate())&&startDate.addMonths(1),startDate.setDate(monthOrd)}return void 0!==wkOrd?(startDate.moveToNthOccurrence(dayOrd,wkOrd),startDate.isBefore(minStart)&&(startDate.addMonths(1),startDate.moveToNthOccurrence(dayOrd,wkOrd))):void 0!==dayOrd&&startDate.getDay()!==dayOrd&&(startDate.moveToDayOfWeek(dayOrd,-1),startDate.isBefore(minStart)&&startDate.moveToDayOfWeek(dayOrd)),time&&this.updateDateWithTime(startDate,time),startDate},updateDateWithTime:function updateDateWithTimeFn(date,timeStr){var timeInfo=this.getTimeFromString(timeStr);date.setHours(timeInfo.hour),date.setMinutes(timeInfo.min),date.setMilliseconds(1)},getTimeFromString:function getTimeFromStringFn(time){var parts=timeRegexp.exec(time),merid,isPM,hour,min,hourString;void 0!==parts[1]?(merid=parts[3].toUpperCase(),isPM=merid===Date.CultureInfo.pmDesignator[0]||merid===Date.CultureInfo.pmDesignator,hour=parseInt(parts[1])+(isPM?12:0),min=parts[2]?parseInt(parts[2]):0,hourString=parts[1]):void 0!==parts[4]&&void 0!==parts[5]&&(hour=parseInt(parts[4]),min=parseInt(parts[5]),hourString=parts[4]);var is24Hour=!1;if(hourString){var rawHour=parseInt(hourString);(hourString.startsWith("0")||0===rawHour||rawHour>12)&&(is24Hour=!0)}return merid||is24Hour?merid&&!is24Hour&&(isPM||12!==hour?isPM&&24===hour&&(hour=12):hour=0):8>hour&&(hour+=12),{hour:hour,min:min}},parseRepeatDate:function parseRepeatDateFn(prevRepeatDate,prevDateText,completedTime,changeType,dateString){var retValue,isDateValid=!1,startDate=Date.today(),endDate,freq=RepeatFreq.Daily,sep=1,offsets,time,dayOrd,wkOrd,monthOrd,yearOrd;if(dateString.match(dToken.repeat)){this.setDateTokens(dateString);var parsedRecur=!1;if(this.checkAndParse(dToken.recur)){switch(lastToken){case"other":sep=2;break;case"last":freq=RepeatFreq.NthMonthInst,wkOrd=-1;break;default:freq=RepeatFreq.NthMonthInst,wkOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()]}parsedRecur=!0}if(parsedRecur&&"other"!==lastToken||!this.checkAndParse(dToken.date))if(!parsedRecur&&this.checkAndParse(dToken.count)){var parsedSep=parseInt(lastToken);isNaN(parsedSep)&&(parsedSep=dTokenValue[lastToken]),this.checkAndParse(dToken.measure)&&(freq=dTokenValue[lastToken.toLowerCase()],sep=parsedSep,isDateValid=!0)}else if(this.checkAndParse(dToken.day)){freq!==RepeatFreq.NthMonthInst&&(freq=RepeatFreq.Weekly),dayOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()];for(var dayOrdList;(lastToken.endsWith(",")||this.checkAndParse(dToken.delim))&&this.checkAndParse(dToken.day);){var nxtDayOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()];dayOrdList?dayOrdList.push(nxtDayOrd):dayOrdList=[dayOrd,nxtDayOrd]}dayOrdList&&(dayOrdList.sort(),offsets=dayOrdList),isDateValid=!0}else if(this.checkAndParse(dToken.daysOfWeek))freq=RepeatFreq.Weekly,"weekday"===lastToken?offsets=[1,2,3,4,5]:"weekend"===lastToken&&(offsets=[0,6]),isDateValid=!0;else if(this.checkAndParse(dToken.month)){var monthParsed=lastToken;if(this.checkAndParse(dToken.date)){var tempMonthOrd=parseInt(lastToken);tempMonthOrd>0&&31>=tempMonthOrd&&(monthOrd=tempMonthOrd,yearOrd=dTokenValue[monthParsed.substr(0,3).toLowerCase()],freq=RepeatFreq.Yearly,isDateValid=!0)}}else if(parsedRecur&&"other"!==lastToken||!this.checkAndParse(dToken.len))if(parsedRecur&&"last"!==lastToken||!this.checkAndParse(dToken.len))parsedRecur&&"other"!==lastToken&&(freq=RepeatFreq.DayOfMonth,monthOrd=wkOrd,wkOrd=void 0,isDateValid=!0);else switch(lastToken){case"day":isDateValid=!0,freq=RepeatFreq.EndOfMonthOffset}else{switch(lastToken){case"day":freq=RepeatFreq.Daily;break;case"week":freq=RepeatFreq.Weekly;break;case"month":freq=RepeatFreq.Monthly;break;case"year":freq=RepeatFreq.Yearly;break;case"morning":freq=RepeatFreq.Daily,time="9:00am";break;case"afternoon":freq=RepeatFreq.Daily,time="2:00pm";break;case"night":freq=RepeatFreq.Daily,time="7:00pm"}isDateValid=!0
}else{var dateParsed=parseInt(lastToken);dateParsed>0&&31>=dateParsed&&(isNaN(dateParsed)||(freq=RepeatFreq.DayOfMonth,monthOrd=dateParsed,isDateValid=!0),this.checkAndParse(dToken.measure)?(freq=dTokenValue[lastToken.toLowerCase()],sep=dateParsed,monthOrd=void 0,isDateValid=!0):(this.checkAndParse(dToken.of),this.checkAndParse(dToken.month)&&(monthOrd=dateParsed,yearOrd=dTokenValue[lastToken.substr(0,3).toLowerCase()],freq=RepeatFreq.Yearly,isDateValid=!0)))}var atParsed=!1;this.checkAndParse(dToken.at)&&(atParsed=!0),this.checkAndParse(dToken.time,2)&&(time=lastToken,isDateValid=!0);var implicitFrom=!1,inParsed=!1;if(this.checkAndParse(dToken.in)){inParsed=!0;var inMonth,inYear;this.checkAndParse(dToken.month)&&(inMonth=dTokenValue[lastToken.substr(0,3).toLowerCase()]),this.checkAndParse(dToken.year)&&(inYear=parseInt(lastToken)),(void 0!==inMonth||void 0!==inYear)&&(endDate=new Date,fromDate=new Date,implicitFrom=!0,inYear&&(endDate.setYear(inYear),endDate.setMonth(11),fromDate.setYear(inYear),fromDate.setMonth(0)),void 0!==inMonth&&(void 0!==inYear&&(endDate.getMonth()>inMonth&&endDate.addYears(1),fromDate.getMonth()>inMonth&&fromDate.addYears(1)),endDate.setMonth(inMonth),fromDate.setMonth(inMonth)),endDate.moveToLastDayOfMonth(),fromDate.setDate(1))}var fromDate,fromDateOffset=dateCharsConsumed+1,fromOffset=dateCharsConsumed;this.checkAndParse(dToken.from)?(fromDateOffset=dateCharsConsumed+1,this.checkAndParseDate()&&((!implicitFrom||dateParsedDate.isAfter(fromDate))&&(fromDate=dateParsedDate),implicitFrom=!1,dateCharsFromString=dateCharsConsumed)):dateCharsFromString=dateCharsConsumed;var postParsed=!1;atParsed||time||(this.checkAndParse(dToken.at)&&(atParsed=!0,postParsed=!0),this.checkAndParse(dToken.time,2)&&(time=lastToken,postParsed=!0)),inParsed||this.checkAndParse(dToken.until)&&this.checkAndParseDate()&&(endDate=dateParsedDate,postParsed=!0),endDate&&endDate.isBefore(fromDate)&&(isDateValid=!1)}else"everyday"===dateString&&(this.setDateTokens(dateString),isDateValid=!0,freq=RepeatFreq.Daily,sep=1);if(isDateValid){var prevStartDate=this.getRepeatStartDate(prevRepeatDate),computeFromDate=this.isFlagSet(changeType,ChangeType.Remote)?prevStartDate:fromDate;if(offsets&&freq===RepeatFreq.Weekly)for(var currentDayOrd=(computeFromDate||new Date).getDay(),i=0;i<offsets.length;++i)if(offsets[i]>=currentDayOrd){dayOrd=offsets[i];break}var startDate=this.computeStartDate(dayOrd,wkOrd,monthOrd,yearOrd,time,computeFromDate),isValidStartDate=!!startDate;if(startDate&&(startDate.isBefore(minStartDate)&&(isValidStartDate=!1),endDate&&endDate.isBefore(startDate)&&(isValidStartDate=!1)),isValidStartDate){var replacedStartDate,finalDateString=dateString.substr(0,dateCharsConsumed),fromString;if(!completedTime&&fromDate&&prevRepeatDate&&!implicitFrom){fromString=dateString.substr(fromDateOffset,dateCharsFromString);var newFromDateInfo=this.computeDateInfo(prevStartDate,void 0,changeType,[fromString]);newFromDateInfo.replacedDate&&(fromString=newFromDateInfo.text)}else completedTime&&completedTime!==forceCompleteTime&&(this.isFlagSet(changeType,ChangeType.Text)||(fromString=new Date(completedTime).toString(Date.CultureInfo.formatPatterns.shortDate)));if(fromString){var origString=dateString.substr(fromDateOffset,dateCharsFromString);if(origString.toUpperCase()!==fromString.toUpperCase()){var repStart=Date.parse(fromString);repStart&&(time&&this.updateDateWithTime(repStart,time),replacedStartDate=repStart.getTime(),finalDateString=finalDateString.substr(0,fromOffset)+" from "+fromString+(postParsed?finalDateString.substr(dateCharsFromString):""))}}retValue={type:DateType.Repeat,repLength:dateCharsConsumed,oldText:prevDateText,text:finalDateString,startDate:replacedStartDate||startDate,endDate:endDate,frequency:freq,separation:sep,offsets:offsets,replacedStartDate:replacedStartDate}}}return retValue}},new DuchessHelpers}),define("DisplaySettings",["require","exports","module","globals","Constants","util","platform","Measure","Sel"],function(require,exports,module){function DisplaySettings(){this.styles={},this.stylesheet={},this.Themes={Classic:{showBullets:!1,bulletColor:"#CCCCCC",showVerticalLines:!1,boldHeaders:!0,itemLineHeight:18,itemPadding:7,itemIndentSize:20,fontSize:14},Outliner:{showBullets:!0,bulletColor:"#666666",showVerticalLines:!0,boldHeaders:!1,itemLineHeight:20,itemPadding:2,itemIndentSize:36,fontSize:15},Light:{showBullets:!0,bulletColor:"#DDDDDD",showVerticalLines:!0,boldHeaders:!1,itemLineHeight:20,itemPadding:3,itemIndentSize:20,fontSize:14}},this.Defaults={Desktop:{noteLineHeight:13,notePadding:0,noteFontSize:13,verticalLinesColor:"#EEEEEE",tagColor:"#0099DD",dateColor:"#AA3300",contactColor:"#22AA66",linkColor:"#3333BB",grayscale:!1}},this.timeoutSettingChanged=void 0,util.forceBind("_updateSettings",this),this.updateSettingValues(),platform.mobile||g.settings.listen("settingChanged",Settings.UISettingsGroup,this.onSettingChanged.bind(this)),platform.mobile||g.runOnLoad(this.updateStyles.bind(this))}var g=require("globals"),C=require("Constants"),util=require("util"),platform=require("platform"),Measure,Sel;return DisplaySettings.prototype={getSettingValue:function getSettingValueFn(setting,premiumOnly){var useSaved=!premiumOnly;if(premiumOnly){var status=g.billingManager?g.billingManager.getPremiumStatus():PremiumStatus.Unknown;useSaved=status===PremiumStatus.Unknown||status===PremiumStatus.Trial||status===PremiumStatus.Active||status===PremiumStatus.Never}return useSaved?g.settings.get(setting,Settings.UISettingsGroup):this.getThemeValue(setting)},getThemeValue:function getThemeValueFn(setting){var theme=g.settings.get(Settings.layoutTheme,Settings.UISettingsGroup)||"Classic",val=this.Themes[theme][setting];return void 0===val&&(val=this.Defaults.Desktop[setting]),val},setFromThemeValue:function setFromThemeValueFn(setting){g.settings.set(setting,this.getThemeValue(setting),Settings.UISettingsGroup)},updateSettingValues:function updateSettingValuesFn(){this._showBullets=this.getSettingValue(Settings.showBullets),this._boldHeaders=this.getSettingValue(Settings.boldHeaders),this._fontSize=this.getSettingValue(Settings.fontSize,!0),this._noteFontSize=this.getSettingValue(Settings.noteFontSize,!0),this._itemPadding=this.getSettingValue(Settings.itemPadding,!0),this._notePadding=this.getSettingValue(Settings.notePadding,!0),this._itemLineHeight=this.getSettingValue(Settings.itemLineHeight,!0),this._noteLineHeight=this.getSettingValue(Settings.noteLineHeight,!0),this._itemIndentSize=this.getSettingValue(Settings.itemIndentSize,!0),this._bulletColor=this.getSettingValue(Settings.bulletColor,!0),this._showVerticalLines=this.getSettingValue(Settings.showVerticalLines,!0),this._verticalLinesColor=this.getSettingValue(Settings.verticalLinesColor,!0),this._tagColor=this.getSettingValue(Settings.tagColor,!0),this._dateColor=this.getSettingValue(Settings.dateColor,!0),this._contactColor=this.getSettingValue(Settings.contactColor,!0),this._linkColor=this.getSettingValue(Settings.linkColor,!0),this._grayscale=this.getSettingValue(Settings.grayscale)},onSettingChanged:function onSettingChangedFn(){this.timeoutSettingChanged||this.isChangingTheme||(this.timeoutSettingChanged=setTimeout(this._updateSettings,0))},_updateSettings:function _updateSettingsFn(){var oldFontSize=this._fontSize,oldNoteFontSize=this._noteFontSize;this.timeoutSettingChanged=void 0,this.updateSettingValues(),Measure=Measure||require("Measure"),Sel=Sel||require("Sel");try{g.PAssert(3355,Measure&&Sel,"Measure and Sel were not yet loaded")}catch(PERR){g.reportError(PERR)}Measure&&Sel&&(Measure.updateFont(),(this._fontSize!==oldFontSize||this._noteFontSize!==oldNoteFontSize)&&Measure.clearWordCaches(),Measure.clearItemCache(),Measure.clearLineCache(),g.vmMain&&g.vmMain.paneManager&&g.vmMain.paneManager.clearPaneCaches(),platform.mobile||this.updateStyles(),g.vmMain&&g.vmMain.updateAllItems(!1,!0),Sel.updateCaret())},fontSize:function fontSizeFn(){return platform.mobile?15:this._fontSize},noteFontSize:function noteFontSizeFn(){return platform.mobile?13:this._noteFontSize},itemPadding:function itemPaddingFn(){return platform.mobile?7:this._itemPadding},notePadding:function notePaddingFn(){return platform.mobile?0:this._notePadding},itemLineHeight:function itemLineHeightFn(){return platform.mobile?18:this._itemLineHeight},noteLineHeight:function noteLineHeightFn(){return platform.mobile?18:this._noteLineHeight},itemIndentSize:function itemIndentSizeFn(){return platform.mobile?20:this._itemIndentSize},itemIndentStart:function itemIndentStartFn(pane){return platform.phone?24:pane.supportBullets&&this._showBullets?45:30},paddingForItemBottom:function paddingForItemBottomFn(item){var pad;return pad=item.hasNote()?0:this.itemPadding()},paddingForItemTop:function paddingForItemTopFn(item){return item.isNote()?this.notePadding():this.itemPadding()},lineHeightForItem:function lineHeightForItemFn(item){return item.isNote()?this.noteLineHeight():this.itemLineHeight()},boldHeaders:function boldHeadersFn(){return platform.phone?!0:this._boldHeaders},createSheet:function createSheetFn(){var head=document.head||document.getElementsByTagName("head")[0],styleNode=document.createElement("style");styleNode.type="text/css",styleNode.rel="stylesheet",head.appendChild(styleNode),this.sheet=styleNode.sheet},changeTheme:function changeThemeFn(theme){this.isChangingTheme=!0,g.settings.set(Settings.layoutTheme,theme,Settings.UISettingsGroup),this.setFromThemeValue(Settings.showBullets),this.setFromThemeValue(Settings.bulletColor),this.setFromThemeValue(Settings.showVerticalLines),this.setFromThemeValue(Settings.boldHeaders),this.setFromThemeValue(Settings.itemLineHeight),this.setFromThemeValue(Settings.itemPadding),this.setFromThemeValue(Settings.itemIndentSize),this.setFromThemeValue(Settings.fontSize),this.isChangingTheme=!1,this._updateSettings()},updateStyles:function updateStylesFn(){try{g.PAssert(3356,!platform.mobile,"Should not be running display settings on mobile")}catch(PERR){g.reportError(PERR)}if(!platform.mobile){if(this.sheet){var node=this.sheet.ownerNode;node.parentNode.removeChild(node)}this.createSheet();var styles=[];if(this._boldHeaders&&styles.push(".item:not(.overviewItem).pHeader { font-weight: bold; color: black; }"),styles.push(".item:not(.pNote) { font-size: "+this._fontSize+"px; }"),styles.push(".pNote { font-size: "+this._noteFontSize+"px; }"),this._showVerticalLines){var indentSize=this.itemIndentSize(),vertLinesColor=this._verticalLinesColor,trans="rgba(255,255,255,0)";styles.push(".vertLines { background: repeating-linear-gradient(to right, "+trans+" 0, "+vertLinesColor+" 1px, "+trans+" 2px, "+trans+" "+indentSize+"px) }")}var lineHeight=this.itemLineHeight(),itemPadding=this.itemPadding(),collapserHeight=lineHeight+2*itemPadding;styles.push(".collapser { line-height: "+collapserHeight+"px; }"),this._showBullets&&(styles.push(".bullet { color: "+this._bulletColor+"; }"),styles.push(".collapser { color: "+this._bulletColor+"; }")),styles.push(".tag { color: "+this._tagColor+";}"),styles.push(".date { color: "+this._dateColor+";}"),styles.push(".duration { color: "+this._dateColor+";}"),styles.push(".contact { color: "+this._contactColor+";}"),styles.push(".link { color: "+this._linkColor+";}"),this._grayscale?g.addClass(document.body,"grayscale"):g.removeClass(document.body,"grayscale");for(var i=0;i<styles.length;i++)this.sheet.insertRule(styles[i],0)}}},new DisplaySettings}),define("Measure",["globals","data","Constants","CacheManager","platform","DuchessHelpers","Dispatcher","DisplaySettings"],function(g,d,C,CacheManager,platform,DuchessHelpers,Dispatcher,DisplaySettings){function roundToFixed(num){return Math.round(num*fixedPrecision)/fixedPrecision}var wordDelims=[" ","-"],wordPlaceholders=[window.AttachChar],ItemCacheMaxSize=5,LineCacheMaxSize=5,Measure=function(){this.fontSize=DisplaySettings.fontSize(),this.isNote=!1,this.isBold=!1,this._wordCache=CacheManager.registerLocalCache("WordCacheNormal","WordCacheNormal",StorageType.LocalStorage,{isPerDoc:!0}),this._wordCacheBold=CacheManager.registerLocalCache("WordCacheBold","WordCacheBold",StorageType.LocalStorage,{isPerDoc:!0}),this._wordCacheNote=CacheManager.registerLocalCache("WordCacheNote","WordCacheNote",StorageType.LocalStorage,{isPerDoc:!0}),this._lineCache=CacheManager.registerLocalCache("LineCache","LineCache",StorageType.LocalStorage,{saveTime:-1,writeOnUnload:!0,clearBackingOnLoad:!0,isPerDoc:!0}),this._itemCache={},this._loadCaches()},MeasureStats={CallCount:{GetCaretOffset:0,GetClassStyles:0,MeasureItem:0,MeasureLines:0,MeasureWord:0,MeasureLine:0,GetOffsetFromLineOffset:0,GetOffsetForPositionInLine:0},Cache:{ItemCacheMiss:0,ItemCacheHit:0,LinesCacheMiss:0,LinesCacheHit:0,CanvasStyleHit:0,CanvasStyleMiss:0,WordCacheHit:0,WordCacheMiss:0}},fixedPrecision=100;return Measure.prototype={updateFont:function updateFontFn(){this.fontSize=this.isNote?DisplaySettings.noteFontSize():DisplaySettings.fontSize(),this.canvasFont=(this.isBold?"bold ":"")+this.fontSize+"px Helvetica Neue, Helvetica, Arial, Sans-serif",this.canvasContext&&(this.canvasContext.font=this.canvasFont)},getCanvasContext:function getCanvasContextFn(){return this.canvasContext||(this.canvasContext=document.getElementById("canvas").getContext("2d"),this.updateFont()),this.canvasContext},getMeasureStats:function getMeasureStatsFn(){return MeasureStats},getCaretOffset:function getCaretOffsetFn(item,pane,offset,preferLineStart){MeasureStats.CallCount.GetCaretOffset++;var maxWidth=g.focusedPane.maxWidthOfItem(item),text=this.getItemDisplayText(item);if(0===text.length||maxWidth<g.MinItemWidth)return{left:0,top:0,line:0,lineOffset:0};void 0===offset&&(offset=text.length);for(var linesOriginal=this.measureLines(item,pane,maxWidth),lines=this.measureLines(item,pane,maxWidth,offset),lineNum=Math.max(lines.length-1,0),line=lines[lineNum],left=line?Math.round(line.width):0,i=0;i<lines.length-1;++i)offset-=lines[i].length;preferLineStart&&offset===linesOriginal[lineNum].length&&lineNum<linesOriginal.length-1?(left=0,offset=0,lineNum++):!preferLineStart&&lineNum>0&&0===offset&&0===lines[lineNum].length&&(lineNum--,offset+=lines[lineNum].length,left=Math.round(lines[lineNum].width));var top=DisplaySettings.lineHeightForItem(item)*lineNum;try{g.PAssert(3357,!isNaN(offset),"Should always have a valid offset")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3358,linesOriginal,"Lines should be defined",item.getParsedText().length)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3359,linesOriginal&&linesOriginal.length>0,"Should always have lines",item.getParsedText().length)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3360,linesOriginal&&linesOriginal[lineNum],"Lines original is not big enough",lineNum,linesOriginal.length,lines.length,preferLineStart)}catch(PERR){g.reportError(PERR)}return{left:left,top:top,line:lineNum,lineOffset:offset,lineLength:linesOriginal[lineNum]?linesOriginal[lineNum].length:0}},getCaretScreenPosition:function getCaretScreenPositionFn(pane,index,offset){try{g.PAssert(3361,index>=0,"Must provide a valid index")}catch(PERR){g.reportError(PERR)}var item=pane.itemAtIndex(index);try{g.PAssert(3362,item,"Must be able to find a valid item at index")}catch(PERR){g.reportError(PERR)}var element=pane.elementAtIndex(index);try{g.PAssert(3363,element,"Must be able to get element for item at index")}catch(PERR){g.reportError(PERR)}var padding=pane.getPaddingForItem(item),caretPos=this.getCaretOffset(item,pane,offset),pos={left:-1,top:-1};if(element){var itemOffset=element.getBoundingClientRect();pos.left=caretPos.left+itemOffset.left+padding,pos.top=caretPos.top+itemOffset.top}return pos},_getClassStyles:function _getClassStylesFn(item,el){MeasureStats.CallCount.GetClassStyles++;try{g.PAssert(3364,g.isVMLI(item),"Item must be a valid VMLI instance")}catch(PERR){g.reportError(PERR)}var isBold=item.isHeader()&&DisplaySettings.boldHeaders()||el.hasClass("contact")||el.hasClass("date")||el.hasClass("duration")||el.hasClass("tag"),isNote=item.isNote(),isItalic=!1,isUnderline=!1;return{isBold:isBold,isItalic:isItalic,isUnderline:isUnderline,isNote:isNote,attrs:el.getAttrs()}},_appendLine:function _appendLineFn(pane,lines,strIndex,words,maxWidth,offset,start,end){for(var lineText="",lineWidth2=0,strLineIndex=strIndex,needsOffsetRet=!1,u=start;end>=u;++u){var w=words[u];if(strLineIndex+w.text.length+w.delim.length>offset){var len=offset-strLineIndex,wordWidth=0,delimWidth=0;len>=w.text.length?(wordWidth=w.width,len-=w.text.length,delimWidth=this.measureWord(pane,w.delim.substr(0,len),w.styles,!0)):wordWidth=this.measureWord(pane,w.text.substr(0,len),w.styles,!0),lineWidth2+=wordWidth+delimWidth,needsOffsetRet=!0;break}lineText+=w.text+w.delim,lineWidth2+=w.width+w.delimWidth,strLineIndex+=(w.text+w.delim).length}lineWidth2=Math.min(lineWidth2,maxWidth);var line={text:lineText,start:strIndex,length:lineText.length,width:lineWidth2};return lines.push(line),{line:line,needsOffsetRet:needsOffsetRet}},measureLines:function measureLinesFn(item,pane,maxWidth,offset){try{g.PAssert(3365,g.isVMLI(item),"Must provide a valid item to measure lines for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3366,g.isPane(pane),"Must provide a valid pane to measure lines for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3367,maxWidth>=0,"Max width must be greater than 0: ",maxWidth)}catch(PERR){g.reportError(PERR)}MeasureStats.CallCount.MeasureLines++;var fullText=this.getItemDisplayText(item),noCache=!isNaN(offset);try{g.PAssert(3368,item&&item.els,"A Item has no els: ",item.__TEMP_InitCalled,item.__TEMP_InitParseCalled,item.__TEMP_ParseCalled,item.__TEMP_SkippedInitParsed,item.isArchived(),g.vmMain.hasDisplayedArchivedItems())}catch(PERR){g.reportError(PERR)}if(0===fullText.length||!item||!item.els)return item&&g.vmMain.runSingleParse(item,ChangeType.Auto),[{text:"",start:0,length:0,width:0}];if(!noCache){var cachedValue=this.getLinesFromCache(item,maxWidth);if(cachedValue){for(var fullLength=fullText.length,length=0,i=0;i<cachedValue.length;i++)length+=cachedValue[i].length;if(fullLength===length)return MeasureStats.Cache.LinesCacheHit++,cachedValue}else MeasureStats.Cache.LinesCacheMiss++}for(var lines=[],els=item.els,strIndex=0,lineWidth=0,word="",lineStart=0,needsOffsetRet=!1,elStyles,words=[],i=0;i<els.length&&!needsOffsetRet;++i){var el=els[i],textLength=el.getParsedText().length;elStyles=this._getClassStyles(item,el);try{g.PAssert(3369,!elStyles.plugin||el.getParsedText()===window.AttachChar,"Plugin should only be set for attachment element")}catch(PERR){g.reportError(PERR)}for(var u=0;textLength>u;++u){var ch=el.getParsedText()[u];if(wordDelims.indexOf(ch)<0||0===strIndex){word+=ch;for(var delimWord="",y=strIndex+1;y<fullText.length;++y){var nextCh=fullText[y];if(!(wordDelims.indexOf(nextCh)>=0))break;delimWord+=nextCh}var shouldCommitWord=delimWord||wordPlaceholders.indexOf(ch)>=0||el.getParsedText()[u+1]===window.AttachChar;if(shouldCommitWord){var width=this.measureWord(pane,word,elStyles,noCache),delimWidth=this.measureWord(pane,delimWord,elStyles,noCache);words.push({text:word,delim:delimWord,styles:elStyles,width:width,delimWidth:Math.min(delimWidth,maxWidth),isAttach:ch===window.AttachChar}),word=""}}strIndex++}if(word.length>0){var width=this.measureWord(pane,word,elStyles,noCache);words.push({text:word,delim:"",styles:elStyles,width:width,delimWidth:0}),word=""}}needsOffsetRet=!1,strIndex=0;for(var i=0;i<words.length&&!needsOffsetRet;++i){if(word=words[i],i>lineStart&&lineWidth+word.width+word.delimWidth>maxWidth){var lineRet=this._appendLine(pane,lines,strIndex,words,maxWidth,offset,lineStart,i-1);lineWidth=0,lineStart=i,strIndex+=lineRet.line.text.length,needsOffsetRet=needsOffsetRet||lineRet.needsOffsetRet}if(word.width+word.delimWidth>maxWidth&&!word.isAttach){for(var bigWordStart=0,t,w,u=0;u<word.text.length&&!needsOffsetRet;++u){if(t=word.text.substring(bigWordStart,u+1),w=this.measureWord(pane,t,word.styles,!0),(w+word.delimWidth>maxWidth||strIndex+t.length-1>offset)&&u>0&&u-1>bigWordStart){var t2=word.text.substring(bigWordStart,u-1),w2=this.measureWord(pane,t2,word.styles,!0);lines.push({text:t2,start:strIndex,length:t2.length,width:w2}),strIndex+=t2.length,bigWordStart=u-1,u--}if(strIndex>=offset){needsOffsetRet=!0;break}}if(!needsOffsetRet&&bigWordStart>0){if(t=word.text.substring(bigWordStart,word.text.length),t.length>0){w=this.measureWord(pane,t,word.styles,!0);var newWord={text:t,delim:word.delim,styles:word.styles,width:w,delimWidth:word.delimWidth};words.splice(i+1,0,newWord)}lineWidth=w+word.delimWidth,lineStart=i+1}}else lineWidth+=word.width+word.delimWidth;needsOffsetRet||i!==words.length-1||this._appendLine(pane,lines,strIndex,words,maxWidth,offset,lineStart,i)}return noCache||this.saveLinesToCache(item,maxWidth,lines),lines},getItemFromCache:function getItemFromCacheFn(item,maxWidth){var cachedItem=this._itemCache[item.id],validCacheItem,key=maxWidth,text=this.getItemDisplayText(item);if(cachedItem&&cachedItem[key]&&cachedItem[key].isHeader===item.isHeader()&&text===cachedItem.text&&cachedItem[key].isNote===item.isNote()&&text.indexOf(window.AttachChar)<0){var cached=cachedItem[key];if(cached.els)MeasureStats.Cache.ItemCacheHit++,validCacheItem=cached;else try{g.PAssert(3370,!1,"Getting item from cache with no els")}catch(PERR){g.reportError(PERR)}}return validCacheItem||MeasureStats.Cache.ItemCacheMiss++,validCacheItem},saveItemToCache:function saveItemToCacheFn(item,measuredItem){try{g.PAssert(3371,measuredItem,"Must save a valid measured item to cache")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3372,measuredItem.els,"Measured item must have els")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3373,measuredItem.maxWidth,"Measured item must have a valid max width")}catch(PERR){g.reportError(PERR)}var text=this.getItemDisplayText(item),cached=this._itemCache[item.id];if(cached&&cached.text===text){var num=0,oldestTime=Number.MAX_VALUE,oldestWidth;for(var key in cached)if(cached.hasOwnProperty(key)){num++;var oldCached=cached[key],t=oldCached.lastAccess;oldestTime>t&&(oldestTime=t,oldestWidth=key)}num>=ItemCacheMaxSize&&delete cached[oldestWidth]}else cached=this._itemCache[item.id]={text:text};cached[measuredItem.maxWidth]=measuredItem},getLinesFromCache:function getLinesFromCacheFn(item,maxWidth){var cachedValue=this._lineCache.getEntrySync(item.id),lines,convertedLines,i;if(cachedValue)for(i=0;i<cachedValue.length&&!(lines=cachedValue[i][maxWidth]);i++);if(lines){var text=this.getItemDisplayText(item);if(g.isNumber(lines))convertedLines=[{start:0,length:text.length,text:text}];else{convertedLines=[];for(var strIndex=0,i=0;i<lines.length;i++){var line=lines[i];convertedLines[i]={start:strIndex,length:line,text:text.substr(strIndex,line)},strIndex+=line}}}return convertedLines},saveLinesToCache:function saveLinesToCacheFn(item,maxWidth,lineLengths){var saved;saved=lineLengths.length>1?lineLengths:1;var cachedValue=this._lineCache.getEntrySync(item.id)||[];cachedValue.length>=LineCacheMaxSize&&cachedValue.pop();for(var i=0;i<cachedValue.length;i++)cachedValue[i][maxWidth]&&(cachedValue.splice(i,1),i--);var val={};val[maxWidth]=saved,cachedValue.splice(0,0,val),this._lineCache.cacheEntry(item.id,cachedValue)},measureItem:function measureItemFn(item,pane,maxWidth){MeasureStats.CallCount.MeasureItem++;try{g.PAssert(3374,g.isNumber(maxWidth),"Must provide a valid number for maxWidth: ",maxWidth)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3375,maxWidth>=0,"Max width must be greater than 0: ",maxWidth)}catch(PERR){g.reportError(PERR)}var measuredItem,fullText=this.getItemDisplayText(item),els=item.els,isHeader=item.isHeader(),isNote=item.isNote();if(0===fullText.length||maxWidth<g.MinItemWidth){var height=this.lineItemHeight(item,1),newEls=[{text:"",start:0,length:0,width:0,cls:"line",index:0}];return{height:height,maxWidth:maxWidth,lineLengths:[0],styledLines:[TextSpace],els:newEls,isHeader:isHeader,isNote:isNote}}if(measuredItem=this.getItemFromCache(item,maxWidth),!measuredItem){for(var lines=this.measureLines(item,pane,maxWidth),joined,i,lineLengths=[],lineEls=[],i=0;i<lines.length;++i){var line=lines[i];lineLengths.push(line.length),lineEls.push({text:line.text,start:line.start,length:line.length,width:line.width,cls:"line",index:i})}try{g.PAssert(3377,item&&item.els,"B Item has no els: ",item.__TEMP_InitCalled,item.__TEMP_InitParseCalled,item.__TEMP_ParseCalled,item.__TEMP_SkippedInitParsed,item.isArchived(),g.vmMain.hasDisplayedArchivedItems())}catch(PERR){g.reportError(PERR)}if(!els){var height=this.lineItemHeight(item,1),newEls=[{text:"",start:0,length:0,width:0,cls:"line",index:0}];return{height:height,maxWidth:maxWidth,lineLengths:[],styledLines:[],els:newEls,isHeader:isHeader,isNote:isNote}}var generatedLines=DuchessHelpers.generateStyledLines(els,lines,pane,maxWidth);height=this.lineItemHeight(item,lines.length),measuredItem={height:height,maxWidth:maxWidth,lineLengths:lineLengths,styledLines:generatedLines,els:lineEls,isHeader:isHeader,isNote:isNote,lastAccess:Date.now()},this.saveItemToCache(item,measuredItem)}return measuredItem},_updateCanvasWithStyles:function _updateCanvasWithStylesFn(wordStyles){wordStyles.isBold!==this.isBold||wordStyles.isNote!==this.isNote?(MeasureStats.Cache.CanvasStyleMiss++,this.isBold=wordStyles.isBold,this.isNote=!!wordStyles.isNote,this.updateFont()):MeasureStats.Cache.CanvasStyleHit++},measureWord:function measureWordFn(pane,word,wordStyles,noCache){MeasureStats.CallCount.MeasureWord++;try{g.PAssert(3378,void 0!==word,"Must pass in a valid word")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3379,wordStyles,"Must supply valid styles for word")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3380,word.indexOf(window.AttachChar)<0||1===word.length,"AttachChar should not be processed with other chars")}catch(PERR){g.reportError(PERR)}var width=0;if(word.length>0)if(word===window.AttachChar&&wordStyles&&wordStyles.attrs){try{g.PAssert(3381,!wordStyles.attrs||wordStyles.attrs.plugin,"Must have a valid plugin: ",wordStyles.attrs&&wordStyles.attrs.plugin)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3382,!wordStyles.attrs||wordStyles.attrs["plugin-id"],"Must have a valid attachment",wordStyles.attrs&&wordStyles.attrs["plugin-id"])}catch(PERR){g.reportError(PERR)}width=g.vmMain.pluginManager.measureAttachment(pane,wordStyles)}else{var cache=this._selectCache(wordStyles,this.fontSize),cachedValue=cache.getEntrySync(word);if(cachedValue)MeasureStats.Cache.WordCacheHit++,width=cachedValue;else{MeasureStats.Cache.WordCacheMiss++,this._updateCanvasWithStyles(wordStyles);var metrics=this.getCanvasContext().measureText(word);width=roundToFixed(metrics.width),noCache||cache.cacheEntry(word,width)}}return width},measureLine:function measureLineFn(item,pane,lineIndex,lineOffset){MeasureStats.CallCount.MeasureLine++;var offset=this.getOffsetFromLineOffset(item,pane,lineIndex,lineOffset),maxWidth=pane.maxWidthOfItem(item),lines=this.measureLines(item,pane,maxWidth,offset);try{g.PAssert(3383,lines,"Must have valid lines for an item")}catch(PERR){g.reportError(PERR)}var data;return data=lines.length>0?lines[lines.length-1]:[{text:"",start:0,length:0,width:0,cls:"line",index:0}]},getOffsetFromLineOffset:function getOffsetFromLineOffsetFn(item,pane,lineIndex,lineOffset){MeasureStats.CallCount.GetOffsetFromLineOffset++;for(var metrics=item.metricsInPane(pane),lines=metrics.lineLengths,sum=0,i=0;i<lines.length;++i){var line=lines[i];if(i===lineIndex)return Math.min(sum+lineOffset,this.getItemDisplayText(item).length);sum+=line}return 0},getOffsetForPositionInLine:function getOffsetForPositionInLineFn(item,pane,line,targetX,guessOffset){MeasureStats.CallCount.GetOffsetForPositionInLine++;var metrics=item.metricsInPane(pane),lineLengths=metrics.lineLengths;try{g.PAssert(3384,line>=0&&line<lineLengths.length,"findOffsetInLineByX out of range",line)}catch(PERR){g.reportError(PERR)}(-1===guessOffset||guessOffset>lineLengths[line])&&(guessOffset=lineLengths[line]);var x=this.measureLine(item,pane,line,guessOffset).width,closest=guessOffset,lineWidth=lineLengths[line],add=targetX-x>0;if(targetX>0)for(var i=add?guessOffset+1:guessOffset-1;add?lineWidth>=i:i>=0;add?i++:i--){var newX=this.measureLine(item,pane,line,i).width;if(!(Math.abs(newX-targetX)<Math.abs(x-targetX)))break;closest=i,x=newX}else closest=0;var closestOffset=this.getOffsetFromLineOffset(item,pane,line,closest);return closestOffset},clearCacheForItem:function clearCacheForItemFn(id){this._lineCache.removeEntry(id),this._itemCache[id]=void 0},_loadCaches:function _loadCachesFn(){this._wordCache.loadAll(),this._wordCacheBold.loadAll(),this._wordCacheNote.loadAll(),this._lineCache.loadAll()},clearWordCaches:function clearWordCachesFn(){this._wordCache.clearCache(),this._wordCacheBold.clearCache(),this._wordCacheNote.clearCache()},clearItemCache:function clearItemCacheFn(){this._itemCache={}},clearLineCache:function clearLineCacheFn(){this._lineCache.clearCache()},_selectCache:function _selectCacheFn(wordStyles){var cache;if(wordStyles.isBold){try{g.PAssert(3385,!wordStyles.isNote,"Currently do not support bold+note")}catch(PERR){g.reportError(PERR)}cache=this._wordCacheBold}else cache=wordStyles.isNote?this._wordCacheNote:this._wordCache;return cache},lineItemHeight:function lineItemHeightFn(item,num){return(!g.isNumber(num)||item.isNote())&&(num=1),DisplaySettings.paddingForItemTop(item)+DisplaySettings.paddingForItemBottom(item)+DisplaySettings.lineHeightForItem(item)*num},getItemDisplayText:function getItemDisplayTextFn(item){var text;if(item.isNote()){var temp=item.getParsedText();text=temp.split("\n")[0]}else text=item.getParsedText();return text}},new Measure}),define("FakeRange",["globals","platform"],function(g,platform){function FakeRange(range){this._range=range,this._range||android.isEnabled()||(this._range=NativeSel._getSelectionRange())}var android={isEnabled:function(){return!!platform.android}};require(["android"],function(androidLoad){android=androidLoad});var NativeSel;return require(["NativeSel"],function(NativeSelLoad){NativeSel=NativeSelLoad}),FakeRange.prototype={isValid:function isValidFn(){return!!this._range},getNativeRange:function getNativeRangeFn(){return this._range},getStartContainer:function getStartContainerFn(){return this._range.startContainer},getEndContainer:function getEndContainerFn(){return this._range.endContainer},getStartElement:function getStartElementFn(){var startEl;return startEl=!this._range&&android.isEnabled()?android.getCurrentElement():g.getElementParent(this._range.startContainer)},getEndElement:function getEndElementFn(){var endEl;return endEl=!this._range&&android.isEnabled()?android.getCurrentElement():g.getElementParent(this._range.endContainer)},getSelectOffsetsInElement:function getSelectOffsetsInElementFn(li){var offsets;return offsets=!this._range&&android.isEnabled()?android.getSelectionOffsets():NativeSel.getSelectOffsetsInElement(li,this._range)},getStartOffset:function getStartOffsetFn(){try{g.PAssert(3386,!android.isEnabled(),"Should not be called during andorid editing")}catch(PERR){g.reportError(PERR)}return this._range.startOffset},getEndOffset:function getEndOffsetFn(){try{g.PAssert(3387,!android.isEnabled(),"Should not be called during andorid editing")}catch(PERR){g.reportError(PERR)}return this._range.endOffset}},FakeRange}),define("NativeSel",["globals","platform","FakeRange"],function(g,platform,FakeRange){function NativeSel(){}return NativeSel.prototype={createFakeRange:function createFakeRangeFn(startElement,startOffset,endElement,endOffset){var range=this.createSelectionRange();return range.setStart(startElement,startOffset),range.setEnd(endElement,endOffset),new FakeRange(range)},createSelectionRange:function createSelectionRangeFn(){return document.createRange()},setSelectionRange:function setSelectionRangeFn(range){var selection=window.getSelection();selection.removeAllRanges(),range instanceof FakeRange&&(range=range.getNativeRange()),selection.addRange(range)
},insertNode:function insertNodeFn(node){var range=this._getSelectionRange();range&&range.insertNode(node)},setSelectionRangeToWhatItAlreadyIs:function setSelectionRangeToWhatItAlreadyIsFn(){var range=this._getSelectionRange();range&&this.setSelectionRange(range)},getSelectionRange:function getSelectionRangeFn(forceNative){var range;return forceNative&&(range=this._getSelectionRange()),new FakeRange(range)},_getSelectionRange:function _getSelectionRangeFn(){var range,selection=window.getSelection();return selection.rangeCount>0&&(range=selection.getRangeAt(0)),range},getSelectionNode:function getSelectionNodeFn(){var selection=window.getSelection(),node=selection.anchorNode;return node?node.nodeType===Node.TEXT_NODE?node.parentNode:node:void 0},clearSelection:function clearSelectionFn(){var selection=window.getSelection();selection.removeAllRanges()},hasSelection:function hasSelectionFn(){var hasSelection=!1,isInAndroidEditBox=document.activeElement&&"androidInput"===document.activeElement.id,range=this._getSelectionRange();if(!isInAndroidEditBox&&range){var pane=g.getPaneForElement(range.startContainer);return pane&&g.findParent(range.startContainer,"paneContent")}return hasSelection=isInAndroidEditBox},hasRawSelection:function hasRawSelectionFn(){return!!window.getSelection().anchorNode},getCursorSelectionRange:function getCursorSelectionRangeFn(e){var range,hovered=g.ensureDOMNode(e.target);if(hovered){try{g.PAssert(3388,g.findParent(hovered,"item"),"getCursorSelectionRange must only be called when hovered item is item",hovered)}catch(PERR){g.reportError(PERR)}var boundingRect=hovered.getBoundingClientRect(),clampedY=g.clamp(e.clientY,boundingRect.top+9,boundingRect.bottom-9);range=this._getCursorSelectionRange(e.clientX,clampedY)}return range?new FakeRange(range):void 0},_getCursorSelectionRange:function _getCursorSelectionRangeFn(clientX,clientY){var range;if(document.caretRangeFromPoint)range=document.caretRangeFromPoint(clientX,clientY);else if(document.caretPositionFromPoint){var r=document.caretPositionFromPoint(clientX,clientY);r&&(range=document.createRange(),range.setStart(r.offsetNode,r.offset),range.setEnd(r.offsetNode,r.offset))}else if(document.body.createTextRange){var origSelection=this._getSelectionRange(),clickTextRange=document.body.createTextRange();try{clickTextRange.moveToPoint(clientX,clientY),clickTextRange.select(),range=this._getSelectionRange(),this.setSelectionRange(origSelection)}catch(err){}}else try{g.PAssert(3389,!1,"Unable to get selection range at cursor")}catch(PERR){g.reportError(PERR)}return range},_ensureSelectionInElement:function _ensureSelectionInElementFn(element,range){try{g.PAssert(3390,element,"Must have a valid element")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3391,range,"Must have a valid range")}catch(PERR){g.reportError(PERR)}g.isAncestor(range.startContainer,element)||range.setStart(element,0),g.isAncestor(range.endContainer,element)||range.setEnd(element,0),g.hasClass(range.startContainer,"textSelected")&&range.setStart(range.startContainer.parentElement.firstElementChild,range.startContainer.innerText.length),g.hasClass(range.endContainer,"textSelected")&&range.setEnd(range.endContainer.parentElement.firstElementChild,range.endContainer.innerText.length);var startPluginCandidate=g.getPluginForElement(range.startContainer);if(startPluginCandidate){var startPluginLength=startPluginCandidate.textContent.length,isTextNode=startPluginCandidate.nodeType===Node.TEXT_NODE;!isTextNode&&0===range.startOffset||isTextNode&&range.startOffset<startPluginLength/2?range.setStartBefore(startPluginCandidate):range.setStartAfter(startPluginCandidate)}var endPluginCandidate=g.getPluginForElement(range.endContainer);if(endPluginCandidate){var endPluginLength=endPluginCandidate.textContent.length,isTextNode=endPluginCandidate.nodeType===Node.TEXT_NODE;!isTextNode&&0===range.endOffset||isTextNode&&range.endOffset<endPluginLength/2?range.setEndBefore(endPluginCandidate):range.setEndAfter(endPluginCandidate)}},getSelectOffsetsInElement:function getSelectOffsetsInElementFn(element,range){var returnValue={total:0};try{g.PAssert(3393,range,"Must provide a valid range")}catch(PERR){g.reportError(PERR)}if(range&&element){this._ensureSelectionInElement(element,range);var startComponent=this._getComponentNode(range.startContainer,range.startOffset),startOffset=range.startOffset,endComponent=this._getComponentNode(range.endContainer,range.endOffset),endOffset=range.endOffset;startComponent&&startComponent.textContent===TextSpace&&(startOffset=0),endComponent&&endComponent.textContent===TextSpace&&(endOffset=0);var totalOffset=0,components=this._getComponentNodesIn(element);if(components.length>0)for(var i=0;i<components.length;++i)components[i]===startComponent&&(returnValue.start=totalOffset+startOffset),components[i]===endComponent&&(returnValue.end=totalOffset+endOffset),totalOffset+=this._getComponentNodeLength(components[i]),void 0===endComponent&&(i===endOffset-1?returnValue.end=totalOffset:0===i&&0===endOffset&&(returnValue.end=0)),void 0===startComponent&&(i===startOffset-1?returnValue.start=totalOffset:0===i&&0===startOffset&&(returnValue.start=0));else returnValue.start=0,returnValue.end=0;returnValue.total=totalOffset,isNaN(returnValue.end)&&(returnValue.end=totalOffset)}else returnValue.start=0,returnValue.end=0;try{g.PAssert(3394,!isNaN(returnValue.start)&&!isNaN(returnValue.end),"Must have valid start and end",returnValue)}catch(PERR){g.reportError(PERR)}return returnValue},getSelectOffsetsForEvent:function getSelectOffsetsForEventFn(e){var li=g.getElementParent(e.target),range=this.getCursorSelectionRange(e);return range.getSelectOffsetsInElement(li)},getOffsetChildElement:function getOffsetChildElementFn(element,offset){try{g.PAssert(3395,element,"Must supply a valid element")}catch(PERR){g.reportError(PERR)}if(this._isComponentNode(element)){try{g.PAssert(3397,this._isComponentSelectable(element),"Component must be selectable")}catch(PERR){g.reportError(PERR)}return{element:element,offset:offset}}for(var totalOffset=0,children=this._getComponentNodesIn(element),i=0;i<children.length;++i){var childLength=this._getComponentNodeLength(children[i]);if(totalOffset+childLength>=offset)return{element:children[i],offset:offset-totalOffset};totalOffset+=childLength}try{g.PAssert(3396,!1,"Unable to find offset child element")}catch(PERR){g.reportError(PERR)}return void 0},getChildNodeOffset:function getChildNodeOffsetFn(child){try{g.PAssert(3398,child,"Must supply a valid child element")}catch(PERR){g.reportError(PERR)}for(var offset=0,children=this._getComponentNodesIn(g.getElementParent(child)),childrenSub=this._getComponentNodesIn(child),i=0;i<children.length&&children[i]!==childrenSub[0];++i)offset+=this._getComponentNodeLength(children[i]);return offset},_getComponentNodeLength:function _getComponentNodeLengthFn(node){try{g.PAssert(3399,this._isComponentNode(node),"Supplied node must be a valid component")}catch(PERR){g.reportError(PERR)}return g.hasClass(node,"plugin")?1:1===node.length&&node.textContent===TextSpace?0:node.length},_getComponentNodesIn:function _getComponentNodesInFn(element){if(this._isComponentNode(element))return[element];var nodes=[];return this._getComponentNodes(nodes,element),nodes},_isComponentNode:function _isComponentNodeFn(node){var isComponent=!1;return node&&(node.nodeType===Node.TEXT_NODE&&!g.getPluginForElement(node)||g.hasClass(node,"plugin"))&&(isComponent=!0),isComponent},_isComponentSelectable:function _isComponentSelectableFn(node){try{g.PAssert(3400,!node||this._isComponentNode(node),"Must either be an invalid node (not-selectable) or a component")}catch(PERR){g.reportError(PERR)}var isSelectable=!1;return node&&node.nodeType===Node.TEXT_NODE&&(isSelectable=!0),isSelectable},_getComponentNodes:function _getComponentNodesFn(arr,node){if(node)if(this._isComponentNode(node))arr.push(node);else if(node.childNodes)for(var i=0;i<node.childNodes.length;++i){var el=node.childNodes[i];this._getComponentNodes(arr,el)}},_getComponentNode:function _getComponentNodeFn(node){var componentNode;if(this._isComponentNode(node))componentNode=node;else{var pluginCandidate=g.getPluginForElement(node);pluginCandidate&&(componentNode=pluginCandidate)}return componentNode},setSelectionValues:function setSelectionValuesFn(range,startEle,startOffset,endEle,endOffset){try{g.PAssert(3401,range,"Range must be supplied")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3402,this._isComponentNode(startEle),"Must be selecting a valid component")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3403,this._isComponentNode(endEle),"Must be selecting a valid component")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3404,startEle!==endEle||endOffset>=startOffset,"Select elements must be different, or selection must start before it ends")}catch(PERR){g.reportError(PERR)}if(startEle.nodeType===Node.TEXT_NODE)range.setStart(startEle,startOffset);else{try{g.PAssert(3405,g.hasClass(startEle,"plugin"),"Only other valid component is plugin")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3406,0===startOffset||1===startOffset,"Must eiter be selecting before or after the plugin")}catch(PERR){g.reportError(PERR)}0===startOffset?this._selectBeforeComponent(range,startEle,"setStart"):1===startOffset&&this._selectAfterComponent(range,startEle,"setStart")}if(endEle.nodeType===Node.TEXT_NODE)range.setEnd(endEle,endOffset);else{try{g.PAssert(3407,g.hasClass(endEle,"plugin"),"Only other valid component is plugin")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3408,0===endOffset||1===endOffset,"Must eiter be selecting before or after the plugin")}catch(PERR){g.reportError(PERR)}0===endOffset?this._selectBeforeComponent(range,endEle,"setEnd"):1===endOffset&&this._selectAfterComponent(range,endEle,"setEnd")}},_selectBeforeComponent:function _selectBeforeComponentFn(range,node,fnName){var prevComponent=this._getPrevComponent(node),isPrevSelectable=this._isComponentSelectable(prevComponent);if(isPrevSelectable)range[fnName](prevComponent,this._getComponentNodeLength(prevComponent));else{var newTarget=document.createTextNode("");node.parentNode.insertBefore(newTarget,node),range[fnName](newTarget,0)}},_selectAfterComponent:function _selectAfterComponentFn(range,node,fnName){var nextComponent=this._getNextComponent(node),isNextSelectable=this._isComponentSelectable(nextComponent);if(isNextSelectable)range[fnName](nextComponent,0);else{var newTarget=document.createTextNode("");node.parentNode.insertBefore(newTarget,void 0),range[fnName](newTarget,0)}},_getPrevComponent:function _getPrevComponentFn(node){try{g.PAssert(3409,node,"Must supply a valid node")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3410,this._isComponentNode(node),"Supplied node must be a valid component itself")}catch(PERR){g.reportError(PERR)}var prevNode=node.previousSibling;try{g.PAssert(3411,!prevNode||this._isComponentNode(prevNode),"Siblings must always be valid components")}catch(PERR){g.reportError(PERR)}return prevNode},_getNextComponent:function _getNextComponentFn(node){try{g.PAssert(3412,node,"Must supply a valid node")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3413,this._isComponentNode(node),"Supplied node must be a valid component itself")}catch(PERR){g.reportError(PERR)}var nextNode=node.nextSibling;try{g.PAssert(3414,!nextNode||this._isComponentNode(nextNode),"Siblings must always be valid components")}catch(PERR){g.reportError(PERR)}return nextNode},selectElement:function selectElementFn(element,offset){var range;if(offset){var offsetInfo=this.getOffsetChildElement(element,offset);offsetInfo&&(range=this.createFakeRange(offsetInfo.element,offsetInfo.offset,offsetInfo.element,offsetInfo.offset))}else range=this.createSelectionRange(),range.selectNodeContents(element);range&&this.setSelectionRange(range)},getSelectionInElement:function getSelectionInElementFn(element){var range=this._getSelectionRange();if(range&&g.isAncestor(range.startContainer,element)&&g.isAncestor(range.endContainer,element)){var offsets=this.getSelectOffsetsInElement(element,range);return offsets}}},new NativeSel}),define("EditHelpers",[],function(){function EditHelpers(){}var chars=[" ","-","/"];return EditHelpers.prototype={getPreviousWord:function getPreviousWordFn(text,offset){for(var max=-1,i=0;i<chars.length;i++)max=Math.max(max,text.prevIndexOf(chars[i],offset-1));return max},getNextWord:function getNextWordFn(text,offset){for(var min=text.length,i=0;i<chars.length;i++){var index=text.indexOf(chars[i],offset);index>=0&&(min=Math.min(min,index))}return min}},new EditHelpers}),define("Multiselect",["require","exports","module","globals","Constants","util","platform","EventDispatcher","Observable","ObservableArray"],function(require,exports,module){function Multiselect(){this.selected={},this.numSelected=new Observable(0)}var g=require("globals"),C=require("Constants"),util=require("util"),platform=require("platform"),EventDispatcher=require("EventDispatcher"),Observable=require("Observable"),ObservableArray=require("ObservableArray");return Multiselect.prototype={_selectedObjForPane:function _selectedObjForPaneFn(pane){try{g.PAssert(3415,pane,"Multiselect should always pass in a pane")}catch(PERR){g.reportError(PERR)}pane=pane||g.focusedPane;var s=this.selected[pane.id];return s||(s=this.selected[pane.id]={arr:new ObservableArray,isInverted:!1},platform.mobile&&s.arr.listen(this.onChanged.bind(this,pane))),s},_selectedForPaneObs:function _selectedForPaneObsFn(pane){return this._selectedObjForPane(pane).arr},_selectedForPane:function _selectedForPaneFn(pane){return this._selectedObjForPane(pane).arr.get()},onChanged:function onChangedFn(pane){this.numSelected.set(this.numSelectedInPane(pane))},isInverted:function isInvertedFn(pane){return this._selectedObjForPane(pane).isInverted},setInverted:function setInvertedFn(value,pane){this._selectedObjForPane(pane).isInverted=value},isSelected:function isSelectedFn(index,pane){return this._selectedForPane(pane).indexOf(index)>=0},getSelected:function getSelectedFn(pane){return this._selectedForPane(pane)},getSelectedItems:function getSelectedItemsFn(pane,includeNotes){for(var selected=this._selectedForPane(pane),items=[],i=0;i<selected.length;++i){var index=selected[i];if(pane.numItems()>index){var item=pane.itemAtIndex(index);!item||!includeNotes&&item.isNote()||items.push(item)}}return items},numSelectedInPane:function numSelectedInPaneFn(pane){for(var num=0,arr=this._selectedForPane(pane),i=0;i<arr.length;i++){var item=pane.itemAtIndex(arr[i]);!item||item.isNote&&item.isNote()||num++}return num},getFirstSelectedIndex:function getFirstSelectedIndexFn(pane){pane=pane||g.focusedPane;for(var selected=this._selectedForPane(pane),fIndex=Number.MAX_VALUE,found=!1,i=0;i<selected.length;i++){var index=selected[i];fIndex>index&&(fIndex=index,found=!0)}return found?fIndex:-1},getFirstSelectedItem:function getFirstSelectedItemFn(pane){pane=pane||g.focusedPane;var index=this.getFirstSelectedIndex(pane);return index>=0?pane.itemAtIndex(index):void 0},getLastSelectedIndex:function getLastSelectedIndexFn(pane){pane=pane||g.focusedPane;for(var selected=this._selectedForPane(pane),fIndex=-1,i=0;i<selected.length;i++){var index=selected[i];index>fIndex&&(fIndex=index)}return fIndex},getLastSelectedItem:function getLastSelectedItemFn(pane){pane=pane||g.focusedPane;var index=this.getLastSelectedIndex(pane);return index>=0?pane.itemAtIndex(index):void 0},_resetPaneID:function _resetPaneIDFn(paneID){var pm=g.vmMain.paneManager,didReset=!0;if(pm.isPaneActive(paneID)){var pane=pm.getPaneById(paneID);pane.canResetMultiselect()?(this.setSelected([],pane),this.selected[paneID].isInverted=!1):didReset=!1}else delete this.selected[paneID];return didReset},reset:function resetFn(pane){var didReset=!0;if(pane)pane.canResetMultiselect()?this._resetPaneID(pane.id):didReset=!1;else for(var paneID in this.selected)this.selected.hasOwnProperty(paneID)&&(didReset=didReset&&this._resetPaneID(paneID));didReset&&this.fireEvent("reset",[pane])},setSelected:function setSelectedFn(indices,pane){pane=pane||g.focusedPane;var selected=this._selectedForPane(pane),toNotify=g.arrayUnion(selected,indices);this.setInverted(!1,pane),this._selectedForPaneObs(pane).set(indices);for(var i=0;i<toNotify.length;i++){var n=toNotify[i];if(n<pane.numItems()){var item=pane.itemAtIndex(n);item&&item.itemChanged.notify()}}},toggleSelected:function toggleSelectedFn(index,pane,value){pane=pane||g.focusedPane;var selected=this._selectedForPaneObs(pane),item=pane.itemAtIndex(index),i=selected.indexOf(index);i>=0&&value!==!0?(selected.remove(index),item.itemChanged.notify()):0>i&&value!==!1&&(selected.push(index),item.itemChanged.notify())},addSelected:function addSelectedFn(index,pane){this.toggleSelected(index,pane,!0)},removeSelected:function removeSelectedFn(index,pane){this.toggleSelected(index,pane,!1)},selectInOrder:function selectInOrderFn(startIndex,endIndex,pane){pane=pane||g.focusedPane;for(var indices=[],i=startIndex;endIndex>=i;i++)indices.push(i);this.setSelected(indices,pane)},applyFnToSelected:function applyFnToSelectedFn(fn,pane){g.vmMain.beginUpdateItems(),pane=pane||g.focusedPane;for(var items=this.getSelectedItems(pane),i=0;i<items.length;i++)fn(items[i],i,items.length);g.vmMain.commitUpdateItems()}},util.extend(Multiselect.prototype,EventDispatcher),new Multiselect}),define("Sel",["globals","Constants","platform","data","util","Dispatcher","Measure","Observable","NativeSel","EditHelpers","DisplaySettings","Multiselect"],function(g,C,platform,d,util,Dispatcher,Measure,Observable,NativeSel,EditHelpers,DisplaySettings,Multiselect){function Sel(){this._isValid=!1,this._isInRightClick=!1,this._isDirty=!1,this._isWatchingChange=!0,this._isMouseDown=!1,this.isWindowFocused=new Observable(!0),this.hoveredItem=void 0,this.hoveredReactCell=void 0,this._previousSelectedIndex=void 0,this._previousIsValid=void 0,this._selectedMap=[],this.mousePos={x:-1,y:-1},this.mouseDownPos={x:-1,y:-1},this._lastClickTime=0,this._numClicks=1,this.pane=new Observable,this.init()}var InvalidOffset=-1,SelectionSide={Start:"start",End:"end"},DragDrop,android,edit;return require(["DragDrop","android","edit"],function(DragDropLoad,AndroidLoad,editLoad){DragDrop=DragDropLoad,android=AndroidLoad,edit=editLoad}),Sel.prototype={init:function initFn(){this.reset();var clickHandlers={};platform.mobile?(clickHandlers.onMove=this.onMouseMoveMobile.bind(this),document.addEventListener("selectstart",this._onSelectStart.bind(this)),document.addEventListener("selectionchange",this._onSelectionChange.bind(this))):(clickHandlers.onStart=this.onMouseDown.bind(this),clickHandlers.onEnd=this.onMouseUp.bind(this),clickHandlers.onRightStart=this.onRightMouseDown.bind(this),clickHandlers.onMove=this.onMouseMove.bind(this),document.addEventListener("mousemove",this.onMouseMoveDocument.bind(this),!0)),g.setupClick(document,this,clickHandlers),window.addEventListener("blur",this.onWindowBlur.bind(this)),window.addEventListener("focus",this.onWindowFocus.bind(this)),Dispatcher.listen("paneAdded",this.onPaneAdded.bind(this)),Dispatcher.listen("paneRemoved",this.onPaneRemoved.bind(this)),util.forceBind("onScroll",this)},reset:function resetFn(continueEditing){this._isValid&&(this._setOffset(SelectionSide.Start,void 0),this._setIndex(SelectionSide.Start,void 0),this._setOffset(SelectionSide.End,void 0),this._setIndex(SelectionSide.End,void 0),this._dblClickOffsets=void 0,this.preferLineStart=!1,this._mouseOffset=-1,this._mouseMoved=!1,this._isValid=!1,this._isArrowSelectInverted=!1,this.getPane()&&this.getPane().caretPosition.set(void 0),this._updateSelection(),platform.mobile&&g.keyboardToolbar&&(Multiselect.reset(),continueEditing||edit.isTyping||Dispatcher.fireEvent("closeKeyboard",[])))},dumpState:function dumpStateFn(){var state={isValid:this._isValid,isDirty:this._isDirty,isWatchingChange:this._isWatchingChange,isMouseDown:this._isMouseDown,isWindowFocused:this.isWindowFocused.get(),numClicks:this._numClicks,start:{index:this.startIndex,offset:this.startOffset},end:{index:this.endIndex,offset:this.endOffset}};try{var hasPane=!!this.pane.get();state.paneInfo=hasPane?{hasPane:hasPane,id:this.pane.get().id,numItems:this.pane.get().items.get().length,displayTop:this.pane.get().indexOfTop(),displayCount:this.pane.get().inViewCount()}:"No Pane Set"}catch(err){state.paneInfo="Invalid Pane"}try{void 0!==this.startIndex&&(state.start.item=this.pane.get().items.get()[this.startIndex].id)}catch(err){state.start.item="Invalid Item"}try{void 0!==this.endIndex&&(state.end.item=this.pane.get().items.get()[this.endIndex].id)}catch(err){state.end.item="Invalid Item"}return state},setValid:function setValidFn(valid){if(valid){try{g.PAssert(3416,!isNaN(this.getStartIndex())&&this.getStartIndex()>=0,"Must have a valid start index when sel is valid: ",this.getStartIndex())}catch(PERR){g.reportError(PERR)}try{g.PAssert(3417,!isNaN(this.getEndIndex())&&this.getEndIndex()>=0,"Must have a valid end index when sel is valid: ",this.getEndIndex())}catch(PERR){g.reportError(PERR)}}else this.reset();this._isValid=valid},isArrowSelectInverted:function isArrowSelectInvertedFn(){return this._isArrowSelectInverted},setArrowSelectInverted:function setArrowSelectInvertedFn(value){this._isArrowSelectInverted=value},getStartItem:function getStartItemFn(){return this.getPane().itemAtIndex(this.startIndex)},getStartObject:function getStartObjectFn(){return this.getPane().objectAtIndex(this.startIndex)},getStartOffset:function getStartOffsetFn(){var startOffset;return this.startOffset===InvalidOffset?(startOffset=this.getStartTotal(),this.startOffset=startOffset):startOffset=this.startOffset,startOffset},getStartIndex:function getStartIndexFn(){return this.startIndex},getStartTotal:function getStartTotalFn(){return this.getStartItem().getParsedText().length},getEndItem:function getEndItemFn(){return this.getPane().itemAtIndex(this.endIndex)},getEndObject:function getEndObjectFn(){return this.getPane().objectAtIndex(this.endIndex)},getEndOffset:function getEndOffsetFn(){var endOffset;return this.endOffset===InvalidOffset?(endOffset=this.getEndTotal(),this.endOffset=endOffset):endOffset=this.endOffset,endOffset},getEndIndex:function getEndIndexFn(){return this.endIndex},getEndTotal:function getEndTotalFn(){return this.getEndItem().getParsedText().length},isMouseDown:function isMouseDownFn(){return this._isMouseDown},_mutateProperty:function _mutatePropertyFn(updateProp,value){var oldValue=this[updateProp];this[updateProp]=value,oldValue!==value&&(this._isDirty=!0)},_setIndex:function _setIndexFn(toUpdate,index){this._mutateProperty(toUpdate+"Index",index)},_setOffset:function _setOffsetFn(toUpdate,offset){this._mutateProperty(toUpdate+"Offset",offset)},isValid:function isValidFn(){return this._isValid},checkValid:function checkValidFn(){var isValid=!1,pane=this.getPane();if(pane&&this.startIndex>=0&&this.startIndex<pane.numItems()&&this.endIndex>=0&&this.endIndex<pane.numItems())if(this.getStartItem()&&this.getEndItem()){var startItem=this.getStartItem(),startText=android.isEnabled()?android.getInputText():startItem.getParsedText(),endItem=this.getEndItem(),endText=android.isEnabled()?android.getInputText():endItem.getParsedText();this.startOffset>=0&&this.startOffset<=startText.length&&this.endOffset>=0&&this.endOffset<=endText.length&&(isValid=!0)}else isValid=!1;return!isValid&&this.isValid()&&(log("Sel is now invalid"),this.reset()),isValid},getPane:function getPaneFn(){try{g.PAssert(3418,this.pane.get()===g.focusedPane,"Should these always match?")}catch(PERR){g.reportError(PERR)}return this.pane.get()},clearSelection:function clearSelectionFn(continueEditing){this.reset(continueEditing)},onPaneAdded:function onPaneAddedFn(pane){pane.useCustomScroller||platform.mobile||pane.addScrollListener(this.onScroll)},onPaneRemoved:function onPaneRemovedFn(pane){pane.useCustomScroller||platform.mobile||pane.removeScrollListener(this.onScroll),this.getPane()===pane&&this.setFocusedPane(void 0)},onScroll:function onScrollFn(e){var pane=g.getPaneForElement(e.target);if(this._isMouseDown&&pane===this.getPane()&&pane.isWriteable&&!DragDrop.isDragging){var pos=this.mousePos;this._mouseOffset=this.mousePos.y+pane.getScrollTop(),e.clientX=pos.x,e.clientY=pos.y;var target=e.target,params={clientX:pos.x,clientY:pos.y,target:target};this._updateFromMouse(params),this._updateSelection()}},onRightMouseDown:function onRightMouseDownFn(e){var ok=!0,li=g.getElementParent(e.target);if(li){var reactCell=g.getReactCellForElement(li);if(reactCell){var pane=g.getPaneForElement(li),index=reactCell.getIndex();this.isSelected(index,pane)&&(ok=!1)}}ok&&(this._isInRightClick=!0,this.onMouseDown(e,!0),this._isInRightClick=!1)},checkDoubleClick:function checkDoubleClickFn(){this._isValid&&this.getStartIndex()===this.getEndIndex()&&this.getStartOffset()!==this.getEndOffset()&&(this._dblClickOffsets={index:this.getStartIndex(),start:this.getStartOffset(),end:this.getEndOffset()}),this._dblClickTimeout=void 0},onMouseDown:function onMouseDownFn(e,isRightClick){var pane=g.getPaneForElement(e.target);if(this.isWindowFocused.set(!0),pane){this.setFocusedPane(pane);var hovered=e.target;if(!(g.hasClass(hovered,"itemCheckbox")||g.findParent(hovered,"searchWrap")||!isRightClick&&g.hasClass(hovered,"collapser"))){isRightClick||(this._isMouseDown=!0),this._selectionBeforeBlur=void 0,this.preferLineStart=void 0;var MAGIC_NUMBER_1=2,MAGIC_NUMBER_2=300;if(isRightClick)this._numClicks=1,this._lastClickTime=0,this._dblClickOffsets=void 0;else{var time=Date.now();time-this._lastClickTime<MAGIC_NUMBER_2&&Math.abs(e.pageX-this.mouseDownPos.x)<MAGIC_NUMBER_1&&Math.abs(e.pageY-this.mouseDownPos.y)<MAGIC_NUMBER_1?this._numClicks++:(this._numClicks=1,this._dblClickOffsets=void 0),this._lastClickTime=time}this.mouseDownPos.x=e.pageX,this.mouseDownPos.y=e.pageY,pane.onFocus();var downLI=g.getElementParent(e.target),valid=!1;if(g.findParent(hovered,"paneContent")){if(pane&&pane.isWriteable){if(downLI){var range=NativeSel.getCursorSelectionRange(e);if(range){var downReactCell=g.getReactCellForElement(e.target);if(downReactCell&&!downReactCell.props.overview){if(e.shiftKey)this._mouseMoved=!0,this._mouseOffset=e.eventY+pane.getScrollTop(),this._updateFromMouse(e);else if(1===this._numClicks||this._numClicks>3){this._downIndex=downReactCell.getIndex();try{g.PAssert(3422,this._downIndex>=0,"Must have a valid index in react item")}catch(PERR){g.reportError(PERR)}if(this._downIndex<0)try{g.PAssert(3423,this._downIndex>=0,"Dead cell error",g.getElementPath(range.getStartElement()),g.getElementPath(e.target))}catch(PERR){g.reportError(PERR)}this._downItem=downReactCell.getItem();try{g.PAssert(3424,this._downItem,"Must have a valid item in react item")}catch(PERR){g.reportError(PERR)}this._setIndex(SelectionSide.Start,this._downIndex),this._setIndex(SelectionSide.End,this._downIndex);var offsets=range.getSelectOffsetsInElement(downLI);this._downOffset=offsets.start,this._setOffset(SelectionSide.Start,this._downOffset),this._setOffset(SelectionSide.End,this._downOffset)}else if(2===this._numClicks){var text=this._downItem.getParsedText(),prevWord=EditHelpers.getPreviousWord(text,this._downOffset)+1,nextWord=EditHelpers.getNextWord(text,this._downOffset);this._setOffset(SelectionSide.Start,prevWord),this._setOffset(SelectionSide.End,nextWord)}else 3===this._numClicks&&(this._setOffset(SelectionSide.Start,0),this._setOffset(SelectionSide.End,this._downItem.getParsedText().length));valid=!0}}}else if(pane.hasNonVMLIs){var wrapperObject=g.dataFor(e.target,!0,!0);if(wrapperObject)if(g.isPane(wrapperObject))valid=!1,e.preventDefault();else{var index=wrapperObject.index;if(index>=0){var item=pane.itemAtIndex(index);item||(index=pane.indexOfNextVMLI(index)),index>=0&&(this._downIndex=index,this._setIndex(SelectionSide.Start,index),this._setIndex(SelectionSide.End,index),this._downOffset=0,this._setOffset(SelectionSide.Start,0),this._setOffset(SelectionSide.End,0),valid=!0)}}}else if(g.findParent(e.target,"paneContent")&&!g.findParent(e.target,"addItemButton")){var selIndex=g.focusedPane.indexOfLastItem();selIndex>=0&&(e.shiftKey&&this.isValid()&&!isRightClick?this.selectIndices(this.getStartIndex(),this.getStartOffset(),selIndex,-1):this.selectIndex(selIndex,-1),valid=!0),e.preventDefault()}this._dblClickTimeout=setTimeout(this.checkDoubleClick.bind(this),0)}}else;this.setValid(valid&&this.checkValid()),this.isValid()&&(g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),this._updateSelection(),g.vmMain.resetItemAnimationMode())}}},getMousePos:function getMousePosFn(){return this.mousePos},onMouseMoveDocument:function onMouseMoveDocumentFn(e){this.mousePos.x=e.pageX,this.mousePos.y=e.pageY},onMouseMove:function onMouseMoveFn(e){try{g.PAssert(3425,!platform.mobile,"Should not be called on mobile")}catch(PERR){g.reportError(PERR)}if(this._dblClickTimeout&&(clearTimeout(this._dblClickTimeout),this._dblClickTimeout=void 0),e.target!==document.documentElement){var pane=g.getPaneForElement(e.target);if(this._isValid&&this._isMouseDown&&pane===this.getPane()&&pane.isWriteable&&!DragDrop.isDragging)return this._mouseMoved=!0,g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),this._mouseOffset=e.eventY+pane.getScrollTop(),this._updateFromMouse(e),this._updateSelection(),Math.abs(e.diffY)>40&&pane.scrollFromMousePosition(e.clientY),e.preventDefault(),!1}},onMouseMoveMobile:function onMouseMoveMobileFn(e){this.mousePos.x=e.pageX||e.clientX,this.mousePos.y=e.pageY||e.clientY},onMouseUp:function onMouseUpFn(e){this._isMouseDown=!1,g.vmMain&&g.vmMain.resetItemAnimationMode();var pane=g.isAttachedToDoc(e.target)&&g.getPaneForElement(e.target),downLI=pane&&g.getElementParent(e.target);downLI&&this.updateCaret(),g.cancelRepeatScroll()},focusPane:function focusPaneFn(pane){this.setFocusedPane(pane),pane.focus(),this.updateCaret()},setFocusedPane:function setFocusedPaneFn(pane){pane&&g.focusedPane&&g.focusedPane.id===pane.id||(this.reset(),Multiselect.reset(g.focusedPane),g.focusedPane=pane,g.focusedItem=pane?pane.getItem():void 0,this.pane.set(pane))},_updateWith:function _updateWithFn(toUpdate,whichSelect,range){var container=whichSelect===SelectionSide.Start?range.getStartElement():range.getEndElement();try{g.PAssert(3426,container,"Trying to select in invalid container")}catch(PERR){g.reportError(PERR)}if(container){var reactCell=g.getReactCellForElement(container),li=g.getElementParent(container),offsets=range.getSelectOffsetsInElement(li),offsetsValue=whichSelect===SelectionSide.Start?offsets.start:offsets.end;try{g.PAssert(3427,reactCell.getItem(),"Should not be updating ReactCells without VMLIs")}catch(PERR){g.reportError(PERR)}if(this._setIndex(toUpdate,reactCell.getIndex()),this._dblClickOffsets&&reactCell.getIndex()===this._dblClickOffsets.index)if(toUpdate===SelectionSide.Start)offsetsValue=Math.min(offsetsValue,this._dblClickOffsets.start);else if(toUpdate===SelectionSide.End)offsetsValue=Math.max(offsetsValue,this._dblClickOffsets.end);else try{g.PAssert(3428,!1,"Invalid toUpdate value")}catch(PERR){g.reportError(PERR)}this._setOffset(toUpdate,offsetsValue);try{g.PAssert(3429,!isNaN(offsetsValue),"Selection offsets should not be undefined")}catch(PERR){g.reportError(PERR)}}},_setSelectionOnSide:function _setSelectionOnSideFn(side,index,offset){var otherSide=side===SelectionSide.Start?SelectionSide.End:SelectionSide.Start;this._setIndex(side,index),this._setOffset(side,offset),this._setIndex(otherSide,this._downIndex),this._setOffset(otherSide,this._downOffset),this.setArrowSelectInverted(index<this._downIndex||index===this._downIndex&&offset<this._downOffset)},_updateFromMouse:function _updateFromMouseFn(e){try{g.PAssert(3430,!platform.mobile,"Should never be reading selection values from mouse on mobile, only accept taps")}catch(PERR){g.reportError(PERR)}var target=e.target;if(target){var pane=g.focusedPane;if(!g.getElementParent(target)&&e.clientY<pane.contentTop()){target=g.elementFromPoint(e.clientX,pane.contentTop()+1,e.target);
var element=g.getElementParent(target);if(element){var reactCell=g.getReactCellForElement(target),item=g.getItemForElement(target);try{g.PAssert(3431,item,"If it is an LI it should be an item",target)}catch(PERR){g.reportError(PERR)}this._setIndex(SelectionSide.Start,reactCell.getIndex()),this._setOffset(SelectionSide.Start,0)}}else{var li=g.getElementParent(e.target),index,offset,range;if(li){if(range=NativeSel.getCursorSelectionRange(e),range&&range.getStartElement()){var reactCell=g.getReactCellForElement(e.target);try{g.PAssert(3432,reactCell,"Must be able to find a valid reactCell for the start element")}catch(PERR){g.reportError(PERR)}if(reactCell){if(index=reactCell.getIndex(),0>index)try{g.PAssert(3434,index>=0,"Dead cell error",g.getElementPath(range.getStartElement()),g.getElementPath(e.target))}catch(PERR){g.reportError(PERR)}if(g.findParent(range.getStartContainer(),"line")&&g.findParent(range.getEndContainer(),"line")){var offsets=range.getSelectOffsetsInElement(li);offset=offsets.start}else g.findParent(range.getStartContainer(),"collapser")&&g.findParent(range.getEndContainer(),"collapser")&&(index<=this._downIndex?this._setSelectionOnSide(SelectionSide.Start,index,0):this._setSelectionOnSide(SelectionSide.End,index,0))}}}else if(pane.hasNonVMLIs){var paneObject=g.dataFor(e.target,!1,!0);if(paneObject){var rIndex=paneObject.index;if(rIndex>=0){var item=pane.itemAtIndex(rIndex);if(!item)if(rIndex<this._downIndex){var newIndex=pane.indexOfNextVMLI(rIndex);newIndex>=0&&this._setSelectionOnSide(SelectionSide.Start,newIndex,0)}else{var newIndex=pane.indexOfPrevVMLI(rIndex);if(newIndex>=0){var item=pane.itemAtIndex(newIndex);this._setSelectionOnSide(SelectionSide.End,newIndex,item.getParsedText().length)}}}}}else if(g.hasClass(target,"paneContent")){var lastItem=pane.getLastItem();this._setIndex(SelectionSide.End,pane.numItems()-1),this._setOffset(SelectionSide.End,lastItem?lastItem.getParsedText().length:0)}if(!isNaN(index)&&!isNaN(offset)&&range){var toUpdate;index<this._downIndex||index===this._downIndex&&offset<this._downOffset?(toUpdate=SelectionSide.End,this._updateWith(SelectionSide.Start,SelectionSide.Start,range),this.setArrowSelectInverted(!0)):(index>this._downIndex||index===this._downIndex&&offset>=this._downOffset)&&(toUpdate=SelectionSide.Start,this._updateWith(SelectionSide.End,SelectionSide.End,range),this.setArrowSelectInverted(!1),offset===this._downOffset&&(this._isDirty=!0)),void 0!==toUpdate&&(this._setIndex(toUpdate,this._downIndex),this._dblClickOffsets?this._setOffset(toUpdate,this._dblClickOffsets[toUpdate]):this._setOffset(toUpdate,this._downOffset),this.setValid(!0))}}}},setSelectionFromNativeRange:function setSelectionFromNativeRangeFn(range){this._updateWith(SelectionSide.Start,SelectionSide.Start,range),this._updateWith(SelectionSide.End,SelectionSide.End,range),this.setValid(!isNaN(this.getStartIndex())&&!isNaN(this.getEndIndex()))},_updateSelection:function _updateSelectionFn(force){if(this._isDirty||force){var numNotified=0,pane=this.getPane(),oldSelected=this._selectedMap;if(this._selectedMap=[],this.setValid(!isNaN(this.getStartIndex())&&!isNaN(this.getEndIndex())),this.getStartIndex()===this.getEndIndex()&&void 0!==this.getStartIndex()){try{g.PAssert(3435,!isNaN(this.getStartOffset())&&!isNaN(this.getEndOffset()),"Selection offsets should not be undefined")}catch(PERR){g.reportError(PERR)}platform.mobile&&Multiselect.setSelected([this.getStartIndex()],pane),this.getStartOffset()!==this.getEndOffset()&&(this._selectedMap[this.getStartIndex()]={start:this.getStartOffset(),end:this.getEndOffset()})}else for(var i=this.getStartIndex();i<=this.getEndIndex();++i){var offsets;if(i===this.getStartIndex())offsets={start:this.getStartOffset(),end:InvalidOffset};else if(i===this.getEndIndex()){try{g.PAssert(3436,this.getEndOffset()<=this.getEndItem().getParsedText().length,"Selection is past end of text string")}catch(PERR){g.reportError(PERR)}offsets={start:0,end:this.getEndOffset()}}else offsets=!0;this._selectedMap[i]=offsets}pane&&(oldSelected.forEach(function(selection,oldIndex){if(void 0===this._selectedMap[oldIndex]&&oldIndex<pane.numItems()){var item=pane.itemAtIndex(oldIndex);item&&(item.itemChanged.notify(),numNotified++)}}.bind(this)),this._selectedMap.forEach(function(selection,newIndex){var oldSel=oldSelected[newIndex],newSel=this._selectedMap[newIndex];if(void 0===oldSel||oldSel.start!==newSel.start||oldSel.end!==newSel.end){var item=pane.itemAtIndex(newIndex);item&&(item.itemChanged.notify(),numNotified++)}}.bind(this))),this.updateCaret(),this._isDirty=!1,Dispatcher.fireEvent("selectionChanged",[]);var index=this.getStartIndex(),isValid=this.isValid();if(index===this.getEndIndex()||!isValid){if(index!==this._previousSelectedIndex||isValid!==this._previousIsValid){var startItem=isValid?this.getStartItem():void 0;Dispatcher.fireEvent("selectedIndexChanged",[index,pane,startItem])}this._previousSelectedIndex=index,this._previousIsValid=isValid}}},_onSelectStart:function _onSelectStartFn(e){return DragDrop=DragDrop||require("DragDrop"),log("Select Start: ",DragDrop.isDragging,e),DragDrop.isDragging?(e.preventDefault(),!1):!0},_onSelectionChange:function _onSelectionChangeFn(e){if(NativeSel.hasSelection()){if(platform.android&&DragDrop.isDragging)return void NativeSel.clearSelection();if(platform.ios)if(this.getPane().isWriteable){var range=NativeSel.getSelectionRange(),start=g.findParent(range.getStartElement(),"item"),end=g.findParent(range.getEndElement(),"item"),isValid=start&&end&&!g.hasClass(start,"dead")&&!g.hasClass(end,"dead");isValid&&this.setSelectionFromNativeRange(range)}else this.reset()}NativeSel.getSelectionRange(!0).isValid()||g.closeKeyboard()},updateCaret:function updateCaretFn(){var pane=this.getPane();if(pane&&pane.isWriteable){var openNotePopup=this.isValid()&&!this._isInRightClick&&this.getStartItem()===this.getEndItem()&&this.getStartItem()&&this.getStartItem().isNote();if(openNotePopup?pane.openNoteContextMenu():this.isValid()&&g.menus.isContextMenuOpen()&&g.menus.closeContextMenuReact(),!platform.ios)if(this.isValid()){if(this.getStartItem()&&this.getEndItem()&&this.getStartIndex()===this.getEndIndex()&&this.getStartOffset()===this.getEndOffset()){var item=this.getStartItem(),itemTop=pane.topOfIndex(this.getStartIndex()),padding=pane.getPaddingForItem(this.getStartItem()),caretPosition=Measure.getCaretOffset(item,pane,this.getStartOffset(),this.preferLineStart);caretPosition.left+=padding,caretPosition.top+=itemTop+(platform.mobile?0:DisplaySettings.paddingForItemTop(item)),(pane.caretPosition.left!==caretPosition.left||pane.caretPosition.top!==caretPosition.top)&&pane.caretPosition.set(caretPosition)}else pane.caretPosition.set(void 0);openNotePopup||(android.isEnabled()?android.updateInput(this.getStartIndex()):pane.hiddenInput&&this.focusHiddenInput())}else pane.caretPosition.set(void 0)}},focusHiddenInput:function focusHiddenInputFn(){var pane=this.getPane();if(pane&&pane.hiddenInput){var range=NativeSel.createSelectionRange(),emp=pane.hiddenInput;emp.firstChild&&0!==emp.firstChild.length||(emp.innerHTML=TextSpace);var selEle=emp.firstChild;try{g.PAssert(3440,selEle,"Empty element must have a valid child")}catch(PERR){g.reportError(PERR)}try{range.setStart(selEle,0),range.setEnd(selEle,1),NativeSel.setSelectionRange(range)}catch(err){g.reportError(err)}}},isSelected:function isSelectedFn(index,pane){return pane!==this.getPane()?!1:!!this._selectedMap[index]},getSelectionAtIndex:function getSelectionAtIndexFn(index){return this._selectedMap[index]},setSelectionFromAndroid:function setSelectionFromAndroidFn(startOffset,endOffset){this._setOffset(SelectionSide.Start,startOffset),this._setOffset(SelectionSide.End,endOffset)},selectIndex:function selectIndexFn(index,startOffset,endOffset){return void 0===endOffset&&(endOffset=startOffset),this.selectIndices(index,startOffset,index,endOffset)},selectIndices:function selectIndicesFn(startIndex,startOffset,endIndex,endOffset){try{g.PAssert(3441,startIndex>=0,"Must supply a valid start index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3442,endIndex>=0,"Must supply a valid end index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3443,endIndex>startIndex||endIndex===startIndex&&(endOffset>=startOffset||endOffset===InvalidOffset),"Must not pass reversed selection")}catch(PERR){g.reportError(PERR)}if(!(0>startIndex||0>endIndex)){var didSelect=!1;if(!this.isValid()||platform.ios||startIndex!==this.getStartIndex()||startOffset!==this.getStartOffset()||endIndex!==this.getEndIndex()||endOffset!==this.getEndOffset()){var pane=this.getPane(),startItem,endItem;if(pane&&pane.isWriteable){startItem=pane.itemAtIndex(startIndex),endItem=pane.itemAtIndex(endIndex);try{g.PAssert(3444,startItem,"Trying to select invalid start index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3445,endItem,"Trying to select invalid end index")}catch(PERR){g.reportError(PERR)}}if(startItem&&endItem){this._setIndex(SelectionSide.Start,startIndex),this._setOffset(SelectionSide.Start,startOffset),this._setIndex(SelectionSide.End,endIndex),this._setOffset(SelectionSide.End,endOffset),this._downIndex=startIndex,this._downOffset=startOffset;try{g.PAssert(3446,!isNaN(this.getStartOffset())&&!isNaN(this.getEndOffset()),"Selection offsets should not be undefined")}catch(PERR){g.reportError(PERR)}if(!isNaN(this.getStartOffset())&&this.getStartOffset()>=0&&!isNaN(this.getEndOffset())&&this.getEndOffset()<=this.getEndTotal()&&this._updateSelection(!0),platform.ios){var startElement=pane.elementAtIndex(startIndex),endElement=pane.elementAtIndex(endIndex);this.selectElements(startElement,startOffset,endElement,endOffset)}didSelect=!0}}else this.updateCaret();return didSelect}},selectItem:function selectItemFn(item,startOffset,endOffset){try{g.PAssert(3447,g.isNumber(startOffset),"Must pass a valid start offset")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3448,g.isNumber(endOffset)||void 0===endOffset,"Must pass a valid end offset")}catch(PERR){g.reportError(PERR)}return void 0===endOffset&&(endOffset=startOffset),this.selectItems(item,startOffset,item,endOffset)},selectItems:function selectItemsFn(startItem,oStart,endItem,oEnd){try{g.PAssert(3449,g.isVMLI(startItem),"Should only be passing VMLIs to start this fn")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3450,g.isVMLI(endItem),"Should only be passing VMLIs to end this fn")}catch(PERR){g.reportError(PERR)}var pane=this.getPane();if(pane){var startIndex=pane.indexOfItem(startItem);try{g.PAssert(3451,startIndex>=0,"Must be able to find the start item in the pane")}catch(PERR){g.reportError(PERR)}var endIndex=pane.indexOfItem(endItem);try{g.PAssert(3452,endIndex>=0,"Must be able to find the end item in the pane")}catch(PERR){g.reportError(PERR)}return this.selectIndices(startIndex,oStart,endIndex,oEnd)}},selectElements:function selectElementsFn(eStart,oStart,eEnd,oEnd){try{g.PAssert(3453,!g.isVMLI(eStart),"Should not be passing VMLIs to start this fn")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3454,!g.isVMLI(eEnd),"Should not be passing VMLIs to end this fn")}catch(PERR){g.reportError(PERR)}this._isWatchingChange=!1;var retVal=!1,start=NativeSel.getOffsetChildElement(eStart,oStart),end=NativeSel.getOffsetChildElement(eEnd,oEnd);try{g.PAssert(3455,start&&start.element&&!isNaN(start.offset),"Start element is invalid")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3456,end&&end.element&&!isNaN(end.offset),"End element is invalid")}catch(PERR){g.reportError(PERR)}if(start&&start.element&&end&&end.element){var range=NativeSel.createSelectionRange();NativeSel.setSelectionValues(range,start.element,start.offset,end.element,end.offset),NativeSel.setSelectionRange(range),retVal=!0}return this._isWatchingChange=!0,retVal},save:function saveFn(){if(!this._isValid)return void 0;try{g.PAssert(3457,!isNaN(this.getStartIndex()),"Start index must be valid")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3458,!isNaN(this.getEndIndex()),"End index must be valid")}catch(PERR){g.reportError(PERR)}return{pane:this.getPane(),startIndex:this.getStartIndex(),startItem:this.getStartItem(),startObject:this.getStartObject(),startOffset:this.getStartOffset(),endIndex:this.getEndIndex(),endItem:this.getEndItem(),endObject:this.getEndObject(),endOffset:this.getEndOffset()}},restore:function restoreFn(saved,adjust){var ret;return saved&&(this.pane.set(saved.pane),saved=saved.pane.adjustSelectionFromPaneObject(saved)),saved&&saved.startItem&&saved.endItem?(this.selectIndices(saved.startIndex,saved.startOffset,saved.endIndex,saved.endOffset),ret=!0):(this.reset(),ret=!1),ret},scrollStartIntoView:function scrollStartIntoViewFn(snap){if(this._isValid){try{g.PAssert(3459,!isNaN(this.getStartIndex()),"Start index must be valid")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3460,!isNaN(this.getEndIndex()),"End index must be valid")}catch(PERR){g.reportError(PERR)}g.focusedPane.scrollIndexIntoView(this.getStartIndex(),snap?ScrollDuration.Snap:ScrollDuration.Default)}},scrollEndIntoView:function scrollEndIntoViewFn(){if(this._isValid){try{g.PAssert(3461,!isNaN(this.getStartIndex()),"Start index must be valid")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3462,!isNaN(this.getEndIndex()),"End index must be valid")}catch(PERR){g.reportError(PERR)}g.focusedPane.scrollIndexIntoView(this.getEndIndex(),ScrollDuration.Default)}},onWindowBlur:function onWindowBlurFn(e){this.isWindowFocused.set(!1)},onWindowFocus:function onWindowFocusFn(e){this.isWindowFocused.set(!0)},getSelectedItems:function getSelectedItemsFn(includeNotes){if(!this._isValid)return[];for(var arr=[],pane=this.getPane(),i=this.getStartIndex();i<=this.getEndIndex();++i){var item=pane.itemAtIndex(i);!item||!includeNotes&&item.isNote()||arr.push(item)}return arr},getStartElement:function getStartElementFn(){return this._isValid&&!isNaN(this.getStartIndex())?this.getPane().elementAtIndex(this.getStartIndex()):void 0},setHovered:function setHoveredFn(pane,item,reactCell){if(this.hoveredReactCell!==reactCell){var oldItem=this.hoveredItem;this.hoveredItem=item,this.hoveredReactCell=reactCell,oldItem&&oldItem.itemChanged.notify(),item&&item.itemChanged.notify()}},isReactCellHovered:function isReactCellHoveredFn(reactCell){return this.hoveredReactCell===reactCell},isItemHovered:function isItemHoveredFn(item){return this.hoveredItem===item}},new Sel}),define("tracker",["globals","util","platform","data","gdata","Sel"],function(g,util,platform,d,gdata,Sel){function tracker(){this.disabled=!1,this.allowOfflineUndo=!1,this.cursor=-1,this.groupID=0,this.groups=[],this.externalUndoRedo=!1,this.undoRedoActive=!1,this.canRedo=!1,this.canUndo=!1,this._performingActions=!1,this._currentAction=[],this._actionsPreventUndo=!1,this._aggregateActions=0,this._externalStateChanged=[],util.forceBind("stateChangeForUndoRedo",this),this.init()}function undoInsert(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(3463,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),startIndex=0;"﻿"===oldText[0]&&(startIndex=1);var newText=oldText.slice(startIndex,entry.position)+oldText.slice(entry.position+entry.text.length);model.setText(newText,!0,ChangeType.Local),Sel.selectItem(model,entry.position)}}function redoInsert(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(3464,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),newText=oldText.slice(0,entry.position)+entry.text+oldText.slice(entry.position);0===newText.length&&(newText="﻿"),model.setText(newText,!0,ChangeType.Local),Sel.selectItem(model,entry.position,entry.position+entry.text.length)}}function undoRemove(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(3465,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),startIndex=0;"﻿"===oldText[0]&&(startIndex=1);var newText=oldText.slice(startIndex,entry.position)+entry.text+oldText.slice(entry.position);model.setText(newText,!0,ChangeType.Local),Sel.selectItem(model,entry.position,entry.position+entry.text.length)}}function redoRemove(data){for(var i=0;i<data.length;++i){var entry=data[i],model=d.getModel(entry.itemID);try{g.PAssert(3466,model,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var oldText=model.getParsedText(),newText=oldText.slice(0,entry.position)+oldText.slice(entry.position+entry.text.length);0===newText.length&&(newText="﻿"),model.setText(newText,!0,ChangeType.Local),Sel.selectItem(model,entry.position)}}function undoCreate(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(3467,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var removedChild=parentModel.removeChildAtIndex(entry.position,ChangeType.Local);try{g.PAssert(3468,removedChild.id===entry.itemID,"Expected data to match removed child: ",removedChild,entry)}catch(PERR){g.reportError(PERR)}removedChild.parent(void 0),d.deleteItem(removedChild,ChangeType.Local);var selectionChild=parentModel;entry.position>0&&(selectionChild=parentModel.getChild(entry.position-1)),g.focusedPane.indexOfItem(selectionChild)>=0&&Sel.selectItem(selectionChild,selectionChild.getParsedText().length),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function redoCreate(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(3469,parentModel,"Expected parent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newChild=d.getModel(entry.itemID);try{g.PAssert(3470,newChild,"Expected child model to exist: ",entry)}catch(PERR){g.reportError(PERR)}d.undeleteItem(newChild,ChangeType.Local),newChild.parent(parentModel),parentModel.items.splice(entry.position,0,newChild),Sel.selectItem(newChild,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function undoDelete(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(3472,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var childModel=d.getModel(entry.itemID);try{g.PAssert(3473,childModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}d.undeleteItem(childModel,ChangeType.Local),childModel.parent(parentModel),parentModel.items.splice(entry.position,0,childModel),platform.mobile||Sel.selectItem(childModel,0),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function redoDelete(data){for(var i=0;i<data.length;++i){var entry=data[i],parentModel=d.getModel(entry.parent);try{g.PAssert(3475,parentModel,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var removedChild=parentModel.removeChildAtIndex(entry.position,ChangeType.Local);try{g.PAssert(3476,removedChild.id===entry.itemID,"Expected data to match removed child: ",removedChild,entry)}catch(PERR){g.reportError(PERR)}removedChild.parent(void 0),d.deleteItem(removedChild,ChangeType.Local);var selectionChild=parentModel;entry.position>0&&(selectionChild=parentModel.getChild(entry.position-1)),Sel.selectItem(selectionChild,selectionChild.getParsedText().length),parentModel.save({items:parentModel.getItemsArrayForSave()},SaveFlag.None)}}function undoMove(data){for(var i=0;i<data.length;++i){var entry=data[i],oldParent=d.getModel(entry.oldParent);try{g.PAssert(3477,oldParent,"Expected oldParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newParent=d.getModel(entry.newParent);try{g.PAssert(3478,newParent,"Expected newParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var child=newParent.removeChildAtIndex(entry.newPosition,ChangeType.Local);try{g.PAssert(3479,child.id===entry.itemID,"Expected data to match child: ",child,entry)}catch(PERR){g.reportError(PERR)}child.parent(oldParent),oldParent.items.splice(entry.oldPosition,0,child),Sel.selectItem(child,0),newParent.save({items:newParent.getItemsArrayForSave()},SaveFlag.None),oldParent.save({items:oldParent.getItemsArrayForSave()},SaveFlag.None)}}function redoMove(data){for(var i=0;i<data.length;++i){var entry=data[i],oldParent=d.getModel(entry.oldParent);try{g.PAssert(3480,oldParent,"Expected oldParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var newParent=d.getModel(entry.newParent);try{g.PAssert(3481,newParent,"Expected newParent model to exist: ",entry)}catch(PERR){g.reportError(PERR)}var child=oldParent.removeChildAtIndex(entry.oldPosition,ChangeType.Local);try{g.PAssert(3482,child.id===entry.itemID)}catch(PERR){g.reportError(PERR)}child.parent(newParent),newParent.items.splice(entry.newPosition,0,child),Sel.selectItem(child,0),newParent.save({items:newParent.getItemsArrayForSave()},SaveFlag.None),oldParent.save({items:oldParent.getItemsArrayForSave()},SaveFlag.None)}}function undoUpdate(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(3483,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3484,item[entry.field],"Expected field to exist: ",entry)}catch(PERR){g.reportError(PERR)}item[entry.field](entry.oldValue)}}function redoUpdate(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(3485,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3486,item[entry.field],"Expected field to exist: ",entry)}catch(PERR){g.reportError(PERR)}item[entry.field](entry.newValue)}}function undoFormat(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(3487,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}}}function redoFormat(data){for(var i=0;i<data.length;++i){var entry=data[i],item=d.getModel(entry.itemID);try{g.PAssert(3488,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}}}function undoZoom(data){var entry=data[0],oldItem=d.getModel(entry.oldItemID);try{g.PAssert(3489,oldItem,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}if(entry.zoomIn)g.vmMain.zoomout(oldItem,!0);else if(entry.zoomOut)g.vmMain.zoomin(oldItem,!0);else try{g.PAssert(3490,!1,"Zoom action must define either zoomIn or zoomOut")}catch(PERR){g.reportError(PERR)}}function redoZoom(data){var entry=data[0],item=d.getModel(entry.itemID);try{g.PAssert(3491,item,"Expected model to exist: ",entry)}catch(PERR){g.reportError(PERR)}if(entry.zoomIn)g.vmMain.zoomout(item,!0);else if(entry.zoomOut)g.vmMain.zoomin(item,!0);else try{g.PAssert(3492,!1,"Zoom action must define either zoomIn or zoomOut")}catch(PERR){g.reportError(PERR)}}function undoUIAction(data){var entry=data[0];switch(entry.type){case TrackerUIAction.RemovePane:break;case TrackerUIAction.SwitchPaneMode:break;default:try{g.PAssert(3493,!1,"Invalid UIAction")}catch(PERR){g.reportError(PERR)}}}function redoUIAction(data){}window.TrackerType={Insert:1,Remove:2,SetText:3,Create:4,Delete:5,Move:6,Update:7,Format:8,Zoom:9,UIAction:10,Misc:11,Mobile:12},window.TrackerMisc={ToggleOverview:1,RightClick:2,CloseMessage:3,ChangeDate:4,AddContact:5,DropItem:6,SyncContacts:7,OpenContact:8,SearchChanged:10,OpenDocumentsMenu:11,AddDocument:12,OpenDocument:13,OpenDocSharing:14,Copy:15,Paste:16,OpenImport:17,OpenExport:18,UndoRedo:19,AddToGCal:20,OpenEmail:21,ComposeEmail:22,DriveUpload:23,OpenDisplaySettings:24},window.TrackerMiscMobile={OpenKeyboard:1,CloseKeyboard:2,PaneAgenda:3,PaneOutline:4,OpenAutocomplete:5,CloseAutocomplete:6,AtButton:7,OpenMultiselect:8,CloseMultiselect:9},window.TrackerUIAction={AddPane:1,RemovePane:2,SwitchPaneMode:3,OpenSettingsMenu:4};var MaxGroups=75;return tracker.prototype={init:function initFn(){this.listeners=[],gdata.registerForUndoRedoStateChange(this)},addListener:function addListenerFn(listener){this.listeners.push(listener)},_getNextGroupID:function _getNextGroupIDFn(){return this.groupID+1},_useNextGroupID:function _useNextGroupIDFn(){return++this.groupID},_getCurrentGroup:function _getCurrentGroupFn(){return this.groups[this.cursor]},_getCurrentAction:function _getCurrentActionFn(){return this.groups[this.cursor].events[this.groups[this.cursor].events.length-1]},_pushGroup:function _pushGroupFn(){var id=this._useNextGroupID();return this.groups.push({id:id,events:[],persisted:!1}),this.cursor<MaxGroups-1&&this.cursor++,this.groups.length>MaxGroups&&this._handleGroupTrimmed(this.groups.shift()),id},_doAction:function _doActionFn(type,data){var group=this._getCurrentGroup();try{g.PAssert(3494,group,"Expected group to exist")}catch(PERR){g.reportError(PERR)}var action={type:type,data:data};switch(type){case TrackerType.Insert:action.cb={undo:undoInsert,redo:redoInsert};break;case TrackerType.Remove:action.cb={undo:undoRemove,redo:redoRemove};break;case TrackerType.Create:action.cb={undo:undoCreate,redo:redoCreate};break;case TrackerType.Delete:action.cb={undo:undoDelete,redo:redoDelete};break;case TrackerType.Move:action.cb={undo:undoMove,redo:redoMove};break;case TrackerType.Update:action.cb={undo:undoUpdate,redo:redoUpdate};break;case TrackerType.Format:action.cb={undo:undoFormat,redo:redoFormat};break;case TrackerType.Zoom:action.cb={undo:undoZoom,redo:redoZoom};break;case TrackerType.UIAction:action.cb={undo:undoUIAction,redo:redoUIAction};break;default:try{g.PAssert(3495,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}group.events.push(action)},_handleGroupTrimmed:function _handleGroupTrimmedFn(group){for(var i=0;i<group.events.length;++i){var action=group.events[i];switch(action.type){case TrackerType.Insert:break;case TrackerType.Remove:break;case TrackerType.Create:break;case TrackerType.Delete:break;case TrackerType.Move:break;case TrackerType.Update:break;case TrackerType.Format:break;case TrackerType.Zoom:break;case TrackerType.UIAction:break;default:try{g.PAssert(3496,!1,"Expected TrackerType, received: ",action.type)}catch(PERR){g.reportError(PERR)}}}},_mergeAction:function _mergeActionFn(type,data){log("Tracker Action Merged: ",type,data);var action=this._getCurrentAction();try{g.PAssert(3497,action,"Expected action to exist")}catch(PERR){g.reportError(PERR)}switch(type){case TrackerType.Insert:break;case TrackerType.Remove:break;case TrackerType.Create:break;case TrackerType.Delete:break;case TrackerType.Move:break;case TrackerType.Update:break;case TrackerType.Format:try{g.PAssert(3498,!1,"Formats cannot be merged")}catch(PERR){g.reportError(PERR)}break;case TrackerType.Zoom:try{g.PAssert(3499,!1,"Zooms cannot be merged")}catch(PERR){g.reportError(PERR)}break;case TrackerType.UIAction:try{g.PAssert(3500,!1,"UIActions cannot be merged")}catch(PERR){g.reportError(PERR)}break;default:try{g.PAssert(3501,!1,"Expected TrackerType, received: ",type)}catch(PERR){g.reportError(PERR)}}},_canMerge:function _canMergeFn(type){var shouldMerge=!1,group=this._getCurrentGroup();return group&&group.events.length>0&&(group.events[group.events.length-1].type===type?type===TrackerType.Insert&&(shouldMerge=!0):shouldMerge=!1),shouldMerge},_canCombine:function _canCombineFn(type,groupID){var group=this._getCurrentGroup();return group&&(group.id===groupID||0===group.events.length)},performActions:function performActionsFn(actions){try{g.PAssert(3502,!this.disabled||g.intro,"Can only perform actions when enabled or during the intro")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3503,!this._performingActions,"Can not nest performing actions")}catch(PERR){g.reportError(PERR)}if(this._performingActions=!0,actions&&actions.length>0){if(!this.disabled){var groupID=void 0;this.cursor!=this.groups.length-1?(this.groups.splice(this.cursor+1,this.groups.length-(this.cursor+1)),groupID=this._pushGroup()):groupID=this._getNextGroupID()}for(var i=0;i<actions.length;++i){var action=actions[i];this.fireActionEvent(action),this.disabled||(this._canCombine(action.type,groupID)?this._canMerge(action.type)?this._mergeAction(action.type,action.data):this._doAction(action.type,action.data):(groupID=this._pushGroup(),this._doAction(action.type,action.data)))}}this._performingActions=!1},beginAction:function beginActionFn(preventUndo){try{g.PAssert(3504,!this._performingActions,"Should never begin an action while replaying old actions")}catch(PERR){g.reportError(PERR)}if(0===this._aggregateActions){this._actionsPreventUndo=!!preventUndo,gdata.beginAction(preventUndo);try{g.PAssert(3505,0===this._currentAction.length,"Current actions should always be empty when starting a new action")}catch(PERR){g.reportError(PERR)}}this._aggregateActions++},performAction:function performActionFn(type,data){try{g.PAssert(3506,!this._performingActions,"Should never perform an action while replaying old actions")}catch(PERR){g.reportError(PERR)}var isFromLoad=!g.vmMain.isLoaded||g.isLoadingRemote;this.disabled?g.intro&&(isFromLoad||this.performActions([{type:type,data:[data]}])):this._aggregateActions?this._currentAction.push({type:type,data:[data]}):this.performActions([{type:type,data:[data]}])},endAction:function endActionFn(){try{g.PAssert(3507,!this._performingActions,"Should never end an action while replaying old actions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3508,0!==this._aggregateActions,"Must have called beginAction before calling endAction")}catch(PERR){g.reportError(PERR)}1===this._aggregateActions&&((!this.disabled||g.intro)&&this.performActions(this._currentAction),this._currentAction.length=0,gdata.endAction(),this._actionsPreventUndo=!1),this._aggregateActions=Math.max(0,this._aggregateActions-1)},resetAggregateActionCount:function resetAggregateActionCountFn(){this._aggregateActions=0},_processStateChangedSelection:function _processStateChangedSelectionFn(stateChanged,startObject){try{g.PAssert(3509,!this.undoRedoActive,"Must not currently be undoing/redoing an action when setting selection")}catch(PERR){g.reportError(PERR)}var finalModel,finalPosition=0,finalLength=0;if(g.isKeyboardOPen||!g.keyboardToolbar){for(var i=0;i<stateChanged.length;++i){var entry=stateChanged[i],data=entry.data,model=d.getModel(data.itemID);try{g.PAssert(3510,model,"Expected model to exist: ",data)}catch(PERR){g.reportError(PERR)}switch(entry.type){case TrackerType.Insert:finalModel=model,finalPosition=data.position,finalLength=data.text.length;break;case TrackerType.Remove:finalModel=model,finalPosition=data.position,finalLength=0;break;case TrackerType.SetText:g.focusedPane.indexOfItem(model)>=0&&(finalModel=model,finalPosition=data.position,finalLength=0);break;case TrackerType.Create:finalModel=model,finalPosition=0,finalLength=0;break;case TrackerType.Delete:if(data.previous){var selectionChild=d.getModel(data.previous);selectionChild&&selectionChild.isDescendantOf(g.focusedPane.getItem())&&(finalModel=selectionChild,finalPosition=selectionChild.getParsedText().length,finalLength=0)}}}var index=-1;g.focusedPane&&(finalModel?index=startObject&&startObject.item===finalModel?g.focusedPane.closestIndexOfObject(startObject):g.focusedPane.indexOfItem(finalModel):(finalPosition=Sel.getStartOffset(),index=startObject?g.focusedPane.closestIndexOfObject(startObject):-1,finalLength=0)),index>=0?(Sel.selectIndex(index,finalPosition,finalPosition+finalLength),finalModel&&g.focusedPane.scrollItemIntoView(finalModel,ScrollDuration.Default)):Sel.reset()}this._externalStateChanged=[]},notifyStateChangedFromUndoRedo:function notifyStateChangedFromUndoRedoFn(type,data){try{g.PAssert(3511,this.undoRedoActive)}catch(PERR){g.reportError(PERR)}this._externalStateChanged.push({type:type,data:data})},undoAction:function undoActionFn(){g.vmMain.isOnline()||this.allowOfflineUndo||g.toasts.pushMessage(MessageID.OfflineUndo),this.undoRedoActive=!0;try{g.PAssert(3512,!this._performingActions)}catch(PERR){g.reportError(PERR)}this.beforeUndoRedo();var startObject=Sel.isValid()?Sel.getStartObject():void 0;if(!this.disabled&&this.allowOfflineUndo){if(this.cursor>=0)for(var group=this.groups[this.cursor--],i=group.events.length-1;i>=0;i--){var action=group.events[i];
action.cb.undo(action.data)}}else if(this.canUndo){try{g.PAssert(3513,this.externalUndoRedo)}catch(PERR){g.reportError(PERR)}gdata.undoAction()}this.afterUndoRedo(),this.undoRedoActive=!1,this._processStateChangedSelection(this._externalStateChanged,startObject),this.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{undo:!0}]})},redoAction:function redoActionFn(){g.vmMain.isOnline()||this.allowOfflineUndo||g.toasts.pushMessage(MessageID.OfflineUndo),this.undoRedoActive=!0;try{g.PAssert(3514,!this._performingActions)}catch(PERR){g.reportError(PERR)}this.beforeUndoRedo();var startObject=Sel.isValid()?Sel.getStartObject():void 0;if(!this.disabled&&this.allowOfflineUndo){if(this.cursor>=-1&&this.cursor<this.groups.length-1)for(var group=this.groups[++this.cursor],i=0;i<group.events.length;++i){var action=group.events[i];action.cb.redo(action.data)}}else if(this.canRedo){try{g.PAssert(3515,this.externalUndoRedo)}catch(PERR){g.reportError(PERR)}gdata.redoAction()}this.afterUndoRedo(),this.undoRedoActive=!1,this._processStateChangedSelection(this._externalStateChanged,startObject),this.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{redo:!0}]})},beforeUndoRedo:function beforeUndoRedoFn(){g.vmMain.beginUpdateItems()},afterUndoRedo:function afterUndoRedoFn(){g.vmMain.commitUpdateItems()},miscAction:function miscActionFn(e){this.fireActionEvent(e)},resetState:function resetStateFn(){this._performingActions=!1,this._externalStateChanged=[],this._currentAction=[],this.undoRedoActive=!1,this.cursor=-1,this.groupID=0,this.groups=[]},_getOrderedGroups:function _getOrderedGroupsFn(){return this.groups.slice(this.cursor).concat(this.groups.slice(0,this.cursor))},stringifyGroups:function stringifyGroupsFn(){var groups=this._getOrderedGroups();return"Tracker: "+groups.length},stateChangeForUndoRedo:function stateChangeForUndoRedoFn(event){this.externalUndoRedo=!0,this.disabled=!0,this.canRedo=event.canRedo,this.canUndo=event.canUndo},fireActionEvent:function fireActionEventFn(e){try{if(e.data||(e.data={}),this.listeners)for(var u=0;u<this.listeners.length;u++)this.listeners[u](e)}catch(err){g.reportError(err)}}},new tracker}),!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define("react",[],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.React=e()}}(function(){return function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[a]={exports:{}};t[a][0].call(c.exports,function(e){var n=t[a][1][e];return o(n?n:e)},c,c.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){var r=e(44),o=e(162),i={focusDOMComponent:function(){o(r.getNodeFromInstance(this))}};t.exports=i},{162:162,44:44}],2:[function(e,t,n){function r(){var e=window.opera;return"object"==typeof e&&"function"==typeof e.version&&parseInt(e.version(),10)<=12}function o(e){return(e.ctrlKey||e.altKey||e.metaKey)&&!(e.ctrlKey&&e.altKey)}function i(e){switch(e){case S.topCompositionStart:return M.compositionStart;case S.topCompositionEnd:return M.compositionEnd;case S.topCompositionUpdate:return M.compositionUpdate}}function a(e,t){return e===S.topKeyDown&&t.keyCode===_}function s(e,t){switch(e){case S.topKeyUp:return-1!==b.indexOf(t.keyCode);case S.topKeyDown:return t.keyCode!==_;case S.topKeyPress:case S.topMouseDown:case S.topBlur:return!0;default:return!1}}function u(e){var t=e.detail;return"object"==typeof t&&"data"in t?t.data:null}function l(e,t,n,r){var o,l;if(E?o=i(e):R?s(e,n)&&(o=M.compositionEnd):a(e,n)&&(o=M.compositionStart),!o)return null;N&&(R||o!==M.compositionStart?o===M.compositionEnd&&R&&(l=R.getData()):R=m.getPooled(r));var c=g.getPooled(o,t,n,r);if(l)c.data=l;else{var p=u(n);null!==p&&(c.data=p)}return h.accumulateTwoPhaseDispatches(c),c}function c(e,t){switch(e){case S.topCompositionEnd:return u(t);case S.topKeyPress:var n=t.which;return n!==P?null:(k=!0,w);case S.topTextInput:var r=t.data;return r===w&&k?null:r;default:return null}}function p(e,t){if(R){if(e===S.topCompositionEnd||s(e,t)){var n=R.getData();return m.release(R),R=null,n}return null}switch(e){case S.topPaste:return null;case S.topKeyPress:return t.which&&!o(t)?String.fromCharCode(t.which):null;case S.topCompositionEnd:return N?null:t.data;default:return null}}function d(e,t,n,r){var o;if(o=x?c(e,n):p(e,n),!o)return null;var i=y.getPooled(M.beforeInput,t,n,r);return i.data=o,h.accumulateTwoPhaseDispatches(i),i}var f=e(16),h=e(20),v=e(154),m=e(21),g=e(108),y=e(112),C=e(172),b=[9,13,27,32],_=229,E=v.canUseDOM&&"CompositionEvent"in window,T=null;v.canUseDOM&&"documentMode"in document&&(T=document.documentMode);var x=v.canUseDOM&&"TextEvent"in window&&!T&&!r(),N=v.canUseDOM&&(!E||T&&T>8&&11>=T),P=32,w=String.fromCharCode(P),S=f.topLevelTypes,M={beforeInput:{phasedRegistrationNames:{bubbled:C({onBeforeInput:null}),captured:C({onBeforeInputCapture:null})},dependencies:[S.topCompositionEnd,S.topKeyPress,S.topTextInput,S.topPaste]},compositionEnd:{phasedRegistrationNames:{bubbled:C({onCompositionEnd:null}),captured:C({onCompositionEndCapture:null})},dependencies:[S.topBlur,S.topCompositionEnd,S.topKeyDown,S.topKeyPress,S.topKeyUp,S.topMouseDown]},compositionStart:{phasedRegistrationNames:{bubbled:C({onCompositionStart:null}),captured:C({onCompositionStartCapture:null})},dependencies:[S.topBlur,S.topCompositionStart,S.topKeyDown,S.topKeyPress,S.topKeyUp,S.topMouseDown]},compositionUpdate:{phasedRegistrationNames:{bubbled:C({onCompositionUpdate:null}),captured:C({onCompositionUpdateCapture:null})},dependencies:[S.topBlur,S.topCompositionUpdate,S.topKeyDown,S.topKeyPress,S.topKeyUp,S.topMouseDown]}},k=!1,R=null,D={eventTypes:M,extractEvents:function(e,t,n,r){return[l(e,t,n,r),d(e,t,n,r)]}};t.exports=D},{108:108,112:112,154:154,16:16,172:172,20:20,21:21}],3:[function(e,t,n){function r(e,t){return e+t.charAt(0).toUpperCase()+t.substring(1)}var o={animationIterationCount:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridRow:!0,gridColumn:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},i=["Webkit","ms","Moz","O"];Object.keys(o).forEach(function(e){i.forEach(function(t){o[r(t,e)]=o[e]})});var a={background:{backgroundAttachment:!0,backgroundColor:!0,backgroundImage:!0,backgroundPositionX:!0,backgroundPositionY:!0,backgroundRepeat:!0},backgroundPosition:{backgroundPositionX:!0,backgroundPositionY:!0},border:{borderWidth:!0,borderStyle:!0,borderColor:!0},borderBottom:{borderBottomWidth:!0,borderBottomStyle:!0,borderBottomColor:!0},borderLeft:{borderLeftWidth:!0,borderLeftStyle:!0,borderLeftColor:!0},borderRight:{borderRightWidth:!0,borderRightStyle:!0,borderRightColor:!0},borderTop:{borderTopWidth:!0,borderTopStyle:!0,borderTopColor:!0},font:{fontStyle:!0,fontVariant:!0,fontWeight:!0,fontSize:!0,lineHeight:!0,fontFamily:!0},outline:{outlineWidth:!0,outlineStyle:!0,outlineColor:!0}},s={isUnitlessNumber:o,shorthandPropertyExpansions:a};t.exports=s},{}],4:[function(e,t,n){var r=e(3),o=e(154),i=(e(75),e(156),e(125)),a=e(167),s=e(174),u=(e(178),s(function(e){return a(e)})),l=!1,c="cssFloat";if(o.canUseDOM){var p=document.createElement("div").style;try{p.font=""}catch(d){l=!0}void 0===document.documentElement.style.cssFloat&&(c="styleFloat")}var f={createMarkupForStyles:function(e,t){var n="";for(var r in e)if(e.hasOwnProperty(r)){var o=e[r];null!=o&&(n+=u(r)+":",n+=i(r,o,t)+";")}return n||null},setValueForStyles:function(e,t,n){var o=e.style;for(var a in t)if(t.hasOwnProperty(a)){var s=i(a,t[a],n);if("float"!==a&&"cssFloat"!==a||(a=c),s)o[a]=s;else{var u=l&&r.shorthandPropertyExpansions[a];if(u)for(var p in u)o[p]="";else o[a]=""}}}};t.exports=f},{125:125,154:154,156:156,167:167,174:174,178:178,3:3,75:75}],5:[function(e,t,n){function r(){this._callbacks=null,this._contexts=null}var o=e(179),i=e(26),a=e(168);o(r.prototype,{enqueue:function(e,t){this._callbacks=this._callbacks||[],this._contexts=this._contexts||[],this._callbacks.push(e),this._contexts.push(t)},notifyAll:function(){var e=this._callbacks,t=this._contexts;if(e){e.length!==t.length?a(!1):void 0,this._callbacks=null,this._contexts=null;for(var n=0;n<e.length;n++)e[n].call(t[n]);e.length=0,t.length=0}},checkpoint:function(){return this._callbacks?this._callbacks.length:0},rollback:function(e){this._callbacks&&(this._callbacks.length=e,this._contexts.length=e)},reset:function(){this._callbacks=null,this._contexts=null},destructor:function(){this.reset()}}),i.addPoolingTo(r),t.exports=r},{168:168,179:179,26:26}],6:[function(e,t,n){function r(e){var t=e.nodeName&&e.nodeName.toLowerCase();return"select"===t||"input"===t&&"file"===e.type}function o(e){var t=x.getPooled(k.change,D,e,N(e));b.accumulateTwoPhaseDispatches(t),T.batchedUpdates(i,t)}function i(e){C.enqueueEvents(e),C.processEventQueue(!1)}function a(e,t){R=e,D=t,R.attachEvent("onchange",o)}function s(){R&&(R.detachEvent("onchange",o),R=null,D=null)}function u(e,t){return e===M.topChange?t:void 0}function l(e,t,n){e===M.topFocus?(s(),a(t,n)):e===M.topBlur&&s()}function c(e,t){R=e,D=t,A=e.value,O=Object.getOwnPropertyDescriptor(e.constructor.prototype,"value"),Object.defineProperty(R,"value",U),R.attachEvent?R.attachEvent("onpropertychange",d):R.addEventListener("propertychange",d,!1)}function p(){R&&(delete R.value,R.detachEvent?R.detachEvent("onpropertychange",d):R.removeEventListener("propertychange",d,!1),R=null,D=null,A=null,O=null)}function d(e){if("value"===e.propertyName){var t=e.srcElement.value;t!==A&&(A=t,o(e))}}function f(e,t){return e===M.topInput?t:void 0}function h(e,t,n){e===M.topFocus?(p(),c(t,n)):e===M.topBlur&&p()}function v(e,t){return e!==M.topSelectionChange&&e!==M.topKeyUp&&e!==M.topKeyDown||!R||R.value===A?void 0:(A=R.value,D)}function m(e){return e.nodeName&&"input"===e.nodeName.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)}function g(e,t){return e===M.topClick?t:void 0}var y=e(16),C=e(17),b=e(20),_=e(154),E=e(44),T=e(99),x=e(110),N=e(133),P=e(140),w=e(141),S=e(172),M=y.topLevelTypes,k={change:{phasedRegistrationNames:{bubbled:S({onChange:null}),captured:S({onChangeCapture:null})},dependencies:[M.topBlur,M.topChange,M.topClick,M.topFocus,M.topInput,M.topKeyDown,M.topKeyUp,M.topSelectionChange]}},R=null,D=null,A=null,O=null,I=!1;_.canUseDOM&&(I=P("change")&&(!("documentMode"in document)||document.documentMode>8));var L=!1;_.canUseDOM&&(L=P("input")&&(!("documentMode"in document)||document.documentMode>11));var U={get:function(){return O.get.call(this)},set:function(e){A=""+e,O.set.call(this,e)}},F={eventTypes:k,extractEvents:function(e,t,n,o){var i,a,s=t?E.getNodeFromInstance(t):window;if(r(s)?I?i=u:a=l:w(s)?L?i=f:(i=v,a=h):m(s)&&(i=g),i){var c=i(e,t);if(c){var p=x.getPooled(k.change,c,n,o);return p.type="change",b.accumulateTwoPhaseDispatches(p),p}}a&&a(e,s,t)}};t.exports=F},{110:110,133:133,140:140,141:141,154:154,16:16,17:17,172:172,20:20,44:44,99:99}],7:[function(e,t,n){function r(e,t){return Array.isArray(t)&&(t=t[1]),t?t.nextSibling:e.firstChild}function o(e,t,n){c.insertTreeBefore(e,t,n)}function i(e,t,n){Array.isArray(t)?s(e,t[0],t[1],n):m(e,t,n)}function a(e,t){if(Array.isArray(t)){var n=t[1];t=t[0],u(e,t,n),e.removeChild(n)}e.removeChild(t)}function s(e,t,n,r){for(var o=t;;){var i=o.nextSibling;if(m(e,o,r),o===n)break;o=i}}function u(e,t,n){for(;;){var r=t.nextSibling;if(r===n)break;e.removeChild(r)}}function l(e,t,n){var r=e.parentNode,o=e.nextSibling;o===t?n&&m(r,document.createTextNode(n),o):n?(v(o,n),u(r,o,t)):u(r,e,t)}var c=e(8),p=e(12),d=e(80),f=(e(44),e(75),e(124)),h=e(145),v=e(146),m=f(function(e,t,n){e.insertBefore(t,n)}),g=p.dangerouslyReplaceNodeWithMarkup,y={dangerouslyReplaceNodeWithMarkup:g,replaceDelimitedText:l,processUpdates:function(e,t){for(var n=0;n<t.length;n++){var s=t[n];switch(s.type){case d.INSERT_MARKUP:o(e,s.content,r(e,s.afterNode));break;case d.MOVE_EXISTING:i(e,s.fromNode,r(e,s.afterNode));break;case d.SET_MARKUP:h(e,s.content);break;case d.TEXT_CONTENT:v(e,s.content);break;case d.REMOVE_NODE:a(e,s.fromNode)}}}};t.exports=y},{12:12,124:124,145:145,146:146,44:44,75:75,8:8,80:80}],8:[function(e,t,n){function r(e){if(v){var t=e.node,n=e.children;if(n.length)for(var r=0;r<n.length;r++)m(t,n[r],null);else null!=e.html?t.innerHTML=e.html:null!=e.text&&d(t,e.text)}}function o(e,t){e.parentNode.replaceChild(t.node,e),r(t)}function i(e,t){v?e.children.push(t):e.node.appendChild(t.node)}function a(e,t){v?e.html=t:e.node.innerHTML=t}function s(e,t){v?e.text=t:d(e.node,t)}function u(){return this.node.nodeName}function l(e){return{node:e,children:[],html:null,text:null,toString:u}}var c=e(9),p=e(124),d=e(146),f=1,h=11,v="undefined"!=typeof document&&"number"==typeof document.documentMode||"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent&&/\bEdge\/\d/.test(navigator.userAgent),m=p(function(e,t,n){t.node.nodeType===h||t.node.nodeType===f&&"object"===t.node.nodeName.toLowerCase()&&(null==t.node.namespaceURI||t.node.namespaceURI===c.html)?(r(t),e.insertBefore(t.node,n)):(e.insertBefore(t.node,n),r(t))});l.insertTreeBefore=m,l.replaceChildWithTree=o,l.queueChild=i,l.queueHTML=a,l.queueText=s,t.exports=l},{124:124,146:146,9:9}],9:[function(e,t,n){var r={html:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg"};t.exports=r},{}],10:[function(e,t,n){function r(e,t){return(e&t)===t}var o=e(168),i={MUST_USE_PROPERTY:1,HAS_SIDE_EFFECTS:2,HAS_BOOLEAN_VALUE:4,HAS_NUMERIC_VALUE:8,HAS_POSITIVE_NUMERIC_VALUE:24,HAS_OVERLOADED_BOOLEAN_VALUE:32,injectDOMPropertyConfig:function(e){var t=i,n=e.Properties||{},a=e.DOMAttributeNamespaces||{},u=e.DOMAttributeNames||{},l=e.DOMPropertyNames||{},c=e.DOMMutationMethods||{};e.isCustomAttribute&&s._isCustomAttributeFunctions.push(e.isCustomAttribute);for(var p in n){s.properties.hasOwnProperty(p)?o(!1):void 0;var d=p.toLowerCase(),f=n[p],h={attributeName:d,attributeNamespace:null,propertyName:p,mutationMethod:null,mustUseProperty:r(f,t.MUST_USE_PROPERTY),hasSideEffects:r(f,t.HAS_SIDE_EFFECTS),hasBooleanValue:r(f,t.HAS_BOOLEAN_VALUE),hasNumericValue:r(f,t.HAS_NUMERIC_VALUE),hasPositiveNumericValue:r(f,t.HAS_POSITIVE_NUMERIC_VALUE),hasOverloadedBooleanValue:r(f,t.HAS_OVERLOADED_BOOLEAN_VALUE)};if(!h.mustUseProperty&&h.hasSideEffects?o(!1):void 0,h.hasBooleanValue+h.hasNumericValue+h.hasOverloadedBooleanValue<=1?void 0:o(!1),u.hasOwnProperty(p)){var v=u[p];h.attributeName=v}a.hasOwnProperty(p)&&(h.attributeNamespace=a[p]),l.hasOwnProperty(p)&&(h.propertyName=l[p]),c.hasOwnProperty(p)&&(h.mutationMethod=c[p]),s.properties[p]=h}}},a=":A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",s={ID_ATTRIBUTE_NAME:"data-reactid",ROOT_ATTRIBUTE_NAME:"data-reactroot",ATTRIBUTE_NAME_START_CHAR:a,ATTRIBUTE_NAME_CHAR:a+"\\-.0-9\\uB7\\u0300-\\u036F\\u203F-\\u2040",properties:{},getPossibleStandardName:null,_isCustomAttributeFunctions:[],isCustomAttribute:function(e){for(var t=0;t<s._isCustomAttributeFunctions.length;t++){var n=s._isCustomAttributeFunctions[t];if(n(e))return!0}return!1},injection:i};t.exports=s},{168:168}],11:[function(e,t,n){function r(e){return l.hasOwnProperty(e)?!0:u.hasOwnProperty(e)?!1:s.test(e)?(l[e]=!0,!0):(u[e]=!0,!1)}function o(e,t){return null==t||e.hasBooleanValue&&!t||e.hasNumericValue&&isNaN(t)||e.hasPositiveNumericValue&&1>t||e.hasOverloadedBooleanValue&&t===!1}var i=e(10),a=(e(44),e(52),e(75),e(143)),s=(e(178),new RegExp("^["+i.ATTRIBUTE_NAME_START_CHAR+"]["+i.ATTRIBUTE_NAME_CHAR+"]*$")),u={},l={},c={createMarkupForID:function(e){return i.ID_ATTRIBUTE_NAME+"="+a(e)},setAttributeForID:function(e,t){e.setAttribute(i.ID_ATTRIBUTE_NAME,t)},createMarkupForRoot:function(){return i.ROOT_ATTRIBUTE_NAME+'=""'},setAttributeForRoot:function(e){e.setAttribute(i.ROOT_ATTRIBUTE_NAME,"")},createMarkupForProperty:function(e,t){var n=i.properties.hasOwnProperty(e)?i.properties[e]:null;if(n){if(o(n,t))return"";var r=n.attributeName;return n.hasBooleanValue||n.hasOverloadedBooleanValue&&t===!0?r+'=""':r+"="+a(t)}return i.isCustomAttribute(e)?null==t?"":e+"="+a(t):null},createMarkupForCustomAttribute:function(e,t){return r(e)&&null!=t?e+"="+a(t):""},setValueForProperty:function(e,t,n){var r=i.properties.hasOwnProperty(t)?i.properties[t]:null;if(r){var a=r.mutationMethod;if(a)a(e,n);else{if(o(r,n))return void this.deleteValueForProperty(e,t);if(r.mustUseProperty){var s=r.propertyName;r.hasSideEffects&&""+e[s]==""+n||(e[s]=n)}else{var u=r.attributeName,l=r.attributeNamespace;l?e.setAttributeNS(l,u,""+n):r.hasBooleanValue||r.hasOverloadedBooleanValue&&n===!0?e.setAttribute(u,""):e.setAttribute(u,""+n)}}}else if(i.isCustomAttribute(t))return void c.setValueForAttribute(e,t,n)},setValueForAttribute:function(e,t,n){r(t)&&(null==n?e.removeAttribute(t):e.setAttribute(t,""+n))},deleteValueForProperty:function(e,t){var n=i.properties.hasOwnProperty(t)?i.properties[t]:null;if(n){var r=n.mutationMethod;if(r)r(e,void 0);else if(n.mustUseProperty){var o=n.propertyName;n.hasBooleanValue?e[o]=!1:n.hasSideEffects&&""+e[o]==""||(e[o]="")}else e.removeAttribute(n.attributeName)}else i.isCustomAttribute(t)&&e.removeAttribute(t)}};t.exports=c},{10:10,143:143,178:178,44:44,52:52,75:75}],12:[function(e,t,n){function r(e){return e.substring(1,e.indexOf(" "))}var o=e(8),i=e(154),a=e(159),s=e(160),u=e(164),l=e(168),c=/^(<[^ \/>]+)/,p="data-danger-index",d={dangerouslyRenderMarkup:function(e){i.canUseDOM?void 0:l(!1);for(var t,n={},o=0;o<e.length;o++)e[o]?void 0:l(!1),t=r(e[o]),t=u(t)?t:"*",n[t]=n[t]||[],n[t][o]=e[o];var d=[],f=0;for(t in n)if(n.hasOwnProperty(t)){var h,v=n[t];for(h in v)if(v.hasOwnProperty(h)){var m=v[h];v[h]=m.replace(c,"$1 "+p+'="'+h+'" ')}for(var g=a(v.join(""),s),y=0;y<g.length;++y){var C=g[y];C.hasAttribute&&C.hasAttribute(p)&&(h=+C.getAttribute(p),C.removeAttribute(p),d.hasOwnProperty(h)?l(!1):void 0,d[h]=C,f+=1)}}return f!==d.length?l(!1):void 0,d.length!==e.length?l(!1):void 0,d},dangerouslyReplaceNodeWithMarkup:function(e,t){if(i.canUseDOM?void 0:l(!1),t?void 0:l(!1),"HTML"===e.nodeName?l(!1):void 0,"string"==typeof t){var n=a(t,s)[0];e.parentNode.replaceChild(n,e)}else o.replaceChildWithTree(e,t)}};t.exports=d},{154:154,159:159,160:160,164:164,168:168,8:8}],13:[function(e,t,n){var r=e(172),o=[r({ResponderEventPlugin:null}),r({SimpleEventPlugin:null}),r({TapEventPlugin:null}),r({EnterLeaveEventPlugin:null}),r({ChangeEventPlugin:null}),r({SelectEventPlugin:null}),r({BeforeInputEventPlugin:null})];t.exports=o},{172:172}],14:[function(e,t,n){var r={onClick:!0,onDoubleClick:!0,onMouseDown:!0,onMouseMove:!0,onMouseUp:!0,onClickCapture:!0,onDoubleClickCapture:!0,onMouseDownCapture:!0,onMouseMoveCapture:!0,onMouseUpCapture:!0},o={getNativeProps:function(e,t){if(!t.disabled)return t;var n={};for(var o in t)!r[o]&&t.hasOwnProperty(o)&&(n[o]=t[o]);return n}};t.exports=o},{}],15:[function(e,t,n){var r=e(16),o=e(20),i=e(44),a=e(114),s=e(172),u=r.topLevelTypes,l={mouseEnter:{registrationName:s({onMouseEnter:null}),dependencies:[u.topMouseOut,u.topMouseOver]},mouseLeave:{registrationName:s({onMouseLeave:null}),dependencies:[u.topMouseOut,u.topMouseOver]}},c={eventTypes:l,extractEvents:function(e,t,n,r){if(e===u.topMouseOver&&(n.relatedTarget||n.fromElement))return null;if(e!==u.topMouseOut&&e!==u.topMouseOver)return null;var s;if(r.window===r)s=r;else{var c=r.ownerDocument;s=c?c.defaultView||c.parentWindow:window}var p,d;if(e===u.topMouseOut){p=t;var f=n.relatedTarget||n.toElement;d=f?i.getClosestInstanceFromNode(f):null}else p=null,d=t;if(p===d)return null;var h=null==p?s:i.getNodeFromInstance(p),v=null==d?s:i.getNodeFromInstance(d),m=a.getPooled(l.mouseLeave,p,n,r);m.type="mouseleave",m.target=h,m.relatedTarget=v;var g=a.getPooled(l.mouseEnter,d,n,r);return g.type="mouseenter",g.target=v,g.relatedTarget=h,o.accumulateEnterLeaveDispatches(m,g,p,d),[m,g]}};t.exports=c},{114:114,16:16,172:172,20:20,44:44}],16:[function(e,t,n){var r=e(171),o=r({bubbled:null,captured:null}),i=r({topAbort:null,topAnimationEnd:null,topAnimationIteration:null,topAnimationStart:null,topBlur:null,topCanPlay:null,topCanPlayThrough:null,topChange:null,topClick:null,topCompositionEnd:null,topCompositionStart:null,topCompositionUpdate:null,topContextMenu:null,topCopy:null,topCut:null,topDoubleClick:null,topDrag:null,topDragEnd:null,topDragEnter:null,topDragExit:null,topDragLeave:null,topDragOver:null,topDragStart:null,topDrop:null,topDurationChange:null,topEmptied:null,topEncrypted:null,topEnded:null,topError:null,topFocus:null,topInput:null,topInvalid:null,topKeyDown:null,topKeyPress:null,topKeyUp:null,topLoad:null,topLoadedData:null,topLoadedMetadata:null,topLoadStart:null,topMouseDown:null,topMouseMove:null,topMouseOut:null,topMouseOver:null,topMouseUp:null,topPaste:null,topPause:null,topPlay:null,topPlaying:null,topProgress:null,topRateChange:null,topReset:null,topScroll:null,topSeeked:null,topSeeking:null,topSelectionChange:null,topStalled:null,topSubmit:null,topSuspend:null,topTextInput:null,topTimeUpdate:null,topTouchCancel:null,topTouchEnd:null,topTouchMove:null,topTouchStart:null,topTransitionEnd:null,topVolumeChange:null,topWaiting:null,topWheel:null}),a={topLevelTypes:i,PropagationPhases:o};t.exports=a},{171:171}],17:[function(e,t,n){var r=e(18),o=e(19),i=e(67),a=e(121),s=e(129),u=e(168),l={},c=null,p=function(e,t){e&&(o.executeDispatchesInOrder(e,t),e.isPersistent()||e.constructor.release(e))},d=function(e){return p(e,!0)},f=function(e){return p(e,!1)},h={injection:{injectEventPluginOrder:r.injectEventPluginOrder,injectEventPluginsByName:r.injectEventPluginsByName},putListener:function(e,t,n){"function"!=typeof n?u(!1):void 0;var o=l[t]||(l[t]={});o[e._rootNodeID]=n;var i=r.registrationNameModules[t];i&&i.didPutListener&&i.didPutListener(e,t,n)},getListener:function(e,t){var n=l[t];return n&&n[e._rootNodeID]},deleteListener:function(e,t){var n=r.registrationNameModules[t];n&&n.willDeleteListener&&n.willDeleteListener(e,t);var o=l[t];o&&delete o[e._rootNodeID]},deleteAllListeners:function(e){for(var t in l)if(l[t][e._rootNodeID]){var n=r.registrationNameModules[t];n&&n.willDeleteListener&&n.willDeleteListener(e,t),delete l[t][e._rootNodeID]}},extractEvents:function(e,t,n,o){for(var i,s=r.plugins,u=0;u<s.length;u++){var l=s[u];if(l){var c=l.extractEvents(e,t,n,o);c&&(i=a(i,c))}}return i},enqueueEvents:function(e){e&&(c=a(c,e))},processEventQueue:function(e){var t=c;c=null,e?s(t,d):s(t,f),c?u(!1):void 0,i.rethrowCaughtError()},__purge:function(){l={}},__getListenerBank:function(){return l}};t.exports=h},{121:121,129:129,168:168,18:18,19:19,67:67}],18:[function(e,t,n){function r(){if(s)for(var e in u){var t=u[e],n=s.indexOf(e);if(n>-1?void 0:a(!1),!l.plugins[n]){t.extractEvents?void 0:a(!1),l.plugins[n]=t;var r=t.eventTypes;for(var i in r)o(r[i],t,i)?void 0:a(!1)}}}function o(e,t,n){l.eventNameDispatchConfigs.hasOwnProperty(n)?a(!1):void 0,l.eventNameDispatchConfigs[n]=e;var r=e.phasedRegistrationNames;if(r){for(var o in r)if(r.hasOwnProperty(o)){var s=r[o];i(s,t,n)}return!0}return e.registrationName?(i(e.registrationName,t,n),!0):!1}function i(e,t,n){l.registrationNameModules[e]?a(!1):void 0,l.registrationNameModules[e]=t,l.registrationNameDependencies[e]=t.eventTypes[n].dependencies}var a=e(168),s=null,u={},l={plugins:[],eventNameDispatchConfigs:{},registrationNameModules:{},registrationNameDependencies:{},possibleRegistrationNames:null,injectEventPluginOrder:function(e){s?a(!1):void 0,s=Array.prototype.slice.call(e),r()},injectEventPluginsByName:function(e){var t=!1;for(var n in e)if(e.hasOwnProperty(n)){var o=e[n];u.hasOwnProperty(n)&&u[n]===o||(u[n]?a(!1):void 0,u[n]=o,t=!0)}t&&r()},getPluginModuleForEvent:function(e){var t=e.dispatchConfig;if(t.registrationName)return l.registrationNameModules[t.registrationName]||null;for(var n in t.phasedRegistrationNames)if(t.phasedRegistrationNames.hasOwnProperty(n)){var r=l.registrationNameModules[t.phasedRegistrationNames[n]];if(r)return r}return null},_resetEventPlugins:function(){s=null;for(var e in u)u.hasOwnProperty(e)&&delete u[e];l.plugins.length=0;var t=l.eventNameDispatchConfigs;for(var n in t)t.hasOwnProperty(n)&&delete t[n];var r=l.registrationNameModules;for(var o in r)r.hasOwnProperty(o)&&delete r[o]}};t.exports=l},{168:168}],19:[function(e,t,n){function r(e){return e===y.topMouseUp||e===y.topTouchEnd||e===y.topTouchCancel}function o(e){return e===y.topMouseMove||e===y.topTouchMove}function i(e){return e===y.topMouseDown||e===y.topTouchStart}function a(e,t,n,r){var o=e.type||"unknown-event";e.currentTarget=C.getNodeFromInstance(r),t?v.invokeGuardedCallbackWithCatch(o,n,e):v.invokeGuardedCallback(o,n,e),e.currentTarget=null}function s(e,t){var n=e._dispatchListeners,r=e._dispatchInstances;if(Array.isArray(n))for(var o=0;o<n.length&&!e.isPropagationStopped();o++)a(e,t,n[o],r[o]);else n&&a(e,t,n,r);e._dispatchListeners=null,e._dispatchInstances=null}function u(e){var t=e._dispatchListeners,n=e._dispatchInstances;if(Array.isArray(t)){for(var r=0;r<t.length&&!e.isPropagationStopped();r++)if(t[r](e,n[r]))return n[r]}else if(t&&t(e,n))return n;return null}function l(e){var t=u(e);return e._dispatchInstances=null,e._dispatchListeners=null,t}function c(e){var t=e._dispatchListeners,n=e._dispatchInstances;Array.isArray(t)?m(!1):void 0,e.currentTarget=t?C.getNodeFromInstance(n):null;var r=t?t(e):null;return e.currentTarget=null,e._dispatchListeners=null,e._dispatchInstances=null,r}function p(e){return!!e._dispatchListeners}var d,f,h=e(16),v=e(67),m=e(168),g=(e(178),{injectComponentTree:function(e){d=e},injectTreeTraversal:function(e){f=e}}),y=h.topLevelTypes,C={isEndish:r,isMoveish:o,isStartish:i,executeDirectDispatch:c,executeDispatchesInOrder:s,executeDispatchesInOrderStopAtTrue:l,hasDispatches:p,getInstanceFromNode:function(e){return d.getInstanceFromNode(e)},getNodeFromInstance:function(e){return d.getNodeFromInstance(e)},isAncestor:function(e,t){return f.isAncestor(e,t)},getLowestCommonAncestor:function(e,t){return f.getLowestCommonAncestor(e,t)},getParentInstance:function(e){return f.getParentInstance(e)},traverseTwoPhase:function(e,t,n){return f.traverseTwoPhase(e,t,n)},traverseEnterLeave:function(e,t,n,r,o){return f.traverseEnterLeave(e,t,n,r,o)},injection:g};t.exports=C},{16:16,168:168,178:178,67:67}],20:[function(e,t,n){function r(e,t,n){var r=t.dispatchConfig.phasedRegistrationNames[n];return C(e,r)}function o(e,t,n){var o=t?y.bubbled:y.captured,i=r(e,n,o);i&&(n._dispatchListeners=m(n._dispatchListeners,i),n._dispatchInstances=m(n._dispatchInstances,e))}function i(e){e&&e.dispatchConfig.phasedRegistrationNames&&v.traverseTwoPhase(e._targetInst,o,e)}function a(e){if(e&&e.dispatchConfig.phasedRegistrationNames){var t=e._targetInst,n=t?v.getParentInstance(t):null;v.traverseTwoPhase(n,o,e)}}function s(e,t,n){if(n&&n.dispatchConfig.registrationName){var r=n.dispatchConfig.registrationName,o=C(e,r);o&&(n._dispatchListeners=m(n._dispatchListeners,o),n._dispatchInstances=m(n._dispatchInstances,e))}}function u(e){e&&e.dispatchConfig.registrationName&&s(e._targetInst,null,e)}function l(e){g(e,i)}function c(e){g(e,a)}function p(e,t,n,r){v.traverseEnterLeave(n,r,s,e,t)}function d(e){g(e,u)}var f=e(16),h=e(17),v=e(19),m=e(121),g=e(129),y=(e(178),f.PropagationPhases),C=h.getListener,b={accumulateTwoPhaseDispatches:l,accumulateTwoPhaseDispatchesSkipTarget:c,accumulateDirectDispatches:d,accumulateEnterLeaveDispatches:p};t.exports=b},{121:121,129:129,16:16,17:17,178:178,19:19}],21:[function(e,t,n){function r(e){this._root=e,this._startText=this.getText(),this._fallbackText=null}var o=e(179),i=e(26),a=e(137);o(r.prototype,{destructor:function(){this._root=null,this._startText=null,this._fallbackText=null},getText:function(){return"value"in this._root?this._root.value:this._root[a()]},getData:function(){if(this._fallbackText)return this._fallbackText;var e,t,n=this._startText,r=n.length,o=this.getText(),i=o.length;for(e=0;r>e&&n[e]===o[e];e++);var a=r-e;for(t=1;a>=t&&n[r-t]===o[i-t];t++);var s=t>1?1-t:void 0;return this._fallbackText=o.slice(e,s),this._fallbackText}}),i.addPoolingTo(r),t.exports=r},{137:137,179:179,26:26}],22:[function(e,t,n){var r=e(10),o=r.injection.MUST_USE_PROPERTY,i=r.injection.HAS_BOOLEAN_VALUE,a=r.injection.HAS_SIDE_EFFECTS,s=r.injection.HAS_NUMERIC_VALUE,u=r.injection.HAS_POSITIVE_NUMERIC_VALUE,l=r.injection.HAS_OVERLOADED_BOOLEAN_VALUE,c={isCustomAttribute:RegExp.prototype.test.bind(new RegExp("^(data|aria)-["+r.ATTRIBUTE_NAME_CHAR+"]*$")),Properties:{accept:0,acceptCharset:0,accessKey:0,action:0,allowFullScreen:i,allowTransparency:0,alt:0,async:i,autoComplete:0,autoPlay:i,capture:i,cellPadding:0,cellSpacing:0,charSet:0,challenge:0,checked:o|i,cite:0,classID:0,className:0,cols:u,colSpan:0,content:0,contentEditable:0,contextMenu:0,controls:i,coords:0,crossOrigin:0,data:0,dateTime:0,"default":i,defer:i,dir:0,disabled:i,download:l,draggable:0,encType:0,form:0,formAction:0,formEncType:0,formMethod:0,formNoValidate:i,formTarget:0,frameBorder:0,headers:0,height:0,hidden:i,high:0,href:0,hrefLang:0,htmlFor:0,httpEquiv:0,icon:0,id:0,inputMode:0,integrity:0,is:0,keyParams:0,keyType:0,kind:0,label:0,lang:0,list:0,loop:i,low:0,manifest:0,marginHeight:0,marginWidth:0,max:0,maxLength:0,media:0,mediaGroup:0,method:0,min:0,minLength:0,multiple:o|i,muted:o|i,name:0,nonce:0,noValidate:i,open:i,optimum:0,pattern:0,placeholder:0,poster:0,preload:0,profile:0,radioGroup:0,readOnly:i,rel:0,required:i,reversed:i,role:0,rows:u,rowSpan:s,sandbox:0,scope:0,scoped:i,scrolling:0,seamless:i,selected:o|i,shape:0,size:u,sizes:0,span:u,spellCheck:0,src:0,srcDoc:0,srcLang:0,srcSet:0,start:s,step:0,style:0,summary:0,tabIndex:0,target:0,title:0,type:0,useMap:0,value:o|a,width:0,wmode:0,wrap:0,about:0,datatype:0,inlist:0,prefix:0,property:0,resource:0,"typeof":0,vocab:0,autoCapitalize:0,autoCorrect:0,autoSave:0,color:0,itemProp:0,itemScope:i,itemType:0,itemID:0,itemRef:0,results:0,security:0,unselectable:0},DOMAttributeNames:{acceptCharset:"accept-charset",className:"class",htmlFor:"for",httpEquiv:"http-equiv"},DOMPropertyNames:{}};t.exports=c},{10:10}],23:[function(e,t,n){function r(e){var t=/[=:]/g,n={"=":"=0",":":"=2"},r=(""+e).replace(t,function(e){return n[e]});return"$"+r}function o(e){var t=/(=0|=2)/g,n={"=0":"=","=2":":"},r=e.substring("."===e[0]&&"$"===e[1]?2:1);return(""+r).replace(t,function(e){return n[e]})}var i={escape:r,unescape:o};t.exports=i},{}],24:[function(e,t,n){var r=e(76),o=e(94),i={linkState:function(e){return new r(this.state[e],o.createStateKeySetter(this,e))}};t.exports=i},{76:76,94:94}],25:[function(e,t,n){function r(e){null!=e.checkedLink&&null!=e.valueLink?l(!1):void 0}function o(e){r(e),null!=e.value||null!=e.onChange?l(!1):void 0}function i(e){r(e),null!=e.checked||null!=e.onChange?l(!1):void 0}function a(e){if(e){var t=e.getName();if(t)return" Check the render method of `"+t+"`."}return""}var s=e(87),u=e(86),l=e(168),c=(e(178),{button:!0,checkbox:!0,image:!0,hidden:!0,radio:!0,reset:!0,submit:!0}),p={value:function(e,t,n){return!e[t]||c[e.type]||e.onChange||e.readOnly||e.disabled?null:new Error("You provided a `value` prop to a form field without an `onChange` handler. This will render a read-only field. If the field should be mutable use `defaultValue`. Otherwise, set either `onChange` or `readOnly`.")},checked:function(e,t,n){return!e[t]||e.onChange||e.readOnly||e.disabled?null:new Error("You provided a `checked` prop to a form field without an `onChange` handler. This will render a read-only field. If the field should be mutable use `defaultChecked`. Otherwise, set either `onChange` or `readOnly`.")
},onChange:s.func},d={},f={checkPropTypes:function(e,t,n){for(var r in p){if(p.hasOwnProperty(r))var o=p[r](t,r,e,u.prop);o instanceof Error&&!(o.message in d)&&(d[o.message]=!0,a(n))}},getValue:function(e){return e.valueLink?(o(e),e.valueLink.value):e.value},getChecked:function(e){return e.checkedLink?(i(e),e.checkedLink.value):e.checked},executeOnChange:function(e,t){return e.valueLink?(o(e),e.valueLink.requestChange(t.target.value)):e.checkedLink?(i(e),e.checkedLink.requestChange(t.target.checked)):e.onChange?e.onChange.call(void 0,t):void 0}};t.exports=f},{168:168,178:178,86:86,87:87}],26:[function(e,t,n){var r=e(168),o=function(e){var t=this;if(t.instancePool.length){var n=t.instancePool.pop();return t.call(n,e),n}return new t(e)},i=function(e,t){var n=this;if(n.instancePool.length){var r=n.instancePool.pop();return n.call(r,e,t),r}return new n(e,t)},a=function(e,t,n){var r=this;if(r.instancePool.length){var o=r.instancePool.pop();return r.call(o,e,t,n),o}return new r(e,t,n)},s=function(e,t,n,r){var o=this;if(o.instancePool.length){var i=o.instancePool.pop();return o.call(i,e,t,n,r),i}return new o(e,t,n,r)},u=function(e,t,n,r,o){var i=this;if(i.instancePool.length){var a=i.instancePool.pop();return i.call(a,e,t,n,r,o),a}return new i(e,t,n,r,o)},l=function(e){var t=this;e instanceof t?void 0:r(!1),e.destructor(),t.instancePool.length<t.poolSize&&t.instancePool.push(e)},c=10,p=o,d=function(e,t){var n=e;return n.instancePool=[],n.getPooled=t||p,n.poolSize||(n.poolSize=c),n.release=l,n},f={addPoolingTo:d,oneArgumentPooler:o,twoArgumentPooler:i,threeArgumentPooler:a,fourArgumentPooler:s,fiveArgumentPooler:u};t.exports=f},{168:168}],27:[function(e,t,n){var r=e(179),o=e(32),i=e(34),a=e(33),s=e(48),u=e(64),l=(e(65),e(87)),c=e(100),p=e(142),d=(e(178),u.createElement),f=u.createFactory,h=u.cloneElement,v=r,m={Children:{map:o.map,forEach:o.forEach,count:o.count,toArray:o.toArray,only:p},Component:i,createElement:d,cloneElement:h,isValidElement:u.isValidElement,PropTypes:l,createClass:a.createClass,createFactory:f,createMixin:function(e){return e},DOM:s,version:c,__spread:v};t.exports=m},{100:100,142:142,178:178,179:179,32:32,33:33,34:34,48:48,64:64,65:65,87:87}],28:[function(e,t,n){function r(e){return Object.prototype.hasOwnProperty.call(e,m)||(e[m]=h++,d[e[m]]={}),d[e[m]]}var o,i=e(179),a=e(16),s=e(18),u=e(68),l=e(120),c=e(138),p=e(140),d={},f=!1,h=0,v={topAbort:"abort",topAnimationEnd:c("animationend")||"animationend",topAnimationIteration:c("animationiteration")||"animationiteration",topAnimationStart:c("animationstart")||"animationstart",topBlur:"blur",topCanPlay:"canplay",topCanPlayThrough:"canplaythrough",topChange:"change",topClick:"click",topCompositionEnd:"compositionend",topCompositionStart:"compositionstart",topCompositionUpdate:"compositionupdate",topContextMenu:"contextmenu",topCopy:"copy",topCut:"cut",topDoubleClick:"dblclick",topDrag:"drag",topDragEnd:"dragend",topDragEnter:"dragenter",topDragExit:"dragexit",topDragLeave:"dragleave",topDragOver:"dragover",topDragStart:"dragstart",topDrop:"drop",topDurationChange:"durationchange",topEmptied:"emptied",topEncrypted:"encrypted",topEnded:"ended",topError:"error",topFocus:"focus",topInput:"input",topKeyDown:"keydown",topKeyPress:"keypress",topKeyUp:"keyup",topLoadedData:"loadeddata",topLoadedMetadata:"loadedmetadata",topLoadStart:"loadstart",topMouseDown:"mousedown",topMouseMove:"mousemove",topMouseOut:"mouseout",topMouseOver:"mouseover",topMouseUp:"mouseup",topPaste:"paste",topPause:"pause",topPlay:"play",topPlaying:"playing",topProgress:"progress",topRateChange:"ratechange",topScroll:"scroll",topSeeked:"seeked",topSeeking:"seeking",topSelectionChange:"selectionchange",topStalled:"stalled",topSuspend:"suspend",topTextInput:"textInput",topTimeUpdate:"timeupdate",topTouchCancel:"touchcancel",topTouchEnd:"touchend",topTouchMove:"touchmove",topTouchStart:"touchstart",topTransitionEnd:c("transitionend")||"transitionend",topVolumeChange:"volumechange",topWaiting:"waiting",topWheel:"wheel"},m="_reactListenersID"+String(Math.random()).slice(2),g=i({},u,{ReactEventListener:null,injection:{injectReactEventListener:function(e){e.setHandleTopLevel(g.handleTopLevel),g.ReactEventListener=e}},setEnabled:function(e){g.ReactEventListener&&g.ReactEventListener.setEnabled(e)},isEnabled:function(){return!(!g.ReactEventListener||!g.ReactEventListener.isEnabled())},listenTo:function(e,t){for(var n=t,o=r(n),i=s.registrationNameDependencies[e],u=a.topLevelTypes,l=0;l<i.length;l++){var c=i[l];o.hasOwnProperty(c)&&o[c]||(c===u.topWheel?p("wheel")?g.ReactEventListener.trapBubbledEvent(u.topWheel,"wheel",n):p("mousewheel")?g.ReactEventListener.trapBubbledEvent(u.topWheel,"mousewheel",n):g.ReactEventListener.trapBubbledEvent(u.topWheel,"DOMMouseScroll",n):c===u.topScroll?p("scroll",!0)?g.ReactEventListener.trapCapturedEvent(u.topScroll,"scroll",n):g.ReactEventListener.trapBubbledEvent(u.topScroll,"scroll",g.ReactEventListener.WINDOW_HANDLE):c===u.topFocus||c===u.topBlur?(p("focus",!0)?(g.ReactEventListener.trapCapturedEvent(u.topFocus,"focus",n),g.ReactEventListener.trapCapturedEvent(u.topBlur,"blur",n)):p("focusin")&&(g.ReactEventListener.trapBubbledEvent(u.topFocus,"focusin",n),g.ReactEventListener.trapBubbledEvent(u.topBlur,"focusout",n)),o[u.topBlur]=!0,o[u.topFocus]=!0):v.hasOwnProperty(c)&&g.ReactEventListener.trapBubbledEvent(c,v[c],n),o[c]=!0)}},trapBubbledEvent:function(e,t,n){return g.ReactEventListener.trapBubbledEvent(e,t,n)},trapCapturedEvent:function(e,t,n){return g.ReactEventListener.trapCapturedEvent(e,t,n)},ensureScrollValueMonitoring:function(){if(void 0===o&&(o=document.createEvent&&"pageX"in document.createEvent("MouseEvent")),!o&&!f){var e=l.refreshScrollValues;g.ReactEventListener.monitorScrollValue(e),f=!0}}});t.exports=g},{120:120,138:138,140:140,16:16,179:179,18:18,68:68}],29:[function(e,t,n){function r(e){var t="transition"+e+"Timeout",n="transition"+e;return function(e){if(e[n]){if(null==e[t])return new Error(t+" wasn't supplied to ReactCSSTransitionGroup: this can cause unreliable animations and won't be supported in a future version of React. See https://fb.me/react-animation-transition-group-timeout for more information.");if("number"!=typeof e[t])return new Error(t+" must be a number (in milliseconds)")}}}var o=e(179),i=e(27),a=e(97),s=e(30),u=i.createClass({displayName:"ReactCSSTransitionGroup",propTypes:{transitionName:s.propTypes.name,transitionAppear:i.PropTypes.bool,transitionEnter:i.PropTypes.bool,transitionLeave:i.PropTypes.bool,transitionAppearTimeout:r("Appear"),transitionEnterTimeout:r("Enter"),transitionLeaveTimeout:r("Leave")},getDefaultProps:function(){return{transitionAppear:!1,transitionEnter:!0,transitionLeave:!0}},_wrapChild:function(e){return i.createElement(s,{name:this.props.transitionName,appear:this.props.transitionAppear,enter:this.props.transitionEnter,leave:this.props.transitionLeave,appearTimeout:this.props.transitionAppearTimeout,enterTimeout:this.props.transitionEnterTimeout,leaveTimeout:this.props.transitionLeaveTimeout},e)},render:function(){return i.createElement(a,o({},this.props,{childFactory:this._wrapChild}))}});t.exports=u},{179:179,27:27,30:30,97:97}],30:[function(e,t,n){var r=e(27),o=e(40),i=e(152),a=e(96),s=e(142),u=17,l=r.createClass({displayName:"ReactCSSTransitionGroupChild",propTypes:{name:r.PropTypes.oneOfType([r.PropTypes.string,r.PropTypes.shape({enter:r.PropTypes.string,leave:r.PropTypes.string,active:r.PropTypes.string}),r.PropTypes.shape({enter:r.PropTypes.string,enterActive:r.PropTypes.string,leave:r.PropTypes.string,leaveActive:r.PropTypes.string,appear:r.PropTypes.string,appearActive:r.PropTypes.string})]).isRequired,appear:r.PropTypes.bool,enter:r.PropTypes.bool,leave:r.PropTypes.bool,appearTimeout:r.PropTypes.number,enterTimeout:r.PropTypes.number,leaveTimeout:r.PropTypes.number},transition:function(e,t,n){var r=o.findDOMNode(this);if(!r)return void(t&&t());var s=this.props.name[e]||this.props.name+"-"+e,u=this.props.name[e+"Active"]||s+"-active",l=null,c=function(e){e&&e.target!==r||(clearTimeout(l),i.removeClass(r,s),i.removeClass(r,u),a.removeEndEventListener(r,c),t&&t())};i.addClass(r,s),this.queueClass(u),n?(l=setTimeout(c,n),this.transitionTimeouts.push(l)):a.addEndEventListener(r,c)},queueClass:function(e){this.classNameQueue.push(e),this.timeout||(this.timeout=setTimeout(this.flushClassNameQueue,u))},flushClassNameQueue:function(){this.isMounted()&&this.classNameQueue.forEach(i.addClass.bind(i,o.findDOMNode(this))),this.classNameQueue.length=0,this.timeout=null},componentWillMount:function(){this.classNameQueue=[],this.transitionTimeouts=[]},componentWillUnmount:function(){this.timeout&&clearTimeout(this.timeout),this.transitionTimeouts.forEach(function(e){clearTimeout(e)})},componentWillAppear:function(e){this.props.appear?this.transition("appear",e,this.props.appearTimeout):e()},componentWillEnter:function(e){this.props.enter?this.transition("enter",e,this.props.enterTimeout):e()},componentWillLeave:function(e){this.props.leave?this.transition("leave",e,this.props.leaveTimeout):e()},render:function(){return s(this.props.children)}});t.exports=l},{142:142,152:152,27:27,40:40,96:96}],31:[function(e,t,n){function r(e,t,n){var r=void 0===e[n];null!=t&&r&&(e[n]=i(t))}var o=e(89),i=e(139),a=(e(23),e(148)),s=e(149),u=(e(178),{instantiateChildren:function(e,t,n){if(null==e)return null;var o={};return s(e,r,o),o},updateChildren:function(e,t,n,r,s){if(t||e){var u,l;for(u in t)if(t.hasOwnProperty(u)){l=e&&e[u];var c=l&&l._currentElement,p=t[u];if(null!=l&&a(c,p))o.receiveComponent(l,p,r,s),t[u]=l;else{l&&(n[u]=o.getNativeNode(l),o.unmountComponent(l,!1));var d=i(p);t[u]=d}}for(u in e)!e.hasOwnProperty(u)||t&&t.hasOwnProperty(u)||(l=e[u],n[u]=o.getNativeNode(l),o.unmountComponent(l,!1))}},unmountChildren:function(e,t){for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];o.unmountComponent(r,t)}}});t.exports=u},{139:139,148:148,149:149,178:178,23:23,89:89}],32:[function(e,t,n){function r(e){return(""+e).replace(b,"$&/")}function o(e,t){this.func=e,this.context=t,this.count=0}function i(e,t,n){var r=e.func,o=e.context;r.call(o,t,e.count++)}function a(e,t,n){if(null==e)return e;var r=o.getPooled(t,n);g(e,i,r),o.release(r)}function s(e,t,n,r){this.result=e,this.keyPrefix=t,this.func=n,this.context=r,this.count=0}function u(e,t,n){var o=e.result,i=e.keyPrefix,a=e.func,s=e.context,u=a.call(s,t,e.count++);Array.isArray(u)?l(u,o,n,m.thatReturnsArgument):null!=u&&(v.isValidElement(u)&&(u=v.cloneAndReplaceKey(u,i+(!u.key||t&&t.key===u.key?"":r(u.key)+"/")+n)),o.push(u))}function l(e,t,n,o,i){var a="";null!=n&&(a=r(n)+"/");var l=s.getPooled(t,a,o,i);g(e,u,l),s.release(l)}function c(e,t,n){if(null==e)return e;var r=[];return l(e,r,null,t,n),r}function p(e,t,n){return null}function d(e,t){return g(e,p,null)}function f(e){var t=[];return l(e,t,null,m.thatReturnsArgument),t}var h=e(26),v=e(64),m=e(160),g=e(149),y=h.twoArgumentPooler,C=h.fourArgumentPooler,b=/\/+/g;o.prototype.destructor=function(){this.func=null,this.context=null,this.count=0},h.addPoolingTo(o,y),s.prototype.destructor=function(){this.result=null,this.keyPrefix=null,this.func=null,this.context=null,this.count=0},h.addPoolingTo(s,C);var _={forEach:a,map:c,mapIntoWithKeyPrefixInternal:l,count:d,toArray:f};t.exports=_},{149:149,160:160,26:26,64:64}],33:[function(e,t,n){function r(e,t){var n=E.hasOwnProperty(t)?E[t]:null;x.hasOwnProperty(t)&&(n!==b.OVERRIDE_BASE?m(!1):void 0),e&&(n!==b.DEFINE_MANY&&n!==b.DEFINE_MANY_MERGED?m(!1):void 0)}function o(e,t){if(t){"function"==typeof t?m(!1):void 0,f.isValidElement(t)?m(!1):void 0;var n=e.prototype,o=n.__reactAutoBindPairs;t.hasOwnProperty(C)&&T.mixins(e,t.mixins);for(var i in t)if(t.hasOwnProperty(i)&&i!==C){var a=t[i],l=n.hasOwnProperty(i);if(r(l,i),T.hasOwnProperty(i))T[i](e,a);else{var c=E.hasOwnProperty(i),p="function"==typeof a,d=p&&!c&&!l&&t.autobind!==!1;if(d)o.push(i,a),n[i]=a;else if(l){var h=E[i];!c||h!==b.DEFINE_MANY_MERGED&&h!==b.DEFINE_MANY?m(!1):void 0,h===b.DEFINE_MANY_MERGED?n[i]=s(n[i],a):h===b.DEFINE_MANY&&(n[i]=u(n[i],a))}else n[i]=a}}}}function i(e,t){if(t)for(var n in t){var r=t[n];if(t.hasOwnProperty(n)){var o=n in T;o?m(!1):void 0;var i=n in e;i?m(!1):void 0,e[n]=r}}}function a(e,t){e&&t&&"object"==typeof e&&"object"==typeof t?void 0:m(!1);for(var n in t)t.hasOwnProperty(n)&&(void 0!==e[n]?m(!1):void 0,e[n]=t[n]);return e}function s(e,t){return function(){var n=e.apply(this,arguments),r=t.apply(this,arguments);if(null==n)return r;if(null==r)return n;var o={};return a(o,n),a(o,r),o}}function u(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function l(e,t){var n=t.bind(e);return n}function c(e){for(var t=e.__reactAutoBindPairs,n=0;n<t.length;n+=2){var r=t[n],o=t[n+1];e[r]=l(e,o)}}var p=e(179),d=e(34),f=e(64),h=(e(86),e(85),e(83)),v=e(161),m=e(168),g=e(171),y=e(172),C=(e(178),y({mixins:null})),b=g({DEFINE_ONCE:null,DEFINE_MANY:null,OVERRIDE_BASE:null,DEFINE_MANY_MERGED:null}),_=[],E={mixins:b.DEFINE_MANY,statics:b.DEFINE_MANY,propTypes:b.DEFINE_MANY,contextTypes:b.DEFINE_MANY,childContextTypes:b.DEFINE_MANY,getDefaultProps:b.DEFINE_MANY_MERGED,getInitialState:b.DEFINE_MANY_MERGED,getChildContext:b.DEFINE_MANY_MERGED,render:b.DEFINE_ONCE,componentWillMount:b.DEFINE_MANY,componentDidMount:b.DEFINE_MANY,componentWillReceiveProps:b.DEFINE_MANY,shouldComponentUpdate:b.DEFINE_ONCE,componentWillUpdate:b.DEFINE_MANY,componentDidUpdate:b.DEFINE_MANY,componentWillUnmount:b.DEFINE_MANY,updateComponent:b.OVERRIDE_BASE},T={displayName:function(e,t){e.displayName=t},mixins:function(e,t){if(t)for(var n=0;n<t.length;n++)o(e,t[n])},childContextTypes:function(e,t){e.childContextTypes=p({},e.childContextTypes,t)},contextTypes:function(e,t){e.contextTypes=p({},e.contextTypes,t)},getDefaultProps:function(e,t){e.getDefaultProps=e.getDefaultProps?s(e.getDefaultProps,t):t},propTypes:function(e,t){e.propTypes=p({},e.propTypes,t)},statics:function(e,t){i(e,t)},autobind:function(){}},x={replaceState:function(e,t){this.updater.enqueueReplaceState(this,e),t&&this.updater.enqueueCallback(this,t,"replaceState")},isMounted:function(){return this.updater.isMounted(this)}},N=function(){};p(N.prototype,d.prototype,x);var P={createClass:function(e){var t=function(e,t,n){this.__reactAutoBindPairs.length&&c(this),this.props=e,this.context=t,this.refs=v,this.updater=n||h,this.state=null;var r=this.getInitialState?this.getInitialState():null;"object"!=typeof r||Array.isArray(r)?m(!1):void 0,this.state=r};t.prototype=new N,t.prototype.constructor=t,t.prototype.__reactAutoBindPairs=[],_.forEach(o.bind(null,t)),o(t,e),t.getDefaultProps&&(t.defaultProps=t.getDefaultProps()),t.prototype.render?void 0:m(!1);for(var n in E)t.prototype[n]||(t.prototype[n]=null);return t},injection:{injectMixin:function(e){_.push(e)}}};t.exports=P},{161:161,168:168,171:171,172:172,178:178,179:179,34:34,64:64,83:83,85:85,86:86}],34:[function(e,t,n){function r(e,t,n){this.props=e,this.context=t,this.refs=i,this.updater=n||o}var o=e(83),i=(e(75),e(123),e(161)),a=e(168);e(178),r.prototype.isReactComponent={},r.prototype.setState=function(e,t){"object"!=typeof e&&"function"!=typeof e&&null!=e?a(!1):void 0,this.updater.enqueueSetState(this,e),t&&this.updater.enqueueCallback(this,t,"setState")},r.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this),e&&this.updater.enqueueCallback(this,e,"forceUpdate")},t.exports=r},{123:123,161:161,168:168,178:178,75:75,83:83}],35:[function(e,t,n){var r=e(7),o=e(50),i={processChildrenUpdates:o.dangerouslyProcessChildrenUpdates,replaceNodeWithMarkup:r.dangerouslyReplaceNodeWithMarkup,unmountIDFromEnvironment:function(e){}};t.exports=i},{50:50,7:7}],36:[function(e,t,n){var r=e(168),o=!1,i={unmountIDFromEnvironment:null,replaceNodeWithMarkup:null,processChildrenUpdates:null,injection:{injectEnvironment:function(e){o?r(!1):void 0,i.unmountIDFromEnvironment=e.unmountIDFromEnvironment,i.replaceNodeWithMarkup=e.replaceNodeWithMarkup,i.processChildrenUpdates=e.processChildrenUpdates,o=!0}}};t.exports=i},{168:168}],37:[function(e,t,n){var r=e(147),o={shouldComponentUpdate:function(e,t){return r(this,e,t)}};t.exports=o},{147:147}],38:[function(e,t,n){function r(e){var t=e._currentElement._owner||null;if(t){var n=t.getName();if(n)return" Check the render method of `"+n+"`."}return""}function o(e){}function i(e,t){}function a(e){return e.prototype&&e.prototype.isReactComponent}var s=e(179),u=e(36),l=e(39),c=e(64),p=e(67),d=e(74),f=(e(75),e(82)),h=e(86),v=(e(85),e(89)),m=e(98),g=e(161),y=e(168),C=e(148);e(178),o.prototype.render=function(){var e=d.get(this)._currentElement.type,t=e(this.props,this.context,this.updater);return i(e,t),t};var b=1,_={construct:function(e){this._currentElement=e,this._rootNodeID=null,this._instance=null,this._nativeParent=null,this._nativeContainerInfo=null,this._updateBatchNumber=null,this._pendingElement=null,this._pendingStateQueue=null,this._pendingReplaceState=!1,this._pendingForceUpdate=!1,this._renderedNodeType=null,this._renderedComponent=null,this._context=null,this._mountOrder=0,this._topLevelWrapper=null,this._pendingCallbacks=null,this._calledComponentWillUnmount=!1},mountComponent:function(e,t,n,r){this._context=r,this._mountOrder=b++,this._nativeParent=t,this._nativeContainerInfo=n;var s,u=this._processProps(this._currentElement.props),l=this._processContext(r),p=this._currentElement.type,f=this._constructComponent(u,l);a(p)||null!=f&&null!=f.render||(s=f,i(p,s),null===f||f===!1||c.isValidElement(f)?void 0:y(!1),f=new o(p)),f.props=u,f.context=l,f.refs=g,f.updater=m,this._instance=f,d.set(f,this);var h=f.state;void 0===h&&(f.state=h=null),"object"!=typeof h||Array.isArray(h)?y(!1):void 0,this._pendingStateQueue=null,this._pendingReplaceState=!1,this._pendingForceUpdate=!1;var v;return v=f.unstable_handleError?this.performInitialMountWithErrorHandling(s,t,n,e,r):this.performInitialMount(s,t,n,e,r),f.componentDidMount&&e.getReactMountReady().enqueue(f.componentDidMount,f),v},_constructComponent:function(e,t){return this._constructComponentWithoutOwner(e,t)},_constructComponentWithoutOwner:function(e,t){var n,r=this._currentElement.type;return n=a(r)?new r(e,t,m):r(e,t,m)},performInitialMountWithErrorHandling:function(e,t,n,r,o){var i,a=r.checkpoint();try{i=this.performInitialMount(e,t,n,r,o)}catch(s){r.rollback(a),this._instance.unstable_handleError(s),this._pendingStateQueue&&(this._instance.state=this._processPendingState(this._instance.props,this._instance.context)),a=r.checkpoint(),this._renderedComponent.unmountComponent(!0),r.rollback(a),i=this.performInitialMount(e,t,n,r,o)}return i},performInitialMount:function(e,t,n,r,o){var i=this._instance;i.componentWillMount&&(i.componentWillMount(),this._pendingStateQueue&&(i.state=this._processPendingState(i.props,i.context))),void 0===e&&(e=this._renderValidatedComponent()),this._renderedNodeType=f.getType(e),this._renderedComponent=this._instantiateReactComponent(e);var a=v.mountComponent(this._renderedComponent,r,t,n,this._processChildContext(o));return a},getNativeNode:function(){return v.getNativeNode(this._renderedComponent)},unmountComponent:function(e){if(this._renderedComponent){var t=this._instance;if(t.componentWillUnmount&&!t._calledComponentWillUnmount)if(t._calledComponentWillUnmount=!0,e){var n=this.getName()+".componentWillUnmount()";p.invokeGuardedCallback(n,t.componentWillUnmount.bind(t))}else t.componentWillUnmount();this._renderedComponent&&(v.unmountComponent(this._renderedComponent,e),this._renderedNodeType=null,this._renderedComponent=null,this._instance=null),this._pendingStateQueue=null,this._pendingReplaceState=!1,this._pendingForceUpdate=!1,this._pendingCallbacks=null,this._pendingElement=null,this._context=null,this._rootNodeID=null,this._topLevelWrapper=null,d.remove(t)}},_maskContext:function(e){var t=this._currentElement.type,n=t.contextTypes;if(!n)return g;var r={};for(var o in n)r[o]=e[o];return r},_processContext:function(e){var t=this._maskContext(e);return t},_processChildContext:function(e){var t=this._currentElement.type,n=this._instance,r=n.getChildContext&&n.getChildContext();if(r){"object"!=typeof t.childContextTypes?y(!1):void 0;for(var o in r)o in t.childContextTypes?void 0:y(!1);return s({},e,r)}return e},_processProps:function(e){return e},_checkPropTypes:function(e,t,n){var o=this.getName();for(var i in e)if(e.hasOwnProperty(i)){var a;try{"function"!=typeof e[i]?y(!1):void 0,a=e[i](t,i,o,n)}catch(s){a=s}a instanceof Error&&(r(this),n===h.prop)}},receiveComponent:function(e,t,n){var r=this._currentElement,o=this._context;this._pendingElement=null,this.updateComponent(t,r,e,o,n)},performUpdateIfNecessary:function(e){null!=this._pendingElement?v.receiveComponent(this,this._pendingElement,e,this._context):null!==this._pendingStateQueue||this._pendingForceUpdate?this.updateComponent(e,this._currentElement,this._currentElement,this._context,this._context):this._updateBatchNumber=null},updateComponent:function(e,t,n,r,o){var i,a,s=this._instance,u=!1;this._context===o?i=s.context:(i=this._processContext(o),u=!0),t===n?a=n.props:(a=this._processProps(n.props),u=!0),u&&s.componentWillReceiveProps&&s.componentWillReceiveProps(a,i);var l=this._processPendingState(a,i),c=!0;!this._pendingForceUpdate&&s.shouldComponentUpdate&&(c=s.shouldComponentUpdate(a,l,i)),this._updateBatchNumber=null,c?(this._pendingForceUpdate=!1,this._performComponentUpdate(n,a,l,i,e,o)):(this._currentElement=n,this._context=o,s.props=a,s.state=l,s.context=i)},_processPendingState:function(e,t){var n=this._instance,r=this._pendingStateQueue,o=this._pendingReplaceState;if(this._pendingReplaceState=!1,this._pendingStateQueue=null,!r)return n.state;if(o&&1===r.length)return r[0];for(var i=s({},o?r[0]:n.state),a=o?1:0;a<r.length;a++){var u=r[a];s(i,"function"==typeof u?u.call(n,i,e,t):u)}return i},_performComponentUpdate:function(e,t,n,r,o,i){var a,s,u,l=this._instance,c=Boolean(l.componentDidUpdate);c&&(a=l.props,s=l.state,u=l.context),l.componentWillUpdate&&l.componentWillUpdate(t,n,r),this._currentElement=e,this._context=i,l.props=t,l.state=n,l.context=r,this._updateRenderedComponent(o,i),c&&o.getReactMountReady().enqueue(l.componentDidUpdate.bind(l,a,s,u),l)},_updateRenderedComponent:function(e,t){var n=this._renderedComponent,r=n._currentElement,o=this._renderValidatedComponent();if(C(r,o))v.receiveComponent(n,o,e,this._processChildContext(t));else{var i=v.getNativeNode(n);v.unmountComponent(n,!1),this._renderedNodeType=f.getType(o),this._renderedComponent=this._instantiateReactComponent(o);var a=v.mountComponent(this._renderedComponent,e,this._nativeParent,this._nativeContainerInfo,this._processChildContext(t));this._replaceNodeWithMarkup(i,a,n)}},_replaceNodeWithMarkup:function(e,t,n){u.replaceNodeWithMarkup(e,t,n)},_renderValidatedComponentWithoutOwnerOrContext:function(){var e=this._instance,t=e.render();return t},_renderValidatedComponent:function(){var e;l.current=this;try{e=this._renderValidatedComponentWithoutOwnerOrContext()}finally{l.current=null}return null===e||e===!1||c.isValidElement(e)?void 0:y(!1),e},attachRef:function(e,t){var n=this.getPublicInstance();null==n?y(!1):void 0;var r=t.getPublicInstance(),o=n.refs===g?n.refs={}:n.refs;o[e]=r},detachRef:function(e){var t=this.getPublicInstance().refs;delete t[e]},getName:function(){var e=this._currentElement.type,t=this._instance&&this._instance.constructor;return e.displayName||t&&t.displayName||e.name||t&&t.name||null},getPublicInstance:function(){var e=this._instance;return e instanceof o?null:e},_instantiateReactComponent:null},E={Mixin:_};t.exports=E},{148:148,161:161,168:168,178:178,179:179,36:36,39:39,64:64,67:67,74:74,75:75,82:82,85:85,86:86,89:89,98:98}],39:[function(e,t,n){var r={current:null};t.exports=r},{}],40:[function(e,t,n){var r=e(44),o=e(63),i=e(78),a=e(89),s=e(99),u=e(100),l=e(127),c=e(135),p=e(144);e(178),o.inject();var d={findDOMNode:l,render:i.render,unmountComponentAtNode:i.unmountComponentAtNode,version:u,unstable_batchedUpdates:s.batchedUpdates,unstable_renderSubtreeIntoContainer:p};"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.inject&&__REACT_DEVTOOLS_GLOBAL_HOOK__.inject({ComponentTree:{getClosestInstanceFromNode:r.getClosestInstanceFromNode,getNodeFromInstance:function(e){return e._renderedComponent&&(e=c(e)),e?r.getNodeFromInstance(e):null}},Mount:i,Reconciler:a}),t.exports=d},{100:100,127:127,135:135,144:144,178:178,44:44,63:63,78:78,89:89,99:99}],41:[function(e,t,n){var r=e(14),o={getNativeProps:r.getNativeProps};t.exports=o},{14:14}],42:[function(e,t,n){function r(e,t){t&&(X[e._tag]&&(null!=t.children||null!=t.dangerouslySetInnerHTML?O(!1):void 0),null!=t.dangerouslySetInnerHTML&&(null!=t.children?O(!1):void 0,"object"==typeof t.dangerouslySetInnerHTML&&K in t.dangerouslySetInnerHTML?void 0:O(!1)),null!=t.style&&"object"!=typeof t.style?O(!1):void 0)}function o(e,t,n,r){if(!(r instanceof D)){var o=e._nativeContainerInfo,a=o._node&&o._node.nodeType===H,s=a?o._node:o._ownerDocument;V(t,s),r.getReactMountReady().enqueue(i,{inst:e,registrationName:t,listener:n})}}function i(){var e=this;b.putListener(e.inst,e.registrationName,e.listener)}function a(){var e=this;S.postMountWrapper(e)}function s(){var e=this;e._rootNodeID?void 0:O(!1);var t=F(e);switch(t?void 0:O(!1),e._tag){case"iframe":case"object":e._wrapperState.listeners=[E.trapBubbledEvent(C.topLevelTypes.topLoad,"load",t)];break;case"video":case"audio":e._wrapperState.listeners=[];for(var n in Y)Y.hasOwnProperty(n)&&e._wrapperState.listeners.push(E.trapBubbledEvent(C.topLevelTypes[n],Y[n],t));break;case"img":e._wrapperState.listeners=[E.trapBubbledEvent(C.topLevelTypes.topError,"error",t),E.trapBubbledEvent(C.topLevelTypes.topLoad,"load",t)];break;case"form":e._wrapperState.listeners=[E.trapBubbledEvent(C.topLevelTypes.topReset,"reset",t),E.trapBubbledEvent(C.topLevelTypes.topSubmit,"submit",t)];break;case"input":case"select":case"textarea":e._wrapperState.listeners=[E.trapBubbledEvent(C.topLevelTypes.topInvalid,"invalid",t)]}}function u(){M.postUpdateWrapper(this)}function l(e){Z.call($,e)||(Q.test(e)?void 0:O(!1),$[e]=!0)}function c(e,t){return e.indexOf("-")>=0||null!=t.is}function p(e){var t=e.type;l(t),this._currentElement=e,this._tag=t.toLowerCase(),this._namespaceURI=null,this._renderedChildren=null,this._previousStyle=null,this._previousStyleCopy=null,this._nativeNode=null,this._nativeParent=null,this._rootNodeID=null,this._domID=null,this._nativeContainerInfo=null,this._wrapperState=null,this._topLevelWrapper=null,this._flags=0}var d=e(179),f=e(1),h=e(4),v=e(8),m=e(9),g=e(10),y=e(11),C=e(16),b=e(17),_=e(18),E=e(28),T=e(35),x=e(41),N=e(43),P=e(44),w=e(51),S=e(53),M=e(54),k=e(58),R=(e(75),e(79)),D=e(93),A=(e(160),e(126)),O=e(168),I=(e(140),e(172)),L=(e(177),e(151),e(178),N),U=b.deleteListener,F=P.getNodeFromInstance,V=E.listenTo,B=_.registrationNameModules,j={string:!0,number:!0},W=I({style:null}),K=I({__html:null}),q={children:null,dangerouslySetInnerHTML:null,suppressContentEditableWarning:null},H=11,Y={topAbort:"abort",topCanPlay:"canplay",topCanPlayThrough:"canplaythrough",topDurationChange:"durationchange",topEmptied:"emptied",topEncrypted:"encrypted",topEnded:"ended",topError:"error",topLoadedData:"loadeddata",topLoadedMetadata:"loadedmetadata",topLoadStart:"loadstart",topPause:"pause",topPlay:"play",topPlaying:"playing",topProgress:"progress",topRateChange:"ratechange",topSeeked:"seeked",topSeeking:"seeking",topStalled:"stalled",topSuspend:"suspend",topTimeUpdate:"timeupdate",topVolumeChange:"volumechange",topWaiting:"waiting"},z={area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0},G={listing:!0,pre:!0,textarea:!0},X=d({menuitem:!0},z),Q=/^[a-zA-Z][a-zA-Z:_\.\-\d]*$/,$={},Z={}.hasOwnProperty,J=1;p.displayName="ReactDOMComponent",p.Mixin={mountComponent:function(e,t,n,o){this._rootNodeID=J++,this._domID=n._idCounter++,this._nativeParent=t,this._nativeContainerInfo=n;var i=this._currentElement.props;switch(this._tag){case"iframe":case"object":case"img":case"form":case"video":case"audio":this._wrapperState={listeners:null},e.getReactMountReady().enqueue(s,this);break;case"button":i=x.getNativeProps(this,i,t);break;case"input":w.mountWrapper(this,i,t),i=w.getNativeProps(this,i),e.getReactMountReady().enqueue(s,this);break;case"option":S.mountWrapper(this,i,t),i=S.getNativeProps(this,i);break;case"select":M.mountWrapper(this,i,t),i=M.getNativeProps(this,i),e.getReactMountReady().enqueue(s,this);break;case"textarea":k.mountWrapper(this,i,t),i=k.getNativeProps(this,i),e.getReactMountReady().enqueue(s,this)}r(this,i);var u,l;null!=t?(u=t._namespaceURI,l=t._tag):n._tag&&(u=n._namespaceURI,l=n._tag),(null==u||u===m.svg&&"foreignobject"===l)&&(u=m.html),u===m.html&&("svg"===this._tag?u=m.svg:"math"===this._tag&&(u=m.mathml)),this._namespaceURI=u;var c;if(e.useCreateElement){var p,d=n._ownerDocument;if(u===m.html)if("script"===this._tag){var h=d.createElement("div"),g=this._currentElement.type;h.innerHTML="<"+g+"></"+g+">",p=h.removeChild(h.firstChild)}else p=d.createElement(this._currentElement.type,i.is||null);else p=d.createElementNS(u,this._currentElement.type);P.precacheNode(this,p),this._flags|=L.hasCachedChildNodes,this._nativeParent||y.setAttributeForRoot(p),this._updateDOMProperties(null,i,e);var C=v(p);this._createInitialChildren(e,i,o,C),c=C}else{var b=this._createOpenTagMarkupAndPutListeners(e,i),_=this._createContentMarkup(e,i,o);c=!_&&z[this._tag]?b+"/>":b+">"+_+"</"+this._currentElement.type+">"}switch(this._tag){case"button":case"input":case"select":case"textarea":i.autoFocus&&e.getReactMountReady().enqueue(f.focusDOMComponent,this);break;case"option":e.getReactMountReady().enqueue(a,this)}return c},_createOpenTagMarkupAndPutListeners:function(e,t){var n="<"+this._currentElement.type;for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if(null!=i)if(B.hasOwnProperty(r))i&&o(this,r,i,e);else{r===W&&(i&&(i=this._previousStyleCopy=d({},t.style)),i=h.createMarkupForStyles(i,this));var a=null;null!=this._tag&&c(this._tag,t)?q.hasOwnProperty(r)||(a=y.createMarkupForCustomAttribute(r,i)):a=y.createMarkupForProperty(r,i),a&&(n+=" "+a)}}return e.renderToStaticMarkup?n:(this._nativeParent||(n+=" "+y.createMarkupForRoot()),n+=" "+y.createMarkupForID(this._domID))},_createContentMarkup:function(e,t,n){var r="",o=t.dangerouslySetInnerHTML;if(null!=o)null!=o.__html&&(r=o.__html);else{var i=j[typeof t.children]?t.children:null,a=null!=i?null:t.children;if(null!=i)r=A(i);else if(null!=a){var s=this.mountChildren(a,e,n);r=s.join("")}}return G[this._tag]&&"\n"===r.charAt(0)?"\n"+r:r},_createInitialChildren:function(e,t,n,r){var o=t.dangerouslySetInnerHTML;if(null!=o)null!=o.__html&&v.queueHTML(r,o.__html);else{var i=j[typeof t.children]?t.children:null,a=null!=i?null:t.children;if(null!=i)v.queueText(r,i);else if(null!=a)for(var s=this.mountChildren(a,e,n),u=0;u<s.length;u++)v.queueChild(r,s[u])}},receiveComponent:function(e,t,n){var r=this._currentElement;this._currentElement=e,this.updateComponent(t,r,e,n)},updateComponent:function(e,t,n,o){var i=t.props,a=this._currentElement.props;switch(this._tag){case"button":i=x.getNativeProps(this,i),a=x.getNativeProps(this,a);break;case"input":w.updateWrapper(this),i=w.getNativeProps(this,i),a=w.getNativeProps(this,a);break;case"option":i=S.getNativeProps(this,i),a=S.getNativeProps(this,a);break;case"select":i=M.getNativeProps(this,i),a=M.getNativeProps(this,a);break;case"textarea":k.updateWrapper(this),i=k.getNativeProps(this,i),a=k.getNativeProps(this,a)}r(this,a),this._updateDOMProperties(i,a,e),this._updateDOMChildren(i,a,e,o),"select"===this._tag&&e.getReactMountReady().enqueue(u,this)},_updateDOMProperties:function(e,t,n){var r,i,a;for(r in e)if(!t.hasOwnProperty(r)&&e.hasOwnProperty(r)&&null!=e[r])if(r===W){var s=this._previousStyleCopy;for(i in s)s.hasOwnProperty(i)&&(a=a||{},a[i]="");this._previousStyleCopy=null}else B.hasOwnProperty(r)?e[r]&&U(this,r):(g.properties[r]||g.isCustomAttribute(r))&&y.deleteValueForProperty(F(this),r);
for(r in t){var u=t[r],l=r===W?this._previousStyleCopy:null!=e?e[r]:void 0;if(t.hasOwnProperty(r)&&u!==l&&(null!=u||null!=l))if(r===W)if(u?u=this._previousStyleCopy=d({},u):this._previousStyleCopy=null,l){for(i in l)!l.hasOwnProperty(i)||u&&u.hasOwnProperty(i)||(a=a||{},a[i]="");for(i in u)u.hasOwnProperty(i)&&l[i]!==u[i]&&(a=a||{},a[i]=u[i])}else a=u;else if(B.hasOwnProperty(r))u?o(this,r,u,n):l&&U(this,r);else if(c(this._tag,t))q.hasOwnProperty(r)||y.setValueForAttribute(F(this),r,u);else if(g.properties[r]||g.isCustomAttribute(r)){var p=F(this);null!=u?y.setValueForProperty(p,r,u):y.deleteValueForProperty(p,r)}}a&&h.setValueForStyles(F(this),a,this)},_updateDOMChildren:function(e,t,n,r){var o=j[typeof e.children]?e.children:null,i=j[typeof t.children]?t.children:null,a=e.dangerouslySetInnerHTML&&e.dangerouslySetInnerHTML.__html,s=t.dangerouslySetInnerHTML&&t.dangerouslySetInnerHTML.__html,u=null!=o?null:e.children,l=null!=i?null:t.children,c=null!=o||null!=a,p=null!=i||null!=s;null!=u&&null==l?this.updateChildren(null,n,r):c&&!p&&this.updateTextContent(""),null!=i?o!==i&&this.updateTextContent(""+i):null!=s?a!==s&&this.updateMarkup(""+s):null!=l&&this.updateChildren(l,n,r)},getNativeNode:function(){return F(this)},unmountComponent:function(e){switch(this._tag){case"iframe":case"object":case"img":case"form":case"video":case"audio":var t=this._wrapperState.listeners;if(t)for(var n=0;n<t.length;n++)t[n].remove();break;case"html":case"head":case"body":O(!1)}this.unmountChildren(e),P.uncacheNode(this),b.deleteAllListeners(this),T.unmountIDFromEnvironment(this._rootNodeID),this._rootNodeID=null,this._domID=null,this._wrapperState=null},getPublicInstance:function(){return F(this)}},d(p.prototype,p.Mixin,R.Mixin),t.exports=p},{1:1,10:10,11:11,126:126,140:140,151:151,16:16,160:160,168:168,17:17,172:172,177:177,178:178,179:179,18:18,28:28,35:35,4:4,41:41,43:43,44:44,51:51,53:53,54:54,58:58,75:75,79:79,8:8,9:9,93:93}],43:[function(e,t,n){var r={hasCachedChildNodes:1};t.exports=r},{}],44:[function(e,t,n){function r(e){for(var t;t=e._renderedComponent;)e=t;return e}function o(e,t){var n=r(e);n._nativeNode=t,t[v]=n}function i(e){var t=e._nativeNode;t&&(delete t[v],e._nativeNode=null)}function a(e,t){if(!(e._flags&h.hasCachedChildNodes)){var n=e._renderedChildren,i=t.firstChild;e:for(var a in n)if(n.hasOwnProperty(a)){var s=n[a],u=r(s)._domID;if(null!=u){for(;null!==i;i=i.nextSibling)if(1===i.nodeType&&i.getAttribute(f)===String(u)||8===i.nodeType&&i.nodeValue===" react-text: "+u+" "||8===i.nodeType&&i.nodeValue===" react-empty: "+u+" "){o(s,i);continue e}d(!1)}}e._flags|=h.hasCachedChildNodes}}function s(e){if(e[v])return e[v];for(var t=[];!e[v];){if(t.push(e),!e.parentNode)return null;e=e.parentNode}for(var n,r;e&&(r=e[v]);e=t.pop())n=r,t.length&&a(r,e);return n}function u(e){var t=s(e);return null!=t&&t._nativeNode===e?t:null}function l(e){if(void 0===e._nativeNode?d(!1):void 0,e._nativeNode)return e._nativeNode;for(var t=[];!e._nativeNode;)t.push(e),e._nativeParent?void 0:d(!1),e=e._nativeParent;for(;t.length;e=t.pop())a(e,e._nativeNode);return e._nativeNode}var c=e(10),p=e(43),d=e(168),f=c.ID_ATTRIBUTE_NAME,h=p,v="__reactInternalInstance$"+Math.random().toString(36).slice(2),m={getClosestInstanceFromNode:s,getInstanceFromNode:u,getNodeFromInstance:l,precacheChildNodes:a,precacheNode:o,uncacheNode:i};t.exports=m},{10:10,168:168,43:43}],45:[function(e,t,n){function r(e,t){var n={_topLevelWrapper:e,_idCounter:1,_ownerDocument:t?t.nodeType===o?t:t.ownerDocument:null,_node:t,_tag:t?t.nodeName.toLowerCase():null,_namespaceURI:t?t.namespaceURI:null};return n}var o=(e(151),9);t.exports=r},{151:151}],46:[function(e,t,n){function r(e,t,n,r,o,i){}var o=e(60),i=(e(178),[]),a={addDevtool:function(e){i.push(e)},removeDevtool:function(e){for(var t=0;t<i.length;t++)i[t]===e&&(i.splice(t,1),t--)},onCreateMarkupForProperty:function(e,t){r("onCreateMarkupForProperty",e,t)},onSetValueForProperty:function(e,t,n){r("onSetValueForProperty",e,t,n)},onDeleteValueForProperty:function(e,t){r("onDeleteValueForProperty",e,t)}};a.addDevtool(o),t.exports=a},{178:178,60:60}],47:[function(e,t,n){var r=e(179),o=e(8),i=e(44),a=function(e){this._currentElement=null,this._nativeNode=null,this._nativeParent=null,this._nativeContainerInfo=null,this._domID=null};r(a.prototype,{mountComponent:function(e,t,n,r){var a=n._idCounter++;this._domID=a,this._nativeParent=t,this._nativeContainerInfo=n;var s=" react-empty: "+this._domID+" ";if(e.useCreateElement){var u=n._ownerDocument,l=u.createComment(s);return i.precacheNode(this,l),o(l)}return e.renderToStaticMarkup?"":"<!--"+s+"-->"},receiveComponent:function(){},getNativeNode:function(){return i.getNodeFromInstance(this)},unmountComponent:function(){i.uncacheNode(this)}}),t.exports=a},{179:179,44:44,8:8}],48:[function(e,t,n){function r(e){return o.createFactory(e)}var o=e(64),i=(e(65),e(173)),a=i({a:"a",abbr:"abbr",address:"address",area:"area",article:"article",aside:"aside",audio:"audio",b:"b",base:"base",bdi:"bdi",bdo:"bdo",big:"big",blockquote:"blockquote",body:"body",br:"br",button:"button",canvas:"canvas",caption:"caption",cite:"cite",code:"code",col:"col",colgroup:"colgroup",data:"data",datalist:"datalist",dd:"dd",del:"del",details:"details",dfn:"dfn",dialog:"dialog",div:"div",dl:"dl",dt:"dt",em:"em",embed:"embed",fieldset:"fieldset",figcaption:"figcaption",figure:"figure",footer:"footer",form:"form",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",head:"head",header:"header",hgroup:"hgroup",hr:"hr",html:"html",i:"i",iframe:"iframe",img:"img",input:"input",ins:"ins",kbd:"kbd",keygen:"keygen",label:"label",legend:"legend",li:"li",link:"link",main:"main",map:"map",mark:"mark",menu:"menu",menuitem:"menuitem",meta:"meta",meter:"meter",nav:"nav",noscript:"noscript",object:"object",ol:"ol",optgroup:"optgroup",option:"option",output:"output",p:"p",param:"param",picture:"picture",pre:"pre",progress:"progress",q:"q",rp:"rp",rt:"rt",ruby:"ruby",s:"s",samp:"samp",script:"script",section:"section",select:"select",small:"small",source:"source",span:"span",strong:"strong",style:"style",sub:"sub",summary:"summary",sup:"sup",table:"table",tbody:"tbody",td:"td",textarea:"textarea",tfoot:"tfoot",th:"th",thead:"thead",time:"time",title:"title",tr:"tr",track:"track",u:"u",ul:"ul","var":"var",video:"video",wbr:"wbr",circle:"circle",clipPath:"clipPath",defs:"defs",ellipse:"ellipse",g:"g",image:"image",line:"line",linearGradient:"linearGradient",mask:"mask",path:"path",pattern:"pattern",polygon:"polygon",polyline:"polyline",radialGradient:"radialGradient",rect:"rect",stop:"stop",svg:"svg",text:"text",tspan:"tspan"},r);t.exports=a},{173:173,64:64,65:65}],49:[function(e,t,n){var r={useCreateElement:!0};t.exports=r},{}],50:[function(e,t,n){var r=e(7),o=e(44),i={dangerouslyProcessChildrenUpdates:function(e,t){var n=o.getNodeFromInstance(e);r.processUpdates(n,t)}};t.exports=i},{44:44,7:7}],51:[function(e,t,n){function r(){this._rootNodeID&&d.updateWrapper(this)}function o(e){var t=this._currentElement.props,n=u.executeOnChange(t,e);c.asap(r,this);var o=t.name;if("radio"===t.type&&null!=o){for(var i=l.getNodeFromInstance(this),a=i;a.parentNode;)a=a.parentNode;for(var s=a.querySelectorAll("input[name="+JSON.stringify(""+o)+'][type="radio"]'),d=0;d<s.length;d++){var f=s[d];if(f!==i&&f.form===i.form){var h=l.getInstanceFromNode(f);h?void 0:p(!1),c.asap(r,h)}}}return n}var i=e(179),a=e(14),s=e(11),u=e(25),l=e(44),c=e(99),p=e(168),d=(e(178),{getNativeProps:function(e,t){var n=u.getValue(t),r=u.getChecked(t),o=i({type:void 0},a.getNativeProps(e,t),{defaultChecked:void 0,defaultValue:void 0,value:null!=n?n:e._wrapperState.initialValue,checked:null!=r?r:e._wrapperState.initialChecked,onChange:e._wrapperState.onChange});return o},mountWrapper:function(e,t){var n=t.defaultValue;e._wrapperState={initialChecked:t.defaultChecked||!1,initialValue:null!=n?n:null,listeners:null,onChange:o.bind(e)}},updateWrapper:function(e){var t=e._currentElement.props,n=t.checked;null!=n&&s.setValueForProperty(l.getNodeFromInstance(e),"checked",n||!1);var r=u.getValue(t);null!=r&&s.setValueForProperty(l.getNodeFromInstance(e),"value",""+r)}});t.exports=d},{11:11,14:14,168:168,178:178,179:179,25:25,44:44,99:99}],52:[function(e,t,n){var r=e(46);t.exports={debugTool:r}},{46:46}],53:[function(e,t,n){var r=e(179),o=e(32),i=e(44),a=e(54),s=(e(178),{mountWrapper:function(e,t,n){var r=null;if(null!=n){var o=n;"optgroup"===o._tag&&(o=o._nativeParent),null!=o&&"select"===o._tag&&(r=a.getSelectValueContext(o))}var i=null;if(null!=r)if(i=!1,Array.isArray(r)){for(var s=0;s<r.length;s++)if(""+r[s]==""+t.value){i=!0;break}}else i=""+r==""+t.value;e._wrapperState={selected:i}},postMountWrapper:function(e){var t=e._currentElement.props;if(null!=t.value){var n=i.getNodeFromInstance(e);n.setAttribute("value",t.value)}},getNativeProps:function(e,t){var n=r({selected:void 0,children:void 0},t);null!=e._wrapperState.selected&&(n.selected=e._wrapperState.selected);var i="";return o.forEach(t.children,function(e){null!=e&&("string"!=typeof e&&"number"!=typeof e||(i+=e))}),i&&(n.children=i),n}});t.exports=s},{178:178,179:179,32:32,44:44,54:54}],54:[function(e,t,n){function r(){if(this._rootNodeID&&this._wrapperState.pendingUpdate){this._wrapperState.pendingUpdate=!1;var e=this._currentElement.props,t=u.getValue(e);null!=t&&o(this,Boolean(e.multiple),t)}}function o(e,t,n){var r,o,i=l.getNodeFromInstance(e).options;if(t){for(r={},o=0;o<n.length;o++)r[""+n[o]]=!0;for(o=0;o<i.length;o++){var a=r.hasOwnProperty(i[o].value);i[o].selected!==a&&(i[o].selected=a)}}else{for(r=""+n,o=0;o<i.length;o++)if(i[o].value===r)return void(i[o].selected=!0);i.length&&(i[0].selected=!0)}}function i(e){var t=this._currentElement.props,n=u.executeOnChange(t,e);return this._rootNodeID&&(this._wrapperState.pendingUpdate=!0),c.asap(r,this),n}var a=e(179),s=e(14),u=e(25),l=e(44),c=e(99),p=(e(178),!1),d={getNativeProps:function(e,t){return a({},s.getNativeProps(e,t),{onChange:e._wrapperState.onChange,value:void 0})},mountWrapper:function(e,t){var n=u.getValue(t);e._wrapperState={pendingUpdate:!1,initialValue:null!=n?n:t.defaultValue,listeners:null,onChange:i.bind(e),wasMultiple:Boolean(t.multiple)},void 0===t.value||void 0===t.defaultValue||p||(p=!0)},getSelectValueContext:function(e){return e._wrapperState.initialValue},postUpdateWrapper:function(e){var t=e._currentElement.props;e._wrapperState.initialValue=void 0;var n=e._wrapperState.wasMultiple;e._wrapperState.wasMultiple=Boolean(t.multiple);var r=u.getValue(t);null!=r?(e._wrapperState.pendingUpdate=!1,o(e,Boolean(t.multiple),r)):n!==Boolean(t.multiple)&&(null!=t.defaultValue?o(e,Boolean(t.multiple),t.defaultValue):o(e,Boolean(t.multiple),t.multiple?[]:""))}};t.exports=d},{14:14,178:178,179:179,25:25,44:44,99:99}],55:[function(e,t,n){function r(e,t,n,r){return e===n&&t===r}function o(e){var t=document.selection,n=t.createRange(),r=n.text.length,o=n.duplicate();o.moveToElementText(e),o.setEndPoint("EndToStart",n);var i=o.text.length,a=i+r;return{start:i,end:a}}function i(e){var t=window.getSelection&&window.getSelection();if(!t||0===t.rangeCount)return null;var n=t.anchorNode,o=t.anchorOffset,i=t.focusNode,a=t.focusOffset,s=t.getRangeAt(0);try{s.startContainer.nodeType,s.endContainer.nodeType}catch(u){return null}var l=r(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),c=l?0:s.toString().length,p=s.cloneRange();p.selectNodeContents(e),p.setEnd(s.startContainer,s.startOffset);var d=r(p.startContainer,p.startOffset,p.endContainer,p.endOffset),f=d?0:p.toString().length,h=f+c,v=document.createRange();v.setStart(n,o),v.setEnd(i,a);var m=v.collapsed;return{start:m?h:f,end:m?f:h}}function a(e,t){var n,r,o=document.selection.createRange().duplicate();void 0===t.end?(n=t.start,r=n):t.start>t.end?(n=t.end,r=t.start):(n=t.start,r=t.end),o.moveToElementText(e),o.moveStart("character",n),o.setEndPoint("EndToStart",o),o.moveEnd("character",r-n),o.select()}function s(e,t){if(window.getSelection){var n=window.getSelection(),r=e[c()].length,o=Math.min(t.start,r),i=void 0===t.end?o:Math.min(t.end,r);if(!n.extend&&o>i){var a=i;i=o,o=a}var s=l(e,o),u=l(e,i);if(s&&u){var p=document.createRange();p.setStart(s.node,s.offset),n.removeAllRanges(),o>i?(n.addRange(p),n.extend(u.node,u.offset)):(p.setEnd(u.node,u.offset),n.addRange(p))}}}var u=e(154),l=e(136),c=e(137),p=u.canUseDOM&&"selection"in document&&!("getSelection"in window),d={getOffsets:p?o:i,setOffsets:p?a:s};t.exports=d},{136:136,137:137,154:154}],56:[function(e,t,n){var r=e(63),o=e(92),i=e(100);r.inject();var a={renderToString:o.renderToString,renderToStaticMarkup:o.renderToStaticMarkup,version:i};t.exports=a},{100:100,63:63,92:92}],57:[function(e,t,n){var r=e(179),o=e(7),i=e(8),a=e(44),s=(e(75),e(126)),u=e(168),l=(e(151),function(e){this._currentElement=e,this._stringText=""+e,this._nativeNode=null,this._nativeParent=null,this._domID=null,this._mountIndex=0,this._closingComment=null,this._commentNodes=null});r(l.prototype,{mountComponent:function(e,t,n,r){var o=n._idCounter++,u=" react-text: "+o+" ",l=" /react-text ";if(this._domID=o,this._nativeParent=t,e.useCreateElement){var c=n._ownerDocument,p=c.createComment(u),d=c.createComment(l),f=i(c.createDocumentFragment());return i.queueChild(f,i(p)),this._stringText&&i.queueChild(f,i(c.createTextNode(this._stringText))),i.queueChild(f,i(d)),a.precacheNode(this,p),this._closingComment=d,f}var h=s(this._stringText);return e.renderToStaticMarkup?h:"<!--"+u+"-->"+h+"<!--"+l+"-->"},receiveComponent:function(e,t){if(e!==this._currentElement){this._currentElement=e;var n=""+e;if(n!==this._stringText){this._stringText=n;var r=this.getNativeNode();o.replaceDelimitedText(r[0],r[1],n)}}},getNativeNode:function(){var e=this._commentNodes;if(e)return e;if(!this._closingComment)for(var t=a.getNodeFromInstance(this),n=t.nextSibling;;){if(null==n?u(!1):void 0,8===n.nodeType&&" /react-text "===n.nodeValue){this._closingComment=n;break}n=n.nextSibling}return e=[this._nativeNode,this._closingComment],this._commentNodes=e,e},unmountComponent:function(){this._closingComment=null,this._commentNodes=null,a.uncacheNode(this)}}),t.exports=l},{126:126,151:151,168:168,179:179,44:44,7:7,75:75,8:8}],58:[function(e,t,n){function r(){this._rootNodeID&&d.updateWrapper(this)}function o(e){var t=this._currentElement.props,n=u.executeOnChange(t,e);return c.asap(r,this),n}var i=e(179),a=e(14),s=e(11),u=e(25),l=e(44),c=e(99),p=e(168),d=(e(178),{getNativeProps:function(e,t){null!=t.dangerouslySetInnerHTML?p(!1):void 0;var n=i({},a.getNativeProps(e,t),{defaultValue:void 0,value:void 0,children:e._wrapperState.initialValue,onChange:e._wrapperState.onChange});return n},mountWrapper:function(e,t){var n=t.defaultValue,r=t.children;null!=r&&(null!=n?p(!1):void 0,Array.isArray(r)&&(r.length<=1?void 0:p(!1),r=r[0]),n=""+r),null==n&&(n="");var i=u.getValue(t);e._wrapperState={initialValue:""+(null!=i?i:n),listeners:null,onChange:o.bind(e)}},updateWrapper:function(e){var t=e._currentElement.props,n=u.getValue(t);null!=n&&s.setValueForProperty(l.getNodeFromInstance(e),"value",""+n)}});t.exports=d},{11:11,14:14,168:168,178:178,179:179,25:25,44:44,99:99}],59:[function(e,t,n){function r(e,t){"_nativeNode"in e?void 0:u(!1),"_nativeNode"in t?void 0:u(!1);for(var n=0,r=e;r;r=r._nativeParent)n++;for(var o=0,i=t;i;i=i._nativeParent)o++;for(;n-o>0;)e=e._nativeParent,n--;for(;o-n>0;)t=t._nativeParent,o--;for(var a=n;a--;){if(e===t)return e;e=e._nativeParent,t=t._nativeParent}return null}function o(e,t){"_nativeNode"in e?void 0:u(!1),"_nativeNode"in t?void 0:u(!1);for(;t;){if(t===e)return!0;t=t._nativeParent}return!1}function i(e){return"_nativeNode"in e?void 0:u(!1),e._nativeParent}function a(e,t,n){for(var r=[];e;)r.push(e),e=e._nativeParent;var o;for(o=r.length;o-->0;)t(r[o],!1,n);for(o=0;o<r.length;o++)t(r[o],!0,n)}function s(e,t,n,o,i){for(var a=e&&t?r(e,t):null,s=[];e&&e!==a;)s.push(e),e=e._nativeParent;for(var u=[];t&&t!==a;)u.push(t),t=t._nativeParent;var l;for(l=0;l<s.length;l++)n(s[l],!0,o);for(l=u.length;l-->0;)n(u[l],!1,i)}var u=e(168);t.exports={isAncestor:o,getLowestCommonAncestor:r,getParentInstance:i,traverseTwoPhase:a,traverseEnterLeave:s}},{168:168}],60:[function(e,t,n){var r,o=(e(10),e(18),e(178),{onCreateMarkupForProperty:function(e,t){r(e)},onSetValueForProperty:function(e,t,n){r(t)},onDeleteValueForProperty:function(e,t){r(t)}});t.exports=o},{10:10,178:178,18:18}],61:[function(e,t,n){function r(e,t,n,r,o,i){}function o(e){}var i=(e(154),e(176),e(178),[]),a={addDevtool:function(e){i.push(e)},removeDevtool:function(e){for(var t=0;t<i.length;t++)i[t]===e&&(i.splice(t,1),t--)},beginProfiling:function(){},endProfiling:function(){},getFlushHistory:function(){},onBeginFlush:function(){r("onBeginFlush")},onEndFlush:function(){r("onEndFlush")},onBeginLifeCycleTimer:function(e,t){o(e),r("onBeginLifeCycleTimer",e,t)},onEndLifeCycleTimer:function(e,t){o(e),r("onEndLifeCycleTimer",e,t)},onBeginReconcilerTimer:function(e,t){o(e),r("onBeginReconcilerTimer",e,t)},onEndReconcilerTimer:function(e,t){o(e),r("onEndReconcilerTimer",e,t)},onBeginProcessingChildContext:function(){r("onBeginProcessingChildContext")},onEndProcessingChildContext:function(){r("onEndProcessingChildContext")},onNativeOperation:function(e,t,n){o(e),r("onNativeOperation",e,t,n)},onSetState:function(){r("onSetState")},onSetDisplayName:function(e,t){o(e),r("onSetDisplayName",e,t)},onSetChildren:function(e,t){o(e),r("onSetChildren",e,t)},onSetOwner:function(e,t){o(e),r("onSetOwner",e,t)},onSetText:function(e,t){o(e),r("onSetText",e,t)},onMountRootComponent:function(e){o(e),r("onMountRootComponent",e)},onMountComponent:function(e){o(e),r("onMountComponent",e)},onUpdateComponent:function(e){o(e),r("onUpdateComponent",e)},onUnmountComponent:function(e){o(e),r("onUnmountComponent",e)}};t.exports=a},{154:154,176:176,178:178}],62:[function(e,t,n){function r(){this.reinitializeTransaction()}var o=e(179),i=e(99),a=e(119),s=e(160),u={initialize:s,close:function(){d.isBatchingUpdates=!1}},l={initialize:s,close:i.flushBatchedUpdates.bind(i)},c=[l,u];o(r.prototype,a.Mixin,{getTransactionWrappers:function(){return c}});var p=new r,d={isBatchingUpdates:!1,batchedUpdates:function(e,t,n,r,o,i){var a=d.isBatchingUpdates;d.isBatchingUpdates=!0,a?e(t,n,r,o,i):p.perform(e,null,t,n,r,o,i)}};t.exports=d},{119:119,160:160,179:179,99:99}],63:[function(e,t,n){function r(){E||(E=!0,g.EventEmitter.injectReactEventListener(m),g.EventPluginHub.injectEventPluginOrder(a),g.EventPluginUtils.injectComponentTree(p),g.EventPluginUtils.injectTreeTraversal(f),g.EventPluginHub.injectEventPluginsByName({SimpleEventPlugin:_,EnterLeaveEventPlugin:s,ChangeEventPlugin:i,SelectEventPlugin:b,BeforeInputEventPlugin:o}),g.NativeComponent.injectGenericComponentClass(c),g.NativeComponent.injectTextComponentClass(h),g.DOMProperty.injectDOMPropertyConfig(u),g.DOMProperty.injectDOMPropertyConfig(C),g.EmptyComponent.injectEmptyComponentFactory(function(e){return new d(e)}),g.Updates.injectReconcileTransaction(y),g.Updates.injectBatchingStrategy(v),g.Component.injectEnvironment(l))}var o=e(2),i=e(6),a=e(13),s=e(15),u=e(22),l=e(35),c=e(42),p=e(44),d=e(47),f=e(59),h=e(57),v=e(62),m=e(69),g=e(72),y=e(88),C=e(103),b=e(104),_=e(105),E=!1;t.exports={inject:r}},{103:103,104:104,105:105,13:13,15:15,2:2,22:22,35:35,42:42,44:44,47:47,57:57,59:59,6:6,62:62,69:69,72:72,88:88}],64:[function(e,t,n){var r=e(179),o=e(39),i=(e(178),e(123),"function"==typeof Symbol&&Symbol["for"]&&Symbol["for"]("react.element")||60103),a={key:!0,ref:!0,__self:!0,__source:!0},s=function(e,t,n,r,o,a,s){var u={$$typeof:i,type:e,key:t,ref:n,props:s,_owner:a};return u};s.createElement=function(e,t,n){var r,i={},u=null,l=null,c=null,p=null;if(null!=t){l=void 0===t.ref?null:t.ref,u=void 0===t.key?null:""+t.key,c=void 0===t.__self?null:t.__self,p=void 0===t.__source?null:t.__source;for(r in t)t.hasOwnProperty(r)&&!a.hasOwnProperty(r)&&(i[r]=t[r])}var d=arguments.length-2;if(1===d)i.children=n;else if(d>1){for(var f=Array(d),h=0;d>h;h++)f[h]=arguments[h+2];i.children=f}if(e&&e.defaultProps){var v=e.defaultProps;for(r in v)void 0===i[r]&&(i[r]=v[r])}return s(e,u,l,c,p,o.current,i)},s.createFactory=function(e){var t=s.createElement.bind(null,e);return t.type=e,t},s.cloneAndReplaceKey=function(e,t){var n=s(e.type,t,e.ref,e._self,e._source,e._owner,e.props);return n},s.cloneElement=function(e,t,n){var i,u=r({},e.props),l=e.key,c=e.ref,p=e._self,d=e._source,f=e._owner;if(null!=t){void 0!==t.ref&&(c=t.ref,f=o.current),void 0!==t.key&&(l=""+t.key);var h;e.type&&e.type.defaultProps&&(h=e.type.defaultProps);for(i in t)t.hasOwnProperty(i)&&!a.hasOwnProperty(i)&&(u[i]=void 0===t[i]&&void 0!==h?h[i]:t[i])}var v=arguments.length-2;if(1===v)u.children=n;else if(v>1){for(var m=Array(v),g=0;v>g;g++)m[g]=arguments[g+2];u.children=m}return s(e.type,l,c,p,d,f,u)},s.isValidElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===i},t.exports=s},{123:123,178:178,179:179,39:39}],65:[function(e,t,n){function r(){if(p.current){var e=p.current.getName();if(e)return" Check the render method of `"+e+"`."}return""}function o(e,t){e._store&&!e._store.validated&&null==e.key&&(e._store.validated=!0,i("uniqueKey",e,t))}function i(e,t,n){var o=r();if(!o){var i="string"==typeof n?n:n.displayName||n.name;i&&(o=" Check the top-level render call using <"+i+">.")}var a=h[e]||(h[e]={});if(a[o])return null;a[o]=!0;var s={parentOrOwner:o,url:" See https://fb.me/react-warning-keys for more information.",childOwner:null};return t&&t._owner&&t._owner!==p.current&&(s.childOwner=" It was passed a child from "+t._owner.getName()+"."),s}function a(e,t){if("object"==typeof e)if(Array.isArray(e))for(var n=0;n<e.length;n++){var r=e[n];l.isValidElement(r)&&o(r,t)}else if(l.isValidElement(e))e._store&&(e._store.validated=!0);else if(e){var i=d(e);if(i&&i!==e.entries)for(var a,s=i.call(e);!(a=s.next()).done;)l.isValidElement(a.value)&&o(a.value,t)}}function s(e,t,n,o){for(var i in t)if(t.hasOwnProperty(i)){var a;try{"function"!=typeof t[i]?f(!1):void 0,a=t[i](n,i,e,o)}catch(s){a=s}a instanceof Error&&!(a.message in v)&&(v[a.message]=!0,r())}}function u(e){var t=e.type;if("function"==typeof t){var n=t.displayName||t.name;t.propTypes&&s(n,t.propTypes,e.props,c.prop),"function"==typeof t.getDefaultProps}}var l=e(64),c=e(86),p=(e(85),e(39)),d=(e(123),e(134)),f=e(168),h=(e(178),{}),v={},m={createElement:function(e,t,n){var r="string"==typeof e||"function"==typeof e,o=l.createElement.apply(this,arguments);if(null==o)return o;if(r)for(var i=2;i<arguments.length;i++)a(arguments[i],e);return u(o),o},createFactory:function(e){var t=m.createElement.bind(null,e);return t.type=e,t},cloneElement:function(e,t,n){for(var r=l.cloneElement.apply(this,arguments),o=2;o<arguments.length;o++)a(arguments[o],r.type);return u(r),r}};t.exports=m},{123:123,134:134,168:168,178:178,39:39,64:64,85:85,86:86}],66:[function(e,t,n){var r,o={injectEmptyComponentFactory:function(e){r=e}},i={create:function(e){return r(e)}};i.injection=o,t.exports=i},{}],67:[function(e,t,n){function r(e,t,n,r){try{return t(n,r)}catch(i){return void(null===o&&(o=i))}}var o=null,i={invokeGuardedCallback:r,invokeGuardedCallbackWithCatch:r,rethrowCaughtError:function(){if(o){var e=o;throw o=null,e}}};t.exports=i},{}],68:[function(e,t,n){function r(e){o.enqueueEvents(e),o.processEventQueue(!1)}var o=e(17),i={handleTopLevel:function(e,t,n,i){var a=o.extractEvents(e,t,n,i);r(a)}};t.exports=i},{17:17}],69:[function(e,t,n){function r(e){for(;e._nativeParent;)e=e._nativeParent;var t=p.getNodeFromInstance(e),n=t.parentNode;return p.getClosestInstanceFromNode(n)}function o(e,t){this.topLevelType=e,this.nativeEvent=t,this.ancestors=[]}function i(e){var t=f(e.nativeEvent),n=p.getClosestInstanceFromNode(t),o=n;do e.ancestors.push(o),o=o&&r(o);while(o);for(var i=0;i<e.ancestors.length;i++)n=e.ancestors[i],v._handleTopLevel(e.topLevelType,n,e.nativeEvent,f(e.nativeEvent))}function a(e){var t=h(window);e(t)}var s=e(179),u=e(153),l=e(154),c=e(26),p=e(44),d=e(99),f=e(133),h=e(165);s(o.prototype,{destructor:function(){this.topLevelType=null,this.nativeEvent=null,this.ancestors.length=0}}),c.addPoolingTo(o,c.twoArgumentPooler);var v={_enabled:!0,_handleTopLevel:null,WINDOW_HANDLE:l.canUseDOM?window:null,setHandleTopLevel:function(e){v._handleTopLevel=e},setEnabled:function(e){v._enabled=!!e},isEnabled:function(){return v._enabled},trapBubbledEvent:function(e,t,n){var r=n;return r?u.listen(r,t,v.dispatchEvent.bind(null,e)):null},trapCapturedEvent:function(e,t,n){var r=n;return r?u.capture(r,t,v.dispatchEvent.bind(null,e)):null},monitorScrollValue:function(e){var t=a.bind(null,e);u.listen(window,"scroll",t)},dispatchEvent:function(e,t){if(v._enabled){var n=o.getPooled(e,t);try{d.batchedUpdates(i,n)}finally{o.release(n)}}}};t.exports=v},{133:133,153:153,154:154,165:165,179:179,26:26,44:44,99:99}],70:[function(e,t,n){var r={logTopLevelRenders:!1};t.exports=r},{}],71:[function(e,t,n){var r=e(32),o=e(64),i=e(160),a=e(168),s=(e(178),{create:function(e){if("object"!=typeof e||!e||Array.isArray(e))return e;if(o.isValidElement(e))return e;1===e.nodeType?a(!1):void 0;var t=[];for(var n in e)r.mapIntoWithKeyPrefixInternal(e[n],t,n,i.thatReturnsArgument);return t}});t.exports=s},{160:160,168:168,178:178,32:32,64:64}],72:[function(e,t,n){var r=e(10),o=e(17),i=e(19),a=e(36),s=e(33),u=e(66),l=e(28),c=e(81),p=e(99),d={Component:a.injection,Class:s.injection,DOMProperty:r.injection,EmptyComponent:u.injection,EventPluginHub:o.injection,EventPluginUtils:i.injection,EventEmitter:l.injection,NativeComponent:c.injection,Updates:p.injection};t.exports=d},{10:10,17:17,19:19,28:28,33:33,36:36,66:66,81:81,99:99}],73:[function(e,t,n){function r(e){return i(document.documentElement,e)}var o=e(55),i=e(157),a=e(162),s=e(163),u={hasSelectionCapabilities:function(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&"text"===e.type||"textarea"===t||"true"===e.contentEditable)},getSelectionInformation:function(){var e=s();return{focusedElem:e,selectionRange:u.hasSelectionCapabilities(e)?u.getSelection(e):null}},restoreSelection:function(e){var t=s(),n=e.focusedElem,o=e.selectionRange;t!==n&&r(n)&&(u.hasSelectionCapabilities(n)&&u.setSelection(n,o),a(n))},getSelection:function(e){var t;if("selectionStart"in e)t={start:e.selectionStart,end:e.selectionEnd};else if(document.selection&&e.nodeName&&"input"===e.nodeName.toLowerCase()){var n=document.selection.createRange();n.parentElement()===e&&(t={start:-n.moveStart("character",-e.value.length),end:-n.moveEnd("character",-e.value.length)})}else t=o.getOffsets(e);return t||{start:0,end:0}},setSelection:function(e,t){var n=t.start,r=t.end;if(void 0===r&&(r=n),"selectionStart"in e)e.selectionStart=n,e.selectionEnd=Math.min(r,e.value.length);else if(document.selection&&e.nodeName&&"input"===e.nodeName.toLowerCase()){var i=e.createTextRange();i.collapse(!0),i.moveStart("character",n),i.moveEnd("character",r-n),i.select()}else o.setOffsets(e,t)}};t.exports=u},{157:157,162:162,163:163,55:55}],74:[function(e,t,n){var r={remove:function(e){e._reactInternalInstance=void 0},get:function(e){return e._reactInternalInstance},has:function(e){return void 0!==e._reactInternalInstance},set:function(e,t){e._reactInternalInstance=t}};t.exports=r},{}],75:[function(e,t,n){var r=e(61);t.exports={debugTool:r}},{61:61}],76:[function(e,t,n){function r(e,t){this.value=e,this.requestChange=t}function o(e){var t={value:void 0===e?i.PropTypes.any.isRequired:e.isRequired,requestChange:i.PropTypes.func.isRequired};return i.PropTypes.shape(t)}var i=e(27);r.PropTypes={link:o},t.exports=r},{27:27}],77:[function(e,t,n){var r=e(122),o=/\/?>/,i=/^<\!\-\-/,a={CHECKSUM_ATTR_NAME:"data-react-checksum",addChecksumToMarkup:function(e){var t=r(e);return i.test(e)?e:e.replace(o," "+a.CHECKSUM_ATTR_NAME+'="'+t+'"$&')},canReuseMarkup:function(e,t){var n=t.getAttribute(a.CHECKSUM_ATTR_NAME);n=n&&parseInt(n,10);var o=r(e);return o===n}};t.exports=a},{122:122}],78:[function(e,t,n){function r(e,t){for(var n=Math.min(e.length,t.length),r=0;n>r;r++)if(e.charAt(r)!==t.charAt(r))return r;return e.length===t.length?-1:n}function o(e){return e?e.nodeType===D?e.documentElement:e.firstChild:null}function i(e){return e.getAttribute&&e.getAttribute(M)||""}function a(e,t,n,r,o){var i;if(C.logTopLevelRenders){var a=e._currentElement.props,s=a.type;i="React mount: "+("string"==typeof s?s:s.displayName||s.name),console.time(i)}var u=_.mountComponent(e,n,null,m(e,t),o);i&&console.timeEnd(i),e._renderedComponent._topLevelWrapper=e,U._mountImageIntoNode(u,t,e,r,n)}function s(e,t,n,r){var o=T.ReactReconcileTransaction.getPooled(!n&&g.useCreateElement);o.perform(a,null,e,t,o,n,r),T.ReactReconcileTransaction.release(o)}function u(e,t,n){for(_.unmountComponent(e,n),t.nodeType===D&&(t=t.documentElement);t.lastChild;)t.removeChild(t.lastChild)}function l(e){var t=o(e);if(t){var n=v.getInstanceFromNode(t);return!(!n||!n._nativeParent)}}function c(e){var t=o(e),n=t&&v.getInstanceFromNode(t);return n&&!n._nativeParent?n:null}function p(e){var t=c(e);return t?t._nativeContainerInfo._topLevelWrapper:null}var d=e(8),f=e(10),h=e(28),v=(e(39),e(44)),m=e(45),g=e(49),y=e(64),C=e(70),b=(e(75),e(77)),_=e(89),E=e(98),T=e(99),x=e(161),N=e(139),P=e(168),w=e(145),S=e(148),M=(e(178),f.ID_ATTRIBUTE_NAME),k=f.ROOT_ATTRIBUTE_NAME,R=1,D=9,A=11,O={},I=1,L=function(){this.rootID=I++};L.prototype.isReactComponent={},L.prototype.render=function(){return this.props};var U={TopLevelWrapper:L,_instancesByReactRootID:O,scrollMonitor:function(e,t){t()},_updateRootComponent:function(e,t,n,r){return U.scrollMonitor(n,function(){E.enqueueElementInternal(e,t),r&&E.enqueueCallbackInternal(e,r)}),e},_renderNewRootComponent:function(e,t,n,r){!t||t.nodeType!==R&&t.nodeType!==D&&t.nodeType!==A?P(!1):void 0,h.ensureScrollValueMonitoring();var o=N(e);T.batchedUpdates(s,o,t,n,r);var i=o._instance.rootID;return O[i]=o,o},renderSubtreeIntoContainer:function(e,t,n,r){return null==e||null==e._reactInternalInstance?P(!1):void 0,U._renderSubtreeIntoContainer(e,t,n,r)},_renderSubtreeIntoContainer:function(e,t,n,r){E.validateCallback(r,"ReactDOM.render"),y.isValidElement(t)?void 0:P(!1);var a=y(L,null,null,null,null,null,t),s=p(n);if(s){var u=s._currentElement,c=u.props;if(S(c,t)){var d=s._renderedComponent.getPublicInstance(),f=r&&function(){r.call(d)};return U._updateRootComponent(s,a,n,f),d}U.unmountComponentAtNode(n)}var h=o(n),v=h&&!!i(h),m=l(n),g=v&&!s&&!m,C=U._renderNewRootComponent(a,n,g,null!=e?e._reactInternalInstance._processChildContext(e._reactInternalInstance._context):x)._renderedComponent.getPublicInstance();return r&&r.call(C),C},render:function(e,t,n){return U._renderSubtreeIntoContainer(null,e,t,n)},unmountComponentAtNode:function(e){!e||e.nodeType!==R&&e.nodeType!==D&&e.nodeType!==A?P(!1):void 0;var t=p(e);return t?(delete O[t._instance.rootID],T.batchedUpdates(u,t,e,!1),!0):(l(e),1===e.nodeType&&e.hasAttribute(k),!1)},_mountImageIntoNode:function(e,t,n,i,a){if(!t||t.nodeType!==R&&t.nodeType!==D&&t.nodeType!==A?P(!1):void 0,i){var s=o(t);if(b.canReuseMarkup(e,s))return void v.precacheNode(n,s);var u=s.getAttribute(b.CHECKSUM_ATTR_NAME);s.removeAttribute(b.CHECKSUM_ATTR_NAME);var l=s.outerHTML;s.setAttribute(b.CHECKSUM_ATTR_NAME,u);var c=e,p=r(c,l);" (client) "+c.substring(p-20,p+20)+"\n (server) "+l.substring(p-20,p+20),t.nodeType===D?P(!1):void 0}if(t.nodeType===D?P(!1):void 0,a.useCreateElement){for(;t.lastChild;)t.removeChild(t.lastChild);d.insertTreeBefore(t,e,null)}else w(t,e),v.precacheNode(n,t.firstChild)}};t.exports=U},{10:10,139:139,145:145,148:148,161:161,168:168,178:178,28:28,39:39,44:44,45:45,49:49,64:64,70:70,75:75,77:77,8:8,89:89,98:98,99:99}],79:[function(e,t,n){function r(e,t,n){return{type:p.INSERT_MARKUP,content:e,fromIndex:null,fromNode:null,toIndex:n,afterNode:t}}function o(e,t,n){return{type:p.MOVE_EXISTING,content:null,fromIndex:e._mountIndex,fromNode:d.getNativeNode(e),toIndex:n,afterNode:t}}function i(e,t){return{type:p.REMOVE_NODE,content:null,fromIndex:e._mountIndex,fromNode:t,toIndex:null,afterNode:null}
}function a(e){return{type:p.SET_MARKUP,content:e,fromIndex:null,fromNode:null,toIndex:null,afterNode:null}}function s(e){return{type:p.TEXT_CONTENT,content:e,fromIndex:null,fromNode:null,toIndex:null,afterNode:null}}function u(e,t){return t&&(e=e||[],e.push(t)),e}function l(e,t){c.processChildrenUpdates(e,t)}var c=e(36),p=(e(75),e(80)),d=(e(39),e(89)),f=e(31),h=(e(160),e(128)),v=e(168),m={Mixin:{_reconcilerInstantiateChildren:function(e,t,n){return f.instantiateChildren(e,t,n)},_reconcilerUpdateChildren:function(e,t,n,r,o){var i;return i=h(t),f.updateChildren(e,i,n,r,o),i},mountChildren:function(e,t,n){var r=this._reconcilerInstantiateChildren(e,t,n);this._renderedChildren=r;var o=[],i=0;for(var a in r)if(r.hasOwnProperty(a)){var s=r[a],u=d.mountComponent(s,t,this,this._nativeContainerInfo,n);s._mountIndex=i++,o.push(u)}return o},updateTextContent:function(e){var t=this._renderedChildren;f.unmountChildren(t,!1);for(var n in t)t.hasOwnProperty(n)&&v(!1);var r=[s(e)];l(this,r)},updateMarkup:function(e){var t=this._renderedChildren;f.unmountChildren(t,!1);for(var n in t)t.hasOwnProperty(n)&&v(!1);var r=[a(e)];l(this,r)},updateChildren:function(e,t,n){this._updateChildren(e,t,n)},_updateChildren:function(e,t,n){var r=this._renderedChildren,o={},i=this._reconcilerUpdateChildren(r,e,o,t,n);if(i||r){var a,s=null,c=0,p=0,f=null;for(a in i)if(i.hasOwnProperty(a)){var h=r&&r[a],v=i[a];h===v?(s=u(s,this.moveChild(h,f,p,c)),c=Math.max(h._mountIndex,c),h._mountIndex=p):(h&&(c=Math.max(h._mountIndex,c)),s=u(s,this._mountChildAtIndex(v,f,p,t,n))),p++,f=d.getNativeNode(v)}for(a in o)o.hasOwnProperty(a)&&(s=u(s,this._unmountChild(r[a],o[a])));s&&l(this,s),this._renderedChildren=i}},unmountChildren:function(e){var t=this._renderedChildren;f.unmountChildren(t,e),this._renderedChildren=null},moveChild:function(e,t,n,r){return e._mountIndex<r?o(e,t,n):void 0},createChild:function(e,t,n){return r(n,t,e._mountIndex)},removeChild:function(e,t){return i(e,t)},_mountChildAtIndex:function(e,t,n,r,o){var i=d.mountComponent(e,r,this,this._nativeContainerInfo,o);return e._mountIndex=n,this.createChild(e,t,i)},_unmountChild:function(e,t){var n=this.removeChild(e,t);return e._mountIndex=null,n}}};t.exports=m},{128:128,160:160,168:168,31:31,36:36,39:39,75:75,80:80,89:89}],80:[function(e,t,n){var r=e(171),o=r({INSERT_MARKUP:null,MOVE_EXISTING:null,REMOVE_NODE:null,SET_MARKUP:null,TEXT_CONTENT:null});t.exports=o},{171:171}],81:[function(e,t,n){function r(e){if("function"==typeof e.type)return e.type;var t=e.type,n=p[t];return null==n&&(p[t]=n=l(t)),n}function o(e){return c?void 0:u(!1),new c(e)}function i(e){return new d(e)}function a(e){return e instanceof d}var s=e(179),u=e(168),l=null,c=null,p={},d=null,f={injectGenericComponentClass:function(e){c=e},injectTextComponentClass:function(e){d=e},injectComponentClasses:function(e){s(p,e)}},h={getComponentClassForElement:r,createInternalComponent:o,createInstanceForText:i,isTextComponent:a,injection:f};t.exports=h},{168:168,179:179}],82:[function(e,t,n){var r=e(64),o=e(168),i={NATIVE:0,COMPOSITE:1,EMPTY:2,getType:function(e){return null===e||e===!1?i.EMPTY:r.isValidElement(e)?"function"==typeof e.type?i.COMPOSITE:i.NATIVE:void o(!1)}};t.exports=i},{168:168,64:64}],83:[function(e,t,n){function r(e,t){}var o=(e(178),{isMounted:function(e){return!1},enqueueCallback:function(e,t){},enqueueForceUpdate:function(e){r(e,"forceUpdate")},enqueueReplaceState:function(e,t){r(e,"replaceState")},enqueueSetState:function(e,t){r(e,"setState")}});t.exports=o},{178:178}],84:[function(e,t,n){var r=e(168),o={isValidOwner:function(e){return!(!e||"function"!=typeof e.attachRef||"function"!=typeof e.detachRef)},addComponentAsRefTo:function(e,t,n){o.isValidOwner(n)?void 0:r(!1),n.attachRef(t,e)},removeComponentAsRefFrom:function(e,t,n){o.isValidOwner(n)?void 0:r(!1);var i=n.getPublicInstance();i&&i.refs[t]===e.getPublicInstance()&&n.detachRef(t)}};t.exports=o},{168:168}],85:[function(e,t,n){var r={};t.exports=r},{}],86:[function(e,t,n){var r=e(171),o=r({prop:null,context:null,childContext:null});t.exports=o},{171:171}],87:[function(e,t,n){function r(e,t){return e===t?0!==e||1/e===1/t:e!==e&&t!==t}function o(e){function t(t,n,r,o,i,a){if(o=o||T,a=a||r,null==n[r]){var s=b[i];return t?new Error("Required "+s+" `"+a+"` was not specified in "+("`"+o+"`.")):null}return e(n,r,o,i,a)}var n=t.bind(null,!1);return n.isRequired=t.bind(null,!0),n}function i(e){function t(t,n,r,o,i){var a=t[n],s=m(a);if(s!==e){var u=b[o],l=g(a);return new Error("Invalid "+u+" `"+i+"` of type "+("`"+l+"` supplied to `"+r+"`, expected ")+("`"+e+"`."))}return null}return o(t)}function a(){return o(_.thatReturns(null))}function s(e){function t(t,n,r,o,i){if("function"!=typeof e)return new Error("Property `"+i+"` of component `"+r+"` has invalid PropType notation inside arrayOf.");var a=t[n];if(!Array.isArray(a)){var s=b[o],u=m(a);return new Error("Invalid "+s+" `"+i+"` of type "+("`"+u+"` supplied to `"+r+"`, expected an array."))}for(var l=0;l<a.length;l++){var c=e(a,l,r,o,i+"["+l+"]");if(c instanceof Error)return c}return null}return o(t)}function u(){function e(e,t,n,r,o){if(!C.isValidElement(e[t])){var i=b[r];return new Error("Invalid "+i+" `"+o+"` supplied to "+("`"+n+"`, expected a single ReactElement."))}return null}return o(e)}function l(e){function t(t,n,r,o,i){if(!(t[n]instanceof e)){var a=b[o],s=e.name||T,u=y(t[n]);return new Error("Invalid "+a+" `"+i+"` of type "+("`"+u+"` supplied to `"+r+"`, expected ")+("instance of `"+s+"`."))}return null}return o(t)}function c(e){function t(t,n,o,i,a){for(var s=t[n],u=0;u<e.length;u++)if(r(s,e[u]))return null;var l=b[i],c=JSON.stringify(e);return new Error("Invalid "+l+" `"+a+"` of value `"+s+"` "+("supplied to `"+o+"`, expected one of "+c+"."))}return o(Array.isArray(e)?t:function(){return new Error("Invalid argument supplied to oneOf, expected an instance of array.")})}function p(e){function t(t,n,r,o,i){if("function"!=typeof e)return new Error("Property `"+i+"` of component `"+r+"` has invalid PropType notation inside objectOf.");var a=t[n],s=m(a);if("object"!==s){var u=b[o];return new Error("Invalid "+u+" `"+i+"` of type "+("`"+s+"` supplied to `"+r+"`, expected an object."))}for(var l in a)if(a.hasOwnProperty(l)){var c=e(a,l,r,o,i+"."+l);if(c instanceof Error)return c}return null}return o(t)}function d(e){function t(t,n,r,o,i){for(var a=0;a<e.length;a++){var s=e[a];if(null==s(t,n,r,o,i))return null}var u=b[o];return new Error("Invalid "+u+" `"+i+"` supplied to "+("`"+r+"`."))}return o(Array.isArray(e)?t:function(){return new Error("Invalid argument supplied to oneOfType, expected an instance of array.")})}function f(){function e(e,t,n,r,o){if(!v(e[t])){var i=b[r];return new Error("Invalid "+i+" `"+o+"` supplied to "+("`"+n+"`, expected a ReactNode."))}return null}return o(e)}function h(e){function t(t,n,r,o,i){var a=t[n],s=m(a);if("object"!==s){var u=b[o];return new Error("Invalid "+u+" `"+i+"` of type `"+s+"` "+("supplied to `"+r+"`, expected `object`."))}for(var l in e){var c=e[l];if(c){var p=c(a,l,r,o,i+"."+l);if(p)return p}}return null}return o(t)}function v(e){switch(typeof e){case"number":case"string":case"undefined":return!0;case"boolean":return!e;case"object":if(Array.isArray(e))return e.every(v);if(null===e||C.isValidElement(e))return!0;var t=E(e);if(!t)return!1;var n,r=t.call(e);if(t!==e.entries){for(;!(n=r.next()).done;)if(!v(n.value))return!1}else for(;!(n=r.next()).done;){var o=n.value;if(o&&!v(o[1]))return!1}return!0;default:return!1}}function m(e){var t=typeof e;return Array.isArray(e)?"array":e instanceof RegExp?"object":t}function g(e){var t=m(e);if("object"===t){if(e instanceof Date)return"date";if(e instanceof RegExp)return"regexp"}return t}function y(e){return e.constructor&&e.constructor.name?e.constructor.name:T}var C=e(64),b=e(85),_=e(160),E=e(134),T="<<anonymous>>",x={array:i("array"),bool:i("boolean"),func:i("function"),number:i("number"),object:i("object"),string:i("string"),any:a(),arrayOf:s,element:u(),instanceOf:l,node:f(),objectOf:p,oneOf:c,oneOfType:d,shape:h};t.exports=x},{134:134,160:160,64:64,85:85}],88:[function(e,t,n){function r(e){this.reinitializeTransaction(),this.renderToStaticMarkup=!1,this.reactMountReady=i.getPooled(null),this.useCreateElement=e}var o=e(179),i=e(5),a=e(26),s=e(28),u=e(73),l=e(119),c={initialize:u.getSelectionInformation,close:u.restoreSelection},p={initialize:function(){var e=s.isEnabled();return s.setEnabled(!1),e},close:function(e){s.setEnabled(e)}},d={initialize:function(){this.reactMountReady.reset()},close:function(){this.reactMountReady.notifyAll()}},f=[c,p,d],h={getTransactionWrappers:function(){return f},getReactMountReady:function(){return this.reactMountReady},checkpoint:function(){return this.reactMountReady.checkpoint()},rollback:function(e){this.reactMountReady.rollback(e)},destructor:function(){i.release(this.reactMountReady),this.reactMountReady=null}};o(r.prototype,l.Mixin,h),a.addPoolingTo(r),t.exports=r},{119:119,179:179,26:26,28:28,5:5,73:73}],89:[function(e,t,n){function r(){o.attachRefs(this,this._currentElement)}var o=e(90),i=(e(75),e(168)),a={mountComponent:function(e,t,n,o,i){var a=e.mountComponent(t,n,o,i);return e._currentElement&&null!=e._currentElement.ref&&t.getReactMountReady().enqueue(r,e),a},getNativeNode:function(e){return e.getNativeNode()},unmountComponent:function(e,t){o.detachRefs(e,e._currentElement),e.unmountComponent(t)},receiveComponent:function(e,t,n,i){var a=e._currentElement;if(t!==a||i!==e._context){var s=o.shouldUpdateRefs(a,t);s&&o.detachRefs(e,a),e.receiveComponent(t,n,i),s&&e._currentElement&&null!=e._currentElement.ref&&n.getReactMountReady().enqueue(r,e)}},performUpdateIfNecessary:function(e,t,n){return e._updateBatchNumber!==n?void(null!=e._updateBatchNumber&&e._updateBatchNumber!==n+1?i(!1):void 0):void e.performUpdateIfNecessary(t)}};t.exports=a},{168:168,75:75,90:90}],90:[function(e,t,n){function r(e,t,n){"function"==typeof e?e(t.getPublicInstance()):i.addComponentAsRefTo(t,e,n)}function o(e,t,n){"function"==typeof e?e(null):i.removeComponentAsRefFrom(t,e,n)}var i=e(84),a={};a.attachRefs=function(e,t){if(null!==t&&t!==!1){var n=t.ref;null!=n&&r(n,e,t._owner)}},a.shouldUpdateRefs=function(e,t){var n=null===e||e===!1,r=null===t||t===!1;return n||r||t._owner!==e._owner||t.ref!==e.ref},a.detachRefs=function(e,t){if(null!==t&&t!==!1){var n=t.ref;null!=n&&o(n,e,t._owner)}},t.exports=a},{84:84}],91:[function(e,t,n){var r={isBatchingUpdates:!1,batchedUpdates:function(e){}};t.exports=r},{}],92:[function(e,t,n){function r(e,t){var n;try{return f.injection.injectBatchingStrategy(p),n=d.getPooled(t),n.perform(function(){var r=v(e),o=c.mountComponent(r,n,null,a(),h);return t||(o=l.addChecksumToMarkup(o)),o},null)}finally{d.release(n),f.injection.injectBatchingStrategy(s)}}function o(e){return u.isValidElement(e)?void 0:m(!1),r(e,!1)}function i(e){return u.isValidElement(e)?void 0:m(!1),r(e,!0)}var a=e(45),s=e(62),u=e(64),l=(e(75),e(77)),c=e(89),p=e(91),d=e(93),f=e(99),h=e(161),v=e(139),m=e(168);t.exports={renderToString:o,renderToStaticMarkup:i}},{139:139,161:161,168:168,45:45,62:62,64:64,75:75,77:77,89:89,91:91,93:93,99:99}],93:[function(e,t,n){function r(e){this.reinitializeTransaction(),this.renderToStaticMarkup=e,this.useCreateElement=!1}var o=e(179),i=e(26),a=e(119),s=[],u={enqueue:function(){}},l={getTransactionWrappers:function(){return s},getReactMountReady:function(){return u},destructor:function(){},checkpoint:function(){},rollback:function(){}};o(r.prototype,a.Mixin,l),i.addPoolingTo(r),t.exports=r},{119:119,179:179,26:26}],94:[function(e,t,n){function r(e,t){var n={};return function(r){n[t]=r,e.setState(n)}}var o={createStateSetter:function(e,t){return function(n,r,o,i,a,s){var u=t.call(e,n,r,o,i,a,s);u&&e.setState(u)}},createStateKeySetter:function(e,t){var n=e.__keySetters||(e.__keySetters={});return n[t]||(n[t]=r(e,t))}};o.Mixin={createStateSetter:function(e){return o.createStateSetter(this,e)},createStateKeySetter:function(e){return o.createStateKeySetter(this,e)}},t.exports=o},{}],95:[function(e,t,n){var r=e(128),o={getChildMapping:function(e){return e?r(e):e},mergeChildMappings:function(e,t){function n(n){return t.hasOwnProperty(n)?t[n]:e[n]}e=e||{},t=t||{};var r={},o=[];for(var i in e)t.hasOwnProperty(i)?o.length&&(r[i]=o,o=[]):o.push(i);var a,s={};for(var u in t){if(r.hasOwnProperty(u))for(a=0;a<r[u].length;a++){var l=r[u][a];s[r[u][a]]=n(l)}s[u]=n(u)}for(a=0;a<o.length;a++)s[o[a]]=n(o[a]);return s}};t.exports=o},{128:128}],96:[function(e,t,n){function r(){var e=s("animationend"),t=s("transitionend");e&&u.push(e),t&&u.push(t)}function o(e,t,n){e.addEventListener(t,n,!1)}function i(e,t,n){e.removeEventListener(t,n,!1)}var a=e(154),s=e(138),u=[];a.canUseDOM&&r();var l={addEndEventListener:function(e,t){return 0===u.length?void window.setTimeout(t,0):void u.forEach(function(n){o(e,n,t)})},removeEndEventListener:function(e,t){0!==u.length&&u.forEach(function(n){i(e,n,t)})}};t.exports=l},{138:138,154:154}],97:[function(e,t,n){var r=e(179),o=e(27),i=e(95),a=e(160),s=o.createClass({displayName:"ReactTransitionGroup",propTypes:{component:o.PropTypes.any,childFactory:o.PropTypes.func},getDefaultProps:function(){return{component:"span",childFactory:a.thatReturnsArgument}},getInitialState:function(){return{children:i.getChildMapping(this.props.children)}},componentWillMount:function(){this.currentlyTransitioningKeys={},this.keysToEnter=[],this.keysToLeave=[]},componentDidMount:function(){var e=this.state.children;for(var t in e)e[t]&&this.performAppear(t)},componentWillReceiveProps:function(e){var t=i.getChildMapping(e.children),n=this.state.children;this.setState({children:i.mergeChildMappings(n,t)});var r;for(r in t){var o=n&&n.hasOwnProperty(r);!t[r]||o||this.currentlyTransitioningKeys[r]||this.keysToEnter.push(r)}for(r in n){var a=t&&t.hasOwnProperty(r);!n[r]||a||this.currentlyTransitioningKeys[r]||this.keysToLeave.push(r)}},componentDidUpdate:function(){var e=this.keysToEnter;this.keysToEnter=[],e.forEach(this.performEnter);var t=this.keysToLeave;this.keysToLeave=[],t.forEach(this.performLeave)},performAppear:function(e){this.currentlyTransitioningKeys[e]=!0;var t=this.refs[e];t.componentWillAppear?t.componentWillAppear(this._handleDoneAppearing.bind(this,e)):this._handleDoneAppearing(e)},_handleDoneAppearing:function(e){var t=this.refs[e];t.componentDidAppear&&t.componentDidAppear(),delete this.currentlyTransitioningKeys[e];var n=i.getChildMapping(this.props.children);n&&n.hasOwnProperty(e)||this.performLeave(e)},performEnter:function(e){this.currentlyTransitioningKeys[e]=!0;var t=this.refs[e];t.componentWillEnter?t.componentWillEnter(this._handleDoneEntering.bind(this,e)):this._handleDoneEntering(e)},_handleDoneEntering:function(e){var t=this.refs[e];t.componentDidEnter&&t.componentDidEnter(),delete this.currentlyTransitioningKeys[e];var n=i.getChildMapping(this.props.children);n&&n.hasOwnProperty(e)||this.performLeave(e)},performLeave:function(e){this.currentlyTransitioningKeys[e]=!0;var t=this.refs[e];t.componentWillLeave?t.componentWillLeave(this._handleDoneLeaving.bind(this,e)):this._handleDoneLeaving(e)},_handleDoneLeaving:function(e){var t=this.refs[e];t.componentDidLeave&&t.componentDidLeave(),delete this.currentlyTransitioningKeys[e];var n=i.getChildMapping(this.props.children);n&&n.hasOwnProperty(e)?this.performEnter(e):this.setState(function(t){var n=r({},t.children);return delete n[e],{children:n}})},render:function(){var e=[];for(var t in this.state.children){var n=this.state.children[t];n&&e.push(o.cloneElement(this.props.childFactory(n),{ref:t,key:t}))}return o.createElement(this.props.component,this.props,e)}});t.exports=s},{160:160,179:179,27:27,95:95}],98:[function(e,t,n){function r(e){a.enqueueUpdate(e)}function o(e,t){var n=i.get(e);return n?n:null}var i=(e(39),e(74)),a=e(99),s=e(168),u=(e(178),{isMounted:function(e){var t=i.get(e);return t?!!t._renderedComponent:!1},enqueueCallback:function(e,t,n){u.validateCallback(t,n);var i=o(e);return i?(i._pendingCallbacks?i._pendingCallbacks.push(t):i._pendingCallbacks=[t],void r(i)):null},enqueueCallbackInternal:function(e,t){e._pendingCallbacks?e._pendingCallbacks.push(t):e._pendingCallbacks=[t],r(e)},enqueueForceUpdate:function(e){var t=o(e,"forceUpdate");t&&(t._pendingForceUpdate=!0,r(t))},enqueueReplaceState:function(e,t){var n=o(e,"replaceState");n&&(n._pendingStateQueue=[t],n._pendingReplaceState=!0,r(n))},enqueueSetState:function(e,t){var n=o(e,"setState");if(n){var i=n._pendingStateQueue||(n._pendingStateQueue=[]);i.push(t),r(n)}},enqueueElementInternal:function(e,t){e._pendingElement=t,r(e)},validateCallback:function(e,t){e&&"function"!=typeof e?s(!1):void 0}});t.exports=u},{168:168,178:178,39:39,74:74,99:99}],99:[function(e,t,n){function r(){w.ReactReconcileTransaction&&_?void 0:m(!1)}function o(){this.reinitializeTransaction(),this.dirtyComponentsLength=null,this.callbackQueue=p.getPooled(),this.reconcileTransaction=w.ReactReconcileTransaction.getPooled(!0)}function i(e,t,n,o,i,a){r(),_.batchedUpdates(e,t,n,o,i,a)}function a(e,t){return e._mountOrder-t._mountOrder}function s(e){var t=e.dirtyComponentsLength;t!==g.length?m(!1):void 0,g.sort(a),y++;for(var n=0;t>n;n++){var r=g[n],o=r._pendingCallbacks;r._pendingCallbacks=null;var i;if(f.logTopLevelRenders){var s=r;r._currentElement.props===r._renderedComponent._currentElement&&(s=r._renderedComponent),i="React update: "+s.getName(),console.time(i)}if(h.performUpdateIfNecessary(r,e.reconcileTransaction,y),i&&console.timeEnd(i),o)for(var u=0;u<o.length;u++)e.callbackQueue.enqueue(o[u],r.getPublicInstance())}}function u(e){return r(),_.isBatchingUpdates?(g.push(e),void(null==e._updateBatchNumber&&(e._updateBatchNumber=y+1))):void _.batchedUpdates(u,e)}function l(e,t){_.isBatchingUpdates?void 0:m(!1),C.enqueue(e,t),b=!0}var c=e(179),p=e(5),d=e(26),f=e(70),h=(e(75),e(89)),v=e(119),m=e(168),g=[],y=0,C=p.getPooled(),b=!1,_=null,E={initialize:function(){this.dirtyComponentsLength=g.length},close:function(){this.dirtyComponentsLength!==g.length?(g.splice(0,this.dirtyComponentsLength),N()):g.length=0}},T={initialize:function(){this.callbackQueue.reset()},close:function(){this.callbackQueue.notifyAll()}},x=[E,T];c(o.prototype,v.Mixin,{getTransactionWrappers:function(){return x},destructor:function(){this.dirtyComponentsLength=null,p.release(this.callbackQueue),this.callbackQueue=null,w.ReactReconcileTransaction.release(this.reconcileTransaction),this.reconcileTransaction=null},perform:function(e,t,n){return v.Mixin.perform.call(this,this.reconcileTransaction.perform,this.reconcileTransaction,e,t,n)}}),d.addPoolingTo(o);var N=function(){for(;g.length||b;){if(g.length){var e=o.getPooled();e.perform(s,null,e),o.release(e)}if(b){b=!1;var t=C;C=p.getPooled(),t.notifyAll(),p.release(t)}}},P={injectReconcileTransaction:function(e){e?void 0:m(!1),w.ReactReconcileTransaction=e},injectBatchingStrategy:function(e){e?void 0:m(!1),"function"!=typeof e.batchedUpdates?m(!1):void 0,"boolean"!=typeof e.isBatchingUpdates?m(!1):void 0,_=e}},w={ReactReconcileTransaction:null,batchedUpdates:i,enqueueUpdate:u,flushBatchedUpdates:N,injection:P,asap:l};t.exports=w},{119:119,168:168,179:179,26:26,5:5,70:70,75:75,89:89}],100:[function(e,t,n){t.exports="15.1.0"},{}],101:[function(e,t,n){var r=e(24),o=e(27),i=e(37),a=e(29),s=e(71),u=e(97),l=e(147),c=e(150);o.addons={CSSTransitionGroup:a,LinkedStateMixin:r,PureRenderMixin:i,TransitionGroup:u,createFragment:s.create,shallowCompare:l,update:c},t.exports=o},{147:147,150:150,24:24,27:27,29:29,37:37,71:71,97:97}],102:[function(e,t,n){var r=e(179),o=e(40),i=e(56),a=e(101),s=r({__SECRET_DOM_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:o,__SECRET_DOM_SERVER_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:i},a);t.exports=s},{101:101,179:179,40:40,56:56}],103:[function(e,t,n){var r={xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace"},o={accentHeight:"accent-height",accumulate:0,additive:0,alignmentBaseline:"alignment-baseline",allowReorder:"allowReorder",alphabetic:0,amplitude:0,arabicForm:"arabic-form",ascent:0,attributeName:"attributeName",attributeType:"attributeType",autoReverse:"autoReverse",azimuth:0,baseFrequency:"baseFrequency",baseProfile:"baseProfile",baselineShift:"baseline-shift",bbox:0,begin:0,bias:0,by:0,calcMode:"calcMode",capHeight:"cap-height",clip:0,clipPath:"clip-path",clipRule:"clip-rule",clipPathUnits:"clipPathUnits",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",contentScriptType:"contentScriptType",contentStyleType:"contentStyleType",cursor:0,cx:0,cy:0,d:0,decelerate:0,descent:0,diffuseConstant:"diffuseConstant",direction:0,display:0,divisor:0,dominantBaseline:"dominant-baseline",dur:0,dx:0,dy:0,edgeMode:"edgeMode",elevation:0,enableBackground:"enable-background",end:0,exponent:0,externalResourcesRequired:"externalResourcesRequired",fill:0,fillOpacity:"fill-opacity",fillRule:"fill-rule",filter:0,filterRes:"filterRes",filterUnits:"filterUnits",floodColor:"flood-color",floodOpacity:"flood-opacity",focusable:0,fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",format:0,from:0,fx:0,fy:0,g1:0,g2:0,glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",glyphRef:"glyphRef",gradientTransform:"gradientTransform",gradientUnits:"gradientUnits",hanging:0,horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",ideographic:0,imageRendering:"image-rendering","in":0,in2:0,intercept:0,k:0,k1:0,k2:0,k3:0,k4:0,kernelMatrix:"kernelMatrix",kernelUnitLength:"kernelUnitLength",kerning:0,keyPoints:"keyPoints",keySplines:"keySplines",keyTimes:"keyTimes",lengthAdjust:"lengthAdjust",letterSpacing:"letter-spacing",lightingColor:"lighting-color",limitingConeAngle:"limitingConeAngle",local:0,markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",markerHeight:"markerHeight",markerUnits:"markerUnits",markerWidth:"markerWidth",mask:0,maskContentUnits:"maskContentUnits",maskUnits:"maskUnits",mathematical:0,mode:0,numOctaves:"numOctaves",offset:0,opacity:0,operator:0,order:0,orient:0,orientation:0,origin:0,overflow:0,overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pathLength:"pathLength",patternContentUnits:"patternContentUnits",patternTransform:"patternTransform",patternUnits:"patternUnits",pointerEvents:"pointer-events",points:0,pointsAtX:"pointsAtX",pointsAtY:"pointsAtY",pointsAtZ:"pointsAtZ",preserveAlpha:"preserveAlpha",preserveAspectRatio:"preserveAspectRatio",primitiveUnits:"primitiveUnits",r:0,radius:0,refX:"refX",refY:"refY",renderingIntent:"rendering-intent",repeatCount:"repeatCount",repeatDur:"repeatDur",requiredExtensions:"requiredExtensions",requiredFeatures:"requiredFeatures",restart:0,result:0,rotate:0,rx:0,ry:0,scale:0,seed:0,shapeRendering:"shape-rendering",slope:0,spacing:0,specularConstant:"specularConstant",specularExponent:"specularExponent",speed:0,spreadMethod:"spreadMethod",startOffset:"startOffset",stdDeviation:"stdDeviation",stemh:0,stemv:0,stitchTiles:"stitchTiles",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",string:0,stroke:0,strokeDasharray:"stroke-dasharray",strokeDashoffset:"stroke-dashoffset",strokeLinecap:"stroke-linecap",strokeLinejoin:"stroke-linejoin",strokeMiterlimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",surfaceScale:"surfaceScale",systemLanguage:"systemLanguage",tableValues:"tableValues",targetX:"targetX",targetY:"targetY",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",textLength:"textLength",to:0,transform:0,u1:0,u2:0,underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicode:0,unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",values:0,vectorEffect:"vector-effect",version:0,vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",viewBox:"viewBox",viewTarget:"viewTarget",visibility:0,widths:0,wordSpacing:"word-spacing",writingMode:"writing-mode",x:0,xHeight:"x-height",x1:0,x2:0,xChannelSelector:"xChannelSelector",xlinkActuate:"xlink:actuate",xlinkArcrole:"xlink:arcrole",xlinkHref:"xlink:href",xlinkRole:"xlink:role",xlinkShow:"xlink:show",xlinkTitle:"xlink:title",xlinkType:"xlink:type",xmlBase:"xml:base",xmlLang:"xml:lang",xmlSpace:"xml:space",y:0,y1:0,y2:0,yChannelSelector:"yChannelSelector",z:0,zoomAndPan:"zoomAndPan"},i={Properties:{},DOMAttributeNamespaces:{xlinkActuate:r.xlink,xlinkArcrole:r.xlink,xlinkHref:r.xlink,xlinkRole:r.xlink,xlinkShow:r.xlink,xlinkTitle:r.xlink,xlinkType:r.xlink,xmlBase:r.xml,xmlLang:r.xml,xmlSpace:r.xml},DOMAttributeNames:{}};Object.keys(o).forEach(function(e){i.Properties[e]=0,o[e]&&(i.DOMAttributeNames[e]=o[e])}),t.exports=i},{}],104:[function(e,t,n){function r(e){if("selectionStart"in e&&l.hasSelectionCapabilities(e))return{start:e.selectionStart,end:e.selectionEnd};if(window.getSelection){var t=window.getSelection();return{anchorNode:t.anchorNode,anchorOffset:t.anchorOffset,focusNode:t.focusNode,focusOffset:t.focusOffset}}if(document.selection){var n=document.selection.createRange();return{parentElement:n.parentElement(),text:n.text,top:n.boundingTop,left:n.boundingLeft}}}function o(e,t){if(_||null==y||y!==p())return null;var n=r(y);if(!b||!h(b,n)){b=n;var o=c.getPooled(g.select,C,e,t);return o.type="select",o.target=y,a.accumulateTwoPhaseDispatches(o),o}return null}var i=e(16),a=e(20),s=e(154),u=e(44),l=e(73),c=e(110),p=e(163),d=e(141),f=e(172),h=e(177),v=i.topLevelTypes,m=s.canUseDOM&&"documentMode"in document&&document.documentMode<=11,g={select:{phasedRegistrationNames:{bubbled:f({onSelect:null}),captured:f({onSelectCapture:null})},dependencies:[v.topBlur,v.topContextMenu,v.topFocus,v.topKeyDown,v.topMouseDown,v.topMouseUp,v.topSelectionChange]}},y=null,C=null,b=null,_=!1,E=!1,T=f({onSelect:null}),x={eventTypes:g,extractEvents:function(e,t,n,r){if(!E)return null;var i=t?u.getNodeFromInstance(t):window;switch(e){case v.topFocus:(d(i)||"true"===i.contentEditable)&&(y=i,C=t,b=null);break;case v.topBlur:y=null,C=null,b=null;break;case v.topMouseDown:_=!0;break;case v.topContextMenu:case v.topMouseUp:return _=!1,o(n,r);case v.topSelectionChange:if(m)break;case v.topKeyDown:case v.topKeyUp:return o(n,r)}return null},didPutListener:function(e,t,n){t===T&&(E=!0)}};t.exports=x},{110:110,141:141,154:154,16:16,163:163,172:172,177:177,20:20,44:44,73:73}],105:[function(e,t,n){var r=e(16),o=e(153),i=e(20),a=e(44),s=e(106),u=e(107),l=e(110),c=e(111),p=e(113),d=e(114),f=e(109),h=e(115),v=e(116),m=e(117),g=e(118),y=e(160),C=e(130),b=e(168),_=e(172),E=r.topLevelTypes,T={abort:{phasedRegistrationNames:{bubbled:_({onAbort:!0}),captured:_({onAbortCapture:!0})}},animationEnd:{phasedRegistrationNames:{bubbled:_({onAnimationEnd:!0}),captured:_({onAnimationEndCapture:!0})}},animationIteration:{phasedRegistrationNames:{bubbled:_({onAnimationIteration:!0}),captured:_({onAnimationIterationCapture:!0})}},animationStart:{phasedRegistrationNames:{bubbled:_({onAnimationStart:!0}),captured:_({onAnimationStartCapture:!0})}},blur:{phasedRegistrationNames:{bubbled:_({onBlur:!0}),captured:_({onBlurCapture:!0})}},canPlay:{phasedRegistrationNames:{bubbled:_({onCanPlay:!0}),captured:_({onCanPlayCapture:!0})}},canPlayThrough:{phasedRegistrationNames:{bubbled:_({onCanPlayThrough:!0}),captured:_({onCanPlayThroughCapture:!0})}},click:{phasedRegistrationNames:{bubbled:_({onClick:!0}),captured:_({onClickCapture:!0})}},contextMenu:{phasedRegistrationNames:{bubbled:_({onContextMenu:!0}),captured:_({onContextMenuCapture:!0})}},copy:{phasedRegistrationNames:{bubbled:_({onCopy:!0}),captured:_({onCopyCapture:!0})}},cut:{phasedRegistrationNames:{bubbled:_({onCut:!0}),captured:_({onCutCapture:!0})}},doubleClick:{phasedRegistrationNames:{bubbled:_({onDoubleClick:!0}),captured:_({onDoubleClickCapture:!0})}},drag:{phasedRegistrationNames:{bubbled:_({onDrag:!0}),captured:_({onDragCapture:!0})}},dragEnd:{phasedRegistrationNames:{bubbled:_({onDragEnd:!0}),captured:_({onDragEndCapture:!0})}},dragEnter:{phasedRegistrationNames:{bubbled:_({onDragEnter:!0}),captured:_({onDragEnterCapture:!0})}},dragExit:{phasedRegistrationNames:{bubbled:_({onDragExit:!0}),captured:_({onDragExitCapture:!0})}},dragLeave:{phasedRegistrationNames:{bubbled:_({onDragLeave:!0}),captured:_({onDragLeaveCapture:!0})}},dragOver:{phasedRegistrationNames:{bubbled:_({onDragOver:!0}),captured:_({onDragOverCapture:!0})}},dragStart:{phasedRegistrationNames:{bubbled:_({onDragStart:!0}),captured:_({onDragStartCapture:!0})}},drop:{phasedRegistrationNames:{bubbled:_({onDrop:!0}),captured:_({onDropCapture:!0})}},durationChange:{phasedRegistrationNames:{bubbled:_({onDurationChange:!0}),captured:_({onDurationChangeCapture:!0})}},emptied:{phasedRegistrationNames:{bubbled:_({onEmptied:!0}),captured:_({onEmptiedCapture:!0})}},encrypted:{phasedRegistrationNames:{bubbled:_({onEncrypted:!0}),captured:_({onEncryptedCapture:!0})}},ended:{phasedRegistrationNames:{bubbled:_({onEnded:!0}),captured:_({onEndedCapture:!0})}},error:{phasedRegistrationNames:{bubbled:_({onError:!0}),captured:_({onErrorCapture:!0})}},focus:{phasedRegistrationNames:{bubbled:_({onFocus:!0}),captured:_({onFocusCapture:!0})}},input:{phasedRegistrationNames:{bubbled:_({onInput:!0}),captured:_({onInputCapture:!0})}},invalid:{phasedRegistrationNames:{bubbled:_({onInvalid:!0}),captured:_({onInvalidCapture:!0})}},keyDown:{phasedRegistrationNames:{bubbled:_({onKeyDown:!0}),captured:_({onKeyDownCapture:!0})}},keyPress:{phasedRegistrationNames:{bubbled:_({onKeyPress:!0}),captured:_({onKeyPressCapture:!0})}},keyUp:{phasedRegistrationNames:{bubbled:_({onKeyUp:!0}),captured:_({onKeyUpCapture:!0})}},load:{phasedRegistrationNames:{bubbled:_({onLoad:!0}),captured:_({onLoadCapture:!0})}},loadedData:{phasedRegistrationNames:{bubbled:_({onLoadedData:!0}),captured:_({onLoadedDataCapture:!0})}},loadedMetadata:{phasedRegistrationNames:{bubbled:_({onLoadedMetadata:!0}),captured:_({onLoadedMetadataCapture:!0})}},loadStart:{phasedRegistrationNames:{bubbled:_({onLoadStart:!0}),captured:_({onLoadStartCapture:!0})}},mouseDown:{phasedRegistrationNames:{bubbled:_({onMouseDown:!0}),captured:_({onMouseDownCapture:!0})}},mouseMove:{phasedRegistrationNames:{bubbled:_({onMouseMove:!0}),captured:_({onMouseMoveCapture:!0})}},mouseOut:{phasedRegistrationNames:{bubbled:_({onMouseOut:!0}),captured:_({onMouseOutCapture:!0})}},mouseOver:{phasedRegistrationNames:{bubbled:_({onMouseOver:!0}),captured:_({onMouseOverCapture:!0})}},mouseUp:{phasedRegistrationNames:{bubbled:_({onMouseUp:!0}),captured:_({onMouseUpCapture:!0})}},paste:{phasedRegistrationNames:{bubbled:_({onPaste:!0}),captured:_({onPasteCapture:!0})}},pause:{phasedRegistrationNames:{bubbled:_({onPause:!0}),captured:_({onPauseCapture:!0})}},play:{phasedRegistrationNames:{bubbled:_({onPlay:!0}),captured:_({onPlayCapture:!0})}},playing:{phasedRegistrationNames:{bubbled:_({onPlaying:!0}),captured:_({onPlayingCapture:!0})}},progress:{phasedRegistrationNames:{bubbled:_({onProgress:!0}),captured:_({onProgressCapture:!0})}},rateChange:{phasedRegistrationNames:{bubbled:_({onRateChange:!0}),captured:_({onRateChangeCapture:!0})}},reset:{phasedRegistrationNames:{bubbled:_({onReset:!0}),captured:_({onResetCapture:!0})}},scroll:{phasedRegistrationNames:{bubbled:_({onScroll:!0}),captured:_({onScrollCapture:!0})}},seeked:{phasedRegistrationNames:{bubbled:_({onSeeked:!0}),captured:_({onSeekedCapture:!0})}},seeking:{phasedRegistrationNames:{bubbled:_({onSeeking:!0}),captured:_({onSeekingCapture:!0})}},stalled:{phasedRegistrationNames:{bubbled:_({onStalled:!0}),captured:_({onStalledCapture:!0})}},submit:{phasedRegistrationNames:{bubbled:_({onSubmit:!0}),captured:_({onSubmitCapture:!0})}},suspend:{phasedRegistrationNames:{bubbled:_({onSuspend:!0}),captured:_({onSuspendCapture:!0})}},timeUpdate:{phasedRegistrationNames:{bubbled:_({onTimeUpdate:!0}),captured:_({onTimeUpdateCapture:!0})}},touchCancel:{phasedRegistrationNames:{bubbled:_({onTouchCancel:!0}),captured:_({onTouchCancelCapture:!0})}},touchEnd:{phasedRegistrationNames:{bubbled:_({onTouchEnd:!0}),captured:_({onTouchEndCapture:!0})}},touchMove:{phasedRegistrationNames:{bubbled:_({onTouchMove:!0}),captured:_({onTouchMoveCapture:!0})}},touchStart:{phasedRegistrationNames:{bubbled:_({onTouchStart:!0}),captured:_({onTouchStartCapture:!0})}},transitionEnd:{phasedRegistrationNames:{bubbled:_({onTransitionEnd:!0}),captured:_({onTransitionEndCapture:!0})}},volumeChange:{phasedRegistrationNames:{bubbled:_({onVolumeChange:!0}),captured:_({onVolumeChangeCapture:!0})}},waiting:{phasedRegistrationNames:{bubbled:_({onWaiting:!0}),captured:_({onWaitingCapture:!0})}},wheel:{phasedRegistrationNames:{bubbled:_({onWheel:!0}),captured:_({onWheelCapture:!0})}}},x={topAbort:T.abort,topAnimationEnd:T.animationEnd,topAnimationIteration:T.animationIteration,topAnimationStart:T.animationStart,topBlur:T.blur,topCanPlay:T.canPlay,topCanPlayThrough:T.canPlayThrough,topClick:T.click,topContextMenu:T.contextMenu,topCopy:T.copy,topCut:T.cut,topDoubleClick:T.doubleClick,topDrag:T.drag,topDragEnd:T.dragEnd,topDragEnter:T.dragEnter,topDragExit:T.dragExit,topDragLeave:T.dragLeave,topDragOver:T.dragOver,topDragStart:T.dragStart,topDrop:T.drop,topDurationChange:T.durationChange,topEmptied:T.emptied,topEncrypted:T.encrypted,topEnded:T.ended,topError:T.error,topFocus:T.focus,topInput:T.input,topInvalid:T.invalid,topKeyDown:T.keyDown,topKeyPress:T.keyPress,topKeyUp:T.keyUp,topLoad:T.load,topLoadedData:T.loadedData,topLoadedMetadata:T.loadedMetadata,topLoadStart:T.loadStart,topMouseDown:T.mouseDown,topMouseMove:T.mouseMove,topMouseOut:T.mouseOut,topMouseOver:T.mouseOver,topMouseUp:T.mouseUp,topPaste:T.paste,topPause:T.pause,topPlay:T.play,topPlaying:T.playing,topProgress:T.progress,topRateChange:T.rateChange,topReset:T.reset,topScroll:T.scroll,topSeeked:T.seeked,topSeeking:T.seeking,topStalled:T.stalled,topSubmit:T.submit,topSuspend:T.suspend,topTimeUpdate:T.timeUpdate,topTouchCancel:T.touchCancel,topTouchEnd:T.touchEnd,topTouchMove:T.touchMove,topTouchStart:T.touchStart,topTransitionEnd:T.transitionEnd,topVolumeChange:T.volumeChange,topWaiting:T.waiting,topWheel:T.wheel};
for(var N in x)x[N].dependencies=[N];var P=_({onClick:null}),w={},S={eventTypes:T,extractEvents:function(e,t,n,r){var o=x[e];if(!o)return null;var a;switch(e){case E.topAbort:case E.topCanPlay:case E.topCanPlayThrough:case E.topDurationChange:case E.topEmptied:case E.topEncrypted:case E.topEnded:case E.topError:case E.topInput:case E.topInvalid:case E.topLoad:case E.topLoadedData:case E.topLoadedMetadata:case E.topLoadStart:case E.topPause:case E.topPlay:case E.topPlaying:case E.topProgress:case E.topRateChange:case E.topReset:case E.topSeeked:case E.topSeeking:case E.topStalled:case E.topSubmit:case E.topSuspend:case E.topTimeUpdate:case E.topVolumeChange:case E.topWaiting:a=l;break;case E.topKeyPress:if(0===C(n))return null;case E.topKeyDown:case E.topKeyUp:a=p;break;case E.topBlur:case E.topFocus:a=c;break;case E.topClick:if(2===n.button)return null;case E.topContextMenu:case E.topDoubleClick:case E.topMouseDown:case E.topMouseMove:case E.topMouseOut:case E.topMouseOver:case E.topMouseUp:a=d;break;case E.topDrag:case E.topDragEnd:case E.topDragEnter:case E.topDragExit:case E.topDragLeave:case E.topDragOver:case E.topDragStart:case E.topDrop:a=f;break;case E.topTouchCancel:case E.topTouchEnd:case E.topTouchMove:case E.topTouchStart:a=h;break;case E.topAnimationEnd:case E.topAnimationIteration:case E.topAnimationStart:a=s;break;case E.topTransitionEnd:a=v;break;case E.topScroll:a=m;break;case E.topWheel:a=g;break;case E.topCopy:case E.topCut:case E.topPaste:a=u}a?void 0:b(!1);var y=a.getPooled(o,t,n,r);return i.accumulateTwoPhaseDispatches(y),y},didPutListener:function(e,t,n){if(t===P){var r=e._rootNodeID,i=a.getNodeFromInstance(e);w[r]||(w[r]=o.listen(i,"click",y))}},willDeleteListener:function(e,t){if(t===P){var n=e._rootNodeID;w[n].remove(),delete w[n]}}};t.exports=S},{106:106,107:107,109:109,110:110,111:111,113:113,114:114,115:115,116:116,117:117,118:118,130:130,153:153,16:16,160:160,168:168,172:172,20:20,44:44}],106:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(110),i={animationName:null,elapsedTime:null,pseudoElement:null};o.augmentClass(r,i),t.exports=r},{110:110}],107:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(110),i={clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}};o.augmentClass(r,i),t.exports=r},{110:110}],108:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(110),i={data:null};o.augmentClass(r,i),t.exports=r},{110:110}],109:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(114),i={dataTransfer:null};o.augmentClass(r,i),t.exports=r},{114:114}],110:[function(e,t,n){function r(e,t,n,r){this.dispatchConfig=e,this._targetInst=t,this.nativeEvent=n;var o=this.constructor.Interface;for(var i in o)if(o.hasOwnProperty(i)){var s=o[i];s?this[i]=s(n):"target"===i?this.target=r:this[i]=n[i]}var u=null!=n.defaultPrevented?n.defaultPrevented:n.returnValue===!1;return this.isDefaultPrevented=u?a.thatReturnsTrue:a.thatReturnsFalse,this.isPropagationStopped=a.thatReturnsFalse,this}var o=e(179),i=e(26),a=e(160),s=(e(178),["dispatchConfig","_targetInst","nativeEvent","isDefaultPrevented","isPropagationStopped","_dispatchListeners","_dispatchInstances"]),u={type:null,target:null,currentTarget:a.thatReturnsNull,eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:null,isTrusted:null};o(r.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():e.returnValue=!1,this.isDefaultPrevented=a.thatReturnsTrue)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,this.isPropagationStopped=a.thatReturnsTrue)},persist:function(){this.isPersistent=a.thatReturnsTrue},isPersistent:a.thatReturnsFalse,destructor:function(){var e=this.constructor.Interface;for(var t in e)this[t]=null;for(var n=0;n<s.length;n++)this[s[n]]=null}}),r.Interface=u,r.augmentClass=function(e,t){var n=this,r=function(){};r.prototype=n.prototype;var a=new r;o(a,e.prototype),e.prototype=a,e.prototype.constructor=e,e.Interface=o({},n.Interface,t),e.augmentClass=n.augmentClass,i.addPoolingTo(e,i.fourArgumentPooler)},i.addPoolingTo(r,i.fourArgumentPooler),t.exports=r},{160:160,178:178,179:179,26:26}],111:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(117),i={relatedTarget:null};o.augmentClass(r,i),t.exports=r},{117:117}],112:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(110),i={data:null};o.augmentClass(r,i),t.exports=r},{110:110}],113:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(117),i=e(130),a=e(131),s=e(132),u={key:a,location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:s,charCode:function(e){return"keypress"===e.type?i(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?i(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}};o.augmentClass(r,u),t.exports=r},{117:117,130:130,131:131,132:132}],114:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(117),i=e(120),a=e(132),s={screenX:null,screenY:null,clientX:null,clientY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:a,button:function(e){var t=e.button;return"which"in e?t:2===t?2:4===t?1:0},buttons:null,relatedTarget:function(e){return e.relatedTarget||(e.fromElement===e.srcElement?e.toElement:e.fromElement)},pageX:function(e){return"pageX"in e?e.pageX:e.clientX+i.currentScrollLeft},pageY:function(e){return"pageY"in e?e.pageY:e.clientY+i.currentScrollTop}};o.augmentClass(r,s),t.exports=r},{117:117,120:120,132:132}],115:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(117),i=e(132),a={touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:i};o.augmentClass(r,a),t.exports=r},{117:117,132:132}],116:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(110),i={propertyName:null,elapsedTime:null,pseudoElement:null};o.augmentClass(r,i),t.exports=r},{110:110}],117:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(110),i=e(133),a={view:function(e){if(e.view)return e.view;var t=i(e);if(null!=t&&t.window===t)return t;var n=t.ownerDocument;return n?n.defaultView||n.parentWindow:window},detail:function(e){return e.detail||0}};o.augmentClass(r,a),t.exports=r},{110:110,133:133}],118:[function(e,t,n){function r(e,t,n,r){return o.call(this,e,t,n,r)}var o=e(114),i={deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:null,deltaMode:null};o.augmentClass(r,i),t.exports=r},{114:114}],119:[function(e,t,n){var r=e(168),o={reinitializeTransaction:function(){this.transactionWrappers=this.getTransactionWrappers(),this.wrapperInitData?this.wrapperInitData.length=0:this.wrapperInitData=[],this._isInTransaction=!1},_isInTransaction:!1,getTransactionWrappers:null,isInTransaction:function(){return!!this._isInTransaction},perform:function(e,t,n,o,i,a,s,u){this.isInTransaction()?r(!1):void 0;var l,c;try{this._isInTransaction=!0,l=!0,this.initializeAll(0),c=e.call(t,n,o,i,a,s,u),l=!1}finally{try{if(l)try{this.closeAll(0)}catch(p){}else this.closeAll(0)}finally{this._isInTransaction=!1}}return c},initializeAll:function(e){for(var t=this.transactionWrappers,n=e;n<t.length;n++){var r=t[n];try{this.wrapperInitData[n]=i.OBSERVED_ERROR,this.wrapperInitData[n]=r.initialize?r.initialize.call(this):null}finally{if(this.wrapperInitData[n]===i.OBSERVED_ERROR)try{this.initializeAll(n+1)}catch(o){}}}},closeAll:function(e){this.isInTransaction()?void 0:r(!1);for(var t=this.transactionWrappers,n=e;n<t.length;n++){var o,a=t[n],s=this.wrapperInitData[n];try{o=!0,s!==i.OBSERVED_ERROR&&a.close&&a.close.call(this,s),o=!1}finally{if(o)try{this.closeAll(n+1)}catch(u){}}}this.wrapperInitData.length=0}},i={Mixin:o,OBSERVED_ERROR:{}};t.exports=i},{168:168}],120:[function(e,t,n){var r={currentScrollLeft:0,currentScrollTop:0,refreshScrollValues:function(e){r.currentScrollLeft=e.x,r.currentScrollTop=e.y}};t.exports=r},{}],121:[function(e,t,n){function r(e,t){if(null==t?o(!1):void 0,null==e)return t;var n=Array.isArray(e),r=Array.isArray(t);return n&&r?(e.push.apply(e,t),e):n?(e.push(t),e):r?[e].concat(t):[e,t]}var o=e(168);t.exports=r},{168:168}],122:[function(e,t,n){function r(e){for(var t=1,n=0,r=0,i=e.length,a=-4&i;a>r;){for(var s=Math.min(r+4096,a);s>r;r+=4)n+=(t+=e.charCodeAt(r))+(t+=e.charCodeAt(r+1))+(t+=e.charCodeAt(r+2))+(t+=e.charCodeAt(r+3));t%=o,n%=o}for(;i>r;r++)n+=t+=e.charCodeAt(r);return t%=o,n%=o,t|n<<16}var o=65521;t.exports=r},{}],123:[function(e,t,n){var r=!1;t.exports=r},{}],124:[function(e,t,n){var r=function(e){return"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(t,n,r,o){MSApp.execUnsafeLocalFunction(function(){return e(t,n,r,o)})}:e};t.exports=r},{}],125:[function(e,t,n){function r(e,t,n){var r=null==t||"boolean"==typeof t||""===t;if(r)return"";var o=isNaN(t);return o||0===t||i.hasOwnProperty(e)&&i[e]?""+t:("string"==typeof t&&(t=t.trim()),t+"px")}var o=e(3),i=(e(178),o.isUnitlessNumber);t.exports=r},{178:178,3:3}],126:[function(e,t,n){function r(e){return i[e]}function o(e){return(""+e).replace(a,r)}var i={"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#x27;"},a=/[&><"']/g;t.exports=o},{}],127:[function(e,t,n){function r(e){if(null==e)return null;if(1===e.nodeType)return e;var t=i.get(e);return t?(t=a(t),t?o.getNodeFromInstance(t):null):void s(("function"==typeof e.render,!1))}var o=(e(39),e(44)),i=e(74),a=e(135),s=e(168);e(178),t.exports=r},{135:135,168:168,178:178,39:39,44:44,74:74}],128:[function(e,t,n){function r(e,t,n){var r=e,o=void 0===r[n];o&&null!=t&&(r[n]=t)}function o(e){if(null==e)return e;var t={};return i(e,r,t),t}var i=(e(23),e(149));e(178),t.exports=o},{149:149,178:178,23:23}],129:[function(e,t,n){var r=function(e,t,n){Array.isArray(e)?e.forEach(t,n):e&&t.call(n,e)};t.exports=r},{}],130:[function(e,t,n){function r(e){var t,n=e.keyCode;return"charCode"in e?(t=e.charCode,0===t&&13===n&&(t=13)):t=n,t>=32||13===t?t:0}t.exports=r},{}],131:[function(e,t,n){function r(e){if(e.key){var t=i[e.key]||e.key;if("Unidentified"!==t)return t}if("keypress"===e.type){var n=o(e);return 13===n?"Enter":String.fromCharCode(n)}return"keydown"===e.type||"keyup"===e.type?a[e.keyCode]||"Unidentified":""}var o=e(130),i={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},a={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"};t.exports=r},{130:130}],132:[function(e,t,n){function r(e){var t=this,n=t.nativeEvent;if(n.getModifierState)return n.getModifierState(e);var r=i[e];return r?!!n[r]:!1}function o(e){return r}var i={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};t.exports=o},{}],133:[function(e,t,n){function r(e){var t=e.target||e.srcElement||window;return t.correspondingUseElement&&(t=t.correspondingUseElement),3===t.nodeType?t.parentNode:t}t.exports=r},{}],134:[function(e,t,n){function r(e){var t=e&&(o&&e[o]||e[i]);return"function"==typeof t?t:void 0}var o="function"==typeof Symbol&&Symbol.iterator,i="@@iterator";t.exports=r},{}],135:[function(e,t,n){function r(e){for(var t;(t=e._renderedNodeType)===o.COMPOSITE;)e=e._renderedComponent;return t===o.NATIVE?e._renderedComponent:t===o.EMPTY?null:void 0}var o=e(82);t.exports=r},{82:82}],136:[function(e,t,n){function r(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function o(e){for(;e;){if(e.nextSibling)return e.nextSibling;e=e.parentNode}}function i(e,t){for(var n=r(e),i=0,a=0;n;){if(3===n.nodeType){if(a=i+n.textContent.length,t>=i&&a>=t)return{node:n,offset:t-i};i=a}n=r(o(n))}}t.exports=i},{}],137:[function(e,t,n){function r(){return!i&&o.canUseDOM&&(i="textContent"in document.documentElement?"textContent":"innerText"),i}var o=e(154),i=null;t.exports=r},{154:154}],138:[function(e,t,n){function r(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n["ms"+e]="MS"+t,n["O"+e]="o"+t.toLowerCase(),n}function o(e){if(s[e])return s[e];if(!a[e])return e;var t=a[e];for(var n in t)if(t.hasOwnProperty(n)&&n in u)return s[e]=t[n];return""}var i=e(154),a={animationend:r("Animation","AnimationEnd"),animationiteration:r("Animation","AnimationIteration"),animationstart:r("Animation","AnimationStart"),transitionend:r("Transition","TransitionEnd")},s={},u={};i.canUseDOM&&(u=document.createElement("div").style,"AnimationEvent"in window||(delete a.animationend.animation,delete a.animationiteration.animation,delete a.animationstart.animation),"TransitionEvent"in window||delete a.transitionend.transition),t.exports=o},{154:154}],139:[function(e,t,n){function r(e){return"function"==typeof e&&"undefined"!=typeof e.prototype&&"function"==typeof e.prototype.mountComponent&&"function"==typeof e.prototype.receiveComponent}function o(e){var t,n=null===e||e===!1;if(n)t=s.create(o);else if("object"==typeof e){var i=e;!i||"function"!=typeof i.type&&"string"!=typeof i.type?l(!1):void 0,t="string"==typeof i.type?u.createInternalComponent(i):r(i.type)?new i.type(i):new c(i)}else"string"==typeof e||"number"==typeof e?t=u.createInstanceForText(e):l(!1);return t._mountIndex=0,t._mountImage=null,t}var i=e(179),a=e(38),s=e(66),u=e(81),l=(e(75),e(168)),c=(e(178),function(e){this.construct(e)});i(c.prototype,a.Mixin,{_instantiateReactComponent:o}),t.exports=o},{168:168,178:178,179:179,38:38,66:66,75:75,81:81}],140:[function(e,t,n){function r(e,t){if(!i.canUseDOM||t&&!("addEventListener"in document))return!1;var n="on"+e,r=n in document;if(!r){var a=document.createElement("div");a.setAttribute(n,"return;"),r="function"==typeof a[n]}return!r&&o&&"wheel"===e&&(r=document.implementation.hasFeature("Events.wheel","3.0")),r}var o,i=e(154);i.canUseDOM&&(o=document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("","")!==!0),t.exports=r},{154:154}],141:[function(e,t,n){function r(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&o[e.type]||"textarea"===t)}var o={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};t.exports=r},{}],142:[function(e,t,n){function r(e){return o.isValidElement(e)?void 0:i(!1),e}var o=e(64),i=e(168);t.exports=r},{168:168,64:64}],143:[function(e,t,n){function r(e){return'"'+o(e)+'"'}var o=e(126);t.exports=r},{126:126}],144:[function(e,t,n){var r=e(78);t.exports=r.renderSubtreeIntoContainer},{78:78}],145:[function(e,t,n){var r=e(154),o=/^[ \r\n\t\f]/,i=/<(!--|link|noscript|meta|script|style)[ \r\n\t\f\/>]/,a=e(124),s=a(function(e,t){e.innerHTML=t});if(r.canUseDOM){var u=document.createElement("div");u.innerHTML=" ",""===u.innerHTML&&(s=function(e,t){if(e.parentNode&&e.parentNode.replaceChild(e,e),o.test(t)||"<"===t[0]&&i.test(t)){e.innerHTML=String.fromCharCode(65279)+t;var n=e.firstChild;1===n.data.length?e.removeChild(n):n.deleteData(0,1)}else e.innerHTML=t}),u=null}t.exports=s},{124:124,154:154}],146:[function(e,t,n){var r=e(154),o=e(126),i=e(145),a=function(e,t){e.textContent=t};r.canUseDOM&&("textContent"in document.documentElement||(a=function(e,t){i(e,o(t))})),t.exports=a},{126:126,145:145,154:154}],147:[function(e,t,n){function r(e,t,n){return!o(e.props,t)||!o(e.state,n)}var o=e(177);t.exports=r},{177:177}],148:[function(e,t,n){function r(e,t){var n=null===e||e===!1,r=null===t||t===!1;if(n||r)return n===r;var o=typeof e,i=typeof t;return"string"===o||"number"===o?"string"===i||"number"===i:"object"===i&&e.type===t.type&&e.key===t.key}t.exports=r},{}],149:[function(e,t,n){function r(e,t){return e&&"object"==typeof e&&null!=e.key?l.escape(e.key):t.toString(36)}function o(e,t,n,i){var d=typeof e;if("undefined"!==d&&"boolean"!==d||(e=null),null===e||"string"===d||"number"===d||a.isValidElement(e))return n(i,e,""===t?c+r(e,0):t),1;var f,h,v=0,m=""===t?c:t+p;if(Array.isArray(e))for(var g=0;g<e.length;g++)f=e[g],h=m+r(f,g),v+=o(f,h,n,i);else{var y=s(e);if(y){var C,b=y.call(e);if(y!==e.entries)for(var _=0;!(C=b.next()).done;)f=C.value,h=m+r(f,_++),v+=o(f,h,n,i);else for(;!(C=b.next()).done;){var E=C.value;E&&(f=E[1],h=m+l.escape(E[0])+p+r(f,0),v+=o(f,h,n,i))}}else"object"===d&&(String(e),u(!1))}return v}function i(e,t,n){return null==e?0:o(e,"",t,n)}var a=(e(39),e(64)),s=e(134),u=e(168),l=e(23),c=(e(178),"."),p=":";t.exports=i},{134:134,168:168,178:178,23:23,39:39,64:64}],150:[function(e,t,n){function r(e){return Array.isArray(e)?e.concat():e&&"object"==typeof e?a(new e.constructor,e):e}function o(e,t,n){Array.isArray(e)?void 0:u(!1);var r=t[n];Array.isArray(r)?void 0:u(!1)}function i(e,t){if("object"!=typeof t?u(!1):void 0,l.call(t,f))return 1!==Object.keys(t).length?u(!1):void 0,t[f];var n=r(e);if(l.call(t,h)){var s=t[h];s&&"object"==typeof s?void 0:u(!1),n&&"object"==typeof n?void 0:u(!1),a(n,t[h])}l.call(t,c)&&(o(e,t,c),t[c].forEach(function(e){n.push(e)})),l.call(t,p)&&(o(e,t,p),t[p].forEach(function(e){n.unshift(e)})),l.call(t,d)&&(Array.isArray(e)?void 0:u(!1),Array.isArray(t[d])?void 0:u(!1),t[d].forEach(function(e){Array.isArray(e)?void 0:u(!1),n.splice.apply(n,e)})),l.call(t,v)&&("function"!=typeof t[v]?u(!1):void 0,n=t[v](n));for(var m in t)g.hasOwnProperty(m)&&g[m]||(n[m]=i(e[m],t[m]));return n}var a=e(179),s=e(172),u=e(168),l={}.hasOwnProperty,c=s({$push:null}),p=s({$unshift:null}),d=s({$splice:null}),f=s({$set:null}),h=s({$merge:null}),v=s({$apply:null}),m=[c,p,d,f,h,v],g={};m.forEach(function(e){g[e]=!0}),t.exports=i},{168:168,172:172,179:179}],151:[function(e,t,n){var r=(e(179),e(160)),o=(e(178),r);t.exports=o},{160:160,178:178,179:179}],152:[function(e,t,n){function r(e,t){for(var n=e;n.parentNode;)n=n.parentNode;var r=n.querySelectorAll(t);return-1!==Array.prototype.indexOf.call(r,e)}var o=e(168),i={addClass:function(e,t){return/\s/.test(t)?o(!1):void 0,t&&(e.classList?e.classList.add(t):i.hasClass(e,t)||(e.className=e.className+" "+t)),e},removeClass:function(e,t){return/\s/.test(t)?o(!1):void 0,t&&(e.classList?e.classList.remove(t):i.hasClass(e,t)&&(e.className=e.className.replace(new RegExp("(^|\\s)"+t+"(?:\\s|$)","g"),"$1").replace(/\s+/g," ").replace(/^\s*|\s*$/g,""))),e},conditionClass:function(e,t,n){return(n?i.addClass:i.removeClass)(e,t)},hasClass:function(e,t){return/\s/.test(t)?o(!1):void 0,e.classList?!!t&&e.classList.contains(t):(" "+e.className+" ").indexOf(" "+t+" ")>-1},matchesSelector:function(e,t){var n=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||function(t){return r(e,t)};return n.call(e,t)}};t.exports=i},{168:168}],153:[function(e,t,n){var r=e(160),o={listen:function(e,t,n){return e.addEventListener?(e.addEventListener(t,n,!1),{remove:function(){e.removeEventListener(t,n,!1)}}):e.attachEvent?(e.attachEvent("on"+t,n),{remove:function(){e.detachEvent("on"+t,n)}}):void 0},capture:function(e,t,n){return e.addEventListener?(e.addEventListener(t,n,!0),{remove:function(){e.removeEventListener(t,n,!0)}}):{remove:r}},registerDefault:function(){}};t.exports=o},{160:160}],154:[function(e,t,n){var r=!("undefined"==typeof window||!window.document||!window.document.createElement),o={canUseDOM:r,canUseWorkers:"undefined"!=typeof Worker,canUseEventListeners:r&&!(!window.addEventListener&&!window.attachEvent),canUseViewport:r&&!!window.screen,isInWorker:!r};t.exports=o},{}],155:[function(e,t,n){function r(e){return e.replace(o,function(e,t){return t.toUpperCase()})}var o=/-(.)/g;t.exports=r},{}],156:[function(e,t,n){function r(e){return o(e.replace(i,"ms-"))}var o=e(155),i=/^-ms-/;t.exports=r},{155:155}],157:[function(e,t,n){function r(e,t){return e&&t?e===t?!0:o(e)?!1:o(t)?r(e,t.parentNode):e.contains?e.contains(t):e.compareDocumentPosition?!!(16&e.compareDocumentPosition(t)):!1:!1}var o=e(170);t.exports=r},{170:170}],158:[function(e,t,n){function r(e){var t=e.length;if(Array.isArray(e)||"object"!=typeof e&&"function"!=typeof e?a(!1):void 0,"number"!=typeof t?a(!1):void 0,0===t||t-1 in e?void 0:a(!1),"function"==typeof e.callee?a(!1):void 0,e.hasOwnProperty)try{return Array.prototype.slice.call(e)}catch(n){}for(var r=Array(t),o=0;t>o;o++)r[o]=e[o];return r}function o(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"length"in e&&!("setInterval"in e)&&"number"!=typeof e.nodeType&&(Array.isArray(e)||"callee"in e||"item"in e)}function i(e){return o(e)?Array.isArray(e)?e.slice():r(e):[e]}var a=e(168);t.exports=i},{168:168}],159:[function(e,t,n){function r(e){var t=e.match(c);return t&&t[1].toLowerCase()}function o(e,t){var n=l;l?void 0:u(!1);var o=r(e),i=o&&s(o);if(i){n.innerHTML=i[1]+e+i[2];for(var c=i[0];c--;)n=n.lastChild}else n.innerHTML=e;var p=n.getElementsByTagName("script");p.length&&(t?void 0:u(!1),a(p).forEach(t));for(var d=Array.from(n.childNodes);n.lastChild;)n.removeChild(n.lastChild);return d}var i=e(154),a=e(158),s=e(164),u=e(168),l=i.canUseDOM?document.createElement("div"):null,c=/^\s*<(\w+)/;t.exports=o},{154:154,158:158,164:164,168:168}],160:[function(e,t,n){function r(e){return function(){return e}}function o(){}o.thatReturns=r,o.thatReturnsFalse=r(!1),o.thatReturnsTrue=r(!0),o.thatReturnsNull=r(null),o.thatReturnsThis=function(){return this},o.thatReturnsArgument=function(e){return e},t.exports=o},{}],161:[function(e,t,n){var r={};t.exports=r},{}],162:[function(e,t,n){function r(e){try{e.focus()}catch(t){}}t.exports=r},{}],163:[function(e,t,n){function r(){if("undefined"==typeof document)return null;try{return document.activeElement||document.body}catch(e){return document.body}}t.exports=r},{}],164:[function(e,t,n){function r(e){return a?void 0:i(!1),d.hasOwnProperty(e)||(e="*"),s.hasOwnProperty(e)||(a.innerHTML="*"===e?"<link />":"<"+e+"></"+e+">",s[e]=!a.firstChild),s[e]?d[e]:null}var o=e(154),i=e(168),a=o.canUseDOM?document.createElement("div"):null,s={},u=[1,'<select multiple="true">',"</select>"],l=[1,"<table>","</table>"],c=[3,"<table><tbody><tr>","</tr></tbody></table>"],p=[1,'<svg xmlns="http://www.w3.org/2000/svg">',"</svg>"],d={"*":[1,"?<div>","</div>"],area:[1,"<map>","</map>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],legend:[1,"<fieldset>","</fieldset>"],param:[1,"<object>","</object>"],tr:[2,"<table><tbody>","</tbody></table>"],optgroup:u,option:u,caption:l,colgroup:l,tbody:l,tfoot:l,thead:l,td:c,th:c},f=["circle","clipPath","defs","ellipse","g","image","line","linearGradient","mask","path","pattern","polygon","polyline","radialGradient","rect","stop","text","tspan"];f.forEach(function(e){d[e]=p,s[e]=!0}),t.exports=r},{154:154,168:168}],165:[function(e,t,n){function r(e){return e===window?{x:window.pageXOffset||document.documentElement.scrollLeft,y:window.pageYOffset||document.documentElement.scrollTop}:{x:e.scrollLeft,y:e.scrollTop}}t.exports=r},{}],166:[function(e,t,n){function r(e){return e.replace(o,"-$1").toLowerCase()}var o=/([A-Z])/g;t.exports=r},{}],167:[function(e,t,n){function r(e){return o(e).replace(i,"-ms-")}var o=e(166),i=/^ms-/;t.exports=r},{166:166}],168:[function(e,t,n){function r(e,t,n,r,o,i,a,s){if(!e){var u;if(void 0===t)u=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var l=[n,r,o,i,a,s],c=0;u=new Error(t.replace(/%s/g,function(){return l[c++]})),u.name="Invariant Violation"}throw u.framesToPop=1,u}}t.exports=r},{}],169:[function(e,t,n){function r(e){return!(!e||!("function"==typeof Node?e instanceof Node:"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName))}t.exports=r},{}],170:[function(e,t,n){function r(e){return o(e)&&3==e.nodeType}var o=e(169);t.exports=r},{169:169}],171:[function(e,t,n){var r=e(168),o=function(e){var t,n={};e instanceof Object&&!Array.isArray(e)?void 0:r(!1);for(t in e)e.hasOwnProperty(t)&&(n[t]=t);return n};t.exports=o},{168:168}],172:[function(e,t,n){var r=function(e){var t;for(t in e)if(e.hasOwnProperty(t))return t;return null};t.exports=r},{}],173:[function(e,t,n){function r(e,t,n){if(!e)return null;var r={};for(var i in e)o.call(e,i)&&(r[i]=t.call(n,e[i],i,e));return r}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],174:[function(e,t,n){function r(e){var t={};return function(n){return t.hasOwnProperty(n)||(t[n]=e.call(this,n)),t[n]}}t.exports=r},{}],175:[function(e,t,n){var r,o=e(154);o.canUseDOM&&(r=window.performance||window.msPerformance||window.webkitPerformance),t.exports=r||{}},{154:154}],176:[function(e,t,n){var r,o=e(175);r=o.now?function(){return o.now()}:function(){return Date.now()},t.exports=r},{175:175}],177:[function(e,t,n){function r(e,t){return e===t?0!==e||1/e===1/t:e!==e&&t!==t}function o(e,t){if(r(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),o=Object.keys(t);if(n.length!==o.length)return!1;for(var a=0;a<n.length;a++)if(!i.call(t,n[a])||!r(e[n[a]],t[n[a]]))return!1;return!0}var i=Object.prototype.hasOwnProperty;t.exports=o},{}],178:[function(e,t,n){var r=e(160),o=r;t.exports=o},{160:160}],179:[function(e,t,n){function r(e){if(null===e||void 0===e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}function o(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;10>n;n++)t["_"+String.fromCharCode(n)]=n;var r=Object.getOwnPropertyNames(t).map(function(e){return t[e]});if("0123456789"!==r.join(""))return!1;var o={};return"abcdefghijklmnopqrst".split("").forEach(function(e){o[e]=e}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},o)).join("")}catch(i){return!1}}var i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;t.exports=o()?Object.assign:function(e,t){for(var n,o,s=r(e),u=1;u<arguments.length;u++){n=Object(arguments[u]);for(var l in n)i.call(n,l)&&(s[l]=n[l]);if(Object.getOwnPropertySymbols){o=Object.getOwnPropertySymbols(n);for(var c=0;c<o.length;c++)a.call(n,o[c])&&(s[o[c]]=n[o[c]])}}return s}},{}]},{},[102])(102)}),!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e(require("react"));else if("function"==typeof define&&define.amd)define("react-dom",["react"],e);else{var f;f="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,f.ReactDOM=e(f.React)}}(function(e){return e.__SECRET_DOM_DO_NOT_USE_OR_YOU_WILL_BE_FIRED}),define("DragDrop",["globals","Constants","platform","tracker","data","Observable","ObservableArray","Sel","NativeSel","Dispatcher"],function(g,C,platform,tracker,d,Observable,ObservableArray,Sel,NativeSel,Dispatcher){function DragDrop(){this.activePane=void 0,this.startPane=void 0,this.previousEventTarget=void 0,this.previousDropTarget=void 0,this.previousHighlightElement=void 0,this.previousAbove=void 0,this.dataTransfer=void 0,this.startInfo=void 0,this.startDragItem=void 0,this.isDragging=!1,this.dragItem=void 0,this.draggingItems=[],this.position=void 0,this.isVisible=new Observable(!1),this.transform=new Observable({left:0,top:0}),this.linePosition=new Observable,this.isDraggingPane=new Observable(!1),window.addEventListener("dragover",this.handleDragOver.bind(this)),window.addEventListener("dragleave",this.handleDragLeave.bind(this)),window.addEventListener("drop",this.handleDrop.bind(this))}var copypaste;return require(["copypaste"],function(copypasteLoad){copypaste=copypasteLoad}),DragDrop.prototype={stop:function stopFn(){this.activePane?this.activePane.notifyDragEnd():g.vmMain.paneManager.runForEachPane(function(pane){pane.notifyDragEnd()});for(var items=this.draggingItems,i=0;i<items.length;++i)items[i].draggedInPane.set(!1);this.draggingItems=[],this.isDragging=!1,this.dragItem=void 0},finish:function finishFn(){this.isVisible.set(!1),this.agendaInfo=void 0},start:function startFn(items,left,top,pane,startInfo,dataTransfer){this.isDragging&&(this.stop(),this.finish()),Sel.reset(),g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),this.isDragging=!0,this.activePane=pane,this.dragInfo=null,this.startPane=pane,this.startInfo=startInfo,this.dataTransfer=dataTransfer,this.draggingItems=items,this.position={left:left,top:top},this.transform.set({left:0,top:0},!1);for(var i=0;i<items.length;++i)items[i].draggedInPane.set(g.focusedPane);this.isVisible.set(!0),this.activePane.notifyDragStart(),Dispatcher.fireEvent("startDrag",[items])},startExternal:function startExternalFn(pane){this.isDragging=!0,this.activePane=pane,this.startPane=pane,this.draggingItems=[],this.isVisible.set(!0),this.activePane.notifyDragStart()},setTransform:function setTransformFn(left,top){this.isVisible.set(!0,!1),this.transform.set({left:left,top:top})},handleDragOver:function handleDragOverFn(e){var eventTarget=g.elementFromPoint(e.clientX,e.clientY,e.srcElement),pane=g.getPaneForElement(eventTarget),handled=!1,linePosition=null;if(this.activePane&&pane!==this.activePane&&this.revertDrag(),pane){this.isDragging||this.startExternal(pane),this.activePane=pane;var isOverview=!!g.findParent(eventTarget,"paneOverviewScroller");pane.canAcceptDragOver(e.dataTransfer.pane,e.item,eventTarget,isOverview)?this.dragInfo=pane.handleDragOver(e.dataTransfer.pane,e.item,eventTarget,e.clientX,e.clientY):this.revertDrag()}return this.linePosition.set(this.dragInfo&&this.dragInfo.linePosition),this.dragInfo&&this.dragInfo.targetElement||g.cancelRepeatScroll(),!1},revertDrag:function revertDragFn(){this.dragInfo=null,this.activePane.revertDrag()},handleDropItem:function handleDropItemFn(movingItem,e,isNew){var item=movingItem,pane=this.activePane;if(this.isDropping=!0,g.cancelRepeatScroll(),this.dragInfo&&pane)g.vmMain.beginUpdateItems(),pane.handleDragDrop(movingItem,e,this.dragInfo,isNew),g.vmMain.commitUpdateItems();else if(g.isNonPaneDropTarget(e.target)){var pane=e.dataTransfer.pane,insertData;if(pane){insertData=pane.notifyDropFromToEdit(movingItem,e.target);try{g.PAssert(3516,!insertData||g.isDOMNode(insertData),"Must always return DOM elements to insert")}catch(PERR){g.reportError(PERR)}}if(insertData){var range=NativeSel._getCursorSelectionRange(e.clientX,e.clientY);NativeSel.setSelectionRange(range),NativeSel.insertNode(insertData)}}return this.isDropping=!1,item},handleDrop:function handleDropFn(e){if(this.activePane&&g.elementInPane(e.target)){var dropItem=e.dataTransfer.item;if(dropItem)this.handleDropItem(dropItem,e);else{var pluginHandled=g.vmMain.pluginManager.handleDropEvent(e,function(res,isNew){tracker.beginAction();var item=d.createVMLI({text:res},{changeType:ChangeType.AllLocal});return item=this.handleDropItem(item,e,isNew),tracker.endAction(),item}.bind(this));if(!pluginHandled&&(e.dataTransfer.getData(platform.ie?"Text":"text/plain")||e.dataTransfer.getData("text/html"))){var range=NativeSel.getCursorSelectionRange(e);try{g.PAssert(3517,range,"Range should always be properly set")}catch(PERR){g.reportError(PERR)}Sel.setSelectionFromNativeRange(range),copypaste.insert(e.dataTransfer,e,DataSource.Drop)}}}else g.isNonPaneDropTarget(e.target)&&e.dataTransfer.item&&this.handleDropItem(e.dataTransfer.item,e);this.isDragging=!1,this.isVisible.set(!1),g.vmMain.resetItemAnimationMode(),e.stopPropagation(),e.preventDefault()},handleDragLeave:function handleDragLeaveFn(e){e.clientX||e.clientY||(this.isDragging=!1,this.isVisible.set(!1))
},setAgendaInfo:function setAgendaInfoFn(info){this.agendaInfo=info}},new DragDrop}),define("android",["util","globals","platform","NativeSel","Sel","DragDrop","Constants"],function(util,g,platform,NativeSel,Sel,DragDrop,C){function android(){this._activePane=void 0,this._inputContainer=void 0,this._inputBox=void 0,this._currentVMLI=void 0,this._currentIndex=void 0,this._canSetInput=void 0,this._pasteHappened=!1,this._forceFirstCaps=!0,this._isStarred=!1,this._linePadding=2,this._padCharacter="​",this._activeKeyboard=void 0,this._customKeyboard=void 0,this._wasHeader=!1,this._isInputVisible=!1,this._lastHeight=0,this._enabled=!1}var edit,tracker,copypaste,AndroidFns={getDebugInfo:function getDebugInfoFn(){var obj={};return obj.activeKeyboard=this.getActiveKeyboard(),obj.isVisible=this.isVisible(),obj.currentVMLI=this.getCurrentVMLI()?this.getCurrentVMLI().id:void 0,obj.selection=this.getCurrentVMLI()?this.getSelectionOffsets():void 0,obj.pasteHappened=this._pasteHappened,obj},isEnabled:function isEnabledFn(){return this._enabled},getCurrentVMLI:function getCurrentVMLIFn(){return this._currentVMLI},getCurrentIndex:function getCurrentIndexFn(){return this._currentIndex},setCurrentVMLI:function setCurrentVMLIFn(vmli,index){try{g.PAssert(3518,vmli,"Must supply a valid VMLI to android editing")}catch(PERR){g.reportError(PERR)}this._currentVMLI=vmli,this._currentIndex=index},clearCurrentVMLI:function clearCurrentVMLIFn(){this._currentVMLI=void 0,this._currentIndex=void 0},isCurrentVMLI:function isCurrentVMLIFn(vmli){return this._currentVMLI===vmli},isVisible:function isVisibleFn(){return this._isInputVisible},getCurrentElement:function getCurrentElementFn(){var elem;if(this._currentVMLI){var itemIndex=this._activePane.indexOfItem(this._currentVMLI);elem=this._activePane.elementAtIndex(itemIndex);try{g.PAssert(3519,elem,"Must be able to get a valid element for the current VMLI to update input bounds")}catch(PERR){g.reportError(PERR)}}return elem},isTargetBox:function isTargetBoxFn(e){return g.isAncestor(e.target||e.srcElement,this.getInputContainer())},getInputContainer:function getInputContainerFn(){return this._inputContainer},getInputBox:function getInputBoxFn(){return this._inputBox},getRawInputText:function getRawInputTextFn(){return this.getInputBox().value},setRawInputText:function setRawInputTextFn(text){this.getInputBox().value=text},getRawSelectionStart:function getRawSelectionStartFn(){return this.getInputBox().selectionStart},getRawSelectionEnd:function getRawSelectionEndFn(){return this.getInputBox().selectionEnd},getSelectionStart:function getSelectionStartFn(){return this.getRawSelectionStart()<this._linePadding?0:this.getRawSelectionStart()-this._linePadding},getSelectionEnd:function getSelectionEndFn(){return this.getRawSelectionEnd()<this._linePadding?0:this.getRawSelectionEnd()-this._linePadding},getSelectionOffsets:function getSelectionOffsetsFn(){return{start:this.getSelectionStart(),end:this.getSelectionEnd(),total:this.getInputText().length}},setSelection:function setSelectionFn(start,end){this.setRawSelection(start+this._linePadding,end+this._linePadding)},setRawSelection:function setRawSelectionFn(start,end){this.setRawSelectionStart(start),this.setRawSelectionEnd(end)},setRawSelectionStart:function setRawSelectionStartFn(start){this.getInputBox().selectionStart=start},setRawSelectionEnd:function setRawSelectionEndFn(end){this.getInputBox().selectionEnd=end},canSetInput:function canSetInputFn(){return void 0===this._canSetInput&&(this._canSetInput=null!==this.getInputBox().selectionStart&&void 0!==this.getInputBox().selectionStart&&null!==this.getInputBox().selectionEnd&&void 0!==this.getInputBox().selectionEnd),this._canSetInput},getActiveKeyboard:function getActiveKeyboardFn(){return this._activeKeyboard},notifyCustomKeyboard:function notifyCustomKeyboardFn(keyboard){keyboard.startsWith("com.google.android")||(this._customKeyboard=keyboard),this._activeKeyboard=keyboard},setPaneRoot:function setPaneRootFn(pane){try{g.PAssert(3520,pane,"Must supply a valid pane")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3521,pane.rootElement,"Pane must have a valid root element")}catch(PERR){g.reportError(PERR)}if(void 0===pane.rootElement){try{g.PAssert(3522,!platform.android,"Android should always have editing enabled")}catch(PERR){g.reportError(PERR)}return void(this._enabled=!1)}this._enabled=!0,this._activePane!==pane&&(this._activePane=pane,platform.mobileie&&this._activePane.paneContent.removeAttribute("contenteditable"),this._inputBox=document.createElement("textarea"),this._inputBox.id="androidInput",this._inputBox.style.visibility="hidden",this._inputContainer=this._inputBox,this._activePane.rootElement.appendChild(this._inputBox),this._inputBox.addEventListener("focus",function(e){DragDrop.isDragging||g.isKeyboardOpen||g.keyboardToolbar.show(C.KeyboardToolbarMode.Item)}),platform.mobileie||this._inputBox.addEventListener("blur",function(e){!this._isInputVisible||e.relatedTarget&&!g.hasClass(e.relatedTarget,"search")||(this.finishInput(),g.keyboardToolbar.hide())}.bind(this)),this._inputBox.addEventListener("input",function(e){if(this._currentVMLI){if(edit=edit||require("edit"),this.updateSel(),this._pasteHappened)if(this._pasteHappened=!1,copypaste=copypaste||require("copypaste"),document.createEvent){var eventObj=document.createEvent("Event");eventObj.synthetic=!0,eventObj.data={types:["text/plain"],getData:function getDataFn(){return this.getBoxValue()}.bind(this)},eventObj.initEvent("paste",!0,!0),Sel.selectItem(this._currentVMLI,0,this.getBoxValue().length),this._inputBox.dispatchEvent(eventObj)}else try{g.PAssert(3524,!1,"Unable to fire key event")}catch(PERR){g.reportError(PERR)}else{var isBackspace=!this.getBoxHasTextSpace();if(isBackspace){tracker=tracker||require("tracker");try{g.PAssert(3525,edit&&tracker,"Should always be defined")}catch(PERR){g.reportError(PERR)}tracker.beginAction(),edit.handleBackspace(e),tracker.endAction()}else this.handleChacterTyped(e)}this.ensureLinePadding(),edit.updateAutocomplete(e),this.checkAndroidBounds()}}.bind(this)),log("---- Android Editing Enabled ----"))},notifyStarred:function notifyStarredFn(newValue){this._isStarred!==newValue&&(this._isStarred=newValue,this._isStarred?g.addClass(this._inputBox,"pStar"):g.removeClass(this._inputBox,"pStar"))},_forceCapsHelper:function _forceCapsHelperFn(){var text=this.getBoxValue(),newText;1===text.length?newText=text.toUpperCase():text.length>1&&(newText=text[0].toUpperCase()+text.substring(1)),this.setBoxValue(newText)},handleChacterTyped:function handleChacterTypedFn(){if(!this._customKeyboard){var sOffset=this.getSelectionStart(),eOffset=this.getSelectionEnd();sOffset===eOffset?1===sOffset?this._forceFirstCaps&&this._forceCapsHelper():0===sOffset&&(this._forceFirstCaps=!1):0===sOffset&&eOffset>0&&this._forceFirstCaps&&this._forceCapsHelper()}this._activePane.scrollItemIntoView(this.getCurrentVMLI(),ScrollDuration.Default)},updateInput:function updateInputFn(index){try{g.PAssert(3526,this.isEnabled(),"Must be enabled to update input")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3527,index>=0,"Must supply a valid index to select")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3528,Sel.isValid(),"Must have a valid selection to update android input")}catch(PERR){g.reportError(PERR)}var openingInput=!1;this._isInputVisible||(this._isInputVisible=!0,openingInput=!0,this.getInputContainer().style.visibility="visible",(null===this.getInputContainer().parentElement||void 0===this.getInputContainer().parentElement)&&this._activePane.rootElement.appendChild(this.getInputContainer())),g.isKeyboardOpen||g.keyboardToolbar.show(C.KeyboardToolbarMode.Item);var vmli=g.focusedPane.itemAtIndex(index);try{g.PAssert(3529,vmli,"Must have a valid item to update android input")}catch(PERR){g.reportError(PERR)}var itemChanged=vmli!==this.getCurrentVMLI()||index!==this.getCurrentIndex();if((itemChanged||vmli&&vmli.isHeader()!==this._wasHeader)&&(this._currentVMLI&&itemChanged&&this.finishInput(!0),this.setCurrentVMLI(vmli,index),this._wasHeader=vmli.isHeader(),this.notifyStarred(vmli.isStarred()),this.updateInputText(vmli),this.updateInputBounds(vmli)),openingInput&&this.getInputBox().focus(),this.canSetInput())try{var targetStart=Sel.getStartOffset(),targetEnd=Sel.getEndOffset();this.setRawSelection(targetStart,targetEnd),this.setSelection(targetStart,targetEnd)}catch(err){g.reportError(err)}},updateInputText:function updateInputTextFn(vmli){if(vmli&&this._currentVMLI&&vmli===this._currentVMLI){var displayText=this._currentVMLI.getParsedText();this._forceFirstCaps=0===displayText.length,this.setBoxValue(displayText)}else try{g.PAssert(3530,!1,"Updating input text with an invalid VMLI")}catch(PERR){g.reportError(PERR)}},insertText:function insertTextFn(offset,text){var val=this.getBoxValue(),newText=val.substr(0,offset)+text+val.substr(offset);this.setBoxValue(newText),this.canSetInput()&&(this.setSelection(offset+text.length,offset+text.length),this.updateSel(),g.autocomplete&&g.autocomplete.update({owner:this._currentVMLI,index:this._activePane.indexOfItem(this._currentVMLI),start:this.getSelectionStart(),fromArrows:!1}))},getInputText:function getInputTextFn(){try{g.PAssert(3531,this.isEnabled(),"Must be enabled to get input")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3532,this._currentVMLI,"Android input must be active to get input text")}catch(PERR){g.reportError(PERR)}return this._currentVMLI?this.getBoxValue():""},updateSel:function updateSelFn(){Sel.setSelectionFromAndroid(this.getSelectionEnd(),this.getSelectionEnd())},updateInputBounds:function updateInputBoundsFn(vmli){try{g.PAssert(3533,this._activePane,"Must have previously set an active pane for android editing")}catch(PERR){g.reportError(PERR)}if(vmli&&this._currentVMLI&&vmli===this._currentVMLI){var itemIndex=this._activePane.indexOfItem(this._currentVMLI);try{g.PAssert(3535,itemIndex>=0,"Must have a valid item index")}catch(PERR){g.reportError(PERR)}var container=this.getInputContainer(),lineHeight=18,leftOffset=8,paddingTop=7,paddingBottom=7,paddingLeft=this._activePane.getPaddingForItem(this._currentVMLI)-leftOffset,paddingRight=g.SPThresholdRight+leftOffset,itemHeight=this._activePane.heightAtIndex(itemIndex);container.style.top=this._activePane.topOfIndex(itemIndex)+"px",container.style.height=itemHeight-paddingTop-paddingBottom+"px",container.style.lineHeight=lineHeight+"px",container.style.marginLeft=leftOffset+"px",container.style.paddingLeft=paddingLeft+"px",container.style.paddingTop=paddingTop+"px",container.style.paddingBottom=paddingBottom+"px",container.style.paddingRight=paddingRight+"px",container.style.width=this._activePane.getWidth()-paddingLeft-g.SPThresholdRight-leftOffset+"px"}else try{g.PAssert(3534,!1,"Invalid VMLI being used to update android input bounds")}catch(PERR){g.reportError(PERR)}},checkAndroidBounds:function checkAndroidBoundsFn(){try{g.PAssert(3536,this.getCurrentVMLI(),"When updating Android bounds we should always have a current VMLI")}catch(PERR){g.reportError(PERR)}var boxHeight=this.getInputContainer().scrollHeight;if(boxHeight!==this._lastHeight){var resultText=this.getBoxValue();this._enabled=!1,this.getCurrentVMLI()&&(this.getCurrentVMLI().getParsedText()!==resultText&&this.getCurrentVMLI().setText(resultText,!0,ChangeType.Local,!0),this.updateInputBounds(this.getCurrentVMLI())),this._enabled=!0,this._lastHeight=boxHeight}},flushInput:function flushInputFn(){var resultText=this.getBoxValue();this._currentVMLI&&this._currentVMLI.getParsedText()!==resultText&&(this._forceFirstCaps&&(1===resultText.length?resultText=resultText.toUpperCase():resultText.length>1&&(resultText=resultText[0].toUpperCase()+resultText.substring(1))),this._currentVMLI.setText(resultText,!0,ChangeType.Local,!0))},finishInput:function finishInputFn(continueEditing){try{g.PAssert(3537,this.isEnabled(),"Must be enabled to finish input")}catch(PERR){g.reportError(PERR)}this._currentVMLI&&(this._isInputVisible&&!continueEditing&&(this._isInputVisible=!1,this.getInputContainer().style.visibility="hidden",g.blurActiveElement()),this.flushInput(),continueEditing||this.clearCurrentVMLI())},hideInput:function hideInputFn(){this._isInputVisible&&(this._isInputVisible=!1,this.getInputContainer().style.visibility="hidden")},handlePaste:function handlePasteFn(){this._pasteHappened=!0},_fixLinePadding:function _fixLinePaddingFn(rawText){this.setBoxValue(rawText)},ensureLinePadding:function ensureLinePaddingFn(){var rawText=this.getInputBox().value;if(rawText.length<this._linePadding)return this._fixLinePadding(rawText),!1;for(var i=0;i<this._linePadding;++i)if(rawText[i]!==this._padCharacter)return this._fixLinePadding(rawText),!1;return!0},getBoxHasTextSpace:function getBoxHasTextSpaceFn(){var rawText=this.getRawInputText();if(rawText.length<this._linePadding)return!1;for(var sCount=0,i=0;i<rawText.length&&sCount<this._linePadding;++i)rawText[i]===this._padCharacter&&sCount++;return sCount===this._linePadding},_removeTextSpace:function _removeTextSpaceFn(text){var re=new RegExp(this._padCharacter,"g");return text.replace(re,"")},getBoxValue:function getBoxValueFn(){var rawText=this.getRawInputText(),outText=this._removeTextSpace(rawText);return outText},setBoxValue:function setBoxValueFn(text){text||(text="");for(var newText="",i=0;i<this._linePadding;++i)newText+=this._padCharacter;newText+=this._removeTextSpace(text),this.setRawInputText(newText)},passKeypress:function passKeypressFn(e){return this._currentVMLI&&(e.normCode===KeyCode.Enter||e.synthetic)?!0:!1},passKeydown:function passKeydownFn(e){return this._currentVMLI&&(e.normCode===KeyCode.Tab||e.synthetic)?!0:!1}};return util.extend(android.prototype,AndroidFns),new android}),define("MobileUI",["require","globals","Constants","platform","Observable","Sel","Multiselect"],function(require){function MobileUI(){this.swipeMode=SwipeMode.None,this.swipeX=0,this.swipePoints=[],this.multiselectAnimate=!1,this.multiselectOffset=new Observable(0),this.topBarMode=new Observable(C.TopBarMode.Normal),this._isDisabled=platform.mobile?!1:!0}var g=require("globals"),C=require("Constants"),platform=require("platform"),Observable=require("Observable"),Sel=require("Sel"),Multiselect=require("Multiselect"),TimeThresh=300,VelThresh=200,SwipeMode={None:0,Item:1,Multiselect:2,Overview:3};return MobileUI.prototype={isSwiping:function isSwipingFn(){return this._isSwiping},disable:function disableFn(){this._isDisabled=!0},enable:function enableFn(){try{g.PAssert(3538,platform.mobile,"Should never enable MobileUI on desktop")}catch(PERR){g.reportError(PERR)}this._isDisabled=!1},isDisabled:function isDisabledFn(){return this._isDisabled},start:function startFn(e){return platform.mobile&&this.enable(),g.focusedPane.isOverviewVisible()&&e.clientX>this.overviewWidth()?!0:void 0},update:function updateFn(e){if(!this.isDisabled()){var item=g.dataFor(e.startSrc,!0);this.swipeMode===SwipeMode.None&&Math.abs(e.distanceY)<g.ClickThreshold&&Math.abs(e.diffX)>g.ClickThreshold&&(this.isInMultiselect()?this.swipeMode=SwipeMode.Multiselect:g.focusedPane.isOverviewVisible()?this.swipeMode=SwipeMode.Overview:item&&g.isVMLI(item)&&!item.isNote()&&(this.swipeMode=SwipeMode.Item));var x=e.diffX;if(this.swipePoints.splice(0,0,{time:Date.now(),x:e.xThisFrame}),this.swipePoints.length>20&&this.swipePoints.splice(this.swipePoints.length-1,1),this.swipeMode===SwipeMode.Multiselect)x=g.clamp(-C.RightMenuWidth+x,-C.RightMenuWidth,0),this.updateMultiselectPosition(x);else if(this.swipeMode===SwipeMode.Overview)x=g.clamp(this.overviewWidth()+x,0,this.overviewWidth()),g.focusedPane.updatePosition(x,!1);else if(this.swipeMode===SwipeMode.Item&&item){var cell=g.getCellForElement(e.target);try{g.PAssert(3539,cell,"Expected cell for swipe")}catch(PERR){g.reportError(PERR)}cell&&(x=g.clamp(x,-platform.windowWidth(),platform.windowWidth()),cell.isAnimatingOffsetX=!1,cell.offsetX.set(x))}this.lastX=e.diffX}return this.swipeMode!==SwipeMode.None},onClick:function onClickFn(e){var pane=g.focusedPane;return!this.isDisabled()&&pane.isOverviewVisible()&&e.clientX>this.overviewWidth()?(g.closeKeyboard(),this.setOverviewVisibility(!1),!0):!1},end:function endFn(e){var pane=g.focusedPane,ret=this.swipeMode!==SwipeMode.None;if(!this.isDisabled())if(this.swipeMode===SwipeMode.Item){var targetItem=g.dataFor(e.startSrc,!0);if(targetItem&&g.isVMLI(targetItem)){var cell=g.getCellForElement(e.target),item=g.getItemForElement(e.target);try{g.PAssert(3540,cell&&item,"Expected cell and item for swipe")}catch(PERR){g.reportError(PERR)}if(cell){var menu=pane.getSwipeMenuItem(item,cell.offsetX.get());cell.isAnimatingOffsetX=!0,cell.offsetX.set(0),menu.fn&&menu.fn(item)}}}else if(this.swipeMode===SwipeMode.Multiselect||this.swipeMode===SwipeMode.Overview){for(var now=Date.now(),sum=0,totalTime=0,snapDir,isOpen,i=0;i<this.swipePoints.length;i++){var p=this.swipePoints[i];if(!(now-p.time<TimeThresh))break;sum+=p.x,totalTime=now-p.time}var v=sum?sum/(totalTime/1e3):0;-VelThresh>v?snapDir=0:v>VelThresh?snapDir=1:this.swipeMode===SwipeMode.Overview?snapDir=Math.round((this.overviewWidth()+this.lastX)/platform.windowWidth()):this.swipeMode===SwipeMode.Multiselect&&(snapDir=Math.round(this.lastX/C.RightMenuWidth)),this.swipeMode===SwipeMode.Overview?(isOpen=snapDir>0,this.setOverviewVisibility(isOpen),isOpen&&g.closeKeyboard()):this.swipeMode===SwipeMode.Multiselect&&(isOpen=0===snapDir,this.setMultiselectVisibility(isOpen))}return this.swipeMode=SwipeMode.None,this.swipePoints.length=0,ret},setOverviewVisibility:function setOverviewVisibilityFn(isOpen){var pane=g.focusedPane;pane.updatePosition(isOpen?this.overviewWidth():0,!0),pane.overview.setVisibility(isOpen)},toggleOverviewVisibility:function toggleOverviewVisibilityFn(){var value=!g.focusedPane.isOverviewVisible();this.setOverviewVisibility(value)},overviewWidth:function overviewWidthFn(){return g.focusedPane.overviewWidth()},isInMultiselect:function isInMultiselectFn(){return 0!==this.multiselectOffset.get()},updateMultiselectPosition:function updateMultiselectPositionFn(x,animate){this.multiselectAnimate=animate,this.multiselectOffset.set(x),this.topBarMode.set(0!==x?C.TopBarMode.Multiselect:C.TopBarMode.Normal),0!==x&&g.closeKeyboard()},setMultiselectVisibility:function setMultiselectVisibilityFn(value){this.updateMultiselectPosition(value?-C.RightMenuWidth:0,!0),value||Multiselect.reset()},setTopBarMode:function setTopBarModeFn(value){this.topBarMode.set(value)},resetTopBarMode:function resetTopBarModeFn(){var mode=this.topBarMode.get();mode===C.TopBarMode.Multiselect?(this.updateMultiselectPosition(0,!0),Multiselect.reset()):mode===C.TopBarMode.Note&&(g.menus.closeContextMenuReact(),Sel.reset()),g.autocomplete.hide(),this.topBarMode.set(C.TopBarMode.Normal)}},new MobileUI}),define("VMLI_TapHandlers",["require","exports","module","globals","platform","android","DragDrop","NativeSel","Sel","Dispatcher","MobileUI","Multiselect"],function(require,exports,module){var g=require("globals"),platform=require("platform"),android=require("android"),DragDrop=require("DragDrop"),NativeSel=require("NativeSel"),Sel=require("Sel"),Dispatcher=require("Dispatcher"),MobileUI=require("MobileUI"),Multiselect=require("Multiselect"),VMLI_TapHandlers={dragStart:function dragStartFn(e){var pane=g.focusedPane;try{g.PAssert(3541,!platform.mobile||pane.isWriteable,"Should not be able to drag/drop on timeline on mobile")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3542,pane.isDraggable,"Pane must be draggable in order to start a drag")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3543,DragDrop.startDragItem,"Should always have a valid item to start dragging from")}catch(PERR){g.reportError(PERR)}android.isEnabled()&&android.finishInput();var target=g.getElementParent(e.startSrc);try{g.PAssert(3544,target,"Must have a valid target node")}catch(PERR){g.reportError(PERR)}if(target){DragDrop.startDragItem=void 0,DragDrop.dragItem=this;var searchParams=pane.getItemSearchParams();searchParams.item=this;var allMovingNodes=[this].concat(g.searchVMLIsAsArray(searchParams)),srcRect=g.offset(target),x=srcRect.left,y=srcRect.top;g.vmMain.paneManager.runForEachPane(function(pane){pane.addScrollListener(this.dragScroll)}.bind(this));var startInfo={x:e.eventX,y:e.eventY},dataTransfer={dropEffect:pane.dropEffect(this),item:this,element:target,pane:pane};DragDrop.start(allMovingNodes,x,y,pane,startInfo,dataTransfer),g.disableMouseMove=!0,Sel.focusHiddenInput()}},dragMove:function dragMoveFn(e){try{g.PAssert(3545,DragDrop.startInfo,"Must have started a drag to be valid")}catch(PERR){g.reportError(PERR)}if(DragDrop.startInfo){e.preventDefault();var x=platform.mobile?0:e.eventX-DragDrop.startInfo.x,y=e.eventY-DragDrop.startInfo.y,dragOver=g.elementFromPoint(e.eventX,e.eventY,e.target);DragDrop.setTransform(x,y),dragOver&&DragDrop.handleDragOver({item:this,srcElement:dragOver,target:dragOver,dataTransfer:DragDrop.dataTransfer,diffY:e.diffY,clientX:e.eventX,clientY:e.eventY,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn})}},dragScroll:function dragScrollFn(){var e={eventX:Sel.mousePos.x,eventY:Sel.mousePos.y,preventDefault:g.emptyFn,diffY:0};this.dragMove(e)},dragEnd:function dragEndFn(e){g.disableMouseMove=!1,DragDrop.stop(),e.target!==document.documentElement&&DragDrop.handleDrop({srcElement:e.target,clientX:e.clientX,clientY:e.clientY,target:e.target,dataTransfer:DragDrop.dataTransfer,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn}),DragDrop.finish(),g.vmMain.paneManager.runForEachPane(function(pane){pane.removeScrollListener(this.dragScroll)}.bind(this)),g.disableMouseMove=!1},onTouchHoldTimeout:function onTouchHoldTimeoutFn(e){g.isKeyboardOpen?this.isLoupeOpen=!0:g.focusedPane&&g.focusedPane.isDropTarget&&this.isDraggable()&&(DragDrop.startDragItem=this,this.dragStart(e),this.dragMove(e))},onStart:function onStartFn(e){var pane=g.focusedPane;g.scrollAtTouchStart=pane.getScrollOffset(),platform.ios&&(this.isEditable.set(!0),g.isKeyboardOpen||e.preventDefault()),g.hasClass(e.target,"paneScroller")?e.preventDefault():(platform.mobile&&!platform.ie&&"UL"!==e.srcElement.tagName&&pane.isWriteable&&pane.isDraggable&&Dispatcher.listen("touchHoldTimeout",this.onTouchHoldTimeout),!platform.mobile&&this.isDraggable()&&pane.isDraggable&&(platform.mobile&&e.clientX<this.getPadding(pane)||!platform.mobile&&g.hasClass(e.srcElement,"collapser")||!platform.mobile&&g.hasClass(e.srcElement,"bullet")||g.findParent(e.srcElement,"plugin"))?(DragDrop.startDragItem=this,g.vmMain.updateCursorFromEvent(e)):platform.mobile&&e.clientX>pane.getWidth()-g.SPThresholdRight||!platform.mobile&&g.hasClass(e.target,"itemCheckbox")?(e.preventDefault(),e.stopImmediatePropagation()):g.vmMain.pluginManager.handleTapStart(this,e)&&platform.mobile&&(e.preventDefault(),e.stopImmediatePropagation()))},onMove:function onMoveFn(e,onPane){DragDrop.startDragItem&&(!platform.touch||Math.abs(e.distanceY)>g.ClickThreshold&&Math.abs(e.distanceX)<g.ClickThreshold)&&DragDrop.startDragItem===this&&this.dragStart(e),DragDrop.isDragging&&this.dragMove(e)},onClick:function onClickFn(index,e){var pane=g.focusedPane;if(platform.mobile&&DragDrop.isDragging)e.preventDefault(),platform.ios&&this.isEditable.set(!1);else if(platform.mobile&&MobileUI.isInMultiselect()){Multiselect.toggleSelected(index);var otherIndex;if(this.isNote()?otherIndex=index-1:this.hasNote()&&(otherIndex=index+1),!isNaN(otherIndex)){var isSelected=Multiselect.isSelected(index,pane);Multiselect.toggleSelected(otherIndex,pane,isSelected)}}else if(pane.supportCollapsing&&(platform.mobile&&e.clientX<pane.getPaddingForItem(this)||!platform.mobile&&g.hasClass(e.target,"collapser"))){if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)g.vmMain.zoomin(this);else if(this.isCollapsible()){var savedSel=Sel.save();this.toggleCollapsed(pane),savedSel&&(platform.mobile?(!savedSel.startItem||savedSel.startItem.isDescendantOf(this))&&g.closeKeyboard():pane.restoreSelectionAfterCollapse(savedSel,this))}e.preventDefault(),e.stopImmediatePropagation()}else if(pane.supportStarClick&&e.clientX<pane.getPaddingForItem(pane))pane.toggleStar(this);else if(platform.mobile&&e.clientX>pane.getWidth()-g.SPThresholdRight||!platform.mobile&&g.hasClass(e.target,"itemCheckbox"))pane.handleRightSideTap(this),e.preventDefault(),e.stopImmediatePropagation();else if(!platform.mobile&&g.hasClass(e.target,"bullet"))g.vmMain.zoomin(this);else if("SPAN"===e.srcElement.tagName&&g.hasClass(e.srcElement,"itemDataPageLoad"))this.notifyPaginationUpdate();else if(!g.hasClass(e.srcElement,"tag")||platform.mobile&&g.isKeyboardOpen)if(!g.hasClass(e.srcElement,"contact")||platform.mobile&&g.isKeyboardOpen)if(!platform.mobile&&g.hasClass(e.srcElement,"date")){if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){Sel.reset();var text=e.srcElement.textContent;e.shiftKey?pane.search.setValue(text):pane.search.addToValue(text)}}else if(g.vmMain.pluginManager.handleTapClick(this,e))platform.mobile?(e.preventDefault(),e.stopImmediatePropagation()):DragDrop.isDragging&&this.dragEnd(e);else if(!g.hasClass(e.srcElement,"link")||platform.mobile&&g.isKeyboardOpen){if(g.autocomplete&&g.autocomplete.hide(),platform.ios||platform.android||platform.mobileie){var activeElement=document.activeElement,scrollTopClick=pane.getScrollOffset(),justCancelledInertialScroll=Math.abs(scrollTopClick-g.scrollAtTouchStart)>0;if(pane.isWriteable)if(justCancelledInertialScroll)platform.mobileie&&android.isEnabled()&&(android.updateInput(index),e.preventDefault(),e.stopPropagation());else{var item=this,selectOffset;if(platform.mobile&&this===pane.getItem())item=pane.getLastItem(),selectOffset=item.getParsedText().length;else if(g.getElementParent(e.target)){var offsets=NativeSel.getSelectOffsetsForEvent(e);selectOffset=offsets.start}else selectOffset=item.getParsedText().length;try{g.PAssert(3546,item,"Click on undefined item should not happen")}catch(PERR){g.reportError(PERR)}var didSelect=!0;g.isKeyboardOpen&&activeElement&&!g.findParentID(activeElement,"search")?(Sel.selectIndex(index,selectOffset),e.preventDefault(),e.stopImmediatePropagation()):platform.mobile&&android.isEnabled()&&item.hasAttachments()?didSelect=!1:g.openKeyboardOnIndex(e,pane,index,function(){pane.onFocus(),Sel.selectIndex(index,selectOffset)},function(){pane.onBlur()}),platform.mobile&&didSelect&&Multiselect.setSelected([index],pane)}}}else(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey||platform.mobile)&&(g.openUrl(e.srcElement.getAttribute("data-href"),e),Sel.reset());else{if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){Sel.reset();var text=e.srcElement.textContent;e.shiftKey?pane.search.setValue(text):pane.search.addToValue(text)}else if(!platform.mobile||!g.isKeyboardOpen){var start;if(platform.mobile){var offsets=NativeSel.getSelectOffsetsForEvent(e);start=offsets.start}else start=Sel.getStartOffset();g.autocomplete.update({owner:this,index:Sel.getStartIndex(),start:start}),g.autocomplete.show(e.srcElement)}platform.mobile&&(e.preventDefault(),e.stopImmediatePropagation())}else{Sel.reset(),Multiselect.reset();var text=e.srcElement.textContent;e.shiftKey?pane.search.setValue(text):pane.search.toggleText(text),platform.mobile&&(e.preventDefault(),e.stopImmediatePropagation())}},onEnd:function onEndFn(e){Dispatcher.isListening("touchHoldTimeout",this.onTouchHoldTimeout)&&Dispatcher.unlisten("touchHoldTimeout",this.onTouchHoldTimeout),DragDrop.startDragItem=void 0,g.itemMenuOpenedOn===this&&g.menus.menuItemSelected(e.srcElement),MobileUI.isInMultiselect()&&(e.preventDefault(),e.stopImmediatePropagation(),e.returnFalse=!0),this.isLoupeOpen=!1,DragDrop.isDragging&&this.dragEnd(e),g.vmMain.updateCursorFromEvent(e)},onRightClick:function onRightClickFn(index,e){g.menus.openItemMenu(this,e),e.preventDefault(),e.stopPropagation()},onDoubleClick:function onDoubleClickFn(index,e){g.vmMain.pluginManager.handleDoubleTap(this,e)&&(platform.mobile?(e.preventDefault(),e.stopImmediatePropagation()):DragDrop.isDragging&&this.dragEnd(e))},onAutocompleteTapped:function onAutocompleteTappedFn(text,textLength,trackingTag){try{g.PAssert(3547,trackingTag,"Must be tracking the current AC tag")}catch(PERR){g.reportError(PERR)}var newText;if(android.isEnabled()){var aText=android.getInputText(),startOffset=Sel.getStartOffset()-trackingTag.length;newText=aText.substr(0,startOffset)+text+aText.substr(Sel.getStartOffset()+1),this.setText(newText,!0,ChangeType.Local),android.updateInputText(this);var selOffset=Sel.getStartOffset()+textLength;android.setSelection(selOffset,selOffset),Sel.setSelectionFromAndroid(selOffset,selOffset)}else{var oText=this.getParsedText(),startOffset=Sel.getStartOffset()-trackingTag.length;newText=oText.substr(0,startOffset)+text+oText.substr(Sel.getStartOffset()+1),Sel.getPane().focus(),this.setText(newText,!0,ChangeType.Local),Sel.selectIndex(Sel.getStartIndex(),startOffset+textLength)}}};return VMLI_TapHandlers}),define("RepeatDate",["globals"],function(g){function RepeatDate(p){if(this._valid=!0,this._initData=p,this._maxCount=maxGenDates,g.isString(p))this.fromString(p);else if(g.isArray(p))this.fromICal(p);else if(p instanceof RepeatDate)this._startDate=new Date(p._startDate),this._endDate=p._endDate?new Date(p._endDate):void 0,this._frequency=p._frequency,this._separation=p._separation,this._offsets=p._offsets?p._offsets.slice():void 0;else if(g.isObject(p)){try{g.PAssert(3548,p.type===DateType.Repeat,"Must have a valid date type set")}catch(PERR){g.reportError(PERR)}this._startDate=new Date(p.startDate),this._endDate=p.endDate?new Date(p.endDate):void 0,this._frequency=p.frequency,this._separation=p.separation||1,this._offsets=p.offsets}else{try{g.PAssert(3549,!1,"Invalid object passed to RepeatDate constructor",p)}catch(PERR){g.reportError(PERR)}this._valid=!1}if(this._startDate){try{g.PAssert(3550,this._startDate instanceof Date,"Must be a valid date instance")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3551,this._startDate.isAfter(minStartDate),"Start date must be after the minimum start date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3552,!this._endDate||this._endDate instanceof Date,"Must be a valid date instance")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3553,!this._offsets||this._offsets.length>=1,"Must always store at least one offset if _offsets is defined",this._offsets)}catch(PERR){g.reportError(PERR)}if(this._endDate&&!this._startDate.isBefore(this._endDate)&&!this._startDate.equals(this._endDate)){this._valid=!1;try{g.PAssert(3555,!1,"Start date must always be before the end date")}catch(PERR){g.reportError(PERR)}}}else this._valid=!1;this._doneGenerating=!this._valid,this._cache=[],this._cacheDate=new Date(this._startDate)}var REPEAT_VER=1,SEP="|",dayList=["SU","MO","TU","WE","TH","FR","SA"],maxGenDates=500,minStartDate=new Date(1401606e6);return RepeatDate.prototype={isValid:function isValidFn(){return this._valid},_isValidDate:function _isValidDateFn(obj){return obj&&obj instanceof Date},setStartDate:function setStartDateFn(date){try{g.PAssert(3556,date,"Must provide a valid date")}catch(PERR){g.reportError(PERR)}if(this._startDate=new Date(date),this._endDate&&!this._startDate.isBefore(this._endDate)&&!this._startDate.equals(this._endDate)){this._valid=!1;try{g.PAssert(3557,!1,"Start date must always be before the end date")}catch(PERR){g.reportError(PERR)}}this._resetCache()},getStartDate:function getStartDateFn(){return this._startDate},getEndDate:function getEndDateFn(){return this._endDate},_isBeforeEnd:function _isBeforeEndFn(date){try{g.PAssert(3558,this._isValidDate(date),"Must provide a valid date: ",date)}catch(PERR){g.reportError(PERR)}var cacheHasSpace=this._cache.length<this._maxCount,beforeEnd=this._endDate?date.isBefore(this._endDate)||date.equals(this._endDate):!0;return cacheHasSpace&&beforeEnd},_resetCache:function _resetCacheFn(){this._cache=[],this._cacheDate=new Date(this._startDate),this._doneGenerating=!this._valid
},_getNext:function _getNextFn(num){return this._cache.length<num&&this._generate(num),this._cache.slice(0,num)},_generateUntil:function _generateUntilFn(until){try{g.PAssert(3559,this._isValidDate(until),"Must provide a valid date to generate until: ",until)}catch(PERR){g.reportError(PERR)}for(var generated=!1;!this._doneGenerating&&this._getLastCachedDate()&&this._getLastCachedDate().isBefore(until);)this._generateNext(1),generated=!0;return generated},_generateNext:function _generateNextFn(num){try{g.PAssert(3560,num>0,"Must request a valid number of additional dates")}catch(PERR){g.reportError(PERR)}this._generate(this._cache.length+num)},_generate:function _generateFn(totalNum){try{g.PAssert(3561,totalNum>0,"Must request a valid number of dates")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3562,totalNum<this._maxCount,"Must request less than maxCount dates")}catch(PERR){g.reportError(PERR)}var currentDate=new Date(this._cacheDate);totalNum=Math.min(totalNum,this._maxCount);for(var iterations=0;totalNum>iterations&&this._cache.length<totalNum&&this._isBeforeEnd(currentDate);){if(this._offsets)for(var i=0;i<this._offsets.length&&this._cache.length<totalNum;++i){var cOffset=this._offsets[i],instanceDate=new Date(currentDate);if(instanceDate.getDay()<=cOffset){switch(this._frequency){case RepeatFreq.Weekly:instanceDate.addDays(cOffset-instanceDate.getDay());break;default:try{g.PAssert(3563,!1,"Invalid repeat frequency for offset dates",this._frequency)}catch(PERR){g.reportError(PERR)}}var lastCache=this._cache[this._cache.length-1];if(!this._isBeforeEnd(instanceDate)||lastCache&&!instanceDate.isAfter(lastCache))return void(this._isBeforeEnd(instanceDate)||(this._doneGenerating=!0));this._cache.push(instanceDate)}}else{var instanceDate=new Date(currentDate),lastCache=this._cache[this._cache.length-1];if(!this._isBeforeEnd(instanceDate)||lastCache&&!instanceDate.isAfter(lastCache))return void(this._isBeforeEnd(instanceDate)||(this._doneGenerating=!0));this._cache.push(instanceDate)}switch(this._frequency){case RepeatFreq.Daily:currentDate.addDays(this._separation);break;case RepeatFreq.Weekly:this._offsets&&this._offsets.length>1&&currentDate.getDay()!==this._offsets[0]&&currentDate.moveToDayOfWeek(this._offsets[0],-1),currentDate.addWeeks(this._separation);break;case RepeatFreq.Monthly:currentDate.addMonths(this._separation);break;case RepeatFreq.NthMonthInst:var targetDay=this._startDate.getDay(),occur=Math.ceil(this._startDate.getDate()/7);currentDate.addMonths(this._separation),(4===occur||5===occur)&&(occur=-1),currentDate.moveToNthOccurrence(targetDay,occur);break;case RepeatFreq.Yearly:currentDate.addYears(this._separation);break;case RepeatFreq.EndOfMonthOffset:currentDate.addMonths(this._separation);var offsetDay=this._startDate.getDate(),maxOffsetDay=this._startDate.getDaysInMonth(),diff=maxOffsetDay-offsetDay;currentDate.setDate(currentDate.getDaysInMonth()-diff);break;case RepeatFreq.DayOfMonth:for(var i=0;i<this._separation;++i)this.getNextValidMonth(currentDate,this._startDate.getDate());break;case RepeatFreq.Once:default:try{g.PAssert(3564,!1,"Invalid repeat frequency")}catch(PERR){g.reportError(PERR)}return void(this._doneGenerating=!0)}this._cacheDate=currentDate,iterations++}this._isBeforeEnd(currentDate)||(this._doneGenerating=!0)},getNextValidMonth:function getNextValidMonthFn(date,offsetDay){try{g.PAssert(3565,this._isValidDate(date),"Must provide a valid date: ",date)}catch(PERR){g.reportError(PERR)}if(date.addMonths(1),date.getDate()!==offsetDay){var maxDays=date.getDaysInMonth();offsetDay>maxDays&&(date.addMonths(1),date.setDate(offsetDay))}},includesDate:function includesDateFn(date){for(var dates=this.getDates(!1),i=0;i<dates.length;i++)if(dates[i].equals(date))return!0;return!1},getDates:function getDatesFn(futureOnly){try{g.PAssert(3566,this._valid,"Must not call getDates with invalid RepeatDate: ",this._initData)}catch(PERR){g.reportError(PERR)}var maxPastDates=3,maxFutureDates=4,today=new Date;this._generate(maxFutureDates),this._generateUntil(today);var todayIndex=this._cache.findInsertIndex(today,Date.compare),futureDates=this._cache.length-todayIndex;maxFutureDates>futureDates&&this._generateNext(maxFutureDates-futureDates);var minIndex=futureOnly?Math.max(todayIndex,0):Math.max(todayIndex-maxPastDates,0),maxIndex=Math.min(todayIndex+maxFutureDates,this._cache.length);return this._cache.slice(minIndex,maxIndex)},next:function nextFn(num){return num>0?this._getNext(num):void 0},nextIndex:function nextIndexFn(fromDate){try{g.PAssert(3568,this._valid,"Must not call nextIndex with invalid RepeatDate: ",this._initData)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3569,!fromDate||this._isValidDate(fromDate),"Must provide a valid from date",fromDate)}catch(PERR){g.reportError(PERR)}var from=fromDate?new Date(fromDate):this._startDate,generated=this._generateUntil(from);if(generated)return this._cache.length-1;for(var i=0;i<this._cache.length;++i)if(this._cache[i].isAfter(from)||this._cache[i].equals(from))return i;return this._generateNext(1),this._cache.length-1},nextComplete:function nextCompleteFn(fromDate){try{g.PAssert(3570,this._valid,"Must not call nextComplete with invalid RepeatDate: ",this._initData)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3571,!fromDate||this._isValidDate(fromDate),"Must provide a valid from date",fromDate)}catch(PERR){g.reportError(PERR)}var futIndex=this.nextIndex(fromDate);return this._cache[futIndex]},nextActive:function nextActiveFn(fromDate){try{g.PAssert(3574,this._valid,"Must not call nextActive with invalid RepeatDate: ",this._initData)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3575,!fromDate||this._isValidDate(fromDate),"Must provide a valid from date",fromDate)}catch(PERR){g.reportError(PERR)}var futIndex=this.nextIndex(fromDate);return this._cache.length<=futIndex+1&&this._generateNext(1),this._cache[futIndex+1]},_getLastCachedDate:function _getLastCachedDateFn(){return this._cache[this._cache.length-1]},hasTimeOfDay:function hasTimeOfDayFn(){return this._valid?this._startDate.hasTimeOfDay():!1},isRepeatDate:function isRepeatDateFn(){return!0},getTimeOfDay:function getTimeOfDayFn(){return this._valid?this._startDate.getTimeOfDay():0},getTime:function getTimeFn(format){return this._valid?this._startDate.toString(format):""},equals:function equalsFn(dateInfo){if(this._valid){if(g.isString(dateInfo))return this.toString()===dateInfo;if(dateInfo instanceof RepeatDate){if(dateInfo._valid){var startEqual=!isNaN(this._startDate)&&!isNaN(dateInfo._startDate)&&this._startDate.equals(dateInfo._startDate),endEqual=this._endDate?this._endDate.equals(dateInfo._endDate):this._endDate===dateInfo._endDate,freqEqual=this._frequency===dateInfo._frequency,sepEqual=this._separation===dateInfo._separation,offsetsEqual=this._offsets?this._offsets.equals(dateInfo._offsets):this._offsets===dateInfo._offsets;return startEqual&&endEqual&&freqEqual&&sepEqual&&offsetsEqual}}else if(g.isObject(dateInfo)){try{g.PAssert(3578,dateInfo.type===DateType.Repeat,"Must have a valid date type set")}catch(PERR){g.reportError(PERR)}var compDate=new Date(dateInfo.startDate);try{g.PAssert(3579,this._isValidDate(compDate),"Must provide a valid comp date",compDate)}catch(PERR){g.reportError(PERR)}var startEqual=!isNaN(this._startDate)&&!isNaN(compDate)&&this._startDate.equals(compDate),endEqual=this._endDate==(dateInfo._endDate?new Date(dateInfo._endDate):void 0),freqEqual=this._frequency===dateInfo.frequency,sepEqual=this._separation===dateInfo._separation,offsetsEqual=this._offsets?this._offsets.equals(dateInfo._offsets):this._offsets===dateInfo._offsets;return startEqual&&endEqual&&freqEqual&&sepEqual&&offsetsEqual}}return!1},fromString:function fromStringFn(str){try{var tokens=str.split(SEP),ver=tokens[0];if("1"===ver){this._startDate=new Date(parseInt(tokens[1])),this._endDate=tokens[2]?new Date(parseInt(tokens[2])):void 0,this._frequency=parseInt(tokens[3]),this._separation=parseInt(tokens[4]);try{g.PAssert(3580,g.isNumber(this._frequency),"Invalid frequency",tokens[3])}catch(PERR){g.reportError(PERR)}try{g.PAssert(3581,g.isNumber(this._separation),"Invalid frequency",tokens[4])}catch(PERR){g.reportError(PERR)}if(this._offsets=void 0,tokens[5]){var offsets=tokens[5].split(",");if(offsets.length>0){this._offsets=[];for(var i=0;i<offsets.length;++i){var offset=parseInt(offsets[i]);try{g.PAssert(3582,g.isNumber(offset),"Date offsets must be valid numbers",offsets[i])}catch(PERR){g.reportError(PERR)}this._offsets.push(offset)}}}if(!this._isValidDate(this._startDate)||this._endDate&&!this._isValidDate(this._endDate)){try{g.PAssert(3583,!1,"Invalid start or end date parsing from string",this._startDate,this._endDate)}catch(PERR){g.reportError(PERR)}this._valid=!1}}else{try{g.PAssert(3584,!1,"Unknown repeated date version: ",ver)}catch(PERR){g.reportError(PERR)}this._valid=!1}}catch(err){this._valid=!1,g.reportError(err)}this._resetCache()},toString:function toStringFn(){if(this._valid){var start=this._startDate.getTime(),end=this._endDate?this._endDate.getTime():"",offsets=this._offsets&&this._offsets.length>1?this._offsets.join(","):"";return REPEAT_VER+SEP+start+SEP+end+SEP+this._frequency+SEP+this._separation+SEP+offsets}return void 0},toICal:function toICalFn(){var ical=[],cmds={};if(this._valid){switch(this._startDate&&ical.push("DTSTART:"+this._startDate.getTime()+"Z"),this._endDate&&(cmds.UNTIL=this._endDate.getTime()+"Z"),this._frequency){case RepeatFreq.Daily:cmds.FREQ="DAILY";break;case RepeatFreq.Weekly:cmds.FREQ="WEEKLY";for(var genDate=this._startDate.clone(),days=[dayList[genDate.getDay()]],i=0;i<this._offsets.length;++i)genDate.moveToDayOfWeek(this._offsets[i]),days.push(dayList[genDate.getDay()]);cmds.BYDAY=days.toString();break;case RepeatFreq.Monthly:cmds.FREQ="MONTHLY";break;case RepeatFreq.DayOfMonth:cmds.FREQ="MONTHLY",cmds.BYMONTHDAY=this._startDate.getDate();break;case RepeatFreq.Yearly:cmds.FREQ="YEARLY";break;case RepeatFreq.EndOfMonthOffset:cmds.FREQ="MONTHLY",cmds.BYMONTHDAY=-this._startDate.getDate();break;case RepeatFreq.NthMonthInst:cmds.FREQ="MONTHLY",cmds.BYDAY=dayList[this._getStartDate.getDay()],cmds.BYSETPOS=Math.ceil(this._getStartDate.getDate()/7);break;default:try{g.PAssert(3585,!1,"Invalid repeat date frequencey: "+this._frequency)}catch(PERR){g.reportError(PERR)}}cmds.INTERVAL=this._separation;var rrule="RRULE:";for(var cmd in cmds)rrule+=cmd+"="+cmds[cmd]+";";ical.push(rrule)}return ical},_handleICalString:function _handleICalStringFn(data,cb){for(var cmds=data.split(";"),i=0;i<cmds.length;++i){var cmd=cmds[i],parts=cmd.split("="),action=parts[0],value=parts[1];cb(action,value)}},_handleDTSTART:function _handleDTSTARTFn(data){try{g.PAssert(3586,data.endsWith("Z"),"Timestamp must be in UTC time: "+data)}catch(PERR){g.reportError(PERR)}log("DTSTART: ",data),this._startDate=new Date(parseInt(data.slice(0,-1)));try{g.PAssert(3587,this._startDate,"Must have a valid start date: "+data)}catch(PERR){g.reportError(PERR)}},_handleRRULE:function _handleRRULEFn(data){this._handleICalString(data,function(action,value){switch(log("RRULE: ",action,"->",value),action){case"FREQ":switch(value){case"DAILY":this._frequency=RepeatFreq.Daily;break;case"WEEKLY":this._frequency=RepeatFreq.Weekly;break;case"MONTHLY":this._frequency=RepeatFreq.Monthly;break;case"YEARLY":this._frequency=RepeatFreq.Yearly;break;case"SECONDLY":case"MINUTELY":case"HOURLY":default:try{g.PAssert(3588,!1,"Invalid RRULE FREQ value: ",value)}catch(PERR){g.reportError(PERR)}}break;case"UNTIL":try{g.PAssert(3589,value.indexOf("T")<0,"Do not currently support date-time")}catch(PERR){g.reportError(PERR)}var year=value.substring(0,4),month=value.substring(4,6),day=value.substring(6,8);this._endDate=new Date(year,month,day);break;case"COUNT":this._maxCount=parseInt(value);break;case"INTERVAL":this._separation=parseInt(value);break;case"BYDAY":var days=value.split(",");this._offsets=[];for(var i=0;i<days.length;++i){var index=dayList.indexOf(days[i]);this._offsets.push(index>=0?index:parseInt(days[i]))}break;case"BYMONTHDAY":break;case"BYYEARDAY":break;case"BYWEEKNO":break;case"BYMONTH":break;case"BYSETPOS":break;case"WKST":break;case"BYSECOND":case"BYMINUTE":case"BYHOUR":default:try{g.PAssert(3590,!1,"Invalid RRULE action: ",action)}catch(PERR){g.reportError(PERR)}}})},_handleEXRULE:function _handleEXRULEFn(data){this._handleICalString(data,function(action,value){log("EXRULE: ",action,"->",value)})},_handleRDATE:function _handleRDATEFn(data){this._handleICalString(data,function(action,value){log("RDATE: ",action,"->",value)})},_handleEXDATE:function _handleEXDATEFn(data){this._handleICalString(data,function(action,value){log("EXDATE: ",action,"->",value)})},fromICal:function fromICalFn(arr){try{g.PAssert(3591,2===arr.length,"Only handle single instance RRULE with added DTSTART")}catch(PERR){g.reportError(PERR)}for(var i=0;i<arr.length;++i){var rule=arr[i],components=rule.split(":"),cmd=components[0],value=components[1];switch(cmd){case"DTSTART":this._handleDTSTART(value);break;case"RRULE":this._handleRRULE(value);break;case"EXRULE":this._handleEXRULE(value);break;case"RDATE":this._handleRDATE(value);break;case"EXDATE":this._handleEXDATE(value);break;default:try{g.PAssert(3592,!1,"Invalid recurrence rule: "+cmd)}catch(PERR){g.reportError(PERR)}}}}},RepeatDate}),define("VMLI_Text",["data","gdata","globals","Constants","tracker","android","RepeatDate","Measure","DuchessHelpers","DisplaySettings"],function(d,gdata,g,C,tracker,android,RepeatDate,Measure,DuchessHelpers,DisplaySettings){var VMLI_Text={_runAndGetSaveData:function _runAndGetSaveDataFn(text,immediateParse,changeType){if(this.shouldSave())var oldMetaData=this.getMetaTextSaveData();if(this.setRawText(this.generateSaveText(text)),this.parseText(immediateParse,changeType),this.shouldSave()){var newMetaData=this.getMetaTextSaveData(),saveData={};for(var key in newMetaData)oldMetaData[key]!==newMetaData[key]&&(saveData[key]=newMetaData[key])}return saveData},setText:function setTextFn(text,immediateParse,changeType,fromAndroidEditing){try{g.PAssert(3593,g.isLocalChange(changeType)||!text||text.indexOf(window.AttachChar)<0,"Should never be setting text with an attach char in it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3594,this.isNote()||!text||text.indexOf("\n")<0,"Non-notes should never have newlines")}catch(PERR){g.reportError(PERR)}changeType|=ChangeType.Text,!this.isNote()&&text&&text.indexOf("\n")>=0&&(text=text.replace(/\n/g," ")),this.isInitialized&&Measure.clearCacheForItem(this.id);var saveData=this._runAndGetSaveData(text,immediateParse,changeType);if(this.shouldSave()){saveData.text=this.generateSaveText(text);var saveFlag;g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)?(gdata.saveChanges(this,saveData),saveFlag=SaveFlag.Text):saveFlag=SaveFlag.None,saveData.dateText=this.getDateText(),saveData.durationText=this.getDurationText(),this.save(saveData,saveFlag),immediateParse&&!fromAndroidEditing&&android.isEnabled()&&android.getCurrentVMLI()===this&&android.updateInputText(this)}},metricsInPane:function metricsInPaneFn(pane,overview){var spanWidth=pane.maxWidthOfItem(this,overview),textMetrics;try{textMetrics=Measure.measureItem(this,pane,spanWidth)}catch(err){g.reportError(err)}return textMetrics},heightInPane:function heightInPaneFn(pane,overview){if(overview)return C.OverviewItemHeight;var height=this.metricsInPane(pane,overview).height;return this.isNote()&&pane.type===PaneMode.Timeline&&(height+=DisplaySettings.itemPadding()),height},generateSaveText:function generateSaveTextFn(text,offset){var saveText;return saveText=void 0!==text&&null!==text?this._generateUsableText(text,"getEmbedString",offset):null},generateTitleText:function generateTitleTextFn(text){return this._generateUsableText(text,"getTitleString")},_generateUsableText:function _generateUsableTextFn(text,fnName,offset){try{g.PAssert(3595,this.hasAttachments()||text.indexOf(window.AttachChar)<0,"Should either have attachments or no embedded attachment chars")}catch(PERR){g.reportError(PERR)}var outText=text;if(this.hasAttachments()&&text.indexOf(window.AttachChar)>=0){var attachIndex=offset||0,maxAttachIndex=this.getNumAttachments();outText=text.replace(/\u2000/g,function(){if(maxAttachIndex>attachIndex){var attach=this.getAttachment(attachIndex);return attachIndex++,attach[fnName]()}try{g.PAssert(3596,!1,"Unable to find valid attachment for AttachChar")}catch(PERR){g.reportError(PERR)}return""}.bind(this));try{g.PAssert(3597,outText.indexOf(window.AttachChar)<0,"Should convert all attachments to their string form")}catch(PERR){g.reportError(PERR)}}return outText},splitUsableText:function splitUsableTextFn(text,startSplitIndex,endSplitIndex){try{g.PAssert(3598,this.hasAttachments()||text.indexOf(window.AttachChar)<0,"Should either have attachments or no embedded attachment chars")}catch(PERR){g.reportError(PERR)}var usableText=text.substring(0,startSplitIndex)+text.substring(endSplitIndex),splitIndex=startSplitIndex;if(this.hasAttachments()&&text.indexOf(window.AttachChar)>=0){var attachIndex=0,maxAttachIndex=this.getNumAttachments();usableText=text.replace(/\u2000/g,function(match,offset){if(maxAttachIndex>attachIndex){var attach=this.getAttachment(attachIndex);attachIndex++;var replaceStr=attach.getEmbedString();return startSplitIndex>offset&&(splitIndex+=Math.max(replaceStr.length-1,0)),replaceStr}return window.AttachChar}.bind(this));try{g.PAssert(3599,usableText.indexOf(window.AttachChar)<0,"Should convert all attachments to their string form")}catch(PERR){g.reportError(PERR)}}var outData={before:usableText.substring(0,splitIndex),after:usableText.substring(splitIndex)};return outData},parseText:function parseTextFn(immediateParse,changeType,changedStyles){try{g.PAssert(3600,!this.isDestroyed(),"Must not parse a destroyed VMLI")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3601,immediateParse,"Currently we only support immediate parsing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3602,g.isValidChangeType(changeType),"Must specify a valid changetype")}catch(PERR){g.reportError(PERR)}this.__TEMP_ParseCalled=!0;var styleInfo;if(immediateParse){if(this.isNote())styleInfo=DuchessHelpers.parseNote(this.getRawText());else{var parseFn=this.getParser();try{g.PAssert(3603,parseFn,"Must be able to get valid parse function for item")}catch(PERR){g.reportError(PERR)}if(!parseFn)return void 0;styleInfo=parseFn(this.getRawText(),this.getDateTime(),this.getRepeatDate(),this.getDateText(),this.getDateCompletedTime(),changeType,d.contactManager.getContacts())}g.isFlagSet(changeType,ChangeType.Local)&&styleInfo.numContacts>0&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddContact,data:[{itemID:this.id}]})}else try{g.PAssert(3604,!1,"Should always be using immediate parse")}catch(PERR){g.reportError(PERR)}var styled=this.styleText(styleInfo,immediateParse,changeType,changedStyles);return this.itemChanged.notify(),styled},styleText:function styleTextFn(styleInfo,parsedFull,changeType,changedStyles){try{g.PAssert(3605,parsedFull,"Currently we only support full parses")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3606,g.isValidChangeType(changeType),"Must specify a valid changetype")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3607,!(!styleInfo&&parsedFull),"In a full parse, styleInfo should always be defined")}catch(PERR){g.reportError(PERR)}var styleChanges=!1,text;if(styleInfo){parsedFull&&this.setParsedText(styleInfo.parsedText);try{g.PAssert(3608,styleInfo.els,"Must always return an els list")}catch(PERR){g.reportError(PERR)}if(styleInfo.els&&(this.els=styleInfo.els),styleInfo.dates){0===styleInfo.dates.length&&(this.date()||this.repeatDate())&&(this.dateText=void 0,this.setDurationText(void 0),this.repeatDate()&&!this.isForceCompleted()&&(this.dateCompleted=void 0,changedStyles&&(styleChanges=!0,changedStyles.dateCompleted=void 0)),this.date(null,changeType),this.repeatDate(null,changeType),this.setDuration(0),changedStyles&&(styleChanges=!0,changedStyles.date=void 0,changedStyles.dateText=void 0,changedStyles.repeatDate=void 0,changedStyles.duration=void 0,changedStyles.durationText=void 0));for(var i=0;i<styleInfo.dates.length;++i){var dt=styleInfo.dates[i];if(dt.type===DateType.Once)this.dateText!==dt.origText&&(this.dateText=dt.origText,changedStyles&&(styleChanges=!0,changedStyles.dateText=dt.origText)),dt.date&&this.date()&&dt.date==this.date()||(!!dt.date^!!this.date()||this.date()&&dt.date.getTime()!==this.date().getTime())&&(this.date(dt.date,changeType),changedStyles&&(styleChanges=!0,changedStyles.date=dt.date)),this.repeatDate()&&(this.repeatDate(null,changeType),changedStyles&&(styleChanges=!0,changedStyles.repeatDate=void 0));else if(dt.type===DateType.Repeat){var newDateText=dt.oldText||dt.text;this.dateText!==newDateText&&(this.dateText=newDateText,changedStyles&&(styleChanges=!0,changedStyles.dateText=newDateText));var rDate=new RepeatDate(dt);rDate.isValid()?(!this.repeatDate()||!rDate.equals(this.repeatDate())||!!rDate^!!this.repeatDate())&&((!rDate||this.repeatDate()&&!this.repeatDate().getStartDate().equals(rDate.getStartDate()))&&(this.isForceCompleted()||(this.dateCompleted=void 0,changedStyles&&(styleChanges=!0,changedStyles.dateCompleted=void 0))),this.repeatDate(rDate,changeType),changedStyles&&(styleChanges=!0,changedStyles.repeatDate=rDate.toString())):g.reportError(new Error("Local invalid repeat date: "+dt)),this.date()&&(this.date(null,changeType),changedStyles&&(styleChanges=!0,changedStyles.date=void 0))}}}else(this.date()||this.repeatDate())&&parsedFull&&(this.dateText=void 0,this.setDurationText(void 0),this.repeatDate()&&!this.isForceCompleted()&&(this.dateCompleted=void 0,changedStyles&&(styleChanges=!0,changedStyles.dateCompleted=void 0)),this.date(null,changeType),this.repeatDate(null,changeType),this.setDuration(0),changedStyles&&(styleChanges=!0,changedStyles.date=void 0,changedStyles.dateText=void 0,changedStyles.repeatDate=void 0,changedStyles.duration=void 0,changedStyles.durationText=void 0));if(styleInfo.durations&&styleInfo.durations.length>0)for(var i=0;i<styleInfo.durations.length;++i){var durationInfo=styleInfo.durations[i];this.setDuration(durationInfo.duration),this.setDurationText(durationInfo.durationText)}else this.getDuration()>0&&(this.setDuration(0),this.setDurationText(void 0),changedStyles&&(styleChanges=!0,changedStyles.duration=void 0,changedStyles.durationText=void 0));if((styleInfo.tags||this._activeTags)&&this.setTags(styleInfo.tags),styleInfo.attachments||this.getAttachments()){for(var newAttachments=[],i=0;styleInfo.attachments&&i<styleInfo.attachments.length;++i){var newAttach=g.vmMain.pluginManager.getAttachment(styleInfo.attachments[i]);newAttach&&(newAttachments.push(newAttach),g.isLocalChange(changeType)&&!newAttach.getOldID()&&newAttach.notifyItemTextChanged(this,!1))}this.setAttachments(newAttachments,changeType)}}return styleChanges},getCalendarRawText:function getCalendarRawTextFn(){var replaceStr=DatePrefix+this.getDateText();return this.getDurationText()&&(replaceStr+=" "+this.getDurationText()),this.getRawText().replace(replaceStr,"").replace(/^ +/g,"").replace(/ +$/g,"")},getCalendarParsedText:function getCalendarParsedTextFn(){var calendarText;if(this.hasAttachmentType(C.PluginType.Email)){var attach=this.getAttachmentByType(C.PluginType.Email);calendarText=attach.getField("subject")}else{var replaceStr=DatePrefix+this.getDateText();this.getDurationText()&&(replaceStr+=" "+this.getDurationText()),calendarText=this.getParsedText().replace(replaceStr,"").replace(/\u2000/g,"")}return calendarText.trim()}};return VMLI_Text}),define("VMLI_Drive",["globals","data","gdata","tracker","RepeatDate","Sel"],function(g,d,gdata,tracker,RepeatDate,Sel){var VMLI_Drive=function(VMLI){function iterateRemoteLink(parentItem,remoteItem){gdata.cacheItem(remoteItem),linkNote(remoteItem,gdata.get(remoteItem,"note")),iterateLink(remoteItem,gdata.get(remoteItem,"items")),iterateLink(remoteItem,gdata.get(remoteItem,"archivedItems"))}function iterateLink(parentItem,itemArray){if(itemArray)for(var i=0;i<itemArray.length;++i){var item=itemArray.get(i);try{g.PAssert(3621,item,"Item must exist to get it from the array")}catch(PERR){g.reportError(PERR)}if(item&&item.id){gdata.setItemParent(item,parentItem);var localItem=d.getModel(item.id);localItem?localItem.linkToGDrive(item):iterateRemoteLink(parentItem,item)}else{if(item)try{g.reportError(new Error("Item in list without defined ID: "+g.getObjectInfo(item)+" : "+JSON.stringify(item)))}catch(err){g.reportError(err)}else g.reportError(new Error("Removing undefined/null value form remote list"));itemArray.remove(i),i--}}}function linkNote(parentItem,note){if(note){gdata.setItemParent(note,parentItem);var localItem=d.getModel(note.id);localItem?localItem.linkToGDrive(note):gdata.cacheItem(note)}}return{changeTypeFromEvent:function changeTypeFromEventFn(event){var changeType;return this.isLocalEvent(event)?(changeType=ChangeType.Local,tracker.undoRedoActive&&(changeType|=ChangeType.UndoRedo)):changeType=ChangeType.Remote,changeType},linkToGDrive:function linkToGDriveFn(data,overwriteFromRemote){try{g.PAssert(3622,data,"Must be passing in valid data")}catch(PERR){g.reportError(PERR)}if(!this.data){if(data){try{g.PAssert(3623,void 0===data.connectIdentifier,"Should never have a connect identifier present during link")}catch(PERR){g.reportError(PERR)}data.connectIdentifier=gdata.connectIdentifier(),this.data=data,gdata.cacheItem(data)}this.setRemoteVersion(VersionType.Structure,gdata.getVersion(data,VersionType.Structure)),this.setRemoteVersion(VersionType.Text,gdata.getVersion(data,VersionType.Text)),overwriteFromRemote&&(this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text))),linkNote(data,gdata.get(data,"note")),iterateLink(data,gdata.get(data,"items")),iterateLink(data,gdata.get(data,"archivedItems"))}},initFromGDrive:function initFromGDriveFn(data){try{g.PAssert(3627,data,"To initialize from gdrive a valid remote data object must be passed in")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3628,!tracker.undoRedoActive,"Should not be initializing new VMLIs from gdrive during undo/redo")}catch(PERR){g.reportError(PERR)}if(!data)return void g.reportError(new Error("FATAL ERROR - No remote data for item"));if(this.data=data,data.connectIdentifier)try{g.PAssert(3631,data.connectIdentifier===gdata.connectIdentifier(),"Should never have a connect identifier present during link")}catch(PERR){g.reportError(PERR)}else data.connectIdentifier=gdata.connectIdentifier();if(gdata.getItemParent(this.data))try{g.PAssert(3632,gdata.getItemParent(this.data).id===this.parent().id,"Item parent must match")}catch(PERR){g.reportError(PERR)}else this.parent()&&gdata.setItemParent(this.data,this.parent().data);gdata.cacheItem(this.data);var needsFullSave=void 0===this.id||this.forceModifiedItems,remoteChanges=needsFullSave?void 0:{},needsParsing=!1;this.id=data.id;try{needsParsing=this.resolveMisc(remoteChanges)||needsParsing,needsParsing=this.resolveText(remoteChanges)||needsParsing,needsParsing&&g.vmMain.addParseItem(this,ChangeType.Remote|ChangeType.All),this.computeDisplayComplete(),this.resolveItems(remoteChanges)}catch(err){g.reportError(err)}if(needsFullSave){try{g.PAssert(3633,void 0===remoteChanges,"If doing a full save, remoteChanges should always be undefined")}catch(PERR){g.reportError(PERR)}this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text)),this.save(null,SaveFlag.None)}else if(!g.isEmpty(remoteChanges)){remoteChanges.isDeleted!==!0&&(remoteChanges.isDeleted=void 0);try{g.PAssert(3634,remoteChanges.hasOwnProperty("version")||remoteChanges.hasOwnProperty("versionText"),"If making remote changes, the version should have changed")}catch(PERR){g.reportError(PERR)}remoteChanges.hasOwnProperty("version")&&this.setVersion(VersionType.Structure,remoteChanges.version),remoteChanges.hasOwnProperty("versionText")&&this.setVersion(VersionType.Text,remoteChanges.versionText),this.save(remoteChanges,SaveFlag.None)}gdata.attachEventsToItem(this)},resolveText:function resolveTextFn(remoteChanges){var needsParsing=!1;if(this.modifiedOfflineText&&!this.forceModifiedItems)if(this.isLocalVersionNewer(VersionType.Text))gdata.saveChanges(this,{text:this.getRawText()});else{var remoteText=gdata.get(this.data,"text");try{g.PAssert(3635,void 0!==remoteText,"Every item should have text associated with it from gdrive")}catch(PERR){g.reportError(PERR)}var localText=this.getRawText(),needDupe=!1;if(localText!==remoteText&&(needDupe=!0),needDupe)if(this.isNote())this.setText(remoteText,!0,ChangeType.Remote|ChangeType.Text),g.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text),remoteChanges&&(remoteChanges.text=this.getRawText(),remoteChanges.modifiedOfflineText=!1);else{var thisIndex=this.getIndex(),newItem=d.createVMLI({text:this.getRawText()},{parent:this.parent(),changeType:ChangeType.Local});this.parent().insertItem(newItem,thisIndex+1),this.setText(remoteText,!0,ChangeType.Remote),g.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text),remoteChanges&&(remoteChanges.text=this.getRawText(),remoteChanges.dateText=this.getDateText(),remoteChanges.durationText=this.getDurationText())}else remoteChanges&&(remoteChanges.modifiedOfflineText=!1);remoteChanges&&(remoteChanges.versionText=this.getRemoteVersion(VersionType.Text),g.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text,remoteChanges))}else if(this.isRemoteVersionNewer(VersionType.Text)){var remoteText=gdata.get(this.data,"text");try{g.PAssert(3636,void 0!==remoteText,"Every item should have text associated with it from gdrive")}catch(PERR){g.reportError(PERR)}this.getRawText()!==remoteText&&(this.setText(remoteText,!0,ChangeType.Remote),remoteChanges&&(remoteChanges.text=this.getRawText(),remoteChanges.dateText=this.getDateText(),remoteChanges.durationText=this.getDurationText()),this.isVersionUninitialized(VersionType.Text)||(needsParsing=!0)),remoteChanges&&this.getVersion(VersionType.Text)!==this.getRemoteVersion(VersionType.Text)&&(remoteChanges.versionText=this.getRemoteVersion(VersionType.Text),g.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text,remoteChanges))}return needsParsing},resolveMisc:function resolveMiscFn(remoteChanges){var useLocal=this.modifiedOfflineText&&this.isLocalVersionNewer(VersionType.Text),needsParsing=!1,modLocal=!1;if(useLocal||this.isRemoteVersionNewer(VersionType.Structure)||this.isRemoteVersionNewer(VersionType.Text)){var localChanges={},remoteDate=gdata.get(this.data,"date");if((remoteDate||this.date())&&(!this.date()||this.date().getTime()!==remoteDate))if(useLocal&&this.date())localChanges.date=this.date().getTime(),modLocal=!0;else{if(remoteDate){var newDate=new Date(remoteDate);this.date(newDate,ChangeType.Remote|ChangeType.Property)}else this.date(null,ChangeType.Remote|ChangeType.Property);remoteChanges&&(remoteChanges.date=this.getDateTime()),this.isVersionUninitialized(VersionType.Text)||(needsParsing=!0)}var remoteDateCompleted=gdata.get(this.data,"dateCompleted");if(!(!remoteDateCompleted&&!this.dateCompleted||this.dateCompleted&&remoteDateCompleted&&this.dateCompleted.getTime()===remoteDateCompleted))if(useLocal)localChanges.dateCompleted=this.dateCompleted?this.dateCompleted.getTime():void 0,modLocal=!0;else{var rDate=remoteDateCompleted;try{g.PAssert(3637,"string"!=typeof remoteDateCompleted,"Invalid date format stored")}catch(PERR){g.reportError(PERR)}this.dateCompleted=new Date(rDate),remoteChanges&&(remoteChanges.dateCompleted=rDate)}var remoteRepeatDate=gdata.get(this.data,"repeatDate");if(!(!remoteRepeatDate&&!this.repeatDate()||this.repeatDate()&&this.repeatDate().equals(remoteRepeatDate)))if(useLocal&&this.repeatDate())localChanges.repeatDate=this.repeatDate().toString(),modLocal=!0;else{if(remoteRepeatDate){var newRepeatDate=new RepeatDate(remoteRepeatDate);
newRepeatDate.isValid()?this.repeatDate(newRepeatDate,ChangeType.Remote|ChangeType.Property):g.reportError(new Error("Remote init invalid repeat date: "+remoteRepeatDate))}else this.repeatDate(null,ChangeType.Remote|ChangeType.Property);remoteChanges&&(remoteChanges.repeatDate=this.getRepeatDate()),this.isVersionUninitialized(VersionType.Text)||(needsParsing=!0)}var remoteDateCreated=gdata.get(this.data,"dateCreated");if(!this.dateCreated||!remoteDateCreated||this.dateCreated.getTime()!==remoteDateCreated)if(useLocal)localChanges.dateCreated=this.dateCreated?this.dateCreated.getTime():void 0,modLocal=!0;else{var rDate=remoteDateCreated;try{g.PAssert(3638,"string"!=typeof remoteDateCreated,"Invalid date format stored")}catch(PERR){g.reportError(PERR)}this.dateCreated=new Date(rDate),remoteChanges&&(remoteChanges.dateCreated=rDate)}var remotePriority=gdata.get(this.data,"priority");(remotePriority||this.priority())&&this.priority()!==remotePriority&&(useLocal?(localChanges.priority=this.priority(),modLocal=!0):(null===remotePriority&&(remotePriority=VMLIFlag.None),this.priority(remotePriority,ChangeType.Remote|ChangeType.Property)));var remoteStarred=gdata.get(this.data,"isStarred");(remoteStarred||this.isStarred())&&this.isStarred()!==remoteStarred&&(useLocal?(localChanges.isStarred=this.isStarred(),modLocal=!0):(null===remoteStarred&&(remoteStarred=!1),this.isStarred(remoteStarred,ChangeType.Remote|ChangeType.Property)));var remoteComplete=gdata.get(this.data,"isComplete");(remoteComplete||this.isComplete())&&this.isComplete()!==remoteComplete&&(useLocal?(localChanges.isComplete=this.isComplete(),modLocal=!0):(null===remoteComplete&&(remoteComplete=!1),this.isComplete(remoteComplete,ChangeType.Remote|ChangeType.Property)));var remoteFavorites=gdata.get(this.data,"favorites");if((remoteFavorites||this.getFavorites())&&remoteFavorites!=this.getFavorites()&&(useLocal?(localChanges.favorites=this.getFavorites(),modLocal=!0):(null===remoteFavorites&&(remoteFavorites=void 0),this.setFavorites(remoteFavorites,ChangeType.Remote|ChangeType.Property))),useLocal){try{g.PAssert(3639,modLocal===!g.isEmpty(localChanges),"Verify modLocal is computed properly. It should track any changes to localChanges")}catch(PERR){g.reportError(PERR)}modLocal===!0&&gdata.saveChanges(this,localChanges)}}return needsParsing},resolveNote:function resolveNoteFn(remoteChanges){var remoteItem=gdata.get(this.data,"note"),localModel=this.hasNote()?this.getNote():void 0;if(remoteItem)if(localModel)localModel.initFromGDrive(remoteItem);else{var localItem=d.getItem(remoteItem.id);if(localItem){if(localItem.isDeleted){try{g.PAssert(3640,g.isReconnected||!localModel,"The local model should never exist when an item has been marked as deleted locally")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3641,localItem.modifiedOffline,"How did the note get deleted if it wasn't modified offline?")}catch(PERR){g.reportError(PERR)}gdata.getVersion(remoteItem,VersionType.Structure)==localItem.version?gdata.noteSet(this,void 0):(localModel=d.createVMLI({data:remoteItem,isNote:!0},{parent:this,changeType:ChangeType.Remote}),d.undeleteItem(localModel,ChangeType.AllRemote),this.setNote(localModel,ChangeType.AllRemote),g.vmMain.addModifiedItem(localModel,ChangeType.AllRemote))}}else localModel=d.createVMLI({data:remoteItem,isNote:!0},{parent:this,changeType:ChangeType.Remote}),this.setNote(localModel,ChangeType.AllRemote),g.vmMain.addModifiedItem(localModel,ChangeType.AllRemote)}else localModel&&(d.initializeItem(localModel),gdata.noteSet(this,localModel))},resolveItemsHelper:function resolveItemsHelperFn(resolveArchived,remoteChanges){var i,remoteItem,localIndex,localItem,localModel,saveItemLists,collabItemList=gdata.getItemList(this.data,resolveArchived),itemArray;itemArray=resolveArchived?this.hasArchivedChildren()?this.archivedItems(!0):[]:this.getItems();try{g.PAssert(3642,itemArray,"Item arrays must exist")}catch(PERR){g.reportError(PERR)}for(i=0;collabItemList&&i<collabItemList.length;i++)if(remoteItem=collabItemList.get(i)){try{g.PAssert(3644,void 0===gdata.loadSeen[remoteItem.id]||gdata.loadSeen[remoteItem.id]===!1,"Items can only be seen once on the remote.")}catch(PERR){g.reportError(PERR)}gdata.loadSeen[remoteItem.id]=this.id;var localIndex=this.getIndexOf(remoteItem.id,resolveArchived);if(localIndex>=0)localModel=itemArray[localIndex],localModel.initFromGDrive(remoteItem);else if(localItem=d.getItem(remoteItem.id),localModel=d.getModel(remoteItem.id),localItem)if(localItem.isDeleted){try{g.PAssert(3646,localItem.modifiedOffline,"How did the item get deleted if it wasn't modified offline?")}catch(PERR){g.reportError(PERR)}if(gdata.getVersion(remoteItem,VersionType.Structure)==localItem.version){gdata.itemRemoved({item:this,index:i,numToRemove:1,isArchived:resolveArchived});var childItem;i--}else{if(localModel){try{g.PAssert(3647,void 0===localModel.parent(),"Should never have a parent if deleted")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3648,localModel.data===remoteItem,"Local model should match remote data")}catch(PERR){g.reportError(PERR)}localModel.parent(this)}else localModel=d.createVMLI({data:remoteItem,isArchived:resolveArchived},{parent:this,changeType:ChangeType.Remote});d.undeleteItem(localModel,ChangeType.Remote),itemArray.splice(i,0,localModel),saveItemLists=!0,g.vmMain.addModifiedItem(localModel,ChangeType.Remote|ChangeType.Structure)}}else if(localModel&&localModel.modifiedOffline)if(localModel.isLocalVersionNewer(VersionType.Structure)){try{g.PAssert(3649,gdata.loadSeen[remoteItem.id]===this.id)}catch(PERR){g.reportError(PERR)}gdata.loadSeen[remoteItem.id]=!1}else localModel.moveTo({parent:this,index:i,shouldBeArchived:resolveArchived},ChangeType.Remote),localModel.initFromGDrive(remoteItem),saveItemLists=!0,g.vmMain.addModifiedItem(localModel,ChangeType.Remote|ChangeType.Structure);else localModel?(localModel.moveTo({parent:this,index:i,shouldBeArchived:resolveArchived},ChangeType.Remote),localModel.initFromGDrive(remoteItem),saveItemLists=!0,g.vmMain.addModifiedItem(localModel,ChangeType.Remote|ChangeType.Structure)):g.reportError(new Error("Local model does not exist for local item that was not deleted."));else{try{g.PAssert(3645,!localModel,"The local model should never exist if there is no corresponding item entry")}catch(PERR){g.reportError(PERR)}localModel=d.createVMLI({data:remoteItem,isArchived:resolveArchived},{parent:this,changeType:ChangeType.Remote}),itemArray.splice(i,0,localModel),saveItemLists=!0,g.vmMain.addModifiedItem(localModel,ChangeType.AllRemote)}}else try{g.PAssert(3643,remoteItem,"Item in remote list does not exist")}catch(PERR){g.reportError(PERR)}if(d.hasLocalData){for(i=0;i<itemArray.length;i++)if(localModel=itemArray[i],gdata.loadSeen[localModel.id]!==this.id)if(remoteItem=localModel.data){if(localModel.modifiedOffline&&localModel.isLocalVersionNewer(VersionType.Structure)){var inTree=gdata.findInTree(remoteItem);if(inTree){var oldParentModel;gdata.itemMoved({item:localModel,newInfo:{index:i,isArchived:resolveArchived},oldParent:inTree.parent,oldInfo:inTree})}else{var remoteDeletedItem=gdata.getDeletedCacheItem(remoteItem.id);if(remoteDeletedItem){try{g.PAssert(3656,!gdata.getItemParent(remoteDeletedItem),"Deleted items should never have parents")}catch(PERR){g.reportError(PERR)}gdata.restoreDeletedItem(remoteItem.id),gdata.itemAdded({item:this,addedItem:remoteItem,index:i,isArchived:resolveArchived})}}localModel.initFromGDrive(remoteItem)}}else if(localModel.modifiedOfflineText){var childrenToRemove=[],localChildren;if(resolveArchived?localModel.hasArchivedChildren()&&(localChildren=localModel.archivedItems(!0)):localChildren=localModel.getItems(),localChildren)for(var j=0;j<localChildren.length;++j)if(localChildren[j].data&&localChildren[j].isLocalVersionNewer(VersionType.Structure)){var inTree=gdata.findInTree(localChildren[j].data);try{g.PAssert(3651,inTree,"Item should be found in tree")}catch(PERR){g.reportError(PERR)}inTree&&childrenToRemove.push({parent:inTree.parent,child:localChildren[j]})}d.initializeItem(localModel),gdata.itemAdded({item:this,addedItem:localModel,index:i,isArchived:resolveArchived});for(var j=0;j<childrenToRemove.length;++j){var removeData=childrenToRemove[j];try{g.PAssert(3652,removeData,"Must have valid data to remove")}catch(PERR){g.reportError(PERR)}var isArchived=removeData.child.isArchived(),remoteList=gdata.getItemList(removeData.parent,isArchived);try{g.PAssert(3653,remoteList,"The item has children, it must have a list")}catch(PERR){g.reportError(PERR)}var index=remoteList.indexOf(removeData.child.data);try{g.PAssert(3654,index>=0,"Remote item must be in the parents list")}catch(PERR){g.reportError(PERR)}gdata.itemRemoved({item:removeData.parent,index:index,numToRemove:1,isArchived:isArchived})}localModel.initFromGDrive(localModel.data)}else{try{g.PAssert(3655,d.getItem(localModel.id),"Trying to delete an item locally that doesn't exist locally")}catch(PERR){g.reportError(PERR)}this.deleteChild(localModel,void 0,void 0,ChangeType.Remote),i--,saveItemLists=!0,g.vmMain.addModifiedItem(localModel,ChangeType.Remote|ChangeType.Structure)}if(!resolveArchived&&collabItemList&&(collabItemList.length>0||itemArray.length>0)){var localModArray=[],nonSharedArray,tempArray=[],remoteArray=collabItemList.asArray(),reorderFound=!1;for(i=0;i<remoteArray.length;++i){var tempID=remoteArray[i].id;if(!tempID)try{g.PAssert(3657,tempID,"Item in list without an ID defined: "+JSON.stringify(remoteArray[i]))}catch(PERR){g.reportError(PERR)}var tempModel=d.getModel(tempID);try{g.PAssert(3658,tempModel,"If the remote ID exists the local item should have been created.")}catch(PERR){g.reportError(PERR)}var localIndex=this.getIndexOf(tempID);tempModel&&tempModel.modifiedOffline&&tempModel.isLocalVersionNewer(VersionType.Structure)?localIndex>=0?localModArray.push(localIndex):(nonSharedArray||(nonSharedArray=[]),log(this.id+": Item in remote array not found in local array: ",tempID),nonSharedArray.push(tempID)):localIndex>=0?(tempArray.push(tempID),localIndex!==i&&(reorderFound=!0)):(nonSharedArray||(nonSharedArray=[]),log(this.id+": Item in remote array not found in local array: ",tempID),nonSharedArray.push(tempID))}if(reorderFound||localModArray.length>0){var tempArrayText;for(localModArray.sort(g.numberComparator),i=0;i<localModArray.length;i++){var localItem=itemArray[localModArray[i]];localItem&&tempArray.splice(localModArray[i],0,localItem.id);var tempArrayText}nonSharedArray&&nonSharedArray.length>0&&(tempArray=tempArray.concat(nonSharedArray));var remoteArrayText,localArrayText,tempArrayText,remoteArrayText;for(i=0;i<tempArray.length;++i)for(var searchItem=tempArray[i],j=i;j<collabItemList.length;++j){var findItem=collabItemList.get(j);if(searchItem===findItem.id){if(i!==j){var lModel=d.getModel(findItem.id),oldInfo={index:j,isArchived:!1},newInfo={index:i,isArchived:!1};gdata.itemMoved({item:lModel,newInfo:newInfo,oldParent:this,oldInfo:oldInfo}),saveItemLists=!0,g.vmMain.addModifiedItem(lModel,ChangeType.Remote|ChangeType.Structure);var remoteArrayText}break}}var localArrayText;for(i=0;i<tempArray.length;++i)for(var searchItem=tempArray[i],j=i;j<itemArray.length;++j){var findItem=itemArray[j];if(searchItem===findItem.id){if(i!==j){findItem.moveTo({parent:this,index:i,shouldBeArchived:!1},ChangeType.Remote),saveItemLists=!0,g.vmMain.addModifiedItem(findItem,ChangeType.Remote|ChangeType.Structure);var localArrayText}break}}}}}saveItemLists&&(resolveArchived?this.hasArchivedChildren()&&this.archivedItems().notify():this.getItemStore().updateItems(),resolveArchived&&!this.hasArchivedChildren()&&this.archivedItems().set(itemArray),remoteChanges&&(remoteChanges.items=this.getItemsArrayForSave(),remoteChanges.version=this.getRemoteVersion(VersionType.Structure)))},resolveItems:function resolveItemsFn(remoteChanges){this.resolveItemsHelper(!1,remoteChanges),this.resolveItemsHelper(!0,remoteChanges),this.resolveNote(remoteChanges)},isMoveEvent:function isMoveEventFn(event){var isMoveEvent=!1;return event.type===gapi.drive.realtime.EventType.VALUES_ADDED?isMoveEvent=void 0!==event.movedFromList&&null!==event.movedFromList:event.type===gapi.drive.realtime.EventType.VALUES_REMOVED&&(isMoveEvent=void 0!==event.movedToList&&null!==event.movedToList),isMoveEvent},isLocalEvent:function isLocalEventFn(event){var isLocal=event.isLocal;if(tracker.undoRedoActive)try{g.PAssert(3664,isLocal,"Must be a local event during undo/redo")}catch(PERR){g.reportError(PERR)}return isLocal},onValueChanged:function onValueChangedFn(event){if(!event.isLocal||tracker.undoRedoActive){var mappedProperty=g.translateFieldOut(event.property);if(this.id===event.target.id){var changeType=this.changeTypeFromEvent(event)|ChangeType.Property,needsParse=!1;switch(mappedProperty){case"version":case"versionText":var localProperty="_"+mappedProperty,remoteVersion=gdata.get(this.data,mappedProperty);if(remoteVersion>this[localProperty]||void 0===this[localProperty]){var changes={};"version"===mappedProperty?changes.modifiedOffline=!1:"versionText"===mappedProperty&&(changes.modifiedOfflineText=!1),changes[mappedProperty]=this[localProperty]=remoteVersion,this.save(changes,SaveFlag.None)}break;case"priority":this.priority(event.newValue,changeType);break;case"isComplete":this.isComplete(event.newValue,changeType);break;case"isStarred":this.isStarred(event.newValue,changeType);break;case"dateCompleted":this.dateCompleted=event.newValue?new Date(event.newValue):null,this.save({dateCompleted:event.newValue},SaveFlag.None),needsParse=!0;break;case"isArchived":this.isArchived(event.newValue,changeType),this.save({isArchived:event.newValue},SaveFlag.None);break;case"date":this.date(event.newValue?new Date(event.newValue):null,changeType),this.save({date:event.newValue},SaveFlag.None);break;case"repeatDate":var newRepeatDate=event.newValue?new RepeatDate(event.newValue):null;!newRepeatDate||newRepeatDate.isValid()?(this.repeatDate(newRepeatDate,changeType),this.save({repeatDate:event.newValue},SaveFlag.None),needsParse=!0):g.reportError(new Error("Remote invalid repeat date: "+event.newValue));break;case"allDayDate":break;case"note":event.newValue?this.addRemoteNote(event.newValue,changeType):this.hasNote()&&this.removeRemoteNote(changeType);break;case"items":case"archivedItems":var isArchived=!("items"===mappedProperty);if(event.newValue)for(var i=0;i<event.newValue.length;++i){var listValue=event.newValue.get(i);this.addRemoteItem(listValue,i,isArchived,changeType)}else{try{g.PAssert(3666,0===event.oldValue.length,"Expected no items in list")}catch(PERR){g.reportError(PERR)}this.removeAllRemoteItems(isArchived)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None);break;case"dateCreated":break;case"text":this.onTextChanged(event);break;default:ShouldLog(LogLevels.Error)&&log("Unhandled value changed remotely: ",mappedProperty,event)}needsParse&&this.parseText(!0,changeType)}}},onTextChanged:function onTextChangedFn(event){if(!event.isLocal||tracker.undoRedoActive){var changeType=this.changeTypeFromEvent(event)|ChangeType.Text,remoteText=gdata.get(this.data,"text");if(remoteText!==this.getRawText()&&(this.setText(remoteText,!0,changeType),tracker.undoRedoActive)){var evType=TrackerType.SetText;tracker.notifyStateChangedFromUndoRedo(evType,{itemID:this.id,position:g.findFirstDiff(event.newValue,event.oldValue,!1,!0),text:event.newValue})}}},addRemoteItem:function addRemoteItemFn(remoteItem,index,isArchived,changeType){gdata.cacheItem(remoteItem);var remoteID=remoteItem.id,localList=isArchived?this.archivedItems():this.items,localListUnderlying=localList.get();if(index<localListUnderlying.length&&localListUnderlying[index].id===remoteID)return void log("Skipping addRemoteItem - "+index+" vs. "+localListUnderlying.length);var vmli=d.getModel(remoteID);vmli||(vmli=d.createVMLI({data:remoteItem},{parent:this,changeType:changeType})),gdata.setItemParent(remoteItem,this.data),vmli.isDeleted()&&(vmli.isDeleted(!1,changeType),vmli.save(null,SaveFlag.None)),vmli.isArchived()!==isArchived&&(vmli.isArchived(isArchived,ChangeType.Remote),vmli.save({isArchived:isArchived},SaveFlag.None)),vmli.parent(this),localList.splice(index,0,vmli),tracker.undoRedoActive&&tracker.notifyStateChangedFromUndoRedo(TrackerType.Create,{itemID:vmli.id,parent:this.id,position:index,text:gdata.get(remoteItem,"text")})},removeAllRemoteItems:function removeAllRemoteItemsFn(isArchived){var itemList;if(isArchived?this.hasArchivedChildren()&&(itemList=this.archivedItems(),itemList.set([])):(itemList=this.items,itemList.set([])),itemList)for(var i=0;i<itemList.get().length;++i)gdata.setItemParent(itemList.get()[i],void 0)},removeRemoteItem:function removeRemoteItemFn(remoteItem,index,isArchived,isActualDelete,changeType){var localList;if(isArchived){try{g.PAssert(3667,this.hasArchivedChildren(),"Must have a valid item list to remove from")}catch(PERR){g.reportError(PERR)}localList=this.archivedItems()}else localList=this.items;var localItem=localList.get()[index];if(localItem&&localItem.id===remoteItem.id){try{g.PAssert(3668,localItem,"Expect a valid local item to remove")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3669,remoteItem.id===localItem.id,"Remote item should match local items")}catch(PERR){g.reportError(PERR)}if(isActualDelete&&(gdata.setItemParent(remoteItem,void 0),gdata.removeItemFromCache(remoteItem.id)),tracker.undoRedoActive){var prevItem=g.getPreviousItem(localItem);tracker.notifyStateChangedFromUndoRedo(TrackerType.Delete,{itemID:localItem.id,parent:this.id,position:index,previous:prevItem?prevItem.id:void 0})}localList.splice(index,1),isActualDelete&&d.deleteItem(localItem,changeType)}},addRemoteNote:function addRemoteNoteFn(remoteNote,changeType){try{g.PAssert(3670,!this.hasNote(),"State of note should always match when adding")}catch(PERR){g.reportError(PERR)}var remoteID=remoteNote.id;gdata.cacheItem(remoteNote);var vmli=d.getModel(remoteID);vmli||(vmli=d.createVMLI({data:remoteNote,isNote:!0},{parent:this,changeType:changeType}));try{g.PAssert(3671,vmli.isNote(),"Must always be a valid note")}catch(PERR){g.reportError(PERR)}vmli.parent(this),vmli.isDeleted()&&(vmli.isDeleted(!1,changeType),vmli.save(null,SaveFlag.None)),this.setNote(vmli,changeType)},removeRemoteNote:function removeRemoteNoteFn(changeType){try{g.PAssert(3672,this.hasNote(),"State of note should always match when removing")}catch(PERR){g.reportError(PERR)}var localNote=this.getNote();this.setNote(void 0,changeType),localNote.isDeleted()||d.deleteItem(localNote,changeType)},onListAdded:function onListAddedFn(event){if(!event.isLocal||tracker.undoRedoActive){gdata.numChanges++;var changeType=this.changeTypeFromEvent(event),areItemsArchived=!1,isValidTarget=!0,remoteItemList=gdata.get(this.data,"items");if(remoteItemList&&event.target.id===remoteItemList.id)isValidTarget=event.target.id===remoteItemList.id;else{var remoteArchivedList=gdata.get(this.data,"archivedItems");remoteArchivedList&&event.target.id===remoteArchivedList.id&&(areItemsArchived=!0),isValidTarget=remoteArchivedList&&event.target.id===remoteArchivedList.id}if(!isValidTarget)return void log("Skipping list add due to invalid target");var getRemoteFn,startIndex,endIndex;event.values.length>0?(startIndex=event.index,endIndex=startIndex+event.values.length,getRemoteFn=function(index){return event.values[index]}):(startIndex=0,endIndex=event.target.length,getRemoteFn=function(index){return event.target.get(index)});for(var isMoveEvent=this.isMoveEvent(event),i=startIndex;endIndex>i;++i){var eventIndex=i-startIndex,remoteItem=getRemoteFn(eventIndex);try{g.PAssert(3675,remoteItem,"Always expect a valid item at each index")}catch(PERR){g.reportError(PERR)}this.addRemoteItem(remoteItem,i,areItemsArchived,changeType)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None),this._selectionBeforeBlur=void 0}},onListRemoved:function onListRemovedFn(event){if(!event.isLocal||tracker.undoRedoActive){var changeType=this.changeTypeFromEvent(event);gdata.numChanges++;var idx,remoteItem,debugLocalItem,localText,areItemsArchived=!1,isValidTarget=!0,remoteItemList=gdata.get(this.data,"items");if(remoteItemList&&event.target.id===remoteItemList.id)isValidTarget=event.target.id===remoteItemList.id;else{var remoteArchivedList=gdata.get(this.data,"archivedItems");remoteArchivedList&&event.target.id===remoteArchivedList.id&&(areItemsArchived=!0),isValidTarget=remoteArchivedList&&event.target.id===remoteArchivedList.id}if(!isValidTarget)return void log("Skipping list remove due to invalid target");for(var startIndex=event.index,endIndex=startIndex+event.values.length,isMoveEvent=this.isMoveEvent(event),i=endIndex-1;i>=startIndex;i--){var eventIndex=i-startIndex;try{g.PAssert(3681,!!event.values[eventIndex],"Always expect a valid item at each index")}catch(PERR){g.reportError(PERR)}var remoteItem=event.values[eventIndex];this.removeRemoteItem(remoteItem,i,areItemsArchived,!isMoveEvent,changeType)}this.save({items:this.getItemsArrayForSave()},SaveFlag.None),this._selectionBeforeBlur=void 0}},onListSet:function onListSetFn(event){try{g.PAssert(3682,!1,"What? This shouldn't happen!",event)}catch(PERR){g.reportError(PERR)}},onObjectChanged:function onObjectChangedFn(event){if(event.ocHandled)return ShouldLog(LogLevels.Warning|LogLevels.Verbose)&&log("Event Already Handled: ",event.ocHandled,"-",this.id,event.events[0].type),!1;gdata.numChanges++,event.ocHandled=this.id,event.stopPropagation();var i,ev;if(event.isLocal&&!tracker.undoRedoActive)return!1;gdata.lastChangeTime=Date.now();var savedSelection;tracker.undoRedoActive||(savedSelection=Sel.save(),Sel.reset()),g.vmMain.beginUpdateItems();for(var i=0;i<event.events.length;++i){var e=event.events[i];if(e.ocHandled)log("Sub-Event Already Handled: ",e.ocHandled,"-",this.id,e.type);else switch(e.ocHandled=this.id,e.type){case gapi.drive.realtime.EventType.TEXT_DELETED:this.onTextChanged(e);break;case gapi.drive.realtime.EventType.TEXT_INSERTED:this.onTextChanged(e);break;case gapi.drive.realtime.EventType.VALUES_ADDED:this.onListAdded(e);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:this.onListRemoved(e);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:this.onValueChanged(e);break;case gapi.drive.realtime.EventType.VALUES_SET:try{g.PAssert(3683,!1,"VALUES_SET should never be triggered")}catch(PERR){g.reportError(PERR)}break;default:try{g.PAssert(3684,!1,"Unexpected event type")}catch(PERR){g.reportError(PERR)}}}return g.vmMain.commitUpdateItems(),savedSelection&&Sel.restore(savedSelection,!0),!1}}};return VMLI_Drive}),define("sounds",["globals","platform"],function(g,platform){function addSource(sound,src){var source=document.createElement("source");source.src=src,sound.appendChild(source)}var self={},bank={};return self.add=function addFn(name){if(self[name]=name,!bank[name]){var sound=document.createElement("audio");addSource(sound,"sounds/"+name+".mp3"),sound.preload="auto",bank[name]=sound}},self.play=function playFn(name){if(!g.settings.get(Settings.noSounds)){if(!bank[name])return log("Tried to play a sound that has not been loaded:",name),void console.trace();try{bank[name].play()}catch(err){log("Failed to play audio",err)}}},self}),define("International",["platform","globals"],function(platform,g){function International(){this._currentLanguage="en-US",this._supportedLanguages=["en-US","en-GB"],this._languages={},this._localized=[],this.init()}return window.DFormat={LongDayTime:0,ShortDayTime:1,ShortTime:2,ShortDate:3,MonthDay:4,MonthDayYear:5,LongStrDate:6,DayYearTime:7,MonthDayYearShort:8},International.prototype={init:function initFn(){this._loadLanguages();var browserLang=navigator.language||navigator.userLanguage;browserLang!==this._currentLanguage&&this._supportedLanguages[browserLang]&&(this._currentLanguage=browserLang,this._loadLanguage()),this._loadLocalized()},setLanguage:function setLanguageFn(lcode,cb){lcode!==this._currentLanguage&&this._supportedLanguages.indexOf(lcode)>=0&&(this._currentLanguage=lcode,this._loadLanguage(cb))},getCurrentLanguageCode:function getCurrentLanguageCodeFn(){return this._currentLanguage},getCurrentLanguagePack:function getCurrentLanguagePackFn(){try{g.PAssert(3685,this._languages[this._currentLanguage],"Invalid language request")}catch(PERR){g.reportError(PERR)}return this._languages[this._currentLanguage]},getFormat:function getFormatFn(format){try{g.PAssert(3686,this._localized[format],"Invalid format request")}catch(PERR){g.reportError(PERR)}return this._localized[format]},_loadLanguage:function _loadLanguageFn(cb){var loadLanguage=this._currentLanguage;try{g.PAssert(3687,this._languages[loadLanguage],"Languages must always be loaded")}catch(PERR){g.reportError(PERR)}log("Set Language: ",loadLanguage),Date.CultureStrings=Date.CultureStrings||{},Date.CultureStrings[loadLanguage]=this._languages[loadLanguage],g.vmMain.notifyLanguageUpdated(),Date.i18n.setLanguage(loadLanguage,!1,function(){cb&&cb(),this._loadLocalized()}.bind(this))},_loadLocalized:function _loadLocalizedFn(){this._localized[DFormat.LongDayTime]="dddd "+Date.CultureInfo.formatPatterns.shortTime,this._localized[DFormat.ShortDayTime]=Date.CultureInfo.formatPatterns.monthDayShortTime+" "+Date.CultureInfo.formatPatterns.shortTime,this._localized[DFormat.ShortTime]=Date.CultureInfo.formatPatterns.shortTime,this._localized[DFormat.ShortDate]=Date.CultureInfo.formatPatterns.monthDayShortTime,this._localized[DFormat.MonthDay]="MMM d",this._localized[DFormat.MonthDayYear]=Date.CultureInfo.formatPatterns.monthDayYear,this._localized[DFormat.MonthDayYearShort]="M/d/yy",this._localized[DFormat.LongStrDate]="MMMM dd, yyyy",this._localized[DFormat.DayYearTime]="MM/dd/yy h:mm tt"},_loadLanguages:function _loadLanguagesFn(){this._languages["en-US"]={},this._languages["en-GB"]={name:"en-GB",englishName:"English (United Kingdom)",nativeName:"English (United Kingdom)",Sunday:"Sunday",Monday:"Monday",Tuesday:"Tuesday",Wednesday:"Wednesday",Thursday:"Thursday",Friday:"Friday",Saturday:"Saturday",Sun:"Sun",Mon:"Mon",Tue:"Tue",Wed:"Wed",Thu:"Thu",Fri:"Fri",Sat:"Sat",Su:"Su",Mo:"Mo",Tu:"Tu",We:"We",Th:"Th",Fr:"Fr",Sa:"Sa",S_Sun_Initial:"S",M_Mon_Initial:"M",T_Tue_Initial:"T",W_Wed_Initial:"W",T_Thu_Initial:"T",F_Fri_Initial:"F",S_Sat_Initial:"S",January:"January",February:"February",March:"March",April:"April",May:"May",June:"June",July:"July",August:"August",September:"September",October:"October",November:"November",December:"December",Jan_Abbr:"Jan",Feb_Abbr:"Feb",Mar_Abbr:"Mar",Apr_Abbr:"Apr",May_Abbr:"May",Jun_Abbr:"Jun",Jul_Abbr:"Jul",Aug_Abbr:"Aug",Sep_Abbr:"Sep",Oct_Abbr:"Oct",Nov_Abbr:"Nov",Dec_Abbr:"Dec",AM:"AM",PM:"PM",firstDayOfWeek:1,twoDigitYearMax:2029,mdy:"dmy","M/d/yyyy":"dd/MM/yyyy","dddd, MMMM dd, yyyy":"dd MMMM yyyy","h:mm tt":"HH:mm","h:mm:ss tt":"HH:mm:ss","dddd, MMMM dd, yyyy h:mm:ss tt":"dd MMMM yyyy HH:mm:ss","yyyy-MM-ddTHH:mm:ss":"yyyy-MM-ddTHH:mm:ss","yyyy-MM-dd HH:mm:ssZ":"yyyy-MM-dd HH:mm:ssZ","ddd, dd MMM yyyy HH:mm:ss":"ddd, dd MMM yyyy HH:mm:ss","MMMM dd":"dd MMMM","MM/dd":"dd/MM","MM/dd/yy":"dd/MM/yy","MMMM, yyyy":"MMMM yyyy","/jan(uary)?/":"jan(uary)?","/feb(ruary)?/":"feb(ruary)?","/mar(ch)?/":"mar(ch)?","/apr(il)?/":"apr(il)?","/may/":"may","/jun(e)?/":"jun(e)?","/jul(y)?/":"jul(y)?","/aug(ust)?/":"aug(ust)?","/sep(t(ember)?)?/":"sep(t(ember)?)?","/oct(ober)?/":"oct(ober)?","/nov(ember)?/":"nov(ember)?","/dec(ember)?/":"dec(ember)?","/^sun(day)?/":"^sun(day)?","/^mon(day)?/":"^mon(day)?","/^tue(s(day)?)?/":"^tue(s(day)?)?","/^wed(nesday)?/":"^wed(nesday)?","/^thu(rsday)?/":"^thu(rsday)?","/^fri(day)?/":"^fri(day)?","/^sat(urday)?/":"^sat(urday)?","/^next/":"^next","/^last|past|prev(ious)?/":"^last|past|prev(ious)?","/^yesterday/":"^yesterday","/^today/":"^today","/^tom(orrow)?/":"^tom(orrow)?","/^soon/":"^soon","/^later/":"^later","/^someday/":"^someday","/^now/":"^now","/^(a|p)/":"^(a|p)","/^(a\\.?m?\\.?|p\\.?m?\\.?)/":"^(a\\.?m?\\.?|p\\.?m?\\.?)","/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\\s*(\\+|\\-)\\s*\\d\\d\\d\\d?)|gmt|utc)/":"^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\\s*(\\+|\\-)\\s*\\d\\d\\d\\d?)|gmt|utc)","/^\\s*(st|nd|rd|th)/":"^\\s*(st|nd|rd|th)","/^\\s*(\\:|a(?!u|p)|p)/":"^\\s*(\\:|a(?!u|p)|p)","/(this )(morn(ing)?)\\b/":"(this )(morn(ing)?)\\b","/(this )(even(ing)?)\\b/":"(this )(even(ing)?)\\b",LINT:"LINT",TOT:"TOT",CHAST:"CHAST",NZST:"NZST",NFT:"NFT",SBT:"SBT",AEST:"AEST",ACST:"ACST",JST:"JST",CWST:"CWST",CT:"CT",ICT:"ICT",MMT:"MMT",BIOT:"BST",NPT:"NPT",IST:"IST",PKT:"PKT",AFT:"AFT",MSK:"MSK",IRST:"IRST",FET:"FET",EET:"EET",CET:"CET",UTC:"UTC",GMT:"GMT",CVT:"CVT",GST:"GST",BRT:"BRT",NST:"NST",AST:"AST",EST:"EST",CST:"CST",MST:"MST",PST:"PST",AKST:"AKST",MIT:"MIT",HST:"HST",SST:"SST",BIT:"BIT",CHADT:"CHADT",NZDT:"NZDT",AEDT:"AEDT",ACDT:"ACDT",AZST:"AZST",IRDT:"IRDT",EEST:"EEST",CEST:"CEST",BST:"BST",PMDT:"PMDT",ADT:"ADT",NDT:"NDT",EDT:"EDT",CDT:"CDT",MDT:"MDT",PDT:"PDT",AKDT:"AKDT",HADT:"HADT"}}},new International}),define("Favorites",["require","exports","module","globals","Constants"],function(require,exports,module){function Favorites(){this._favMap={}}var g=require("globals"),C=require("Constants");return Favorites.prototype={_ensureGroup:function _ensureGroupFn(group){var groupObj=[];return this._favMap[group]||(this._favMap[group]=groupObj),groupObj},notifyAdd:function notifyAddFn(item,group){var groupObj=this._ensureGroup(group);try{g.PAssert(3688,groupObj.indexOf(item)<0,"Should not double add item to group")}catch(PERR){g.reportError(PERR)}groupObj.push(item)},notifyRemove:function notifyRemoveFn(item,group){var groupObj=this._ensureGroup(group);try{g.PAssert(3689,groupObj.indexOf(item)>=0,"Must have been added to group before removing")}catch(PERR){g.reportError(PERR)}groupObj.remove(item)},getItems:function getItemsFn(group){return this._favMap[group]},hasItems:function hasItemsFn(group){var items=this.getItems(group);return items&&items.length>0}},new Favorites}),define("VMLI",["ko","globals","util","platform","data","gdata","android","VMLI_TapHandlers","VMLI_Text","VMLI_Drive","tracker","sounds","RepeatDate","International","Observable","ObservableArray","Trigger","Dispatcher","DisplaySettings","Favorites","Measure","Sel"],function(ko,g,util,platform,d,gdata,android,VMLI_TapHandlers,VMLI_Text,VMLI_Drive,tracker,sounds,RepeatDate,International,Observable,ObservableArray,Trigger,Dispatcher,DisplaySettings,Favorites,Measure,Sel){function VMLI(p,extraInfo){this.isInitialized=!1;try{g.PAssert(3690,extraInfo,"Each VMLI must be given a set of additional info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3691,g.isValidChangeType(extraInfo.changeType),"Must specify a valid change type when creating a VMLI")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3692,extraInfo.store,"Must supply a valid itemStore for each VMLI")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3693,!extraInfo.parent||extraInfo.parent._store===extraInfo.store,"All VMLIs in a tree must share the same owner")}catch(PERR){g.reportError(PERR)}if(this.__TEMP_InitCalled=!1,this.__TEMP_InitParseCalled=!1,this.__TEMP_ParseCalled=!1,this.__TEMP_SkippedInitParsed=!1,!p.id&&p.data&&p.data.id)p.id=p.data.id;else if(p.id&&p.data)try{g.PAssert(3694,p.id===p.data.id,"If passing in a local id and a remote ID, they should match")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3695,void 0===p.v,"We should never be passing in 'v'")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3696,void 0===p.extern,"We should never be passing in 'extern'")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3697,extraInfo.store,"Must specify a valid item store this item belongs to")}catch(PERR){g.reportError(PERR)}this._store=extraInfo.store,this._parent=extraInfo?extraInfo.parent:void 0,this._rawText=p.data?"":p.text,this._searchText=p.data?"":p.text?p.text.toLowerCase():"",this._parsedText=void 0,this.els=void 0,this._isArchived=p.isArchived||!1,this._numArchivedAncestors=this._parent?this._parent._numArchivedAncestors+(this._parent.isArchived()?1:0):0,this._numArchivedDescendants=0,this._isArchived&&this._notifyAncestorsArchived(!0),util.forceBind("itemsHasMutated",this),this.items=new ObservableArray([],this.itemsHasMutated),this._note=void 0,this.itemChanged=new Trigger,this._archivedItems=void 0,this._demandLoadChildren=p.demandLoadChildren||!1,this._loadedOnDemandData=!this._demandLoadChildren,this._paginationToken=void 0,this._canDestroy=extraInfo.canDestroy||!1,this._destroyed=!1,this._date=void 0,this._dateTempForced=void 0,this._repeatDate=void 0,this._attachments=void 0,this.draggedInPane=new Observable(!1);
var origFlags=VMLIFlag.None;p.isComplete&&(origFlags|=VMLIFlag.Complete),p.isStarred&&(origFlags|=VMLIFlag.Starred),p.isNote&&(origFlags|=VMLIFlag.Note),p.isArchived&&(origFlags|=VMLIFlag.Archived),p.priority&&(origFlags|=p.priority),this.flags=new Observable(origFlags),this._favorites=void 0,this.dateText=p.dateText,this.dateCreated=p.dateCreated?new Date(p.dateCreated):new Date,this.dateCompleted=p.dateCompleted?new Date(p.dateCompleted):void 0,this._durationMS=p.duration,this._durationText=p.durationText,this._activeTags=void 0,this._isDeleted=p.isDeleted||!1,this.modifiedOffline=void 0,this.modifiedOfflineText=void 0,this.highlightTimeout=void 0,this.data=void 0,this._version=window.UninitializedVersion,this._versionText=window.UninitializedVersion,this._versionRemote=void 0,this._versionRemoteText=void 0,this.lastFindPass=0,this.isEditable=new Observable(!0),this.levelsDeep=new Observable(this._parent?this._parent.levelsDeep.get()+1:0),this.isHighlighted=new Observable,window.__TOTAL_ITEMS++,p.isArchived&&window.__TOTAL_ARCHIVED_ITEMS++,this._needsParse=!1,this.isLoaded=void 0,this.init(p,extraInfo),util.forceBind("dragScroll",this),util.forceBind("onTouchHoldTimeout",this),util.forceBind("heightInPane",this),this.isInitialized=!0}window.__TOTAL_ITEMS=0,window.__TOTAL_ARCHIVED_ITEMS=0,window.__TOTAL_ARCHIVE_PARENTS=0;var forceCompleteDate=new Date(9e12);return VMLI.prototype={getReactKey:function getReactKeyFn(){return this._store.id+this.id},notifyDemandLoadUpdate:function notifyDemandLoadUpdateFn(showItems,pane){showItems&&!this._loadedOnDemandData&&(pane.requestDemandLoadData(this),this.notifyLoadedData())},notifyLoadedData:function notifyLoadedDataFn(){this._loadedOnDemandData=!0},notifyLoadDataFailed:function notifyLoadDataFailedFn(pane){this.setCollapsed(!1,pane,!1),this._loadedOnDemandData=!1},isDemandLoad:function isDemandLoadFn(){return this._demandLoadChildren},isDemandNotYetLoaded:function isDemandNotYetLoadedFn(){return this._demandLoadChildren&&!this._loadedOnDemandData},showInOverview:function showInOverviewFn(includeArchived){return this.numItems()>0||this._demandLoadChildren||includeArchived&&this.hasArchivedChildren()},paginationTokenInUse:function paginationTokenInUseFn(){try{g.PAssert(3698,this._paginationToken,"Should always have a valid pagination token when beginning to load a data page")}catch(PERR){g.reportError(PERR)}return this._paginationToken.isInUse()},hasPaginationToken:function hasPaginationTokenFn(){return!!(this.flags.get()&VMLIFlag.HasPageToken)},needsPaginationToken:function needsPaginationTokenFn(){return!this.hasPaginationToken()&&!this._paginationToken},setPaginationToken:function setPaginationTokenFn(token){try{g.PAssert(3699,token,"Should never be setting an undefined token - use clear instead")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3700,!this._paginationToken,"Should never be overriding a pagination token - clear then set")}catch(PERR){g.reportError(PERR)}this._paginationToken=token,this.setFlags(this.flags.get()|VMLIFlag.HasPageToken)},beginDataPageLoad:function beginDataPageLoadFn(){try{g.PAssert(3702,this._paginationToken,"Should always have a valid pagination token when beginning to load a data page")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3703,!this._paginationToken.isInUse(),"Token should not already be in use when beginning a page load")}catch(PERR){g.reportError(PERR)}return this._paginationToken.notifyBeginUse(),this._paginationToken},endDataPageLoad:function endDataPageLoadFn(hasMoreData){try{g.PAssert(3705,this._paginationToken,"Should always have a valid pagination token when done loading a data page")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3706,this._paginationToken.isInUse(),"Token should always be in use when running a request")}catch(PERR){g.reportError(PERR)}hasMoreData?this._paginationToken.notifyEndUse():this.setFlags(this.flags.get()&~VMLIFlag.HasPageToken)},notifyPaginationUpdate:function notifyPaginationUpdateFn(){try{g.PAssert(3707,this._paginationToken,"Must have a valid token to get next page of data")}catch(PERR){g.reportError(PERR)}this._paginationToken&&g.focusedPane.requestDataPage(this)},createNote:function createNoteFn(){try{g.PAssert(3708,!this.isNote(),"Should never create a note on a note item")}catch(PERR){g.reportError(PERR)}var note;return this.hasNote()?note=this.getNote():(note=d.createVMLI({text:"",isNote:!0},{parent:this,forceSave:!0,changeType:ChangeType.AllLocal}),this.setNote(note,ChangeType.Local)),note},editNote:function editNoteFn(){var pane=g.focusedPane,startObj=Sel.getStartObject();if(this.isNote())Sel.selectIndex(Sel.getStartIndex(),this.getParsedText().length);else{this.hasNote()||this.createNote();var note=this.getNote(),newStart=pane.indexOfObject(startObj);Sel.selectIndex(newStart+1,note.getParsedText().length)}},hasNote:function hasNoteFn(){return void 0!==this._note},getNote:function getNoteFn(){try{g.PAssert(3709,this.hasNote(),"Must have a note to get one")}catch(PERR){g.reportError(PERR)}return this._note},setNote:function setNoteFn(note,changeType){try{g.PAssert(3710,g.isValidChangeType(changeType),"Must supply a valid changeType")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3711,!this.isNote(),"Should never set a note on a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3712,!this._note||!note,"Should never set a note multiple times on a single item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3713,!note||note.isNote(),"Should only set items that are notes as notes")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3714,!note||!note.isDeleted(),"Should note set a deleted note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3715,!note||note instanceof VMLI,"Note must be a valid VMLI")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3716,!note||note.parent()===this,"Should always have a valid parent set before setting note on item")}catch(PERR){g.reportError(PERR)}var origNote=this._note;if(this._note=note,this.shouldSave()){var newID=note?note.id:void 0;this.save({note:newID},SaveFlag.Prop),g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)&&(tracker.beginAction(),gdata.noteSet(this,note),tracker.endAction()),note||!origNote||origNote.isDeleted()||d.deleteItem(origNote,changeType)}Dispatcher.fireEvent("itemNoteSet",[{item:this}]),this.itemsHasMutated()},isNote:function isNoteFn(value){if(void 0===value)return this._isFlagHelper(VMLIFlag.Note);if(value!==this._isFlagHelper(VMLIFlag.Note)){var newFlags=value?this.flags.get()|VMLIFlag.Note:this.flags.get()&~VMLIFlag.Note;this.setFlags(newFlags)}},addFavorite:function addFavoriteFn(group,changeType){this._favorites||(this._favorites=[]);try{g.PAssert(3717,!this._favorites.indexOf(group)<0,"Must not already be in the favorites group")}catch(PERR){g.reportError(PERR)}if(this._favorites.push(group),Favorites.notifyAdd(this,group),this.shouldSave()){var saveData={favorites:this._favorites};g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)&&(gdata.saveChanges(this,saveData),saveData=g.clone(saveData)),this.save(saveData,SaveFlag.Prop)}},removeFavorite:function removeFavoriteFn(group,changeType){try{g.PAssert(3718,this._favorites,"Must always have favorites defined before removing from item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3719,!this._favorites.indexOf(group)>=0,"Must already be in the favorites group")}catch(PERR){g.reportError(PERR)}if(this._favorites.remove(group),Favorites.notifyRemove(this,group),this.shouldSave()){var saveData={favorites:this._favorites};g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)&&(gdata.saveChanges(this,saveData),saveData=g.clone(saveData)),this.save(saveData,SaveFlag.Prop)}},setFavorites:function setFavoritesFn(favorites,changeType){for(var favoritesAdded=(favorites||[]).removeArray(this._favorites),favoritesRemoved=(this._favorites||[]).removeArray(favorites),i=0;i<favoritesRemoved.length;++i)Favorites.notifyRemove(this,favoritesRemoved[i]);for(var i=0;i<favoritesAdded.length;++i)Favorites.notifyAdd(this,favoritesAdded[i]);if(this._favorites=favorites,this.shouldSave()){for(var favsToSave=[],i=0;i<favorites.length;i++)favsToSave[i]=g.clone(favorites[i],!0);var saveData={favorites:favsToSave};g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)&&(gdata.saveChanges(this,saveData),saveData=g.clone(saveData)),this.save(saveData,SaveFlag.Prop)}},getFavorites:function getFavoritesFn(){return this._favorites},shouldSave:function shouldSaveFn(){return this._shouldSave||g.isDemoMode()},canDestroy:function canDestroyFn(){return this._canDestroy},_getLineStyle:function _getLineStyleFn(){return this.flags.get()&g.LSMask},_getPriority:function _getPriorityFn(){return this.flags.get()&g.PMask},getPadding:function getPaddingFn(pane,overview){try{g.PAssert(3720,pane&&pane.getItem(),"Invalid pane")}catch(PERR){g.reportError(PERR)}if(this.isNote())return this.parent().getPadding(pane);var rootDepth=overview&&!pane.overviewTracksScroll?1:pane.getItem().levelsDeep.get(),paddingLevels=this.levelsDeep.get()-rootDepth-(overview?platform.mobile?0:pane.overviewPadLevels:1);return this.getPaddingForLevel(paddingLevels,pane,overview)},getPaddingForLevel:function getPaddingForLevelFn(level,pane,overview){level=Math.max(level,0);var padding;padding=overview?g.overviewPaddingStart+level*g.overviewPaddingIncrement:DisplaySettings.itemIndentStart(pane)+level*DisplaySettings.itemIndentSize(pane);try{g.PAssert(3721,g.isNumber(padding),"Must have a valid padding")}catch(PERR){g.reportError(PERR)}return padding},getSpanWidth:function getSpanWidthFn(pane){var padding=this.getPadding(pane),spanWidth=pane.getWidth()-padding-g.SPThresholdRight;return spanWidth},_updateStylePadding:function _updateStylePaddingFn(parentDepth,forceChange){try{g.PAssert(3722,this._parent,"Must have a valid parent to update padding, root should never change")}catch(PERR){g.reportError(PERR)}var newDepth=parentDepth+1,hasChanged=this.levelsDeep.get()!==newDepth;if(hasChanged||forceChange){hasChanged&&this.levelsDeep.set(newDepth);for(var children=this.getItems(),i=0;i<children.length;++i)children[i]._updateStylePadding(newDepth,forceChange)}},setFlags:function setFlagsFn(value){this.flags.set(value)},styleProps:function stylePropsFn(pane,blockDate){var localFlags=this.flags.get(),styleProps=this.isHeader()?"pHeader ":"";if(localFlags&VMLIFlag.Highlighted&&pane!==g.focusedPane&&(styleProps+="highlight "),localFlags&VMLIFlag.NumList&&(styleProps+="pNumList "),this.isArchived()&&(styleProps+="archived "),localFlags&VMLIFlag.Complete?(!this.repeatDate()||this.dateCompleted&&this.dateCompleted.getTime()===forceCompleteDate.getTime())&&(styleProps+="pComplete "):styleProps+=localFlags&VMLIFlag.DisplayComplete?"pComplete ":localFlags&g.PMask?g.priorityMapOut[localFlags&g.PMask]+" ":"pNormal ",localFlags&VMLIFlag.Starred&&(styleProps+="pStar "),localFlags&VMLIFlag.Note){styleProps+="pNote ";var parentFlags=this.parent().flags.get();(parentFlags&VMLIFlag.Complete||parentFlags&VMLIFlag.DisplayComplete)&&(styleProps+="pComplete "),localFlags&VMLIFlag.Multiline&&(styleProps+="multiline ")}var attachments=this.getAttachments();if(attachments)for(var i=0;i<attachments.length;++i){var attach=attachments[i];if(attach.isLoaded()){var cssClass=attach.getPlugin().getCssClass(attach);cssClass&&(styleProps+=cssClass)}}return styleProps},onAttachmentIDChange:function onAttachmentIDChangeFn(attach,oldID){this.setText(this.getParsedText(),!0,ChangeType.Local)},onAttachmentUpdate:function onAttachmentUpdateFn(attach,updateFields,changeType){attach.fieldsHaveParseEffect(updateFields)&&(Measure.clearCacheForItem(this.id),this.parseText(!0,changeType),Dispatcher.fireEvent("itemTextChanged",[{item:this}]))},setAttachments:function setAttachmentsFn(attachments,changeType){var changed=!1;if(!this._attachments&&attachments&&(this._attachments=ko.observableArray()),this._attachments){for(var thisAttachments=this._attachments(),i=0;i<thisAttachments.length;++i)attachments.indexOf(thisAttachments[i])<0&&(thisAttachments[i].unsubscribe(this),thisAttachments[i].notifyItemTextChanged(this,!0),this.shouldSave()&&thisAttachments[i].markUnused(changeType),changed=!0);for(var i=0;i<attachments.length;++i){var attach=attachments[i];if(thisAttachments.indexOf(attach)<0){if(attach.shouldBeDeleted()){var embedString=attach.getEmbedString(),newText=this.getRawText().replace(embedString,"File failed to upload");return void requestAnimationFrame(function(){this.setText(newText,!0,ChangeType.Local)}.bind(this))}attach.subscribe(this),this.shouldSave()&&attach.markInUse(changeType),changed=!0}}changed&&this._attachments(attachments)}changed&&this.itemChanged.notify()},getAttachment:function getAttachmentFn(index){try{g.PAssert(3725,this._attachments,"Must have valid attachments in order to query")}catch(PERR){g.reportError(PERR)}return this._attachments?this._attachments()[index]:void 0},hasAttachment:function hasAttachmentFn(id){if(this._attachments)for(var i=0;i<this._attachments().length;++i)if(this._attachments()[i].id===id)return!0;return!1},hasPluginAttachment:function hasPluginAttachmentFn(pluginID){if(this._attachments)for(var i=0;i<this._attachments().length;++i)if(this._attachments()[i].getPlugin().id===pluginID)return!0;return!1},getAttachmentById:function getAttachmentByIdFn(id){try{g.PAssert(3726,this._attachments,"Must have valid attachments in order to query")}catch(PERR){g.reportError(PERR)}if(this._attachments)for(var i=0;i<this._attachments().length;++i)if(this._attachments()[i].id===id)return this._attachments()[i];return void 0},getAttachmentByType:function getAttachmentByTypeFn(type){if(this._attachments)for(var i=0;i<this._attachments().length;++i){var attach=this._attachments()[i];if(attach.isType(type))return attach}},getAttachmentByPlugin:function getAttachmentByPluginFn(pluginID){if(this._attachments)for(var i=0;i<this._attachments().length;++i){var attach=this._attachments()[i];if(attach.isPlugin(pluginID))return attach}},getAttachments:function getAttachmentsFn(){return this._attachments&&this._attachments().length>0?this._attachments():void 0},hasAttachments:function hasAttachmentsFn(){return this._attachments&&this._attachments().length>0},getNumAttachments:function getNumAttachmentsFn(){return this._attachments?this._attachments().length:0},hasAttachmentType:function hasAttachmentTypeFn(type){return g.vmMain.pluginManager.hasAttachmentType(this,type)},copyProperties:function copyPropertiesFn(src){this.isStarred(src.isStarred(),ChangeType.Auto),this.isComplete(src.isComplete(),ChangeType.Auto),this.priority(src.priority(),ChangeType.Auto)},moveNote:function moveNoteFn(src,changeType){try{g.PAssert(3727,src.hasNote(),"Must have a note to move")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3728,!this.hasNote(),"Must not already have a note")}catch(PERR){g.reportError(PERR)}var note=src.getNote();src.setNote(void 0,changeType),note&&(note.parent(this),this.setNote(note,changeType))},parent:function parentFn(){if(1===arguments.length){try{g.PAssert(3729,arguments[0]instanceof VMLI||void 0===arguments[0],"Parent must be a VMLI")}catch(PERR){g.reportError(PERR)}var newParent=arguments[0],oldParent=this._parent;try{g.PAssert(3730,!newParent||newParent._store===this._store,"All VMLIs in the same tree must share the same owner")}catch(PERR){g.reportError(PERR)}if(newParent!==oldParent)if(void 0!==newParent){var numArchived=this._numArchivedDescendants+(this.isArchived()?1:0);this._notifyAncestorsArchived(!1,numArchived),this._parent=newParent,this._notifyAncestorsArchived(!0,numArchived),this._numArchivedAncestors=this._parent._numArchivedAncestors+(this._parent.isArchived()?1:0),this._notifyDescendantsArchived(!0,this._numArchivedAncestors),this._updateStylePadding(this._parent.levelsDeep.get(),!1)}else{this._parent=newParent;var numChanged=oldParent._numArchivedAncestors+(oldParent.isArchived()?1:0);this._numArchivedAncestors-=numChanged,this._notifyDescendantsArchived(!1,numChanged);var numArchived=this._numArchivedDescendants+(this.isArchived()?1:0);this._notifyAncestorsArchived(!1,numArchived)}}return this._parent},getParser:function getParserFn(){var parser,store=this.getItemStore();return store&&(parser=store.getParser()),parser},getItemStore:function getItemStoreFn(){return this._store},belongsToSameItemStore:function belongsToSameItemStoreFn(item){return this.getItemStore()===item.getItemStore()},belongsToItemStore:function belongsToItemStoreFn(itemStore){return this.getItemStore()===itemStore},archivedItems:function archivedItemsFn(underlying){return this._archivedItems||(this._archivedItems=new ObservableArray,window.__TOTAL_ARCHIVE_PARENTS++),underlying?this._archivedItems.get():this._archivedItems},hasArchivedChildren:function hasArchivedChildrenFn(){return void 0!==this._archivedItems?this._archivedItems.get().length>0:!1},_notifyAncestorsArchived:function _notifyAncestorsArchivedFn(isArchived,num){var parent=this.parent();try{g.PAssert(3731,void 0===num||num>=0,"Must not specify a zero or negative number")}catch(PERR){g.reportError(PERR)}if(num=void 0===num?1:num,num>0)for(;parent;){isArchived?parent._numArchivedDescendants+=num:parent._numArchivedDescendants-=num;try{g.PAssert(3732,parent._numArchivedDescendants>=0,"Must never have a negative number of archived descendants")}catch(PERR){g.reportError(PERR)}parent=parent.parent()}},_notifyDescendantsArchived:function _notifyDescendantsArchivedFn(isArchived,num){try{g.PAssert(3733,void 0===num||num>=0,"Must not specify a zero or negative number")}catch(PERR){g.reportError(PERR)}if(num=void 0===num?1:num,num>0){isArchived?this._numArchivedAncestors+=num:this._numArchivedAncestors-=num;try{g.PAssert(3734,this._numArchivedAncestors>=0,"Must never have a negative number of archived ancestors")}catch(PERR){g.reportError(PERR)}for(var items=this.getItems(),i=0;i<items.length;++i)items[i]._notifyDescendantsArchived(isArchived,num);if(this.hasArchivedChildren())for(var archivedItems=this.archivedItems(!0),i=0;i<archivedItems.length;++i)archivedItems[i]._notifyDescendantsArchived(isArchived,num)}},isArchived:function isArchivedFn(){if(arguments.length>=1){var oldValue=this._isArchived;if(this._isArchived=arguments[0],arguments[0]!==oldValue){(void 0===this._parsedText||void 0===this.els)&&this.parseText(!0,ChangeType.Local);for(var items=this.getItems(),i=0;i<items.length;++i)items[i]._notifyDescendantsArchived(this._isArchived);if(this.hasArchivedChildren())for(var archivedItems=this.archivedItems(!0),i=0;i<archivedItems.length;++i)archivedItems[i]._notifyDescendantsArchived(this._isArchived);this._notifyAncestorsArchived(this._isArchived);var val=this._isFlagHelper(VMLIFlag.Archived);if(this._isFlagHelper(VMLIFlag.Archived,!val),this.hasAttachments())for(var attachList=this.getAttachments(),i=0;i<attachList.length;++i)attachList[i].notifyItemPropertyChanged(this,ChangeType.Local);Dispatcher.fireEvent("itemStateChanged",[this])}}return this._isArchived},hasArchivedDescendant:function hasArchivedDescendantFn(){return this._numArchivedDescendants>0},hasArchivedAncestor:function hasArchivedAncestorFn(){var ancestor;return this._numArchivedAncestors>0},getArchivedAncestor:function getArchivedAncestorFn(findTop){for(var archivedAncestor,ancestor=findTop?this:this.parent();void 0!==ancestor&&(!ancestor.isArchived()||(archivedAncestor=ancestor,findTop));)ancestor=ancestor.parent();return archivedAncestor},getLevelsToArchivedAncestor:function getLevelsToArchivedAncestorFn(findTop){try{g.PAssert(3737,findTop||!this.isArchived(),"Should not be getting the archived ancestor for an archived item")}catch(PERR){g.reportError(PERR)}for(var archivedNumLevels=0,numLevels=0,ancestor=findTop?this:this.parent();void 0!==ancestor&&(numLevels++,!ancestor.isArchived()||(archivedNumLevels=numLevels,findTop));)ancestor=ancestor.parent();return archivedNumLevels},isHidden:function isHiddenFn(pane,overview){try{g.PAssert(3738,pane,"Must specify the pane for the item being checked")}catch(PERR){g.reportError(PERR)}return pane?!pane.search.isMatched(this):!1},getRawText:function getRawTextFn(){return this._rawText},getParsedText:function getParsedTextFn(){try{g.PAssert(3739,this._needsParse===!1,"Text should be parsed before calling get")}catch(PERR){g.reportError(PERR)}return this._parsedText?this._parsedText:this._rawText},getSearchText:function getSearchTextFn(){try{g.PAssert(3740,void 0!==this._searchText,"Item should always have search text")}catch(PERR){g.reportError(PERR)}return this._searchText},setRawText:function setRawTextFn(text){(void 0===text||null===text)&&(text="");try{g.PAssert(3741,text.indexOf(window.AttachChar)<0,"Should never have an AttachChar present in raw text")}catch(PERR){g.reportError(PERR)}this._rawText=text,this._searchText=text.toLowerCase(),this._parsedText=void 0,this._needsParse=!0},setParsedText:function setParsedTextFn(text){this._parsedText=text,text&&(this._searchText=text.toLowerCase()),this._needsParse=!1},priority:function priorityFn(pri,changeType){if(void 0===pri)return this._getPriority();try{g.PAssert(3743,g.isValidChangeType(changeType),"Must supply a valid changetype when completing an item: "+changeType)}catch(PERR){g.reportError(PERR)}try{g.PAssert(3744,null===pri||g.priorityMapOut[pri],"Priority must be defined in globals")}catch(PERR){g.reportError(PERR)}var oldPriority=this._getPriority();if(pri!==oldPriority){var origFlags=this.flags.get(),newFlags=origFlags&~g.PCMask|pri;if(origFlags&VMLIFlag.Complete&&(newFlags&=~VMLIFlag.Complete),this.setFlags(newFlags),this.shouldSave()){var saveData={priority:pri},saveFlags;g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)?(gdata.saveChanges(this,saveData),saveData=g.clone(saveData),saveFlags=SaveFlag.Text):saveFlags=SaveFlag.None,this.save(saveData,saveFlags)}if(this.hasAttachments())for(var attachList=this.getAttachments(),i=0;i<attachList.length;++i)attachList[i].notifyItemPropertyChanged(this,changeType);Dispatcher.fireEvent("itemStateChanged",[this]),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"priority",newValue:pri,oldValue:oldPriority})}},isScheduled:function isScheduledFn(){return!!this._date||!!this._repeatDate},getDuration:function getDurationFn(){return this._durationMS||0},setDuration:function setDurationFn(durationMS){this._durationMS!==durationMS&&(this._durationMS=durationMS,Dispatcher.fireEvent("itemStateChanged",[this]))},getDurationText:function getDurationTextFn(){return this._durationText||""},setDurationText:function setDurationTextFn(durationText){this._durationText=durationText},getDateText:function getDateTextFn(){return this.dateText},getEndDate:function getEndDateFn(ignoreForced){try{g.PAssert(3745,this.date(),"Must have a valid date")}catch(PERR){g.reportError(PERR)}var startDate=this.getDate(ignoreForced);return startDate?startDate.clone().addMilliseconds(this.getDuration()):void 0},isMultidayEvent:function isMultidayEventFn(){var isMultiday=!1;if(this.date()&&this.getDuration()>0){var endDate=this.getEndDate();this.date().isSameDay(endDate)||(isMultiday=!0)}return isMultiday},forceDate:function forceDateFn(date){this._dateTempForced=date},date:function dateFn(date,changeType){if(void 0!==date){try{g.PAssert(3746,!date||date instanceof Date,"Must pass in a valid date object")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3747,g.isValidChangeType(changeType),"Must have a valid changeType")}catch(PERR){g.reportError(PERR)}if(date!==this._date){null===date&&(date=void 0);try{g.PAssert(3748,void 0===date||!isNaN(date.getTime()),"Must be setting a valid date")}catch(PERR){g.reportError(PERR)}this._date=date,g.timeline.updateNotifications(this),Dispatcher.fireEvent("itemStateChanged",[this]),g.isLocalChange(changeType)&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:{itemID:this.id,date:date}})}}return this.getDate()},getDate:function getDateFn(ignoreForced){return ignoreForced||!this._dateTempForced||this._dateTempForced.isRepeatDate()?this._date:this._dateTempForced},repeatDate:function repeatDateFn(rDate,changeType){if(void 0!==rDate){try{g.PAssert(3749,!rDate||rDate instanceof RepeatDate,"Must pass in a valid repeat date object")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3750,g.isValidChangeType(changeType),"Must have a valid changeType")}catch(PERR){g.reportError(PERR)}rDate!==this._repeatDate&&(null===rDate&&(rDate=void 0),this._repeatDate=rDate,!rDate&&this.dateCompleted&&this.dateCompleted.getTime()!==forceCompleteDate.getTime()&&this.isComplete(!1,changeType),g.timeline.updateNotifications(this),Dispatcher.fireEvent("itemStateChanged",[this]),g.isLocalChange(changeType)&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:{itemID:this.id,date:rDate}}))}return this._dateTempForced&&this._dateTempForced.isRepeatDate()?this._dateTempForced:this._repeatDate},allDayDate:function allDayDateFn(){return this._date?!this._date.hasTimeOfDay():this.repeatDate()?!this.repeatDate().hasTimeOfDay():!1},_isFlagHelper:function _isFlagHelperFn(flag,value){if(void 0!==value){var newFlags=value?this.flags.get()|flag:this.flags.get()&~flag;return void this.setFlags(newFlags)}return!!(this.flags.get()&flag)},isDeleted:function isDeletedFn(value,changeType){if(void 0!==value){try{g.PAssert(3751,g.isValidChangeType(changeType),"Must supply a valid changetype to delete an item: "+changeType)}catch(PERR){g.reportError(PERR)}this._isDeleted=value;for(var i=0;this._favorites&&i<this._favorites.length;++i){var fav=this._favorites[i];value?Favorites.notifyRemove(this,fav):Favorites.notifyAdd(this,fav)}if(this._attachments)for(var tAttach=this._attachments(),i=0;i<tAttach.length;++i)value?(tAttach[i].unsubscribe(this),this.shouldSave()&&tAttach[i].markUnused(changeType)):(tAttach[i].subscribe(this),this.shouldSave()&&tAttach[i].markInUse(changeType))}return this._isDeleted},isImportant:function isImportantFn(){return this._getPriority()},forceComplete:function forceCompleteFn(value,changeType){return this.isComplete(value,changeType,!0)},computeDisplayComplete:function computeDisplayCompleteFn(){var parent=this.parent(),value=parent&&!this.isComplete()&&(parent.isComplete()||parent._isFlagHelper(VMLIFlag.DisplayComplete));this._isFlagHelper(VMLIFlag.DisplayComplete,value)},propagateDisplayComplete:function propagateDisplayCompleteFn(value){this.computeDisplayComplete();for(var i=0;i<this.numItems();i++){var item=this.itemAtIndex(i);item.isComplete()||item.propagateDisplayComplete()}},_hideChildrenHelper:function _hideChildrenHelperFn(value){for(var i=0;i<this.numItems();i++){var item=this.itemAtIndex(i);item._hideChildrenHelper(value)}},isComplete:function isCompleteFn(value,changeType,force){if(void 0===value)return this._isFlagHelper(VMLIFlag.Complete)&&(!this.repeatDate()||this.dateCompleted&&this.dateCompleted.getTime()===forceCompleteDate.getTime());var saveData={isComplete:value};try{g.PAssert(3752,g.isValidChangeType(changeType),"Must supply a valid changetype when completing an item: "+changeType)}catch(PERR){g.reportError(PERR)}if(value!==this._isFlagHelper(VMLIFlag.Complete)||this.repeatDate()){if(value){if(this.repeatDate()){try{g.PAssert(3753,!this.dateCompleted||this.dateCompleted.getTime()!==forceCompleteDate.getTime(),"If the passed in value is true then the repeated date should never be forced")}catch(PERR){g.reportError(PERR)}if(force)this.dateCompleted=forceCompleteDate;else{var nextComplete=this.repeatDate().nextComplete(this.dateCompleted),nextActive=this.repeatDate().nextActive(this.dateCompleted);if(nextActive){if(g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)){this.dateCompleted=nextActive,tracker.beginAction(),g.focusedPane.setIgnoreRestoreScroll(!0);var newText=this.getRawText().replace(this.dateText,nextComplete.toString(Date.CultureInfo.formatPatterns.shortDate)),completedItem=d.createVMLI({text:newText,isComplete:!0,dateCompleted:Date.now()},{parent:this.parent(),changeType:ChangeType.AllLocal});this.parent().insertItem(completedItem,this.getIndex()),this.repeatDate().setStartDate(nextActive),saveData.repeatDate=this.repeatDate().toString(),Dispatcher.fireEvent("itemStateChanged",[this]),g.vmMain.runSingleParse(this,changeType|ChangeType.Property),tracker.endAction()}}else this.dateCompleted=forceCompleteDate,g.vmMain.runSingleParse(this,changeType|ChangeType.Property),force=!0}saveData.dateCompleted=this.getDateCompletedTime()}else this.dateCompleted||(this.dateCompleted=new Date,saveData.dateCompleted=this.getDateCompletedTime());g.isLocalChange(changeType)&&g.aggregateEvent("ItemCompleted")}else this.dateCompleted=void 0,saveData.dateCompleted=void 0,force=!0;if(this.shouldSave()){var saveFlags;g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)?(gdata.saveChanges(this,saveData),saveData=g.clone(saveData),saveFlags=SaveFlag.Text):saveFlags=SaveFlag.None,this.save(saveData,saveFlags)}if(this.hasAttachments())for(var attachList=this.getAttachments(),i=0;i<attachList.length;++i)attachList[i].notifyItemPropertyChanged(this,changeType);tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isComplete",newValue:value,oldValue:!value})}(force||!this.repeatDate())&&(this._isFlagHelper(VMLIFlag.Complete,value),this.propagateDisplayComplete(),g.timeline.updateNotifications(this),Dispatcher.fireEvent("itemStateChanged",[this]))},isStarred:function isStarredFn(value,changeType){if(void 0===value)return this._isFlagHelper(VMLIFlag.Starred);try{g.PAssert(3754,g.isValidChangeType(changeType),"Must supply a valid changetype when completing an item: "+changeType)}catch(PERR){g.reportError(PERR)}if(value!==this._isFlagHelper(VMLIFlag.Starred)){var origFlags=this.flags.get();value&&origFlags&VMLIFlag.Complete&&(origFlags&=~VMLIFlag.Complete);var newFlags=value?origFlags|VMLIFlag.Starred:origFlags&~VMLIFlag.Starred;this.setFlags(newFlags);var saveData={isStarred:value};if(android.isEnabled()&&android.isCurrentVMLI(this)&&android.notifyStarred(value),this.shouldSave()){var saveFlags;g.isLocalChange(changeType)&&!g.isUndoRedoChange(changeType)?(gdata.saveChanges(this,saveData),saveData=g.clone(saveData),saveFlags=SaveFlag.Text):saveFlags=SaveFlag.None,this.save(saveData,saveFlags)}if(this.hasAttachments())for(var attachList=this.getAttachments(),i=0;i<attachList.length;++i)attachList[i].notifyItemPropertyChanged(this,changeType);Dispatcher.fireEvent("itemStateChanged",[this]),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isStarred",newValue:value,oldValue:!value})}},isHeader:function isHeaderFn(){if(this.isNote())return!1;var value=this.numItems()>0||this._demandLoadChildren&&!this._loadedOnDemandData;return value},hasVisibleChildren:function hasVisibleChildrenFn(pane){if(this.isNote())return!1;for(var items=this.getItems(),i=0;i<items.length;i++)if(!items[i].isHidden(pane))return!0;return!1},hasHeaderChildren:function hasHeaderChildrenFn(){if(this.isNote())return!1;for(var items=this.getItems(),i=0;i<items.length;i++)if(items[i].isHeader())return!0;return!1},isCollapsed:function isCollapsedFn(pane,overview){try{g.PAssert(3755,pane,"Must specify the pane for the item being checked for collapsed")}catch(PERR){g.reportError(PERR)}if(!pane)return!1;var state=pane.getPerPaneState(this.id,overview?PerPaneStateField.CollapsedOverview:pane.isSearched()?PerPaneStateField.CollapsedSearch:PerPaneStateField.Collapsed);return void 0===state&&this.isDemandLoad()?0===this.numItems()?!0:!pane.isSearched()&&!overview:!!state},setCollapsed:function setCollapsedFn(value,pane,overview){try{g.PAssert(3756,pane,"Must specify the pane for the item being checked for collapsed")}catch(PERR){g.reportError(PERR)}if(!pane)return!1;var oldValue=this.isCollapsed(pane,overview);return void 0!==value&&(!value||this.isCollapsible())&&(pane.setPerPaneState(this.id,overview?PerPaneStateField.CollapsedOverview:pane.isSearched()?PerPaneStateField.CollapsedSearch:PerPaneStateField.Collapsed,value),g.vmMain.paneManager.updatePaneStateForPane(pane),tracker.performAction(TrackerType.Update,{itemID:this.id,field:"isCollapsed",pane:pane,newValue:value,oldValue:oldValue}),this.shouldSave()&&this.save({isCollapsed:value},SaveFlag.Text),this.isDemandLoad()&&this.notifyDemandLoadUpdate(!value,g.focusedPane),value!==oldValue&&pane.updateItems()),this.itemChanged.notify(),pane?pane.getPerPaneState(this.id,overview?PerPaneStateField.CollapsedOverview:PerPaneStateField.Collapsed):!1
},toggleCollapsed:function toggleCollapsedFn(pane){try{g.PAssert(3757,pane,"Must specify the pane that this item is being collapsed in")}catch(PERR){g.reportError(PERR)}this.setCollapsed(!this.isCollapsed(pane,!1),pane,!1)},isCollapsible:function isCollapsibleFn(){return!this.isNote()&&(this.numItems()>0||this._demandLoadChildren&&!this._loadedOnDemandData)},isDraggable:function isDraggableFn(){return!this.isNote()},setTags:function setTagsFn(newTags){this._activeTags=newTags},getTags:function getTagsFn(){return this._activeTags},hasCompletedAncestor:function hasCompletedAncestorFn(){for(var parent=this.parent();parent;){if(parent.isComplete())return!0;parent=parent.parent()}},hasTime:function hasTimeFn(){return this.date()?this.date().hasTimeOfDay():this.repeatDate()?this.repeatDate().hasTimeOfDay():!!this.dateCompleted},getTimeOfDay:function getTimeOfDayFn(){return this.date()?this.date().getTimeOfDay():this.repeatDate()?this.repeatDate().getTimeOfDay():this.dateCompleted?this.dateCompleted.getTimeOfDay():0},time:function timeFn(){var timeString="";return this.dateCompleted?timeString=this.dateCompleted.toString(International.getFormat(DFormat.ShortTime)):this.date()?timeString=this.date().hasTimeOfDay()?this.date().toString(International.getFormat(DFormat.ShortTime)):"All day":this.repeatDate()&&(timeString=this.repeatDate().hasTimeOfDay()?this.repeatDate().getTime(International.getFormat(DFormat.ShortTime)):"All day"),timeString},createDateString:function createDateStringFn(dt){return dt.toString(dt.isBefore(Date.today().addWeeks(1))?International.getFormat(DFormat.LongDayTime):International.getFormat(DFormat.ShortDayTime))},fullTime:function fullTimeFn(){var date=this.date();return date?void this.createDateString(date):""},isVersionUninitialized:function isVersionUninitializedFn(type){var v;switch(type){case VersionType.Structure:v=this._version;break;case VersionType.Text:v=this._versionText;break;default:v=-2;try{g.PAssert(3758,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return(v?v:0)===window.UninitializedVersion},setVersion:function setVersionFn(type,v){try{g.PAssert(3759,g.isNumber(v),"Must always be setting a version to a number: ",v)}catch(PERR){g.reportError(PERR)}var verStr;switch(type){case VersionType.Structure:this._version=v;break;case VersionType.Text:this._versionText=v;break;default:try{g.PAssert(3760,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}},getVersion:function getVersionFn(type){var v;switch(type){case VersionType.Structure:v=this._version;break;case VersionType.Text:v=this._versionText;break;default:v=-2;try{g.PAssert(3761,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},setRemoteVersion:function setRemoteVersionFn(type,v){try{g.PAssert(3762,void 0===v||g.isNumber(v),"Must always be setting a remote version to a number: ",v)}catch(PERR){g.reportError(PERR)}var verStr;switch(type){case VersionType.Structure:this._versionRemote=v;break;case VersionType.Text:this._versionRemoteText=v;break;default:try{g.PAssert(3763,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}},getRemoteVersion:function getRemoteVersionFn(type){var v;switch(type){case VersionType.Structure:v=this._versionRemote;break;case VersionType.Text:v=this._versionRemoteText;break;default:v=-2;try{g.PAssert(3764,!1,"Invalid version type")}catch(PERR){g.reportError(PERR)}}return v?v:0},isLocalVersionNewer:function isLocalVersionNewerFn(type){return this.getVersion(type)==this.getRemoteVersion(type)},isRemoteVersionNewer:function isRemoteVersionNewerFn(type){return!this.isLocalVersionNewer(type)},init:function initFn(p,extraInfo){this._shouldSave=!(extraInfo&&extraInfo.noSave);try{g.PAssert(3765,!this._shouldSave||!this._demandLoadChildren,"Should never be saving results of demand loaded items")}catch(PERR){g.reportError(PERR)}if(p.data){try{g.PAssert(3766,this.shouldSave(),"Should never be loading from remote with item that doesnt save")}catch(PERR){g.reportError(PERR)}var verStructure=gdata.getVersion(p.data,VersionType.Structure),verText=gdata.getVersion(p.data,VersionType.Text);this.setRemoteVersion(VersionType.Structure,verStructure),this.setRemoteVersion(VersionType.Text,verText),tracker.beginAction(),this.initFromGDrive(p.data),tracker.endAction(),this.setRemoteVersion(VersionType.Structure,void 0),this.setRemoteVersion(VersionType.Text,void 0)}else{if(void 0!==p.version&&this.setVersion(VersionType.Structure,p.version),void 0!==p.versionText&&this.setVersion(VersionType.Text,p.versionText),this.modifiedOffline=p.modifiedOffline,this.modifiedOfflineText=p.modifiedOfflineText,this.modifiedOffline,this.modifiedOfflineText,g.vmMain.isLoaded&&this.shouldSave()&&gdata.isConnected()&&p.id!==d.rootId?d.initializeItem(this):this.id=p.id||g.generateTempId(),p.date){var newDate=new Date(p.date);this.date(newDate,extraInfo.changeType)}if(p.repeatDate){var newRepeatDate=new RepeatDate(p.repeatDate);newRepeatDate.isValid()?this.repeatDate(newRepeatDate,extraInfo.changeType):g.reportError(new Error("Initial invalid repeat date: "+p.repeatDate))}p.dateCompleted&&(this.dateCompleted=new Date(p.dateCompleted)),p.favorites&&this.setFavorites(p.favorites,extraInfo.changeType),this.computeDisplayComplete(),(p.items&&p.items.length>0||p.note)&&this.updateItems(p.items,p.note,extraInfo.changeType)}if(this.__TEMP_InitCalled=!0,!this.isArchived()||g.vmMain.hasDisplayedArchivedItems()){try{g.PAssert(3767,extraInfo,"Currently we have required properties in extraInfo")}catch(PERR){g.reportError(PERR)}var changeType=extraInfo?extraInfo.changeType:ChangeType.Auto;try{g.PAssert(3768,g.isValidChangeType(changeType),"Must supply a valid changetype to VMLIs")}catch(PERR){g.reportError(PERR)}this.__TEMP_InitParseCalled=!0,this.parseText(!0,extraInfo.changeType)}else this.__TEMP_SkippedInitParsed=!0;if(this.shouldSave()&&!g.isAutoChange(extraInfo.changeType)){var saveFlags;g.isLocalChange(extraInfo.changeType)?(saveFlags=SaveFlag.All,(this.date()||this.repeatDate())&&gdata.saveChanges(this,this.getMetaTextSaveData()),this.isComplete()&&gdata.saveChanges(this,{isComplete:this.isComplete()})):saveFlags=SaveFlag.None,this.getItemStore().trackGlobally()&&d.setModel(this),this.save(void 0,saveFlags)}else this.getItemStore().trackGlobally()&&d.setModel(this);g.isLocalChange(extraInfo.changeType)&&g.aggregateEvent("ItemCreated")},onLoad:function onLoadFn(pane){this.isLoaded||(!this.isDemandLoad()||this.isCollapsed(pane,!1)||pane.isSearched()||this.notifyDemandLoadUpdate(!0,pane),this.isLoaded=!0)},destroy:function destroyFn(){try{g.PAssert(3769,this._canDestroy,"VMLI must be explicitly marked as destroyable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3770,!this.shouldSave()||g.isDemoMode(),"Should never destory a saveable VMLI")}catch(PERR){g.reportError(PERR)}if(this._destroyed=!0,this._attachments){for(var thisAttachments=this._attachments(),i=0;i<thisAttachments.length;++i){var attach=thisAttachments[i];attach.unsubscribe(this)}this._attachments=void 0}this.getItemStore().trackGlobally()&&d.clearModel(this.id),this.items.unlisten(this.itemsHasMutated),this._store=void 0,Dispatcher.fireEvent("itemStateChanged",[this]),util.destroy(this)},isDestroyed:function isDestroyedFn(){return this._destroyed},getACText:function getACTextFn(){return android.isEnabled()&&android.isCurrentVMLI(this)?android.getInputText():this.getParsedText()},resetDriveData:function resetDriveDataFn(){this._versionRemote=void 0,this._versionRemoteText=void 0,this.data&&this.data.removeAllEventListeners(),this.data=void 0},isFullscreen:function isFullscreenFn(){return g.focusedItem===this},findItem:function findItemFn(item){var found=this.getIndexOf(item.id,!1);return found>=0?{index:found,arr:this.items,isArchived:!1}:this.hasArchivedChildren()&&(found=this.getIndexOf(item.id,!0),found>=0)?{index:found,arr:this.archivedItems(),isArchived:!0}:void 0},updateItems:function updateItemsFn(newItems,note,changeType){var itemsModified=!1,archivedItemsModified=!1;if(newItems&&newItems.length>0){var collabItemList,collabArchivedItemList;this.data&&(collabItemList=gdata.get(this.data,"items"),collabArchivedItemList=gdata.get(this.data,"archivedItems"));try{g.PAssert(3773,!this.hasChildren(),"Update items should only be called from initialize when there are no items already loaded")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3774,!this.hasArchivedChildren(),"Update items should only be called from initialize when there are no items already loaded")}catch(PERR){g.reportError(PERR)}for(var i=0;i<newItems.length;++i){var item=newItems[i],itemVM=void 0;if(item instanceof VMLI?itemVM=item:g.isString(item)&&(itemVM=d.getModel(item)),itemVM){var oldParentInfo=d.getItem(itemVM.parent().id);if(oldParentInfo&&oldParentInfo.id!==this.id){var oldParentIndex=oldParentInfo.items.indexOf(itemVM.id);try{g.PAssert(3777,-1===oldParentIndex,"Expect that the old parent has been notified")}catch(PERR){g.reportError(PERR)}var childModelIndex=itemVM.getIndex();childModelIndex>-1&&itemVM.parent().removeChildAtIndex(childModelIndex,changeType)}itemVM.parent(this)}else if("object"!=typeof item){var itemInfo=d.getItem(item);try{g.PAssert(3775,itemInfo,"Referenced item doesn't exist",item)}catch(PERR){g.reportError(PERR)}itemInfo&&(itemVM=d.createVMLI(itemInfo,{parent:this,changeType:changeType}))}else{try{g.PAssert(3776,item,"Item must exist otherwise we arent creating anything")}catch(PERR){g.reportError(PERR)}item&&(itemVM=d.createVMLI(item,{parent:this,changeType:changeType}))}try{g.PAssert(3778,itemVM,"There must be a model at this point")}catch(PERR){g.reportError(PERR)}itemVM&&(itemVM.isArchived()?(archivedItemsModified=!0,this.archivedItems(!0).push(itemVM),!collabArchivedItemList&&this.data&&(collabArchivedItemList=gdata.ensureItemList(this,!0)),collabArchivedItemList&&collabArchivedItemList.push(itemVM.data)):(itemsModified=!0,this.items.push(itemVM),!collabItemList&&this.data&&(collabItemList=gdata.ensureItemList(this,!1)),collabItemList&&collabItemList.push(itemVM.data)))}}if(note){try{g.PAssert(3779,!this._note,"Must not already have a valid note set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3780,g.isString(note),"Note must be a valid ID")}catch(PERR){g.reportError(PERR)}var noteVM=d.getModel(note);if(!noteVM){var itemInfo=d.getItem(note);try{g.PAssert(3781,itemInfo,"Referenced note doesn't exist",note)}catch(PERR){g.reportError(PERR)}itemInfo&&(itemInfo.isNote=!0,noteVM=d.createVMLI(itemInfo,{parent:this,changeType:changeType}))}try{g.PAssert(3782,noteVM,"Must have a valid note VM at this point")}catch(PERR){g.reportError(PERR)}this._note=noteVM,itemsModified=!0}itemsModified&&this.itemsHasMutated(),archivedItemsModified&&this.archivedItems().notify()},insertItem:function insertItemFn(item,index,underlying,force){try{g.PAssert(3783,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3784,item,"Must specify a valid item to be inserted")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3785,!item.isArchived(),"Should not be inserting an archived item into the items array")}catch(PERR){g.reportError(PERR)}isNaN(index)?this.items.push(item):this.items.splice(index,0,item),this.shouldSave()&&d.insertItems(this,[item],index)},insertSorted:function insertSortedFn(item,sortFn,force){try{g.PAssert(3786,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3787,item,"Must specify a valid item to be inserted")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3788,!item.isArchived(),"Should not be inserting an archived item into the items array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3789,sortFn,"Must supply a valid comparator")}catch(PERR){g.reportError(PERR)}var index=this.items.insertSorted(item,sortFn);this.shouldSave()&&d.insertItems(this,[item],index)},moveTo:function moveToFn(params,changeType){var parent=params.parent,index=params.index,shouldBeArchived=params.shouldBeArchived,noVersion=params.noVersion,underlying=params.underlying,fromTab=params.fromTab;try{g.PAssert(3790,parent instanceof VMLI,"New parent must be a valid VMLI")}catch(PERR){g.reportError(PERR)}void 0===index&&(index=-1),void 0===shouldBeArchived&&(shouldBeArchived=!1);var oldParent=this.parent(),oldInfo=oldParent.findItem(this);if(oldInfo){var dstLocalIndex=index,dstRemoteIndex=index;if(oldParent===parent){if(oldInfo.index===dstLocalIndex)return;oldInfo.index<dstLocalIndex&&dstLocalIndex--}g.vmMain.beginUpdateItems(),oldInfo.arr.splice(oldInfo.index,1),this.parent(parent);var arr=shouldBeArchived?parent.archivedItems():parent.items;if(0>dstLocalIndex?arr.push(this):arr.splice(dstLocalIndex,0,this),this.hasNote()&&this.getNote().itemChanged.notify(),g.vmMain.commitUpdateItems(),this.shouldSave()){var newInfo={index:dstRemoteIndex,isArchived:shouldBeArchived};d.moveItem({item:this,newInfo:newInfo,oldParent:oldParent,oldInfo:oldInfo,noVersion:noVersion},changeType)}if(shouldBeArchived)try{g.PAssert(3791,this.isArchived(),"If moving to an archived array, the item should already be archived")}catch(PERR){g.reportError(PERR)}else try{g.PAssert(3792,!this.isArchived(),"If moving to a non-archived array item should not already be archived")}catch(PERR){g.reportError(PERR)}}},getItemsArrayForSave:function getItemsArrayForSaveFn(){try{g.PAssert(3793,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}for(var saveItems=[],items=this.getItems(),i=0;i<items.length;++i)saveItems.push(items[i].id);if(this.hasArchivedChildren())for(var archivedItems=this.archivedItems(!0),i=0;i<archivedItems.length;++i)saveItems.push(archivedItems[i].id);return saveItems},getDateTime:function getDateTimeFn(){return this.date()?this.date().getTime():void 0},getRepeatDate:function getRepeatDateFn(){return this.repeatDate()?this.repeatDate().toString():void 0},getDateCompletedTime:function getDateCompletedTimeFn(){return this.dateCompleted?this.dateCompleted.getTime():void 0},isForceCompleted:function isForceCompletedFn(){return this.dateCompleted&&this.dateCompleted.equals(forceCompleteDate)?!0:!1},getMetaTextSaveData:function getMetaTextSaveDataFn(){var currentDate=this.getDate(!0),repeatDate=this.repeatDate(),numDate,numRepeatDate;return void 0!==currentDate&&(numDate=currentDate.getTime()),void 0!==repeatDate&&(numRepeatDate=repeatDate.toString()),{date:numDate,repeatDate:numRepeatDate,dateCompleted:this.getDateCompletedTime()}},_generateNotificationEntry:function _generateNotificationEntryFn(date){var dateJSON=date.toJSON(),alertDateJSON,alertDate=new Date(date);try{g.PAssert(3794,g.isDateValid(alertDate),"Must provide a valid alert date: "+date+" - "+this.dateText)}catch(PERR){g.reportError(PERR)}return alertDateJSON=date.hasTimeOfDay()?alertDate.addMinutes(-30).toJSON():alertDate.addDays(-1).clearTime().addHours(17).toJSON(),{id:this.id,text:this.getParsedText(),date:dateJSON,alertDate:alertDateJSON}},getNotificationEntries:function getNotificationEntriesFn(){try{g.PAssert(3795,this.date()||this.repeatDate(),"Must have a valid date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3796,!this.allDayDate(),"All day dates should not be scheduled")}catch(PERR){g.reportError(PERR)}if(this.allDayDate())return void 0;try{if(this.date())return this._generateNotificationEntry(this.date());if(this.repeatDate()){for(var entries=[],dates=this.repeatDate().getDates(!0),i=0;i<dates.length;++i)entries.push(this._generateNotificationEntry(dates[i]));return entries}}catch(err){return void g.reportError(err)}},getDebugData:function getDebugDataFn(){var data={id:this.id,parent:this._parent?this._parent.id:void 0,items:this.isNote()?void 0:this.getItemsArrayForSave(),text:this.getRawText(),note:this.hasNote()?this.getNote().id:void 0,isNote:this.isNote(),isArchived:this.isArchived(),isDeleted:this.isDeleted(),version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return data},getFullSaveData:function getFullSaveDataFn(){try{g.PAssert(3797,this.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}var data={id:this.id,text:this.getRawText(),date:this.getDateTime(),repeatDate:this.getRepeatDate(),dateText:this.dateText,dateCreated:this.dateCreated.getTime(),dateCompleted:this.getDateCompletedTime(),duration:this.getDuration(),durationText:this.getDurationText(),favorites:this.getFavorites()||void 0,priority:this._getPriority()||void 0,isComplete:this.isComplete()||void 0,isStarred:this.isStarred()||void 0,note:this.hasNote()?this.getNote().id:void 0,isArchived:this.isArchived()||void 0,isNote:this.isNote()||void 0,isDeleted:void 0,version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return this.isNote()||(data.items=this.getItemsArrayForSave()),data},save:function saveFn(changes,saveFlags){try{g.PAssert(3798,this.shouldSave(),"Item must be marked as saveable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3799,void 0!==saveFlags,"Must specify saveFlags for the changes that are being saved")}catch(PERR){g.reportError(PERR)}if(changes){var existingItem=d.getItem(this.id);existingItem||changes.id?(changes.items&&(changes.items=this.getItemsArrayForSave(),g.isFlagSet(saveFlags,SaveFlag.Prop)||(this.modifiedOffline=!1,changes.modifiedOffline=!1)),void 0!==changes.text&&(g.isFlagSet(saveFlags,SaveFlag.Text)||(this.modifiedOfflineText=!1,changes.modifiedOfflineText=!1),Dispatcher.fireEvent("itemTextChanged",[{item:this,force:saveFlags===SaveFlag.None}]))):changes=this.getFullSaveData()}else changes=this.getFullSaveData();d.saveChanges(this,changes,saveFlags)},highlight:function highlightFn(){var self=this;this.highlightTimeout?(this.isHighlighted.set(!1),clearTimeout(this.highlightTimeout),this.highlightTimeout=void 0,setTimeout(function(){self.isHighlighted.set(!0)},0)):this.isHighlighted.set(!0),this.highlightTimeout=setTimeout(function(){self.isHighlighted.set(!1)},2e3)},getElement:function getElementFn(paneID){return void 0},getSpan:function getSpanFn(paneID){return void 0},getOverviewElement:function getOverviewElementFn(paneID){return void 0},removeChild:function removeChildFn(child,changeType){try{g.PAssert(3802,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3803,!child.isNote(),"Do not use remove child to remove notes from items")}catch(PERR){g.reportError(PERR)}var removedIndex;if(child.isArchived()){try{g.PAssert(3806,this.hasArchivedChildren(),"For a child to be archived, this item must have valid archived children")}catch(PERR){g.reportError(PERR)}if(this.hasArchivedChildren()){if(removedIndex=this.archivedItems(!0).remove(child),removedIndex>=0)this.shouldSave()&&d.removeItem(this,removedIndex,child,!0,changeType);else{try{g.PAssert(3807,!1,"Archived child not found in parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3808,this===child.parent(),"Parent of archived child is not set to this item, should not remove: "+child.parent())}catch(PERR){g.reportError(PERR)}}this.archivedItems().notify()}}else if(removedIndex=this.items.remove(child),removedIndex>=0)this.shouldSave()&&d.removeItem(this,removedIndex,child,!1,changeType);else{try{g.PAssert(3804,!1,"Child not found in parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3805,this===child.parent(),"Parent of child is not set to this item, should not remove: "+child.parent())}catch(PERR){g.reportError(PERR)}}return removedIndex},removeChildAtIndex:function removeChildAtIndexFn(index,changeType){try{g.PAssert(3809,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3810,!this.itemAtIndex(index).isArchived())}catch(PERR){g.reportError(PERR)}var removed=this.items.removeAt(index);return this.shouldSave()&&d.removeItem(this,index,removed,!1,changeType),removed},archiveChild:function archiveChildFn(child,changeType){try{g.PAssert(3811,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3812,!child.isNote(),"Do not use archive child on notes")}catch(PERR){g.reportError(PERR)}var retVal=!1;if(!child.isArchived()){tracker.beginAction(),child.isArchived(!0,changeType),this.archivedItems().push(child);var removedIndex=this.items.remove(child);try{g.PAssert(3813,removedIndex>=0,"Must be able to find child in items list")}catch(PERR){g.reportError(PERR)}this.shouldSave()&&d.archiveItem(this,removedIndex,child,changeType),tracker.endAction(),retVal=!0}return retVal},unarchiveChild:function unarchiveChildFn(child,changeType){try{g.PAssert(3814,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3815,!child.isNote(),"Do not use unarchive child on notes")}catch(PERR){g.reportError(PERR)}var retVal=!1;if(child.isArchived()){tracker.beginAction();try{g.PAssert(3816,child.isArchived(),"Child must be archived to be unarchived")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3817,this.hasArchivedChildren(),"Parent must have archived children to unarchive a child")}catch(PERR){g.reportError(PERR)}child.isArchived(!1,changeType);var removedIndex=this.archivedItems(!0).remove(child);this.items.push(child),this.shouldSave()&&d.unarchiveItem(this,removedIndex,child,changeType),this.archivedItems().notify(),tracker.endAction(),retVal=!0}return retVal},_moveChildrenHelper:function _moveChildrenHelperFn(params,changeType){var newParent=params.newParent,index=params.index,isArchived=params.isArchived;try{g.PAssert(3818,void 0!==newParent&&void 0!==isArchived,"_moveChildrenHelper is missing parameters")}catch(PERR){g.reportError(PERR)}var oldItems=isArchived?this.archivedItems(!0):this.getItems(),children=oldItems;if(children.length>0){var newItems=isArchived?newParent.archivedItems(!0):newParent.getItems();!isArchived&&(isNaN(index)||0>index)&&(index=newItems.length);for(var i=0;children.length>0;){try{g.PAssert(3819,children[i]!==newParent,"Should never be reparenting to a child")}catch(PERR){g.reportError(PERR)}var id=children[0].id;children[0].moveTo({parent:newParent,index:index+i,shouldBeArchived:isArchived,underlying:!0},changeType),tracker.performAction(TrackerType.Move,{itemID:id,oldParent:this.id,oldPosition:i,newParent:newParent.id,newPosition:index+i}),i++}}},moveChildren:function moveChildrenFn(newParent,index,changeType){try{g.PAssert(3820,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3821,this.id!==newParent.id,"Do not use moveChildren to move a child to the same parent")}catch(PERR){g.reportError(PERR)}if(newParent.parent()===this){var oldIndex=this.removeChild(newParent,changeType);tracker.performAction(TrackerType.Delete,{itemID:newParent.id,parent:this.id,position:oldIndex})}g.vmMain.beginUpdateItems(),this._moveChildrenHelper({newParent:newParent,index:index,isArchived:!1},changeType),this._moveChildrenHelper({newParent:newParent,index:index,isArchived:!0},changeType),g.vmMain.commitUpdateItems()},deleteSelf:function deleteSelfFn(changeType){this.parent().deleteChild(this,void 0,void 0,changeType),this.parent(void 0)},deleteChild:function deleteChildFn(child,newParent,newIndex,changeType){try{g.PAssert(3822,child,"Must provide a valid child to delete")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3823,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}if(tracker.beginAction(),g.vmMain.beginUpdateItems(),child.isNote())this.setNote(void 0,changeType);else if(child.hasChildren()||child.hasArchivedChildren())if(newParent)child.moveChildren(newParent,newIndex,changeType);else for(var childItems=child.getItems(),i=childItems.length-1;i>=0;i--)child.deleteChild(childItems[i],void 0,void 0,changeType);if(child.hasNote()&&child.setNote(void 0,changeType),!child.isDeleted()){if(!child.isNote()){var oldIndex=this.removeChild(child,changeType);tracker.performAction(TrackerType.Delete,{itemID:child.id,parent:this.id,position:oldIndex})}this.shouldSave()&&d.deleteItem(child,changeType)}Dispatcher.fireEvent("itemStateChanged",[this]),g.vmMain.commitUpdateItems(),tracker.endAction()},replaceChild:function replaceChildFn(oldChild,newChild,changeType){try{g.PAssert(3824,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3825,!oldChild.isNote(),"Old child should not be a note")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3826,!newChild.isNote(),"New child should not be a note")}catch(PERR){g.reportError(PERR)}var index=oldChild.getIndex();this.items.removeAt(index),tracker.performAction(TrackerType.Delete,{itemID:oldChild.id,parent:this.id,position:index}),d.deleteItem(oldChild,changeType),newChild.moveTo({parent:this,index:index},changeType),d.removeItem(this,index+1,oldChild,!1,changeType),oldChild.moveChildren(newChild,newChild.numChildren(),changeType);var newChildOldParentID=newChild.parent().id;if(newChildOldParentID!==this.id){var newChildOldIndex=newChild.parent().items.remove(newChild);tracker.performAction(TrackerType.Move,{itemID:newChild.id,oldParent:newChildOldParentID,oldPosition:newChildOldIndex,newParent:this.id,newPosition:index})}},getChildren:function getChildrenFn(){return this.isNote()?void 0:this.hasNote()?[this.getNote()].concat(this.getItems()):this.getItems()},getChild:function getChildFn(index){try{g.PAssert(3827,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3828,index<this.numItems(),"Child index out of range")}catch(PERR){g.reportError(PERR)}return this.itemAtIndex(index)},getFirstChild:function getFirstChildFn(){try{g.PAssert(3829,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.hasChildren()?this.itemAtIndex(0):void 0},isFirstChild:function isFirstChildFn(){try{g.PAssert(3830,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.parent()?this.parent().getFirstChild()===this:!1},getLastChild:function getLastChildFn(){try{g.PAssert(3831,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.hasChildren()?this.itemAtIndex(this.numItems()-1):void 0},isLastChild:function isLastChildFn(){try{g.PAssert(3832,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.parent()?this.parent().getLastChild()===this:!1},isDescendantOf:function isDescendantOfFn(ancestor){for(var check=this.parent();check&&check!==ancestor;)check=check.parent();return void 0!==check},getChildIndex:function getChildIndexFn(child){try{g.PAssert(3833,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3834,!child.isNote(),"Should not get the index of an item note")}catch(PERR){g.reportError(PERR)}return this.getIndexOf(child.id,child.isArchived())},getIndexOf:function getIndexOfFn(id,isArchived){try{g.PAssert(3835,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3836,g.isString(id),"ID must be a valid string: "+g.getObjectInfo(id))}catch(PERR){g.reportError(PERR)}var index=-1,arr;if(isArchived?this.hasArchivedChildren()&&(arr=this.archivedItems(!0)):arr=this.getItems(),arr)for(var i=0;i<arr.length;++i)if(arr[i].id===id){index=i;break}return index},getRemoteIndexOf:function getRemoteIndexOfFn(item,isArchived){try{g.PAssert(3837,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3838,!item.isNote(),"Should never be getting a remote child index of a note")}catch(PERR){g.reportError(PERR)}var remoteList=gdata.getItemList(this.data,isArchived),index=-1;return remoteList&&(index=remoteList.indexOf(item)),index},getIndex:function getIndexFn(){try{g.PAssert(3840,!this.isNote(),"Should never be getting a child index of a note")}catch(PERR){g.reportError(PERR)}return this.parent().getChildIndex(this)},hasChildren:function hasChildrenFn(){return this.isNote()?!1:this.numItems()>0},numChildren:function numChildrenFn(){try{g.PAssert(3841,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}return this.numItems()},canZoom:function canZoomFn(){return this.isNote()?!1:this.numChildren()>0||this.getParsedText().length>0},parents:function parentsFn(){for(var parents=[],parent=this.parent();parent;)parents.splice(0,0,parent),parent=parent.parent();return parents},getArchivedTitle:function getArchivedTitleFn(){for(var title="",parent=this.parent();parent.parent();)title=parent.getParsedText()+(title?" | "+title:""),parent=parent.parent();return title||(title=d.getRootModel().getParsedText()),title},getSiblings:function getSiblingsFn(startIndex){try{g.PAssert(3842,!this.isNote(),"Notes cannot use this function")}catch(PERR){g.reportError(PERR)}startIndex=startIndex||0;var arr=[];if(this.parent())for(var items=this.parent().getItems(),i=startIndex,_l=items.length;_l>i;i++)items[i]!==this&&arr.push(items[i]);return arr},nextSibling:function nextSiblingFn(){var index=this.getIndex(),parentItems=this.parent().getItems(),next=parentItems[index+1];return next},isRootItem:function isRootItemFn(){var itemStore=this.getItemStore();return itemStore?itemStore.isRoot(this):!1},isPaneRoot:function isPaneRootFn(context){if(context)for(var i=context.$parents.length-1;i>=0;i--)if(context.$parents[i]instanceof g.VMPane)return this===context.$parents[i].getItem()},clone:function cloneFn(parent,changeType){try{g.PAssert(3843,!g.isAutoChange(changeType),"Cloning should always be a user action")}catch(PERR){g.reportError(PERR)}var itemStore=parent.getItemStore(),clonedItem=itemStore.createItemRaw({text:this.getRawText(),isComplete:this.isComplete(),dateText:this.getDateText(),date:this.date(),duration:this.getDuration(),durationText:this.getDurationText(),priority:this.priority(),isStarred:this.isStarred(),isNote:this.isNote()},{parent:parent,changeType:changeType});clonedItem.shouldSave()&&g.isLocalChange(changeType)&&clonedItem.save(void 0,SaveFlag.None);for(var i=0;i<this.numItems();++i){var childItem=this.itemAtIndex(i).clone(clonedItem,changeType);clonedItem.insertItem(childItem)}if(this.hasNote()){var note=this.getNote().clone(clonedItem,changeType);clonedItem.setNote(note,changeType)}return clonedItem},getItems:function getItemsFn(){return this.items.get()},itemAtIndex:function itemAtIndexFn(index){return this.items.get()[index]},numItems:function numItemsFn(){return this.items.get().length},itemsHasMutated:function itemsHasMutatedFn(){try{g.PAssert(3844,!this._destroyed,"Item should not fire mutation events once destroyed: ",this.id)}catch(PERR){g.reportError(PERR)}!this._destroyed&&this.isInitialized&&(Measure.clearCacheForItem(this.id),Dispatcher.fireEvent("itemBoldChanged",[{item:this}]),this.getItemStore().updateItems(),this.itemChanged.notify())},numChildrenRecursive:function numChildrenRecursiveFn(){var num=0,options={item:this};return options.each=function(item){num++},g.searchVMLIs(options),num},isOnDate:function isOnDateFn(date){var itemDate=this.date(),repeatDate=this.repeatDate();if(itemDate){if(date.hasTimeOfDay()){if(itemDate.equals(date))return!0}else if(itemDate.clone().clearTime().equals(date))return!0}else if(repeatDate&&repeatDate.includesDate(date))return!0}},util.defineBase(VMLI),util.extend(VMLI.prototype,VMLI_TapHandlers),util.extend(VMLI.prototype,VMLI_Text),util.extend(VMLI.prototype,VMLI_Drive(VMLI)),VMLI}),define("edit",["globals","Constants","platform","data","android","VMLI","tracker","NativeSel","Sel","EditHelpers","Measure","Multiselect"],function(g,C,platform,d,android,VMLI,tracker,NativeSel,Sel,EditHelpers,Measure,Multiselect){function edit(){}var NavigationActions={None:0,Left:1,Right:2,StartLine:3,EndLine:4,LeftWord:5,RightWord:6,Down:7,Up:8,PageDown:9,PageUp:10,Top:11,Bottom:12,PrevHeader:13,NextHeader:14,All:15},keyCodesDown=[KeyCode.Tab,KeyCode.BackSpace,KeyCode.Delete],keyCodesArrows=[KeyCode.UpArrow,KeyCode.DownArrow,KeyCode.LeftArrow,KeyCode.RightArrow,KeyCode.Home,KeyCode.End,KeyCode.A,KeyCode.E,KeyCode.PageUp,KeyCode.PageDown],textSaveInfo={},lastKeypress,StringNewLine=String.fromCharCode(10);
return edit.prototype={getNavigationAction:function getNavigationActionFn(e){var mac=platform.mac,ctrl=e.ctrlKey&&!e.altKey&&!e.metaKey,alt=e.altKey&&!e.ctrlKey&&!e.metaKey,meta=e.metaKey&&!e.ctrlKey&&!e.altKey,none=!e.ctrlKey&&!e.altKey&&!e.metaKey,key=e.normCode,K=KeyCode,A=NavigationActions;if(key===K.LeftArrow){if(ctrl&&!platform.mac||alt&&platform.mac)return A.LeftWord;if(meta&&mac)return A.StartLine;if(none)return A.Left}if(key===K.RightArrow){if(ctrl&&!platform.mac||alt&&platform.mac)return A.RightWord;if(meta&&mac)return A.EndLine;if(none)return A.Right}if(key===K.UpArrow){if(mac&&meta)return A.Top;if(mac&&ctrl)return A.PageUp;if(mac&&alt)return A.StartLine;if(!mac&&ctrl)return A.PrevHeader;if(none)return A.Up}if(key===K.DownArrow){if(mac&&meta)return A.Bottom;if(mac&&ctrl)return A.PageDown;if(mac&&alt)return A.EndLine;if(!mac&&ctrl)return A.NextHeader;if(none)return A.Down}if(key===K.A&&ctrl&&mac)return A.StartLine;if(key===K.E&&ctrl&&mac)return A.EndLine;if(key===K.Home&&!mac){if(ctrl)return A.Top;if(none)return A.StartLine}if(key===K.End&&!mac){if(ctrl)return A.Bottom;if(none)return A.EndLine}return key===K.PageUp&&none?A.PageUp:key===K.PageDown&&none?A.PageDown:key===K.A&&meta&&mac||key===K.A&&ctrl&&!mac?A.All:A.None},updateAutocomplete:function updateAutocompleteFn(e){var fromArrows=e.normCode&&keyCodesArrows.indexOf(e.normCode)>=0;g.autocomplete&&!g.isDemoRunning&&(Sel.isValid()&&Sel.getStartItem()===Sel.getEndItem()&&Sel.getStartOffset()===Sel.getEndOffset()?g.autocomplete.update({owner:Sel.getStartItem(),index:Sel.getStartIndex(),start:Sel.getStartOffset(),fromArrows:fromArrows}):g.autocomplete.hide())},stopPropagation:function stopPropagationFn(e){try{g.PAssert(3845,e.stopImmediatePropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopImmediatePropagation&&e.stopImmediatePropagation()},preventDefault:function preventDefaultFn(e){try{g.PAssert(3846,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.preventDefault&&e.preventDefault()},keyup:function keyupFn(element,e){var scrolled=!1;return textSaveInfo.item&&(tracker.beginAction(),void 0!==textSaveInfo.text&&textSaveInfo.item.setText(textSaveInfo.text,!0,ChangeType.Local),textSaveInfo.useNext?Sel.selectIndex(textSaveInfo.startIndex+1,0):Sel.selectIndex(textSaveInfo.startIndex,textSaveInfo.start),scrolled=!0,tracker.endAction()),platform.mobile&&this.updateAutocomplete(e),textSaveInfo.nextItem&&"enter"===textSaveInfo.waitAutocorrect&&Multiselect.setSelected([textSaveInfo.startIndex+1],g.focusedPane),textSaveInfo.item=void 0,textSaveInfo.nextItem=void 0,textSaveInfo.useNext=!1,textSaveInfo.startIndex=void 0,textSaveInfo.text=void 0,textSaveInfo.start=void 0,textSaveInfo.waitAutocorrect=void 0,textSaveInfo.innerHTML=void 0,platform.mobile&&!scrolled&&Sel.scrollStartIntoView(platform.ios),this.stopPropagation(e),this.preventDefault(e),this.isTyping=!1,e.handled?!0:void 0},handleSelectAll:function handleSelectAllFn(pane){var start=pane.indexOfFirstItem(),end=pane.indexOfLastItem();return Sel.selectIndices(start,0,end,-1),!1},handleSelectAllItem:function handleSelectAllItemFn(){return g.focusedPane&&g.focusedPane.isWriteable?(Sel.selectIndex(Sel.getStartIndex(),0,-1),!1):void 0},_move:function _moveFn(direction,e){try{g.PAssert(3847,direction===Direction.Up||direction===Direction.Down,"Must move in a direction")}catch(PERR){g.reportError(PERR)}var pane=g.focusedPane,startIndex=Sel.getStartIndex(),endIndex=Sel.getEndIndex(),startItem=Sel.getStartItem(),endItem=Sel.getEndItem(),ok=!1;if(startItem.parent()===endItem.parent()&&(ok=!0),!ok){var next=pane.getNextItem(Sel.getEndIndex(),!0);if(!next)for(;endItem;){if(startItem.parent()===endItem.parent()){ok=!0;break}endItem=endItem.parent()}}if(ok){var moveItem,index;if(direction===Direction.Up?(moveItem=pane.getPreviousItem(startIndex,!0),index=endItem.getIndex()+1):(moveItem=pane.getNextItem(endIndex,!0),index=startItem.getIndex()),moveItem){tracker.beginAction();var savedSelection=Sel.save();Sel.reset();var numMovedPast=1+moveItem.numChildrenRecursive();g.vmMain.setItemAnimationMode(C.ItemAnimationMode.Move),moveItem.moveTo({parent:moveItem.parent(),index:index},ChangeType.Local),g.vmMain.resetItemAnimationMode(),direction===Direction.Up?(savedSelection.startIndex-=numMovedPast,savedSelection.endIndex-=numMovedPast):direction===Direction.Down&&(savedSelection.startIndex+=numMovedPast,savedSelection.endIndex+=numMovedPast),Sel.restore(savedSelection),direction===Direction.Up?Sel.scrollStartIntoView():Sel.scrollEndIntoView(),tracker.endAction()}}},moveUp:function moveUpFn(e){g.focusedPane.type!==PaneMode.Timeline&&Sel.isValid()&&this._move(Direction.Up,e)},moveDown:function moveDownFn(e){g.focusedPane.type!==PaneMode.Timeline&&Sel.isValid()&&this._move(Direction.Down,e)},handleArrows:function handleArrowsFn(element,e){var pane=g.focusedPane;if(!Sel.isValid())return!0;var action=this.getNavigationAction(e),A=NavigationActions;switch(action){case A.Left:case A.Right:case A.StartLine:case A.EndLine:case A.LeftWord:case A.RightWord:var item,text,isLeft=action===A.Left||action===A.LeftWord||action===A.StartLine,isRight=action===A.Right||action===A.RightWord||action===A.EndLine,offset,newIndex,newOffset,total;if(isLeft&&(!e.shiftKey||Sel.isArrowSelectInverted())||isRight&&e.shiftKey&&Sel.isArrowSelectInverted()||action===A.StartLine&&Sel.getStartIndex()===Sel.getEndIndex()?(offset=Sel.getStartOffset(),newIndex=Sel.getStartIndex(),total=Sel.getStartTotal(),item=Sel.getStartItem()):(offset=Sel.getEndOffset(),newIndex=Sel.getEndIndex(),total=Sel.getEndTotal(),item=Sel.getEndItem()),text=item.getParsedText(),action===A.StartLine){var caretPos=Measure.getCaretOffset(item,pane,offset,Sel.preferLineStart),line=caretPos.line;newOffset=line>0&&0===caretPos.lineOffset?0:Measure.getOffsetForPositionInLine(item,pane,line,0,0),newIndex=Sel.isArrowSelectInverted()?Sel.getStartIndex():Sel.getEndIndex(),total=Sel.isArrowSelectInverted()?Sel.getStartTotal():Sel.getEndTotal()}else if(action===A.EndLine){var caretPos=Measure.getCaretOffset(item,pane,offset,Sel.preferLineStart),line=caretPos.line,itemMetrics=item.metricsInPane(pane);total=Sel.isArrowSelectInverted()?Sel.getStartTotal():Sel.getEndTotal(),newOffset=line<itemMetrics.styledLines.length-1&&caretPos.lineOffset===caretPos.lineLength?total:Measure.getOffsetForPositionInLine(item,pane,line,pane.getWidth(),-1),newIndex=Sel.isArrowSelectInverted()?Sel.getStartIndex():Sel.getEndIndex()}else if(action===A.LeftWord){var lastWord=EditHelpers.getPreviousWord(text,offset-1),lastPlugin=text.prevIndexOf(window.AttachChar,offset);if(0>lastPlugin||lastWord>=lastPlugin)if(-1===lastWord&&0===offset)if(newIndex>0){if(newIndex=pane.indexOfPrevVMLI(newIndex,!1,!0),newIndex>=0){var textPrev=pane.itemAtIndex(newIndex).getParsedText();newOffset=EditHelpers.getPreviousWord(textPrev,textPrev.length-1)+1,total=textPrev.length}}else newOffset=-1;else newOffset=lastWord+1;else lastPlugin>lastWord&&(newOffset=lastPlugin+1,lastPlugin+1===offset&&newOffset--)}else if(action===A.RightWord){var nextWord=EditHelpers.getNextWord(text,offset+1),nextPlugin=text.indexOf(window.AttachChar,offset);if(0>nextPlugin||nextPlugin>=nextWord)if(nextWord===total)if(offset===total)if(newIndex<pane.numItems()-1){if(newIndex=pane.indexOfNextVMLI(newIndex,!1,!0),newIndex>=0){var textNext=pane.itemAtIndex(newIndex).getParsedText();nextWord=EditHelpers.getNextWord(textNext,0),total=textNext.length,-1===nextWord&&(nextWord=textNext.length),newOffset=nextWord}}else newOffset=total+1;else newOffset=total;else newOffset=nextWord;else(nextWord>nextPlugin||0>nextWord)&&nextPlugin>=0&&(newOffset=nextPlugin,nextPlugin===offset&&newOffset++)}else action===A.Left?newOffset=Sel.getStartOffset()===Sel.getEndOffset()||e.shiftKey?offset-1:Sel.getStartOffset():action===A.Right&&(newOffset=Sel.getStartOffset()===Sel.getEndOffset()||e.shiftKey?offset+1:Sel.getEndOffset());if(Sel.preferLineStart=isLeft,0>newOffset?newIndex>0?newIndex=pane.indexOfPrevVMLI(newIndex,!1,!0):newOffset=0:newOffset>total&&(newIndex<pane.numItems()-1?(newIndex=pane.indexOfNextVMLI(newIndex,!1,!0),newOffset=0):newOffset=total),e.shiftKey){var otherIndex=Sel.isArrowSelectInverted()?Sel.getEndIndex():Sel.getStartIndex(),otherOffset=Sel.isArrowSelectInverted()?Sel.getEndOffset():Sel.getStartOffset();!Sel.isArrowSelectInverted()&&isLeft&&newIndex<=Sel.getStartIndex()&&newOffset>=-1&&newOffset<Sel.getStartOffset()?Sel.setArrowSelectInverted(!0):Sel.isArrowSelectInverted()&&isRight&&newIndex>=Sel.getEndIndex()&&newOffset>Sel.getEndOffset()&&Sel.setArrowSelectInverted(!1),Sel.isArrowSelectInverted()?Sel.selectIndices(newIndex,newOffset,otherIndex,otherOffset):Sel.selectIndices(otherIndex,otherOffset,newIndex,newOffset)}else Sel.selectIndex(newIndex,newOffset);if(platform.isFirefox)if(e.normCode===KeyCode.LeftArrow){var prevChar=item.getParsedText()[Sel.getStartOffset()-1];if(prevChar===window.AttachChar&&!e.shiftKey)return Sel.selectItem(item,Sel.getStartOffset()-1),!1}else if(e.normCode===KeyCode.RightArrow){var nextChar=item.getParsedText()[Sel.getEndOffset()];if(nextChar===window.AttachChar&&!e.shiftKey)return Sel.selectItem(item,Sel.getEndOffset()+1),!1}isLeft?Sel.scrollStartIntoView():Sel.scrollEndIntoView();break;case A.Up:case A.Down:case A.Top:case A.Bottom:case A.PageUp:case A.PageDown:case A.PrevHeader:case A.NextHeader:var isUp=action===A.Up||action===A.Top||action===A.PageUp,isDown=action===A.Down||action===A.Bottom||action===A.PageDown,newIndex,newItem,offset;isUp&&(!e.shiftKey||Sel.isArrowSelectInverted())||isDown&&e.shiftKey&&Sel.isArrowSelectInverted()?(offset=Sel.getStartOffset(),newIndex=Sel.getStartIndex(),newItem=Sel.getStartItem()):(offset=Sel.getEndOffset(),newIndex=Sel.getEndIndex(),newItem=Sel.getEndItem());var origItem=newItem,caretPosStart=Measure.getCaretOffset(newItem,pane,offset,Sel.preferLineStart),targetLineOffset=caretPosStart.lineOffset,targetX=caretPosStart.left,newOffset;if(action===A.Up){var newLine=caretPosStart.line-1;if(0>newLine&&newIndex>0&&(newIndex=pane.indexOfPrevVMLI(newIndex,!1,!0),newIndex>=0)){newItem=pane.itemAtIndex(newIndex);var paddingDiff=pane.getPaddingForItem(origItem)-pane.getPaddingForItem(newItem);targetX+=paddingDiff;var prevLineInfo=Measure.getCaretOffset(newItem,pane);newLine=prevLineInfo.line}newLine>=0&&(newOffset=Measure.getOffsetForPositionInLine(newItem,pane,newLine,targetX,targetLineOffset))}else if(action===A.Down){var newLine=caretPosStart.line+1,itemMetrics=newItem.metricsInPane(pane);if(newLine>itemMetrics.styledLines.length-1)if(newIndex<pane.numItems()-1)if(newIndex=pane.indexOfNextVMLI(newIndex,!1,!0),newIndex>=0){newItem=pane.itemAtIndex(newIndex);var paddingDiff=pane.getPaddingForItem(origItem)-pane.getPaddingForItem(newItem);targetX+=paddingDiff,targetX=Math.max(targetX,0),newLine=0}else newLine=caretPosStart.line;else newLine=caretPosStart.line;newOffset=Measure.getOffsetForPositionInLine(newItem,Sel.getPane(),newLine,targetX,targetLineOffset)}else if(action===A.Top)newIndex=pane.indexOfFirstItem(),newOffset=0;else if(action===A.Bottom){var lastItem=pane.getLastItem(),numItems=pane.numItems();lastItem&&numItems>0&&(newIndex=pane.indexOfLastItem(),newOffset=lastItem.getParsedText().length)}else if(action===A.PageUp){var up=pane.indexPageUp(Sel.getStartIndex());newIndex=up,newOffset=0}else if(action===A.PageDown){var down=pane.indexPageDown(Sel.getStartIndex());newIndex=down;var item=pane.itemAtIndex(down);newOffset=item.getParsedText().length}else{if(action===A.PrevHeader&&pane.type!==PaneMode.Timeline){var item=Sel.getStartItem(),focusItem;if(item.parent()===g.focusedItem){if(!item.isFirstChild()){try{g.PAssert(3848,item.getIndex()>0,"Should never hit this with the first item in the list")}catch(PERR){g.reportError(PERR)}focusItem=item.parent().getChild(item.getIndex()-1)}}else{for(;item.parent()!==g.focusedItem;)item=item.parent();focusItem=item}return void 0!==focusItem&&Sel.selectItem(focusItem,-1),!1}if(action===A.NextHeader&&pane.type!==PaneMode.Timeline){var item=Sel.getEndItem(),focusItem;if(item.parent()===g.focusedItem)item.isLastChild()||(focusItem=item.parent().getChild(item.getIndex()+1));else{for(;item.parent()!==g.focusedItem;)item=item.parent();item.isLastChild()||(focusItem=item.parent().getChild(item.getIndex()+1))}return void 0!==focusItem&&Sel.selectItem(focusItem,-1),!1}}if(newIndex>=0&&!isNaN(newOffset))if(e.shiftKey){var otherIndex=Sel.isArrowSelectInverted()?Sel.getEndIndex():Sel.getStartIndex(),otherOffset=Sel.isArrowSelectInverted()?Sel.getEndOffset():Sel.getStartOffset();!Sel.isArrowSelectInverted()&&isUp&&(newIndex===Sel.getStartIndex()&&newOffset<Sel.getStartOffset()||newIndex<Sel.getStartIndex())?Sel.setArrowSelectInverted(!0):Sel.isArrowSelectInverted()&&isDown&&(newIndex===Sel.getEndIndex()&&newOffset>Sel.getEndOffset()||newIndex>Sel.getEndIndex())&&Sel.setArrowSelectInverted(!1),Sel.isArrowSelectInverted()?Sel.selectIndices(newIndex,newOffset,otherIndex,otherOffset):Sel.selectIndices(otherIndex,otherOffset,newIndex,newOffset)}else Sel.selectIndex(newIndex,newOffset);isUp?Sel.scrollStartIntoView():Sel.scrollEndIntoView();break;case A.All:this.handleSelectAll(pane)}return action!==A.None?!1:!0},keydown:function keydownFn(pane,e){this.isTyping=!0;var ret=!0;return keyCodesDown.indexOf(e.normCode)>=0?ret=this.keypress(pane,e,!0):platform.mac&&e.ctrlKey&&e.normCode===KeyCode.D?ret=this.keypress(pane,e,!0):keyCodesArrows.indexOf(e.normCode)>=0?(g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),ret=this.handleArrows(pane,e),g.vmMain.resetItemAnimationMode(),platform.ios||this.updateAutocomplete(e)):platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey&&!e.altKey?(e.normCode===KeyCode.Y||e.normCode===KeyCode.Z)&&(ret=this.keypress(pane,e,!0)):platform.mac&&e.ctrlKey&&e.normCode===KeyCode.H&&this.preventDefault(e),!platform.mobile&&ret&&this.keyWantsScrollIntoView(e,!0)&&Sel.scrollStartIntoView(),ret},checkKeypressSpecialCases:function checkKeypressSpecialCasesFn(e,character){var forceValid;return e.ctrlKey&&e.altKey&&character?forceValid=!0:e.metaKey&&e.normCode===KeyCode.Tilde&&(forceValid=!1),forceValid},allowTextEditing:function allowTextEditingFn(item){try{g.PAssert(3849,item,"Must provide a valid item to check")}catch(PERR){g.reportError(PERR)}var allowTextEditing=!1;return platform.mobile?(!android.isEnabled()||item&&!item.hasAttachments())&&(allowTextEditing=!0):allowTextEditing=!0,g.vmMain.pluginManager.allowTextEditing(item)||(allowTextEditing=!1),allowTextEditing},isMultiselectDangerous:function isMultiselectDangerousFn(){var pane=g.focusedPane;if(pane.type===PaneMode.Timeline)return"Are you sure you want to delete multiple items from the agenda?";for(var startIndex=pane.indexOfNextVMLI(Sel.getStartIndex()-1),endIndex=pane.indexOfPrevVMLI(Sel.getEndIndex()+1),index=pane.indexOfNextVMLI(startIndex),fscount=0,num=0;index&&index>=0&&(endIndex>index||index===endIndex&&Sel.getEndOffset()===Sel.getEndTotal());){var item=pane.itemAtIndex(index);item.parent()===g.focusedPane.getItem()&&item.isHeader()&&fscount++,num++,index=pane.indexOfNextVMLI(index)}return num>=16&&fscount>=2&&"You have selected a large number of items to delete. Please confirm you want to perform this action."},keypress:function keypressFn(element,e,fromKeydown,multiselectOK){var keyCodes=[KeyCode.Enter,KeyCode.D];try{g.PAssert(3850,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.stopPropagation&&e.stopPropagation(),android.isEnabled()&&android.updateSel();var returnValue=!0,validCharacter=e.normCode>=32||keyCodes.indexOf(e.normCode)>=0,skipCharacter=platform.mobile&&e.normCode===KeyCode.Delete||0===e.which;if(!skipCharacter&&(fromKeydown||validCharacter)){if(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey){var keyChar=String.fromCharCode(e.normCode);switch(keyChar){case"c":case"C":return e.handled=!0,!0;case"v":case"V":return e.handled=!0,!0;case"x":case"X":return e.handled=!0,!0;case"Y":case"y":case"Z":case"z":try{g.PAssert(3851,!1,"Should not be handled undo/redo hotkeys here")}catch(PERR){g.reportError(PERR)}return e.handled=!0,!0;case"r":case"R":case"a":case"A":case"t":case"T":return e.handled=!0,!0}}var item=Sel.getStartItem(),startObject=Sel.getStartObject();tracker.beginAction();var specialKeys=[KeyCode.Tab,KeyCode.Enter,KeyCode.BackSpace,KeyCode.Delete,KeyCode.D];if(Sel.getStartIndex()!==Sel.getEndIndex()&&e.normCode!==KeyCode.Tab&&(!e.metaKey&&!e.ctrlKey&&!e.optKey||specialKeys.indexOf(e.normCode)>=0))if(g.focusedPane.type===PaneMode.Timeline)g.toasts.pushMessage({text:"Deleting multiple items from this pane is not currently supported. Please delete them individually.",actionText:"OKAY"}),returnValue=!1;else{g.vmMain.beginUpdateItems();var dangerousText;if(!multiselectOK&&(dangerousText=this.isMultiselectDangerous())){var sel=Sel.save();g.menus.confirm(dangerousText,function(value){Sel.restore(sel),value&&this.keypress(element,e,fromKeydown,!0)}.bind(this)),returnValue=!1}else returnValue=g.focusedPane.isEditable?returnValue&&this.handleMultiselect(e):!1;g.vmMain.commitUpdateItems()}returnValue&&specialKeys.indexOf(e.normCode)>=0&&(g.vmMain.beginUpdateItems(),e.ctrlKey||e.normCode!==KeyCode.Tab?e.normCode===KeyCode.Enter?(g.focusedPane.type===PaneMode.Timeline&&(g.focusedPane.preventUpdateItemsForItem=!1),returnValue=g.focusedPane.isEditable?returnValue&&this.handleEnter(e):!1):e.normCode===KeyCode.BackSpace?returnValue=this.allowTextEditing(item)&&g.focusedPane.isEditable?returnValue&&this.handleBackspace(e):!1:(e.normCode===KeyCode.Delete||platform.mac&&e.ctrlKey&&e.normCode===KeyCode.D)&&(returnValue=this.allowTextEditing(item)&&g.focusedPane.isEditable?returnValue&&this.handleDelete(e):!1):g.focusedPane.type===PaneMode.Timeline?returnValue=!1:g.focusedPane.isEditable&&(returnValue=returnValue&&this.handleTab(e)),g.vmMain.commitUpdateItems());var keyCode=e.normCode;e.normCode!==KeyCode.Period||fromKeydown||(keyCode=KeyCode.Delete);var character=String.fromCharCode(keyCode),isValid=returnValue&&character&&e.normCode!==KeyCode.BackSpace&&e.normCode!==KeyCode.Enter&&!e.ctrlKey&&!e.metaKey,forceValid=this.checkKeypressSpecialCases(e,character);if(forceValid===!0?isValid=!0:forceValid===!1&&(isValid=!1),isValid){var item=Sel.getStartItem();if(Sel.isValid()&&this.allowTextEditing(item)&&g.focusedPane.isEditable){var s;s=android.isEnabled()?android.getInputText():item.getParsedText();var newText=s.substr(0,Sel.getStartOffset())+character+s.substr(Sel.getEndOffset());if(Sel.getStartOffset()!==Sel.getEndOffset()&&tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset(),text:s.slice(Sel.getStartOffset(),Sel.getEndOffset())}),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:Sel.getStartOffset(),text:character}),platform.ios)textSaveInfo.text=newText,textSaveInfo.startIndex=Sel.getStartIndex(),textSaveInfo.start=Sel.getStartOffset()+1,textSaveInfo.waitAutocorrect=" "===character?"space":void 0,textSaveInfo.item=item,returnValue=!0;else{var startOffset=Sel.getStartOffset();item.setText(newText,!0,ChangeType.Local);var startIndex=g.focusedPane.indexOfObject(startObject);startIndex>=0?Sel.selectIndex(startIndex,startOffset+1):Sel.reset(),returnValue=!1,this.preventDefault(e)}}else returnValue=!1}tracker.endAction()}return lastKeypress=e.normCode,!platform.mobile&&this.keyWantsScrollIntoView(e,fromKeydown)&&Sel.scrollStartIntoView(),platform.ios||this.updateAutocomplete(e),returnValue},textInputiOS:function textInputiOSFn(pane,e){try{g.PAssert(3852,platform.ios||platform.android||platform.mac||platform.windows,"Should only ever use textInput events on iOS or OSX")}catch(PERR){g.reportError(PERR)}var returnValue=!0;try{g.PAssert(3853,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}if(e.stopPropagation&&e.stopPropagation(),!Sel.isValid())return e.stopPropagation(),e.preventDefault(),!1;tracker.beginAction();var incText=e.data;try{g.PAssert(3854,incText&&incText.length>0,"Must have valid incoming text: ",e)}catch(PERR){g.reportError(PERR)}incText&&!g.isString(incText)&&e.detail&&(incText=e.detail.data);var incTextLength=0;incText&&g.isString(incText)&&(incText=incText.replace(/(\r\n|\n|\r)/g,""),incTextLength=incText.length);var item,index,startOffset,endOffset,delLength=0,s;if(platform.ios){var range=NativeSel.getSelectionRange(),element=range.getStartElement();if(!element)return!1;var offsets=range.getSelectOffsetsInElement(element),reactCell=g.getReactCellForElement(element);item=g.getItemForElement(element),index=reactCell.getIndex(),startOffset=offsets.start,endOffset=offsets.end,s=item.getParsedText(),delLength=s.length-offsets.total}else{if(Sel.getStartItem()!==Sel.getEndItem())return!1;if(item=Sel.getStartItem(),index=Sel.getStartIndex(),startOffset=Sel.getStartOffset(),endOffset=Sel.getEndOffset(),s=item.getParsedText(),!this.isComposing){var range=NativeSel.getSelectionRange(),start=range.getStartOffset(),end=range.getEndOffset();end-start>0&&(item=Sel.getStartItem(),index=Sel.getStartIndex(),s=item.getParsedText(),delLength=end-start,startOffset=Sel.getStartOffset()-delLength,endOffset=Sel.getEndOffset()-delLength)}}if(!this.allowTextEditing(item))return!1;var incIndex=!1;if(startOffset!==endOffset&&0===delLength&&platform.ios){var endIndex=s.indexOf(" ",endOffset);0>endIndex&&(endIndex=s.length);var fullWord=s.substring(startOffset,endIndex),trimWord=g.trimPunc(fullWord);try{g.PAssert(3856,endOffset<=startOffset+trimWord.length,"Should never shorten a word being replaced by autocomplete")}catch(PERR){g.reportError(PERR)}endOffset=startOffset+trimWord.length;try{g.PAssert(3857,endOffset<=Sel.getEndTotal())}catch(PERR){g.reportError(PERR)}}else textSaveInfo&&"enter"===textSaveInfo.waitAutocorrect&&textSaveInfo.useNext&&(incIndex=!0);var newText=s.substr(0,startOffset)+incText+s.substr(endOffset+delLength);if(startOffset!==endOffset&&tracker.performAction(TrackerType.Remove,{itemID:item.id,position:startOffset,text:s.slice(startOffset,endOffset)}),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:startOffset,text:incText}),item.setText(newText,!0,ChangeType.Local),incIndex?(index++,startOffset=0):startOffset+=incTextLength,platform.ios){var startElement=pane.elementAtIndex(index);Sel.selectElements(startElement,startOffset,startElement,startOffset)}else Sel.selectIndex(index,startOffset);returnValue=!1;try{g.PAssert(3858,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),tracker.endAction(),textSaveInfo.item=void 0,returnValue},handleMultiselect:function handleMultiselectFn(e){var pane=g.focusedPane,startIndex=pane.indexOfNextVMLI(Sel.getStartIndex()-1),endIndex=pane.indexOfPrevVMLI(Sel.getEndIndex()+1),startOffset=Sel.getStartOffset(),endOffset=Sel.getEndOffset();Sel.selectIndices(startIndex,startOffset,endIndex,endOffset);var levelsDeep2=0,returnValue=!0,startObject=pane.objectAtIndex(startIndex),endObject=pane.objectAtIndex(endIndex),startItem=Sel.getStartItem(),endItem=Sel.getEndItem();if(startItem.isNote()&&(startItem=startItem.parent()),endItem.isNote()&&(endItem=endItem.parent()),!pane.hasNonVMLIs&&startItem===endItem)return!1;if(e.normCode===KeyCode.Enter&&e.shiftKey)return!0;for(var nextItem=startItem,arrToDelete=[],endIndex=endIndex,index=pane.indexOfNextVMLI(startIndex),fscount=0;index&&index>=0&&(endIndex>index||index===endIndex&&Sel.getEndOffset()===Sel.getEndTotal());){var item=pane.itemAtIndex(index);item.parent()===g.focusedPane.getItem()&&item.isHeader()&&fscount++,arrToDelete.indexOf(item)<0&&item!==startItem&&arrToDelete.push(item),index=pane.indexOfNextVMLI(index)}var levelsDeep=Sel.getEndItem().levelsDeep.get()-Sel.getStartItem().levelsDeep.get(),newStartText;if(Sel.getStartOffset()>0||Sel.getEndOffset()<Sel.getEndTotal()){var startTextInfo=startItem.splitUsableText(startItem.getParsedText(),Sel.getStartOffset(),Sel.getStartOffset()),textAddedInfo=endItem.splitUsableText(endItem.getParsedText(),Sel.getEndOffset(),Sel.getEndOffset());newStartText=startTextInfo.before+textAddedInfo.after,tracker.performAction(TrackerType.Remove,{itemID:startItem.id,position:Sel.getStartOffset(),text:startItem.getParsedText().slice(Sel.getStartOffset())}),tracker.performAction(TrackerType.Insert,{itemID:startItem.id,position:Sel.getStartOffset(),text:endItem.getParsedText().substring(Sel.getEndOffset())}),arrToDelete.indexOf(endItem)<0&&arrToDelete.push(endItem),0===Sel.getStartOffset()&&startItem.copyProperties(endItem)}else tracker.performAction(TrackerType.Remove,{itemID:startItem.id,position:0,text:startItem.getParsedText()}),newStartText="";if((e.normCode===KeyCode.BackSpace||e.normCode===KeyCode.Delete||e.normCode===KeyCode.Enter)&&(returnValue=!1),startItem.setText(newStartText,!0,ChangeType.Local),endItem.moveChildren(startItem,0,ChangeType.Local),levelsDeep>0){for(var arrToMove2=[],arrToMove=[],next=endItem.nextSibling();levelsDeep>0&&next;){var index=next.getIndex(),nextItems=next.parent().getItems().slice(index);arrToMove=arrToMove.concat(nextItems),next=next.parent().nextSibling(),levelsDeep--}if(arrToMove.length>0)for(var parentToMoveTo=startItem,index=0,i=0;i<arrToMove.length;i++){var item=arrToMove[i],oldParent=item.parent();if(arrToDelete.indexOf(oldParent)>=0){var oldIndex=item.getIndex();item.moveTo({parent:parentToMoveTo,index:index},ChangeType.Local),tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:oldParent.id,oldPosition:oldIndex,newParent:parentToMoveTo.id,newPosition:index}),index++}}}else if(arrToDelete.indexOf(endItem.parent())>=0)for(var parentToMoveTo=startItem.parent(),item=pane.getNextItem(endIndex,!0);item;){var index=parentToMoveTo.numItems(),oldParent=item.parent(),oldIndex=oldParent.getChildIndex(item);item.moveTo({parent:parentToMoveTo,index:index},ChangeType.Local),tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:oldParent.id,oldPosition:oldIndex,newParent:parentToMoveTo.id,newPosition:index}),item=pane.getNextItem(endIndex,!0)}for(var i=0;i<arrToDelete.length;i++){var item=arrToDelete[i];try{g.PAssert(3859,item,"Item must exist")}catch(PERR){g.reportError(PERR)}item.isDeleted()||item.parent().deleteChild(item,void 0,void 0,ChangeType.Local)}if(pane.hasNonVMLIs){var newStartIndex=pane.closestIndexOfObject(startObject);try{g.PAssert(3860,newStartIndex>0,"Could not find item to select")}catch(PERR){g.reportError(PERR)}newStartIndex>0&&Sel.selectIndex(newStartIndex,Sel.getStartOffset())}else Sel.selectIndex(startIndex,startOffset);return returnValue},handleTab:function handleTabFn(e){g.vmMain.beginUpdateItems();var pane=Sel.getPane(),startItem=Sel.getStartItem(),endItem=Sel.getEndItem(),startIndex=Sel.getStartIndex(),endIndex=Sel.getEndIndex(),indent=e.normCode===KeyCode.Tab&&!e.shiftKey||e.normCode===KeyCode.RightArrow,origStartItem=startItem;startItem&&startItem.isNote()&&(startItem=startItem.parent());var origEndItem=endItem;endItem&&endItem.isNote()&&(endItem=endItem.parent());var nextItem=startItem,needUpdate={},itemsToTab=[startItem],newParent,moved={},itemsHighlighted={};if(itemsHighlighted[startItem.id]=!0,startItem!==endItem)do{var nextItemOptions={numLevels:0,ignoreSearch:!0};nextItem=g.getNextItem(nextItem,pane,nextItemOptions),nextItem&&(itemsToTab.push(nextItem),itemsHighlighted[nextItem.id]=!0)}while(nextItem!==endItem&&void 0!==nextItem);var i,initial,condition,increment;for(e.shiftKey?(initial=function(){i=itemsToTab.length-1},condition=function(){return i>=0},increment=function(){i--}):(initial=function(){i=0},condition=function(){return i<itemsToTab.length},increment=function(){i++}),initial();condition();increment()){var item=itemsToTab[i];try{g.PAssert(3861,item,"Must always be tabbing/untabbing valid items")}catch(PERR){g.reportError(PERR)}var parent=item.parent(),index=parent.getItems().indexOf(item),ok,u;if(indent){if(ok=index>0){for(newParent=parent.itemAtIndex(index-1);newParent.isHidden(pane);){if(index--,0>=index)return g.vmMain.commitUpdateItems(),!1;newParent=parent.itemAtIndex(index-1)}moved[parent.id]||(needUpdate[item.parent().id]=item.parent(),needUpdate[newParent.id]=newParent,item.moveTo({parent:newParent,fromTab:!0},ChangeType.Local)),moved[item.id]=!0,tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:parent.id,oldPosition:index,newParent:newParent.id,newPosition:newParent.numItems()-1})}else newParent=parent,moved[item.id]=moved[parent.id];for(var moveSiblings=!1,parentMoved=item;parentMoved;){if(moved[parentMoved.id]){parentMoved.isCollapsed(pane,!1)||(moveSiblings=!0);break}parentMoved=parentMoved.parent()}var siblingStartIndex=item.getIndex()+1;if(moveSiblings){var items=item.getItems(),numMoved=0;for(u=0;u<items.length;u++){var child=items[u];if(!itemsHighlighted[child.id]){if(child.isHidden(pane,!1))continue;needUpdate[child.parent().id]=child.parent(),needUpdate[item.parent().id]=item.parent();var moveIndex=siblingStartIndex+numMoved;child.moveTo({parent:item.parent(),index:moveIndex,fromTab:!0},ChangeType.Local),moved[child.id]=!0,tracker.performAction(TrackerType.Move,{itemID:child.id,oldParent:item.id,oldPosition:u,newParent:item.parent().id,newPosition:moveIndex}),numMoved++,u--}}}}else if(ok=item.parent()!==g.focusedItem){newParent=item.parent().parent();var parentItems=parent.getItems();for(u=index+1;parentItems[index+1];){var siblingItem=parentItems[index+1];itemsHighlighted[siblingItem.id]||siblingItem.isHidden(pane)?index++:(needUpdate[siblingItem.parent().id]=siblingItem.parent(),needUpdate[item.id]=item,siblingItem.moveTo({parent:item,fromTab:!0},ChangeType.Local),moved[siblingItem.id]=!0,tracker.performAction(TrackerType.Move,{itemID:siblingItem.id,oldParent:parent.id,oldPosition:u,newParent:item.id,newPosition:item.numItems()-1})),u++}if(itemsHighlighted[parent.id]>=0&&(!parent.parent()||parent.parent()!==g.focusedItem))continue;var parentIndex=newParent.getItems().indexOf(parent);needUpdate[item.parent().id]=item.parent(),needUpdate[newParent.id]=newParent,item.moveTo({parent:newParent,index:parentIndex+1,fromTab:!0},ChangeType.Local),moved[item.id]=!0,tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:parent.id,oldPosition:index,newParent:newParent.id,newPosition:parentIndex+1})}}if(g.vmMain.commitUpdateItems(!1,!0),android.isEnabled())android.updateInputBounds(startItem);else if(startItem||endItem){try{g.PAssert(3862,startItem&&endItem)}catch(PERR){g.reportError(PERR)}Sel.selectIndices(Sel.getStartIndex(),Sel.getStartOffset(),Sel.getEndIndex(),Sel.getEndOffset())}e.handled=!0;try{g.PAssert(3863,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1},handleEnter:function handleEnterFn(e){var pane=g.focusedPane,item=Sel.getStartItem();if(!item){try{g.PAssert(3864,!1,"Invalid item in handleEnter")}catch(PERR){g.reportError(PERR)}return!1}var parent=item.parent();if(!parent){try{g.PAssert(3865,!1,"Invalid parent in handleEnter")}catch(PERR){g.reportError(PERR)}return!1}var index=parent.getItems().indexOf(item),forcedToRoot=!1;android.isEnabled()&&android.finishInput(!0);var text=item.getParsedText(),item2,addToChild=!1,newParent=parent,startObject=Sel.getStartObject();if(e.shiftKey)return item.isNote()||item.editNote(),e.preventDefault(),!1;if(!item.isNote()){var useNextItem=!0,copyProperties=!1,itemParams={text:""};if(pane.setIgnoreRestoreScroll(!0),pane.type===PaneMode.Timeline){var itemObject=Sel.getStartObject(),block=itemObject.block;block.isStarred?itemParams.isStarred=!0:block.isImportant?itemParams.priority=item.priority():block.date&&item.dateText&&(itemParams.text=" @"+item.dateText),item.shouldSave()||(newParent=d.getRootModel(),index=-1,forcedToRoot=!0)}else if(item.hasAttachmentType(C.PluginType.Calendar));else if(0===Sel.getEndOffset()&&""!==text)index--,useNextItem=!1;else if(Sel.getStartOffset()>=Sel.getStartTotal())addToChild=!item.isCollapsed(pane,!1)&&(item.numItems()>0||item.isHeader()),addToChild&&(newParent=item);
else if(0===Sel.getStartOffset()&&Sel.getEndOffset()===Sel.getEndTotal())item.setText("",!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text});else{var splitText=item.splitUsableText(text,Sel.getStartOffset(),Sel.getEndOffset());itemParams.text=splitText.after,g.vmMain.setItemAnimationMode(C.ItemAnimationMode.Move),item.setText(splitText.before,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.substring(0,Sel.getEndOffset())}),copyProperties=!0,addToChild=!item.isCollapsed(pane,!1)&&(item.numItems()>0||item.isHeader()),addToChild&&(newParent=item)}if(item2=d.createVMLI(itemParams,{parent:newParent,changeType:ChangeType.AllLocal}),copyProperties&&item2.copyProperties(item),item2.parseText(!0,ChangeType.Local|ChangeType.All),addToChild)item.insertItem(item2,0),tracker.performAction(TrackerType.Create,{itemID:item2.id,parent:item.id,position:0,text:item2.getParsedText()});else{try{g.PAssert(3866,!item2.isNote(),"Should never be inserting a note here")}catch(PERR){g.reportError(PERR)}newParent.insertItem(item2,index+1),tracker.performAction(TrackerType.Create,{itemID:item2.id,parent:newParent.id,position:index+1,text:item2.getParsedText()})}g.vmMain.resetItemAnimationMode();var selectItem=useNextItem?item2:item;try{g.PAssert(3867,selectItem,"Expected another item to exist")}catch(PERR){g.reportError(PERR)}if(platform.ios)return textSaveInfo.startIndex=Sel.getStartIndex(),textSaveInfo.start=Sel.getStartOffset(),textSaveInfo.waitAutocorrect="enter",textSaveInfo.item=useNextItem?item:item2,textSaveInfo.nextItem=useNextItem?item2:item,textSaveInfo.useNext=useNextItem,!0;var indexOfStartObject=pane.indexOfObject(startObject),selectIndex=useNextItem?pane.indexOfNextVMLI(indexOfStartObject,!1,!0):indexOfStartObject,selectOffset=0;if(0>selectIndex){var lastIndex=pane.indexOfLastItem(),lastItem=pane.getLastItem();lastIndex>=0&&lastIndex!==indexOfStartObject&&lastItem&&(selectIndex=lastIndex,selectOffset=lastItem.getParsedText().length)}selectIndex>=0&&Sel.selectIndex(selectIndex,selectOffset,selectOffset);try{g.PAssert(3868,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}return e.preventDefault&&e.preventDefault(),!1}if(platform.ios);else if(!android.isEnabled())return e.preventDefault(),!1},handleBackspace:function handleBackspaceFn(e){var item=Sel.getStartItem(),startIndex=Sel.getStartIndex(),pane=g.focusedPane;if(!item){try{g.PAssert(3869,!1,"Invalid item in handleBackspace")}catch(PERR){g.reportError(PERR)}return!1}var parent=item.parent();try{g.PAssert(3870,parent,"Must always have a valid parent for an item")}catch(PERR){g.reportError(PERR)}android.isEnabled()&&android.finishInput(!0),platform.ie&&(e.preventDefault(),e.stopImmediatePropagation());var text=item.getParsedText(),newText="",newTextOffset=0,ok=!0,hasCalendarAttach=item.hasAttachmentType(C.PluginType.Calendar);if(0===Sel.getStartOffset()&&0===Sel.getEndOffset()||""===text)if(item.isNote()&&""!==text)ok=!1;else if(hasCalendarAttach)ok=!1;else if(Sel.getStartIndex()>0){var prevIndex=g.focusedPane.indexOfPrevVMLI(Sel.getStartIndex(),!0,!0),prev=prevIndex>=0&&g.focusedPane.itemAtIndex(prevIndex);if(prev){if(pane.type===PaneMode.Timeline&&(text=text.replace("@"+item.dateText,"").trim(),0!==text.length&&(ok=!1)),ok){pane.setIgnoreRestoreScroll(!0);var prevText=prev.getParsedText(),selectIndex=prev.isFullscreen()?0:prevIndex,objToSelect=pane.objectAtIndex(selectIndex),selectOffset=prev.isFullscreen()?0:prevText.length;Sel.selectIndex(selectIndex,selectOffset),parent.deleteChild(item,prev,0,ChangeType.Local),text.length>0&&""!==text&&(0===prevText.length&&prev.copyProperties(item),prev.setText(prev.generateSaveText(prevText)+item.generateSaveText(text),!0,ChangeType.Local),item.hasNote()&&(prev.hasNote()||prev.moveNote(item,ChangeType.Local)),tracker.performAction(TrackerType.Insert,{itemID:prev.id,position:prevText.length,text:text})),selectIndex=pane.indexOfObject(objToSelect),Sel.selectIndex(selectIndex,selectOffset),ok=!1}}else ok=!1}else ok=!1;else if(0===Sel.getStartOffset()&&Sel.getEndOffset()===text.length)tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:item.getParsedText()}),newText="",newTextOffset=0;else if(e.metaKey)if(item.isNote()){var lastLine=text.prevIndexOf("\n",Sel.getEndOffset());0>lastLine?(newText=text.substring(Sel.getEndOffset()),newTextOffset=0,tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,Sel.getEndOffset())})):(newText=text.substring(0,lastLine)+text.substring(Sel.getEndOffset()),newTextOffset=lastLine,tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(lastLine,Sel.getEndOffset())}))}else newText=text.substring(Sel.getEndOffset()),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,Sel.getEndOffset())}),newTextOffset=0;else if((platform.mac&&e.altKey||!platform.mac&&e.ctrlKey)&&Sel.getStartOffset()===Sel.getEndOffset()){var endOfText=text.substring(Sel.getStartOffset()),subIndex=EditHelpers.getPreviousWord(text,Sel.getStartOffset()-1)+1;subIndex>=0?(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:subIndex,text:text.slice(subIndex,Sel.getStartOffset())}),newText=text.substring(0,subIndex)+endOfText,newTextOffset=subIndex):(Sel.getStartOffset()===text.length?0===Sel.getStartOffset()&&(newText="",tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text})):(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,Sel.getStartOffset())}),newText=endOfText),newTextOffset=0)}else if(Sel.getStartOffset()!==Sel.getEndOffset()){var deletedText=text.slice(Sel.getStartOffset(),Sel.getEndOffset());hasCalendarAttach&&deletedText.indexOf(window.AttachChar)>=0&&deletedText.indexOf(window.DatePrefix)<0?(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset(),text:deletedText.replace(window.AttachChar,"")}),newText=text.substr(0,Sel.getStartOffset())+text.substr(Sel.getEndOffset())+window.AttachChar):(tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset(),text:deletedText}),newText=text.substr(0,Sel.getStartOffset())+text.substr(Sel.getEndOffset())),newTextOffset=Sel.getStartOffset()}else{var sub=1;text.length>1&&""===text[Sel.getStartOffset()-1]&&sub++,hasCalendarAttach&&text.charAt(Sel.getStartOffset()-1)===window.AttachChar?" "===text.charAt(Sel.getStartOffset()-2)?(newText=text.substr(0,Sel.getStartOffset()-3)+text.substr(Sel.getStartOffset()-2),newTextOffset=Sel.getStartOffset()-3):(newText=text.substr(0,Sel.getStartOffset()-2)+text.substr(Sel.getStartOffset()-1),newTextOffset=Sel.getStartOffset()-2):(newText=text.substr(0,Sel.getStartOffset()-sub)+text.substr(Sel.getStartOffset()),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset()-sub,text:text.slice(Sel.getStartOffset()-sub,Sel.getStartOffset())}),newTextOffset=Sel.getStartOffset()-sub),!hasCalendarAttach||newText!==" "+window.AttachChar&&newText!==window.AttachChar||(newText="",newTextOffset=0)}if(ok){if(platform.ios)return textSaveInfo.text=newText,textSaveInfo.startIndex=startIndex,textSaveInfo.start=newTextOffset,textSaveInfo.item=item,textSaveInfo.innerHTML=e.target&&e.target.innerHTML,!1;item.setText(newText,!0,ChangeType.Local),Sel.selectIndex(startIndex,newTextOffset)}return!1},handleDelete:function handleDeleteFn(e){var item=Sel.getStartItem(),pane=g.focusedPane;if(!item)return!1;var parent=item.parent(),text=item.getParsedText(),ok=!0,newText,hasCalendarAttach=item.hasAttachmentType(C.PluginType.Calendar);if(""===text){if(pane.type===PaneMode.Timeline)ok=!1;else if(item.isNote())parent.setNote(void 0,ChangeType.Local),Sel.selectItem(parent,-1);else if(Sel.getStartIndex()<pane.numItems()-1){var index=Sel.getStartIndex();pane.setIgnoreRestoreScroll(!0),pane.numItems()>1&&(item.hasChildren()?parent.replaceChild(item,item.getFirstChild(),ChangeType.Local):parent.deleteChild(item,parent,index,ChangeType.Local))}}else if(Sel.getStartOffset()===Sel.getStartTotal()&&Sel.getEndOffset()===Sel.getEndTotal())if(pane.type===PaneMode.Timeline)ok=!1;else if(item.isNote())ok=!1;else{var nextIndex=pane.indexOfNextVMLI(Sel.getStartIndex(),!0,!0),next=nextIndex>=0&&pane.itemAtIndex(nextIndex);if(pane.setIgnoreRestoreScroll(!0),next){var text=item.generateSaveText(text),nextText=next.getParsedText();ok&&(item.setText(text+nextText,!0,ChangeType.Local),tracker.performAction(TrackerType.Insert,{itemID:item.id,position:text.length,text:next.getParsedText()}),next.parent().deleteChild(next,item,0,ChangeType.Local),Sel.selectIndex(Sel.getEndIndex(),Sel.getEndOffset()))}}else if(e.metaKey)item.isNote()||(newText=text.substring(0,Sel.getStartOffset()),item.setText(newText,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:0,text:text.slice(0,Sel.getStartOffset())}),Sel.selectIndex(Sel.getStartIndex(),Sel.getStartOffset()));else if((platform.mac&&e.altKey||!platform.mac&&e.ctrlKey)&&Sel.getStartOffset()===Sel.getEndOffset()){var subIndex=EditHelpers.getNextWord(text,Sel.getStartOffset()+1);0>subIndex&&(subIndex=Sel.getStartTotal()),subIndex>=0&&(newText=text.substring(0,Sel.getStartOffset())+text.substring(subIndex),item.setText(newText,!0,ChangeType.Local),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:subIndex,text:newText}),Sel.selectIndex(Sel.getStartIndex(),Sel.getStartOffset()))}else{if(Sel.getStartOffset()!==Sel.getEndOffset()){var deletedText=text.slice(Sel.getStartOffset(),Sel.getEndOffset());hasCalendarAttach&&deletedText.indexOf(window.AttachChar)>=0&&deletedText.indexOf(window.DatePrefix)<0?(newText=text.substr(0,Sel.getStartOffset())+text.substr(Sel.getEndOffset())+window.AttachChar,tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset(),text:text.slice(Sel.getStartOffset(),Sel.getEndOffset())})):(newText=text.substr(0,Sel.getStartOffset())+text.substr(Sel.getEndOffset()),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset(),text:text.slice(Sel.getStartOffset(),Sel.getEndOffset())}))}else hasCalendarAttach&&text.charAt(Sel.getStartOffset())===window.AttachChar||(newText=text.substr(0,Sel.getStartOffset())+text.substr(Sel.getStartOffset()+1),tracker.performAction(TrackerType.Remove,{itemID:item.id,position:Sel.getStartOffset(),text:text.slice(Sel.getStartOffset(),Sel.getStartOffset()+1)}));!hasCalendarAttach||newText!==" "+window.AttachChar&&newText!==window.AttachChar&&newText!==" "+window.AttachChar&&text!==window.AttachChar||(newText=""),void 0!==newText&&(item.setText(newText,!0,ChangeType.Local),Sel.selectIndex(Sel.getStartIndex(),Sel.getStartOffset()))}return!1},keyWantsScrollIntoView:function keyWantsScrollIntoViewFn(e,fromKeydown){switch(e.normCode){case KeyCode.LeftMeta:case KeyCode.RightMeta:case KeyCode.Alt:case KeyCode.Shift:case KeyCode.Ctrl:case KeyCode.LeftArrow:case KeyCode.RightArrow:case KeyCode.UpArrow:case KeyCode.DownArrow:return!1}return platform.mac&&e.metaKey&&(fromKeydown&&e.normCode===KeyCode.Tilde||!fromKeydown&&"`"===String.fromCharCode(e.normCode))?!1:!(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)||e.normCode!==KeyCode.Z&&e.normCode!==KeyCode.Y?e.normCode>=KeyCode.F1&&e.normCode<=KeyCode.F12?!1:!0:!1}},new edit}),define("EmailHTML",["require","exports","module","globals"],function(require,exports,module){function EmailHTML(){}function parseResourceID(resourceString){var resourceID;resourceRegex.lastIndex=0;var resMatch=resourceRegex.exec(resourceString);return resMatch&&resMatch[1]&&(resourceID=resMatch[1]),resourceID}var g=require("globals"),sanitizeSchemes={Default:{bannedTags:["style","script","source","track","iframe","frame","frameset","button","input","audio","video","math","svg","link","comment","base","object","embed"],allowedAttributes:["abbr","accept","acceptcharset","accesskey","align","alt","async","autocomplete","axis","background","border","bordercolor","bgcolor","cellpadding","cellspacing","char","charoff","charset","checked","class","classid","classname","color","colspan","cols","content","contextmenu","controls","coords","data","datetime","defer","dir","disabled","download","draggable","enctype","form","formaction","formenctype","formmethod","formnovalidate","formtarget","frame","frameborder","headers","height","hidden","high","href","hreflang","htmlfor","httpequiv","icon","id","itemscope","itemtype","itemid","itemprop","itemref","label","lang","list","loop","low","manifest","marginheight","marginwidth","max","maxlength","media","mediagroup","method","min","multiple","muted","name","novalidate","nowrap","open","optimum","pattern","placeholder","poster","preload","radiogroup","readonly","rel","required","role","rowspan","rows","rules","sandbox","scope","scoped","scrolling","seamless","selected","shape","size","sizes","sortable","sorted","span","spellcheck","src","srcdoc","srcset","start","step","style","summary","tabindex","target","title","translate","type","usemap","valign","value","width","wmode"],allowedTagAttributes:{A:["href","name"],IMG:["src","alt"],FONT:["face"],HTML:["xmlns"],BODY:["text","link","alink","vlink"],META:["http-equiv"]}}},resourceRegex=/^<(.*)>$/,protocolRegexp=/^[^:]+(?=:)/;return EmailHTML.prototype={update:function updateFn(decoded,resources,options,mimeType){var data;return"text/plain"===mimeType?data=this._parsePlain(decoded,resources,options):"text/html"===mimeType?data=this._parseHTML(decoded,resources,options):g.reportError("Unknown email mimeType: ",mimeType),data.parsed=this._escapeHTMLEntities(data.parsed),data},_escapeHTMLEntities:function _escapeHTMLEntitiesFn(value){var SurrogatePairRegexp=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,NonPrintableASCII=/[\x01-\t\x0B\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g;return value.replace(SurrogatePairRegexp,function(value){var hi=value.charCodeAt(0),low=value.charCodeAt(1);return"&#"+(1024*(hi-55296)+(low-56320)+65536)+";"}).replace(NonPrintableASCII,function(value){return"&#x"+value.charCodeAt(0).toString(16).toUpperCase()+";"})},getAttachmentLinks:function getAttachmentLinksFn(decoded){var specialLinks=[],doc=this._createDoc(decoded);if(doc){var links=this._findLinkElements(doc);try{specialLinks=this._findSpecialLinks(links).attachments}catch(err){g.reportError(err)}}return specialLinks},generatePlaintext:function generatePlaintextFn(decoded,options){var doc=this._createDoc(decoded);return doc.body.innerText},replaceSignature:function replaceSignatureFn(decoded,newSignature){var output,doc=this._createDoc(decoded),sigEle=this._findActiveSignature(doc);if(sigEle){var hadSignature=!!sigEle.innerHTML;if(sigEle.innerHTML=newSignature||"",newSignature)hadSignature||(sigEle.parentNode.insertBefore(document.createElement("br"),sigEle),sigEle.parentNode.insertBefore(document.createElement("br"),sigEle),sigEle.parentNode.insertBefore(document.createTextNode("--"),sigEle),sigEle.parentNode.insertBefore(document.createElement("br"),sigEle));else{var brCandidate=sigEle.previousSibling;if(brCandidate&&"BR"===brCandidate.tagName){var dashCandidate=brCandidate.previousSibling;if(dashCandidate&&g.isTextNode(dashCandidate)&&"--"===dashCandidate.textContent){var preBROne=dashCandidate.previousSibling;if(preBROne){var preBRTwo=preBROne.previousSibling;"BR"===preBROne.tagName&&(preBROne.parentElement.removeChild(preBROne),preBRTwo&&"BR"===preBRTwo.tagName&&preBRTwo.parentElement.removeChild(preBRTwo))}brCandidate.parentElement.removeChild(brCandidate),dashCandidate.parentElement.removeChild(dashCandidate)}}}output=doc.body.outerHTML}else output=decoded;return output},_ensurePartDoc:function _ensurePartDocFn(part){var doc;switch(part.mimeType){case"text/plain":doc=this._createDoc(this._parsePlain(part.decoded).parsed);break;case"text/html":doc=this._createDoc(part.decoded);break;default:try{g.PAssert(3872,!1,"Unknown display part mimeType: "+part.mimeType)}catch(PERR){g.reportError(PERR)}}return doc},_mergeDocs:function _mergeDocsFn(src,dst){var adoptedNode=dst.adoptNode(src.body),mergeNode=dst.createElement("div");try{for(var i=0;i<adoptedNode.attributes.length;++i){var attr=adoptedNode.attributes[i];mergeNode.setAttribute(attr.name,attr.value)}}catch(err){g.reportError(err)}try{for(;adoptedNode.childNodes.length>0;)mergeNode.appendChild(adoptedNode.firstChild)}catch(err){g.reportError(err)}try{dst.body.appendChild(mergeNode)}catch(err){g.reportError(err)}},combineParts:function combinePartsFn(partList){try{g.PAssert(3873,g.isArray(partList)&&partList.length>0,"Must always supply a valid part list with contents")}catch(PERR){g.reportError(PERR)}var combinedDoc=this._createDoc("<body></body>");try{g.PAssert(3874,combinedDoc,"Must always be able to create a valid document for first part in list")}catch(PERR){g.reportError(PERR)}if(combinedDoc)for(var i=0;i<partList.length;++i){var entryDoc=this._ensurePartDoc(partList[i]);if(entryDoc)try{this._mergeDocs(entryDoc,combinedDoc)}catch(err){g.reportError(err)}}return combinedDoc?combinedDoc.body.outerHTML:" "},removeElementById:function removeElementByIdFn(decoded,id){try{g.PAssert(3875,g.isString(decoded),"Must pass in a valid decoded HTML email string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3876,g.isString(id),"Must provide a valid item ID")}catch(PERR){g.reportError(PERR)}var didRemove=!1;try{var doc=this._createDoc(decoded);doc&&(didRemove=this._removeElementById(doc,id))}catch(err){g.reportError(err)}return didRemove?doc.body.outerHTML:decoded},_removeElementById:function _removeElementByIdFn(doc,id){var didRemove=!1,target=doc.getElementById(id);return target&&(target.parentNode.removeChild(target),didRemove=!0),didRemove},removeElementsByAttribute:function removeElementsByAttributeFn(decoded,attr){try{g.PAssert(3877,g.isString(decoded),"Must pass in a valid decoded HTML email string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3878,g.isString(attr),"Must provide a valid item ID")}catch(PERR){g.reportError(PERR)}var didRemove=!1;try{var doc=this._createDoc(decoded);if(doc)for(var eles=doc.querySelectorAll("["+attr+"]"),i=0;i<eles.length;++i){var target=eles[i];target.parentNode.removeChild(target),didRemove=!0}}catch(err){g.reportError(err)}return didRemove?doc.body.outerHTML:decoded},_createFragment:function _createFragmentFn(){return{lines:[],isQuote:!1}},_createPlainFragments:function _createPlainFragmentsFn(decoded){var fragments=[],lines=decoded.split("\n"),currentFragment=this._createFragment();fragments.push(currentFragment);for(var i=0;i<lines.length;++i){var line=lines[i].trim(),isQuote=new RegExp(/^>+/).test(line);currentFragment.lines.length>0&&isQuote!==currentFragment.isQuote&&""!==line&&(currentFragment=this._createFragment(),fragments.push(currentFragment)),currentFragment.lines.push(line),currentFragment.isQuote=currentFragment.isQuote||isQuote}return fragments},_getFragmentText:function _getFragmentTextFn(frag){var text="",pre,post;if(frag.isQuote){var quoteID=this._generatePlaceholderID();pre='<div id="'+quoteID+'" place="true"></div><p quote="collapsed" group="'+quoteID+'">',post="</p>"}else pre="",post="";for(var i=0;i<frag.lines.length;++i)text+=frag.lines[i]+"\n";return pre+text+post},_joinPlainFragments:function _joinPlainFragmentsFn(fragments){for(var joinedText="",i=0;i<fragments.length;++i){var frag=fragments[i];joinedText+=this._getFragmentText(frag)}return joinedText},_parsePlain:function _parsePlainFn(decoded,resources,options){var pre='<html><head></head><body style="white-space: pre-wrap;">',post="</body><html>",plainText=this._escapeHTMLEntities(decoded),fragments=this._createPlainFragments(plainText),parsedText;try{parsedText=this._joinPlainFragments(fragments);var linkRegexp=/\b((?:(https?):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gm;parsedText=parsedText.replace(linkRegexp,'<a mlink="true" href="$1">$1</a>')}catch(err){g.reportError(err),parsedText="There was an error loading this message."}return{parsed:pre+parsedText+post}},_parseHTML:function _parseHTMLFn(decoded,resources,options){var outData={parsed:void 0},doc=this._createDoc(decoded),quotes=this._findQuoteElements(doc);quotes=this._cleanupDocQuotes(doc,quotes,resources);var isFullQuote=this._isFullQuote(doc,quotes);if(isFullQuote||this._collapseAndMarkQuotes(doc,quotes,!!options.collapseQuotes),options.createLinksFromText)try{this._createLinksFromText(doc)}catch(err){g.reportError(err)}var links=this._findLinkElements(doc);this._markLinks(links);try{outData.specialLinks=this._findSpecialLinks(links)}catch(err){g.reportError(err)}try{outData.parsedMetadata=this._parseMetadata(doc)}catch(err){g.reportError(err)}try{var imageData=this._updateResourceImages(doc,resources);outData.missingResourceData=imageData.missingResourceData}catch(err){g.reportError(err)}return this._trimTrailingWhitespace(doc),this._trimQuoteWhitespace(quotes),outData.parsed=doc.body.outerHTML,outData},_traverseNode:function _traverseNodeFn(node,visitFn){visitFn(node);for(var i=node.childNodes.length-1;i>=0;i--)this._traverseNode(node.childNodes[i],visitFn)},_sanitizeInputDoc:function _sanitizeInputDocFn(doc,type){var scheme=sanitizeSchemes[type],visitFn=function(node){if(node.nodeType===Node.COMMENT_NODE){try{g.PAssert(3879,0===node.childNodes.length,"A comment node should never have children")}catch(PERR){g.reportError(PERR)}node.parentNode.removeChild(node)}else if(node.nodeType===Node.TEXT_NODE);else if(scheme.bannedTags.indexOf(node.tagName.toLowerCase())>=0)node.parentNode.removeChild(node);else if(node.attributes.length>0){for(var allowedAttrs=scheme.allowedTagAttributes[node.tagName],i=node.attributes.length-1;i>=0;i--){var attrName=node.attributes[i].name;if(scheme.allowedAttributes.indexOf(attrName)<0&&(!allowedAttrs||allowedAttrs.indexOf(attrName)<0))node.removeAttribute(attrName);else{var value=node.getAttribute(attrName);value&&value.startsWith("javascript:")&&(console.log("Remove Inline JS: ",node.tagName,attrName),node.removeAttribute(attrName))}}var height=node.getAttribute("height");height&&height.indexOf("%")>=0&&(node.removeAttribute("height"),console.log("Remove Height: ",node.tagName,height))}};doc.body&&this._traverseNode(doc.body,visitFn)},sanitizeContent:function sanitizeContentFn(decoded){var sanitized;if(decoded){var doc=this._createDoc(decoded),visitFn=function(node){node.nodeType===Node.TEXT_NODE?node.textContent=new Array(node.textContent.length+1).join("#"):"A"===node.nodeName&&node.removeAttribute("href")};try{this._traverseNode(doc.body,visitFn),sanitized=doc.body.outerHTML}catch(err){g.reportError(err),sanitized="<<SANITIZED>>"}}return sanitized},getComposeBody:function getComposeBodyFn(decoded,resources){var body,didUpdate=!1;try{var doc=this._createDoc(decoded);if(doc){didUpdate=this._removeElementById(doc,"moodoAttach");var resourceData=this._updateResourceImages(doc,resources);didUpdate=didUpdate||resourceData.didUpdate}}catch(err){g.reportError(err)}return didUpdate?doc.body.outerHTML:decoded},_createDoc:function _createDocFn(decoded){var doc,domParser=new DOMParser;try{doc=domParser.parseFromString(decoded,"text/html"),doc&&this._sanitizeInputDoc(doc,"Default")}catch(err){g.reportError(err);try{doc=domParser.parseFromString("Error parsing email message","text/html")}catch(err2){g.reportError(err2)}}return doc},_updateResourceImages:function _updateResourceImagesFn(doc,resources){for(var resourceData={missingData:!1,didUpdate:!1},images=this._findImageElements(doc),i=0;i<images.length;++i){var image=images[i];if(image.src.startsWith("cid:")){var cid=image.src.substr(4);if(cid){image.setAttribute("cid",cid);var resource=resources?resources[cid]:void 0;if(resource&&resource.data){var dataURI="data:"+resource.mimeType+";base64,"+resource.data;image.src=dataURI,resourceData.didUpdate=!0}else image.src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=",resourceData.didUpdate=!0,resource||(resourceData.missingData=!0)}else image.src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=",resourceData.didUpdate=!0}}return resourceData},_findImageElements:function _findImageElementsFn(doc){return doc.querySelectorAll("img")},_findLinkElements:function _findLinkElementsFn(doc){return Array.prototype.slice.call(doc.querySelectorAll("a"))},_sanitizeLink:function _sanitizeLinkFn(link){if(link&&link.hasAttribute("href")){link.setAttribute("mlink",!0);var href=link.getAttribute("href");if(href.startsWith("file:"))link.setAttribute("href","");else{var protocol=protocolRegexp.exec(href);protocol||link.setAttribute("href","https://"+href)}}},_createLinksFromText:function _createLinksFromTextFn(doc){var visitFn=function(node){if(node.nodeType===Node.TEXT_NODE){var content=node.textContent;if(content.indexOf("http")>=0||content.indexOf("www.")>=0){var linkRegexp=/\b((?:(https?):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gm;if(linkRegexp){var replacedText=node.textContent.replace(linkRegexp,'<a href="$1">$1</a>'),tempNode=doc.createElement("div");tempNode.innerHTML=replacedText;var numChildren=tempNode.childNodes.length;if(numChildren>1||1===numChildren&&"A"===tempNode.childNodes[0].tagName){for(;tempNode.firstChild;)node.parentNode.insertBefore(tempNode.firstChild,node);node.parentNode.removeChild(node)}}}}}.bind(this);this._traverseNode(doc.body,visitFn)},_markLinks:function _markLinksFn(links){for(var i=0;i<links.length;++i)this._sanitizeLink(links[i])},_isAttachmentURL:function _isAttachmentURLFn(href){return!!/^https:\/\/drive.google.com\/file\/d\/.*\/view/g.exec(href)},_findSpecialLinks:function _findSpecialLinksFn(links){for(var specialLinks={unsubscribe:[],twitter:[],attachments:[]},i=0;i<links.length;++i){var link=links[i];link.href&&this._isAttachmentURL(link.href)&&specialLinks.attachments.push({href:link.href,name:link.innerText,type:"application/octet-stream"})}return specialLinks},_parseMetadata:function _parseMetadataFn(doc){var metadata=this._parseMicrodata(doc);return metadata},_parseMicrodata:function _parseMicrodataFn(doc){var scopes=doc.querySelectorAll("[itemscope]"),items=Array.prototype.map.call(scopes,function(ele){return ele.hasAttribute("itemprop")?void 0:this._parseMicrodataScope(ele)}.bind(this)).filter(function(item){return!!item});return items},_parseMicrodataScope:function _parseMicrodataScopeFn(ele){for(var item={type:ele.getAttribute("itemtype"),properties:{}},i=0;i<ele.children.length;++i){var child=ele.children[i];if(child.hasAttribute("itemprop")){var propKey=child.getAttribute("itemprop"),propValue;if(child.hasAttribute("itemscope"))propValue=this._parseMicrodataScope(child);else switch(child.tagName.toLowerCase()){case"a":case"area":propValue=child.getAttribute("href");break;case"meta":propValue=child.getAttribute("content");break;case"img":propValue=child.getAttribute("src");break;case"data":case"meter":propValue=child.getAttribute("value");break;case"time":propValue=child.getAttribute("datetime");break;default:propValue=child.hasAttribute("content")?child.getAttribute("content"):child.textContent}propKey&&propValue&&(item.properties[propKey]=propValue)}}return item},_cleanupDocQuotes:function _cleanupDocQuotesFn(doc,quotes,resources){return quotes.filter(function(ele){var quoteRemoved=!1;if("BLOCKQUOTE"===ele.nodeName&&"cite"===ele.getAttribute("type")){var resourceID=parseResourceID(ele.innerText);resourceID&&ele&&ele.parentNode&&(ele.parentNode.removeChild(ele),quoteRemoved=!0)}return!quoteRemoved})},_generatePlaceholderID:function _generatePlaceholderIDFn(){return g.generateTempId()},_createQuotePlaceholder:function _createQuotePlaceholderFn(doc){var div=doc.createElement("div");return div.id=this._generatePlaceholderID(),div.setAttribute("place",!0),div},_findFirstSiblingQuote:function _findFirstSiblingQuoteFn(quote,quotes){for(var firstQuote=quote;firstQuote.previousElementSibling&&quotes.indexOf(firstQuote.previousElementSibling)>=0;)firstQuote=firstQuote.previousElementSibling;return firstQuote},_markAdjacentQuotes:function _markAdjacentQuotesFn(quote,id,quotes,state){for(;quote&&quotes.indexOf(quote)>=0;)quote.setAttribute("quote",state),quote.setAttribute("group",id),quote=quote.nextElementSibling},_collapseAndMarkQuotes:function _collapseAndMarkQuotesFn(doc,quotes,doCollapse){for(var i=0;i<quotes.length;++i){var quote=quotes[i];if(!quote.getAttribute("quote")){var firstQuote=this._findFirstSiblingQuote(quote,quotes),placeholder=this._createQuotePlaceholder(doc),quoteState=0===i&&doCollapse?"collapsed":"uncollapsed";this._markAdjacentQuotes(firstQuote,placeholder.id,quotes,quoteState),firstQuote.parentNode.insertBefore(placeholder,quote)}}},_removeQuote:function _removeQuoteFn(quote){quote&&quote.parentNode&&quote.parentNode.removeChild(quote)},_removeQuotes:function _removeQuotesFn(doc,quotes){for(var i=0;i<quotes.length;++i)this._removeQuote(quotes[i])},_isFullQuote:function _isFullQuoteFn(doc,quotes){for(var isFullQuote=!0,i=0;i<doc.body.childNodes.length;++i){var childNode=doc.body.childNodes[i];if(""!==childNode.textContent.trim()&&quotes.indexOf(childNode)<0&&quotes.indexOf(childNode.firstElementChild)<0){isFullQuote=!1;break}}return isFullQuote},_findQuoteElements:function _findQuoteElementsFn(doc){var gmailQuotes=this._findGmailQuotes(doc),officeQuotes=this._findOffice365Quotes(doc),blockQuotes=this._findBlockquoteQuotes(doc),quotes=[];return quotes.pushOnlyUniques(gmailQuotes),quotes.pushOnlyUniques(officeQuotes),quotes.pushOnlyUniques(blockQuotes),quotes=this._cleanupGmail(quotes),quotes=this._removeEmptyQuotes(quotes)},_cleanupGmail:function _cleanupGmailFn(quotes){return quotes.filter(function(value){var hideQuote=!1;if("BLOCKQUOTE"===value.nodeName&&g.hasClass(value,"gmail_quote"))for(var i=0;i<quotes.length;++i)for(var ele=value.parentNode;ele;){if(g.hasClass(ele,"gmail_quote")){"DIV"===ele.nodeName&&(hideQuote=!0);break}ele=ele.parentNode}return!hideQuote})},_removeEmptyQuotes:function _removeEmptyQuotesFn(quotes){return quotes},_findGmailQuotes:function _findGmailQuotesFn(doc){return Array.prototype.slice.call(doc.querySelectorAll(".gmail_quote"))},_findOffice365Quotes:function _findOffice365QuotesFn(doc){var eles=Array.prototype.slice.call(doc.querySelectorAll("#divRplyFwdMsg, #OLK_SRC_BODY_SECTION")),rply3D=doc.getElementById('3D"divRplyFwdMsg"');return rply3D&&eles.push(rply3D),eles=eles.map(function(ele){return ele.previousElementSibling&&"HR"===ele.previousElementSibling.nodeName?ele.parentElement:ele})},_findBlockquoteQuotes:function _findBlockquoteQuotesFn(doc){return Array.prototype.slice.call(doc.querySelectorAll("blockquote"))},_findGmailSignatures:function _findGmailSignaturesFn(doc){return Array.prototype.slice.call(doc.querySelectorAll(".gmail_signature"))},_findActiveSignature:function _findActiveSignatureFn(doc){for(var candidates=this._findGmailSignatures(doc),quotes=this._findQuoteElements(doc),sigEle,i=candidates.length-1;i>=0&&!sigEle;i--){for(var sig=candidates[i],validSig=!0,j=0;j<quotes.length;++j)if(g.isAncestor(sig,quotes[j])){validSig=!1;break}validSig&&(sigEle=sig)}return sigEle},_trimTrailingWhitespace:function _trimTrailingWhitespaceFn(doc){for(var nodes=doc.body.childNodes,trimNodes=[],i=nodes.length-1;i>=0;i--){var currentNode=nodes[i],prevNode=nodes[i-1];if(!currentNode||"BR"!==currentNode.nodeName||!prevNode||"BR"!==prevNode.nodeName)break;trimNodes.push(currentNode)}this._removeElements(trimNodes)},_trimQuoteWhitespace:function _trimQuoteWhitespaceFn(quotes){for(var trimNodes=[],i=0;i<quotes.length;++i)for(var ele=quotes[i].previousElementSibling;ele;)"BR"===ele.nodeName&&ele.previousElementSibling&&"BR"===ele.previousElementSibling.nodeName&&trimNodes.push(ele),ele=ele.previousElementSibling;this._removeElements(trimNodes)},_removeElements:function _removeElementsFn(elements){for(var i=0;i<elements.length;++i){var ele=elements[i];
try{ele.parentNode&&ele.parentNode.removeChild(ele)}catch(err){}}}},new EmailHTML}),define("parse",["globals","VMLI","tracker","data"],function(g,VMLI,tracker,d){function parse(){}return parse.prototype={_setSectionValue:function _setSectionValueFn(section,key,value){section.hasOwnProperty(key)||(section[key]=value)},_parseSection:function _parseSectionFn(lines,index){for(var section={},i=index;i<lines.length;++i){var line=lines[i];if(line){var splitIndex=line.indexOf(":"),lineData=[line.substr(0,splitIndex),line.substr(splitIndex+1)],lineKey=lineData[0].split(";");switch(lineKey[0]){case"BEGIN":var sectionData=this._parseSection(lines,i+1);i+=sectionData.size,section[lineData[1]]=sectionData.section;break;case"END":return{section:section,size:i-index+1};default:if(lineKey.length>1){for(var entry={value:lineData[1]},j=1;j<lineKey.length;++j){var dt=lineKey[j].split("=");try{g.PAssert(3883,!entry.hasOwnProperty(dt[0]),"Should never overwrite line values")}catch(PERR){g.reportError(PERR)}entry[dt[0]]=dt[1]}this._setSectionValue(section,lineKey[0],entry)}else this._setSectionValue(section,lineKey[0],lineData[1]);break;case void 0:case null:try{g.PAssert(3884,!1,"Invalid ICS format: "+line)}catch(PERR){g.reportError(PERR)}}}}return section},parseICS:function parseICSFn(data){for(var rawLines=data.split("\n"),lines=[],i=0;i<rawLines.length;++i){var line=rawLines[i];line.startsWith(" ")?lines[lines.length-1]+=line.trim():lines.push(line.trim())}var parsedData=this._parseSection(lines,0);return parsedData},parseHead:function parseHeadFn(node){for(var props={},i=0;i<node.childElementCount;++i){var prop=node.children[i],propName=prop.nodeName;if(prop.firstChild){var propValue=prop.firstChild.textContent;props[propName]=propValue}}return props},parseOPML:function parseOPMLFn(data,filename){var rootModel,visit=function(node,parentModel){var visitChildren=!0,nodeModel;switch(node.nodeName){case"#document":case"body":case"opml":break;case"head":visitChildren=!1;var ret=this.parseHead(node);ret&&ret.title&&!rootModel&&(rootModel=d.createVMLI({text:ret.title},{parent:d.getRootModel(),changeType:ChangeType.AllLocal}),d.getRootModel().insertItem(rootModel));break;case"outline":parentModel||(rootModel?parentModel=rootModel:(parentModel=rootModel=d.createVMLI({text:filename},{parent:d.getRootModel(),changeType:ChangeType.AllLocal}),d.getRootModel().insertItem(rootModel)));var itemTextAttr=node.attributes.text,itemText=itemTextAttr?itemTextAttr.value:"",completeAttr=node.attributes._complete,isComplete=completeAttr&&"true"===completeAttr.value?!0:!1,nodeData={text:itemText.replace(/<\/?[biu]>/g,"").replace(/[\r\n\t]/g," "),isComplete:isComplete};nodeModel=d.createVMLI(nodeData,{parent:parentModel,changeType:ChangeType.AllLocal}),parentModel.insertItem(nodeModel);break;default:log("Unknown OPML Node: ",node)}if(visitChildren)for(var i=0;i<node.childElementCount;++i)visit(node.children[i],nodeModel);return nodeModel}.bind(this);return tracker.beginAction(),visit(data),tracker.endAction(),!0},parseJSON:function parseJSONFn(data,root){function visit(node,parentModel){var nodeParent=parentModel||root||d.getRootModel(),nodeData={text:node.text,dateCompleted:node.dateCompleted,priority:node.priority,isComplete:node.isComplete,isStarred:node.isStarred},nodeModel=d.createVMLI(nodeData,{parent:nodeParent,changeType:ChangeType.AllLocal});if(nodeParent.insertItem(nodeModel),node.note){var noteData={text:node.note.text,isNote:!0},noteModel=d.createVMLI(noteData,{parent:nodeModel,changeType:ChangeType.AllLocal});nodeModel.setNote(noteModel,ChangeType.AllLocal)}if(node.items)for(var i=0;i<node.items.length;++i)visit(node.items[i],nodeModel)}var dataVersion;if(void 0!==data.moodoVer&&void 0!==data.moodoRoot)try{dataVersion=parseInt(data.moodoVer),tracker.beginAction();var docRoot=data.moodoRoot;if(docRoot.items)for(var i=0;i<docRoot.items.length;++i)visit(docRoot.items[i]);return tracker.endAction(),!0}catch(err){g.reportError(err)}else if(void 0!==data.text&&void 0!==data.items)try{return tracker.beginAction(),visit(data),tracker.endAction(),!0}catch(err){}return!1},stripParents:function stripParentsFn(item){if(item.parent=void 0,item.items)for(var i=0;i<item.items.length;i++)this.stripParents(item.items[i])},parseClassName:function parseClassNameFn(className,v){return className?(className.indexOf("high")>=0?v.priority=VMLIFlag.P0:className.indexOf("medium")>=0?v.priority=VMLIFlag.P1:className.indexOf("low")>=0&&(v.priority=VMLIFlag.P2),className.indexOf("complete")>=0&&(v.isComplete=!0),className.indexOf("starred")>=0&&(v.isStarred=!0),v):void 0},traverseDOM:function traverseDOMFn(options){function visit(node){if(node.nodeType===Node.TEXT_NODE){(reallyNeedsNewItem||needsNewItem)&&(currentLine.text=currentLine.text.replace(/^ +/g,"").replace(/ +$/g,""),""!==currentLine.text&&(newItem={text:"",parent:currentLine.parent},_this.parseClassName(newItemClass,newItem),currentLine.parent.items.push(newItem),currentLine=newItem)),reallyNeedsNewItem=!1,needsNewItem=!1;var addText=node.nodeValue.replace(/[\ud800-\udfff]+/g,"");""===currentLine.text&&(addText=addText.replace(/^[ \r\n\t]+/g,"")),_this.parseClassName(newItemClass,currentLine),currentLine.text+=addText}else node.nodeType===Node.COMMENT_NODE||("BR"===node.tagName||"P"===node.tagName||"LI"===node.tagName||"DIV"===node.tagName?(needsNewItem=!0,newItemClass=node.className):("UL"===node.tagName||"OL"===node.tagName)&&(currentLine.text=currentLine.text.replace(/^ +/g,"").replace(/ +$/g,""),newItem={text:"",parent:currentLine},_this.parseClassName(newItemClass,newItem),currentLine.items?currentLine.items.push(newItem):currentLine.items=[newItem],currentLine=newItem,needsNewItem=!1,newItemClass=""))}function end(node){node.nodeType!==Node.TEXT_NODE&&("UL"===node.tagName||"OL"===node.tagName?(currentLine=currentLine.parent,reallyNeedsNewItem=!0):("DIV"===node.tagName||"P"===node.tagName)&&(needsNewItem=!0,newItemClass=""))}function print(r,levelsDeep){isNaN(levelsDeep)&&(levelsDeep=0);for(var text="",i=0;levelsDeep>i;i++)text+="--";if(levelsDeep&&console.log(text,r.text),r.items)for(var i=0;i<r.items.length;i++)print(r.items[i],levelsDeep+1)}var root=options.root,doStripParents=options.stripParents,shouldPrint=options.shouldPrint,n=root.firstChild,rootNode={items:[]},currentLine={text:"",parent:rootNode};rootNode.items.push(currentLine);var newItem,needsNewItem=!1,reallyNeedsNewItem=!1,newItemClass,_this=this,c;do if(visit(n),c=n.firstChild)n=c;else if(c=n.nextSibling)n=c;else{do c=n.parentNode.nextSibling,c?(end(n.parentNode),n=c):(n=n.parentNode,end(n));while(!c&&n&&n.parentNode);if(!c)break}while(n);return doStripParents&&this.stripParents(rootNode),shouldPrint&&print(rootNode),rootNode}},new parse}),define("EmailPreview",["require","globals","Constants","util","platform","Observable","ObservableArray","Dispatcher","EmailHTML","tracker","parse"],function(require){function EmailPreview(){this.openOnPane=void 0,this.messages=new ObservableArray,this.messagesLoaded=new Observable(!1),this.isLoading=new Observable(!1),this.errorMessage=new Observable(""),this.threadAttach=void 0,this.threadAttachLoading=void 0,this.numLoaded=0,this._cachedCSS=void 0,util.forceBind("onAttachmentUpdate",this),util.forceBind("reset",this),this.init()}function InjectedJSWrapper(frameID,isApp){!function(){function reportError(err){console.log("ERROR: ",err)}function hookEventHandlers(){document.documentElement.addEventListener("click",function(e){InjectedJS.postMessage("click")}),document.addEventListener("keydown",function(e){var keyData={type:e.type,keyCode:e.keyCode,charCode:e.charCode,which:e.which,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,metaKey:e.metaKey,altKey:e.altKey};InjectedJS.postMessage("keypress",keyData)},!0);for(var links=document.querySelectorAll("[mlink]"),i=0;i<links.length;++i)links[i].addEventListener("click",function(e){e.stopImmediatePropagation(),e.preventDefault();var href=this.getAttribute("href");return href.startsWith("attach:")?InjectedJS.postMessage("reqResource",[href]):isApp?InjectedJS.postMessage("href",href):window.parent.open(href,"_blank"),!1});for(var quotes=document.querySelectorAll("[place]"),i=0;i<quotes.length;++i)quotes[i].addEventListener("click",function(e){for(var groupID=this.id,quote=this.nextElementSibling,canBeShorter=!1;quote&&quote.getAttribute("group")===groupID;){var prevValue=quote.getAttribute("quote"),newValue="collapsed"===prevValue?"uncollapsed":"collapsed";"collapsed"===newValue&&(canBeShorter=!0),quote.setAttribute("quote",newValue),quote=quote.nextElementSibling}return setTimeout(function(){InjectedJS.postMessage("resize",canBeShorter)},0),e.stopImmediatePropagation(),e.preventDefault(),!1});for(var attachLoad=[],images=document.querySelectorAll("img"),i=0;i<images.length;++i){var cid=images[i].getAttribute("cid");cid&&attachLoad.push(cid),images[i].addEventListener("load",function(){InjectedJS.postMessage("resize")})}attachLoad.length>0&&InjectedJS.postMessage("reqResource",attachLoad)}function loadDone(){document.removeEventListener("DOMContentLoaded",loadDone,!1),hasLoaded?InjectedJS.postMessage("resize"):(hasLoaded=!0,hookEventHandlers(),InjectedJS.postMessage("epLoaded"))}window.InjectedJS={postMessage:function postMessageFn(action,data){try{var dataStr;if(void 0!==data)if("string"==typeof data)dataStr="-"+data;else try{dataStr="-"+JSON.stringify(data)}catch(err){reportError(err),dataStr=""}else dataStr="";window.parent.postMessage("-"+action+"-"+frameID+dataStr,"*")}catch(err){reportError(err)}}},window.addEventListener("message",function(e){if(e.data&&e.data.startsWith&&e.data.startsWith("-")){var actionIndex=e.data.indexOf("-",1),action=e.data.substring(1,actionIndex),data=e.data.substring(actionIndex+1);switch(action){case"resLoad":try{if(data)for(var res=JSON.parse(data),dom=document.querySelectorAll('[cid="'+res.cid+'"]'),dataURI="data:"+res.mimeType+";base64,"+res.data,i=0;i<dom.length;++i)dom[i].src=dataURI}catch(err){reportError(err)}break;case"contentLoad":try{if(data){var res=JSON.parse(data);document.open(),document.write(res.data),document.close(),setTimeout(function(){InjectedJS.postMessage("resize")})}}catch(err){reportError(err)}break;default:reportError(new Error("Unknown PreviewFrame message: "+action))}}});var hasLoaded=!1;"complete"===document.readyState||"interactive"===document.readyState?setTimeout(loadDone):(document.addEventListener("DOMContentLoaded",loadDone,!1),window.addEventListener("load",loadDone,!1))}()}var g=require("globals"),C=require("Constants"),util=require("util"),platform=require("platform"),Observable=require("Observable"),ObservableArray=require("ObservableArray"),Dispatcher=require("Dispatcher"),EmailHTML=require("EmailHTML"),tracker=require("tracker");return EmailPreview.prototype={init:function initFn(){window.addEventListener("message",function(e){if(g.getLocationOrigin()===e.origin&&e.data&&e.data.startsWith&&e.data.startsWith("-")){var actionIndex=e.data.indexOf("-",1),frameIndex=e.data.indexOf("-",actionIndex+1);0>frameIndex&&(frameIndex=void 0);var action=e.data.substring(1,actionIndex),frameID=e.data.substring(actionIndex+1,frameIndex),data=frameIndex?e.data.substring(frameIndex+1):void 0;this.handleFrameMessage(frameID,action,data,e)}}.bind(this)),Dispatcher.listen("selectedIndexChanged",this.onSelectedIndexChanged.bind(this)),platform.onResize.listen(this._onWindowResize.bind(this))},reset:function resetFn(notify,isLoading){if(this.threadAttach){for(var oldMessages=this.threadAttach.getField("messages"),i=0;i<oldMessages.length;++i){var oldMsg=oldMessages[i];oldMsg.initializedForDisplay&&this._destroyMessageDisplay(oldMessages[i])}this.threadAttach.unsubscribe(this)}this.numLoaded=0,this.threadAttach=void 0,this.emailElement=void 0,this.errorMessage.set("",!1),this.isLoading.set(isLoading,!1),this.messagesLoaded.set(!1,!1),this.messages.get().length>0&&this.messages.set([],notify)},_onWindowResize:function _onWindowResizeFn(){if(this.threadAttach)for(var messages=this.threadAttach.getField("messages"),i=0;i<messages.length;++i)this.updateMessageHeight(messages[i].id,!0)},getPlugin:function getPluginFn(){var plugin;return plugin=this.threadAttach?this.threadAttach.getPlugin():g.vmMain.getDefaultEmailPlugin()},_sendReply:function _sendReplyFn(target,action,data){try{var dataStr=void 0!==data?"-"+data:"";target.postMessage("-"+action+dataStr,"*")}catch(err){g.reportError(err)}},handleFrameMessage:function handleFrameMessageFn(frameID,action,data,e){switch(action){case"resize":this.updateMessageHeight(frameID,"true"===data);break;case"click":g.fireCustomEvent("tapMain");break;case"keypress":try{var keyData=JSON.parse(data);platform.normalizeKeys(keyData),g.fireKeyEvent(document.documentElement,keyData)}catch(err){g.reportError(err)}break;case"href":if(data.startsWith("mailto:")){var mailToData=this.parseMailtoURL(data.replace(/^mailto:/gi,"")),initData={to:[{email:mailToData.to}],subject:mailToData.subject&&unescape(mailToData.subject)};g.menus.openComposeEmail(this.getPlugin(),void 0,void 0,initData)}else g.openUrl(data);break;case"epLoaded":this.onMessageLoaded(frameID);break;case"reqResource":try{try{g.PAssert(3885,e,"Must provide a valid request event")}catch(PERR){g.reportError(PERR)}if(this.threadAttach)for(var resourceReqs=JSON.parse(data),i=0;i<resourceReqs.length;++i){var resourceID=resourceReqs[i],isContentResource=!1;resourceID.startsWith("attach:")&&(resourceID=resourceID.replace(/^attach:/gi,""),isContentResource=!0),this.getPlugin().loadResource(this.threadAttach.id,frameID,resourceID,function(res){var replyData;if(res){var data;data=isContentResource?this._createMessageHTML(this.getPlugin()._decodeEmail(res.data,void 0,{}),{},"text/html").parsed:res.data,replyData={cid:res.cid,data:data,mimeType:res.mimeType}}try{if(e.source){var replyType=isContentResource?"contentLoad":"resLoad";this._sendReply(e.source,replyType,replyData?JSON.stringify(replyData):void 0)}}catch(replyErr){g.reportError(replyErr)}}.bind(this))}}catch(err){g.reportError(err)}break;default:log("Unknown message from child frame: ",frameID,action,data,e)}},isOpen:function isOpenFn(){return this.openOnPane&&this.openOnPane.isExpanded.get()},isOpenOnPane:function isOpenOnPaneFn(pane){return this.openOnPane===pane&&this.openOnPane.isExpanded.get()},close:function closeFn(){this.isOpen()&&(this.wantsPaneTransition=!0,this.setOpenPane(null),platform.mobile?setTimeout(this.reset,C.EmailOpenTimeMobile):this.reset(),this.wantsPaneTransition=!1,Dispatcher.fireEvent("EmailPreview","onClosed",[]))},_handleStartDrag:function _handleStartDragFn(items){this.isOpen()&&this.close()},setOpenPane:function setOpenPaneFn(pane){this.openOnPane&&this.openOnPane!==pane&&this.openOnPane.setExpanded(!1),this.openOnPane=pane,pane&&pane.setExpanded(!0)},_openPane:function _openPaneFn(pane,cb){try{g.PAssert(3886,cb,"Must supply a valid cb to openPane")}catch(PERR){g.reportError(PERR)}pane!==this.openOnPane?(this.wantsPaneTransition=!0,setTimeout(function(){this.wantsPaneTransition=!1,cb()}.bind(this),C.EmailOpenTime+100)):cb(),this.setOpenPane(pane)},getPane:function getPaneFn(){try{g.PAssert(3887,this.openOnPane,"Should not be trying to get pane if email preview is not open")}catch(PERR){g.reportError(PERR)}return this.openOnPane},startOpenOnLoad:function startOpenOnLoadFn(pane){this.setOpenPane(pane)},open:function openFn(attach,pane){if(attach!==this.threadAttach||pane!==this.openOnPane){var plugin=attach.getPlugin();this.reset(!0,!0),this.threadAttachLoading=attach,platform.mobile&&g.closeKeyboard();var callbacks=2,loadSuccess=!1,onDone=function(){callbacks--,0===callbacks&&attach===this.threadAttachLoading&&(loadSuccess?(this._setThread(attach),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenEmail,data:{pane:pane}})):this.errorMessage.get()?this.isLoading.set(!1):g.menus.alert({text:"Unable to load email messages. You may be offline.",actionText:"OKAY"}))}.bind(this);this._openPane(pane,function(){onDone()}),plugin.loadThread(attach,function(success,loadedData,errorMessage){loadSuccess=success,this.errorMessage.set(!success&&errorMessage?errorMessage:""),onDone()}.bind(this))}},_getReplyToFromMessage:function _getReplyToFromMessageFn(msg){var replyTo;return replyTo=this.getPlugin().hasSyncAccount(msg.from.email)?msg.to:msg.replyTo?[msg.replyTo]:[msg.from]},_getSenderFromMessage:function _getSenderFromMessageFn(msg){var sender,plugin=this.getPlugin();return sender=plugin.getDefaultFromInfo(this.threadAttach.getField("accountID"))},_updateDraftFromMessage:function _updateDraftFromMessageFn(inReplyToMessage,draft,mode){var to,cc,body,res,plugin=this.getPlugin(),subject=inReplyToMessage.subject,sender=this._getSenderFromMessage(inReplyToMessage);if(mode===C.EmailResponseMode.Reply)to=this._getReplyToFromMessage(inReplyToMessage),body=plugin.createReplyQuote(inReplyToMessage)+plugin.createSignature(draft.from.email);else if(mode===C.EmailResponseMode.ReplyAll){to=this._getReplyToFromMessage(inReplyToMessage).concat(inReplyToMessage.to).concat(inReplyToMessage.cc||[]);for(var i=0;i<to.length;i++)plugin.isMyAccountID(to[i].email)&&(to.splice(i,1),i--);cc=inReplyToMessage.cc,body=plugin.createReplyQuote(inReplyToMessage)+plugin.createSignature(draft.from.email)}else mode===C.EmailResponseMode.Forward&&(body=plugin.createForwardQuote(inReplyToMessage)+plugin.createSignature(draft.from.email),res=g.clone(inReplyToMessage.resources));to=to||[],cc=cc||[],mode===C.EmailResponseMode.Reply||mode===C.EmailResponseMode.ReplyAll?(0!==subject.toLowerCase().indexOf("re")&&(subject="Re: "+subject),res=draft.resources):mode===C.EmailResponseMode.Forward&&0!==subject.toLowerCase().indexOf("fwd")&&(subject="Fwd: "+subject);var data={to:to,from:sender,cc:cc,bcc:void 0,subject:subject,body:body,resources:res||{}};this.getPlugin().updateDraft(this.threadAttach,draft.id,draft.draftID,data,body,!0,!1,function(success){try{g.PAssert(3888,success,"Should always be able to update a draft")}catch(PERR){g.reportError(PERR)}})},requestAttachment:function requestAttachmentFn(threadID,msgID,cid,cb){this.getPlugin().loadResource(threadID,msgID,cid,cb)},getAttachmentURL:function getAttachmentURLFn(accountID,threadID,attrID){return this.getPlugin().getAttachmentURL(accountID,threadID,attrID)},getPreviewURL:function getPreviewURLFn(res){return this.getPlugin().getPreviewURL(res)},reportMessage:function reportMessageFn(accountID,threadID,msgID,description,sendContent){this.getPlugin().reportMessage(accountID,threadID,msgID,description,sendContent)},parseMailtoURL:function parseMailtoURLFn(raw){var mailtoData={to:void 0,subject:void 0,body:void 0},parts=raw.split("?");if(mailtoData.to=parts[0],parts[1])for(var headers=parts[1].split("&"),i=0;i<headers.length;++i){var header=headers[i].split("=");switch(header[0].toUpperCase()){case"SUBJECT":mailtoData.subject=header[1];break;case"BODY":mailtoData.body=header[1]}}return mailtoData},parseListUnsubscribe:function parseListUnsubscribeFn(raw){for(var unsubData={emailData:void 0,url:void 0},unsubParts=raw.split(","),i=0;i<unsubParts.length;++i){var unsubRegex=/^<?(http|https|mailto):([^<>]*)>?/gi,unsubMatch=unsubRegex.exec(unsubParts[i]);if(unsubMatch)switch(unsubMatch[1]){case"http":case"https":unsubData.url=unsubMatch[1]+":"+unsubMatch[2];break;case"mailto":unsubData.emailData=this.parseMailtoURL(unsubMatch[2]);break;default:try{g.PAssert(3889,!1,"Unknown List Unsubscribe Format: "+raw)}catch(PERR){g.reportError(PERR)}}}return unsubData},setMessageResponseMode:function setMessageResponseModeFn(messageID,mode){var inReplyToMessage=this.messages.get()[this.messages.indexOfWithProperty("id",messageID)];if(mode!==C.EmailResponseMode.None){try{g.PAssert(3890,inReplyToMessage.initializedForDisplay,"Must be initialized for display to set response mode")}catch(PERR){g.reportError(PERR)}var emailPlugin=this.getPlugin(),draftMsg=emailPlugin.getDraftForMessage(this.threadAttach.getField("accountID"),this.threadAttach.id,messageID,mode);this._updateDraftFromMessage(inReplyToMessage,draftMsg,mode)}inReplyToMessage.responseMode.set(mode),platform.mobile&&mode!==C.EmailResponseMode.None&&g.menus.openModal(Modals.EmailReply,{threadAttach:this.getThreadAttach(),message:draftMsg,inReplyToMessage:inReplyToMessage,responseMode:mode})},setLastMessageResponseMode:function setLastMessageResponseModeFn(mode){if(mode){var message=this.messages.get()[this.messages.length()-1];try{g.PAssert(3891,message,"Setting message response mode when there are no messages")}catch(PERR){g.reportError(PERR)}message&&this.setMessageResponseMode(message.id,mode)}},_createErrorHTML:function _createErrorHTMLFn(){return EmailHTML.update("There was an error loading your mail message.",{},{},"text/plain")},_createMessageHTML:function _createMessageHTMLFn(decoded,resources,mimeType,incOptions){var options={collapseQuotes:!0,replaceLinks:!0,createLinksFromText:!0};if(incOptions)for(var opt in incOptions)incOptions.hasOwnProperty(opt)&&(options[opt]=incOptions[opt]);return EmailHTML.update(decoded,resources,options,mimeType)},_generateCSS:function _generateCSSFn(){if(!this._cachedCSS){var rules={body:{"overflow-x":"auto","overflow-y":"hidden","font-family":"'Helvetica Neue', Helvetica, Arial, Sans-serif","font-size":"14px",margin:0},"#moodoAttach":{display:"none"},'[quote="collapsed"]':{display:"none"},'[place="true"]':{cursor:"pointer",display:"inline-block",height:"12px",width:"26px","text-align":"center","margin-top":"8px","margin-bottom":"8px",color:"#aaa",border:"1px solid #ddd","background-color":"#f6f6f6","border-radius":"3px"},'[place="true"]:before':{content:'"..."',"line-height":"5px","font-size":"16px","vertical-align":"text-top"}},stylesString="";for(var rule in rules){stylesString+=rule+"{";for(var prop in rules[rule]){var value=rules[rule][prop];stylesString+=prop+":"+value+";"}stylesString+="}"}this._cachedCSS="<style>"+stylesString+"</style>"}return this._cachedCSS},_createFrameBlob:function _createFrameBlobFn(displayData,contentType,frameID){var frameCSS=this._generateCSS(),frameScript="<script>("+InjectedJSWrapper.toString()+')("'+frameID+'",'+platform.app+");</script>",docType="<!DOCTYPE html>",contentType='<meta http-equiv="Content-Type" content="'+contentType+'">';return platform.ie||platform.ieEdge?[docType,"<html>","<head>",contentType,frameCSS,frameScript,"</head>",displayData,"</html>"].join(""):new Blob([docType,"<html>","<head>",contentType,frameCSS,frameScript,"</head>",displayData,"</html>"],{type:"text/html"})},onMessageLoaded:function onMessageLoadedFn(frameID){this.updateMessageHeight(frameID),this.messagesLoaded.set(!0)},getPreviewIFrame:function getPreviewIFrameFn(frameID){return document.getElementById("emailPreview_"+frameID)},updateMessageHeight:function updateMessageHeightFn(frameID,needsResize){var target=this.getPreviewIFrame(frameID);if(target){var msg=this.messages.get()[this.messages.indexOfWithProperty("id",frameID)];needsResize&&(target.style.height="0px");try{var body=target.contentDocument.body;if(body){var height=body.scrollHeight;needsResize&&height===msg.height.get()&&(target.style.height=height+"px"),msg.height.set(height)}}catch(err){g.reportError(err)}}},_generateAltParts:function _generateAltPartsFn(attach,msg){var attachments=this.getPlugin().getMessageAttachments(msg);if(attachments)for(var i=0;i<attachments.length;++i){var res=attachments[i];"application/ics"===res.mimeType&&this.getPlugin().loadResource(attach.id,msg.id,res.cid,function(resource){var parsedData=require("parse").parseICS(g.b64_to_utf8(resource.data));log("Parsed ICS Data: ",parsedData)})}},_computeResponseMode:function _computeResponseModeFn(msg){var responseMode=C.EmailResponseMode.None;return msg&&msg.labelIds.indexOf("DRAFT")>=0&&(msg.subject.startsWith("Fwd:")?responseMode=C.EmailResponseMode.Forward:msg.subject.startsWith("Re:")&&(responseMode=1===msg.to.length?C.EmailResponseMode.Reply:C.EmailResponseMode.ReplyAll)),responseMode},_createMessageDisplay:function _createMessageDisplayFn(msg,nextMessage,options){try{g.PAssert(3892,!msg.initializedForDisplay,"Should only initialize message for display once")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3893,msg.to,"Must have a valid to object")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3894,msg.from,"Mus have a valid from object")}catch(PERR){g.reportError(PERR)}var success=!0,messageData;if(msg.decoded?(messageData=this._createMessageHTML(msg.decoded,msg.resources,msg.mimeType,options),messageData.missingResourceData&&(success=!1)):messageData=this._createErrorHTML(),msg.listUnsubscribe){var unsubData=this.parseListUnsubscribe(msg.listUnsubscribe);log("Unsub Data: ",unsubData)}try{g.PAssert(3895,messageData.parsed,"Must have valid parsed data")}catch(PERR){g.reportError(PERR)}return msg.blob=this._createFrameBlob(messageData.parsed,msg.contentType,msg.id),g.isString(msg.blob)||(msg.blobURL=platform.URL.createObjectURL(msg.blob)),msg.specialLinks=messageData.specialLinks,msg.height=new Observable(0),msg.responseMode||(msg.responseMode=new Observable(this._computeResponseMode(nextMessage))),msg.initializedForDisplay=!0,success},_destroyMessageDisplay:function _destroyMessageDisplayFn(msg){try{g.PAssert(3896,msg.initializedForDisplay,"Message must first be initialized before being destroyed")}catch(PERR){g.reportError(PERR)}msg.initializedForDisplay=!1,msg.height=void 0,msg.responseMode&&(msg.responseMode=void 0),msg.specialLinks=void 0,msg.blob=void 0,msg.blobURL&&(platform.URL.revokeObjectURL(msg.blobURL),msg.blobURL=void 0)},ensureDisplayMessages:function ensureDisplayMessagesFn(attach){if(attach===this.threadAttach)try{for(var messages=attach.getField("messages"),displayMessages=[],i=0;i<messages.length;++i){var msg=messages[i];if(!attach.getPlugin().isMessageDraft(msg)&&!msg.initializedForDisplay){this._generateAltParts(attach,msg);var success;success=0===i?this._createMessageDisplay(msg,messages[i+1],{collapseQuotes:!1}):this._createMessageDisplay(msg,messages[i+1]),success||this.getPlugin().reportMessage(attach.getField("accountID"),attach.id,msg.id,"Error creating display",!1)}displayMessages.push(msg)}this.messages.set(displayMessages)}catch(err){g.reportError(err)}},onAttachmentUpdate:function onAttachmentUpdateFn(attach,fields,changeType){(!fields||fields.indexOf("messages")>=0)&&attach.getPlugin().loadThread(attach,function(success,loadedData){try{g.PAssert(3897,success,"Must be able to re-load thread data")}catch(PERR){g.reportError(PERR)}loadedData&&attach===this.threadAttach&&this.ensureDisplayMessages(attach)}.bind(this))},getThreadAttach:function getThreadAttachFn(){return this.threadAttach},_setThread:function _setThreadFn(attach){try{g.PAssert(3898,attach.hasField("messages"),"Must supply valid messages to the email preview")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3899,this.errorMessage.get()||attach.getField("dataLoaded"),"Must have loaded remote data or have an error")}catch(PERR){g.reportError(PERR)}this.threadAttach&&this.threadAttach.id===attach.id||(this.reset(),this.threadAttach=attach,attach.subscribe(this),this.ensureDisplayMessages(attach),attach.getPlugin().attachmentHasLabel(attach,"UNREAD")&&attach.getPlugin().performAction(C.PluginAction.Gmail.MarkRead,!0,attach))},onSelectedIndexChanged:function onSelectedIndexChangedFn(index,pane,item){if(!platform.mobile&&this.isOpen()&&pane===this.openOnPane)if(item&&item.getAttachments()){var attach=item.getAttachments()[0];if(attach.getPlugin()===this.getPlugin()){var plugin=this.getPlugin();plugin.openEmailByID(attach.id,pane)}}else"PaneGmail"===pane.type&&this.reset()}},new EmailPreview}),define("AScript",["require","exports","module","globals","Constants","util","platform","data","tracker","react-dom","VMLI","edit","Sel","DragDrop","Dispatcher","EmailPreview","Observable","ObservableArray","Measure","DisplaySettings"],function(require,exports,module){function AScript(){function onMessage(e){if(e.data&&g.isString(e.data)&&e.data.indexOf("{")<0)for(var commands=e.data.split("&"),i=0;i<commands.length;i++){var params=commands[i].split("=");try{g.PAssert(3900,params.length>=0,"Invalid number of params in message")}catch(PERR){g.reportError(PERR)}switch(params[0]){case"script":this.runScript(params[1]);break;case"data":if(this.isRunning)return this.stop(),clearTimeout(this.timeoutMessage),void(this.timeoutMessage=setTimeout(onMessage.bind(this),100,e));this.loadScriptData(params[1]);break;case"start":this.start();break;case"stop":this.stop();break;case"pause":this.pause();break;case"resume":this.resume();break;case"restart":this.restart();break;case"alertDemo":g.menus.alert({text:'Click anywhere to try this <b class="blue">live demo</b>',callback:g.emptyFn});break;case"help":var show=params[1];"1"==show?g.vmMain.showHelp(C.HelpMode.Intro):g.intro.closeHelp();break;case"panes":this.loadPanes(params[1])}}}this.hasSelection=!1,this.isTyping=!1,this.isRunning=!1,this.isDisabled=!1,this.isPaused=!1,this.stoppedFromPause=!1,this.activeScript=void 0,this.index=0,this.repeat=!1,this.onScriptDone=void 0,this.selectedItem=void 0,this.lastLoadedData=void 0,this.savedItems={},this.typingSpeed=30,this._scriptQueue=[],this.startText={},this.demoCaption=new Observable,window.addEventListener("message",onMessage.bind(this),!1),window.pauseScript=function(){this.isDisabled||(log("pause script"),this.isDisabled=!0)}.bind(this)}var g=require("globals"),C=require("Constants"),util=require("util"),platform=require("platform"),d=require("data"),tracker=require("tracker"),ReactDOM=require("react-dom"),VMLI=require("VMLI"),edit=require("edit"),Sel=require("Sel"),DragDrop=require("DragDrop"),Dispatcher=require("Dispatcher"),EmailPreview=require("EmailPreview"),Observable=require("Observable"),ObservableArray=require("ObservableArray"),Measure=require("Measure"),DisplaySettings=require("DisplaySettings"),paneAnimTime=60,q=function(){this.queue.apply(this,arguments)},addItem=function(text,name,indent,set){if(q("createItemAfter",void 0,name),void 0!==indent&&0!==indent)for(var i=0;i<Math.abs(indent);i++)q("indent",0>indent?!0:!1);set?q("setText",void 0,text):q("typeString",void 0,text)},delay=function(value){q("delay",value)};return AScript.prototype={runScript:function runScriptFn(id){var shouldStart=!0;if(!this.isDisabled){var s=this.createScript(id);switch(this.activeScript=s,id){case"wait":this.demoEmpty(s);break;case"intro":this.demoIntro(s);break;case"introEmail":this.demoEmail(s);break;case"introStyle":this.demoStyle(s);break;case"top":this.demoTop(s);break;case"press":this.demoPress(s);break;case"none":return void this.notify("demoReady")}if(s.runQueue.length>0)this._scriptQueue.push(s);else try{g.PAssert(3901,!1,"Invalid script request: ",id)}catch(PERR){g.reportError(PERR)}this.repeat=!1,this.activeScript=this._scriptQueue[0],!this.isRunning&&this.activeScript&&shouldStart&&this.start()}},start:function startFn(){g.toasts.clearMessage(MessageID.ThisIsDemo),this.onScriptStart(this.activeScript),this.run()},restart:function restartFn(){this.activeScript=this._scriptQueue[0],this.activeScript.index=0,this.start()},stop:function stopFn(){this._scriptQueue=[],this.isRunning=!1,this.activeScript=void 0,clearTimeout(this.timeoutDelay),this.timeoutDelay=void 0,clearTimeout(this.timeout),this.timeout=void 0,clearTimeout(this.timeoutMessage),this.timeoutMessage=void 0,g.autocomplete.hide(),DragDrop.stop(),DragDrop.finish()},pause:function pauseFn(){this.isPaused=!0},resume:function resumeFn(){this.isPaused=!1,this.wasResumed=!0,this.stoppedFromPause&&(this.stoppedFromPause=!1,this.run())},demoReady:function demoReadyFn(cb){this.wasResumed||this.pause(),this.notify("demoReady"),cb()},switchDemo:function switchDemoFn(id){this.stop(),g.isDemoRunning=!0,selectedDemo=id;var script=this[id]();this.resetData(function(){this._scriptQueue.push(script),this.activeScript=script,this.start()}.bind(this))},loadScriptData:function loadScriptDataFn(dataId,cb){log("Load Script Data: ",dataId),this._scriptQueue=[],this.repeat=!1,this.lastLoadedData=dataId,Dispatcher.fireEvent("resetEverything",[]),g.vmMain.paneManager.clearPanes(!1),g.vmMain.beginUpdateItems(),d.loadDemoData(dataId,!0,function(id){g.vmMain.changeRoot(id),g.vmMain.commitUpdateItems(),cb&&cb()
})},loadPanes:function loadPanesFn(dataId){g.demoPanes=dataId.split(":"),g.vmMain.loadDemoPanes()},onScriptStart:function onScriptStartFn(script){script&&window.parent.postMessage(script.getName(),"*")},createScript:function createScriptFn(){var script={_nextId:0,owner:this,index:0,_repeat:!1,noDelay:!1,runQueue:[],_activeQueue:function _activeQueueFn(){return this.runQueue},queue:function queueFn(fnName){var args=Array.prototype.slice.call(arguments,1),arr=this.runQueue;return arr.push({id:this._nextId++,name:fnName,args:args}),arr},repeat:function repeatFn(val){this._repeat=val},nextStep:function nextStepFn(){var queue=this.runQueue;return queue[this.index++]},getName:function getNameFn(){return this._name}};return q=q.bind(script),addItem=addItem.bind(script),script},run:function runFn(){if(!this.isDisabled&&this.activeScript){if(this.isPaused)return void(this.stoppedFromPause=!0);try{g.PAssert(3903,this.activeScript,"Must have a script active to be running")}catch(PERR){g.reportError(PERR)}var next=this.activeScript.nextStep();if(next){var args=next.args;args.push(this.run.bind(this)),this.isRunning=!0,clearTimeout(this.timeout),this.timeout=setTimeout(function(){try{this[next.name].apply(this,args)}catch(err){g.reportError(err),this.onDisable()}}.bind(this),0)}}},onDisable:function onDisableFn(){this.isDisabled=!0},setSelection:function setSelectionFn(item,paneIndex,offset,length,cb){try{g.PAssert(3904,item,"Must provide a valid item to select")}catch(PERR){g.reportError(PERR)}if(g.isNumber(item)){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);item=pane.itemAtIndex(item)}item=this.getItemIfString(item);var selectPane=paneIndex>=0?g.vmMain.paneManager.getPaneAtIndex(paneIndex):g.focusedPane;g.focusedPane&&g.focusedPane.id===selectPane.id||Sel.focusPane(selectPane),void 0===offset||null===offset?offset=0:0>offset&&(offset=item.getParsedText().length+offset+1),Sel.selectItem(item,offset,offset+length),this.hasSelection=!0,this.selectedItem=item,cb&&cb()},clearSelection:function clearSelectionFn(cb){Sel.reset(),this.hasSelection=!1,this.selectedItem=void 0,cb&&cb()},scrollTo:function scrollToFn(index,offset,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(index);try{g.PAssert(3905,pane,"Must have selected a valid pane")}catch(PERR){g.reportError(PERR)}pane.setScrollOffset(offset),cb&&cb()},scrollMain:function scrollMainFn(x,duration,cb){g.vmMain.setScrollOffset(x,duration),setTimeout(cb,duration)},setText:function setTextFn(item,str,cb){item=item||this.selectedItem,item.setText(str,!0,ChangeType.Local),cb&&cb()},appendText:function appendTextFn(item,str,cb){item.setText(item.getParsedText()+str,!0),cb&&cb()},setPriority:function setPriorityFn(item,priority,cb){item=this.getItemIfString(item)||this.selectedItem,item.priority(priority,ChangeType.Local),cb&&cb()},setStarred:function setStarredFn(item,isStarred,cb){item=item||this.selectedItem,item.isStarred(isStarred,ChangeType.Local),cb&&cb()},setComplete:function setCompleteFn(item,isComplete,date,cb){item=this.getItemIfString(item)||this.selectedItem,item.dateCompleted=date,item.isComplete(isComplete,ChangeType.Local),cb&&cb()},removeItem:function removeItemFn(item,cb){item=this.getItemIfString(item)||this.selectedItem,item.deleteSelf(ChangeType.Local),cb()},setStarredEmail:function setStarredEmailFn(paneIndex,itemIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),item=pane.itemAtIndex(itemIndex);pane.toggleStar(item),cb()},setPriorityEmail:function setPriorityEmailFn(paneIndex,itemIndex,priority,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),item=pane.itemAtIndex(itemIndex),pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);pluginGmail.setAttachmentPriority(item.getAttachments()[0],priority),cb()},indent:function indentFn(outdent,cb){var keyData={normCode:KeyCode.Tab,shiftKey:outdent};g.fireKeyEvent(void 0,keyData),cb&&cb()},collapse:function collapseFn(item,paneIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);item=this.getItemIfString(item)||this.selectedItem,item.setCollapsed(!0,pane),cb&&cb()},backspace:function backspaceFn(item,num,index,cb){function typeChar(){return this.isTyping=!0,this.activeScript!==script?void stop():(str=str.substr(0,index-1)+str.substr(index,str.length-index),index--,item.setText(str,!0,ChangeType.Local),void(++i>=num&&(stop(),cb&&cb())))}try{g.PAssert(3910,cb,"typeString should always have a callback")}catch(PERR){g.reportError(PERR)}item=this.getItemIfString(item)||this.selectedItem;try{g.PAssert(3911,item,"Must be an item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3912,this.hasSelection,"Must set selection before typing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3913,!this.isTyping,"Must wait until previous typing is finished")}catch(PERR){g.reportError(PERR)}var i=0,stop=function(){this.intervalTyping&&(clearInterval(this.intervalTyping),this.intervalTyping=void 0),this.isTyping=!1}.bind(this),script=this.activeScript,str=item.getParsedText();typeChar.apply(this),num>1&&(clearInterval(this.intervalTyping),this.intervalTyping=setInterval(typeChar.bind(this),this.typingSpeed))},typeString:function typeStringFn(item,str,cb){function typeChar(){if(this.isTyping=!0,this.activeScript!==script)return void stop();var normCode=str.charCodeAt(i);if(normCode===KeyCode.Delete&&(normCode=KeyCode.Period),normCode===KeyCode.End){var start=Sel.getStartOffset(),itemText=item.getParsedText(),outStr=itemText.substr(0,start)+str.charAt(i)+itemText.substr(start);item.setText(outStr,!0,ChangeType.Local),Sel.selectItem(item,start+1)}else g.fireKeyEvent(void 0,{normCode:normCode});++i>=str.length&&(stop(),cb&&cb())}try{g.PAssert(3914,cb,"typeString should always have a callback")}catch(PERR){g.reportError(PERR)}item=this.getItemIfString(item)||this.selectedItem;try{g.PAssert(3915,item,"Must be an item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3916,this.hasSelection,"Must set selection before typing")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3917,!this.isTyping,"Must wait until previous typing is finished")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3918,void 0!==str,"Must supply a string to be typed")}catch(PERR){g.reportError(PERR)}var i=0,stop=function(){this.intervalTyping&&(clearInterval(this.intervalTyping),this.intervalTyping=void 0),this.isTyping=!1}.bind(this),script=this.activeScript;str&&(typeChar.apply(this),str.length>1&&(clearInterval(this.intervalTyping),this.intervalTyping=setInterval(typeChar.bind(this),this.typingSpeed)))},typeIntoEmail:function typeIntoEmailFn(str,charDelay,cb){function typeChar(){if(this.activeScript!==script)return void stop();var char=str[i];editable.insertCharAtIndex(char,i),++i>=str.length&&(stop(),cb&&cb())}var editable=g.reactEmailCompose.refs.body,i=0,stop=function(){this.intervalTyping&&(clearInterval(this.intervalTyping),this.intervalTyping=void 0),this.isTyping=!1}.bind(this),script=this.activeScript;clearInterval(this.intervalTyping),this.intervalTyping=setInterval(typeChar.bind(this),charDelay)},setSearch:function setSearchFn(search,paneIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);pane.search.setValue(search),cb&&cb()},createItemAfter:function createItemAfterFn(item,savedName,cb){item=item||this.selectedItem,this.setSelection(item,void 0,item.getParsedText().length,0),g.fireKeyEvent(void 0,{normCode:KeyCode.Enter}),requestAnimationFrame(function(){this.clearSelection(function(){var newItem;newItem=item.isHeader()?item.getChild(0):item.parent().getChild(item.getIndex()+1);try{g.PAssert(3923,newItem,"Error getting new item: ",savedName)}catch(PERR){g.reportError(PERR)}savedName&&(this.savedItems[savedName]=newItem),this.selectedItem=newItem,this.setSelection(newItem,void 0,-1,0,cb)}.bind(this))}.bind(this))},zoomPane:function zoomPaneFn(paneIndex,item,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);item=this.getItemIfString(item),pane.setItem(item,!0),cb&&cb()},zoomGmailPane:function zoomGmailPaneFn(paneIndex,labelName,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail),label=pluginGmail._getLabelByName("me",labelName);try{g.PAssert(3929,label,"Must be able to get a valid label if clicking a valid label")}catch(PERR){g.reportError(PERR)}var item=pluginGmail.getVMLIForLabel("me",label);pane.setItem(item,!0),pane.selectIndex(-1),cb&&cb()},delay:function delayFn(ms,cb){cb&&(0===ms?cb&&cb():(this.delayCb=cb,clearTimeout(this.timeoutDelay),this.timeoutDelay=setTimeout(function(){this.delayCb=this.timeoutDelay=void 0,cb()}.bind(this),ms)))},addPane:function addPaneFn(type,index,focusItem,search,notify,cb){var params={};params.item=focusItem?this.getItemIfString(focusItem):d.getRootModel(),search&&(params.search=search);var pane=g.vmMain.paneManager.createPaneAtIndex(type,index,params,notify);cb()},removePane:function removePaneFn(paneIndex,notify,cb){g.vmMain.paneManager.removePaneAtIndex(paneIndex,notify),cb&&cb()},cullPanes:function cullPanesFn(numPanesLeft,cb){var count=g.vmMain.paneManager.paneCount();count>numPanesLeft?(this.removePane(count-1),setTimeout(this.cullPanes.bind(this,numPanesLeft,cb),paneAnimTime)):cb()},selectItemInPane:function selectItemInPaneFn(paneIndex,itemIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),item=pane.itemAtIndex(itemIndex);this.selectedItem=item,cb()},dragTo:function dragToFn(paneIndexMove,paneIndexTarget,moveIndex,targetIndex,totalTime,cb){function ease(t){return.5>t?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}function moveDrag(time){if(self.activeScript!==script)return void g.fireMouseUp(moveEl,ButtonCode.Left);startTime||(startTime=time);var p=ease((time-startTime)/totalTime);if(currentX=targetX*p+srcRect.left+10,currentY=targetY*p+top,p>=1){var blocker=document.getElementById("preventInteraction"),blockerParent;blocker&&(blockerParent=blocker.parentElement,blockerParent.removeChild(blocker))}moveItem.dragMove({eventX:currentX,eventY:currentY,diffY:targetY>srcRect.top?1:-1,preventDefault:g.emptyFn}),blocker&&blockerParent.appendChild(blocker),p>=1?(moveItem.dragEnd({target:moveEl,srcElement:moveEl}),cb&&cb()):requestAnimationFrame(moveDrag)}var paneMove=g.vmMain.paneManager.getPaneAtIndex(paneIndexMove),paneTarget=g.vmMain.paneManager.getPaneAtIndex(paneIndexTarget),moveItem=paneMove.itemAtIndex(moveIndex),moveEl=paneMove.elementAtIndex(moveIndex),isLast=-1===targetIndex;isLast&&(targetIndex=paneTarget.numItems()-1);var targetEl=paneTarget.elementAtIndex(targetIndex),targetItem=paneTarget.itemAtIndex(targetIndex),srcRect=moveEl.getBoundingClientRect(),dstRect=targetEl.getBoundingClientRect(),dragMarginTop=paneMove.dragMarginTop||0,top=srcRect.top+(dragMarginTop||10),targetX=dstRect.left-srcRect.left,targetY=dstRect.top-top+(isLast?Measure.lineItemHeight(targetItem,1):0);Sel.focusPane(paneMove);var currentX,currentY,startTime=null,self=this,script=this.activeScript;DragDrop.startDragItem=moveItem,moveItem.dragStart({startSrc:moveEl,eventX:srcRect.left+10,eventY:top}),requestAnimationFrame(moveDrag)},getItemIfString:function getItemIfStringFn(itemCandidate){var item;if(g.isString(itemCandidate)){item=d.getModel(itemCandidate)||this.savedItems[itemCandidate];try{g.PAssert(3936,item,"Item was not saved correctly")}catch(PERR){g.reportError(PERR)}}else if(itemCandidate){try{g.PAssert(3937,itemCandidate instanceof VMLI,"Must supply a valid VMLI: ",g.getObjectInfo(itemCandidate))}catch(PERR){g.reportError(PERR)}item=itemCandidate}return item},pushMessage:function pushMessageFn(text,cb){if(this._currentToast)return g.toasts.clearMessage(this._currentToast),this._currentToast=void 0,void setTimeout(this.pushMessage.bind(this),100,text,cb);var msg;if(msg=g.toasts.pushMessage(g.isString(text)?{text:text,hold:!0}:text),this._currentToast=msg,text===MessageID.ThisIsDemo){var closeFn=function(){g.toasts.clearMessage(msg),window.removeEventListener("tapMain",closeFn)};window.addEventListener("tapMain",closeFn)}cb&&cb()},notify:function notifyFn(text,cb){window.parent.postMessage(text,"*"),cb&&cb()},demoDone:function demoDoneFn(cb){Sel.reset(),this.notify("done"),g.isDemoRunning=!1,g.autocomplete.isEnabled=!0;var blocker=document.getElementById("preventInteraction");blocker&&blocker.parentElement.removeChild(blocker),cb()},addClass:function addClassFn(cls,cb){g.addClass(document.documentElement||document.body,cls),cb&&cb()},removeClass:function removeClassFn(cls,cb){g.removeClass(document.documentElement||document.body,cls),cb&&cb()},switchClass:function switchClassFn(from,to,cb){this.removeClass(from),this.addClass(to),cb()},selectEmail:function selectEmailFn(paneIndex,itemIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);try{g.PAssert(3938,pane,"Must have selected a valid pane")}catch(PERR){g.reportError(PERR)}Sel.focusPane(pane),pane.selectIndex(itemIndex),cb&&cb()},openEmail:function openEmailFn(paneIndex,itemIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);try{g.PAssert(3939,pane,"Must have selected a valid pane")}catch(PERR){g.reportError(PERR)}pane.selectIndex(itemIndex);var item=pane.itemAtIndex(itemIndex);pane.openEmailByItem(item),cb&&cb()},closeEmail:function closeEmailFn(cb){EmailPreview.close(),cb&&cb()},sendEmail:function sendEmailFn(cb){g.reactEmailCompose.onClickSend(),cb()},toggleMessageExpanded:function toggleMessageExpandedFn(index,cb){g.reactEmailPreview.toggleExpanded(index),cb()},replyToMessage:function replyToMessageFn(cb){EmailPreview.setLastMessageResponseMode(C.EmailResponseMode.Reply),cb()},archiveEmail:function archiveEmailFn(paneIndex,itemIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),item=pane.itemAtIndex(itemIndex);pane.archiveItem(!0,item),cb()},addEmail:function addEmailFn(threadID,cb){var pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);pluginGmail.refreshThreadCacheData("me",threadID,void 0,function(){},cb)},waitPaneItems:function waitPaneItemsFn(paneIndex,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex);try{g.PAssert(3940,pane,"Must have selected a valid pane")}catch(PERR){g.reportError(PERR)}if(pane.items.length()>0)cb();else{var wait=function(value){value.length>0&&(pane.items.unlisten(wait),cb())};pane.items.listen(wait)}},displaySetting:function displaySettingFn(theme,cb){DisplaySettings.changeTheme(theme),cb()},tooltipItem:function tooltipItemFn(paneIndex,index,text,above,offset,arrow,cb){var pane=g.vmMain.paneManager.getPaneAtIndex(paneIndex),element=pane.elementAtIndex(index);if("left"===offset.x){var box=element.getBoundingClientRect();offset.x=-box.width/2+30}g.tooltip.displayTip({text:text,element:element,above:above,offset:offset,maxWidth:360,sticky:!0,arrow:arrow}),cb()},caption:function captionFn(text,center,cb){this.demoCaption.set({text:text,opacity:1,center:center,light:text.indexOf("<b>")>=0}),cb()},captionFade:function captionFadeFn(cb){var c=this.demoCaption.get();this.demoCaption.set({text:c.text,opacity:0,center:c.center,light:c.light}),cb()},resetData:function resetDataFn(cb){return this.isRunning?(this.stop(),clearTimeout(this.timeoutMessage),void(this.timeoutMessage=setTimeout(this.resetData.bind(this),100,cb))):void this.loadScriptData(d.demoDataId,cb)},waitAction:function waitActionFn(check,cb){this._waitTracker={check:check,cb:cb}},onTrackerAction:function onTrackerActionFn(e){var w=this._waitTracker;w&&w.check(e)&&w.cb()},demoTop:function demoTopFn(s){function swap(oldCls,newCls,caption){q("captionFade"),delay(captionFadeTime),q("switchClass",oldCls,newCls),delay(captionFadeTime),q("caption",caption,!1),delay(startTime)}var startTime=800,endTime=800,captionFadeTime=800;this.addClass("demoTop"),this.addClass("demosFaded"),this.typingSpeed=50,g.autocomplete.isEnabled=!1,this.demoCaption.set({text:"",opacity:0,center:!0}),delay(200),q("demoReady"),q("removeClass","invisible"),delay(200),q("caption","Everything is a <b>todo list.</b>",!0),delay(2e3),swap("demosFaded","demoTop1","<b>Email</b>"),q("setPriorityEmail",0,0,VMLIFlag.P0),delay(400),q("setStarredEmail",0,1),delay(400),q("setPriorityEmail",0,2,VMLIFlag.P2),delay(endTime),swap("demoTop1","demoTop2","<b>Calendar</b>"),q("setSelection","electrician",2,0,0),delay(500),q("typeString",void 0,"#calls "),delay(300),q("setSelection","electrician",2,-1,0),delay(300),q("typeString",void 0," 4pm"),q("setSelection","helpSystem",2,-1,0),q("setSelection","electrician",2,-1,0),delay(endTime),swap("demoTop2","demoTop3","<b>Tasks</b>"),q("setSelection","extinguisher",1,-1,0),delay(200),q("typeString",void 0," #fire"),delay(400),q("setPriority",void 0,VMLIFlag.P0),delay(600),q("dragTo",1,1,4,6,800),delay(endTime),q("captionFade"),q("switchClass","demoTop3","demosFaded"),delay(800),q("caption","So they should all <b>work together.</b>",!0),delay(2e3),q("captionFade"),delay(endTime),q("switchClass","demosFaded","demoTop3"),delay(400),swap("demoTop3","demoTop4","<b>Email</b> in your <b>Tasks</b> on your <b>Calendar</b>"),q("dragTo",0,1,0,5,1e3),q("archiveEmail",0,0),delay(600),q("setSelection",5,1,-1,0),delay(500),q("typeString",void 0," @NOW"),delay(1200),q("setSelection",1,2,-1,0),delay(600),q("setComplete",void 0,!0,void 0),q("setSelection",2,2,-1,0),delay(300),q("setSelection","extinguisher",2,-1,0),delay(300),q("setComplete",void 0,!0,void 0),q("setSelection","extinguisher",2,-1,0),delay(300),q("setSelection","electrician",2,-1,0),delay(300),q("setComplete",void 0,!0,void 0),q("setSelection","electrician",2,-1,0),delay(endTime),q("captionFade"),q("switchClass","demoTop4","demoTop5"),delay(1500),q("switchClass","demoTop5","demoTop6"),q("caption",'<img class="demoTopLogo" src="/img/logoForWhite600.png"/><br><div class="demoTopTagline">Get it together.</div>',!0),delay(1e3),q("switchClass","demoTop6","demoTop7"),delay(1500),q("demoDone")},demoIntro:function demoIntroFn(s){g.addClass(document.documentElement,"demoIntro"),this.typingSpeed=30,g.autocomplete.isEnabled=!1,q("removeClass","invisible"),q("demoReady"),delay(500),q("setSelection","first",1,-1,0),q("typeString",void 0,"Organize everything"),addItem("In a powerful outliner","subproject",1,!1),delay(200),addItem("With #tags for context","Feedback",1,!1),delay(200),addItem("Integrated +Contacts","Fancy",0,!1),delay(200),addItem("Synced with Google Calendar","synced",0,!1),q("setText",void 0,"Synced with Google Calendar  p:GCalendar,id:syncEvent "),delay(200),addItem("Attached ",void 0,0,!1),q("setText",void 0,"Attached p:Drive,id:file "),delay(400),addItem("With a fully featured email client",void 0,-1,!1),addItem("","prioritize",1,!0),delay(300),q("addEmail","emailReply"),delay(100),q("addEmail","emailConvo"),delay(100),q("addEmail","emailProject"),delay(100),q("addEmail","emailApp2"),delay(800),q("selectEmail",0,0),delay(200),q("openEmail",0,0),delay(1800),q("closeEmail"),delay(800),q("dragTo",0,1,0,7,1e3),delay(1e3),q("setSelection","prioritize",1,-1,0),q("indent",!0),q("indent",!0),q("typeString",void 0,"Prioritize everything"),delay(200),addItem("With dates","dates",1,!1),q("typeString",void 0," @tomorrow"),delay(600),q("setSelection",7,1,-1,0),q("typeString",void 0," @friday"),delay(600),q("setSelection","dates",1,-1,0),addItem("Or high/medium/low priority","priority",0,!1),delay(400),q("setPriority","priority",VMLIFlag.P0),delay(400),q("setPriority","prioritize",VMLIFlag.P1),delay(400),q("setPriority","synced",VMLIFlag.P2),delay(800),q("setSelection","priority",1,-1,0),addItem("Complete tasks when they're done","complete",0,!1),delay(400),q("selectItemInPane",1,11),q("setComplete",void 0,!0,void 0),delay(300),q("selectItemInPane",1,9),q("setComplete",void 0,!0,void 0),delay(300),q("selectItemInPane",1,7),q("setComplete",void 0,!0,void 0),delay(600),q("pushMessage",MessageID.ThisIsDemo),q("demoDone")},demoEmail:function demoEmailFn(s){return g.isDemoRunning=!0,q("waitPaneItems",0),q("zoomGmailPane",1,"Needs Reply"),q("zoomGmailPane",2,"STARRED"),q("removeClass","invisible"),q("demoReady"),delay(1e3),q("dragTo",0,1,0,-1,1e3),delay(200),q("dragTo",0,1,0,-1,1e3),delay(800),q("setStarredEmail",0,1),delay(500),q("setStarredEmail",0,3),delay(800),q("setPriorityEmail",2,0,VMLIFlag.P0),delay(500),q("setPriorityEmail",2,2,VMLIFlag.P2),delay(1200),q("selectEmail",0,0),delay(200),q("openEmail",0,0),q("pushMessage",MessageID.ThisIsDemo),q("demoDone"),s},demoStyle:function demoStyleFn(s){g.isDemoRunning=!0,g.autocomplete.isEnabled=!1,this.collapse("ideas",0),this.collapse("todo",0),this.collapse("testing",0),q("removeClass","invisible"),q("demoReady"),delay(500),q("dragTo",0,1,1,1,1e3),delay(1e3),q("setSelection","tracking",0,-1,0),q("typeString",void 0," #Android"),delay(800),q("typeString",void 0," @tomorrow "),delay(800),q("setSelection","tracking",0,0,0),q("typeString",void 0,"+Grant "),delay(1500),q("zoomPane",1,"release"),delay(1500);for(var search="#Android",i=search.length;i>=0;i--)q("setSearch",search.substr(0,i),2),delay(40);delay(800),search="+Grant";for(var i=0;i<=search.length;i++)q("setSearch",search.substr(0,i),2),delay(40);q("pushMessage",MessageID.ThisIsDemo),q("demoDone")},demoPress:function demoPressFn(s){tracker.addListener(this.onTrackerAction.bind(this)),q("pushMessage",{text:"Try dragging an email onto the Outline.",hold:!0,big:!0}),q("waitAction",function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Gmail}),q("pushMessage",{text:"Schedule an item by typing @ then a date.<br><br>Or drag it right onto the Agenda.",hold:!0,big:!0}),q("waitAction",function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate||e.type===TrackerType.Insert&&"@"===e.data[0].text}),q("pushMessage",{text:"Learn more on our homepage.",hold:!0,action:MessageAction.OpenURL,actionText:"https://moo.do",data:{url:"https://www.moo.do"}})},demoEmpty:function demoEmptyFn(s){g.isDemoRunning=!0,q("demoReady"),q("pushMessage",MessageID.ThisIsDemo),q("demoDone")}},AScript}),define("VMSetup",["ko","data","globals","util","platform","goog","AScript","AccountManager"],function(ko,d,g,util,platform,goog,AScript,AccountManager){function VMSetup(){this.loginState=ko.observable(LoginState.NONE);var gapiLoaded=window.gapi&&window.gapi.auth;this.loginStatus=ko.observable(navigator.onLine?gapiLoaded?LoginStatus.Normal:LoginStatus.Loading:LoginStatus.Offline),gapiLoaded||window.addEventListener("gapiLoaded",function(){this.loginStatus()===LoginStatus.Loading&&this.loginStatus(LoginStatus.Normal)}.bind(this)),this.loginRequested=!1,this.loginRequestTimer=void 0}var LoginStatus={Normal:"Sign in with Google",Connecting:"Connecting...",LoggingIn:"Logging In...",Loading:"Loading...",Offline:"Offline"};return VMSetup.prototype={init:function initFn(){if(g.isDemoMode())return LoginState.LOGGED_OUT;var loginState=g.getLoginState();return this.setLoginState(loginState),g.applyBindings(this,"setup"),window.addEventListener("gapiLoaded",function(){try{g.PAssert(3941,window.gapi&&window.gapi.auth,"Must have gapi libs loaded correctly to receive gapiLoaded event")}catch(PERR){g.reportError(PERR)}this.loginRequested&&(this.loginStatus(LoginStatus.Normal),AccountManager.hasValidAccessToken()?this.userLogin():this.loginRequested=!1)}.bind(this)),window.addEventListener("offline",function(){log("Browser going offline."),g.vmMain.setGDriveStatus(DriveStatus.Offline),this.loginStatus(LoginStatus.Offline)}.bind(this)),window.addEventListener("online",function(){if(log("Browser going online."),this.loginStatus(LoginStatus.Normal),this.loginRequested&&(AccountManager.hasValidAccessToken()?this.userLogin():this.loginRequested=!1),g.getLoginState()==LoginState.LOGGED_IN&&!platform.offline){var alreadyOnline=goog.ensureDocConnection();log("Coming online. Already online:",alreadyOnline)}}.bind(this)),loginState},showGooglePlus:function showGooglePlusFn(){return this.loginStatus()===LoginStatus.Normal},logoutButtonText:function logoutButtonTextFn(){return g.isDemoMode()?"Leave Demo":"LOGOUT"},setLoginState:function setLoginStateFn(state){state!=this.loginState()&&(g.setLoginState(state),this.loginState(state))},userLogin:function userLoginFn(){var gapiLoaded=window.gapi&&window.gapi.auth;gapiLoaded&&this.loginStatus()===LoginStatus.Normal&&this.loginState()!=LoginState.LOGGED_IN?(this.loginStatus(LoginStatus.LoggingIn),this.loginRequested=!1,goog.runAuthenticate(goog.requiredScopes,!1,!0,function(token){this.loginStatus(LoginStatus.Normal),token&&!token.error?(g.settings.set(Settings.localIntegrity,!0),this.setLoginState(LoginState.LOGGED_IN),g.vmMain.paneManager.setupInitialTimeout(),gapi.load("drive-realtime",function(){goog.loadClientDefaultFile()})):log("Invalid token returned when calling userLogin")}.bind(this))):(this.loginStatus(LoginStatus.Connecting),this.loginRequested=!0),clearTimeout(this.loginRequestTimer),this.loginRequestTimer=setTimeout(function(){this.loginStatus(navigator.onLine?LoginStatus.Normal:LoginStatus.Offline),this.loginRequested=!1}.bind(this),500)},openLogin:function openLoginFn(){this.loginState(LoginState.NONE)},logout:function logoutFn(){this.setLoginState(LoginState.LOGGED_OUT),d.clearData(function(){util.storage.clear(),setTimeout(function(){util.hasURLParam("login")?util.removeURLParam("login"):util.hasURLParam("user")?util.removeURLParam("user"):platform.app?platform.app&&g.nativeBridge.sendToApp("logout"):g.reload()},0)})},logoutClicked:function logoutClickedFn(){if(g.isDemoMode())util.removeURLParam("demo");else{var ok=!0;for(var itemID in d.pendingRemoteUpdates)if(d.pendingRemoteUpdates.hasOwnProperty(itemID)){g.menus.confirm("You have unsaved changes which will be lost if you log out. Are you sure?",function(result){result&&this.logout()}.bind(this)),ok=!1;break}ok&&this.logout()}},isLocal:function isLocalFn(){return"localhost"==window.location.hostname},onlineStatusToggle:function onlineStatusToggleFn(){platform.offline?util.removeURLParam("offline"):util.insertURLParam("offline","true")},initDemo:function initDemoFn(){g.AScript||(g.AScript=new AScript)},runScript:function runScriptFn(id){g.AScript.runScript(id)},onTapLogin:function onTapLoginFn(e){this.loginStatus()===LoginStatus.Normal&&this.userLogin(),platform.mobile&&e&&(e.preventDefault(),e.stopPropagation(),g.preventClick())},onTapLanding:function onTapLandingFn(e){(platform.mobile||g.hasClass(e.srcElement,"link"))&&g.openUrl("/",e)},onPrivacyPolicy:function onPrivacyPolicyFn(e){(platform.mobile||g.hasClass(e.srcElement,"link"))&&g.openUrl("/privacy/",e)},onEmailKeydown:function onEmailKeydownFn(data,e){return e.normCode===KeyCode.Enter?(this.onTapLogin(e),e.preventDefault(),e.stopImmediatePropagation(),!1):!0}},VMSetup}),define("SettingsManager",["require","exports","module","globals","util","EventDispatcher"],function(require,exports,module){function SettingsManager(){this._versions={},this._values={},this._changeListeners=[],this._apiNotifications={},this._localLoaded=!1,this._localLoadError=!1,this._localWriteError=!1,this._remoteLoaded=!1,this._remoteLoadError=!1,this._remoteSettings=void 0,this.init()}var g=require("globals"),util=require("util"),EventDispatcher=require("EventDispatcher"),DefaultGroup=Settings.DefaultGroup="Default",UISettingsGroup=Settings.UISettingsGroup="UISettings",CURRENT_VERSION=1,LocalSettingProp="localSettings",UnsetVersion=-1,RemoteKey=0,RemoteValue=1;return SettingsManager.prototype={init:function initFn(){this._testLocalWrites(),this.registerGroup(DefaultGroup),this.registerGroup(UISettingsGroup),this.registerSetting(Settings.theme,DefaultGroup,!0),this.registerSetting(Settings.syncContacts,DefaultGroup,!0),this.registerSetting(Settings.shownTutorial,DefaultGroup,!0),this.registerSetting(Settings.rootFolderId,DefaultGroup,!0),this.registerSetting(Settings.attachFolderId,DefaultGroup,!0),this.registerSetting(Settings.enableOfflineAuth,DefaultGroup,!0),this.registerSetting(Settings.trialOverHidden,DefaultGroup,!0),this.registerSetting(Settings.helpState,DefaultGroup,!0),this.registerSetting(Settings.helpPaneState,DefaultGroup,!0),this.registerSetting(Settings.closedImport,DefaultGroup,!0),this.registerSetting(Settings.lastContactSync),this.registerSetting(Settings.lastTaskSync),this.registerSetting(Settings.disableNotifications),this.registerSetting(Settings.authScopes),this.registerSetting(Settings.localIntegrity),this.registerSetting(Settings.localDataVersion),this.registerSetting(Settings.localRecoverVersion),this.registerSetting(Settings.gdocId),this.registerSetting(Settings.gdocTitle),this.registerSetting(Settings.activeUser),this.registerSetting(Settings.userId),this.registerSetting(Settings.displayName),this.registerSetting(Settings.noSounds),this.registerSetting(Settings.lastServerVersion),this.registerSetting(Settings.oauthScheme),this.registerSetting(Settings.premiumStatus),this.registerSetting(Settings.trialStart),this.registerSetting(Settings.trialDuration),this.registerSetting(Settings.premiumEndDate),this.registerSetting(Settings.notifiedTrialOver),this.registerSetting(Settings.notifiedTrialEndSoon),this.registerSetting(Settings.showBullets,UISettingsGroup,!0,!1),this.registerSetting(Settings.bulletColor,UISettingsGroup,!0,"#CCCCCC"),this.registerSetting(Settings.showVerticalLines,UISettingsGroup,!0,!1),this.registerSetting(Settings.verticalLinesColor,UISettingsGroup,!0,"#EEEEEE"),this.registerSetting(Settings.boldHeaders,UISettingsGroup,!0,!0),this.registerSetting(Settings.itemPadding,UISettingsGroup,!0,7),this.registerSetting(Settings.notePadding,UISettingsGroup,!0,0),this.registerSetting(Settings.itemLineHeight,UISettingsGroup,!0,18),this.registerSetting(Settings.noteLineHeight,UISettingsGroup,!0,18),this.registerSetting(Settings.fontSize,UISettingsGroup,!0,14),this.registerSetting(Settings.noteFontSize,UISettingsGroup,!0,13),this.registerSetting(Settings.itemIndentSize,UISettingsGroup,!0,20),this.registerSetting(Settings.tagColor,UISettingsGroup,!0,"#0099DD"),this.registerSetting(Settings.dateColor,UISettingsGroup,!0,"#AA3300"),this.registerSetting(Settings.contactColor,UISettingsGroup,!0,"#22AA66"),this.registerSetting(Settings.linkColor,UISettingsGroup,!0,"#3333BB"),this.registerSetting(Settings.underlineP,UISettingsGroup,!0,!1),this.registerSetting(Settings.layoutTheme,UISettingsGroup,!0),this.registerSetting(Settings.grayscale,UISettingsGroup,!0,!1),this.registerAPIServerNotification(Settings.layoutTheme,UISettingsGroup),this.registerAPIServerNotification(Settings.boldHeaders,UISettingsGroup),this.registerAPIServerNotification(Settings.grayscale,UISettingsGroup),this._setupLocalNotifications(),this._ensureLocalLoaded(),this._ensureRemoteSettings()},_setupLocalNotifications:function _setupLocalNotificationsFn(){g.shouldWriteLocal()&&window.addEventListener("storage",function(e){if(e||(e=window.event),e.key===LocalSettingProp){var oldParsedValue,newParsedValue;try{if(e.oldValue&&(oldParsedValue=this._deserializeSettings(e.oldValue)),e.newValue&&(newParsedValue=this._deserializeSettings(e.newValue)),oldParsedValue&&newParsedValue){try{g.PAssert(3944,oldParsedValue.values,"Must have a valid set of old settings")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3945,newParsedValue.values,"Must have a valid set of new settings")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this._changeListeners.length;++i){var entry=this._changeListeners[i];try{g.PAssert(3946,entry,"Each listener must have a valid entry")}catch(PERR){g.reportError(PERR)}var oldGroup=oldParsedValue.values[entry.groupID],newGroup=newParsedValue.values[entry.groupID],oldValue,newValue;if(oldGroup&&newGroup?(oldValue=oldGroup[entry.key],newValue=newGroup[entry.key]):!oldGroup&&newGroup?(oldValue=void 0,newValue=newGroup[entry.key]):oldGroup&&!newGroup&&(oldValue=oldGroup[entry.key],newValue=void 0),oldValue!==newValue)try{entry.fn(oldValue,newValue)}catch(entryErr){g.reportError(entryErr)}}for(var groupID in newParsedValue.versions){var newGroup=newParsedValue.versions[groupID],oldGroup=oldParsedValue.versions[groupID];if(newGroup)for(var key in newGroup){var newVersion=newGroup[key],oldVersion=oldGroup?oldGroup[key]:void 0;
if(!oldGroup||newVersion>oldVersion){var newValue=newParsedValue.values[groupID][key],oldValue=oldGroup?oldParsedValue.values[groupID][key]:void 0;this.fireEvent("settingChanged",groupID,key,[oldValue,newValue])}}}}}catch(err){g.reportError(err)}if(this._localLoaded=!1,newParsedValue)this._loadLocalSettings(newParsedValue);else try{g.PAssert(3947,!1,"Unable to update settings to be empty")}catch(PERR){g.reportError(PERR)}}}.bind(this),!1)},registerForChangeNotification:function registerForChangeNotificationFn(key,groupID,fn){try{g.PAssert(3948,key,"Must provide a valid key to watch")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3949,fn&&g.isFunction(fn),"Must provide a valid callback fn",fn)}catch(PERR){g.reportError(PERR)}groupID=groupID||DefaultGroup,this._changeListeners.push({key:key,groupID:groupID,fn:fn})},_testLocalWrites:function _testLocalWritesFn(){var localAvailable=!1;try{util.storage.setItem("poke",0),localAvailable=!0}catch(err){g.preventLocalWrites()}return localAvailable},registerGroup:function registerGroupFn(groupID){this._versions[groupID]||(this._versions[groupID]={},this._values[groupID]={})},registerSetting:function registerSettingFn(key,groupID,syncRemote,defaultValue){groupID=groupID||DefaultGroup,syncRemote=syncRemote||!1;try{g.PAssert(3951,this._versions[groupID],"Must first register a group before a setting in the group")}catch(PERR){g.reportError(PERR)}this._versions[groupID][key]||(this._versions[groupID][key]={version:UnsetVersion,syncRemote:syncRemote}),void 0!==defaultValue&&void 0===this._values[groupID][key]&&(this._values[groupID][key]=defaultValue)},registerAPIServerNotification:function registerAPIServerNotificationFn(key,groupID){groupID=groupID||DefaultGroup,this._apiNotifications[groupID]||(this._apiNotifications[groupID]={}),this._apiNotifications[groupID][key]=!0},get:function getFn(key,groupID){groupID=groupID||DefaultGroup;try{g.PAssert(3953,key,"Must specify a valid setting to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3954,this._versions[groupID],"Must first register a group before getting a setting from it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3955,!this._versions[groupID]||void 0!==this._versions[groupID][key],"Must first register a setting before getting a value from it: "+key)}catch(PERR){g.reportError(PERR)}return this._ensureLocalLoaded(),this._values[groupID][key]},set:function setFn(key,value,groupID){groupID=groupID||DefaultGroup;try{g.PAssert(3956,key,"Must specify a valid setting to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3957,this._versions[groupID],"Must first register a group before getting a setting from it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3958,!this._versions[groupID]||void 0!==this._versions[groupID][key],"Must first register a setting before setting a value to it")}catch(PERR){g.reportError(PERR)}var performWrite=!1;this._ensureLocalLoaded();var localValue=this._values[groupID][key],localVersion=this._versions[groupID][key].version;if((localValue!==value||g.isObject(value)||g.isArray(value))&&(performWrite=!0),performWrite){var syncRemote=this._versions[groupID][key].syncRemote,newVersion=localVersion+1;syncRemote&&this._remoteLoaded&&this._setRemoteValue(key,value,newVersion,groupID),this._values[groupID][key]=value,this._versions[groupID][key].version=newVersion,this._writeLocalSettings(),this._sendChangeNotification(groupID,key,localValue,value,ChangeType.Local)}},reset:function resetFn(key,groupID){groupID=groupID||DefaultGroup;try{g.PAssert(3959,key,"Must specify a valid setting to get")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3960,void 0!==this._versions[groupID],"Must first register a group before getting a setting from it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3961,this._versions[groupID][key].syncRemote===!1,"Currently do not support resetting remote syncd settings")}catch(PERR){g.reportError(PERR)}this._ensureLocalLoaded();var oldValue=this._values[groupID][key];delete this._values[groupID][key],this._writeLocalSettings(),this._sendChangeNotification(groupID,key,oldValue,void 0,ChangeType.Local)},resetAll:function resetAllFn(skipList){try{g.PAssert(3963,!g.isArray(skipList),"Must pass in a valid settings object to skip")}catch(PERR){g.reportError(PERR)}if(g.isArray(skipList)){var defaultSettingsSkip=skipList;skipList={},skipList[DefaultGroup]=defaultSettingsSkip}for(var groupID in this._versions){var group=this._versions[groupID],groupSkip=skipList?skipList[groupID]:void 0;for(var propID in group)(!groupSkip||groupSkip.indexOf(propID)<0)&&(this._versions[groupID][propID].version=UnsetVersion,this._values[groupID][propID]=void 0)}if(skipList)this._writeLocalSettings();else if(g.shouldWriteLocal())try{util.storage.setItem(LocalSettingProp,"{}")}catch(err){g.reportError(err)}},_ensureLocalLoaded:function _ensureLocalLoadedFn(){if(g.shouldWriteLocal()&&!this._localLoaded)try{var storValue=util.storage.getItem(LocalSettingProp);storValue||(g.isFirstRun=!0),this._loadLocalSettings(this._deserializeSettings(storValue))}catch(err){g.reportError(err),this._localLoadError=!0}},_serializeSettings:function _serializeSettingsFn(){var out={__version:CURRENT_VERSION,versions:{},values:{}};for(var groupID in this._versions){var group=this._versions[groupID];for(var propID in group){var pVersion=this._versions[groupID][propID].version,pValue=this._values[groupID][propID];this._versions[groupID][propID].syncRemote&&(out.versions[groupID]||(out.versions[groupID]={}),out.versions[groupID][propID]=pVersion),out.values[groupID]||(out.values[groupID]={}),void 0!==pValue&&(out.values[groupID][propID]=pValue)}}return out},_deserializeSettings:function _deserializeSettingsFn(settings){var out={versions:{},values:{}};if(settings)try{var settingsObj=JSON.parse(settings);if(void 0===settingsObj.__version){var VersionPrefix="V~";out.versions[DefaultGroup]={},out.values[DefaultGroup]={};for(var prop in settingsObj)if(prop.startsWith(VersionPrefix)){var ver=settingsObj[prop];out.versions[DefaultGroup][prop.substr(VersionPrefix.length)]=ver}else{var value=settingsObj[prop];out.values[DefaultGroup][prop]=value}}else if(settingsObj.__version===CURRENT_VERSION)out.versions=settingsObj.versions,out.values=settingsObj.values;else try{g.PAssert(3964,!1,"Invalid settings version")}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}return out},_loadLocalSettings:function _loadLocalSettingsFn(parsedSettings){try{g.PAssert(3965,!this._localLoaded,"Should not load settings from local twice")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3966,parsedSettings,"Must supply some valid parsed settings")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3967,!parsedSettings||parsedSettings.versions,"Must have a valid constructed parsed settings - versions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3968,!parsedSettings||parsedSettings.values,"Must have a valid constructed parsed settings - values")}catch(PERR){g.reportError(PERR)}var versions=parsedSettings.versions,values=parsedSettings.values;for(var groupID in versions){var group=versions[groupID];this._versions[groupID]||(this._versions[groupID]={});for(var propID in group)this._versions[groupID][propID]={version:group[propID],syncRemote:!0}}for(var groupID in values){var group=values[groupID];this._values[groupID]||(this._values[groupID]={});for(var propID in group)this._values[groupID][propID]=group[propID]}this._localLoaded=!0,this._localLoadError=!1},_writeLocalSettings:function _writeLocalSettingsFn(){if(g.shouldWriteLocal())try{var writeSettings=this._serializeSettings();util.storage.setItem("localSettings",JSON.stringify(writeSettings))}catch(err){g.reportError(err);try{util.storage.setItem("localSettings","{}")}catch(err2){g.reportError(err2)}this._localWriteError=!0}},_ensureRemoteSettings:function _ensureRemoteSettingsFn(){this._remoteRequested||this._remoteLoaded||g.vmMain&&g.vmMain.realtimeDocManager&&(this._remoteRequested=!0,g.vmMain.realtimeDocManager.registerForReadyNotification(DocType.GAppData,function(){this._remoteSettings=g.vmMain.realtimeDocManager.createDocument(DocType.GAppData,"RemoteSettings"),this._remoteSettings.open("RemoteSettings",this._onRemoteLoad.bind(this),this._onRemoteInit.bind(this),this._onRemoteError.bind(this))}.bind(this)))},_getRemoteEntry:function _getRemoteEntryFn(key,groupID){if(this._remoteLoaded){var model=this._remoteSettings.getModel(),settingsRoot=model.getRoot().get("settings"),group=settingsRoot.get(groupID);if(group){var entry=group.get(key);return entry}}return void 0},_getRemoteValue:function _getRemoteValueFn(key,groupID){var entry=this._getRemoteEntry(key,groupID);return entry?entry.value:void 0},_getRemoteVersion:function _getRemoteVersionFn(key,groupID){var entry=this._getRemoteEntry(key,groupID);return entry?entry.ver:UnsetVersion},_setRemoteValue:function _setRemoteValueFn(key,value,version,groupID){if(groupID=groupID||DefaultGroup,this._remoteLoaded){var model=this._remoteSettings.getModel(),settingsRoot=model.getRoot().get("settings"),group=settingsRoot.get(groupID);group||(group=model.createMap(),settingsRoot.set(groupID,group)),group.set(key,{value:value,ver:version})}},_sendChangeNotification:function _sendChangeNotificationFn(groupID,key,oldValue,newValue,changeType){this.fireEvent("settingChanged",groupID,key,[oldValue,newValue]);for(var i=0;i<this._changeListeners.length;++i){var listener=this._changeListeners[i];if(groupID===listener.groupID&&key===listener.key)try{listener.fn(oldValue,newValue)}catch(err){g.reportError(err)}}g.isLocalChange(changeType)&&this._shouldNotifyAPIServer(groupID,key)&&this._notifyAPISever(groupID,key,newValue)},_findGroupForMap:function _findGroupForMapFn(settingsMap,groupMap){for(var items=settingsMap.items(),i=0;i<items.length;++i)if(items[i][RemoteValue]===groupMap)return items[i][RemoteKey];return void 0},_onRemoteSettingsChange:function _onRemoteSettingsChangeFn(change){for(var i=0;i<change.events.length;++i){var ev=change.events[i];if(!ev.isLocal){var groupID=this._findGroupForMap(change.currentTarget,ev.target);groupID&&ev.newValue&&this._remoteSettingLoaded(ev.property,ev.newValue.value,ev.newValue.ver,groupID)}}},_remoteSettingLoaded:function _remoteSettingLoadedFn(key,remoteValue,remoteVersion,groupID){try{g.PAssert(3970,groupID,"Must specify a valid groupID at this point")}catch(PERR){g.reportError(PERR)}this._versions[groupID]||this.registerGroup(groupID),this._versions[groupID][key]||this.registerSetting(key,groupID,!0);var localValue=this._values[groupID][key],localVersion=this._versions[groupID][key].version;if(remoteVersion>localVersion)this._values[groupID][key]=remoteValue,this._versions[groupID][key].version=remoteVersion,this._sendChangeNotification(groupID,key,localValue,remoteValue,ChangeType.Remote);else if(localVersion>remoteVersion)this._setRemoteValue(key,localValue,localVersion,groupID),this._shouldNotifyAPIServer(groupID,key)&&this._notifyAPISever(groupID,key,localValue);else if(remoteVersion===localVersion)if(g.isArray(localValue)){try{g.PAssert(3971,g.isArray(remoteValue),"Must both be arrays or neither arrays")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3972,localValue.equals(remoteValue),"Arrays must match")}catch(PERR){g.reportError(PERR)}}else try{g.PAssert(3973,localValue===remoteValue,"Should match if the versions are the same: "+key+" - "+groupID)}catch(PERR){g.reportError(PERR)}else try{g.PAssert(3974,!1,"What - remote and local versions are messed up",remoteVersion,localVersion)}catch(PERR){g.reportError(PERR)}},_onRemoteLoad:function _onRemoteLoadFn(doc){try{g.PAssert(3975,this._localLoaded,"Local settings must be loaded before remote")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3976,this._remoteRequested,"Remote document must have been requested")}catch(PERR){g.reportError(PERR)}this._remoteLoaded=!0;var updatedLocal=!1,updatedRemote=!1,model=doc.getModel();model.beginCompoundOperation("Sync Settings",!1);var root=model.getRoot(),settings=root.get("settings"),info=root.get("info");try{for(var groups=settings.items(),i=0;i<groups.length;++i)for(var groupID=groups[i][RemoteKey],group=groups[i][RemoteValue],props=group.items(),j=0;j<props.length;++j){var propID=props[j][RemoteKey],prop=props[j][RemoteValue],pValue=prop.value,pVersion=prop.ver;updatedLocal=updatedLocal||this._remoteSettingLoaded(propID,pValue,pVersion,groupID)}for(var groupID in this._versions){var group=this._versions[groupID];for(var propID in group)if(this._versions[groupID][propID].syncRemote&&this._versions[groupID][propID].version!==UnsetVersion){var remoteGroup=settings.get(groupID);remoteGroup||(remoteGroup=model.createMap(),settings.set(groupID,remoteGroup));var remoteProp=remoteGroup.get(propID);remoteProp||(remoteProp={value:this._values[groupID][propID],ver:this._versions[groupID][propID].version},remoteGroup.set(propID,remoteProp),updatedRemote=!0)}}}catch(err){g.reportError(err)}model.endCompoundOperation(),settings.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,this._onRemoteSettingsChange.bind(this)),updatedLocal&&this._writeLocalSettings()},_onRemoteError:function _onRemoteErrorFn(err){try{g.PAssert(3977,this._localLoaded,"Local settings must be loaded before remote")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3978,this._remoteRequested,"Remote document must have been requested")}catch(PERR){g.reportError(PERR)}this._remoteLoaded=!1,this._remoteLoadError=!0},_onRemoteInit:function _onRemoteInitFn(model){try{g.PAssert(3979,this._localLoaded,"Local settings must be loaded before remote")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3980,this._remoteRequested,"Remote document must have been requested")}catch(PERR){g.reportError(PERR)}var root=model.getRoot(),settings=model.createMap(),info=model.createMap();info.set("settingsVer",1),root.set("settings",settings),root.set("info",info)},_shouldNotifyAPIServer:function _shouldNotifyAPIServerFn(groupID,key){return this._apiNotifications[groupID]&&this._apiNotifications[groupID][key]},_notifyAPISever:function _notifyAPISeverFn(groupID,key,value){g.billingManager.onBillingIdentifierAvailable(function(){g.XHR_PrivateAPI({type:"POST",path:"/user/settings/set",data:{email:g.billingManager.getBillingIdentifier(),groupID:groupID,key:key,value:value},requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){200!==xhr.status&&g.reportError(new Error("Unable to notify API server of remote setting: "+xhr.status+" "+groupID+" "+key+" "+value))}})})},getRawSettings:function getRawSettingsFn(){var rawSettings;if(g.shouldWriteLocal())try{rawSettings=util.storage.getItem("localSettings")}catch(err){g.reportError(err)}else try{return JSON.stringify(this._serializeSettings())}catch(err){return g.reportError(err),'{m:"Invalid Settings"}'}return rawSettings},_dumpSettings:function _dumpSettingsFn(){log("---- Settings ----"),log("Versions: ",this._versions),log("Values: ",this._values)}},util.defineBase(SettingsManager),util.extend(SettingsManager.prototype,EventDispatcher),g.settings=new SettingsManager,g.settings}),define("copypaste",["globals","platform","data","android","edit","VMLI","tracker","parse","NativeSel","Sel"],function(g,platform,d,android,edit,VMLI,tracker,parse,NativeSel,Sel){function copypaste(){}return copypaste.prototype={init:function initFn(){try{g.PAssert(3981,"complete"===document.readyState||"interactive"===document.readyState,"Setting up copy/paste too early")}catch(PERR){g.reportError(PERR)}document.body.addEventListener("paste",this.handlepaste.bind(this),!1),document.body.addEventListener("cut",this.handlecut.bind(this),!1),document.body.addEventListener("copy",this.handlecopy.bind(this),!1)},killEvent:function killEventFn(e){try{g.PAssert(3982,e.preventDefault,"Should always be defined")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3983,e.stopPropagation,"Should always be defined")}catch(PERR){g.reportError(PERR)}e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},insertToNote:function insertToNoteFn(startItem,endItem,text){try{g.PAssert(3984,startItem,"Must have a valid start item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3985,endItem,"Must have a valid end item")}catch(PERR){g.reportError(PERR)}var itemText=startItem.getParsedText();tracker.beginAction();var newText;newText=endItem===startItem?itemText.substring(0,Sel.getStartOffset())+text+itemText.substring(Sel.getEndOffset()):itemText.substring(0,Sel.getStartOffset())+text,startItem.setText(newText,!0,ChangeType.Local),tracker.endAction()},insert:function insertFn(data,e,source){if(!Sel.isValid()||g.elementInNonPaneEdit(e.target))return!1;var clipboardBuffer="",dataTypeText=platform.ie?"Text":"text/plain",lastItem,selOffset,traversed;if(source===DataSource.Plugin)traversed={items:[{text:data}]};else if(data&&data.getData){if(tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Paste}),this.killEvent(e),clipboardBuffer=platform.ie?void 0:data.getData("moodo/html")||data.getData("text/html"),!platform.ie&&clipboardBuffer){if(!clipboardBuffer)return;var node=document.createElement("div"),replacedText=clipboardBuffer.replace(/[\n\t]/g," ").replace(/[\r]|<head(.|\s)*?\/head>|<script(.|\s)*?\/script>|<style(.|\s)*?\/style>/g,"").replace(/[ ]+/g," ").replace(/onload/gi,"never"),bodyRegex=/<body(.|\s)*?\/body>/g,bodyMatch;(bodyMatch=bodyRegex.exec(replacedText))&&(replacedText=bodyMatch[0]),node.innerHTML=replacedText,Sel.isValid()&&Sel.getStartItem().isNote()?this.insertToNote(Sel.getStartItem(),Sel.getEndItem(),node.innerText):(traversed=parse.traverseDOM({root:node,shouldPrint:!1,stripParents:!0}),1===traversed.items.length&&""===traversed.items[0].text&&(traversed=traversed.items[0]))}else if(clipboardBuffer=data.getData(dataTypeText)){var isXML=clipboardBuffer.startsWith("<?xml "),isOPML=clipboardBuffer.startsWith("<?opml "),xml;if((isXML||isOPML)&&(xml=g.loadXML(clipboardBuffer)),xml){if(isXML)return g.toasts.pushMessage({text:"We currently do not support pasting XML. If you need to import XML please tell us",action:MessageAction.Contact,hold:!0}),!1;if(isOPML)return parse.parseOPML(xml,"OPML Import"),!1}else{if(clipboardBuffer.startsWith("{")&&clipboardBuffer.endsWith("}"))try{var jsonData=JSON.parse(clipboardBuffer),res=parse.parseJSON(jsonData,Sel.getStartItem().parent());if(res)return!1}catch(err){}var replacedText=clipboardBuffer.replace(/[\t]/g," ");if(Sel.getStartItem().isNote())this.insertToNote(Sel.getStartItem(),Sel.getEndItem(),replacedText);else{var traversedText=replacedText.split("\n");traversed={items:[]};for(var i=0;i<traversedText.length;i++)if(0!==traversedText[i].length){var str=g.trimString(traversedText[i].replace(/[\ud800-\udfff]+/g,""));traversed.items.push({text:str,parent:traversed})}}}}else try{g.PAssert(3986,!1,"Paste with unexpected data type",data.types)}catch(PERR){g.reportError(PERR)}if(!traversed||!traversed.items||0===traversed.items.length)return!1}if(traversed){tracker.beginAction(),g.vmMain.beginUpdateItems();var ok=!0,itemStart=Sel.getStartItem(),itemEnd=Sel.getEndItem(),itemParent=Sel.getStartItem().parent(),itemIndex=Sel.getStartItem().getIndex(),sText=Sel.getStartItem().getParsedText(),eText=Sel.getEndItem().getParsedText();if(itemStart!==itemEnd&&(itemEnd.isNote()&&(itemEnd=itemEnd.parent()),itemStart!==itemEnd&&edit.handleMultiselect({normCode:KeyCode.BackSpace,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn})),lastItem=itemStart,1!==traversed.items.length||traversed.items[0].items)if(g.focusedPane.type===PaneMode.Timeline)g.toasts.pushMessage({text:"Pasting multiple items into the agenda is not supported. Please try pasting into an Outline pane.",actionText:"OKAY"}),ok=!1;else{ShouldLog(LogLevels.Timing)&&console.time("paste");var mutations=[],allowFirstItemSplit=!itemStart.hasChildren()&&Sel.getStartOffset()>0&&Sel.getEndOffset()<eText.length;!allowFirstItemSplit&&Sel.getStartOffset()>0&&itemIndex++;for(var i=0;traversed&&i<traversed.items.length;++i){var itemInfo=traversed.items[i];if(""!==itemInfo.text||itemInfo.items)if(0===i&&allowFirstItemSplit){if(itemInfo.text=sText.substring(0,Sel.getStartOffset())+itemInfo.text,itemStart.setText(itemInfo.text,!0,ChangeType.Local),tracker.performAction(TrackerType.Insert,{itemID:itemStart.id,position:0,text:itemInfo.text}),itemIndex++,itemInfo.items){for(var u=0;u<itemInfo.items.length;++u){var child=itemInfo.items[u];if(""!==child.text||child.items){var newItem=d.createVMLI(child,{parent:itemStart,changeType:ChangeType.AllLocal});itemStart.insertItem(newItem),lastItem=newItem}}mutations.indexOf(itemStart)<0&&mutations.push(itemStart)}}else{var newItem=d.createVMLI(itemInfo,{parent:itemParent,changeType:ChangeType.AllLocal});itemParent.insertItem(newItem,itemIndex++,!0),lastItem=newItem,mutations.indexOf(itemParent)<0&&mutations.push(itemParent),tracker.performAction(TrackerType.Create,{itemID:newItem.id,parent:itemParent.id,position:itemIndex-1,text:newItem.getParsedText()})}}for(;lastItem.hasChildren();)lastItem=lastItem.getLastChild();selOffset=lastItem.getParsedText().length,allowFirstItemSplit&&lastItem.setText(lastItem.getParsedText()+eText.substring(Sel.getEndOffset().endText),!0,ChangeType.Local)}else{var iText=traversed.items[0].text,str=sText.substring(0,Sel.getStartOffset())+iText+eText.substring(Sel.getEndOffset());tracker.performAction(TrackerType.Remove,{itemID:itemStart.id,position:0,text:itemStart.getParsedText()}),itemStart.setText(str,!0,ChangeType.Local),tracker.performAction(TrackerType.Insert,{itemID:itemStart.id,position:0,text:str}),selOffset=Sel.getStartOffset()+iText.length}g.vmMain.commitUpdateItems(),tracker.endAction(),ShouldLog(LogLevels.Timing)&&console.timeEnd("paste")}return ok&&lastItem&&(Sel.selectItem(lastItem,selOffset),g.focusedPane.scrollItemIntoView(lastItem,ScrollDuration.Snap)),!1},handlepaste:function handlepasteFn(e){if(e.srcElement||(e.srcElement=e.target),!e.synthetic&&android.isEnabled())return android.handlePaste(),!0;var clipData=e&&e.clipboardData?e.clipboardData:e.synthetic?e.data:window.clipboardData;return this.insert(clipData,e,DataSource.Paste)},handlecut:function handlecutFn(e){var copySuccess=!this.handlecopy(e);return copySuccess?(edit.keydown(void 0,{normCode:KeyCode.BackSpace,preventDefault:g.emptyFn,stopPropagation:g.emptyFn,stopImmediatePropagation:g.emptyFn}),!1):!0},padText:function padTextFn(text,deep){for(var i=0;deep>i;++i)text="    "+text;return text},printLI:function printLIFn(item,startOffset,endOffset){var text,moodoText;if(text=isNaN(startOffset)||isNaN(endOffset)?isNaN(startOffset)?isNaN(endOffset)?item.getParsedText():item.getParsedText().substring(0,endOffset):item.getParsedText().substring(startOffset):item.getParsedText().substr(startOffset,endOffset-startOffset),item.hasAttachments()){var attachOffset=0;if(!isNaN(startOffset)&&startOffset>0)for(var rawText=item.getParsedText(),i=0;startOffset>i;++i)rawText[i]===window.AttachChar&&attachOffset++;moodoText=item.generateSaveText(text,attachOffset)}else moodoText=text;var cls=[],pri=item.priority();pri&&(pri===VMLIFlag.P0?cls.push("high"):pri===VMLIFlag.P1?cls.push("medium"):pri===VMLIFlag.P2&&cls.push("low")),item.isComplete()&&cls.push("complete"),item.isStarred()&&cls.push("starred");var html="<li"+(cls.length>0?' class="'+cls.join(" ")+'"':"")+">"+text+"</li>",plain=text,moodo="<li"+(cls.length>0?' class="'+cls.join(" ")+'"':"")+">"+moodoText+"</li>";return{html:html,plain:text,moodo:moodo}},handlecopy:function handlecopyFn(e){if(!android.isEnabled()){var pane=g.focusedPane,dataType=platform.ie?"Text":"text/plain",clipData=e&&e.clipboardData?e.clipboardData:window.clipboardData;if(clipData){e.srcElement||(e.srcElement=e.target);var exportedArea=g.findParent(e.srcElement,"exportedArea",10);if(!platform.mobile&&exportedArea)return!0;if(!Sel.isValid())return!0;if(!Sel.getPane().overrideCopyBehavior)return!0;var item=Sel.getStartItem(),index=Sel.getStartIndex(),endItem=Sel.getEndItem(),endIndex=Sel.getEndIndex();try{g.PAssert(3987,item&&endItem,"Must have valid item selections")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3988,item instanceof VMLI&&endItem instanceof VMLI,"Items must be valid VMLIs")}catch(PERR){g.reportError(PERR)}var createHTML=!platform.ie,html,plain,moodo,text;if(item===endItem)text=Sel.getStartOffset()===Sel.getEndOffset()?this.printLI(item):this.printLI(item,Sel.getStartOffset(),Sel.getEndOffset()),html=text.html,plain=text.plain,moodo=text.moodo;else{var deep=0;text=this.printLI(item,Sel.getStartOffset()),deep++,html="<ul>"+text.html,plain=text.plain,moodo="<ul>"+text.moodo;do{var prevItem=item;if(index=pane.indexOfNextVMLI(index),item=pane.itemAtIndex(index)){if(pane.type!==PaneMode.Timeline){var levelDiff=item.levelsDeep.get()-prevItem.levelsDeep.get();levelDiff>0&&(html+="<ul>",moodo+="<ul>",deep++);for(var i=0;-levelDiff>i;i++)html+="</ul>",moodo+="</ul>",deep--;0>=deep&&(html+="<ul>",moodo+="<ul>",deep++)}index!==endIndex?(text=this.printLI(item),html+=text.html,moodo+=text.moodo):(text=this.printLI(item,0,Sel.getEndOffset()),html+=text.html+"</ul>",moodo+=text.moodo+"</ul>",deep--)}plain+="\r\n"+this.padText(text.plain,deep-1)}while(index!==endIndex);for(;deep>0;)html+="</ul>",moodo+="</ul>",deep--}createHTML&&html&&clipData.setData("text/html",html),createHTML&&moodo&&clipData.setData("moodo/html",moodo),clipData.setData(dataType,plain)}return platform.ios||this.killEvent(e),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Copy}),!1}}},new copypaste}),define("InfiniteListCell",["require","Observable","Trigger"],function(require){function InfiniteListCell(){this.isLive=!1,this.wasLive=!1,this.seenInPass=!1,this.deadNeedsNotify=!1,this.index=-1,this.width=0,this.height=0,this.offset=0,this.paneObject=void 0,this.cellChanged=new Trigger,this.offsetX=new Observable(0),this.isAnimatingOffsetX=!1}var Observable=require("Observable"),Trigger=require("Trigger");return InfiniteListCell.prototype={kill:function killFn(notify){this.isLive=!1,this.index=-1,this.isAnimatingOffsetX=!1,notify?(this.deadNeedsNotify=!1,this.cellChanged.notify()):this.deadNeedsNotify=!0},update:function updateFn(index,width,height,offset,prevOffset,paneObject){this.seenInPass=!0,this.wasLive=this.isLive,this.deadNeedsNotify=!1,this.isAnimatingOffsetX=!1,this.isLive&&index===this.index&&width===this.width&&height===this.height&&offset===this.offset&&paneObject===this.paneObject||(this.isLive=!0,this.index=index,this.width=width,this.height=height,this.paneObject=paneObject,this.offset=offset,this.prevOffset=prevOffset,this.cellChanged.notify())},getState:function getStateFn(){return{item:this.paneObject&&this.paneObject.id,index:this.index,height:this.height,offset:this.offset,prevOffset:this.prevOffset,deadNeedsNotify:this.deadNeedsNotify,isLive:this.isLive}}},InfiniteListCell}),define("InfiniteList",["globals","Constants","util","platform","Observable","ObservableArray","Sel","DragDrop","react","Dispatcher","NativeSel","InfiniteListCell","react-dom","DisplaySettings"],function(g,C,util,platform,Observable,ObservableArray,Sel,DragDrop,React,Dispatcher,NativeSel,InfiniteListCell,ReactDOM,DisplaySettings){function InfiniteList(p){this._pane=p.pane,this._isOverview=p.isOverview,this._itemsObs=p.itemsObs,this._getItemsList=p.itemsFn,this.getHeight=p.heightFn,this.itemsAreObjects=p.itemsAreObjects,this.hasSetHeightOnce=!1,this.scrollHandler=void 0,this.contentHeight=new Observable(0),this._timeoutPointerEvents=0,this.disablePointerEvents=new Observable(!1),this._direction=Direction.None,this._scrollTop=0,this._lastProcessedScrollTop=0,this._itemInfoById={},this._savedScrollOfTop={},this._indexOfTop=0,this._inViewCount=0,this._reactList=void 0,this._isMounted=!1,this._panePadding=0,this.useCustomScroller=platform.android||platform.ios,this.cellsObs=new ObservableArray([]),this.cells=this.cellsObs.get(),this.cellsNew=[],this.offscreenScrollPadding=400,this._phase=Phase.None,this.init()}var _disableHeightChanged=!1,logTimes=[],paneContentPadding=500,Phase={None:0,OnScroll:1};return InfiniteList.prototype={init:function initFn(){util.forceBind("_onListChanged",this),util.forceBind("_onSettingChanged",this),util.forceBind("_onResize",this),util.forceBind("_onScroll",this),util.forceBind("_onWheel",this),util.forceBind("_handleScroll",this),util.forceBind("handleItemTextChanged",this),util.forceBind("handleItemBoldChanged",this),util.forceBind("handleItemNoteSet",this),util.forceBind("_onTimeoutPointerEvents",this),util.forceBind("_computeRenderItemsBatched",this),util.forceBind("_onTimeoutSeenWheel",this),util.forceBind("_onSetScrollComplete",this),util.forceBind("_onSetScrollCompleteTimeout",this),util.forceBind("_afterSetScrollComplete",this)},getID:function getIDFn(){return this._pane.id+(this._isOverview?"_o":"")},notifyInit:function notifyInitFn(reactInfiniteList){this.allocateCells(),this._onListChanged(),this._isMounted=!0,this._reactList=reactInfiniteList,this._listenToItemsList(this._onListChanged),this._pane.rect.listen(this._onResize),this._pane.topBoxHeight.listen(this._onListChanged),g.settings.listen("settingChanged",Settings.UISettingsGroup,this._onSettingChanged)},notifyUnmounted:function notifyUnmountedFn(){util.destroy(this),this._isMounted=!1,this._unlistenToItemsList(this._onListChanged),this._pane.rect.unlisten(this._onResize),this._pane.topBoxHeight.unlisten(this._onListChanged),g.settings.unlisten("settingChanged",Settings.UISettingsGroup,this._onSettingChanged),this.removeScrollListener(this._onScroll,this._onWheel),this._reactList=void 0,this.useCustomScroller&&(this.iScroller.destroy(),this.iScroller=void 0),platform.mobile||this._isOverview||(this._pane=void 0)},allocateCells:function allocateCellsFn(){var DS=DisplaySettings,currentNumCells=this.cells.length,numCells=Math.ceil((platform.windowHeight()+2*this.offscreenScrollPadding)/(DS.itemLineHeight()+2*DS.itemPadding()))+4;if(numCells>currentNumCells){log("Allocating cells",numCells,currentNumCells,platform.windowHeight(),DS.itemLineHeight(),DS.itemPadding(),this._isOverview);for(var arr=this.cells,i=currentNumCells;numCells>i;i++){var cell=new InfiniteListCell;arr.push(cell)}this.cellsObs.set(arr),this.cells=this.cellsObs.get()}},setupScroller:function setupScrollerFn(scrollElement,contentElement){this.scrollElement=scrollElement,this.useCustomScroller&&this.setupCustomScroller(scrollElement,contentElement),this.addScrollListener(this._onScroll,this._onWheel),this.useCustomScroller&&setTimeout(this.refreshScrollListener.bind(this))},setupCustomScroller:function setupCustomScrollerFn(scrollElement,contentElement){var rangeStart;this.iScroller=g.createCustomScroller(scrollElement),this.iScroller.on("scrollStart",function(){platform.ios&&(rangeStart=g.isKeyboardOpen?NativeSel.getSelectionRange(!0):null,g.addClass(contentElement,"preventSelect"))}.bind(this)),this.iScroller.on("scrollEnd",function(){log("Custom Scroll End!"),this._onSetScrollComplete(),platform.ios&&(!rangeStart&&g.isKeyboardOpen&&(rangeStart=NativeSel.getSelectionRange(!0)),setTimeout(function(){g.removeClass(contentElement,"preventSelect"),rangeStart&&(NativeSel.setSelectionRange(rangeStart),rangeStart=null)},0))}.bind(this))},clearItemInfoForItem:function clearItemInfoForItemFn(item){var infos=this._itemInfoById;if(this.itemsAreObjects)for(var key in this._itemInfoById)infos.hasOwnProperty(key)&&infos[key].paneObject.item===item&&delete infos[key];else delete infos[item.id]},handleItemNoteSet:function handleItemNoteSetFn(e){this.clearItemInfoForItem(e.item)},handleItemBoldChanged:function handleItemBoldChangedFn(e){var overview=this._isOverview,pane=this._pane,item=e.item,field=overview?PerPaneStateField.NumLinesOverview:PerPaneStateField.NumLines;this.clearItemInfoForItem(item),pane.setPerPaneState(item.id,field,void 0)},handleItemTextChanged:function handleItemTextChangedFn(e){var overview=this._isOverview,pane=this._pane,item=e.item,field=overview?PerPaneStateField.NumLinesOverview:PerPaneStateField.NumLines,lines=item.metricsInPane(pane,overview).styledLines,numLines=pane.getPerPaneState(item.id,field);
(isNaN(numLines)||numLines!==lines.length)&&(this.clearItemInfoForItem(item),pane.setPerPaneState(item.id,field,lines.length),pane.updateItems(!1,!0))},getElementAtIndex:function getElementAtIndexFn(index){return this._reactList.getElementAtIndex(index)},isIndexMounted:function isIndexMountedFn(index){return this._reactList.isIndexMounted(index)},hasItems:function hasItemsFn(){return this._getItemsList().length>0},numItems:function numItemsFn(){return this._getItemsList().length},indexOfTop:function indexOfTopFn(){return this._indexOfTop},inViewCount:function inViewCountFn(){return this._inViewCount},itemAtTop:function itemAtTopFn(){var items=this._getItemsList(),top=this.indexOfTop(),isValid=top>=0&&top<items.length;try{g.PAssert(3989,isValid,"Item at top is not in range",top,items.length)}catch(PERR){g.reportError(PERR)}var obj=items[top];return obj&&(g.isVMLI(obj)?obj:obj.item)},indexPageUp:function indexPageUpFn(index){for(var pageHeight=this.size.height,diff=0,i=index-1;i>=0;--i){var height=this._heights[i];if(diff+=height,diff>pageHeight)return i+1}return 0},indexPageDown:function indexPageDownFn(index){for(var pageHeight=this.size.height,diff=0,num=this._heights.length,i=index;num>i;++i){var height=this._heights[i];if(diff+=height,diff>pageHeight)return i}return Math.max(num-1,0)},_listenToItemsList:function _listenToItemsListFn(cb){this._itemsObs.listen(cb)},_unlistenToItemsList:function _unlistenToItemsListFn(cb){this._itemsObs.unlisten(cb)},objectAtIndex:function objectAtIndexFn(index){var items=this._getItemsList();try{g.PAssert(3990,index>=0&&index<items.length,"Invalid item index: "+index)}catch(PERR){g.reportError(PERR)}return items[index]},itemAtIndex:function itemAtIndexFn(index){var items=this._getItemsList();try{g.PAssert(3991,index>=0&&index<items.length,"Invalid item index: "+index)}catch(PERR){g.reportError(PERR)}var obj=items[index];return obj&&(g.isVMLI(obj)?obj:obj.item)},heightAtIndex:function heightAtIndexFn(index){return this._pane.heightAtIndex(index,this._isOverview)},addPadding:function addPaddingFn(){this.useCustomScroller&&(this._panePadding=platform.windowHeight()-2*g.topBarHeight,this.refreshScrollListener())},removePadding:function removePaddingFn(){if(this.useCustomScroller){var s=this.iScroller;this._panePadding=0,this.refreshScrollListener(),s&&s.y<s.maxScrollY&&this.iScroller.scrollTo(0,s.maxScrollY,200)}},addScrollListener:function addScrollListenerFn(cbScroll,cbWheel){this.useCustomScroller?this.iScroller.on("scroll",cbScroll):(this.scrollElement.addEventListener("scroll",cbScroll),platform.mac&&cbWheel&&this.scrollElement.addEventListener("wheel",cbWheel))},removeScrollListener:function removeScrollListenerFn(cbScroll,cbWheel){this.useCustomScroller?this.iScroller.off("scroll",cbScroll):(this.scrollElement.removeEventListener("scroll",cbScroll),platform.mac&&cbWheel&&this.scrollElement.removeEventListener("wheel",cbWheel))},refreshScrollListener:function refreshScrollListenerFn(){if(this.useCustomScroller&&this.iScroller){var height=this.contentHeight.get();this.iScroller.manualRefresh(height+this._panePadding)}},getScrollOffset:function getScrollOffsetFn(){return this._isMounted?this.useCustomScroller?this.iScroller?-this.iScroller.y:0:this.scrollElement.scrollTop:0},getScrollHeight:function getScrollHeightFn(){return Math.max(this.contentHeight.get()+(platform.mobile||g.noPanePadding?0:paneContentPadding),0)},getMaxScrollOffset:function getMaxScrollOffsetFn(){return Math.max(this.getScrollHeight()-this.getHeight(),0)},setScrollOffset:function setScrollOffsetFn(offset,duration,cb){try{g.PAssert(3992,this.scrollElement,"Pane must have loaded a scrollable element")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3993,g.isNumber(offset),"Must supply a valid scroll offset")}catch(PERR){g.reportError(PERR)}duration=duration||ScrollDuration.Snap;var startOffset=this.getScrollOffset(),maxScrollY=this.getMaxScrollOffset();return platform.mobile&&(maxScrollY+=platform.getKBSize()+g.keyboardToolbarHeight),0>offset?offset=0:platform.mobile&&offset>maxScrollY&&(offset=maxScrollY),this._isMounted&&this._scrollingTo!==offset?(this._scrollingTo=duration?offset:void 0,this._isSettingScroll=!0,this.useCustomScroller?(this.iScroller.scrollTo(0,-offset,duration),duration||this.iScroller._execEvent("scroll"),cb&&(duration?setTimeout(cb,duration):cb())):g.scrollTo(void 0,offset,duration,this.scrollElement,function(){this._onSetScrollComplete(),cb&&cb()}.bind(this))):cb&&(cb(),g.timeoutOnce("setScrollComplete_"+this.getID(),this._onSetScrollComplete,0)),offset-startOffset},_onSetScrollComplete:function _onSetScrollCompleteFn(){this._restoringScroll?this._afterSetScrollComplete():g.timeoutOnce("scrollCompleteTimeout_"+this.getID(),this._onSetScrollCompleteTimeout,60)},_onSetScrollCompleteTimeout:function _onSetScrollCompleteTimeoutFn(){this._isMounted&&this.saveScrollOfTop(!0),this._afterSetScrollComplete()},_afterSetScrollComplete:function _afterSetScrollCompleteFn(){this._scrollingTo=void 0,this._isSettingScroll=!1},_computeContentHeight:function _computeContentHeightFn(notify){var paddingTop=this.getPaddingTop(),contentHeight=paddingTop;this._heights=[],this._tops=[];for(var items=this._getItemsList(),rootDepth=this._pane.getItem().levelsDeep.get(),i=0;i<items.length;++i){var item=items[i],isVMLI=g.isVMLI(item),itemInfo=this._itemInfoById[item.id],levelsDeep=isVMLI&&item.levelsDeep.get()-rootDepth,height;!itemInfo||isVMLI&&itemInfo.levelsDeep!==levelsDeep?(height=this.heightAtIndex(i),itemInfo=this._itemInfoById[item.id]={height:height,levelsDeep:levelsDeep,paneObject:item}):height=itemInfo.height,this._heights[i]=height,this._tops[i]=i>0?this._tops[i-1]+this._heights[i-1]:paddingTop,itemInfo.previousTop=itemInfo.top,itemInfo.top=this._tops[i],contentHeight+=itemInfo.height}return platform.mobile&&(contentHeight+=2*g.minItemHeight),this.contentHeight.set(contentHeight,notify),this.useCustomScroller&&this.refreshScrollListener(),contentHeight},_onTimeoutPointerEvents:function _onTimeoutPointerEventsFn(){this.disablePointerEvents.set(!1),this.killAllDeadCells(),this._isSettingScroll||this._wasSettingScroll||this.saveScrollOfTop(),this._scrollingTo=void 0,this._wasSettingScroll=!1},_onTimeoutSeenWheel:function _onTimeoutSeenWheelFn(){this._hasSeenWheel=!1,this._timeoutSeenWheel=0,this._onScroll()},_onWheel:function _onWheelFn(e){0!==e.deltaY&&(this._hasSeenWheel=!0,this._timeoutSeenWheel&&clearTimeout(this._timeoutSeenWheel),this._timeoutSeenWheel=setTimeout(this._onTimeoutSeenWheel,50),this._wheelAnimFrame||(this._prevScrollTop=this._scrollTop,this._wheelAnimFrame=requestAnimationFrame(this._handleScroll)),this._scrollTop=Math.min(Math.max(this._scrollTop+e.deltaY,0),this.getMaxScrollOffset()))},_onScroll:function _onScrollFn(e){this._hasSeenWheel||this._restoringScroll||(this._prevScrollTop=this._scrollTop,this._scrollTop=this.getScrollOffset(),this._handleScroll())},_handleScroll:function _handleScrollFn(){if(this._wheelAnimFrame=0,this._phase=Phase.OnScroll,platform.mobile||Sel.isMouseDown()||(this.disablePointerEvents.set(!0),this._timeoutPointerEvents&&clearTimeout(this._timeoutPointerEvents),this._wasSettingScroll=this._isSettingScroll,this._timeoutPointerEvents=setTimeout(this._onTimeoutPointerEvents,150),0===this._scrollTop&&0!==this._prevScrollTop&&this.saveScrollOfTop()),platform.mobile||g.tooltip.hideTip(),Sel.hoveredItem&&Sel.setHovered(this,null,null),this._scrollTop!==this._prevScrollTop){this._direction=this._scrollTop>this._prevScrollTop?Direction.Down:Direction.Up;var scrollDiff=Math.abs(this._scrollTop-this._lastProcessedScrollTop);if(scrollDiff>=this.offscreenScrollPadding/2){this._lastProcessedScrollTop=this._scrollTop;var start;this._computeRenderItems();var end,total,amt,i}else this.updateTopIndex()}this.scrollHandler&&this.scrollHandler(this._scrollTop),this._phase=Phase.None},_updateSize:function _updateSizeFn(){this.size={width:this._pane.getWidth(),height:this._pane.getHeight()}},_onListChanged:function _onListChangedFn(){return this._needsResize?(this._needsResize=!1,void this._onResize(void 0,void 0,!0)):(this.rect=this._pane.rect.get(),this._updateSize(),_disableHeightChanged=!0,this.killAllDeadCells(),this._computeContentHeight(!1),this._isMounted&&this._timeoutSeenWheel&&(clearTimeout(this._timeoutSeenWheel),this._onTimeoutSeenWheel()),this._computeRenderItems(this._isMounted),void(_disableHeightChanged=!1))},_onSettingChanged:function _onSettingChangedFn(value){this._needsResize=!0,g.timeoutOnce("listSettingChanged_"+this.getID(),this._onResize,0,void 0,void 0,!0)},_onResize:function _onResizeFn(value,oldValue,force){g.clearTimeoutOnce("listSettingChanged_"+this.getID()),this._needsResize=!1;var rectWidth=this.rect?this.rect.width:-1,rectHeight=this.rect?this.rect.height:-1;force||value&&(value.width!==rectWidth||value.height!==rectHeight)?(this._updateSize(),this.clearCache(),this.allocateCells(),g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),this._onListChanged(),g.vmMain.resetItemAnimationMode(),Sel.getPane()===this._pane&&Sel.updateCaret()):this._updateSize()},saveScrollOfTop:function saveScrollOfTopFn(getNativeScrollTop){var savedScroll=this._savedScrollOfTop;if(this.numItems()>0){for(var saved=[],numItems=this.numItems(),scroll=getNativeScrollTop?this.getScrollOffset():this._scrollTop,obj,scrollOffset,i=this._indexOfTop;i<Math.min(this._indexOfTop+this._inViewCount-1,numItems);i++){obj=this.objectAtIndex(i),scrollOffset=scroll-this.topOfIndex(i);var height=this._heights[i];scrollOffset-height<-this.getPaddingTop()&&saved.push({index:i,paneObject:obj,scrollOffset:scrollOffset})}this._savedScrollOfTop.inView=saved}},restoreScrollOfTop:function restoreScrollOfTopFn(){var savedScroll=this._savedScrollOfTop;if(!this._pane.isIgnoringRestoreScroll()){if(savedScroll){var inView=savedScroll.inView,found=!1;if(!found&&inView)for(var i=0;i<inView.length;i++){var obj=inView[i];if(this.restoreScroll(obj))break}}this._restoringScroll||this.setScrollOffset(0,ScrollDuration.Snap),this._restoringScroll=!1}},restoreScroll:function restoreScrollFn(obj){var index=this.indexOfItem(obj.paneObject);if(index>=0){var top=Math.max(this.topOfIndex(index)+(obj.scrollOffset||0),0),maxScrollY=this.getMaxScrollOffset();return top>maxScrollY&&(top=maxScrollY),this._restoringScroll=!0,this.setScrollOffset(top,ScrollDuration.Snap),g.animFrameOnce("restoreScroll_"+this.getID(),function(){this.setScrollOffset(top,ScrollDuration.Snap)}.bind(this)),!0}return!1},clearCache:function clearCacheFn(){this._itemInfoById={};for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.isLive&&(cell.width=cell.height=void 0)}},_isInBounds:function _isInBoundsFn(top,bottom){var isInBounds=!1;return top>this._getPVRBottom()+this.offscreenScrollPadding||bottom<this._getPVRTop()-this.offscreenScrollPadding||(isInBounds=!0),isInBounds},getScrollTop:function getScrollTopFn(){return this._scrollTop},_getPVRTop:function _getPVRTopFn(){return this._scrollTop},_getPVRBottom:function _getPVRBottomFn(){return this._scrollTop+this.size.height},killAllDeadCells:function killAllDeadCellsFn(){for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];!cell.isLive&&cell.deadNeedsNotify&&cell.kill(!0)}},_startCellPassOnCell:function _startCellPassOnCellFn(cell){cell.seenInPass=!1},startCellPass:function startCellPassFn(){this.cellsCurrent={};for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.isLive&&(this.cellsCurrent[cell.paneObject.id]=cell,this._startCellPassOnCell(cell))}},_pruneCellPassOnCell:function _pruneCellPassOnCellFn(cell,force){if(!cell.seenInPass||force){var notify,i=cell.index;(this._phase!==Phase.OnScroll||this._isInBounds(this._tops[i],this._tops[i]+this._heights[i]))&&(notify=!0),cell.kill(notify)}},pruneCellPass:function pruneCellPassFn(){for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.isLive&&this._pruneCellPassOnCell(cell)}},updateCell:function updateCellFn(index){var paneObject=this._getItemsList()[index],id=paneObject.id,cell=this.cellsCurrent[id],width=this.size.width,height=this._heights[index],offset=this._tops[index],itemInfo=this._itemInfoById[id],prevOffset=itemInfo&&itemInfo.previousTop;cell&&!cell.seenInPass?cell.update(index,width,height,offset,prevOffset,paneObject):!cell&&this.cellsNew.indexOfWithProperty("index",index)<0&&this.cellsNew.push({index:index,width:width,height:height,offset:offset,paneObject:paneObject,prevOffset:prevOffset})},_addPassOnCell:function _addPassOnCellFn(info){for(var cell,i=0;i<this.cells.length;i++)if(!this.cells[i].isLive){cell=this.cells[i];break}try{g.PAssert(3994,cell,"Must always have additional cells to use",platform.windowHeight())}catch(PERR){g.reportError(PERR)}cell||(cell=new InfiniteListCell,this.cells.push(cell)),cell.update(info.index,info.width,info.height,info.offset,info.prevOffset,info.paneObject)},addCellPass:function addCellPassFn(){for(var i=0;i<this.cellsNew.length;i++){var info=this.cellsNew[i];this._addPassOnCell(info)}this.cellsNew=[]},_isIndexSeen:function _isIndexSeenFn(index){var paneObject=this._getItemsList()[index],id=paneObject.id,cell=this.cellsCurrent[id];return cell&&cell.seenInPass},_computeRenderItems:function _computeRenderItemsFn(restoreScroll){ReactDOM.unstable_batchedUpdates(this._computeRenderItemsBatched,restoreScroll)},_computeRenderItemsBatched:function _computeRenderItemsBatchedFn(restoreScroll){var items=this._getItemsList(),numInView=0,top,height,inBounds,newTopIndex;this.startCellPass();for(var i=0;i<items.length;++i)if(top=this._tops[i],height=this._heights[i],inBounds=this._isInBounds(top,top+height))isNaN(newTopIndex)&&top+height>this._getPVRTop()&&(newTopIndex=i),this.updateCell(i),numInView++;else if(top>this._getPVRBottom())break;isNaN(newTopIndex)&&(newTopIndex=0),this._indexOfTop=newTopIndex,this._inViewCount=numInView;var index;Sel.isValid()&&(!platform.mobile||platform.ios&&g.isKeyboardOpen)&&this._pane===Sel.getPane()&&(index=Sel.getStartIndex(),index<this._heights.length&&!this._isIndexSeen(index)&&this.updateCell(index)),platform.mobile&&DragDrop.isDragging&&(index=this._pane.indexOfItem(DragDrop.dragItem),index>=0&&!this._isIndexSeen(index)&&this.updateCell(index)),this.pruneCellPass(),this.addCellPass(),restoreScroll&&this.restoreScrollOfTop(),this._isSettingScroll||this._phase===Phase.OnScroll||this.saveScrollOfTop()},updateTopIndex:function updateTopIndexFn(){for(var items=this._getItemsList(),top,height,i=0;i<items.length;++i)if(top=this._tops[i],height=this._heights[i],this._isInBounds(top,top+height)&&top+height>this._getPVRTop()){this._indexOfTop=i;break}},getItemInfo:function getItemInfoFn(id){return this._itemInfoById[id]},indexOfItem:function indexOfItemFn(item){var isVMLI=g.isVMLI(item),items=this._getItemsList();if(this.itemsAreObjects){for(var i=0;i<items.length;i++)if(isVMLI){if(items[i].item===item&&(!items[i].type||"agendaItem"===items[i].type))return i}else if(items[i].id===item.id)return i;return-1}return items.indexOf(item)},topOfItem:function topOfItemFn(item){try{g.PAssert(3995,item,"Must provide a valid item to measure")}catch(PERR){g.reportError(PERR)}var index=this.indexOfItem(item);try{g.PAssert(3996,index>=0,"Must supply a valid item that is in this pane")}catch(PERR){g.reportError(PERR)}return this.topOfIndex(index)},topOfIndex:function topOfIndexFn(index){try{g.PAssert(3997,index>=0,"Must supply a valid index")}catch(PERR){g.reportError(PERR)}return this._tops[index]},scrollIndexToTop:function scrollIndexToTopFn(index,duration,cb){var itemTop=this.topOfIndex(index);return this.setScrollOffset(itemTop,duration,cb)},scrollItemToTop:function scrollItemToTopFn(item,duration,cb){try{g.PAssert(3998,g.isVMLI(item),"Must be a valid VMLI instance")}catch(PERR){g.reportError(PERR)}try{g.PAssert(3999,g.isNumber(duration),"Must have a valid scroll duration")}catch(PERR){g.reportError(PERR)}var index=this.indexOfItem(item);try{g.PAssert(4e3,index>=0,"Must supply a valid item that is in this pane")}catch(PERR){g.reportError(PERR)}return this.scrollIndexToTop(index,duration,cb)},scrollIndexToMiddle:function scrollIndexToMiddleFn(index,duration,cb){if(this._isMounted){var itemTop=this.topOfIndex(index),height=this._heights[index],amtMoved=itemTop+height/2-this.getHeight()/2;return this.setScrollOffset(amtMoved,duration,cb)}cb&&cb()},scrollItemToMiddle:function scrollItemToMiddleFn(item,duration,cb){if(this._isMounted){var index=this.indexOfItem(item);return this.scrollIndexToMiddle(index,duration,cb)}cb&&cb()},scrollItemIntoView:function scrollItemIntoViewFn(item,duration,cb){if(this._isMounted){var index=this.indexOfItem(item);return this.scrollIndexIntoView(index,duration,cb)}cb&&cb()},scrollIndexIntoView:function scrollIndexIntoViewFn(index,duration,cb){try{g.PAssert(4001,g.isNumber(index),"Must supply a valid index")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4002,g.isNumber(duration),"Must supply a valid scroll duration")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4003,!cb||g.isFunction(cb),"Must supply a valid callback function")}catch(PERR){g.reportError(PERR)}var item=this.itemAtIndex(index);try{g.PAssert(4004,item,"Item does not exist to scroll to",index,this.numItems())}catch(PERR){g.reportError(PERR)}if(this._isMounted&&item){var kbsize=platform.getKBSize(),itemTop=this.topOfIndex(index),paneHeight=this.getHeight(),availableScreenArea=platform.mobile?paneHeight-kbsize-g.keyboardToolbarHeight:paneHeight,scrollTop,scrollBottom;platform.mobile?(scrollTop=this.getScrollOffset(),scrollBottom=scrollTop+availableScreenArea):(scrollTop=this.getScrollOffset(),scrollBottom=scrollTop+paneHeight);var height=this._heights[index],itemScrollTop=itemTop,itemScrollBottom=itemScrollTop+height,isBelow=itemScrollBottom>scrollBottom,isAbove=scrollTop>itemScrollTop;isAbove&&height>availableScreenArea&&itemScrollBottom>=scrollBottom&&(isAbove=!1);var needsScroll=0,scrollDest;return isAbove?scrollDest=0===itemTop?0:itemScrollTop:isBelow&&(scrollDest=itemScrollBottom-availableScreenArea),isAbove||isBelow?(needsScroll=scrollDest-scrollTop,this.setScrollOffset(scrollDest,duration,function(){cb&&setTimeout(cb,0)})):cb&&cb(),needsScroll}return!1},getPaddingTop:function getPaddingTopFn(){return this._isOverview?platform.mobile?8:0:this._pane.topBoxHeight.get()},notifyDragStart:function notifyDragStartFn(){this.useCustomScroller&&this.iScroller.disable()},notifyDragEnd:function notifyDragEndFn(){this.useCustomScroller&&this.iScroller&&this.iScroller.enable()},notifySwappedIn:function notifySwappedInFn(scrollOffset){this.setScrollOffset(scrollOffset)},addScrollDelta:function addScrollDeltaFn(delta){try{g.PAssert(4005,this.scrollElement,"Pane must have loaded a scrollable element")}catch(PERR){g.reportError(PERR)}return this.setScrollOffset(this.getScrollOffset()+delta)},setScrollHandler:function setScrollHandlerFn(cb){this.scrollHandler=cb}},util.defineBase(InfiniteList),InfiniteList}),define("PaneOverview",["require","exports","module","globals","Constants","data","util","platform","tracker","MobileUI","Observable","InfiniteList","Sel","Dispatcher"],function(require,exports,module){function PaneOverview(pane,isVisible){this.pane=pane,this.root=pane.getRootItem(),this.contentElement=void 0,this.isVisible=new Observable(!!isVisible);var defaultTransform=platform.mobile?0:-1;this.transform=new Observable(defaultTransform),this.hasOpened=!1,this.cursor=new Observable,this.topItem=void 0,this.dragHoverItem=void 0,this._infiniteList=new InfiniteList({pane:pane,isOverview:!0,itemsObs:pane.headers,itemsFn:pane.getHeaders,heightFn:pane.getHeight}),this.init()}var g=require("globals"),C=require("Constants"),d=require("data"),util=require("util"),platform=require("platform"),tracker=require("tracker"),MobileUI=require("MobileUI"),Observable=require("Observable"),InfiniteList=require("InfiniteList"),Sel=require("Sel"),Dispatcher=require("Dispatcher");return PaneOverview.prototype={init:function initFn(){platform.mobile?util.forceBind("refreshScrollListener",this):(util.forceBind("onPaneScroll",this),util.forceBind("onPaneItemsUpdated",this),Dispatcher.listen("itemsUpdated",this.onPaneItemsUpdated))},destroy:function destroyFn(){this.pane=void 0,util.destroy(this)},getInfiniteList:function getInfiniteListFn(){return this._infiniteList},getContentElement:function getContentElementFn(){return this.contentElement},onTapSection:function onTapSectionFn(e){g.vmMain.vmPicker.onTapSection(e)},getScrollOffset:function getScrollOffsetFn(){this._infiniteList.getScrollOffset()},refreshScrollListener:function refreshScrollListenerFn(){this._infiniteList.refreshScrollListener()},onTap:{onStart:function onStartFn(e){e.preventDefault()},onClick:function onClickFn(e){var pane=this.pane,item,data=g.dataFor(e.target),li=g.getElementParent(e.target);if(li&&data!==pane&&data!==this){item=g.getItemForElement(e.target);try{g.PAssert(4006,item,"Element in overview was text but was not an item")}catch(PERR){g.reportError(PERR)}}if(item){try{g.PAssert(4007,li,"Item must have an overview element: "+(item.getRawText?item.getRawText():"not an item"))}catch(PERR){g.reportError(PERR)}if(li){var offsetX=e.clientX-g.offset(li).left;if(offsetX<pane.getPaddingForItem(item,!0))item.setCollapsed(!item.isCollapsed(pane,!0),pane,!0),this.pane.updateHeaders();else if(this.pane.supportClickOverviewScroll&&offsetX<C.OverviewWidth-50){this._disablePaneScrollListener=!0;for(var scrollItem=item,index=this.pane.indexOfItem(scrollItem),ok=index>=0;!ok;)scrollItem=scrollItem.parent(),scrollItem&&scrollItem!==this.pane.getItem()&&(ok=this.pane.indexOfItem(scrollItem)>=0);ok&&this.pane.scrollItemToTop(scrollItem,ScrollDuration.Default),this.updateTopPaneItem(item),setTimeout(function(){this._disablePaneScrollListener=!1}.bind(this),2*ScrollDuration.Default)}else this.pane.allowZoom(item)?(g.vmMain.zoomin(item),platform.mobile&&MobileUI.setOverviewVisibility(!1),g.sendEvent("Menu","OverviewZoom")):this.pane.performOverviewAction(item)}}e.preventDefault()}},setVisibility:function setVisibilityFn(isVisible){isVisible&&(this.hasOpened=!0,Sel.reset()),isVisible!==this.isVisible.get()&&(this.isVisible.set(isVisible),Dispatcher.fireEvent("panesChanged",[]),platform.mobile||(g.vmMain.paneManager.updatePaneStateForPane(this),this.pane.overviewTracksScroll&&(isVisible?(this.pane.addScrollListener(this.onPaneScroll),this.onPaneScroll()):this.pane.removeScrollListener(this.onPaneScroll)))),platform.mobile&&(isVisible&&g.isKeyboardOpen&&!g.getActiveSearch().isFocused.get()&&g.blurActiveElement(),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOverview,data:{value:isVisible,pane:this.pane}}),this.pane.onOverviewToggled(isVisible))},toggleDesktop:function toggleDesktopFn(){var time=150;this.setVisibility(this.isVisible.get()?!1:!0),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOverview,data:{value:this.isVisible.get(),pane:this.pane}})},onPaneScroll:function onPaneScrollFn(){if(!this._disablePaneScrollListener){try{g.PAssert(4008,this.isVisible.get(),"Should not be tracking scroll if overview is not open")}catch(PERR){g.reportError(PERR)}var item=this.findTopPaneItem();item&&(this.updateTopPaneItem(item),this._infiniteList.scrollItemToMiddle(item,ScrollDuration.Default))}},findTopPaneItem:function findTopPaneItemFn(){var pane=this.pane;if(this.pane.numItems()>0){for(var scrollOffset=this.pane.getScrollOffset(),topIndex=this.pane.indexOfTop(),topItem,item;topIndex>=0&&topIndex<pane.numItems()&&!item;){for(topItem=this.pane.itemAtIndex(topIndex);topItem&&topItem!==this.root&&!item;){var index=this._infiniteList.indexOfItem(topItem);0>index?topItem=topItem.parent():item=topItem}item||topIndex++}return!item&&this._infiniteList.numItems()>0&&(item=this._infiniteList.itemAtIndex(0)),item}},updateTopPaneItem:function updateTopPaneItemFn(item){var old=this.topItem;this.topItem=item,old&&old.itemChanged.notify(),item.itemChanged.notify()},updateDragHoverItem:function updateDragHoverItemFn(item){var old=this.dragHoverItem;this.dragHoverItem=item,old&&old.itemChanged.notify(),item&&item.itemChanged.notify()},onPaneItemsUpdated:function onPaneItemsUpdatedFn(pane){if(pane===this.pane&&this.isVisible.get()&&this.pane.overviewTracksScroll){var item=this.findTopPaneItem();item&&this.updateTopPaneItem(item)}},isItemAtTop:function isItemAtTopFn(item){return item===this.topItem},isItemDragHovered:function isItemDragHoveredFn(item){return item===this.dragHoverItem},getiScroller:function getiScrollerFn(){return this._infiniteList.iScroller}},PaneOverview}),define("Search",["globals","Constants","util","platform","android","data","VMLI","tracker","Observable","ObservableArray","Trigger","Dispatcher","NativeSel"],function(g,C,util,platform,android,d,VMLI,tracker,Observable,ObservableArray,Trigger,Dispatcher,NativeSel){function Search(pane,savedState,callback){this.callback=callback,this.pane=pane,this.searchArr=[],this.matches={},this.previousSearch="",this.itemStoreFilter=void 0,this.UI=void 0,this.isFocused=new Observable,this._destroyed=!1,util.forceBind("isMatched",this),util.forceBind("checkChildrenParams",this),pane.supportSearchListenTextChanges&&Dispatcher.listen("itemTextChanged",util.forceBind("handleItemTextChanged",this));for(var defaultFilters={priority:{name:"priority",matchFn:this._matchFnPriority.bind(this)},complete:{name:"complete",initialValue:-1,icon:"icon-ok",matchFn:this._matchFnComplete.bind(this)},starred:{name:"starred",initialValue:1,icon:"icon-star",matchFn:this._matchFnStarred.bind(this)},email:{name:"email",initialValue:1,icon:"icon-envelope",matchFn:this._matchFnEmail.bind(this),enabled:g.vmMain.pluginManager.getPlugin(PluginID.Gmail).isActive()}},filters=[],i=0;i<pane.searchFilters.length;i++){var f=pane.searchFilters[i];filters.push(g.isString(f)?defaultFilters[f]:f)}this.setupFilters(filters,savedState),this.filterDate=new Observable,this.value=savedState&&savedState.text||"",this.onChanged=new Trigger(callback),this._updateSearchArr(),g.vmMain.pluginManager.listen("pluginActiveChanged",PluginID.Gmail,util.forceBind("onGmailActiveChanged",this))}var MatchState=C.MatchState;return Search.prototype={destroy:function destroyFn(){this._destroyed=!0,this.pane.supportSearchListenTextChanges&&Dispatcher.unlisten("itemTextChanged",this.handleItemTextChanged),this.onChanged.unlisten(this.callback),g.vmMain.pluginManager.unlisten("pluginActiveChanged",PluginID.Gmail,this.onGmailActiveChanged),this.pane=void 0,this.UI=void 0,util.destroy(this)},setupFilters:function setupFiltersFn(filters,savedState){for(var arr=[],i=0;i<filters.length;i++){var filter=filters[i],name=filter.name,saved=savedState&&savedState[name];filter.value=saved||0,filter.enabled=new Observable(void 0!==filter.enabled?filter.enabled:!0);try{g.PAssert(4009,!this.hasOwnProperty("filter_"+name),"Should not double define filter properties")}catch(PERR){g.reportError(PERR)}this["filter_"+name]=filter,arr.push(filter)}this.filters=arr},setFilterEnabled:function setFilterEnabledFn(name,enabled){var index=this.filters.indexOfWithProperty("name",name);index>=0&&this.filters[index].enabled.set(enabled)},onGmailActiveChanged:function onGmailActiveChangedFn(plugin,isActive){this.setFilterEnabled("email",isActive)},getValue:function getValueFn(){return this.value},getRemoteValue:function getRemoteValueFn(){for(var rvalue=this.value,i=0;i<this.filters.length;++i){var f=this.filters[i];if(f.remoteStringFn&&f.enabled.get()){var remoteString=f.remoteStringFn(f.value);remoteString&&(rvalue+=" "+remoteString)}}return rvalue.trim()},getState:function getStateFn(){for(var state={text:this.getValue()},i=0;i<this.filters.length;i++){var filter=this.filters[i];state[filter.name]=filter.value}return state},focus:function focusFn(){this.UI.focus()},blur:function blurFn(){this.UI.blur()},onParsed:function onParsedFn(parsed){var date=parsed.dates&&parsed.dates[0];date!==this.filterDate.get()&&(this.filterDate.set(date),this._updateSearchArr(),this.update(!0))},setValue:function setValueFn(value){value||this.pane.clearPerPaneStateSearch(),this.value=value,this._updateSearchArr(),this.update(!0),value&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:this.getState()})},addToValue:function addToValueFn(add){var offset=this.getSelectionOffset(),text=this.value;"-"!==text[text.length-1]&&"!"!==text[text.length-1]&&(add=" "+add),text+=add,this.setValue(text),this.setSelectionOffset(offset+add.length)},toggleText:function toggleTextFn(toggle){var text=this.value.trim(),regexp="\\B"+g.escapeRegExp(toggle)+"\\b",match=text.match(regexp);match?text=text.replace(new RegExp(regexp),"").replace(/  +/g," "):text+=" "+toggle,text=text.trim(),this.setValue(text),(!platform.mobile||g.isKeyboardOpen)&&this.setSelectionOffset(text.length)},getSelectionOffset:function getSelectionOffsetFn(){return this.UI.getSelectionOffset()},setSelectionOffset:function setSelectionOffsetFn(offset){this.UI.setSelectionOffset(offset)},isSearched:function isSearchedFn(){if(this.value.length>0)return!0;for(var i=0;i<this.filters.length;i++){var f=this.filters[i];if(f.enabled.get()&&f.value)return!0}},reset:function resetFn(){this.setValue("")},resetFilters:function resetFiltersFn(){for(var i=0;i<this.filters.length;i++){var filter=this.filters[i];filter.value=0}this.update(!0,!0)},getMatchedItems:function getMatchedItemsFn(){var items=[];for(var id in this.matches)this.matches[id]===MatchState.Yes&&items.push(id);return items},isMatched:function isMatchedFn(item){if(this.pane.supportLocalSearch){var m=this.matches[item.id];return void 0===m||m===MatchState.Yes||m===MatchState.ChildYes||m===MatchState.Unknown}return MatchState.Yes},handleItemTextChanged:function handleItemTextChangedFn(e){if(g.vmMain.paneManager.isPaneActive(this.pane.id)&&!platform.mobile&&(e.force||g.focusedPane&&g.focusedPane.id!==this.pane.id)){var item=e.item,oldValue=this.isMatched(item);this.checkItem(item);var newValue=this.isMatched(item);newValue!=oldValue&&this.pane.refreshSearchResults()}},_updateSearchArr:function _updateSearchArrFn(){var text=this.value;this.filterDate.get()&&(text=text.replace("@"+this.filterDate.get().text,""));var textArray=text.toLowerCase().trim().split(/\s+/);textArray=textArray.filter(function(str){return!(!str||"-"===str)}),this.searchArr=[];for(var i=0;i<textArray.length;++i){var isNegated=textArray[i].startsWith("-"),itemText=isNegated?textArray[i].substr(1):textArray[i];this.searchArr.push({text:itemText,isNegated:isNegated})}},toggleFilterDefault:function toggleFilterDefaultFn(name){var prop=this["filter_"+name],val=prop.value;val=val?0:prop.initialValue,this.setFilter(name,val)},toggleFilter:function toggleFilterFn(name,negate){var targetVal=negate?-1:1,prop=this["filter_"+name],val=prop.value;val=val===targetVal?0:targetVal,this.setFilter(name,val)},getFilter:function getFilterFn(name){var prop=this["filter_"+name];return prop.value},setFilter:function setFilterFn(name,value){var prop=this["filter_"+name];prop.value=value,this.update(!0,!0),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:this.getState()})},update:function updateFn(notify,force){this.pane.supportLocalSearch&&(this.matches={},this.checkChildren()),this.isUpdatingSearch=!0,this.pane.isLoaded&&notify&&(g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),this.onChanged.notify(force)),setTimeout(function(){this.isUpdatingSearch=!1,g.vmMain.resetItemAnimationMode()}.bind(this),0)},_checkMatch:function _checkMatchFn(item,lower,s){var found=!0;if(s.length>0&&found&&(found=lower.indexOf(s)>=0,!found)){var attachments=item.getAttachments();if(attachments)try{for(var i=0;i<attachments.length&&!found;++i)found=attachments[i].match(s)}catch(err){g.reportError(err)}}return found},_isMatchStateOk:function _isMatchStateOkFn(matchState){return matchState===MatchState.Yes||matchState===MatchState.Unknown},_matchFilter:function _matchFilterFn(filterValue,value,matchState){return filterValue&&(matchState=value?filterValue>0?MatchState.Yes:MatchState.Negated:filterValue>0?MatchState.No:MatchState.Unknown),matchState
},_matchFilters:function _matchFiltersFn(item){for(var matchState=MatchState.Unknown,i=0;i<this.filters.length;i++)if(this._isMatchStateOk(matchState)){var filter=this.filters[i];matchState=filter.matchFn(filter.value,item,matchState)}return matchState},_matchFnComplete:function _matchFnCompleteFn(filterValue,item,matchState){return this._matchFilter(filterValue,item.isComplete(),matchState)},_matchFnStarred:function _matchFnStarredFn(filterValue,item,matchState){return this._matchFilter(filterValue,item.isStarred(),matchState)},_matchFnPriority:function _matchFnPriorityFn(filterValue,item,matchState){var priority=item.priority();return priority>=filterValue?MatchState.Yes:MatchState.No},_matchFnEmail:function _matchFnEmailFn(filterValue,item,matchState){var attachments=item.getAttachments(),attach=attachments&&attachments[0],value=attach&&attach.getPlugin()===g.vmMain.getDefaultEmailPlugin();return this._matchFilter(filterValue,value,matchState)},_matchDate:function _matchDateFn(item,matchState){var filterDate=this.filterDate.get();if(filterDate){matchState=MatchState.No;var date=filterDate.date;item.isOnDate(date)&&(matchState=MatchState.Yes)}return matchState},checkItem:function checkItemFn(item){var root=d.getRootModel(),matches=this.matches;try{g.PAssert(4010,item.parent()||item.isRootItem(),"Item parent does not exist while being searched",item.isArchived(),item===root)}catch(PERR){g.reportError(PERR)}if(item.isRootItem())return matches[item.id]=MatchState.Yes;if(!item.parent())return matches[item.id]=MatchState.No;if(matches[item.parent().id]===MatchState.Negated)return matches[item.id]=MatchState.Negated,MatchState.Negated;var matchState=MatchState.Unknown,parent,i,s,found,termEntry,lower=item.getSearchText();if(matchState=this._matchFilters(item),this._isMatchStateOk(matchState)&&(matchState=this._matchDate(item,matchState)),matchState!==MatchState.Negated)for(i=0;i<this.searchArr.length;i++){termEntry=this.searchArr[i];var negate=termEntry.isNegated;if(negate){s=termEntry.text;try{g.PAssert(4011,s,"Each value in the search array should be valid at this point")}catch(PERR){g.reportError(PERR)}if(found=this._checkMatch(item,lower,s)){matchState=MatchState.Negated;break}}}if(matchState!==MatchState.Negated){if(item.parent()!==root&&matches[item.parent().id]===MatchState.Yes&&this.pane.shouldSearchMatchParents)return matches[item.id]=MatchState.Yes,MatchState.Yes;for(i=0;i<this.searchArr.length;i++){termEntry=this.searchArr[i],s=termEntry.text;try{g.PAssert(4012,s,"Each value in the search array should be valid at this point")}catch(PERR){g.reportError(PERR)}if(!termEntry.isNegated&&(found=this._checkMatch(item,lower,s),!found))for(parent=item;parent;){if(parent=parent.parent(),!parent||parent===root){matchState=MatchState.No;break}if(this._checkMatch(parent,parent.getSearchText(),s))break}if(matchState===MatchState.No)break}}if(matchState===MatchState.Unknown&&(matchState=MatchState.Yes),matchState===MatchState.Yes)for(parent=item.parent();parent&&!parent.isRootItem()&&matches[parent.id]!==MatchState.Negated&&matches[parent.id]!==MatchState.Yes;)matches[parent.id]=MatchState.ChildYes,parent.hasNote()&&(matches[parent.getNote().id]=MatchState.Yes),parent=parent.parent();else matchState===MatchState.No&&item.isNote()&&(matchState=matches[item.parent().id]);return matches[item.id]=matchState,matchState},checkChildrenParams:function checkChildrenParamsFn(item){var val=this.checkItem(item);return val!==MatchState.Negated},checkChildren:function checkChildrenFn(){var params={includeArchived:this.pane.showArchived.get(),includeNotes:!0,comparator:this.checkChildrenParams};this.itemStoreFilter&&(params.itemStoreFilter=this.itemStoreFilter),params.itemStore=this.pane.getItemStore(),g.searchVMLIs(params);for(var item=this.pane.getItem();item;)this.matches[item.id]=MatchState.Yes,item=item.parent()}},Search}),define("AutocompleteDates",["ko","data","globals","platform"],function(ko,d,g,platform){function AutocompleteDates(){this.soft=["now","soon","later","someday"],this.softDays=["today","tomorrow"],this.dayModifiers=["next"],this.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],this.months=["january","february","march","april","may","june","july","august","september","october","november","december"],this.repeatStart=["every"],this.repeatModifier=["first","other","last"],this.dict=this.soft.concat(this.repeatStart).concat(this.softDays).concat(this.repeatModifier).concat(this.dayModifiers).concat(this.days).concat(this.months),this.NextWordOptions={None:0,DayName:1,Days:2,Time:4,Repeat:8},this.nextDateWord=ko.observable(this.NextWordOptions.None),this.init()}return AutocompleteDates.prototype={init:function initFn(){},showAllDates:function showAllDatesFn(){return""===g.autocomplete.text()},showRepeat:function showRepeatFn(){return g.isFlagSet(this.nextDateWord(),this.NextWordOptions.Repeat)},showDate:function showDateFn(){return this.nextDateWord()===this.NextWordOptions.None||g.isFlagSet(this.nextDateWord(),this.NextWordOptions.DayName)},showDays:function showDaysFn(){return g.isFlagSet(this.nextDateWord(),this.NextWordOptions.Days)},showTime:function showTimeFn(){return g.isFlagSet(this.nextDateWord(),this.NextWordOptions.Time)},getShortMonth:function getShortMonthFn(index){return Date.CultureInfo.abbreviatedMonthNames[index]},getLongMonth:function getLongMonthFn(index){return Date.CultureInfo.monthNames[index]},getShortDay:function getShortDayFn(index){return Date.CultureInfo.abbreviatedDayNames[index]},getLongDay:function getLongDayFn(index){return Date.CultureInfo.dayNames[index]},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return item.text},getItemTextLength:function getItemTextLengthFn(item){return item?this.getItemText(item).length:0},getItemStyledText:function getItemStyledTextFn(item){return item.text},findMatchLike:function findMatchLikeFn(like){for(var lower=like.toLowerCase(),results=[],i=0;i<this.dict.length;++i)0===this.dict[i].indexOf(lower)&&results.push({type:"date",text:this.dict[i]});return results},findMatchExact:function findMatchExactFn(text){if(this.dict.indexOf(text)>=0){if(!platform.mobile)return{type:"date",text:text};if(this.nextWordOptions(text)===this.NextWordOptions.None)return{type:"date",text:text}}return void 0},nextWordOptions:function nextWordOptionsFn(text){var words=text.toLowerCase().split(" "),lastWord=words[words.length-1];if(""===lastWord&&(lastWord=words[words.length-2]),this.soft.indexOf(lastWord)>=0)return this.NextWordOptions.None;if(this.repeatStart.indexOf(lastWord)>=0)return this.NextWordOptions.DayName|this.NextWordOptions.Repeat;if(this.repeatModifier.indexOf(lastWord)>=0)return this.NextWordOptions.DayName;if(this.softDays.indexOf(lastWord)>=0)return this.NextWordOptions.Time;if(this.dayModifiers.indexOf(lastWord)>=0)return this.NextWordOptions.DayName;if(this.days.indexOf(lastWord)>=0)return this.NextWordOptions.Time;if(this.months.indexOf(lastWord)>=0)return this.NextWordOptions.Days;var isInt=parseInt(lastWord,10);return isNaN(isInt)?lastWord.indexOf(":")>=0?this.NextWordOptions.Time:this.NextWordOptions.None:this.NextWordOptions.Time},getMonthList:function getMonthListFn(){var monthsInPast=1,monthsInFuture=5,currentIndex=(new Date).getMonth(),startIndex=currentIndex-monthsInPast;0>startIndex&&(startIndex=12+startIndex);for(var endIndex=startIndex+monthsInPast+monthsInFuture,output=[],i=startIndex;endIndex>i;++i){var monthIndex=i%12;output.push(monthIndex)}return output},getDayList:function getDayListFn(){return[0,1,2,3,4,5,6]},getSoftList:function getSoftListFn(){return this.repeatStart.concat(this.soft)},onTapDate:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var el=e.srcElement;if("SPAN"===el.nodeName){var parentDiv=el.parentNode;if(g.hasClass(parentDiv,"disabled"))return;var text=el.id||el.textContent,next=this.nextWordOptions(text);this.nextDateWord(next);var hide=next===this.NextWordOptions.None;"autocompleteHours"!==parentDiv.id&&"autocompleteMinutes"!==parentDiv.id&&(text+=" "),g.autocomplete.onTapped(text,text.length,hide,!0)}}}},AutocompleteDates}),define("TagManager",["require","exports","module","globals","util"],function(require,exports,module){function TagManager(){util.forceBind("tagComparatorNumber",this)}var g=require("globals"),util=require("util");return TagManager.prototype={previewTemplate:function previewTemplateFn(){return void 0},getItemStyledText:function getItemStyledTextFn(item){return item.text},getItemText:function getItemTextFn(item){return item.text},getItemTextLength:function getItemTextLengthFn(item){return item?this.getItemText(item).length:0},tagComparator:function tagComparatorFn(a,b){return a.localeCompare(b)},tagComparatorNumber:function tagComparatorNumberFn(a,b){var numA=a.count,numB=b.count;return numA===numB?a.text.localeCompare(b.text):numA>numB?-1:1},findMatchExact:function findMatchExactFn(tag){return!1},findMatchLike:function findMatchLikeFn(tagToFind,maxCount,pane){var tagsMap={},tagsArray=[],tagToFindLower=tagToFind.toLowerCase(),params={comparator:function comparatorFn(item){return!!item.getTags()},each:function eachFn(item){for(var tags=item.getTags(),i=0;i<tags.length;i++){var tag=tags[i],tagID="t~"+tag.toLowerCase();if(lower=tag.toLowerCase(),!tagToFindLower||lower.startsWith(tagToFindLower)&&lower!==tagToFindLower){if(!tagsMap[tagID]){var found=tagsMap[tagID]={type:"tag",text:tag,count:0};tagsArray.push(found)}tagsMap[tagID].count++}}}};return pane?params.item=pane.item.get():params.itemStore=g.vmMain.itemStoreManager.getDefaultItemStore(),g.searchVMLIs(params),tagsArray.sort(this.tagComparatorNumber),tagsArray.length>maxCount&&(tagsArray=tagsArray.slice(0,maxCount)),tagsArray},printStats:function printStatsFn(time){log("--- Tag stats ---",time);for(var results=this.findMatchLike("",100),i=0;i<results.length;i++)console.log(results[i].text,results[i].count)}},new TagManager}),define("AutocompleteItems",["require","exports","module","globals","data","util","platform"],function(require,exports,module){function AutocompleteItems(){this.items=[]}var g=require("globals"),d=require("data"),util=require("util"),platform=require("platform");return AutocompleteItems.prototype={findMatchLike:function findMatchLikeFn(like,max){var itemStore=g.vmMain.itemStoreManager.getDefaultItemStore(),lower=like.toLowerCase(),results=[];return g.searchVMLIs({itemStore:itemStore,each:function eachFn(item){var text=item.getSearchText();return item.isHeader()&&text.indexOf(lower)>=0&&(results.push({type:"item",text:item.getParsedText(),item:item}),results.length>=max)?!1:void 0}}),results},findMatchExact:function findMatchExactFn(text,matchesLike){}},new AutocompleteItems}),define("AutocompleteGmailLabels",["require","exports","module","globals"],function(require,exports,module){function AutocompleteGmailLabels(){}var g=require("globals");return AutocompleteGmailLabels.prototype={findMatchLike:function findMatchLikeFn(like,maxResults){for(var plugin=g.vmMain.getDefaultEmailPlugin(),labels=plugin.getLabels(like,maxResults),results=[],i=0;i<labels.length;++i)labels[i].isSystemLabel()||results.insertSorted(labels[i],plugin.labelSortFn);return results.map(function(label){return{type:"gmailLabel",text:label.getName(),label:label}})},findMatchExact:function findMatchExactFn(text,matchesLike){}},new AutocompleteGmailLabels}),define("Autocomplete",["require","exports","module","globals","data","util","platform","react","ObservableArray","AutocompleteDates","TagManager","AutocompleteItems","AutocompleteGmailLabels"],function(require,exports,module){function Autocomplete(){this.matches=new ObservableArray,this._isShowing=!1,this._isTempDisabled=!1,this._isPopup=!1,this._searchInfo=void 0,this.owner=void 0,this.elementInput=void 0,this.text=void 0,this._prefixes=[ContactPrefix,DatePrefix,TagPrefix],this._prefixMap={},this._prefixMap[ContactPrefix]=d.contactManager,this._prefixMap[TagPrefix]=TagManager,this._prefixMap[DatePrefix]=new AutocompleteDates,util.forceBind("onClosed",this),this.supportedModes=null}var g=require("globals"),d=require("data"),util=require("util"),platform=require("platform"),React=require("react"),ObservableArray=require("ObservableArray"),AutocompleteDates=require("AutocompleteDates"),TagManager=require("TagManager"),AutocompleteItems=require("AutocompleteItems"),AutocompleteGmailLabels=require("AutocompleteGmailLabels");return Autocomplete.prototype={isShowing:function isShowingFn(){return this._isShowing},getText:function getTextFn(){return this.text},getProviderForPrefix:function getProviderForPrefixFn(prefix){return this._prefixMap[prefix]||ACProvider.None},_checkPrefixes:function _checkPrefixesFn(word){for(var l=word.startsWith("-")?1:0,i=0;i<this._prefixes.length;i++){var p=this._prefixes[i];if(word[l]===p)return{length:l+1,prefix:p}}},_findClosestWithPrefix:function _findClosestWithPrefixFn(text,offset,mode){for(var words=text.split(" "),lineIndex=0,startWord=-1,startChar=-1,endChar=-1,prefixLength=0,prefix,i=0;i<words.length&&offset>=lineIndex;++i){var word=words[i];words[startWord]===prefix&&(prefixLength=0);var prefixInfo=this._checkPrefixes(word);prefixInfo?(startWord=i,startChar=lineIndex,endChar=startChar+word.length,prefixLength=prefixInfo.length,prefix=prefixInfo.prefix):prefixLength&&(endChar+=word.length+1),lineIndex+=word.length+1}if(prefixLength){var searchText=text.substr(startChar+prefixLength,endChar-startChar-prefixLength);return{mode:mode,text:text,prefix:prefix,searchText:searchText,start:startChar+prefixLength,end:endChar}}},_findClosestDelimited:function _findClosestDelimitedFn(text,offset,mode){for(var phrases=text.split(","),found=!1,lineIndex=0,startChar=-1,endChar=-1,prefixLength=0,prefix,i=0;i<phrases.length&&offset>=lineIndex;++i){var phrase=phrases[i];startChar=lineIndex+this._numStartSpaces(phrase),endChar=lineIndex+phrase.length-1-this._numEndSpaces(phrase),found=offset>startChar&&endChar+1>=offset&&phrase.length>0?!0:!1,lineIndex+=phrase.length+1}if(found||this._isPopup){var searchText=text.substr(startChar,endChar-startChar+1);return{mode:mode,text:text,searchText:searchText,start:startChar,end:endChar}}},_findClosestVMLIElement:function _findClosestVMLIElementFn(text,els,offset,mode){for(var lineIndex=0,found=!1,startChar,endChar,searchText,i=0;i<els.length&&found===!1;i++){var phrase=els[i].getParsedText();if(startChar=lineIndex+this._numStartSpaces(phrase),endChar=lineIndex+phrase.length-1-this._numEndSpaces(phrase),offset>startChar&&endChar+1>=offset&&phrase.length>0){found=i,searchText=phrase.trim();break}lineIndex+=phrase.length}return found!==!1?{mode:mode,text:text,prefix:"",searchText:searchText,start:startChar,end:endChar,el:els[i]}:void 0},_numStartSpaces:function _numStartSpacesFn(text){for(var num=0,i=0;i<text.length&&" "===text[i];i++)num++;return num},_numEndSpaces:function _numEndSpacesFn(text){for(var num=0,i=text.length-1;i>=0&&" "===text[i];i--)num++;return num},insertMatch:function insertMatchFn(match){var s=this._searchInfo,text=s.text,before=text.substr(0,s.start),after=text.substr(s.end+1,text.length),offset=s.start+match.length;" "!==after[0]&&match&&(match+=" ",offset++);var newText=before+match+after;return{text:newText,offset:offset}},update:function updateFn(params){var mode=params.mode;if((params.owner!==this.owner||params.elementInput!==this.elementInput)&&(this._isTempDisabled=!1),this.text=params.text,this._isTempDisabled||!params.text&&!this._isPopup)this.matches.set([]),this._isPopup||this.hide();else{this.owner=params.owner,this.elementInput=params.elementInput;var text=params.text,matches=null,provider=null;this._searchInfo="all"===mode?this._findClosestWithPrefix(text,params.offset,params.mode):this._findClosestDelimited(text,params.offset,params.mode);var MaxMatchCount=22;if(this._searchInfo){this.text=this._searchInfo.searchText;var useDefaultMatch=!0;if("all"===mode)provider=this.getProviderForPrefix(this._searchInfo.prefix);else switch(mode){case"move":provider=AutocompleteItems;break;case"email":provider=this._prefixMap[ContactPrefix],matches=provider.findEmailsLike(this._searchInfo.searchText.trim(),MaxMatchCount);break;case"contact":provider=this._prefixMap[ContactPrefix];break;case"tag":provider=this._prefixMap[TagPrefix];break;case"date":case"snooze":provider=this._prefixMap[DatePrefix];break;case"gmailLabel":provider=AutocompleteGmailLabels}null===matches&&(matches=provider.findMatchLike(this._searchInfo.searchText,MaxMatchCount,g.focusedPane)),1===matches.length&&provider.findMatchExact(this._searchInfo.searchText,matches)&&(matches=[])}matches=matches||[],params.supportSearchItemAutocomplete&&"all"===mode&&0===matches.length&&params.parsedEls&&(this._searchInfo=this._findClosestVMLIElement(text,params.parsedEls,params.offset,mode)),this.matches.set(matches),!this._isShowing&&matches.length>0&&!this._isTempDisabled?this.show(params):0===matches.length&&(this._isPopup||this.hide(),this._isTempDisabled=!1)}},clearDisabled:function clearDisabledFn(){this._isTempDisabled=!1},onClosed:function onClosedFn(value,source){this._isShowing=!1,this._owner=null},show:function showFn(params){this._isShowing=!0,this._isPopup=!1,this._owner=params.owner,params.componentName="ReactAutocomplete",params.onClosed=this.onClosed,g.menus.openContextMenuReact(params)},showPopup:function showPopupFn(params){this._isShowing=!0,this._isPopup=!0,params.componentName="ReactAutocomplete",params.onClosed=this.onClosed,g.menus.openContextMenuReact(params)},hide:function hideFn(fromEscape){this._isShowing&&(this._isShowing=!1,g.menus.closeContextMenuReact("ReactAutocomplete"))}},new Autocomplete}),define("VMPane",["require","globals","Constants","data","util","android","edit","tracker","PaneOverview","platform","Dispatcher","Observable","ObservableArray","Trigger","Search","Sel","Multiselect","MobileUI","DragDrop","InfiniteList","Autocomplete","AccountManager","EmailPreview"],function(require){function VMPane(p){this.setPropDefault("type",PaneMode.Outline),this.setPropDefault("paneClass","paneOutline"),this.setPropDefault("contextMenu","contextMenuItem"),this.setPropDefault("paneEmptyMessage","Write some things here to get started"),this.setPropDefault("paneEmptySearchMessage","No search results"),this.setPropDefault("overviewEmptyMessage","No lists in this item"),this.setPropDefault("searchFilters",(g.isDemoMode()?[]:["email"]).concat(["complete","starred","priority"])),this.setPropDefault("dropEffect",function(){return C.DropEffect.Move}),this.setPropDefault("isWriteable",!0),this.setPropDefault("isEditable",!0),this.setPropDefault("isDraggable",!0),this.setPropDefault("isDropTarget",!0),this.setPropDefault("hasNonVMLIs",!1),this.setPropDefault("canAddItem",!0),this.setPropDefault("overrideCopyBehavior",!0),this.setPropDefault("supportCollapsing",!0),this.setPropDefault("supportCompleting",!0),this.setPropDefault("supportArchiving",!1),this.setPropDefault("supportIndent",!0),this.setPropDefault("supportOffline",!0),this.setPropDefault("supportPerformArchive",!0),this.setPropDefault("supportDataRefresh",!1),this.setPropDefault("supportReportError",!1),this.setPropDefault("supportCompose",!1),this.setPropDefault("supportPagination",!1),this.setPropDefault("supportSearchAutocomplete",!0),this.setPropDefault("supportBullets",!0),this.setPropDefault("supportVertLines",!0),this.setPropDefault("supportStarClick",!1),this.setPropDefault("supportSearchItemAutocomplete",!0),this.setPropDefault("supportSearchListenTextChanges",!0),this.setPropDefault("supportLocalSearch",!0),this.setPropDefault("supportClone",!0),this.setPropDefault("supportDates",!0),this.setPropDefault("supportMultiselect",!0),this.setPropDefault("supportDeferredItemLoad",!1),this.setPropDefault("shouldSearchMatchParents",!0),this.setPropDefault("noOverviewStyle",!1),this.setPropDefault("itemsAreObjects",!1),this.setPropDefault("titleOfFirstItem",C.RootItemName),this.setPropDefault("supportClickOverviewScroll",!platform.mobile),this.setPropDefault("overviewTracksScroll",!0),this.setPropDefault("overviewPadLevels",0),this.setPropDefault("maxWidth",900),this.setPropDefault("pluginCursor",function(){return this.isDraggable?DragDrop.startDragItem?platform.isFirefox?"-moz-grabbing":"-webkit-grabbing":platform.isFirefox?"-moz-grab":"-webkit-grab":"pointer"}.bind(this)),this.topBoxHeight=new Observable(g.activeDisplayMode&DisplayMode.NoPaneTop?0:platform.phone?40:36),this.rect=new Observable(p.rect),this.isExpanded=new Observable(!1);try{g.PAssert(4013,void 0!==p.id,"Must supply a valid pane id")}catch(PERR){g.reportError(PERR)}this.id=p.id,p.item||(this.supportDeferredItemLoad?(p.item=this.getDefaultDisplayItem(),this.deferredItemState={itemID:p.deferredItemID,search:p.search,offset:0}):(p.item=this.getDefaultDisplayItem(),p.offset=0,p.search="")),this.item=new Observable(p.item),this.items=new ObservableArray,this.headers=new ObservableArray,this.isDefaultPane=p.isDefaultPane,this.itemsDirtyState=void 0,this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.reloading=!1,this.showArchived=new Observable(!1),this.numCompleteItems=new Observable(0),this._panePadding=0,this.cursor=new Observable,this.paneTopText=new Observable,this.blurTrigger=new Trigger,this.focusTrigger=new Trigger,this.isInitialized=!1,this.isLoaded=!1,this.isLoading=new Observable(!1),this.isFocused=!1,this.caretPosition=new Observable,this.isReady=new Observable(this.plugin?this.plugin.isReady():!0),this.paddingBottom=new Observable(0),util.forceBind("getItems",this),util.forceBind("getHeaders",this),util.forceBind("getHeight",this),util.forceBind("zoomInOnSwipe",this),this._infiniteList=new InfiniteList({pane:this,isOverview:!1,itemsObs:this.items,itemsFn:this.getItems,heightFn:this.getHeight,itemsAreObjects:this.itemsAreObjects}),this.useCustomScroller=this._infiniteList.useCustomScroller,this.isLoadingNewPage=new Observable(!1),this._perPaneState={},this._destroyed=!1,this._numItemComputes=0,this._numHeaderComputes=0,this._numItemSets=0,this.isAnimatingOffset=!1,this._ignoreRestoreScroll=!1,this._activeItemStores={},this.initialOffset=p.offset,platform.mobile?(this.defaultOffset=this.topBoxHeight.get()-16,this.offsetX=new Observable(0),this.swipeMenuItems=this.getSwipeMenuItems(),util.forceBind("onTouchHoldTimeout",this)):this.defaultOffset=0,util.forceBind("textInput",this),util.forceBind("compositionStart",this),util.forceBind("compositionEnd",this),util.forceBind("onShowArchivedChanged",this),util.forceBind("updateItems",this),this.showArchived.listen(this.onShowArchivedChanged),this.search=new Search(this,p.search,this.onSearchChanged.bind(this)),this.overview=new PaneOverview(this,p.isOverviewVisible)}var g=require("globals"),C=require("Constants"),d=require("data"),util=require("util"),android=require("android"),edit=require("edit"),tracker=require("tracker"),PaneOverview=require("PaneOverview"),platform=require("platform"),Dispatcher=require("Dispatcher"),Observable=require("Observable"),ObservableArray=require("ObservableArray"),Trigger=require("Trigger"),Search=require("Search"),Sel=require("Sel"),Multiselect=require("Multiselect"),MobileUI=require("MobileUI"),DragDrop=require("DragDrop"),InfiniteList=require("InfiniteList"),Autocomplete=require("Autocomplete"),AccountManager=require("AccountManager"),EmailPreview=require("EmailPreview");return VMPane.prototype={init:function initFn(){this.getItem()&&this.setItem(this.getItem(),!1),this.plugin&&this.plugin.notifyPaneCreated(this)},getStats:function getStatsFn(){return{numItemComputes:this._numItemComputes,numHeaderComputes:this._numHeaderComputes,numItemSets:this._numItemSets}},destroy:function destroyFn(){this._destroyed=!0,this.plugin&&this.plugin.notifyPaneDestroyed(this),this.showArchived.unlisten(this.onShowArchivedChanged),this.search.destroy(),this.search=void 0,this.overview.destroy(),this.overview=void 0,this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.hiddenInput=void 0,platform.mobile&&(this.itemMenuPhone=void 0,this.rightMenuPhone=void 0),this.getItemStore()===g.vmMain.itemStoreManager.getDefaultItemStore()&&(Dispatcher.unlisten("itemNoteSet",this._infiniteList.handleItemNoteSet),Dispatcher.unlisten("itemTextChanged",this._infiniteList.handleItemTextChanged),Dispatcher.unlisten("itemBoldChanged",this._infiniteList.handleItemBoldChanged)),util.destroy(this)},notifyPluginLoaded:function notifyPluginLoadedFn(){try{g.PAssert(4014,!1,"Plugin load notification not supported by pane type: ",this.type)}catch(PERR){g.reportError(PERR)}},getInfiniteList:function getInfiniteListFn(isOverview){var infiniteList;return infiniteList=isOverview?this.getOverview().getInfiniteList():this._infiniteList},getItemStore:function getItemStoreFn(){return g.vmMain.itemStoreManager.getDefaultItemStore()},usesItemStore:function usesItemStoreFn(store){return store===this.getItemStore()||!!this._activeItemStores[store.id]},useItemStore:function useItemStoreFn(store){try{g.PAssert(4015,!this._activeItemStores[store.id],"Should never use the same store twice")}catch(PERR){g.reportError(PERR)}this._activeItemStores[store.id]=store},stopUsingItemStore:function stopUsingItemStoreFn(store){try{g.PAssert(4016,this._activeItemStores[store.id],"Must be using item store to stop using it")}catch(PERR){g.reportError(PERR)}delete this._activeItemStores[store.id]},getOverview:function getOverviewFn(){return this.overview},isOverviewVisible:function isOverviewVisibleFn(){return this.overview.isVisible.get()},getiScroller:function getiScrollerFn(){return this._infiniteList.iScroller},numItems:function numItemsFn(){return this.getItems().length},getItems:function getItemsFn(){return g.vmMain.flushItemsUpdate(),this.items.get()},getHeaders:function getHeadersFn(){return this.headers.get()},itemAtIndex:function itemAtIndexFn(index){return this._infiniteList.itemAtIndex(index)},objectAtIndex:function objectAtIndexFn(index){return this._infiniteList.objectAtIndex(index)},indexOfItem:function indexOfItemFn(item){return this._infiniteList.indexOfItem(item)},indexOfObject:function indexOfObjectFn(object){return this._infiniteList.indexOfItem(object)},topOfItem:function topOfItemFn(item){return this._infiniteList.topOfItem(item,this.topBoxHeight.get())},topOfIndex:function topOfIndexFn(index){return this._infiniteList.topOfIndex(index,this.topBoxHeight.get())},indexOfTop:function indexOfTopFn(){return this._infiniteList.indexOfTop()},inViewCount:function inViewCountFn(){return this._infiniteList.inViewCount()},itemAtTop:function itemAtTopFn(){return this._infiniteList.itemAtTop()},elementAtIndex:function elementAtIndexFn(index){return this._infiniteList.getElementAtIndex(index)},isIndexMounted:function isIndexMountedFn(index){return this._infiniteList.isIndexMounted(index)},notifyDragStart:function notifyDragStartFn(){return this._infiniteList.notifyDragStart()},notifyDragEnd:function notifyDragEndFn(){return this._infiniteList.notifyDragEnd()},notifySwappedIn:function notifySwappedInFn(scrollOffset){return this._infiniteList.notifySwappedIn(scrollOffset)},getScrollOffset:function getScrollOffsetFn(){return this._infiniteList.getScrollOffset()},addScrollListener:function addScrollListenerFn(cb){return this._infiniteList.addScrollListener(cb)},removeScrollListener:function removeScrollListenerFn(cb){return this._infiniteList.removeScrollListener(cb)},refreshScrollListener:function refreshScrollListenerFn(){return this._infiniteList.refreshScrollListener()},setScrollOffset:function setScrollOffsetFn(offset,duration,cb){return this._infiniteList.setScrollOffset(offset,duration,cb)},scrollIndexIntoView:function scrollIndexIntoViewFn(index,duration,cb){return this._infiniteList.scrollIndexIntoView(index,duration,cb)},scrollItemIntoView:function scrollItemIntoViewFn(item,duration,cb){return this._infiniteList.scrollItemIntoView(item,duration,cb)},scrollIndexToTop:function scrollIndexToTopFn(item,duration,cb){return this._infiniteList.scrollIndexToTop(item,duration,cb)},scrollItemToTop:function scrollItemToTopFn(item,duration,cb){return this._infiniteList.scrollItemToTop(item,duration,cb)},scrollItemToMiddle:function scrollItemToMiddleFn(item,duration,cb){return this._infiniteList.scrollItemToMiddle(item,duration,cb)},scrollIndexToMiddle:function scrollIndexToMiddleFn(item,duration,cb){return this._infiniteList.scrollIndexToMiddle(item,duration,cb)},addScrollDelta:function addScrollDeltaFn(delta){return this._infiniteList.addScrollDelta(delta)},addPadding:function addPaddingFn(){return this._infiniteList.addPadding()},removePadding:function removePaddingFn(){return this._infiniteList.removePadding()},getScrollTop:function getScrollTopFn(){return this._infiniteList.getScrollTop()},closestIndexOfObject:function closestIndexOfObjectFn(item){return this.indexOfObject(item)},heightAtIndex:function heightAtIndexFn(index,overview){var owner=overview?this.overview._infiniteList:this._infiniteList,item=owner.objectAtIndex(index);try{g.PAssert(4018,item,"Must have found a valid item")}catch(PERR){g.reportError(PERR)}return item?this.heightOfItem(item,overview):0},heightOfItem:function heightOfItemFn(item,overview){try{g.PAssert(4019,item,"Must provide a valid item to measure")}catch(PERR){g.reportError(PERR)}if(item.heightInPane)return item.heightInPane(this,overview);try{g.PAssert(4020,!1,"Should have heightInPane defined")}catch(PERR){g.reportError(PERR)}return 0},getPaneDoc:function getPaneDocFn(){return g.vmMain.docManager.getOpenDoc()},getStatusMessage:function getStatusMessageFn(overview){var msg;return overview?0===this.headers.length()&&(msg=this.overviewEmptyMessage):this.isLoading.get()?msg="Loading...":0===this.numItems()?msg=this.isSearched()?this.paneEmptySearchMessage:this.paneEmptyMessage:this.isReady.get()||(msg=this._getNotReadyStatus()),msg},_getNotReadyStatus:function _getNotReadyStatusFn(){return"Pane data is only available while online."},copyStateFrom:function copyStateFromFn(pane){this.getItem()!==pane.getItem()&&this.setItem(pane.getItem())},getSaveInfo:function getSaveInfoFn(){return{id:this.id,item:this.getItem().id,type:this.type,showarch:this.showArchived.get(),search:this.search.getState(),offset:this.getScrollOffset(),itemState:this.getSaveInfoItemState(),isOverviewVisible:!platform.mobile&&this.overview.isVisible.get(),isExpanded:this.isExpanded.get()}},getSaveInfoItemState:function getSaveInfoItemStateFn(){var state=this._perPaneState,collapsed=[],collapsedSearch=[],uncollapsed=[];for(var id in state)if(state.hasOwnProperty(id)){var item=d.getModel(id);if(item){var o=state[id];o[PerPaneStateField.Collapsed]&&collapsed.push(id),o[PerPaneStateField.CollapsedSearch]&&collapsedSearch.push(id),o[PerPaneStateField.Collapsed]===!1&&item.isDemandLoad()&&uncollapsed.push(id)}else delete state[id]}return{collapsed:collapsed.length>0?collapsed:void 0,collapsedSearch:collapsedSearch.length>0?collapsedSearch:void 0,uncollapsed:uncollapsed.length>0?uncollapsed:void 0}},getPerPaneState:function getPerPaneStateFn(id,field){return this._perPaneState[id]?this._perPaneState[id][field]:void 0},setPerPaneState:function setPerPaneStateFn(id,field,data){this._perPaneState[id]||(this._perPaneState[id]={}),this._perPaneState[id][field]=data},clearPerPaneStateSearch:function clearPerPaneStateSearchFn(){if(this.isSearched()){var list=this._perPaneState;for(var id in list)if(list.hasOwnProperty(id)&&void 0!==list[id][PerPaneStateField.CollapsedSearch]){var item=d.getModel(id);item&&(item.setCollapsed(!1,this,!1),list[id][PerPaneStateField.CollapsedSearch]=void 0)}}},deletePerPaneState:function deletePerPaneStateFn(id){this._perPaneState[id]=void 0},isSearched:function isSearchedFn(){try{g.PAssert(4021,this.search,"Pane must be initialized: ",this._destroyed)}catch(PERR){g.reportError(PERR)}return this.search?this.search.isSearched():!1},onSearchChanged:function onSearchChangedFn(){var isSelValid=Sel.isValid();if(isSelValid&&Sel.reset(),this.refreshSearchResults(),isSelValid&&this.numItems()>0){var firstIndex=this.indexOfFirstItem();
firstIndex>=0&&Sel.selectIndex(firstIndex,0)}g.vmMain.paneManager.updatePaneStateForPane(this)},refreshSearchResults:function refreshSearchResultsFn(){this.updateItems(!0)},_applyItemStateArr:function _applyItemStateArrFn(arr,field,value){if(arr)for(var i=0;i<arr.length;i++){var id=arr[i];this.setPerPaneState(id,field,value)}},applyItemState:function applyItemStateFn(itemState){itemState&&(this._applyItemStateArr(itemState.collapsed,PerPaneStateField.Collapsed,!0),this._applyItemStateArr(itemState.uncollapsed,PerPaneStateField.Collapsed,!1),this._applyItemStateArr(itemState.collapsedSearch,PerPaneStateField.CollapsedSearch,!0))},requestDemandLoadData:function requestDemandLoadDataFn(paneID,item){try{g.PAssert(4022,!1,"SubClass must override - by default demand load is not supported")}catch(PERR){g.reportError(PERR)}},requestDataPage:function requestDataPageFn(item){try{g.PAssert(4023,!1,"SubClass must override - by default data pagination is not supported")}catch(PERR){g.reportError(PERR)}},getDefaultDisplayItem:function getDefaultDisplayItemFn(){return this.getRootItem()},getRootItem:function getRootItemFn(){return g.vmMain.root.peek()},setRootItem:function setRootItemFn(item,notify){try{g.PAssert(4024,void 0===item.parent(),"Root should never have a parent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4025,this.getItem()!==item,"Should not be setting root to the same value")}catch(PERR){g.reportError(PERR)}this.setItem(item,notify)},onTapSection:function onTapSectionFn(e){g.vmMain.vmPicker.onTapSection(e)},scrollFromMousePosition:function scrollFromMousePositionFn(clientY){var scrollAreaSize=80,topMin=0,topMax=scrollAreaSize,bottomMax=this.getHeight(),bottomMin=bottomMax-scrollAreaSize,offsetY=clientY-this.contentTop(),speedMod=3,speed;topMax>offsetY?(speed=-(1-g.computeScrollSpeed(topMin,topMax,offsetY))*speedMod,g.repeatScroll(speed,this)):offsetY>=bottomMin?(speed=g.computeScrollSpeed(bottomMin,bottomMax,offsetY)*speedMod,g.repeatScroll(speed,this)):g.cancelRepeatScroll()},getContentElement:function getContentElementFn(){return this.paneContent},getPaneIcon:function getPaneIconFn(){return"icon-align-left"},itemHasChildren:function itemHasChildrenFn(){return this.getItem().numItems()>0},getItem:function getItemFn(){return this.item.get()},allowZoom:function allowZoomFn(item){return!0},performOverviewAction:function performOverviewActionFn(item){},setItem:function setItemFn(newItem,notify){this._numItemSets++;var oldItem=this.getItem();this.item.set(newItem,!1),this.updateItemsImmediate(!0),oldItem.parent()&&oldItem._updateStylePadding(oldItem.parent().levelsDeep.get(),!0),notify&&(newItem.itemChanged.notify(),newItem!==oldItem&&oldItem.itemChanged.notify(),this.item.notify(newItem,oldItem))},getItemSearchParams:function getItemSearchParamsFn(){return{item:this.getItem(),comparator:this.search.isMatched,noCollapsed:!0,includeNotes:!0,pane:this}},getHeaderSearchParams:function getHeaderSearchParamsFn(){return{item:this.getItem(),comparator:this.search.isMatched,noCollapsed:!0,collapseAfterDepth:1,headers:!0,overview:!0,pane:this}},setItemsDirty:function setItemsDirtyFn(){this.itemsDirtyState={updateSearch:!1,forceNotify:!1}},isItemsDirty:function isItemsDirtyFn(){return!!this.itemsDirtyState},updateItems:function updateItemsFn(updateSearch,forceNotify){this.itemsDirtyState={updateSearch:updateSearch,forceNotify:forceNotify},g.vmMain.updateAllItems()},updateItemsImmediate:function updateItemsImmediateFn(updateSearch,forceNotify){this.itemsDirtyState&&(updateSearch=updateSearch||this.itemsDirtyState.updateSearch,forceNotify=forceNotify||this.itemsDirtyState.forceNotify,this.itemsDirtyState=void 0),(updateSearch||this!==g.focusedPane&&!DragDrop.isDropping)&&this.search.update();var numComplete=0,rootItem=this.item.get(),arr=[],params=this.getItemSearchParams(),each=params.each;params.each=function(item){item.isNote()&&item.parent()===rootItem||(arr.push(item),each&&each(item),item.isComplete()&&!item.isArchived()&&numComplete++)},g.searchVMLIs(params),this.numCompleteItems.set(numComplete),this._numItemComputes++,this.setItems(arr,forceNotify),this.updateHeaders(forceNotify),this.isInitialized||(this.isInitialized=!0),Dispatcher.fireEvent("itemsUpdated",[this])},setItems:function setItemsFn(items,forceNotify){(forceNotify||!items.equals(this.items.get()))&&(this.items.set(items),Sel.getPane()===this&&Sel.checkValid())},updateHeaders:function updateHeadersFn(forceNotify){var headers=[];if(platform.mobile){var it=this.getItem();headers=it.parents().concat(it)}else headers=[];var params=this.getHeaderSearchParams();params.each=function(item){headers.push(item)},g.searchVMLIs(params),this._numHeaderComputes++,this.setHeaders(headers,forceNotify)},setHeaders:function setHeadersFn(headers,forceNotify){(forceNotify||!headers.equals(this.headers.get()))&&this.headers.set(headers)},clearItems:function clearItemsFn(notify){this.items.set([],notify)},onLoad:function onLoadFn(){this.isLoaded=!0,this.getItemStore()===g.vmMain.itemStoreManager.getDefaultItemStore()&&(Dispatcher.listen("itemNoteSet",this._infiniteList.handleItemNoteSet),Dispatcher.listen("itemTextChanged",this._infiniteList.handleItemTextChanged),Dispatcher.listen("itemBoldChanged",this._infiniteList.handleItemBoldChanged)),!platform.android&&!platform.mobileie||platform.script||android.setPaneRoot(this),requestAnimationFrame(this.onAfterLoaded.bind(this))},onAfterLoaded:function onAfterLoadedFn(){isNaN(this.initialOffset)&&(this.initialOffset=this.defaultOffset),0!==this.initialOffset&&this.setScrollOffset(this.initialOffset)},getSize:function getSizeFn(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function getWidthFn(){return!platform.mobile&&this.isExpanded.get()?C.GmailPaneMaxWidth:this.rect.get().width},getHeight:function getHeightFn(){var height=this.rect.get().height;return height-this.headerHeight()},toggleOverviewVisibility:function toggleOverviewVisibilityFn(){this.getOverview().toggleDesktop()},notifyDropFrom:function notifyDropFromFn(droppedItem){},notifyDropFromToEdit:function notifyDropFromToEditFn(droppedItem,dropElement){if(droppedItem.hasChildren()||droppedItem.hasAttachmentType(C.PluginType.Storage)){var attach=droppedItem.getAttachmentByType(C.PluginType.Storage);return attach.getPlugin().notifyDropFromToEdit(droppedItem,dropElement)}var insertData=document.createElement("ul");return insertData.innerHTML=d.toDropHtml(droppedItem),insertData},dropEffectCopyBehavior:function dropEffectCopyBehaviorFn(copyItem,targetItem){return copyItem.clone(targetItem,ChangeType.Local)},keydown:function keydownFn(e){if(e.handled)return!0;if(android.isEnabled()&&!android.passKeydown(e))return!0;if(Sel.isValid())if(g.autocomplete&&!g.autocomplete.onkeydown(e))e.preventDefault(),e.stopPropagation();else{platform.mobile||android.isEnabled()||0!==this.numItems()||g.hasClass(this.paneContent,"loading")||this.addItem(e);try{edit.keydown(this,e)||(e.preventDefault(),e.stopPropagation())}catch(err){g.reportError(err,e)}}},keypress:function keypressFn(e){if(Sel.isValid()){if(android.isEnabled()&&!android.passKeypress(e))return;try{edit.keypress(this,e)||(e.preventDefault(),e.stopPropagation())}catch(err){g.reportError(err,e)}}},keyup:function keyupFn(e){if(g.vmMain.notifyActivity(),Sel.isValid())try{edit.keyup(this,e)||(e.preventDefault(),e.stopPropagation())}catch(err){g.reportError(err,e)}},textInput:function textInputFn(e){if(!(platform.ios||platform.mac||platform.windows||platform.linux))return!0;try{return edit.textInputiOS(this,e)}catch(err){g.reportError(err,e)}},compositionStart:function compositionStartFn(){edit.isComposing=!0},compositionEnd:function compositionEndFn(e){if(edit.isComposing=!1,platform.isFirefox)try{edit.textInputiOS(this,e)}catch(err){g.reportError(err,e)}this.hiddenInput&&(this.hiddenInput.innerHTML=TextSpace)},setupContextMenu:function setupContextMenuFn(item,e){var contextMenu,srcElement=e.target,pluginElement=g.getPluginForElement(srcElement);if(pluginElement)contextMenu=g.vmMain.pluginManager.handleRightClick(item,e),contextMenu||(contextMenu=g.element(this.contextMenu));else if(g.hasClass(srcElement,"date")){var calendarPlugin=g.vmMain.getDefaultCalendarPlugin();calendarPlugin&&(contextMenu=calendarPlugin.getDateContextMenu(item)),contextMenu||(contextMenu=g.element("contextMenuItem"))}else contextMenu=g.element(g.hasClass(srcElement,"contact")?"contextMenuItem_Contact":item.isNote()?"contextMenuItem_Note":this.contextMenu);return contextMenu},addItemToPane:function addItemToPaneFn(text,index){var target=this.getItem();text||(text=""),tracker.beginAction();var item=d.createVMLI({text:text},{parent:target,changeType:ChangeType.AllLocal});return target.insertItem(item,index),tracker.performAction(TrackerType.Create,{itemID:item.id,parent:target.id,position:isNaN(index)?target.numItems()-1:index,text:text}),tracker.endAction(),item},runUnarchive:function runUnarchiveFn(item){var runSingle=function(node){node.isArchived()&&node.parent().unarchiveChild(node,ChangeType.Local)},ensureCollapseState=function(){if(item.hasArchivedAncestor())for(var collapseField=this.isSearched()?PerPaneStateField.CollapsedSearch:PerPaneStateField.Collapsed,ancestor=item.parent();void 0!==ancestor&&(void 0===this.getPerPaneState(ancestor.id,collapseField)&&ancestor.setCollapsed(!1,this,!1),!ancestor.isArchived());)ancestor=ancestor.parent()}.bind(this),optTree="Entire Tree",optSubtree="Entire Subtree",optSingle="Single Item";item.hasArchivedAncestor()?g.menus.options("An ancestor of this item is still archived. Which items do you want to unarchive?",[optTree,optSingle],function(selection){var isActionable=selection===optSingle||selection===optTree;isActionable&&(ensureCollapseState(),selection===optSingle?runSingle(item):selection===optTree&&g.vmMain.runFnOnSubtree(item.getArchivedAncestor(!0),runSingle))}):item.hasArchivedDescendant()?g.menus.options("Which items do you want to unarchive?",[optSubtree,optSingle],function(selection){var isActionable=selection===optSingle||selection===optSubtree;isActionable&&(ensureCollapseState(),selection===optSingle?runSingle(item):selection===optSubtree&&g.vmMain.runFnOnSubtree(item,runSingle))}):(ensureCollapseState(),runSingle(item)),Sel.reset()},archiveSelected:function archiveSelectedFn(){var numChanged=0,selectIndex=this.indexOfPrevVMLI(Sel.getStartIndex(),!0,!0);if(g.vmMain.applyToSelection(function(item){item.parent().archiveChild(item,ChangeType.Local)&&numChanged++}.bind(this)),numChanged>0){if(0>selectIndex&&this.numItems()>0&&(selectIndex=this.indexOfFirstItem()),selectIndex>=0){var selectItem=this.itemAtIndex(selectIndex),selectOffset=selectItem.getParsedText().length;Sel.selectIndex(selectIndex,selectOffset)}var z=numChanged>1?" items.":" item.";g.toasts.pushMessage({text:"Archived "+numChanged+z,action:MessageAction.Undo,hold:platform.mobile,timeout:platform.mobile?void 0:8e3})}},deleteSelected:function deleteSelectedFn(comparator,value){var selectIndex=this.indexOfPrevVMLI(Sel.getStartIndex(),!0,!0);if(g.vmMain.applyToSelection(function(item){(!comparator||comparator(item))&&item.deleteSelf(ChangeType.Local)}),0>selectIndex&&this.numItems()>0&&(selectIndex=this.indexOfFirstItem()),selectIndex>=0){var selectItem=this.itemAtIndex(selectIndex);if(selectItem){var selectOffset=selectItem.getParsedText().length;Sel.selectIndex(selectIndex,selectOffset)}else Sel.reset()}},handleRightSideTap:function handleRightSideTapFn(item){this.supportCompleting&&item.isComplete(!item.isComplete(),ChangeType.Local)},onClickTitle:function onClickTitleFn(e,item){var parents=this.getItem().parents();return 0===parents.length?void(this.isOverviewVisible()&&this.toggleOverviewVisibility()):(g.vmMain.zoomout(item),void g.sendEvent("Menu","Title"))},onDoubleClickTitle:function onDoubleClickTitleFn(e,item){this.toggleCollapseAll()},onTap:{onStart:function onStartFn(e){if(this._disableClick)return void e.preventDefault();var target;if(platform.mobile&&(android.isEnabled()&&android.isTargetBox(e)||e.preventDefault(),g.touchHoldTimeout&&clearTimeout(g.touchHoldTimeout),MobileUI.isInMultiselect()||this.useCustomScroller&&this.getiScroller()&&this.getiScroller().moved||(target=g.dataFor(e.target,!0),target&&target!==this&&(g.touchHoldTimeout=setTimeout(this.onTouchHoldTimeout,g.isKeyboardOpen?g.iOSDragTimeKeyboardOpen:g.iOSDragTime,e)))),!platform.mobile||!MobileUI.start(e)){if(Sel.setFocusedPane(this),!this.useCustomScroller&&platform.isTouchDevice&&platform.mobile&&!platform.app&&(!platform.ie||platform.mobileie)&&!g.preventScrollPropagation(this.scrollElement))return e.preventDefault(),!1;android.isEnabled()&&android.isTargetBox(e)||(target=g.dataFor(e.srcElement,!0),platform.mobile&&target===this&&(target=g.focusedPane.getLastItem()),target&&target.onStart&&target.onStart(e))}},onMove:function onMoveFn(e){if(platform.mobile&&g.touchHoldTimeout&&(clearTimeout(g.touchHoldTimeout),g.touchHoldTimeout=void 0),g.autocomplete&&platform.mobile&&g.autocomplete.hide(),!(android.isEnabled()&&android.isTargetBox(e)||platform.mobile&&MobileUI.update(e))){var target=g.dataFor(e.startSrc,!0),onPane=!1;platform.mobile&&target===this&&(target=g.focusedPane.getLastItem(),onPane=!0),DragDrop.isDragging&&(target=DragDrop.dragItem),target&&target.onMove&&target.onMove(e,onPane)}return!1},onClick:function onClickFn(e){if(!(platform.mobile&&MobileUI.onClick(e)||android.isEnabled()&&android.isTargetBox(e))){var target=g.dataFor(e.startSrc,!0),index;platform.mobile&&target===this&&g.hasClass(e.startSrc,"paneScroller")&&(target=g.focusedPane.getLastItem(),index=g.focusedPane.numItems()-1,(target&&e.clientX<target.getPadding(this)||e.clientX>this.getWidth()-g.SPThresholdRight)&&(target=void 0)),target&&(e.targetItem=target),g.hasClass(e.startSrc,"addItemButton")?this.onTapAddItem(e):target&&target.onClick?(void 0===index&&(index=g.getIndexForElement(e.startSrc)),this.onClickItem(index,target,e)):(this.addIfEmpty(e),g.hasClass(e.startSrc,"paneDataPageLoad")||e.startSrc.parentElement&&g.hasClass(e.startSrc.parentElement,"paneDataPageLoad")?this.getItem().hasPaginationToken()&&this.requestDataPage(this.getItem()):e.preventDefault())}},onEnd:function onEndFn(e){if(platform.mobile&&g.touchHoldTimeout&&(clearTimeout(g.touchHoldTimeout),g.touchHoldTimeout=void 0),platform.mobile&&MobileUI.end(e),!(platform.mobile&&this.isOverviewVisible()||android.isEnabled()&&android.isTargetBox(e))){var target=e.targetItem||g.dataFor(e.startSrc,!0);if(platform.mobile&&target===this&&(target=g.focusedPane.getLastItem()),DragDrop.isDragging&&(target=DragDrop.dragItem),!target)return;"paneContent"===e.startSrc.id&&e.preventDefault(),target&&target.onEnd&&target.onEnd(e)}},onDoubleClick:function onDoubleClickFn(e){var target=g.dataFor(e.startSrc,!0);if(target&&target.onDoubleClick){var index=g.getIndexForElement(e.startSrc);this.onDoubleClickItem(index,target,e)}},onRightClick:function onRightClickFn(e){if(!g.isDisplayModeActive(DisplayMode.NoRightClick)){if(Sel.setFocusedPane(this),this.addIfEmpty(e),!android.isEnabled()||!android.isTargetBox(e)){var target=g.dataFor(e.target,!0);if(target&&target.onRightClick){var index=g.getIndexForElement(e.target);this.onRightClickItem(index,target,e)}}tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.RightClick,data:{element:void 0,pane:this}})}}},onClickItem:function onClickItemFn(index,item,e){item.onClick(index,e)},onRightClickItem:function onRightClickItemFn(index,item,e){item.onRightClick(index,e)},onDoubleClickItem:function onDoubleClickItemFn(index,item,e){item.onDoubleClick(index,e)},addIfEmpty:function addIfEmptyFn(e){this.isWriteable&&0===this.numItems()&&this.canAddItem&&!g.hasClass(this.paneContent,"loading")&&this.addItem(e)},addItem:function addItemFn(e){Sel.reset(),this.addItemToPane("",0);var pane=g.focusedPane;if(platform.mobileie&&android.isEnabled())android.updateInput(0);else if(pane&&pane.paneContent){Sel.focusPane(pane);var firstIndex=pane.indexOfFirstItem();firstIndex>=0&&Sel.selectIndex(firstIndex,0,0)}platform.mobile&&e&&g.openKeyboardOnIndex(e,pane,0,function(){pane.onFocus()},function(){pane.onBlur()}),g.sendEvent("Menu","AddItemButton")},onClose:function onCloseFn(){},onTapAddItem:function onTapAddItemFn(e){platform.mobile&&this.isOverviewVisible()||(Sel.setFocusedPane(this),this.getScrollOffset()>this.topBoxHeight.get()?this.setScrollOffset(0,ScrollDuration.Default,function(){this._infiniteList.saveScrollOfTop(),this.onTapAddItem(e)}.bind(this)):this.addItem(e))},onTapOverviewButton:function onTapOverviewButtonFn(){this.toggleOverviewVisibility(),this.isOverviewVisible()?g.sendEvent("Menu","OpenOverview"):g.sendEvent("Menu","CloseOverview")},onTapClosePane:function onTapClosePaneFn(){var removedID=g.vmMain.paneManager.removePane(this);if(removedID){try{g.PAssert(4028,removedID===this.id,"Pane IDs must match")}catch(PERR){g.reportError(PERR)}tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:removedID}),g.sendEvent("Menu","ClosePane"),g.tooltip.hideTip(),this.onClose()}},onTapArchiveCompleted:{onStart:function onStartFn(e){e.stopImmediatePropagation()},onClick:function onClickFn(e){this.archiveCompleted(),g.handlerPreventStop(e),g.sendEvent("Menu","ArchiveCompleted")}},onTapRefreshData:{onStart:function onStartFn(e){e.stopImmediatePropagation()},onClick:function onClickFn(e){try{g.PAssert(4029,this.supportDataRefresh,"How did this pane try to perform a data refresh if it is not supported",this.type)}catch(PERR){g.reportError(PERR)}this.refreshPaneData(),g.sendEvent("Menu","PaneDataRefresh"),g.handlerPreventStop(e)}},onTapReportError:{onStart:function onStartFn(e){e.stopImmediatePropagation()},onClick:function onClickFn(e){try{g.PAssert(4030,this.supportReportError,"Pane does not support error reporting")}catch(PERR){g.reportError(PERR)}this.reportPaneError(),g.sendEvent("Menu","PaneReportError"),g.handlerPreventStop(e)}},archiveCompleted:function archiveCompletedFn(){var nextSelObject,i,item;if(Sel.isValid())for(i=Sel.getEndIndex();i<this.items.length();){if(item=this.itemAtIndex(i),item&&!this.itemAtIndex(i).hasCompletedAncestor()){nextSelObject=this.objectAtIndex(i);break}i++}var archivedItems=[];for(i=0;i<this.numItems();++i)item=this.itemAtIndex(i),item&&item.isComplete()&&!item.isNote()&&archivedItems.push(item);for(tracker.beginAction(),g.vmMain.beginUpdateItems(),i=archivedItems.length-1;i>=0;i--)item=archivedItems[i],item.parent().archiveChild(item,ChangeType.Local);if(g.vmMain.commitUpdateItems(),tracker.endAction(),archivedItems.length>0){var z=archivedItems.length>1?" items.":" item.";g.toasts.pushMessage({text:"Archived "+(archivedItems.length+z),action:MessageAction.Undo,hold:platform.mobile,timeout:platform.mobile?void 0:8e3})}else g.toasts.pushMessage({text:"No completed items to archive"});if(!platform.mobile&&nextSelObject){var index=this.indexOfObject(nextSelObject);if(index>=0){item=this.itemAtIndex(index);try{g.PAssert(4031,item,"Could not restore selection to item")}catch(PERR){g.reportError(PERR)}if(item){var offset=item.getParsedText().length;Sel.selectIndex(index,offset)}}}else Sel.reset()},onTapViewArchived:function onTapViewArchivedFn(){},updatePosition:function updatePositionFn(x,animate){this.isAnimatingOffset=animate,x=Math.round(x),this.offsetX.set(x)},updatePositionMobile:function updatePositionMobileFn(){this.updatePosition(this.isOverviewVisible()?this.overviewWidth:0)},overviewWidth:function overviewWidthFn(){return platform.windowWidth()*C.MobileOverviewWidth},bottomListMessage:function bottomListMessageFn(){return void 0},isSearchingRemote:function isSearchingRemoteFn(){return!1},getTitleList:function getTitleListFn(){return this.getItem().parents().concat(this.getItem())},itemTitle:function itemTitleFn(){return this.getItem().parent()?this.getItem().getParsedText():this.titleOfFirstItem},onShowArchivedChanged:function onShowArchivedChangedFn(){this.showArchived.get()&&Dispatcher.fireEvent("showArchived",[]),this.updateItems()},indexOfFirstItem:function indexOfFirstItemFn(){return this.indexOfNextVMLI(-1)},indexOfLastItem:function indexOfLastItemFn(){return this.indexOfPrevVMLI(this.numItems(),!1,!0)},getFirstItem:function getFirstItemFn(){var index=this.indexOfFirstItem();if(index>=0){var obj=this.getItems()[index];return obj&&(this.itemsAreObjects?obj.item:obj)}},getLastItem:function getLastItemFn(){var obj=this.getItems()[this.indexOfLastItem()];return obj&&(this.itemsAreObjects?obj.item:obj)},onBlur:function onBlurFn(){this.isFocused&&this.blurTrigger.notify(),this.isFocused=!1},onFocus:function onFocusFn(){this.isFocused||this.focusTrigger.notify(),this.isFocused=!0},focus:function focusFn(){this.paneContent.focus(),this.onFocus(!0)},headerHeight:function headerHeightFn(){return platform.mobile?0:76},handleUndo:function handleUndoFn(){tracker.undoAction()},handleRedo:function handleRedoFn(){tracker.redoAction()},contentTop:function contentTopFn(){return g.paneTop+this.headerHeight()},indexPageUp:function indexPageUpFn(index){var list=this._infiniteList;return index=list.indexPageUp(index),this.itemAtIndex(index)||(index=this.indexOfNextVMLI(index)),index},indexPageDown:function indexPageDownFn(index){var list=this._infiniteList;return index=list.indexPageDown(index),this.itemAtIndex(index)||(index=this.indexOfPrevVMLI(index)),index},adjustSelectionFromPaneObject:function adjustSelectionFromPaneObjectFn(sel){try{g.PAssert(4032,sel,"Must pass in a valid saved selection")}catch(PERR){g.reportError(PERR)}var adjustedSelection=sel;return sel.startItem&&sel.endItem&&(sel.startIndex=this.indexOfObject(sel.startObject),sel.endIndex=this.indexOfObject(sel.endObject),(sel.startIndex<0||sel.endIndex<0)&&(adjustedSelection=void 0)),adjustedSelection},maxWidthOfItem:function maxWidthOfItemFn(item,isOverview){var spanWidth,padding;try{g.PAssert(4033,this.getWidth()>0,"Must have a valid pane width")}catch(PERR){g.reportError(PERR)}isOverview&&platform.mobile?(padding=this.getPaddingForItem(item,isOverview),spanWidth=this.getWidth()*g.overviewWidthPerc-padding-g.scrollbarWidth):(padding=this.getPaddingForItem(item,isOverview),spanWidth=this.getWidth()-padding-g.SPThresholdRight);try{g.PAssert(4034,g.isNumber(spanWidth)&&spanWidth>0,"Must have a valid spanWidth: "+spanWidth)}catch(PERR){g.reportError(PERR)}return spanWidth},restoreSelection:function restoreSelectionFn(saved){try{g.PAssert(4035,saved,"Must always have a valid saved selection")}catch(PERR){g.reportError(PERR)}if(saved){var newStart=this.indexOfObject(saved.startObject),newEnd=this.indexOfObject(saved.endObject);if(newStart>=0&&newEnd>=0){var newStartOffset=saved.startOffset,newEndOffset=saved.endOffset,startText=saved.startItem.getParsedText(),endText=saved.endItem.getParsedText();(0>newStartOffset||newStartOffset>startText.length||0>newEndOffset||newEndOffset>endText.length)&&(newStartOffset=-1,newEndOffset=-1),Sel.selectIndices(newStart,newStartOffset,newEnd,newEndOffset)}else Sel.reset()}else Sel.reset()},restoreSelectionAfterCollapse:function restoreSelectionAfterCollapseFn(saved,collapsed){if(saved){var startItem=saved.startItem,startIndex=this.indexOfItem(saved.startItem),endIndex=this.indexOfItem(saved.endItem),item,changedSel;if(startIndex>=0&&endIndex>=0)Sel.selectIndices(startIndex,saved.startOffset,endIndex,saved.endOffset),item=saved.startItem;else if(startIndex>=0)Sel.selectIndex(startIndex,saved.startOffset),item=saved.startItem,changedSel=!0;else if(endIndex>=0)Sel.selectIndex(endIndex,saved.endOffset),item=saved.endItem,changedSel=!0;else if(collapsed===!0)for(item=startItem;item;){var parent=item.parent();if(parent===g.focusedPane.item.get()){Sel.selectItem(item,item===startItem?Sel.getStartOffset():-1),changedSel=!0;break}item=parent}else Sel.reset();item&&changedSel&&g.focusedPane.scrollItemToMiddle(item,ScrollDuration.Snap)}},toggleCollapseAll:function toggleCollapseAllFn(){if(this.supportCollapsing){var rootItem=this.item.get(),numChildren=rootItem.numChildren(),children=rootItem.getItems(),savedSel=Sel.save();g.vmMain.beginUpdateItems();for(var doCollapse=!this.hasCollapsed(),i=0;numChildren>i;++i){var child=children[i];this.search.isMatched(child)&&child.hasChildren()&&child.setCollapsed(doCollapse,g.focusedPane,!1)}g.vmMain.commitUpdateItems(),this.restoreSelectionAfterCollapse(savedSel,doCollapse)}},hasCollapsed:function hasCollapsedFn(){for(var rootItem=this.item.get(),numChildren=rootItem.numChildren(),children=rootItem.getItems(),i=0;numChildren>i;++i){var child=children[i];if(this.search.isMatched(child)&&child.hasChildren()&&child.isCollapsed(this,!1))return!0}return!1},onOverviewToggled:function onOverviewToggledFn(isVisible){this.useCustomScroller&&(isVisible?this.getiScroller().disable():(this.getiScroller().enable(),this._disableClick=!1))},onTouchHoldTimeout:function onTouchHoldTimeoutFn(e){g.touchHoldTimeout=void 0,g.isKeyboardOpen&&!this.isOverviewVisible()&&this.useCustomScroller&&this.getiScroller().disable(),MobileUI.disable(),Dispatcher.fireEvent("touchHoldTimeout",[e])},getPaddingForItem:function getPaddingForItemFn(item,overview){var value=item.getPadding(this,overview);return value>this.getWidth()-g.SPThresholdRight&&(value=this.getWidth()-g.SPThresholdRight-8),value},getSpanWidthForItem:function getSpanWidthForItemFn(item){return item.getSpanWidth(this)},indexOfPrevVMLI:function indexOfPrevVMLIFn(index,noSameVMLI,noNote){try{g.PAssert(4036,index>=0,"Must supply a valid selection index: "+index)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4037,index<this.numItems()+1,"Must supply a valid selection index: "+index)}catch(PERR){g.reportError(PERR)}if(this.itemsAreObjects){for(var origItem=noSameVMLI?this.itemAtIndex(index):void 0,i=index-1;i>=0;){var item=this.itemAtIndex(i);if(item&&origItem!==item)return i;i--}return-1}var ret=index>0?index-1:-1;if(noNote&&ret>=0){var prevCandidate=this.itemAtIndex(ret);prevCandidate.isNote()&&(ret>=1?ret--:ret=-1)}return isNaN(ret)?-1:ret},indexOfNextVMLI:function indexOfNextVMLIFn(index,noSameVMLI,noNote){try{g.PAssert(4038,index>=-1,"Must supply a valid selection index: "+index)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4039,index<this.numItems(),"Must supply a valid selection index: "+index)}catch(PERR){g.reportError(PERR)}if(this.itemsAreObjects){for(var origItem=noSameVMLI?this.itemAtIndex(index):void 0,i=index+1;i<this.numItems();){var item=this.itemAtIndex(i);if(item&&origItem!==item)return i;i++}return-1}var ret=index<this.numItems()-1?index+1:-1;if(noNote&&ret>=0){var nextCandidate=this.itemAtIndex(ret);nextCandidate.isNote()&&(ret<this.numItems()-1?ret++:ret=-1)}return isNaN(ret)?-1:ret},_getPrevNextItem:function _getPrevNextItemFn(index,sameLevel,next){var incFn=next?this.indexOfNextVMLI:this.indexOfPrevVMLI,newIndex=incFn.call(this,index);if(sameLevel)for(var item=this.itemAtIndex(index);newIndex>=0;){var newItem=this.itemAtIndex(newIndex);if(item.parent()===newItem.parent())return newItem;if(item.parent()===newItem||newItem.parent()===item.parent().parent()){newIndex=-1;break}newIndex=incFn.call(this,newIndex)}else if(newIndex>=0)return this.itemAtIndex(newIndex)},getPreviousItem:function getPreviousItemFn(index,sameLevel){return this._getPrevNextItem(index,sameLevel,!1)},getNextItem:function getNextItemFn(index,sameLevel){return this._getPrevNextItem(index,sameLevel,!0)},applyToSelection:function applyToSelectionFn(fn,options){g.vmMain.applyToSelection(fn,options)},applyPriorityToSelection:function applyPriorityToSelectionFn(pri,toggle){toggle?g.vmMain.applyFnToSelection("priority",{toggle:!0,value:pri,value2:ChangeType.Local,emptyValue:VMLIFlag.None}):g.vmMain.applyFnToSelection("priority",{value:pri,value2:ChangeType.Local})},autocompleteTag:function autocompleteTagFn(){var params={mode:"tag",text:"Add tag",buttonText:"Add"};this._autocompletePopup(params,function(item,result){var tag=result.value.trim(),text=item.getParsedText()+" "+TagPrefix+tag;item.setText(text,!0,ChangeType.Local)}.bind(this))},autocompleteDate:function autocompleteDateFn(){var params={mode:"date",text:"Choose date",buttonText:"Schedule"};this._autocompletePopup(params,function(item,result){var date=result.value.trim(),text=item.getParsedText()+" "+DatePrefix+date;item.setText(text,!0,ChangeType.Local)})},autocompleteMove:function autocompleteMoveFn(params,cb){params=params||{},params.mode="move",params.text="Select item to move to",params.buttonText="MOVE",this._autocompletePopup(params,function(movingItem,result){var target;result.subItemText?(target=d.createVMLI({text:result.subItemText},{parent:result.item,changeType:ChangeType.AllLocal}),result.item.insertItem(target,0)):result.item===movingItem||result.item.isDescendantOf(movingItem)||(target=result.item),target&&this._moveItem(movingItem,target)}.bind(this),function(){cb&&cb(),Sel.updateCaret()}.bind(this))},autocompleteSnooze:function autocompleteSnoozeFn(params,accountID,doneCB){var displayError=function(){var element=params&&params.elementDisplay;if(!element){var index=Multiselect.getFirstSelectedIndex(this);element=this.elementAtIndex(index)}g.menus.openContextMenuReact({componentName:"ReactContextMenuAuthorize",element:element,message:"Snooze requires server access to your account so Moo.do can manage your inbox while you're not around. Please enable Offline Features to enable Snooze."})}.bind(this),allowSnooze=g.settings.get(Settings.enableOfflineAuth);if(AccountManager.isConnected())if(allowSnooze){g.toasts.clearMessage(MessageID.SnoozeOffline),params=params||{},params.mode="snooze",params.text="Snooze until date",params.buttonText="SNOOZE",params.allowCustom=!0;var plugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);this._autocompletePopup(params,function(movingItem,result){plugin.beginAction();var dateStr=result.value.trim(),date=Date.parse(dateStr),attach=movingItem.getAttachments()[0];try{g.PAssert(4040,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}if(g.isDateValid(date))if(AccountManager.isLinkedAccountAuthorized(attach.getField("accountID"),GScope.GmailModify)){var delay=date.getTime()-Date.now();plugin.performAction(C.PluginAction.Gmail.Snooze,!1,attach,delay)}else g.menus.closeContextMenuReact(),displayError();else g.toasts.pushMessage({text:"Unable to read date. Please try a different option.",action:MessageAction.Okay});plugin.endAction()}.bind(this),doneCB)}else displayError();else g.toasts.pushMessage(MessageID.SnoozeOffline)},autocompleteSchedule:function autocompleteScheduleFn(params,doneCB){params=params||{},params.mode="date",params.text="Add event on date",params.buttonText="Add",params.allowCustom=!0;var plugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);this._autocompletePopup(params,function(scheduleItem,result){tracker.beginAction();var dateStr=result.value.trim(),date=Date.parse(dateStr);g.isDateValid(date)?plugin.scheduleEmail(scheduleItem,date):g.toasts.pushMessage({text:"Unable to read date. Please try a different option.",action:MessageAction.Okay}),tracker.endAction()}.bind(this),doneCB)},autocompleteLabel:function autocompleteLabelFn(params,removedCB){var plugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail),attach;if(params=params||{},!params.tokens){attach=EmailPreview.getThreadAttach();var itemTags=attach.getPlugin().getDisplayTags(attach)||[];params.tokens=(itemTags||[]).map(function(tag){return{text:tag}})}params.mode="gmailLabel",params.text="Select a label",params.buttonText="LABEL",params.allowCustom=!0,params.allowEmpty=!0,params.onTokenRemoved=removedCB,this._autocompletePopup(params,function(item,result){var tag=result.value.trim();try{g.PAssert(4041,item.hasPluginAttachment(plugin.id),"Must have valid plugin attachment")}catch(PERR){g.reportError(PERR)}attach=item.getAttachments()[0];var labelName=plugin.createLabelString(tag);labelName&&(plugin.attachmentHasLabel(attach,labelName)||plugin.performAction(C.PluginAction.Gmail.AddLabel,!1,attach,labelName))}.bind(this))},_autocompletePopup:function _autocompletePopupFn(params,itemCB,doneCB){if(!params.elementDisplay){var index=Sel.getStartIndex(),element=this.elementAtIndex(index);
params.elementDisplay=element}params.onSelected=function(p){g.vmMain.applyToSelection(function(item){itemCB(item,p)}),doneCB&&doneCB()}.bind(this),Autocomplete.showPopup(params)},_moveItem:function _moveItemFn(item,target){g.vmMain.beginUpdateItems(),target.belongsToSameItemStore(item)&&item.moveTo({parent:target,index:0},ChangeType.Local),g.vmMain.commitUpdateItems()},setPropDefault:function setPropDefaultFn(name,value){void 0===this[name]&&(this[name]=value)},setExpanded:function setExpandedFn(value){var isChanged=this.isExpanded.get()!==value;this.isExpanded.set(value),isChanged&&(Dispatcher.fireEvent("panesChanged",[]),g.vmMain.paneManager.updatePaneStateForPane(this),g.vmMain.paneManager.ensurePaneInView(this))},canAcceptDragOver:function canAcceptDragOverFn(fromPane,item,eventTarget,overview){return this.isDropTarget},handleDragOver:function handleDragOverFn(fromPane,item,target,x,y){var li=g.getElementParent(target),targetItem=li&&g.getItemForElement(li),dragInfo;return li&&g.findParent(li,"overviewList")?(this.overview.updateDragHoverItem(targetItem),dragInfo={overview:!0,targetItem:targetItem,targetElement:li}):(this.overview.updateDragHoverItem(null),dragInfo=this._handleDragOverPane(fromPane,item,target,li,targetItem,x,y)),dragInfo},_handleDragOverPane:function _handleDragOverPaneFn(fromPane,item,target,li,targetItem,x,y){var found=!1,highlightAbove=!1,dropOnPane=!1,linePosition,targetElement,el;if(targetItem){targetItem.isNote()&&(targetItem=targetItem.parent());var box=li.getBoundingClientRect(),boxMid=box.top+box.height/2;highlightAbove=boxMid>y,targetElement=li,found=!0}else if(0===this.numItems())targetItem=this.getItem(),dropOnPane=!0;else if(platform.mobile||g.findParent(target,"paneScroller")){var lastIndex=this.indexOfLastItem();if(!found&&lastIndex>=0&&this.isIndexMounted(lastIndex)&&(el=this.elementAtIndex(lastIndex),y>el.getBoundingClientRect().bottom)){var lastItem=this.getLastItem();targetItem=lastItem,targetElement=el,highlightAbove=!1,found=!0}}if(!found){var firstIndex=this&&this.indexOfFirstItem();if(this&&firstIndex>=0&&this.isIndexMounted(firstIndex)&&(el=this.elementAtIndex(firstIndex),y<el.getBoundingClientRect().top)){var firstItem=this.getFirstItem();targetItem=firstItem,targetElement=el,highlightAbove=!0,found=!0}}if(found){var rect=targetElement.getBoundingClientRect(),yLine=highlightAbove?rect.top:rect.bottom;if(yLine>this.contentTop()){var xPadding=this.getPaddingForItem(targetItem),xLine=rect.left+xPadding,width=rect.right-rect.left-xPadding;linePosition={left:xLine,top:yLine,width:width}}}return this.scrollFromMousePosition(y),{above:highlightAbove,targetElement:targetElement,targetItem:targetItem,linePosition:linePosition,overview:!1,dropOnPane:dropOnPane}},handleDragDrop:function handleDragDropFn(item,e,dragInfo,isNew){dragInfo&&item!==dragInfo.targetItem&&dragInfo.targetItem&&this._handleDragDrop(item,e,dragInfo,isNew),this.revertDrag()},_handleDragDrop:function _handleDragDropFn(item,e,dragInfo,isNew){for(var isOverview=dragInfo.overview,isOK=!0,targetItem=dragInfo.targetItem,parent=targetItem.parent();parent&&isOK;)parent===item&&(isOK=!1),parent=parent.parent();if(isOK){var itemIndex=this.indexOfItem(item);if(itemIndex>=0&&this.getNextItem(itemIndex)===targetItem&&dragInfo.above&&(isOK=!1),isOK){var target,targetIndex=-1;if(isOverview)target=targetItem,targetIndex=target.numChildren();else if(dragInfo.dropOnPane)target=targetItem,targetIndex=0;else if(dragInfo.above)target=targetItem.parent(),targetIndex=targetItem.getIndex();else{var targetIndexInPane=this.indexOfItem(targetItem),nextItem=this.getNextItem(targetIndexInPane);nextItem&&nextItem.parent()===targetItem?(target=targetItem,targetIndex=0):(target=targetItem.parent(),targetIndex=targetItem.getIndex()+1)}tracker.beginAction();try{g.PAssert(4042,target,"Trying to move without a target")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4043,!isNaN(targetIndex),"Trying to move without a target index")}catch(PERR){g.reportError(PERR)}var performedDrop=!0;if(e.dataTransfer.dropEffect===C.DropEffect.Move){var previousParent=item.parent(),previousIndex=item.getIndex();previousParent.belongsToSameItemStore(target)?(item.moveTo({parent:target,index:targetIndex},ChangeType.Local),tracker.performAction(TrackerType.Move,{itemID:item.id,oldParent:previousParent.id,oldPosition:previousIndex,newParent:target.id,newPosition:targetIndex})):(item=item.clone(target,ChangeType.Local),target.insertItem(item,targetIndex),previousParent.removeChildAtIndex(previousIndex,ChangeType.Local))}else isNew||(item=e.dataTransfer.pane?e.dataTransfer.pane.dropEffectCopyBehavior(item,target):item.clone(target,ChangeType.Local)),item?(item.parent(target),target.insertItem(item,targetIndex)):performedDrop=!1;tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DropItem,data:{itemID:item.id,toPane:this,fromPane:e.dataTransfer.pane}}),tracker.endAction(),performedDrop&&e.dataTransfer.pane&&e.dataTransfer.pane.notifyDropFrom(item,this)}}},revertDrag:function revertDragFn(){this.overview&&this.overview.updateDragHoverItem(null)},isItemHeader:function isItemHeaderFn(item,overview){return overview?item.hasHeaderChildren():item.hasVisibleChildren(this)},onNotePopupClosed:function onNotePopupClosedFn(){},openNoteContextMenu:function openNoteContextMenuFn(){var note=Sel.getStartItem(),index=Sel.getStartIndex(),itemIndex=index-1,selectionStart=Sel.getStartOffset(),selectionEnd=Sel.getEndOffset(),element=this.elementAtIndex(index);if(element){try{g.PAssert(4044,element.firstChild,"Opening a note should have a firstChild",g.getElementPath(element))}catch(PERR){g.reportError(PERR)}element.firstChild&&(element=element.firstChild),void 0!==selectionStart&&void 0===selectionEnd&&(selectionEnd=selectionStart);var params={componentName:"ReactNotePopup",onClosed:this.onNotePopupClosed.bind(this),element:element,note:note,pane:this,index:index,position:"fill",selectionStart:selectionStart,selectionEnd:selectionEnd};if(g.menus.isContextMenuOpen()&&g.menus.closeContextMenuReact(),Sel.clearSelection(!0),platform.mobile){this._editingNote={note:note,index:index,itemIndex:itemIndex};var item=note.parent();params.bottom=platform.getKBSize(),params.autocompleteOffset={top:-12},this.scrollItemToTop(item,0,function(){g.menus.openContextMenuReact(params,!0),MobileUI.setTopBarMode(C.TopBarMode.Note)})}else params.autocompleteOffset={left:-4,top:-18},g.menus.openContextMenuReact(params);android.isEnabled()&&android.hideInput()}},closeNoteContextMenu:function closeNoteContextMenuFn(){if(g.menus.isContextMenuOpen()){if(platform.ios){var editing=this._editingNote,note=editing.note,index=editing.itemIndex,item=note.parent(),length=item.getParsedText().length;Sel.selectIndex(index,length),this._editingNote=void 0}g.menus.closeContextMenuReact()}},shouldShowHelp:function shouldShowHelpFn(){return!this.isDefaultPane&&!!g.intro.paneIntros[this.type]&&!g.intro.paneIntros[this.type].isComplete.get()},canResetMultiselect:function canResetMultiselectFn(){return!0},applyAgendaDropToItem:function applyAgendaDropToItemFn(agendaInfo,item){var a=agendaInfo;if(a.isDate){var isOK=!0;if(item.hasAttachmentType(C.PluginType.Calendar)){var attach=item.getAttachmentByType(C.PluginType.Calendar);attach&&attach.getField("recurringEventId")&&item.getCalendarParsedText()===attach.getField("summary")&&(g.toasts.pushMessage({text:"Moo.do does not currently support modifying repeated events.",actionText:"OKAY"}),isOK=!1)}if(isOK){var dateText="",itemDate=item.date();a.date&&(dateText+=a.date.toString("M/d"));var dateTime=a.dateTime||itemDate&&itemDate.hasTimeOfDay()&&itemDate;if(dateTime&&(dateText+=dateTime.toString(0===dateTime.getMinutes()?" h tt":" h:mm tt")),dateText){var text=item.getRawText(),durText=a.duration?" "+a.duration+"hr":"";if(dateText=dateText.toLowerCase()+durText,item.dateText){if(item.getDuration()){durText=item.getDurationText();var indexOfAt=text.indexOf(DatePrefix),indexOfDur=text.indexOf(durText,indexOfAt);text=text.substr(0,indexOfDur-1)+text.substr(indexOfDur+durText.length)}text=text.replace(item.dateText,dateText)}else text+=" "+DatePrefix+dateText;item.setText(text,!0,ChangeType.Local)}}}else{var pri;a.isStarred?item.isStarred(!0,ChangeType.Local):a.p0||a.isImportant?pri=VMLIFlag.P0:a.p1?pri=VMLIFlag.P1:a.p2&&(pri=VMLIFlag.P2),pri&&item.priority(pri,ChangeType.Local)}},setIgnoreRestoreScroll:function setIgnoreRestoreScrollFn(value){this._ignoreRestoreScroll=value},isIgnoringRestoreScroll:function isIgnoringRestoreScrollFn(){return this._ignoreRestoreScroll},zoomInOnSwipe:function zoomInOnSwipeFn(item){var prevItem=this.item.get();g.vmMain.zoomin(item),g.toasts.pushMessage({text:"<b>Zoomed in to:</b><br>"+item.getParsedText(),action:function actionFn(){g.vmMain.zoomin(prevItem)},hold:!1,actionText:"UNDO"})},getSwipeMenuItems:function getSwipeMenuItemsFn(){var _this=this;return{leftOuter:{icon:"icon-zoom-in",color:"#09d",fn:_this.zoomInOnSwipe},leftInner:{icon:function iconFn(item){return item.isCollapsible()?"icon-"+(item.isCollapsed(_this,!1)?"caret-down":"caret-right"):"icon-zoom-in"},color:function colorFn(item){return item.isCollapsible()?"#777":"#09d"},fn:function fnFn(item){item.isCollapsible()?(item.toggleCollapsed(_this),g.closeKeyboard()):_this.zoomInOnSwipe(item)}},rightInner:{icon:"icon-ok",color:"#0c0",fn:function fnFn(item){_this.supportCompleting&&item.isComplete(!item.isComplete(),ChangeType.Local)}},rightOuter:{icon:"icon-trash",color:"#a30",fn:function fnFn(item){item.deleteSelf(ChangeType.Local),g.toasts.pushMessage({text:"<b>Deleted:</b><br>"+item.getParsedText(),action:function actionFn(){tracker.undoAction()},hold:!1,actionText:"UNDO"})}}}},getSwipeMenuItem:function getSwipeMenuItemFn(item,x){var thresh=.125*platform.windowWidth(),menuItems=this.swipeMenuItems;return x>3*thresh?menuItems.leftOuter:x>thresh?menuItems.leftInner:3*-thresh>x?menuItems.rightOuter:-thresh>x?menuItems.rightInner:{color:"#ddd"}}},util.defineBase(VMPane),g.VMPane=VMPane,VMPane}),define("VMTimelineBlock",["globals","data","util","VMLI","International","Observable"],function(g,d,util,VMLI,International,Observable){function VMTimelineBlock(p){this.pane=p.pane,this.date=p.date,this.id=this.dateKey=p.dateKey,this.text=p.name,this.search=this.pane.search,this.items=[],this.isDate=p.isDate,this.isStarred=p.isStarred,this.isImportant=p.isImportant,this.isToday=p.isToday,this.isNow=p.isNow,this.isOverdue=p.isOverdue,this.emptyText=p.emptyText;try{g.PAssert(4045,this.id,"Added an agenda block without an id")}catch(PERR){g.reportError(PERR)}}return VMTimelineBlock.prototype={heightOfHeader:function heightOfHeaderFn(){return 44},heightOfTime:function heightOfTimeFn(){return 20},heightOfEmpty:function heightOfEmptyFn(){return 26},_formatDateTime:function _formatDateTimeFn(date){return date.toString(International.getFormat(DFormat.ShortTime))},showTime:function showTimeFn(index){var items=this.items,item=items[index];if(!this.isDate&&!items[0].isComplete())return!1;if(!items[0].hasTime()&&!items[0].isComplete())return!1;for(var previousVisible=index-1;previousVisible>0&&items[previousVisible].isNote();)previousVisible--;if(0>previousVisible)return!0;var prevItem=items[previousVisible];return!prevItem||this.getTime(item)!==this.getTime(prevItem)},_getDisplayDateWithDuration:function _getDisplayDateWithDurationFn(item){var date;return date=item.date().clone().clearTime().equals(this.date)?item.date():item.getEndDate().clone().clearTime().equals(this.date)?item.getEndDate():this.date},getTime:function getTimeFn(item){var timeString;if(item.dateCompleted)timeString=this._formatDateTime(item.dateCompleted);else if(item.date())if(item.date().hasTimeOfDay())if(item.getDuration()>0){var displayDate=this._getDisplayDateWithDuration(item);timeString=displayDate.equals(item.date())?this._formatDateTime(item.date()):displayDate.equals(item.getEndDate())?"Ends "+this._formatDateTime(item.getEndDate()):"All day"}else timeString=this._formatDateTime(item.date());else timeString="All day";else item.repeatDate()&&(timeString=item.repeatDate().hasTimeOfDay()?item.repeatDate().getTime(International.getFormat(DFormat.ShortTime)):"All day");return timeString},comparePriority:function comparePriorityFn(left,right){var lPri=left.priority(),rPri=right.priority();return lPri>rPri?-1:rPri>lPri?1:0},compareDate:function compareDateFn(left,right){var leftDate=left.date()||left.repeatDate()&&left.repeatDate().getStartDate(),rightDate=right.date()||right.repeatDate()&&right.repeatDate().getStartDate();if(left.isComplete()&&!right.isComplete())return-1;if(!left.isComplete()&&right.isComplete())return 1;if(left.isComplete()&&right.isComplete())return left.dateCompleted>right.dateCompleted?1:-1;if(leftDate&&!rightDate)return-1;if(!leftDate&&rightDate)return 1;if(!leftDate&&!rightDate)return 0;left.getDuration()>0&&(leftDate=this._getDisplayDateWithDuration(left)),right.getDuration()>0&&(rightDate=this._getDisplayDateWithDuration(right));var leftDay=leftDate.clone().clearTime(),rightDay=rightDate.clone().clearTime();if(!leftDay.equals(rightDay))return rightDay>leftDay?-1:1;if(leftDate.hasTimeOfDay()&&rightDate.hasTimeOfDay()){var leftTime=leftDate.getTimeOfDay(),rightTime=rightDate.getTimeOfDay();return leftTime===rightTime?0:rightTime>leftTime?-1:1}return leftDate.hasTimeOfDay()?-1:rightDate.hasTimeOfDay()?1:0},compareOrder:function compareOrderFn(left,right){return left.hasAttachments()&&!right.hasAttachments()?-1:right.hasAttachments()&&!left.hasAttachments()?1:-1},compareItems:function compareItemsFn(left,right){left.isNote()&&(left=left.parent()),right.isNote()&&(right=right.parent());var cDate=this.isStarred||this.isImportant?0:this.compareDate(left,right);if(0===cDate){var cPriority=this.isStarred?0:this.comparePriority(left,right);if(0===cPriority){var cOrder=this.compareOrder(left,right);return cOrder}return cPriority}return cDate},addItem:function addItemFn(item){try{g.PAssert(4048,item&&item instanceof VMLI,"Must be adding a valid item: "+g.getObjectInfo(item))}catch(PERR){g.reportError(PERR)}this.items.indexOf(item)<0&&this.items.insertSorted(item,this.compareItems.bind(this))},height:function heightFn(){var height=0,items=this.items;items.length>0&&(height+=44);for(var i=0;i<items.length;i++){var item=items[i];this.showTime(item,i)&&(height+=20),height+=item.heightInPane(this.pane)}return height}},VMTimelineBlock}),define("ObservableComputed",["require","exports","module","globals","util","Listener","Observable"],function(require,exports,module){function ObservableComputed(observables,fn,onUpdate){for(var onChanged=util.forceBind("onChanged",this),i=0;i<observables.length;i++)observables[i].listen(onChanged);fn&&g.isFunction(fn)?this.checkFn=fn:(this.observables=observables,this.checkFn="or"===fn?this.checkFnOr:this.checkFnAnd);var value=this.checkFn();this._super.constructor.call(this,value,onUpdate)}var g=require("globals"),util=require("util"),Listener=require("Listener"),Observable=require("Observable"),ObservableComputedFns={checkFnOr:function checkFnOrFn(){for(var ret=!1,i=0;!ret&&i<this.observables.length;i++)ret=ret||this.observables[i].get();return ret},checkFnAnd:function checkFnAndFn(){for(var ret=!0,i=0;ret&&i<this.observables.length;i++)ret=ret&&this.observables[i].get();return ret},onChanged:function onChangedFn(){var oldValue=this._value,value=this.checkFn();value!==oldValue&&this._super.set.call(this,value)}};return util.inherit(Observable,ObservableComputed),util.extend(ObservableComputed.prototype,ObservableComputedFns),ObservableComputed}),define("PaneObject",["require","exports","module","globals"],function(require,exports,module){function PaneObject(p){try{g.PAssert(4049,p.id&&p.type&&p.heightInPane,"Pane object missing properties")}catch(PERR){g.reportError(PERR)}for(var key in p)p.hasOwnProperty(key)&&(this[key]=p[key])}var g=require("globals");return PaneObject.prototype={},PaneObject}),define("VMPane_Timeline",["require","exports","module","globals","Constants","data","util","platform","DragDrop","VMTimelineBlock","RepeatDate","VMPane","Observable","ObservableComputed","International","Dispatcher","Sel","tracker","PaneObject"],function(require,exports,module){function VMPane_Timeline(p){var gcalPlugin=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar),isGCalActive=gcalPlugin.isActive()&&!g.isDemoMode();this.searchFilters=[{name:"gcal",initialValue:1,icon:"icon-calendar",matchFn:this._matchFnCal.bind(this),enabled:isGCalActive},"email","complete","starred","priority"],g.isDemoMode()&&this.searchFilters.remove("email"),this.type=PaneMode.Timeline,this.paneClass="paneAgenda",this.paneEmptyMessage="Nothing on the agenda",this.isWriteable=!0,this.isDropTarget=!platform.mobile,this.hasNonVMLIs=!0,this.canAddItem=!1,this.supportCollapsing=!1,this.supportCompleting=!0,this.supportIndent=!1,this.supportOffline=!0,this.supportVertLines=!1,this.supportMultiselect=!1,this.itemsAreObjects=!0,this.supportDataRefresh=isGCalActive,this.supportClickOverviewScroll=!1,this.titleOfFirstItem="Agenda",this.retainOverlayAfterDrop=new Observable(!1),this.dragHoveredBlock=new Observable,this.isShowingOverlay=platform.mobile?!1:new ObservableComputed([this.retainOverlayAfterDrop,DragDrop.isVisible],function(){return this.retainOverlayAfterDrop.get()||DragDrop.isVisible.get()&&DragDrop.startPane.supportDates}.bind(this)),this._super.constructor.call(this,p),this._allPaneItems=[],platform.mobile||this.topBoxHeight.set(18,!1),this.search.itemStoreFilter=ItemStoreFilter.Dates|ItemStoreFilter.Priority,this.dropEffect=function(item){var dropEffect=C.DropEffect.Move;return this.isCalendarItem(item)&&(dropEffect=C.DropEffect.Copy),dropEffect},this.viewMode=new Observable(p.viewMode||C.AgendaViewMode.All,this.onViewModeChanged.bind(this)),this.setupViewMode(),util.forceBind("_itemSearchComparator",this),this.initTimeline()}var g=require("globals"),C=require("Constants"),d=require("data"),util=require("util"),platform=require("platform"),DragDrop=require("DragDrop"),VMTimelineBlock=require("VMTimelineBlock"),RepeatDate=require("RepeatDate"),VMPane=require("VMPane"),Observable=require("Observable"),ObservableComputed=require("ObservableComputed"),International=require("International"),Dispatcher=require("Dispatcher"),Sel=require("Sel"),tracker=require("tracker"),PaneObject=require("PaneObject"),VMPane_TimelineFns={initTimeline:function initTimelineFn(){this.blocks=[],this.blockImportant=void 0,this.blockStarred=void 0,this.days={},this.updateNextTimeout=0,this.datesByItem={},this.starredItems={},this.priorityItems={},this.blocksByKey={},this.preventUpdateItemsForItem=void 0,this.itemAnimationTimeout=void 0;var gcalPlugin=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar);gcalPlugin.isActive()&&gcalPlugin.loadRemoteAPIs();var gmailPlugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);gmailPlugin.isActive()&&this.useItemStore(gmailPlugin.getDefaultItemStore()),g.vmMain.pluginManager.listen("pluginActiveChanged",PluginID.GCalendar,util.forceBind("onGCalendarActiveChanged",this)),g.vmMain.pluginManager.listen("pluginActiveChanged",PluginID.Gmail,util.forceBind("onGmailActiveChanged",this)),Dispatcher.listen("selectionChanged",util.forceBind("_onSelectionChanged",this))},destroy:function destroyFn(){Dispatcher.unlisten("selectionChanged",this._onSelectionChanged),g.vmMain.pluginManager.unlisten("pluginActiveChanged",PluginID.GCalendar,this.onGCalendarActiveChanged),g.vmMain.pluginManager.unlisten("pluginActiveChanged",PluginID.Gmail,this.onGmailActiveChanged),this._super.destroy.call(this)},getPaneIcon:function getPaneIconFn(){return"icon-calendar"},keydown:function keydownFn(e){if(Sel.isValid()&&Sel.getStartIndex()===Sel.getEndIndex()&&!tracker.undoRedoActive){this.preventUpdateItemsForItem=Sel.getStartObject();var item=Sel.getStartItem();item&&(item.date()||item.repeatDate())&&item.forceDate(item.date()||item.repeatDate())}this._super.keydown.call(this,e)},clearPreventUpdate:function clearPreventUpdateFn(){var obj=this.preventUpdateItemsForItem;if(obj){var item=g.isVMLI(obj)?obj:obj.item;item&&item.forceDate(void 0),this.preventUpdateItemsForItem=void 0}},_onSelectionChanged:function _onSelectionChangedFn(){if(Sel.getPane()===this&&this.preventUpdateItemsForItem&&!tracker.undoRedoActive)if(Sel.isValid()){if(Sel.getStartObject().id!==this.preventUpdateItemsForItem.id)if(this.clearPreventUpdate(),platform.mobile)setTimeout(this.updateItems,0);else{var savedSel=Sel.save();g.vmMain.setItemAnimationMode(C.ItemAnimationMode.Move),this.updateItems(),this.restoreSelection(savedSel),clearTimeout(this.itemAnimationTimeout),this.itemAnimationTimeout=setTimeout(function(){g.vmMain.resetItemAnimationMode()},300)}}else this.clearPreventUpdate(),this.updateItems();else this.clearPreventUpdate()},updateItemsImmediate:function updateItemsImmediateFn(updateSearch,forceNotify){(!this.preventUpdateItemsForItem||tracker.undoRedoActive||forceNotify||this.itemsDirtyState&&this.itemsDirtyState.forceNotify)&&this._super.updateItemsImmediate.call(this,updateSearch,forceNotify)},isCalendarItem:function isCalendarItemFn(item){return item.belongsToItemStore(g.vmMain.pluginManager.getPlugin(PluginID.GCalendar).getDefaultItemStore())},isEmailItem:function isEmailItemFn(item){return item.belongsToItemStore(g.vmMain.pluginManager.getPlugin(PluginID.Gmail).getDefaultItemStore())},_itemSearchComparator:function _itemSearchComparatorFn(item){var searchMatches=this.search.isMatched(item)||item.isNote()&&this.search.isMatched(item.parent())||this.preventUpdateItemsForItem&&item===this.preventUpdateItemsForItem.item,hasNormalAttach=!1;if(this.isCalendarItem(item)){var calAttach=item.getAttachmentByPlugin(PluginID.GCalendar);calAttach&&calAttach.forEachItem(void 0,function(sub){sub.belongsToItemStore(g.vmMain.pluginManager.getPlugin(PluginID.GCalendar).getDefaultItemStore())||(hasNormalAttach=!0)})}else if(this.isEmailItem(item)){var emailAttach=item.getAttachmentByPlugin(PluginID.Gmail);if(emailAttach){var emailPlugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);if(emailPlugin.isItemArchived(item))searchMatches=!1;else{var pri=emailPlugin.getAttachmentPriority(emailAttach);pri!==VMLIFlag.None&&(searchMatches=!0)}}}return searchMatches&&!hasNormalAttach},getItemSearchParams:function getItemSearchParamsFn(){var params={itemStoreFilter:this.search.itemStoreFilter,item:this.item.get(),comparator:this._itemSearchComparator,noCollapsed:!0,includeArchived:this.showArchived.get(),includeNotes:!0,pane:this};return params},setItems:function setItemsFn(items){this._allPaneItems=items,this.loadTimeline()},onTapViewArchived:function onTapViewArchivedFn(){g.vmMain.beginUpdateItems(),this.showArchived.set(!this.showArchived.get()),g.vmMain.commitUpdateItems(),g.vmMain.paneManager.updatePaneStateForPane(this),g.sendEvent("Menu","ShowArchivedTimeline")},onAfterLoaded:function onAfterLoadedFn(){var index=this.findIndexOfNextBlock();this.initialOffset=index>=0?this.topOfIndex(index)+8:0,this._super.onAfterLoaded.call(this)},scrollToToday:function scrollToTodayFn(duration){var index=this.findIndexOfNextBlock();index>=0&&this.scrollIndexToTop(index,isNaN(duration)?ScrollDuration.Default:duration)},blockCompare:function blockCompareFn(left,right){return left.date.compareTo(right.date)},findIndexOfNextBlock:function findIndexOfNextBlockFn(){for(var index=0,now=new Date,i=0;i<this.blocks.length;++i){var block=this.blocks[i];if(block.isOverdue||block.isNow||block.isToday||block.isStarred||block.isImportant||block.date>=now)return index;index++;for(var u=0;u<block.items.length;++u)index+=block.showTime(u)?2:1}return-1},_getDateForItem:function _getDateForItemFn(item){var date;if(item.isComplete())date=item.dateCompleted;else if(g.isDateSoft(item.dateText))date=item.dateText.toUpperCase();else if(item.repeatDate())date=item.repeatDate().getDates();else if(item.date()){var startDate=item.date();if(item.getDuration()>0){date=[];for(var startDate=startDate.clone().clearTime(),endDate=item.getEndDate().clone().clearTime();endDate>=startDate;)date.push(startDate.equals(endDate)?item.getEndDate():startDate.clone()),startDate.addDays(1);var SanityCheckValue}else date=startDate}return date},_getKeyForDate:function _getKeyForDateFn(date){var text,today=Date.today(),timeDiff=Math.floor((date-today)/864e5);if(this.combineOverdue&&today>date)text="OVERDUE";else{switch(timeDiff){case-1:text="YESTERDAY";break;case 0:text="TODAY";break;case 1:text="TOMORROW";break;default:text=date.toString("dddd").toUpperCase()}var showYear=date.getYear()!==today.getYear(),dateFormatEnum=showYear?DFormat.MonthDayYear:DFormat.ShortDate,dateFormat=International.getFormat(dateFormatEnum);text+=" "+date.toString(dateFormat)}return text},loadTimeline:function loadTimelineFn(){var i,item,index=0;for(this!==g.focusedPane&&this.search.update(),this.blocks=[],this.blocksByKey={},this.getBlock(Date.today()),i=0;i<this._allPaneItems.length;i++)item=this._allPaneItems[i],item.isNote()||this.addToBlock(this._allPaneItems[i]);var numByID={},items=[];for(i=0;i<this.blocks.length;i++){var block=this.blocks[i];if(block.isToday||block.isNow){var prevBlock=this.blocks[i-1];!prevBlock||prevBlock.isToday||prevBlock.isNow||(block.showLine=!0)}if(items.push(new PaneObject({type:"agendaHeader",block:block,id:block.id,index:index++,isToday:block.isToday?-1:null,heightInPane:block.heightOfHeader})),block.items.length>0)for(var u=0;u<block.items.length;u++){item=block.items[u];var itemID;if(itemID=!block.isDate||item.repeatDate()||item.isMultidayEvent()?item.id+"_"+block.id:item.id+"_date",block.showTime(u)&&!item.isNote()){var header={type:"agendaTime",text:block.getTime(item),id:itemID+"_time",block:block,timeItem:item,index:index++,heightInPane:block.heightOfTime};item.isComplete()&&(header.isComplete=!0),items.push(new PaneObject(header))}items.push(new PaneObject({type:"agendaItem",item:item,id:itemID,block:block,index:index++,heightInPane:item.heightInPane}))}else items.push(new PaneObject({type:"agendaEmpty",text:block.emptyText||"Nothing scheduled",block:block,id:block.id+"_empty",index:index++,isToday:block.isToday?1:null,heightInPane:block.heightOfEmpty}))}this.items.set(items)},addToBlock:function addToBlockFn(item){if(!item.isComplete()){if(item.isStarred()){var blockStarred=this.getBlock("STARRED");this.addItemToBlock(item,blockStarred)}if(item.isImportant()){var blockImportant=this.getBlock("IMPORTANT");this.addItemToBlock(item,blockImportant)}}var date=this._getDateForItem(item);if(date)if(g.isArray(date))for(var i=0;i<date.length;++i)this.addToDateBlock(item,date[i]);else this.addToDateBlock(item,date)},addToDateBlock:function addToDateBlockFn(item,date){if(!this.startDate||!this.endDate||date>=this.startDate&&date<this.endDate||this.combineOverdue&&date<this.startDate){var block=this.getBlock(date);block.isOverdue&&item.isComplete()||this.addItemToBlock(item,block)}},addItemToBlock:function addItemToBlockFn(item,block){block.addItem(item),item.hasNote()&&block.addItem(item.getNote())},isDateWithinRange:function isDateWithinRangeFn(date){return!this.startDate||!this.endDate||date>=this.startDate&&date<this.endDate},getBlock:function getBlockFn(date){var block,key,origDate=date;g.isString(date)?(key=date,date=void 0):key=this._getKeyForDate(date);try{g.PAssert(4054,key,"Undefined key for block",date,origDate)}catch(PERR){g.reportError(PERR)}if(block=this.blocksByKey[key],!block){var options={pane:this,dateKey:key,name:key};if(date&&(options.date=date.clone().clearTime()),g.isString(key)&&0===key.indexOf("TODAY"))options.isToday=!0,options.isDate=!0,options.emptyText="Nothing due today";else switch(key){case"NOW":options.isNow=!0,options.date=Date.today().add({hours:-1});break;case"STARRED":options.date=Date.today().add({hours:2}),options.isStarred=!0;break;case"IMPORTANT":options.date=Date.today().add({hours:3}),options.isImportant=!0;break;case"NEXT":options.date=Date.today().add({hours:12});break;case"SOON":options.date=Date.today().add({days:1,hours:12});break;case"LATER":options.date=Date.today().add({days:3,hours:12});break;case"SOMEDAY":options.date=Date.today().add({days:14,hours:12});break;case"OVERDUE":options.date=Date.today().add({days:-1}),options.isOverdue=!0,options.emptyText="Nothing overdue";break;default:options.isDate=!0}block=new VMTimelineBlock(options),this.blocksByKey[key]=block,this.blocks.insertSorted(block,this.blockCompare)}return block},maxWidthOfItem:function maxWidthOfItemFn(item){return this.getWidth()-g.agendaPadding-g.SPThresholdRight},closestIndexOfObject:function closestIndexOfObjectFn(object){var searchStrs=["STARRED","NOW","IMPORTANT"],searchStr;searchStrs.some(function(str){return object.id.indexOf(str)>0?(searchStr=str,!0):void 0});for(var matches=[],items=this.getItems(),i=0;i<items.length;i++)if(items[i].item===object.item){if(items[i].id===object.id){matches=[i];break}matches.push(i)}return 1===matches.length?matches[0]:searchStr?matches.filter(function(index){var matchItem=items[index];return matchItem.id.indexOf(searchStr)>=0})[0]||matches[0]:matches.filter(function(index){var matchItem=items[index],ok=!searchStrs.some(function(str){return matchItem.id.indexOf(str)>=0?!0:void 0});return ok})[0]||matches[0]},getPaddingForItem:function getPaddingForItemFn(item,overview){return overview?this._super.getPaddingForItem.call(this,item,overview):g.agendaPadding},getSpanWidthForItem:function getSpanWidthForItemFn(item){return this.getWidth()-g.agendaPadding-g.SPThresholdRight},onGCalendarActiveChanged:function onGCalendarActiveChangedFn(plugin,isActive){this.search.setFilterEnabled("gcal",isActive),this.supportDataRefresh=isActive},onGmailActiveChanged:function onGmailActiveChangedFn(plugin,isActive){var itemStore=plugin.getDefaultItemStore();isActive?this.useItemStore(itemStore):this.stopUsingItemStore(itemStore)},_matchFnCal:function _matchFnCalFn(filterValue,item,matchState){var isCal=this.isCalendarItem(item);return filterValue?isCal&&filterValue>0||!isCal&&0>filterValue?C.MatchState.Yes:C.MatchState.No:void 0},refreshPaneData:function refreshPaneDataFn(){var gcalPlugin=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar);gcalPlugin.isActive()&&gcalPlugin.forceRemoteEventSync(this.id)},handleRightSideTap:function handleRightSideTapFn(item){this._super.handleRightSideTap.call(this,item),platform.mobile||(Sel.reset(),g.vmMain.mousemove&&(Sel.setHovered(this,null,null),setTimeout(function(){var pos=Sel.mousePos,eventTarget=g.elementFromPoint(pos.x,pos.y);g.vmMain.mousemove({clientX:pos.x,clientY:pos.y,target:eventTarget},!0)},g.itemTransitionTime)))},onViewModeChanged:function onViewModeChangedFn(mode){this.setupViewMode(),this.loadTimeline(),g.vmMain.paneManager.updatePaneStateForPane(this)},setupViewMode:function setupViewModeFn(){var mode=this.viewMode.get();mode===C.AgendaViewMode.All?(this.startDate=void 0,this.endDate=void 0,this.combineOverdue=!1):mode===C.AgendaViewMode.Day?(this.startDate=Date.today(),this.endDate=Date.today().addDays(1),this.combineOverdue=!0):mode===C.AgendaViewMode.Week&&(this.startDate=Date.today(),this.endDate=Date.today().addDays(7),this.combineOverdue=!0)},_handleDragOverPane:function _handleDragOverPaneFn(fromPane,item,target,li,targetItem,x,y){if(fromPane&&fromPane.supportDates&&!g.findParent(target,"paneOverlay")&&g.findParent(target,"paneContent")&&!g.hasClass(target,"paneContent")){var block,prevBlock=this.dragHoveredBlock.get(),reactCell=g.getReactCellForElement(target);return reactCell&&reactCell.props.cell&&(block=reactCell.props.cell.paneObject.block),this.dragHoveredBlock.set(block),DragDrop.setAgendaInfo(block),{block:block}}return{}},handleDragDrop:function handleDragDropFn(item,e,dragInfo,isNew){var info=DragDrop.agendaInfo,retain=info&&(info.date||info.dateTime);info&&DragDrop.startPane.applyAgendaDropToItem(info,item),this.retainOverlayAfterDrop.get()||this.revertDrag()},revertDrag:function revertDragFn(){this._super.revertDrag.call(this);var prevBlock=this.dragHoveredBlock.get();prevBlock&&this.dragHoveredBlock.set(null)
},getSaveInfo:function getSaveInfoFn(){var state=this._super.getSaveInfo.call(this);return state.viewMode=this.viewMode.get(),state}};return util.inherit(VMPane,VMPane_Timeline),util.extend(VMPane_Timeline.prototype,VMPane_TimelineFns),VMPane_Timeline}),define("VMPane_Archived",["require","exports","module","ko","globals","data","util","VMPane"],function(require,exports,module){function VMPane_Archived(p){this.type=PaneMode.Archived,this.paneClass="paneArchived",this.isWriteable=!0,this.isEditable=!1,this.isDraggable=!1,this.isDropTarget=!1,this.canAddItem=!1,this.supportCollapsing=!0,this.supportCompleting=!1,this.supportArchiving=!0,this.supportPerformArchive=!1,this.supportIndent=!1,this.supportClone=!1,this.titleOfFirstItem="Archived Items",this._super.constructor.call(this,p),this._blocks=[],this._blocksById={},util.forceBind("isItemMatched",this),util.forceBind("itemEach",this),this.initArchived()}var ko=require("ko"),g=require("globals"),d=require("data"),util=require("util"),VMPane=require("VMPane"),VMPane_ArchivedFns={initArchived:function initArchivedFn(){this.showArchived.set(!0)},isItemMatched:function isItemMatchedFn(item){return(item.isArchived()||item.hasArchivedDescendant()||item.hasArchivedAncestor())&&this.search.isMatched(item)},itemEach:function itemEachFn(item){var collapseField=this.isSearched()?PerPaneStateField.CollapsedSearch:PerPaneStateField.Collapsed;void 0===this.getPerPaneState(item.id,collapseField)&&(item.isArchived()&&!item.hasArchivedDescendant()||!item.isArchived()&&item.hasArchivedAncestor()&&!item.hasArchivedDescendant())&&item.setCollapsed(!0,this,!1)},getItemSearchParams:function getItemSearchParamsFn(){var params={item:this.getItem(),comparator:this.isItemMatched,each:this.itemEach,includeArchived:!0,noCollapsed:!0,pane:this};return params},getHeaderSearchParams:function getHeaderSearchParamsFn(){return{item:this.getItem(),comparator:this.isItemMatched,includeArchived:!0,noCollapsed:!0,collapseAfterDepth:1,headers:!0,overview:!0,pane:this}},getStatusMessage:function getStatusMessageFn(){return"No archived items"},handleRightSideTap:function handleRightSideTapFn(item){this.runUnarchive(item)},setupContextMenu:function setupContextMenuFn(item,e){return g.element("contextMenuItem_Archived")}};return util.inherit(VMPane,VMPane_Archived),util.extend(VMPane_Archived.prototype,VMPane_ArchivedFns),VMPane_Archived}),define("PaneFactory",["ko","globals","data","VMPane","VMPane_Timeline","VMPane_Archived","Observable","ObservableArray"],function(ko,g,d,VMPane,VMPane_Timeline,VMPane_Archived,Observable,ObservableArray){function PaneFactory(){this._inactivePaneTypes={},this.activePaneTypes=new ObservableArray,this._registeredTypes={},this.numInactivePanes=new Observable(0),this.registerPaneType(void 0,PaneMode.Outline,"Outline",VMPane,"icon-align-left"),this.registerPaneType(void 0,PaneMode.Timeline,"Agenda",VMPane_Timeline,"icon-calendar"),this.registerPaneType(void 0,PaneMode.Archived,"Archived",VMPane_Archived,"icon-inbox")}return PaneFactory.prototype={registerPaneType:function registerPaneTypeFn(plugin,type,name,constructor,icon){this._registeredTypes[type]={plugin:plugin,constructor:constructor};var paneTypeInfo={type:type,name:name,icon:icon,text:name+" Pane",tooltip:"Add "+name+" Pane"};!plugin||plugin.isActive()?this.activePaneTypes.push(paneTypeInfo):(this._inactivePaneTypes[type]=paneTypeInfo,this.numInactivePanes.set(this.numInactivePanes.get()+1))},activatePaneType:function activatePaneTypeFn(type){var paneTypeInfo=this._inactivePaneTypes[type];try{g.PAssert(4056,paneTypeInfo,"Must have previously registered pane type")}catch(PERR){g.reportError(PERR)}this._inactivePaneTypes[type]=void 0,this.activePaneTypes.push(paneTypeInfo),this.numInactivePanes.set(this.numInactivePanes.get()-1)},deactivatePaneType:function deactivatePaneTypeFn(type){var paneTypeInfo=this.activePaneTypes.remove(function(entry){return entry.type===type})[0];try{g.PAssert(4057,paneTypeInfo,"Must have previously activated pane type")}catch(PERR){g.reportError(PERR)}g.vmMain.paneManager.removePanesByType(type),this._inactivePaneTypes[type]=paneTypeInfo,this.numInactivePanes.set(this.numInactivePanes.get()+1)},createPane:function createPaneFn(type,options){options&&options.id||(options.id=g.vmMain.paneManager.getNextPaneID());var paneInfo=this._registeredTypes[type];if(!paneInfo){try{g.PAssert(4058,!1,"Invalid pane type requested")}catch(PERR){g.reportError(PERR)}return void 0}if(paneInfo.plugin&&(!paneInfo.plugin.isActive()||paneInfo.plugin.isPluginBlocked()))return void 0;try{g.vmMain.beginUpdateItems();var pane=new paneInfo.constructor(options);return g.vmMain.commitUpdateItems(),pane}catch(err){return void g.reportError(err)}},isPaneTypeActive:function isPaneTypeActiveFn(type){var isRegistered=!!this._registeredTypes[type],isInactive=!!this._inactivePaneTypes[type];return isRegistered&&!isInactive},getRegisteredPanes:function getRegisteredPanesFn(){return this.activePaneTypes.get()}},new PaneFactory}),define("Stack",["require","exports","module"],function(require,exports,module){function Stack(){this.stack=[]}return Stack.prototype={push:function pushFn(cb){this.stack.push(cb)},pop:function popFn(cb){this.stack.remove(cb)},peek:function peekFn(){return this.stack[this.stack.length-1]},contains:function containsFn(cb){return this.stack.indexOf(cb)>=0}},Stack}),define("Hotkeys",["require","globals","platform","Constants","tracker","edit","NativeSel","Stack","Sel"],function(require){function Hotkeys(){function ignoreKeyOnBody(e){return(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.normCode===KeyCode.A}function globalKeyUp(e){if(platform.normalizeKeys(e),g.vmMain&&g.vmMain.updateCursorFromEvent(e),platform.windows&&lastGlobalKeyDown!==e.normCode&&(e.normCode===KeyCode.D1||e.normCode===KeyCode.D2||e.normCode===KeyCode.D3||e.normCode===KeyCode.D8)){var result=hotkeys[e.normCode];result&&(globalKeyDown(e),lastGlobalKeyDown=void 0)}}var hotkeySearch=function(){var targetPane=g.focusedPane||g.vmMain.paneManager.getPaneAtIndex(0);if(targetPane){var search=targetPane.search;search.isFocused.get()||search.focus(),g.sendEvent("Hotkey","Search")}},hotkeyOverview=function(){g.focusedPane&&g.focusedPane.toggleOverviewVisibility(),g.sendEvent("Hotkey","Overview")},checkToggleSearchFilter=function(name){var pane=g.focusedPane;return pane&&pane.search.isFocused.get()?(pane.search.toggleFilterDefault(name),!0):!1},checkToggleSearchPriority=function(value){var pane=g.focusedPane;if(pane&&pane.search.isFocused.get()){var search=pane.search;return search.getFilter("priority")===value&&(value=0),pane.search.setFilter("priority",value),!0}return!1},hotkeyP0=function(){g.focusedPane&&!checkToggleSearchPriority(VMLIFlag.P0)&&(g.focusedPane.applyPriorityToSelection(VMLIFlag.P0,!0),g.sendEvent("Hotkey","Important"))},hotkeyP1=function(){g.focusedPane&&!checkToggleSearchPriority(VMLIFlag.P1)&&(g.focusedPane.applyPriorityToSelection(VMLIFlag.P1,!0),g.sendEvent("Hotkey","Important"))},hotkeyP2=function(){g.focusedPane&&!checkToggleSearchPriority(VMLIFlag.P2)&&(g.focusedPane.applyPriorityToSelection(VMLIFlag.P2,!0),g.sendEvent("Hotkey","Important"))},hotkeyStar=function(){checkToggleSearchFilter("starred")||(g.vmMain.applyFnToSelection("isStarred",{toggle:!0,restoreSelection:!0,value2:ChangeType.Local}),g.sendEvent("Hotkey","Star"))},hotkeyComplete=function(){checkToggleSearchFilter("complete")||(g.vmMain.applyFnToSelection("isComplete",{toggle:!0,restoreSelection:!0,value2:ChangeType.Local}),g.sendEvent("Hotkey","Complete"))},hotkeyArchiveCompleted=function(){g.focusedPane&&g.focusedPane.archiveCompleted(),g.sendEvent("Hotkey","ArchiveCompleted")},hotkeyZoomIn=function(){g.vmMain.applyToSelection(function(item){return item.isNote()||g.vmMain.zoomin(item),!1}),g.sendEvent("Hotkey","ZoomIn")},hotkeyZoomOut=function(){var item=g.focusedItem;item&&item.parent()&&g.vmMain.zoomout(item.parent()),g.sendEvent("Hotkey","ZoomOut")},hotkeyToggleCollapse=function(){g.vmMain.applyToSelection(function(item){g.focusedPane.supportCollapsing&&item.toggleCollapsed(g.focusedPane)}),g.sendEvent("Hotkey","Collapse")},hotkeyCollapse=function(){g.vmMain.applyToSelection(function(item){g.focusedPane.supportCollapsing&&item.setCollapsed(!0,g.focusedPane)}),g.sendEvent("Hotkey","Collapse")},hotkeyUncollapse=function(){g.vmMain.applyToSelection(function(item){g.focusedPane.supportCollapsing&&item.setCollapsed(!1,g.focusedPane)}),g.sendEvent("Hotkey","Collapse")},hotkeyCollapseAll=function(){g.focusedItem&&g.focusedPane&&g.focusedPane.supportCollapsing&&g.focusedPane.toggleCollapseAll(),g.sendEvent("Hotkey","CollapseAll")},hotkeyIndent=function(){Sel.isValid()&&(g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1}),g.sendEvent("Hotkey","Indent"))},hotkeyUnindent=function(){Sel.isValid()&&(g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0}),g.sendEvent("Hotkey","Unindent"))},hotkeyClosePane=function(e){var removedID=g.vmMain.paneManager.removeFocusedPane();void 0!==removedID&&(tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:removedID}),g.sendEvent("Hotkey","ClosePane"),g.tooltip.hideTip(),e.stopImmediatePropagation())},hotkeyMoveAutocomplete=function(){g.focusedPane&&g.focusedPane.autocompleteMove()},hotkeyCompose=function(){var emailPlugin=g.vmMain.getDefaultEmailPlugin();emailPlugin.isEnabled()?g.menus.openComposeEmail(emailPlugin):g.toasts.pushMessage(MessageID.NeedGmailPermission)},hotkeyUndo=function(){return NativeSel.hasRawSelection()&&g.elementInNonPaneEdit(NativeSel.getSelectionNode())?!1:(g.focusedPane?g.focusedPane.handleUndo():tracker.undoAction(),void g.sendEvent("Hotkey","Undo"))},hotkeyRedo=function(){return NativeSel.hasRawSelection()&&g.elementInNonPaneEdit(NativeSel.getSelectionNode())?!1:(g.focusedPane?g.focusedPane.handleRedo():tracker.redoAction(),void g.sendEvent("Hotkey","Redo"))},hotkeyAddPane=function(){var el=g.element("addPaneButton");g.menus.openContextMenuReact({componentName:"ReactContextMenuAddPane",element:el})},hotkeyGoto=function(){g.vmMain.applyToSelection(function(item){return g.scrollToAndHighlightItem(item,g.focusedPane),!1}),g.sendEvent("Hotkey","GoTo")},hotkeyNOP=function(){},hotkeyPassthrough=function(){return!1};this.platformPrimaryKey=platform.mac?Mods.Meta:Mods.Ctrl,this.platformSecondaryKey=platform.mac?Mods.Ctrl:Mods.Alt,this.addHotkey(KeyCode.F,C.Primary.Either,C.Shift.No,hotkeySearch,"Search"),this.addHotkey(KeyCode.G,C.Primary.No,C.Shift.No,hotkeyGoto),this.addHotkey(KeyCode.O,C.Primary.No,C.Shift.No,hotkeyOverview,"Overview"),this.addHotkey(KeyCode.Slash,C.Primary.Either,C.Shift.No,hotkeyComplete,"Complete"),this.addHotkey(KeyCode.Enter,C.Primary.Never,C.Shift.No,hotkeyComplete,"Complete"),this.addHotkey(KeyCode.Slash,C.Primary.Either,C.Shift.Yes,hotkeyArchiveCompleted,"ArchiveCompleted"),this.addHotkey(KeyCode.D1,C.Primary.No,C.Shift.No,hotkeyP0,"Priority0"),this.addHotkey(KeyCode.D2,C.Primary.No,C.Shift.No,hotkeyP1,"Priority1"),this.addHotkey(KeyCode.D3,C.Primary.No,C.Shift.No,hotkeyP2,"Priority2"),this.addHotkey(KeyCode.D8,C.Primary.Either,C.Shift.Either,hotkeyStar,"Star"),this.addHotkey(KeyCode.Enter,C.Primary.Yes,C.Shift.No,hotkeyZoomIn,"ZoomIn"),this.addHotkey(KeyCode.Enter,C.Primary.Yes,C.Shift.Yes,hotkeyZoomOut,"ZoomOut"),platform.mac&&(this.addHotkey(KeyCode.LeftArrow,C.Primary.Both,C.Shift.No,hotkeyZoomOut,"ZoomOut"),this.addHotkey(KeyCode.RightArrow,C.Primary.Both,C.Shift.No,hotkeyZoomIn,"ZoomIn"),this.addHotkey(KeyCode.Comma,C.Primary.Yes,C.Shift.Yes,hotkeyZoomOut,"ZoomOut"),this.addHotkey(KeyCode.Period,C.Primary.Yes,C.Shift.Yes,hotkeyZoomIn,"ZoomIn")),this.addHotkey(KeyCode.Space,C.Primary.No,C.Shift.No,hotkeyToggleCollapse,"ToggleCollapse"),this.addHotkey(KeyCode.Space,C.Primary.No,C.Shift.Yes,hotkeyCollapseAll,"CollapseAll"),this.addHotkey(KeyCode.Comma,platform.mac?C.Primary.Never:C.Primary.No,C.Shift.No,hotkeyToggleCollapse,"ToggleCollapse"),this.addHotkey(KeyCode.Comma,platform.mac?C.Primary.Never:C.Primary.No,C.Shift.Yes,hotkeyCollapseAll,"CollapseAll"),this.addHotkey(KeyCode.Period,C.Primary.Either,C.Shift.No,hotkeyToggleCollapse,"ToggleCollapse"),this.addHotkey(KeyCode.Period,C.Primary.No,C.Shift.Yes,hotkeyCollapseAll,"CollapseAll"),this.addHotkey(KeyCode.DownArrow,C.Primary.Never,C.Shift.No,hotkeyUncollapse,"Uncollapse"),this.addHotkey(KeyCode.UpArrow,C.Primary.Never,C.Shift.No,hotkeyCollapse,"Collapse"),this.addHotkey(KeyCode.LBracket,C.Primary.Either,C.Shift.No,hotkeyUnindent,"Unindent"),this.addHotkey(KeyCode.RBracket,C.Primary.Either,C.Shift.No,hotkeyIndent,"Indent"),this.addHotkey(KeyCode.LeftArrow,C.Primary.Never,C.Shift.Yes,hotkeyUnindent,"Unindent"),this.addHotkey(KeyCode.RightArrow,C.Primary.Never,C.Shift.Yes,hotkeyIndent,"Indent");var moveUpFn=edit.moveUp.bind(edit),moveDownFn=edit.moveDown.bind(edit);this.addHotkey(KeyCode.UpArrow,C.Primary.Never,C.Shift.Yes,moveUpFn,"MoveUp"),this.addHotkey(KeyCode.DownArrow,C.Primary.Never,C.Shift.Yes,moveDownFn,"MoveDown"),platform.mac?(this.addHotkey(KeyCode.UpArrow,C.Primary.Both,C.Shift.No,moveUpFn,"MoveUp",!0),this.addHotkey(KeyCode.DownArrow,C.Primary.Both,C.Shift.No,moveDownFn,"MoveDown",!0),this.addHotkey(KeyCode.UpArrow,void 0,C.Shift.No,moveUpFn,"MoveUp",!0,!0),this.addHotkey(KeyCode.DownArrow,void 0,C.Shift.No,moveDownFn,"MoveDown",!0,!0)):(this.addHotkey(KeyCode.UpArrow,C.Primary.Never,C.Shift.Yes,moveUpFn,"MoveUp",!0),this.addHotkey(KeyCode.DownArrow,C.Primary.Never,C.Shift.Yes,moveDownFn,"MoveDown",!0)),platform.mac&&(this.addHotkey(KeyCode.LeftArrow,C.Primary.Never,C.Shift.Yes,hotkeyUnindent,"Unindent",!0),this.addHotkey(KeyCode.RightArrow,C.Primary.Never,C.Shift.Yes,hotkeyIndent,"Indent",!0),this.addHotkey(KeyCode.L,C.Primary.Never,C.Shift.No,edit.handleSelectAllItem,"SelectAll",!0)),this.addHotkey(KeyCode.F4,void 0,C.Shift.Yes,hotkeyClosePane,"ClosePane"),this.addHotkey(KeyCode.Tilde,C.Primary.Either,C.Shift.No,hotkeyPassthrough,"Passthrough"),this.addHotkey(KeyCode.S,C.Primary.Either,C.Shift.No,hotkeyNOP,"Save"),this.addHotkey(KeyCode.M,C.Primary.Never,C.Shift.No,hotkeyMoveAutocomplete,"Move"),this.addHotkey(KeyCode.Z,C.Primary.Yes,C.Shift.No,hotkeyUndo,"Undo"),this.addHotkey(KeyCode.Y,C.Primary.Yes,C.Shift.No,hotkeyRedo,"Redo"),this.addHotkey(KeyCode.Z,C.Primary.Yes,C.Shift.Yes,hotkeyRedo,"Redo"),this.addHotkey(KeyCode.T,C.Primary.No,C.Shift.No,hotkeyAddPane,"Add pane"),this.addHotkey(KeyCode.N,C.Primary.No,C.Shift.No,hotkeyCompose,"EmailCompose");var lastGlobalKeyDown,checkHotkeys=function(e,result){for(var valid,i=0;i<result.length;i++){var entry=result[i],noMods=!entry.mods,ctrlValid,metaValid,altValid,shiftValid;if(noMods||(ctrlValid=!!entry.mods[Mods.Ctrl]==!!e.ctrlKey,metaValid=!!entry.mods[Mods.Meta]==!!e.metaKey,altValid=!!entry.mods[Mods.Alt]==!!e.altKey,shiftValid=!!entry.mods[Mods.Shift]==!!e.shiftKey),noMods||ctrlValid&&metaValid&&altValid&&shiftValid){valid=entry;break}}if(valid){var ret=valid.call(e);return valid.stopPropagation&&e.stopPropagation(),ret!==!1?(e.handled=!0,e.preventDefault(),!1):!0}},globalKeyDown=function(e){platform.normalizeKeys(e),lastGlobalKeyDown=e.normCode;var inStack=this.hotkeyStack.peek(),ret;if(inStack&&inStack[e.normCode]&&(ret=checkHotkeys(e,[inStack[e.normCode]])),void 0===ret){var result=hotkeys[e.normCode];result&&(ret=checkHotkeys(e,result))}if(void 0!==ret)return g.vmMain&&g.vmMain.updateCursorFromEvent(e),ret;if(platform.android&&e.srcElement===document.body){if(ignoreKeyOnBody(e))return e.preventDefault(),!1;edit.keydown(null,e)}}.bind(this);this.hotkeyStack=new Stack,document.addEventListener("keydown",globalKeyDown,!0),document.addEventListener("keyup",globalKeyUp,!0)}var g=require("globals"),platform=require("platform"),C=require("Constants"),tracker=require("tracker"),edit=require("edit"),NativeSel=require("NativeSel"),Stack=require("Stack"),Sel=require("Sel"),hotkeys={},Mods={Ctrl:0,Meta:1,Alt:2,Shift:3};return Hotkeys.prototype={pushStack:function pushStackFn(newHotkeys){for(var obj={},i=0;i<newHotkeys.length;i++){var h=newHotkeys[i];obj[h.keyCode]=h}return this.hotkeyStack.push(obj),obj},pushStackEscape:function pushStackEscapeFn(cb){return this.pushStack([this.create(KeyCode.Escape,C.Primary.Either,C.Shift.Either,cb)])},popStack:function popStackFn(obj){this.hotkeyStack.pop(obj)},registerHotkey:function registerHotkeyFn(keyCode,primary,shift,callback,stopPropagation){return this.addHotkey(keyCode,primary,shift,callback,stopPropagation)},getHotkey:function getHotkeyFn(e){var name,result=hotkeys[e.normCode];if(result)for(var i=0;i<result.length;i++){var entry=result[i],noMods=!entry.mods,ctrlValid,metaValid,altValid,shiftValid;if(noMods||(ctrlValid=!!entry.mods[Mods.Ctrl]==!!e.ctrlKey,metaValid=!!entry.mods[Mods.Meta]==!!e.metaKey,altValid=!!entry.mods[Mods.Alt]==!!e.altKey,shiftValid=!!entry.mods[Mods.Shift]==!!e.shiftKey),noMods||ctrlValid&&metaValid&&altValid&&shiftValid){name=entry.name;break}}return name},create:function createFn(keyCode,primary,shift,callback,option){try{g.PAssert(4059,keyCode,"Invalid keyCode")}catch(PERR){g.reportError(PERR)}var hotkey={keyCode:keyCode,mods:{},call:callback};return(primary===C.Primary.Yes||primary===C.Primary.Both)&&(hotkey.mods[this.platformPrimaryKey]=!0),(primary===C.Primary.No||primary===C.Primary.Never||primary===C.Primary.Both)&&(hotkey.mods[this.platformSecondaryKey]=!0),option&&platform.mac&&(hotkey.mods[Mods.Alt]=!0),shift===C.Shift.Yes&&(hotkey.mods[Mods.Shift]=!0),hotkey},createEscape:function createEscapeFn(cb){return this.create(KeyCode.Escape,C.Primary.Either,C.Shift.Either,cb)},addHotkey:function addHotkeyFn(keyCode,primary,shift,callback,name,stopPropagation,option){platform.app&&!isNaN(primary)&&primary!==C.Primary.Both&&primary!==C.Primary.Never&&(primary=C.Primary.Either),this._addHotkey(keyCode,primary,shift,callback,name,stopPropagation,option)},_addHotkey:function _addHotkeyFn(keyCode,primary,shift,callback,name,stopPropagation,option){if(hotkeys[keyCode]=hotkeys[keyCode]||[],primary===C.Primary.Either)return this._addHotkey(keyCode,C.Primary.No,shift,callback,name,stopPropagation),void this._addHotkey(keyCode,C.Primary.Yes,shift,callback,name,stopPropagation);if(shift===C.Shift.Either)return this._addHotkey(keyCode,primary,C.Shift.No,callback,name,stopPropagation),void this._addHotkey(keyCode,primary,C.Shift.Yes,callback,name,stopPropagation);try{g.PAssert(4060,!platform.windows||primary!==C.Primary.Both,"Should never require AltGr combo on windows")}catch(PERR){g.reportError(PERR)}var hotkey=this.create(keyCode,primary,shift,callback,option);hotkeys[keyCode].push(hotkey),hotkey.stopPropagation=stopPropagation,hotkey.name=name}},new Hotkeys}),define("ModalBase",["ko","globals","util","Hotkeys"],function(ko,g,util,Hotkeys){function ModalBase(id){try{g.PAssert(4061,id,"Must supply each modal with a valid ID")}catch(PERR){g.reportError(PERR)}this.id=id,this.isRegistered=!1,this.isVisible=ko.observable(!1),this.openFn=void 0,this.closeFn=void 0,util.forceBind("_onEscape",this)}return ModalBase.prototype={registerModal:function registerModalFn(openFn,closeFn){try{g.PAssert(4062,!openFn||g.isFunction(openFn),"May only supply a function as an open callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4063,!closeFn||g.isFunction(closeFn),"May only supply a function as an open callback")}catch(PERR){g.reportError(PERR)}this.openFn=openFn,this.closeFn=closeFn,this.isRegistered=!0,g.menus.registerModal(this.id,this)},openModal:function openModalFn(){setTimeout(function(){this.isVisible(!0)}.bind(this),0),this.openFn&&this.openFn.apply(this,arguments),this.__hotkeys=Hotkeys.pushStackEscape(this._onEscape)},closeModal:function closeModalFn(){this.isVisible(!1),Hotkeys.popStack(this.__hotkeys),this.__hotkeys=void 0,this.closeFn&&this.closeFn.apply(this,arguments)},_onEscape:function _onEscapeFn(){this.close()},close:function closeFn(){g.menus.closeModal(this.id,!0)}},util.defineBase(ModalBase),ModalBase}),define("ModalDeleteAccount",["ko","globals","util","platform","ModalBase"],function(ko,g,util,platform,ModalBase){function ModalDeleteAccount(){this._super.constructor.call(this,Modals.DeleteAccount),this.activeCallback=void 0,this.activeCallbackValue=!1,this.deleteReason=ko.observable(),this.init()}var ModalDeleteAccountFns={init:function initFn(){this.registerModal(this.onModalOpen.bind(this),this.onModalClose.bind(this))},onModalOpen:function onModalOpenFn(cb){this.activeCallback=cb},onModalClose:function onModalCloseFn(cb){this.activeCallback&&this.activeCallback(this.activeCallbackValue),this.clearModalData()},_close:function _closeFn(value){this.activeCallbackValue=value,g.menus.closeModal(this.id)},onTapDelete:function onTapDeleteFn(){var desc=this.deleteReason()||g.element("deleteReason").value;if(desc&&desc.length>0){var name="Account Deleted";g.sendFeedback(name,desc,function(){this.deleteReason("")}.bind(this))}this._close(!0)},onTapCancel:function onTapCancelFn(){this._close(!1)},clearModalData:function clearModalDataFn(){this.activeCallback=void 0}};return util.inherit(ModalBase,ModalDeleteAccount),util.extend(ModalDeleteAccount.prototype,ModalDeleteAccountFns),ModalDeleteAccount}),define("VMMenus",["require","ko","globals","Constants","gdata","ObservableArray","tracker","platform","Sel","util","Dispatcher","Hotkeys","AccountManager","ModalBase","PaneFactory","ModalDeleteAccount"],function(require){function VMMenus(){try{g.PAssert(4064,!g.menus,"Should only have a single instance of VMMenus")}catch(PERR){g.reportError(PERR)}g.menus=this,this.linkAddress=ko.observable(),this.phoneLastTop=0,this.rightMenuPhone=void 0,this.itemIsHeader=ko.observable(!1),this.itemIsStarred=ko.observable(!1),this.itemCanCollapse=ko.observable(!1),this.itemIsCollapsed=ko.observable(!1),this.itemIsArchived=ko.observable(!1),this.itemIsComplete=ko.observable(!1),this.itemCanIndent=ko.observable(!1),this.itemCanUnindent=ko.observable(!1),this.itemCanZoom=ko.observable(!1),this.itemCanAddNote=ko.observable(!1),this.itemCanArchive=ko.observable(!1),this.itemCanUnarchive=ko.observable(!1),this.itemIsRead=ko.observable(!1),this.itemIsImportant=ko.observable(!1),this.itemIsArchivedMail=ko.observable(!1),this.itemIsTrashed=ko.observable(!1),this.itemCanSnooze=ko.observable(!1),this.mobileExternalAppText=ko.observable(""),this.mobileExternalAppTap=void 0,this.contextBottomOpen=void 0,this._openedContextMenu=ko.observable(void 0),this._contextMenuElement=void 0,this.isModalVisible=ko.observable(!1),this.menusBound=!1,this.billingManager=g.billingManager,this.emailComposeCount=0,this._registeredModals={},this._openModals=[],this.newModals=[Modals.Settings,Modals.Alert,Modals.Confirm,Modals.ExportData,Modals.RevisionHistory,Modals.ImportData,Modals.ReportProblem,Modals.Billing,Modals.Welcome,Modals.EmailReply],this.modalStack=new ObservableArray,this.contextMenuStack=new ObservableArray,this.emailComposeStack=new ObservableArray,util.forceBind("applyToOpenItem",this),this.main=function(){return g.vmMain},this.init()}var ko=require("ko"),g=require("globals"),C=require("Constants"),gdata=require("gdata"),ObservableArray=require("ObservableArray"),tracker=require("tracker"),platform=require("platform"),Sel=require("Sel"),util=require("util"),Dispatcher=require("Dispatcher"),Hotkeys=require("Hotkeys"),AccountManager=require("AccountManager"),ModalBase=require("ModalBase"),PaneFactory=require("PaneFactory"),ModalDeleteAccount=require("ModalDeleteAccount");return VMMenus.prototype={init:function initFn(){Dispatcher.listen("closeKeyboard",this.onCloseKeyboard.bind(this)),Hotkeys.pushStackEscape(this.onEscapeKey.bind(this)),platform.mobile||this.isModalVisible.subscribe(function(newValue){requestAnimationFrame(newValue?function(){requestAnimationFrame(function(){g.addClass(g.element("container"),"modalOpen"),g.addClass(g.element("desktopMenu"),"modalOpen")})}:function(){g.removeClass(g.element("container"),"modalOpen"),g.removeClass(g.element("desktopMenu"),"modalOpen")})}),setTimeout(function(){g.applyBindings(this,"modals")}.bind(this),0),new ModalDeleteAccount},vmPicker:function vmPickerFn(){return g.vmMain.vmPicker},bind:function bindFn(){this.menusBound||(this.menusBound=!0,setTimeout(function(){g.applyBindings(this,"contextMenus")}.bind(this),0))},onEscapeKey:function onEscapeKeyFn(){return this.closeAllMenus(),this.isModalVisible()?this._closeModalInternal(!1):void 0},openLinkMenu:function openLinkMenuFn(target,address,left,top){this.linkAddress(address),g.menuOnItem=target;var menuLink=document.getElementById("contextMenuLink");menuLink.style.left=left+"px",menuLink.style.top=top+"px",menuLink.style.display="block",g.vmMain.handleFullscreenClick()},closeLinkMenu:function closeLinkMenuFn(){g.menuOnItem=void 0,this.linkAddress("");var menuLink=document.getElementById("contextMenuLink");menuLink.style.display="none",g.vmMain.cancelFullscreenClick()},onTapLink:{onClick:function onClickFn(){this.closeLinkMenu()}},closeAllMenus:function closeAllMenusFn(){this.closeLinkMenu(),this.closeContextMenu(),this.closeItemMenu()},openContextMenuReact:function openContextMenuReactFn(params,noFade){this.contextMenuNoFade=noFade,this.contextMenuStack.push(params)},closeContextMenuReact:function closeContextMenuReactFn(fn,callbackValue,source){var stack=this.contextMenuStack.get();if(fn){var index=stack.indexOfWithProperty("fn",fn);0>index&&(index=stack.indexOfWithProperty("componentName",fn));try{g.PAssert(4065,index>=0,"Tried to close a context menu that was not open")}catch(PERR){g.reportError(PERR)}if(index>=0){var menu=this.contextMenuStack.get()[index];menu.onClosed&&menu.onClosed(callbackValue,source),this.contextMenuStack.removeAt(index)}}else{for(var i=stack.length-1;i>=0;i--)stack[i].onClosed&&stack[i].onClosed(!1,source);this.contextMenuStack.clear()}},isContextMenuOpen:function isContextMenuOpenFn(){return this.contextMenuStack.get().length>0},openContextMenu:function openContextMenuFn(pane,item,e,offset,toLeft){this.closeContextMenu();var menu=pane.setupContextMenu(item,e);this._openedContextMenu(menu),this._contextMenuElement=e.srcElement,this._contextMenuPane=pane,g.autocomplete&&g.autocomplete.hide();var styles={top:offset.top},menuWidth=g.width(menu);toLeft||offset.left+menuWidth>platform.windowWidth()&&(toLeft=!0),styles.left=toLeft?offset.left-menuWidth-2:offset.left+2;var menuHeight=g.height(menu);offset.top+menuHeight>platform.windowHeight()&&(styles.top-=menuHeight),g.css(menu,styles),g.addClass(menu,"open");var windowBounds=document.documentElement.getBoundingClientRect(),rect=menu.getBoundingClientRect(),autoRect={left:rect.left,right:rect.right,top:rect.top,bottom:rect.bottom},origin=g.adjustOriginToBeInsideBounds(windowBounds,autoRect);(origin.x!==autoRect.left||origin.y!==autoRect.top)&&(menu.style.left=origin.x+"px",menu.style.top=origin.y+"px"),g.vmMain.handleFullscreenClick()},getContextMenuElement:function getContextMenuElementFn(){return this._contextMenuElement},getContextMenuPane:function getContextMenuPaneFn(){return this._contextMenuPane},closeContextMenu:function closeContextMenuFn(){var menu=this._openedContextMenu();menu&&(g.removeClass(menu,"open"),this._openedContextMenu(void 0),this._contextMenuElement=void 0,this._contextMenuPane=void 0,g.vmMain.cancelFullscreenClick())},getModalForId:function getModalForIdFn(id){return this._registeredModals[id]},isModalBound:function isModalBoundFn(id){var element=document.getElementById(id);return g.dataFor(element.firstElementChild)!==this},isModalOpen:function isModalOpenFn(id){var newModals=this.modalStack.get();if(!id)return newModals.length>0||this._openModals.length>0;for(var i=0;i<newModals.length;i++)if(newModals[i].id===id)return!0;return this._openModals.indexOf(id)>=0?!0:void 0},getTopModal:function getTopModalFn(){return this._openModals[this._openModals.length-1]},removeTopModal:function removeTopModalFn(){return this._openModals.pop()},addTopModal:function addTopModalFn(id){this._openModals.push(id)},isTopModal:function isTopModalFn(id){return this.getTopModal()===id},registerModal:function registerModalFn(id,modalObj){try{g.PAssert(4066,id,"Must have a valid modal id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4067,modalObj,"Must have a valid modal object to bind to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4068,!this._registeredModals[id],"Should only register a modal a single time: "+id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4069,modalObj instanceof ModalBase,"Can only register valid modals")}catch(PERR){g.reportError(PERR)}this._registeredModals[id]=modalObj},openModalNew:function openModalNewFn(id,params){try{g.PAssert(4070,void 0===params||g.isObject(params),"Must always pass in a valid object for params")}catch(PERR){g.reportError(PERR)}if(!this.isModalOpen(id)){params=params||{};try{g.PAssert(4071,void 0===params.id,"Should not already have an ID defined with modal params")}catch(PERR){g.reportError(PERR)}params.id=id,Sel.reset(),this.modalStack.push(params)}},closeModalNew:function closeModalNewFn(id,callbackValue){var index=this.modalStack.get().indexOfWithProperty("id",id);if(index>=0){var modal=this.modalStack.get()[index];this.modalStack.removeAt(index),modal.callback&&modal.callback(callbackValue)}},openModal:function openModalFn(id,params){if(this.newModals.indexOf(id)>=0)this.openModalNew(id,params);else{try{g.PAssert(4072,this._registeredModals[id],"Must have registered the modal before opening it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4073,!this.isModalOpen(id),"Must not have the same modal open multiple times: "+id)}catch(PERR){g.reportError(PERR)}if(this.isModalOpen(id))return;Sel.reset();var activeModal=this.getModalForId(id);activeModal.openModal.apply(activeModal,Array.prototype.slice.call(arguments,1)),this.isModalBound(id)||g.applyBindings(activeModal,id),this.addTopModal(id),this.isModalVisible(!0)}},closeModal:function closeModalFn(id){try{g.PAssert(4074,this._registeredModals[id],"Must have registered the modal before closing it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4075,this.isModalOpen(id),"Modal must be open to be closed: "+id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4076,this.isTopModal(id),"Tried to close the wrong modal: "+id+", "+this.getTopModal())}catch(PERR){g.reportError(PERR)}arguments.length>1?this._closeModalInternal.apply(this,Array.prototype.slice.call(arguments,1)):this._closeModalInternal()},_closeModalInternal:function _closeModalInternalFn(){try{g.PAssert(4077,this._openModals.length>0,"Tried to close when no modal was open")}catch(PERR){g.reportError(PERR)}if(0!==this._openModals.length){var currentModal=this.getModalForId(this.removeTopModal());this.modalInputOn=void 0,0===this._openModals.length&&this.isModalVisible(!1),Dispatcher.fireEvent("closeKeyboard",[]),currentModal.closeModal.apply(currentModal,arguments)}},focusModalInputMobile:function focusModalInputMobileFn(e,element){try{g.PAssert(4078,platform.mobile,"Should not call this from non-mobile")}catch(PERR){g.reportError(PERR)}var currentModal=this.getModalForId(this.getTopModal());this.modalInputOn?this.modalInputOn!==element?(element.focus(),currentModal.onKeyboardOpened&&requestAnimationFrame(function(){currentModal.onKeyboardOpened(e)}.bind(this)),e.preventDefault(),e.stopPropagation(),g.enforceScroll()):g.enforceScroll():g.openKeyboardOnElement(e,element,function(){platform.app?(currentModal&&currentModal.onKeyboardOpened&&currentModal.onKeyboardOpened(e),requestAnimationFrame(function(){requestAnimationFrame(function(){element.focus(),g.enforceScroll()})})):element.focus()}.bind(this))},onTapModal:{onClick:function onClickFn(e){var prevent=!0;if("modals"===e.srcElement.id){var topModal=this.getTopModal();topModal&&this.closeModal(topModal),this.modalInputOn=void 0}else e.srcElement===this.modalInputOn?prevent=!1:g.isKeyboardInputElement(e.srcElement)||g.hasClass(e.srcElement,"input")?(platform.mobile&&(prevent=!1,this.focusModalInputMobile(e,e.srcElement)),this.modalInputOn=e.srcElement):this.modalInputOn=void 0;prevent&&platform.mobile&&(e.preventDefault(),e.stopPropagation())
}},onCloseKeyboard:function onCloseKeyboardFn(){this.modalInputOn=void 0},openItemMenu:function openItemMenuFn(itemOpened,e){var pane=g.getPaneForElement(e.target),foundZoomCandidate=!1,anyIncomplete=!1,canOpen=!0;this.openOnItem=void 0;var checkFn=function(item,index,total){try{g.PAssert(4079,item,"Item must be defined")}catch(PERR){g.reportError(PERR)}if(item&&0===index&&(this.itemIsHeader(item.isHeader()),this.itemIsStarred(item.isStarred()),this.itemCanCollapse(pane.supportCollapsing&&(item.isHeader()||item.hasChildren())),this.itemIsCollapsed(item.isCollapsed(pane,!1)),this.itemIsArchived(item.isArchived()),this.itemCanIndent(pane.supportIndent&&!item.isNote()&&0!==item.getIndex()),this.itemCanUnindent(pane.supportIndent&&!item.isNote()&&item.parent()!==g.focusedItem),this.itemCanAddNote(!item.isNote()),this.itemCanArchive(!item.isNote()),this.itemCanUnarchive(item.isArchived()),item.hasAttachmentType(C.PluginType.Email))){var attach=item.getAttachments()[0],plugin=attach.getPlugin();this.itemIsRead(!plugin.isItemUnread(item)),this.itemIsImportant(plugin.isItemImportant(item)),this.itemIsStarred(plugin.isItemStarred(item)),this.itemIsArchivedMail(plugin.isItemArchived(item)),this.itemIsTrashed(plugin.isItemFullTrashed(item)),this.itemCanSnooze(AccountManager.isLinkedAccountAuthorized(attach.getField("accountID"),GScope.GmailModify)),this.itemIsTrashed()&&(this.itemCanArchive(!1),this.itemCanUnarchive(!1))}item.isComplete()||(anyIncomplete=!0),foundZoomCandidate||(pane.isWriteable&&item.canZoom()||!pane.isWriteable&&(item.isHeader()||item.hasChildren()))&&(foundZoomCandidate=!0,this.itemCanZoom(!0)),foundZoomCandidate||index!==total-1||this.itemCanZoom(!1)}.bind(this);pane.isWriteable?Sel.isValid()?pane.applyToSelection(checkFn):canOpen=!1:pane.isWriteable||(this.openOnItem=itemOpened,checkFn(itemOpened,0,1)),this.itemIsComplete(!anyIncomplete),canOpen&&this.openContextMenu(pane,itemOpened,e,{left:e.pageX,top:e.pageY},!1)},closeItemMenu:function closeItemMenuFn(){this.openOnItem=void 0,this.closeContextMenu()},itemContextText:function itemContextTextFn(){return this.itemIsCollapsed()?"Expand":"Collapse"},itemContextIcon:function itemContextIconFn(){return this.itemIsCollapsed()?"icon-add":"icon-minus"},itemArchivedText:function itemArchivedTextFn(){return this.itemIsArchived()?"Unarchive":"Archive"},itemCompleteText:function itemCompleteTextFn(){return this.itemIsComplete()?"Uncomplete":"Complete"},itemStarText:function itemStarTextFn(){return this.itemIsStarred()?"Unstar":"Star"},itemReadText:function itemReadTextFn(){return this.itemIsRead()?"Mark as unread":"Mark as read"},itemUnreadHotkey:function itemUnreadHotkeyFn(){return this.itemIsRead()?"U":""},itemImportantText:function itemImportantTextFn(){return this.itemIsImportant()?"Mark as unimportant":"Mark as important"},itemArchiveMailText:function itemArchiveMailTextFn(){return this.itemIsArchivedMail()?"Unarchive":"Archive"},itemTrashedText:function itemTrashedTextFn(){return this.itemIsTrashed()?"Undelete":"Delete"},hotkeyText:function hotkeyTextFn(key){return platform.secModKey+" + "+key},primaryHotkeyText:function primaryHotkeyTextFn(key){return platform.priModKey+" + "+key},applyToOpenItem:function applyToOpenItemFn(fn){fn(this.openOnItem)},onTapItemMenu:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var id=e.srcElement.id,pane=g.focusedPane,close=!0,applyFn=this.openOnItem?this.applyToOpenItem:g.vmMain.applyToSelection;switch(id||(id=e.srcElement.parentNode.id),id){case"itemComplete":g.vmMain.applyFnToSelection("isComplete",{toggle:!0,value2:ChangeType.Local});break;case"itemStar":g.vmMain.applyFnToSelection("isStarred",{toggle:!0,value2:ChangeType.Local});break;case"itemIndent":g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1});break;case"itemUnindent":g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0});break;case"contextMenuPriority":break;case"itemPriorityNone":pane.applyPriorityToSelection(VMLIFlag.None);break;case"itemPriorityLow":pane.applyPriorityToSelection(VMLIFlag.P2);break;case"itemPriorityMed":pane.applyPriorityToSelection(VMLIFlag.P1);break;case"itemPriorityHigh":pane.applyPriorityToSelection(VMLIFlag.P0);break;case"itemAddNote":applyFn(function(item){return item.editNote(),!1});break;case"itemCollapseDrive":case"itemCollapse":applyFn(function(item){item.toggleCollapsed(pane)},{resetSelection:!0});break;case"itemZoomDrive":case"itemZoom":applyFn(function(item){return item.canZoom()?(g.vmMain.zoomin(item),!1):!0});break;case"itemZoomNewPane":applyFn(function(item){if(item.canZoom()){var index=g.vmMain.paneManager.getPaneIndex(pane)+1,newPane=PaneFactory.createPane(PaneMode.Outline,{item:item});return g.vmMain.paneManager.addPaneAtIndex(newPane,index),Sel.setFocusedPane(newPane),!1}return!0});break;case"itemGoto":applyFn(function(item){return g.scrollToAndHighlightItem(item,g.focusedPane),!1});break;case"itemUnarchive":applyFn(function(item){item.isArchived()&&g.focusedPane.runUnarchive(item)});break;case"itemArchive":pane.isWriteable&&pane.archiveSelected(!0);break;case"itemDelete":var item=Sel.getStartItem();if(item.isNote()){var index=Sel.getStartIndex(),parent=item.parent();item.parent().setNote(void 0,ChangeType.Local),Sel.selectIndex(index-1,parent.getParsedText().length)}else pane.isWriteable&&pane.deleteSelected();break;case"itemEdit":var item=Sel.getStartItem();item.isNote()&&item.editNote();break;case"itemAddToCalendar":var item=Sel.getStartItem();try{g.PAssert(4080,item,"Must have a valid item")}catch(PERR){g.reportError(PERR)}var pluginCalendar=g.vmMain.getDefaultCalendarPlugin();pluginCalendar&&pluginCalendar.hotkeyCreateEvent();break;case"itemDeleteCalendar":var attach=g.vmMain.pluginManager.getAttachmentFromElement(this.getContextMenuElement());try{g.PAssert(4081,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}var item=Sel.getStartItem();try{g.PAssert(4082,item,"Must have a valid item")}catch(PERR){g.reportError(PERR)}var pluginCalendar=attach.getPlugin();Sel.reset(),pluginCalendar.deleteCalendarEventForItem(item,attach,function(){},function(success){success||g.toasts.pushMessage({text:"There was an error removing the event from your Google Calendar.",action:MessageAction.Okay})});break;case"itemUndeleteCalendar":break;case"itemInviteContact":break;case"itemMarkAsRead":pane.markReadSelected(!this.itemIsRead());break;case"itemStarGmail":pane.toggleStarSelected();break;case"itemImportantGmail":pane.toggleImportantSelected();break;case"itemArchiveGmail":pane.archiveSelected(!this.itemIsArchivedMail());break;case"itemDeleteGmail":var plugin=g.vmMain.getDefaultEmailPlugin();pane.deleteSelected(plugin.isGmailItem,!this.itemIsTrashed());break;case"itemLabelGmail":pane.autocompleteLabel();break;case"itemSnoozeGmail":pane.autocompleteSnooze();break;case"itemScheduleGmail":pane.autocompleteSchedule();break;case"itemMove":case"itemMoveGmail":pane.autocompleteMove();break;case"itemReply":pane.replySelected();break;case"itemReplyAll":pane.replyAllSelected();break;case"itemForward":pane.forwardSelected();break;case"contextMenuItem_Drive":case"contextMenuItem_Calendar":case"contextMenuItem_Date":case"contextMenuItem_Contact":case"contextMenuItem_Archived":case"contextMenuItem_Gmail":case"contextMenuItem_Note":case"contextMenuItem":close=!1;break;default:if(g.hasClass(e.srcElement,"hotkey"))close=!1;else try{g.PAssert(4083,!1,"Unknown context menu item: ",g.elementToString(e.srcElement))}catch(PERR){g.reportError(PERR)}}close&&(g.sendEvent("ContextMenu",id),this.closeItemMenu())}},confirm:function confirmFn(text,cb){try{g.PAssert(4084,cb,"Confirm modals should have callbacks",text)}catch(PERR){g.reportError(PERR)}this.openModalNew(Modals.Confirm,{text:text,callback:cb})},alert:function alertFn(params){try{g.PAssert(4085,!params.action,"Still using an old style alert",params)}catch(PERR){g.reportError(PERR)}params.action&&(params.callback=params.action),this.openModalNew(Modals.Alert,params)},options:function optionsFn(text,options,cb){try{g.PAssert(4086,g.isArray(options,"Must have valid options array"))}catch(PERR){g.reportError(PERR)}try{g.PAssert(4087,cb,"Options modal must have a callback")}catch(PERR){g.reportError(PERR)}this.openModalNew(Modals.Options,{text:text,options:options,callback:cb})},openSettings:function openSettingsFn(section){tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.OpenSettingsMenu}),this.openModalNew(Modals.Settings,{section:section})},getUserEmail:function getUserEmailFn(){return g.getUserIdentifier()},getUserName:function getUserNameFn(){var user=gdata.authenticatedUser();return user?user.displayName:g.vmMain.gdriveStatus()===DriveStatus.Saved?"Connected":g.vmSetup.loginState()===LoginState.LOGGED_IN?"Connecting":"Demo"},openMenuExternalApp:function openMenuExternalAppFn(html,onTap){var el=g.element("contextMenuMobileExternalApp");this.contextBottomOpen=el,this.mobileExternalAppText(html),g.addClass(el,"showing");try{g.PAssert(4088,onTap,"onTap must be defined")}catch(PERR){g.reportError(PERR)}onTap&&(this._mobileExternalAppTap=onTap)},closeContextBottom:function closeContextBottomFn(){var el=this.contextBottomOpen;g.removeClass(el,"showing"),this.contextBottomOpen=void 0},onTapMobileExternalApp:function onTapMobileExternalAppFn(e){var onTap=this._mobileExternalAppTap;try{g.PAssert(4089,onTap,"_mobileExternalAppTap must be defined")}catch(PERR){g.reportError(PERR)}onTap&&onTap(),this.closeContextBottom(),e.preventDefault(),e.stopPropagation()},_indexOfCompose:function _indexOfComposeFn(draftID){for(var stack=this.emailComposeStack.get(),i=0;i<stack.length;++i){var msg=stack[i].draftMsg;if(msg.id===draftID)return i}return-1},isComposeOpenForEmail:function isComposeOpenForEmailFn(draftID){return this._indexOfCompose(draftID)>=0},openComposeEmail:function openComposeEmailFn(emailPlugin,threadID,draftID,initData){try{g.PAssert(4090,emailPlugin,"Must have a valid email plugin")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4091,!threadID||g.isString(threadID),"Must have a string threadID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4092,!draftID||g.isString(draftID),"Must have a string draftID")}catch(PERR){g.reportError(PERR)}if(Sel.reset(),this.isComposeOpenForEmail());else{var draftData=emailPlugin.getDraftByID(emailPlugin.getDefaultAccount(),threadID,draftID,initData);try{g.PAssert(4093,draftData,"Must always create a valid draft")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4094,this.emailComposeStack.indexOf(draftData)<0,"Must not double-open drafts, should re-use")}catch(PERR){g.reportError(PERR)}this.emailComposeStack.get().indexOfWithProperty("attach",draftData.attach)<0&&this.emailComposeStack.push(draftData)}tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ComposeEmail})},closeComposeEmail:function closeComposeEmailFn(threadAttach,message){var composeIndex=this._indexOfCompose(message.id);try{g.PAssert(4095,composeIndex>=0,"Must have found a valid composing email to remove")}catch(PERR){g.reportError(PERR)}this.emailComposeStack.removeAt(composeIndex)}},VMMenus}),define("VMDocument",["require","exports","module","globals","Constants","data","goog","Observable"],function(require,exports,module){function VMDocument(p,isRemoteData){this._remoteData=isRemoteData?p:void 0,p=p||{},this.id=p.id,this._title=new Observable(p.title||""),this._isShared=new Observable(p.shared||!1),this._isOwned=new Observable(!this._remoteData),this._isOpen=new Observable(!1),this._isDeleted=!1,this._docFolderID=void 0,this._realtimeDoc=void 0,this._remoteData&&this.updateData(this._remoteData)}var g=require("globals"),C=require("Constants"),d=require("data"),goog=require("goog"),Observable=require("Observable"),LoadState={Creating:0,Closed:1,Opening:2,Opened:3};return VMDocument.prototype={updateData:function updateDataFn(remoteData,isRemoteData){try{g.PAssert(4096,remoteData,"Must supply remote data to update doc")}catch(PERR){g.reportError(PERR)}if(remoteData){if(this._remoteData){try{g.PAssert(4097,!remoteData.id||remoteData.id===this.id,"ID must either not exist or be the same")}catch(PERR){g.reportError(PERR)}for(var prop in remoteData)remoteData.hasOwnProperty(prop)&&(this._remoteData[prop]=remoteData[prop])}else this._remoteData=remoteData,this.id=remoteData.id;g.settings.get(Settings.gdocId)===this._remoteData.id&&g.settings.set(Settings.gdocTitle,this._remoteData.title),this._title.set(this._remoteData.title),this._isShared.set(this._remoteData.shared);var userPermission=this._remoteData.userPermission;this._isOwned.set(userPermission&&"me"===userPermission.id&&"owner"===userPermission.role?!0:!1)}},setRealtimeDoc:function setRealtimeDocFn(realtimeDoc){try{g.PAssert(4098,!this._realtimeDoc,"Must only have a single realtime doc instance per doc")}catch(PERR){g.reportError(PERR)}this._realtimeDoc=realtimeDoc},hasDriveBacking:function hasDriveBackingFn(){return!!this._remoteData},generateShareInfo:function generateShareInfoFn(toUser){var sinfo={};sinfo.fromUser=g.getUserIdentifier(),toUser&&(sinfo.toUser=toUser);var encodedString;try{var infoString=JSON.stringify(sinfo);encodedString=g.utf8_to_b64(infoString)}catch(err){g.reportError(err)}return encodedString},insertPermission:function insertPermissionFn(addr,cb){try{g.PAssert(4099,this._remoteData,"Must have remote data to add permissions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4100,this.id,"Must specify a valid document ID to operate on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4101,addr,"Must specify a valid email to add")}catch(PERR){g.reportError(PERR)}var docURL="https://www.moo.do/app/#login=true&file="+this.id+"&sinfo="+this.generateShareInfo(addr),successCB=function(result){g.XHR_PrivateAPI({type:"POST",path:"/sharing/shareDoc",data:{fromUser:g.getUserIdentifier(),toEmail:addr,docURL:docURL},requireAuth:!0,cb:function cbFn(xhr){200!==xhr.status}}),this.getDocumentFolder(function(folderID){var folderSuccessCB=function(result){},folderFailureCB=function(result){};g.vmMain.remoteAPI().drivePermissionsInsert(folderID,addr,!1,folderSuccessCB,folderFailureCB)}),result&&(this._remoteData.permissions.push(result),this._remoteData.shared=!0,this._isShared.set(!0)),cb(!!result)}.bind(this),failureCB=function(result){var sentRetry=!1;if(result.error&&400===result.error.code)for(var errors=result.error.errors,i=0;i<errors.length;++i){var err=errors[i];"invalidSharingRequest"===err.reason&&(g.vmMain.remoteAPI().drivePermissionsInsert(this.id,addr,!0,successCB,failureCB),sentRetry=!0)}sentRetry||cb(!1)}.bind(this);g.vmMain.remoteAPI().drivePermissionsInsert(this.id,addr,!1,successCB,failureCB)},deletePermission:function deletePermissionFn(permissionID,cb){try{g.PAssert(4102,this._remoteData,"Must have valid remote data to remove permissions")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4103,this.id,"Must specify a valid document ID to operate on")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4104,permissionID,"Must specify a valid permissionID to remove")}catch(PERR){g.reportError(PERR)}var successCB=function(result){for(var j=0;j<this._remoteData.permissions.length;++j)if(this._remoteData.permissions[j].id===permissionID){this._remoteData.permissions.removeAt(j);break}1===this._remoteData.permissions.length&&(this._remoteData.shared=!1,this._isShared.set(!1)),cb(!0)}.bind(this),failureCB=function(result){cb(!1)};g.vmMain.remoteAPI().drivePermissionsDelete(this.id,permissionID,successCB,failureCB),this.getDocumentFolder(function(folderID){var folderSuccessCB=function(result){},folderFailureCB=function(result){};g.vmMain.remoteAPI().drivePermissionsDelete(folderID,permissionID,folderSuccessCB,folderFailureCB)})},listPermissions:function listPermissionsFn(cb){try{g.PAssert(4105,this._remoteData,"Must have valid remote data to list permissions")}catch(PERR){g.reportError(PERR)}var successCB=function(result){cb(result.items)},failureCB=function(result){cb(void 0)};g.vmMain.remoteAPI().drivePermissionsList(this.id,successCB,failureCB)},getDocumentFolder:function getDocumentFolderFn(cb){try{g.PAssert(4106,!g.isDemoMode(),"Should not be creating file structure in demo mode")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4107,cb,"Must provide a valid callback when getting the doc folder")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4108,this.id,"Must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4109,this.getTitle(),"Must have a valid doc title")}catch(PERR){g.reportError(PERR)}if(this._docFolderID)return cb(this._docFolderID);var folderID;g.loadGoogleAPI("drive","v2",function(){var createDocFolder=function(){this.createDocumentFileStructure(function(newFolderID){return newFolderID?(this._docFolderID=newFolderID,cb(newFolderID)):cb(folderID)})}.bind(this);if(folderID)try{var successCB=function(result){return result?(this._docFolderID=folderID,this.updateDocumentFolderProps(result),cb(folderID)):void createDocFolder()}.bind(this),failureCB=function(result){return cb(folderID)};g.vmMain.remoteAPI().driveFilesGet(folderID,successCB,failureCB)}catch(err){return g.reportError(err),cb()}else{var docPropValue=goog.DocFolderPropertyPrefix+this.id;try{var q="properties has {key='"+goog.DocFolderProperty+"' and value='"+docPropValue+"' and visibility='PRIVATE'} and trashed=false",options={getAllPages:!0},successCB=function(results){if(0!==results.length){try{g.PAssert(4110,1===results.length,"Must have only a single document folder")}catch(PERR){g.reportError(PERR)}var docFolderInfo=results[0];return this._docFolderID=docFolderInfo.id,this.updateDocumentFolderProps(docFolderInfo),cb(docFolderInfo.id)}createDocFolder()}.bind(this),failureCB=function(response){return cb()};g.vmMain.remoteAPI().driveFilesList(q,successCB,failureCB,options)}catch(err){return g.reportError(err),cb()}}}.bind(this))},updateDocumentFolderProps:function updateDocumentFolderPropsFn(docFolderInfo){try{g.PAssert(4111,docFolderInfo,"Must provide valid doc folder info")}catch(PERR){g.reportError(PERR)}if(this.getTitle()){var needTitleUpdate=!1,needTitleInsert=!1;if(docFolderInfo.properties){for(var i=0;i<docFolderInfo.properties.length;++i)if(docFolderInfo.properties[i].key===goog.DocFolderTitleProperty){docFolderInfo.properties[i].value!==this.getTitle()&&(needTitleUpdate=!0);break}}else needTitleInsert=!0;if(needTitleInsert){var successCB=function(){},failureCB=function(response){g.reportError(new Error("Unable to update drive folder title property"))};g.vmMain.remoteAPI().drivePropertiesInsert(docFolderInfo.id,goog.DocFolderTitleProperty,this.getTitle(),successCB,failureCB)}else if(needTitleUpdate){var successCB=function(){},failureCB=function(response){g.reportError(new Error("Unable to update drive folder title property"))};g.vmMain.remoteAPI().drivePropertiesUpdate(docFolderInfo.id,goog.DocFolderTitleProperty,this.getTitle(),successCB,failureCB)}}goog.getRootFolder(function(rootFolderID){if(rootFolderID){var hasRootFolderAsParent=!1;if(docFolderInfo.parents)for(var i=0;i<docFolderInfo.parents.length;++i)if(docFolderInfo.parents[i].id===rootFolderID){hasRootFolderAsParent=!0;break}if(!hasRootFolderAsParent){var successCB=function(){},failureCB=function(response){g.reportError(new Error("Unable to add shared doc folder to root folder"))};g.vmMain.remoteAPI().driveParentsInsert(docFolderInfo.id,rootFolderID,successCB,failureCB)}}}),this.hasDriveBacking()&&this.ensureFolderPermissions(docFolderInfo)},createDocumentFileStructure:function createDocumentFileStructureFn(cb){try{g.PAssert(4112,this.id,"In order to create a valid folder structure we must have a valid document ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4113,this.getTitle(),"Must provide a valid document title")}catch(PERR){g.reportError(PERR)}goog.getRootFolder(function(rootFolderID){if(!rootFolderID)return cb();var props=[{key:goog.DocFolderProperty,value:goog.DocFolderPropertyPrefix+this.id,visibility:"PRIVATE"}];this.getTitle()&&props.push({key:goog.DocFolderTitleProperty,value:this.getTitle(),visibility:"PRIVATE"});var requestFn=["gapi","client","drive","files","insert"],requestData={resource:{fields:"createdDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,userPermission(id,role,type)",mimeType:goog.FOLDER_MIMETYPE,title:goog.DocFolderTitlePrefix+this.id,writersCanShare:!1,parents:[{id:rootFolderID}],properties:props}},successCB=function(result){return this._docFolderID=result.id,this.hasDriveBacking()&&this.ensureFolderPermissions(result),cb(result.id)}.bind(this),failureCB=function(result){return cb()};g.vmMain.remoteAPI().runRemoteSingleRequest(requestFn,requestData,successCB,failureCB)}.bind(this))},ensureFolderPermissions:function ensureFolderPermissionsFn(folderInfo){function folderHasPermission(email){var hasPermission=!1;if(folderPermissionList)for(var i=0;i<folderPermissionList.length;++i)if(folderPermissionList[i].emailAddress===email){hasPermission=!0;break}return hasPermission}try{g.PAssert(4114,this._remoteData,"Must have valid remote data to take permissions from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4115,folderInfo,"Must supply a valid folder ID to set permissions on")}catch(PERR){g.reportError(PERR)}var successCB=function(result){},failureCB=function(result){},folderPermissionList=folderInfo.permissions,docPermissionList=this._remoteData.permissions;try{g.PAssert(4116,docPermissionList,"Must always have a valid list of permissions for this doc")}catch(PERR){g.reportError(PERR)}if(docPermissionList)for(var i=0;i<docPermissionList.length;++i){var entry=docPermissionList[i];if("anyone"===entry.type);else{var email=entry.emailAddress;email&&"owner"!==entry.role&&(folderHasPermission(email)||g.vmMain.remoteAPI().drivePermissionsInsert(folderInfo.id,email,!1,successCB,failureCB))}}},rename:function renameFn(newTitle,cb){if(this._remoteData||this.getTitle()){try{g.PAssert(4117,newTitle,"Must specify a valid title to rename to")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4118,g.isFunction(cb),"Must supply a valid callback fn")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4119,this.getTitle(),"Must have a valid title set already")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4120,this.getTitle()!==newTitle,"Should always be setting to a different title")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","drive","files","patch"],requestData={fileId:this.id,resource:{title:newTitle}},successCB=function(result){this.getDocumentFolder(function(folderID){var folderSuccessCB=function(result){},folderFailureCB=function(result){g.reportError(new Error("Unable to update drive folder title property"))};g.vmMain.remoteAPI().drivePropertiesUpdate(folderID,goog.DocFolderTitleProperty,newTitle,folderSuccessCB,folderFailureCB)}.bind(this)),this._title.set(newTitle),this._remoteData.title=newTitle,this.isOpen()&&goog.setDocInfo(this.id,newTitle),log("File renamed to:"+newTitle),cb(!0)}.bind(this),failureCB=function(result){cb(!1)};g.vmMain.remoteAPI().runRemoteSingleRequest(requestFn,requestData,successCB,failureCB)}else this._title.set(newTitle),cb(!0)},shareFile:function shareFileFn(fileID,cb){try{g.PAssert(4121,fileID,"Must specify a valid fileID to share")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4122,cb,"Must specify a valid callback for sharing")}catch(PERR){g.reportError(PERR)}this.getDocumentFolder(function(folderID){var successCB=function(result){cb(!0,result)},failureCB=function(result){cb(!1,result)};g.vmMain.remoteAPI().driveParentsInsert(fileID,folderID,successCB,failureCB)})},unshareFile:function unshareFileFn(fileID,cb){try{g.PAssert(4123,fileID,"Must specify a valid fileID to unshare")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4124,cb,"Must specify a valid callback for unsharing")}catch(PERR){g.reportError(PERR)}this.getDocumentFolder(function(folderID){var successCB=function(result){cb(!0)},failureCB=function(result){cb(!1)};g.vmMain.remoteAPI().driveParentsDelete(fileID,folderID,successCB,failureCB)})},deleteData:function deleteDataFn(cb){var delsExpected=0,errorInDelete=!1,delSuccessCB=function(){delsExpected--,checkDelCompleted()},delFailureCB=function(){errorInDelete=!0,delsExpected--,checkDelCompleted()},checkDelCompleted=function(){0!==delsExpected||errorInDelete||this.getDocumentFolder(function(folderID){var folderSuccessCB=function(){this._docFolderID=void 0},folderFailureCB=function(){};g.vmMain.remoteAPI().driveFilesTrash(folderID,folderSuccessCB,folderFailureCB)})}.bind(this),successCB=function(result){this.getDocumentFolder(function(folderID){var options={getAllPages:!0,maxPageResults:500},listSuccessCB=function(result){for(var i=0;i<result.length;++i){var requestFn=["gapi","client","drive","children","delete"],delRequestData={folderId:folderID,childId:result[i].id};delsExpected++,g.vmMain.remoteAPI().runRemoteSingleRequest(delRequestFn,delRequestData,delSuccessCB,delFailureCB)}},listFailureCB=function(result){};g.vmMain.remoteAPI().driveChildrenList(folderID,listSuccessCB,listFailureCB,options)}),this._isDeleted=!0,this._remoteData&&(this._remoteData.trashed=!0),cb(!0)}.bind(this),failureCB=function(result){cb(!1)};g.vmMain.remoteAPI().driveFilesTrash(this.id,successCB,failureCB)},isShared:function isSharedFn(){return this._isShared.get()},isOwned:function isOwnedFn(){return this._isOwned.get()},open:function openFn(){try{g.PAssert(4125,!this._isOpen.get(),"Document must be closed to be opened")}catch(PERR){g.reportError(PERR)}this._isOpen.set(!0),g.vmMain.docManager.setDocOpened(this.id)},close:function closeFn(){try{g.PAssert(4126,this._isOpen.get(),"Document must be opened to be closed")}catch(PERR){g.reportError(PERR)}this._isOpen.set(!1),g.vmMain.docManager.setDocClosed(this.id)},isOpen:function isOpenFn(){return this._isOpen.get()},getTitle:function getTitleFn(){return this._title.get()},getData:function getDataFn(){return this._remoteData}},VMDocument}),define("ContactsAutocomplete",["ko","globals","util","platform","data"],function(ko,g,util,platform,d){function ContactsAutocomplete(onSelectedFn){try{g.PAssert(4127,onSelectedFn,"Must supply a valid selected callback")}catch(PERR){g.reportError(PERR)}this._matchedContacts=ko.observableArray(),this.selectedContactIndex=ko.observable(0),this._element=void 0,this._inputElement=void 0,this.onSelectedCallback=onSelectedFn,util.forceBind("_onInputBlur",this)}var ContactsAutocompleteFns={onLoad:function onLoadFn(element){this._element=element,this.contactsListEle=element.firstElementChild},setInputElement:function setInputElementFn(inputElement){this._inputElement!==inputElement&&(this._inputElement&&this._cleanupInputElement(),this._inputElement=inputElement,g.copyStyles(inputElement,this._element,["width"]),this._setupInputElement())},_setupInputElement:function _setupInputElementFn(){try{g.PAssert(4128,this._inputElement,"Must have specified a valid input element")}catch(PERR){g.reportError(PERR)}this._inputElement.addEventListener("blur",this._onInputBlur)},_cleanupInputElement:function _cleanupInputElementFn(){try{g.PAssert(4129,this._inputElement,"Must have specified a valid input element")}catch(PERR){g.reportError(PERR)}this._inputElement.removeEventListener("blur",this._onInputBlur)},_onInputBlur:function _onInputBlurFn(){this.forceHide()},onkeydown:function onkeydownFn(data,e){if(platform.normalizeKeys(e),e.normCode===KeyCode.Enter){var newEmailTextEle=this.contactsListEle.children[this.selectedContactIndex()];return newEmailTextEle&&this.onSelectedCallback(newEmailTextEle.textContent),e.preventDefault(),e.stopImmediatePropagation(),!1}if(e.normCode===KeyCode.UpArrow){var newIndex=this.selectedContactIndex()-1;return 0>newIndex&&(newIndex=this._matchedContacts().length-1),this.selectedContactIndex(newIndex),e.preventDefault(),e.stopImmediatePropagation(),g.scrollIntoView(this.contactsListEle.children[newIndex],200),!1}if(e.normCode===KeyCode.DownArrow){var newIndex=this.selectedContactIndex()+1;return newIndex>=this._matchedContacts().length&&(newIndex=0),this.selectedContactIndex(newIndex),e.preventDefault(),e.stopImmediatePropagation(),g.scrollIntoView(this.contactsListEle.children[newIndex],200),!1}return!0},onContactEmailUpdate:function onContactEmailUpdateFn(newEmail){if(newEmail){var contacts=d.contactManager.findEmailsLike(newEmail);contacts&&this._matchedContacts(contacts)}else this._matchedContacts([]);var inputElement=document.activeElement;"INPUT"===inputElement.nodeName&&this.setInputElement(inputElement)},showContactList:function showContactListFn(){return this._matchedContacts().length>0},forceHide:function forceHideFn(){this._matchedContacts([])},computeSelectionIndex:function computeSelectionIndexFn(e){var index=0,ele=e.srcElement||e.target;for("#text"===ele.tagName&&(ele=ele.parentNode);ele=ele.previousElementSibling;)++index;this.selectedContactIndex(index)},onTapContactList:function onTapContactListFn(e){this._matchedContacts([]);var selectedEmail=e.startSrc.innerText;return this.onSelectedCallback(selectedEmail),this.selectedContactIndex(0),e.preventDefault(),e.stopImmediatePropagation(),!1},onMouseoverContactList:function onMouseoverContactListFn(self,e){this.computeSelectionIndex(e)},isContactSelected:function isContactSelectedFn(index){return this.selectedContactIndex()===index()},renderContact:function renderContactFn(contact){var email=contact.email,text="",hasText=contact.text&&contact.text!==email;return hasText&&(text=contact.text+" <"),text+=email,hasText&&(text+=">"),text}};return util.extend(ContactsAutocomplete.prototype,ContactsAutocompleteFns),ContactsAutocomplete}),define("VMDocSharing",["ko","globals","util","platform","data","goog","ContactsAutocomplete","ModalBase"],function(ko,g,util,platform,d,goog,ContactsAutocomplete,ModalBase){function VMDocSharing(){this._super.constructor.call(this,Modals.ShareDoc),this.doc=ko.observable(),this.isLoading=ko.observable(!1),this.isCreating=ko.observable(!1),this.permissions=ko.observableArray(),this.permissionsNew=ko.observableArray(),this.permissionsRemove=[],this.newEmail=ko.observable(""),this.errorGlobal=ko.observable(!1),this.errorName=ko.observable(!1),this.errorInvite=ko.observable(!1),this.isSaving=ko.observable(!1),this.editing=ko.observable(!1),this.closeCallback=void 0,this.justCreated=!1,this._contactsAutocomplete=new ContactsAutocomplete(this.onContactSelected.bind(this)),this.newEmail.subscribe(this._contactsAutocomplete.onContactEmailUpdate.bind(this._contactsAutocomplete)),this.init()}var VMDocSharingFns={init:function initFn(){this.registerModal(this.open.bind(this),this.onClose.bind(this))},open:function openFn(doc,callback){this.doc(doc),this.closeCallback=callback,this.isLoading(!0),this.isCreating(!this.doc().hasDriveBacking()),this.permissions.removeAll(),this.permissionsNew.removeAll(),this.permissionsRemove=[],this.newEmail(""),this.errorGlobal(!1),this.errorName(!1),this.errorInvite(!1),this.isSaving(!1),this.editing(!1),this.justCreated=!1,this.inputName=document.getElementById("shareNameInput"),this.inputName.value=this.doc().getTitle(),this.shareLink=document.getElementById("shareLinkInput"),this.shareLink&&(this.shareLink.value="https://moo.do/app/#file="+this.doc().id+"&sinfo="+this.doc().generateShareInfo()),platform.mobile||setTimeout(function(){this.inputName.focus()}.bind(this),0),this.isCreating()?this.isLoading(!1):this.doc().listPermissions(this.permissionHandler.bind(this))},addPadding:function addPaddingFn(){var padSize=platform.windowHeight()-platform.getKBSize()+g.topBarHeight;platform.android&&(padSize=platform.getKBSize()+20),g.element("shareScroller").style.paddingBottom=padSize+"px"},removePadding:function removePaddingFn(){document.getElementById("shareScroller").style.paddingBottom=""},permissionHandler:function permissionHandlerFn(permissionList){if(permissionList){this.isLoading(!1);for(var permissions=[],i=0;i<permissionList.length;++i){var item=permissionList[i];
item.emailAddress!==g.getUserIdentifier()&&(item.onRemove=this.onRemove.bind(this,item),"anyone"!==item.id&&(item.emailAddress||(item.emailAddress="owner"===item.role?"Owner":""),"owner"===item.role?permissions.splice(0,0,item):permissions.push(item)),item.emailDisplay="("+item.emailAddress+")")}this.permissions(permissions)}},isOwned:function isOwnedFn(){return this.doc().isOwned&&this.doc().isOwned()},saveText:function saveTextFn(){if(this.isCreating())return this.isSaving()?"CREATING...":"CREATE";if(platform.mobile&&this.editing()){switch(this.editing()){case"Name":return"SAVE";case"Invite User":return"INVITE"}return""}return this.newEmail().length>0?"INVITE":this.isSaving()?"SAVING...":"SAVE"},titleText:function titleTextFn(){return platform.mobile&&this.editing()?this.editing():this.isCreating()?"Create Document":"Edit Document"},onKeyboardOpened:function onKeyboardOpenedFn(e){this.editing(e.srcElement.title)},inviteUser:function inviteUserFn(){var userStr=this.newEmail();if(0===userStr.length)return void this.errorInvite("");var emailAddr=this._getEmailAddrFromStr(userStr);if(!g.isEmail(emailAddr))return this.errorInvite("Please enter a valid email address."),!1;var user={emailAddress:emailAddr,error:ko.observable(!1)},contact=d.contactManager.findContactByEmail(user.emailAddress.toLowerCase());return user.name=contact?contact.text:user.emailAddress,user.onRemove=this.onRemoveNew.bind(this,user),this.permissionsNew.push(user),this.newEmail(""),this.errorInvite(!1),!0},checkName:function checkNameFn(){var title=this.inputName.value.trim();return title.length>0&&title.length<255?(this.errorName(!1),!0):(this.errorName("Error: Document name must be >0 and <255 characters."),!1)},rename:function renameFn(){var title=this.inputName.value.trim();title!==this.doc().getTitle()&&this.doc().rename(title,function(success){success||this.errorName("Error: Unable to update name on remote server.")}.bind(this))},create:function createFn(callback){this.justCreated=!0,this.isSaving(!0);var title=this.inputName.value.trim();this.doc().rename(title,function(success){try{g.PAssert(4130,success,"Rename during create must be successful")}catch(PERR){g.reportError(PERR)}}),goog.createAndSetupDocument(this.doc(),!1,function(response){response&&!response.error?(this.isCreating(!this.doc().hasDriveBacking()),this.isSaving(!1),callback&&callback()):this.errorGlobal("Error: Unable to create new document.")}.bind(this))},save:function saveFn(){if(!this.isSaving()||this.justCreated){if(!goog.isDriveAPILoaded())return this.errorGlobal("Error communicating with Google Drive. Please reconnect and try again."),void g.blurActiveElement();if(this.checkName()){if(this.isCreating())return void this.create(this.save.bind(this));if(this.newEmail().length>0){if(!this.inviteUser())return}else this.errorInvite(!1);this.rename();for(var docWasShared=this.doc().isShared(),count=0,handleResponse=function(index,success){success?(count--,0>=count&&(g.menus.closeModal(Modals.ShareDoc,!1),this.doc().isOwned()&&this.doc().isOpen()&&g.vmMain.pluginManager.onDocumentShared(docWasShared))):(this.permissionsNew()[index].error(!0),this.errorInvite("Some people could not be invited."),this.isSaving(!1))}.bind(this),i=0;i<this.permissionsNew().length;i++){var newPermission=this.permissionsNew()[i];newPermission.error()||(count++,this.doc().insertPermission(newPermission.emailAddress,handleResponse.bind(this,i)))}for(var i=0;i<this.permissionsRemove.length;i++){var permission=this.permissionsRemove[i];this.doc().deletePermission(permission.id,function(success){})}this.errorInvite()||this.errorName()||(0===count?g.menus.closeModal(Modals.ShareDoc,!0):(this.isSaving(!0),this.onClose(!0)))}}},onClose:function onCloseFn(isSave){this.closeCallback&&(this.closeCallback(isSave),this.closeCallback=void 0),g.blurActiveElement()},onTapInviteMessage:{onStart:g.handlerPreventStop,onClick:function onClickFn(e){var el=g.element("inputShareInvite");platform.mobile?g.menus.focusModalInputMobile(e,el):el.focus()}},onTapSave:{onStart:g.handlerPreventStop,onClick:function onClickFn(){this.isSaving()||(this.editing()||this.newEmail().length>0?(g.blurActiveElement(),this.inviteUser(),this.editing("")):(this.save(),g.sendEvent("Menu","SharingSave")))}},onTapCancel:{onStart:g.handlerPreventStop,onClick:function onClickFn(){this.editing()?(g.blurActiveElement(),this.editing("")):(g.blurActiveElement(),g.menus.closeModal(Modals.ShareDoc,!1),g.sendEvent("Menu","SharingCancel"))}},onTapDelete:{onClick:function onClickFn(){g.sendEvent("Menu","SharingDelete");var result;result=platform.appPlatform===AppPlatform.Chrome?!0:confirm("Are you sure you want to delete the file?"),result&&(g.vmMain.docManager.deleteDoc(this.doc().id,function(success){log("Document Delete Response: ",success),success||g.toasts.pushMessage({text:"Unable to delete document on the remote server."})}),g.menus.closeModal(Modals.ShareDoc,!1))}},onRemove:function onRemoveFn(user){this.permissionsRemove.push(user),this.permissions.remove(user),g.sendEvent("Menu","SharingRemoveUser")},onRemoveNew:function onRemoveNewFn(user){this.permissionsNew.remove(user)},_getEmailAddrFromStr:function _getEmailAddrFromStrFn(str){var addr;if(str){var fromRegexp=/(?:\"?([^\"]*)\"?\s)?<(.*)>/g,matchData=fromRegexp.exec(str);addr=matchData?matchData[2]:str}return addr},onContactSelected:function onContactSelectedFn(emailAddr){emailAddr?(g.scrollIntoView(g.element("inputShareInvite"),0),this.newEmail(emailAddr)):this.newEmail("")},onkeydown:function onkeydownFn(data,e){return platform.normalizeKeys(e),this._contactsAutocomplete.onkeydown(data,e),e.normCode===KeyCode.Enter&&this.inviteUser(),!0}};return util.inherit(ModalBase,VMDocSharing),util.extend(VMDocSharing.prototype,VMDocSharingFns),VMDocSharing}),define("VMPicker",["require","exports","module","globals","data","util","platform","goog","tracker","Observable","VMDocument","VMDocSharing","Dispatcher"],function(require,exports,module){function VMPicker(){this.fileMap={},this.isLoading=new Observable(!1),this.showError=new Observable(!1),this.listHeight=void 0,this.scrollDebounced=!1,this._openFile=void 0,this.loadCallbacks=[],this.init()}var g=require("globals"),d=require("data"),util=require("util"),platform=require("platform"),goog=require("goog"),tracker=require("tracker"),Observable=require("Observable"),VMDocument=require("VMDocument"),VMDocSharing=require("VMDocSharing"),Dispatcher=require("Dispatcher");return VMPicker.prototype={init:function initFn(){new VMDocSharing,platform.mobile&&setTimeout(function(){g.vmMain.docManager.getDocList().listen(function(){Dispatcher.fireEvent("documentsLoaded",[])}.bind(this))}.bind(this),0)},hasFiles:function hasFilesFn(){var docList=g.vmMain.docManager.getDocList();return docList.get().length>0},showLoading:function showLoadingFn(){return!this.hasFiles()&&!this.showError.get()},refreshFiles:function refreshFilesFn(){this.loadFileList()},runLoad:function runLoadFn(){g.vmMain.docManager.loadDocList(function(success){success||this.showError.set("Refresh Documents List"),this.isLoading.set(!1)}.bind(this))},loadFileList:function loadFileListFn(){this.isLoading.get()||(this.isLoading.set(!0),this.showError.set(!1),g.loadGoogleAPI("drive","v2",this.runLoad.bind(this)))},requestOpenDocument:function requestOpenDocumentFn(id){var doc=g.vmMain.docManager.getDoc(id);doc?this.openDocument(doc):this.openDocumentFromId(id)},openDocumentFromId:function openDocumentFromIdFn(id,title){try{g.PAssert(4131,id,"Document should always have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4132,title,"Document should always have a valid title")}catch(PERR){g.reportError(PERR)}var currentDoc=goog.getDocId();currentDoc!==id&&d.clearData(function(){goog.setDocInfo(id,title),util.hasURLParam("file")?util.removeURLParam("file",!0):util.hasURLParam("state")&&util.removeURLParam("state",!0),setTimeout(function(){g.reload()},500)},d.defaultSkipSettings,!0)},openDocument:function openDocumentFn(doc){g.localDocChangeRequested=!0,this.openDocumentFromId(doc.id,doc.getTitle())},onTapReloadDocuments:function onTapReloadDocumentsFn(e){this.loadFileList()},openSharing:function openSharingFn(doc,callback){g.menus.openModal(Modals.ShareDoc,doc,callback)},onTapDocument:{onClick:function onClickFn(e){var doc=g.dataFor(e.srcElement,!0);g.hasClass(e.srcElement,"documentTitle")?this.onClickDocumentTitle(doc):doc instanceof VMDocument?(this.onClickDocumentSettings(doc),e.stopImmediatePropagation()):"documentsList"!==e.srcElement.id&&g.reportError(new Error("Incorrect document type: "+g.elementToString(e.srcElement))),e.preventDefault(),e.stopImmediatePropagation()}},onTapAddDocument:function onTapAddDocumentFn(){if(g.vmMain&&g.vmMain.isOnline()){var doc=g.vmMain.docManager.createNewDoc();g.sendEvent("Menu","AddDocument"),this.openSharing(doc,function(saved){saved&&g.vmMain.docManager.setDoc(doc)}),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddDocument})}else g.toasts.pushMessage({text:"You must be online to create a new document."})},onTapRefresh:{onStart:g.handlerStopProp,onClick:function onClickFn(){g.vmMain&&g.vmMain.isOnline()&&!this.isLoading.get()&&this.refreshFiles()}}},VMPicker}),define("VMSettings",["ko","data","globals","util","goog","platform","tracker","VMPicker","ModalBase"],function(ko,d,g,util,goog,platform,tracker,VMPicker,ModalBase){function VMSettings(){this._super.constructor.call(this,platform.mobile?Modals.MobileSettings:Modals.Settings),this.enabledSyncContacts=ko.observable(!1),this.enabledSounds=ko.observable(!1),this.enabledNotifications=ko.observable(!1),this.enabledMobileUI=ko.observable(!1),this.enabledPluginDrive=ko.observable(!1),this.enabledPluginGmail=ko.observable(!1),this.syncContactsEnabledOnOpen=ko.observable(!1),this.isRefreshingContacts=ko.observable(!1),this.refreshContactsSuccess=ko.observable(void 0),this.billingManager=g.billingManager,this.init()}var VMSettingsFns={init:function initFn(){if(platform.mobile&&this.registerModal(this.open.bind(this),this.close.bind(this)),this.loadSettings(),platform.mobile){var saveFn=this.save.bind(this);this.enabledSyncContacts.subscribe(saveFn),this.enabledSounds.subscribe(saveFn),this.enabledNotifications.subscribe(saveFn),this.enabledMobileUI.subscribe(saveFn)}g.settings.registerForChangeNotification(Settings.syncContacts,void 0,this.onSyncContactsChange.bind(this))},isLocal:function isLocalFn(){return"localhost"===window.location.hostname||!1},showMobileAppReview:function showMobileAppReviewFn(){return!!platform.appReviewLink},showMobileUIOptionOnDesktop:function showMobileUIOptionOnDesktopFn(){return!1},showMobileUIOptionOnMobile:function showMobileUIOptionOnMobileFn(){return!1},onEnableNotificationsChange:function onEnableNotificationsChangeFn(){this.enabledNotifications()?g.timeline.updateNotifications():g.timeline.clearNotifications()},onSyncContactsChange:function onSyncContactsChangeFn(oldValue,newValue){this.ignoreContactsSyncChange||this.enabledSyncContacts(newValue)},open:function openFn(){this.isClosing||(this.refreshContactsSuccess(void 0),this.loadSettings(),this.syncContactsEnabledOnOpen(this.enabledSyncContacts()))},close:function closeFn(save){if(save)this.save();else{var checkSyncContacts=!!g.settings.get(Settings.syncContacts),checkPluginDrive=g.vmMain.pluginManager.isAuthorized(PluginID.Drive),checkPluginGmail=g.vmMain.pluginManager.isAuthorized(PluginID.Gmail);this.enabledSyncContacts(checkSyncContacts),this.enabledSounds(!g.settings.get(Settings.noSounds)),this.enabledPluginDrive(checkPluginDrive),this.enabledPluginGmail(checkPluginGmail)}},onScreenStartOpen:function onScreenStartOpenFn(){this.loadSettings()},enableSyncContacts:function enableSyncContactsFn(handler){function handleContactsLoaded(numContacts){0>numContacts?(g.toasts.pushMessage({text:"There was an error syncing your contacts. Please try again.",actionText:"SYNC",action:function actionFn(){this.enableSyncContacts(handler)}.bind(this)}),handler&&handler(!1)):numContacts>0&&(g.vmMain.parseSubtree(g.vmMain.root(),ChangeType.Auto),handler&&handler(!0))}g.sendEvent("Settings","EnableContacts"),goog.runAuthenticate([GScope.Contacts],!1,!1,function(token){token&&!token.error?(goog.loadContacts(handleContactsLoaded.bind(this)),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SyncContacts}),this.enabledSyncContacts(!0),g.settings.set(Settings.syncContacts,!0)):(this.enabledSyncContacts(!1),g.settings.set(Settings.syncContacts,!1),g.toasts.pushMessage({text:"To sync your contacts we need permission to access them. Please try again.",actionText:"SYNC",action:function actionFn(){this.enabledSyncContacts(handler)}.bind(this)}),handler&&handler(!1))}.bind(this))},loadSettings:function loadSettingsFn(){this.enabledSyncContacts(!!g.settings.get(Settings.syncContacts)),this.enabledSounds(!g.settings.get(Settings.noSounds)),this.enabledNotifications(!g.settings.get(Settings.disableNotifications)),this.enabledPluginDrive(g.vmMain.pluginManager.isAuthorized(PluginID.Drive)),this.enabledPluginGmail(g.vmMain.pluginManager.isAuthorized(PluginID.Gmail))},save:function saveFn(){var changedContacts=this.enabledSyncContacts()!==!!g.settings.get(Settings.syncContacts),changedSounds=this.enabledSounds()!==!g.settings.get(Settings.noSounds),changedNotifications=this.enabledNotifications()!==!g.settings.get(Settings.disableNotifications);changedContacts&&(this.ignoreContactsSyncChange=!0,g.settings.set(Settings.syncContacts,this.enabledSyncContacts()),this.ignoreContactsSyncChange=!1,this.enabledSyncContacts()?this.enableSyncContacts():(g.sendEvent("Settings","DisableContacts"),goog.loadedContacts=!1,d.clearContacts())),changedSounds&&g.settings.set(Settings.noSounds,!this.enabledSounds()),changedNotifications&&(g.settings.set(Settings.disableNotifications,!this.enabledNotifications()),this.enabledNotifications()?g.timeline.updateNotifications():g.timeline.clearNotifications())},isDemo:function isDemoFn(){return g.isDemoMode()},onTapSave:function onTapSaveFn(){g.menus.closeModal(platform.mobile?Modals.MobileSettings:Modals.Settings,!0)},onTapCancel:function onTapCancelFn(){g.menus.closeModal(platform.mobile?Modals.MobileSettings:Modals.Settings,!0)},onTapLogout:function onTapLogoutFn(e){g.vmSetup.logoutClicked(),g.sendEvent("Menu","Logout"),e.preventDefault()},onTapRunPicker:function onTapRunPickerFn(){},onTapFeedback:function onTapFeedbackFn(e){g.menus.openModal(Modals.ReportBug),g.sendEvent("Menu","GiveFeedback"),e.preventDefault()},onTapLeaveDemo:function onTapLeaveDemoFn(){util.removeURLParam("demo")},onTapRestartClient:function onTapRestartClientFn(e){g.reload(),e.preventDefault()},onTapResetClient:function onTapResetClientFn(){d.clearData(function(){g.reload()}),g.sendEvent("Menu","ResetClient")},onForceReloadDoc:function onForceReloadDocFn(){d.clearDataAndReload(),g.sendEvent("Menu","ReloadDoc")},onTapSettings:function onTapSettingsFn(){g.menus.openSettings(),g.vmMain.cancelFullscreenClick(),g.sendEvent("Menu","Settings")},onlineStatusToggle:function onlineStatusToggleFn(){platform.offline?util.removeURLParam("offline"):util.insertURLParam("offline","true")},logoutButtonText:function logoutButtonTextFn(){return g.vmSetup.logoutButtonText()},isLoggedIn:function isLoggedInFn(){return g.vmSetup.loginState()==LoginState.LOGGED_IN},isOnline:function isOnlineFn(){return g.vmMain.isOnline()},showAppDebugInfo:function showAppDebugInfoFn(){return platform.debugApp},getHostName:function getHostNameFn(){return"Host: "+window.location.host},getLowMemText:function getLowMemTextFn(){return"LowMem: "+(g.hasSentLowMemoryWarning()?"TRUE":"FALSE")},getDebugUserText:function getDebugUserTextFn(){return"Premium: "+g.billingManager.getPremiumStatus()},getDebugPremiumText:function getDebugPremiumTextFn(){return"User: "+g.billingManager.getBillingIdentifier()},onTapRefreshContacts:function onTapRefreshContactsFn(){this.isRefreshingContacts()||(this.isRefreshingContacts(!0),this.refreshContactsSuccess(void 0),d.clearLocalContacts(),goog.loadedContacts=!1,goog.authAndLoadContacts(!0,function(success){this.refreshContactsSuccess(success),setTimeout(function(){this.isRefreshingContacts(!1)}.bind(this),1e3)}.bind(this)),g.sendEvent("Menu","RefreshContacts"))},contactsRefreshSuccessTest:function contactsRefreshSuccessTestFn(){return void 0===this.refreshContactsSuccess()?"":this.refreshContactsSuccess()===!0?"Success!":this.refreshContactsSuccess()===!1?"Failure!":void 0},onTapSendToAppReview:function onTapSendToAppReviewFn(){platform.appReviewLink&&g.openUrl(platform.appReviewLink)}};return util.inherit(ModalBase,VMSettings),util.extend(VMSettings.prototype,VMSettingsFns),VMSettings}),define("KeyboardToolbar",["globals","data","edit","platform","tracker","Sel","Dispatcher","Observable","Constants"],function(g,d,edit,platform,tracker,Sel,Dispatcher,Observable,C){function KeyboardToolbar(){this.isVisible=new Observable(!1),this.mode=new Observable,this.aboutToShow=void 0,this.bottomPosition=new Observable(0),this.topBarHidden=!1,this.init()}return KeyboardToolbar.prototype={init:function initFn(){Dispatcher.listen("closeKeyboard",this.hide.bind(this)),Dispatcher.listen("itemsUpdated",function(pane){document.activeElement&&document.activeElement!==document.body||g.isKeyboardOpen&&g.closeKeyboard()}.bind(this))},preShow:function preShowFn(){this.aboutToShow=!0,setTimeout(function(){this.aboutToShow=!1}.bind(this),100)},show:function showFn(type){this.aboutToShow=!1,this.updatePosition(),this.mode.set(type),g.isKeyboardOpen=!0,(!platform.ie||platform.ie&&(platform.mobro||platform.winphone))&&this.isVisible.set(!0),setTimeout(function(){tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenKeyboard}),g.fireCustomEvent("keyboardOpened")},0)},hide:function hideFn(){!this.aboutToShow&&g.isKeyboardOpen&&(g.isKeyboardOpen=!1,g.focusedPane.removePadding(),g.onCloseKeyboard(),this.hideTopBarIfLandscape(),this.isVisible.set(!1),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseKeyboard}))},hideTopBarIfLandscape:function hideTopBarIfLandscapeFn(){platform.orientation!==Orientation.Landscape||!g.isKeyboardOpen&&!this.aboutToShow||g.getActiveSearch().UI.isFocused?this.topBarHidden&&(this.topBarHidden=!1,g.setTransform(g.element("container"),0,0)):(g.setTransform(g.element("container"),0,-g.topBarHeight),this.topBarHidden=!0)},updatePosition:function updatePositionFn(){var bottom=platform.kbsize;bottom!==this.bottomPosition&&this.bottomPosition.set(bottom),g.isKeyboardOpen&&g.focusedPane.addPadding()}},new KeyboardToolbar}),define("IntroSection",["require","exports","module","globals","platform","Observable"],function(require,exports,module){function IntroSection(id,text,note){this.isComplete=new Observable(!1),this.id=id,this.text=text,this.note=note,this.items=[],this.inOrder=!1,this.enforceOrder=!1,this.owner=void 0,this.numComplete=0,this.next=0}var g=require("globals"),platform=require("platform"),Observable=require("Observable");return IntroSection.prototype={defaultShow:function defaultShowFn(){this.isDisabled.set(!1)},loadFromSaveData:function loadFromSaveDataFn(data){this.numComplete=0;for(var numItems=0,j=0;j<this.items.length;++j){var item=this.items[j];data[item.id]&&(item.isComplete.set(!0),this.numComplete++,this.inOrder&&(this.next=Math.max(this.next,j+1))),item.hiddenObservable&&item.hiddenObservable.get()||item.visibleObservable&&!item.visibleObservable.get()||numItems++}if((this.numComplete===numItems||data[this.id])&&this.isComplete.set(!0),this.inOrder&&0!==this.next&&this.next<numItems){var nextItem=this.items[this.next];nextItem&&(nextItem.show(),!g.isKeyboardOpen&&this.owner.needsKeyboardOpen&&g.tooltip.hideTip())}},saveData:function saveDataFn(data,saveSelf){for(var i=0;i<this.items.length;++i){var item=this.items[i];try{g.PAssert(4133,item,"Item entries must exist")}catch(PERR){g.reportError(PERR)}item.isComplete.get()&&(data[item.id]=1)}saveSelf&&this.isComplete.get()&&(data[this.id]=1)},addStep:function addStepFn(item){try{g.PAssert(4134,!!item.id==!!item.check&&(item.text||item.jsx),"Invalid help step")}catch(PERR){g.reportError(PERR)}return item.isComplete||(item.isComplete=new Observable(!1)),this.inOrder&&!platform.mobile?item.isDisabled||(item.isDisabled=new Observable(this.items.length>0)):item.isDisabled=new Observable(!1),item.isHotkeyOr=item.isHotkeyOr,item.show||(item.show=this.defaultShow.bind(item)),this.items.push(item),item},complete:function completeFn(item){item.isComplete.get()||(item.isComplete.set(!0),this.owner.notifyOfChange(item))},forceComplete:function forceCompleteFn(){this.isComplete.set(!0),this.owner.notifyOfChange()},check:function checkFn(e){try{g.PAssert(4135,!this.isComplete.get(),"Should never be checking items in a completed section")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this.items.length;i++){var item=this.items[i];if(!item.isComplete.get()&&((e===!0||item.check&&item.check(e))&&(this.complete(item),this.inOrder&&i===this.next&&(this.next++,this.next<this.items.length&&this.items[this.next].show())),this.enforceOrder))break}}},IntroSection}),define("MooReact",["require","exports","module","globals","react","react-dom","Hotkeys","Observable","ObservableArray","Dispatcher","Trigger"],function(require,exports,module){var g=require("globals"),React=require("react"),ReactDOM=require("react-dom"),Hotkeys=require("Hotkeys"),Observable=require("Observable"),ObservableArray=require("ObservableArray"),Dispatcher=require("Dispatcher"),Trigger=require("Trigger"),MooReact={};MooReact.createClass=function(params){try{g.PAssert(4136,!params.mixins,"Should not supply separate mixins value")}catch(PERR){g.reportError(PERR)}return params.mixins||(params.mixins=[MooReact.MooReactMixin,React.addons.PureRenderMixin]),React.createClass(params)};var _nextID=0;return MooReact.MooReactMixin={getInitialState:function getInitialStateFn(){this.init&&this.init();var stateObject=this.getState?this.getState(this.props):{};this._observables&&(stateObject=g.extend(stateObject,this._observables));var txState=null;return stateObject&&(this.setupListeners(stateObject),txState=this.transformState(stateObject)),txState},createObservables:function createObservablesFn(obj){try{g.PAssert(4137,!this._listeners,"You have to run createObservables in init()")}catch(PERR){g.reportError(PERR)}for(var key in obj)if(obj.hasOwnProperty(key)){var val=obj[key];obj[key]=g.isArray(val)?new ObservableArray(val):new Observable(val);try{g.PAssert(4138,!this.hasOwnProperty(key),"Must not multi-define observable properties")}catch(PERR){g.reportError(PERR)}this[key]=obj[key]}try{g.PAssert(4139,!this.hasOwnProperty("_observables"),"Must not define an _observables property and use createObservables")}catch(PERR){g.reportError(PERR)}this._observables=obj},_addListener:function _addListenerFn(listener){try{g.PAssert(4140,listener&&listener.target,"Must add a valid listener")}catch(PERR){g.reportError(PERR)}this._ensureListeners();try{g.PAssert(4141,!this._hasListener(listener.target),"Must not double register the same observable/trigger")}catch(PERR){g.reportError(PERR)}this._listeners.push(listener)},refreshListeners:function refreshListenersFn(){this.disposeListeners();var stateObject=this.getState?this.getState(this.props):{};this._observables&&(stateObject=g.extend(stateObject,this._observables)),stateObject&&this.setupListeners(stateObject)},_ensureListeners:function _ensureListenersFn(){this._listeners||(this._listeners=[],this._permanentListeners=[])},setupListeners:function setupListenersFn(stateObject){this._ensureListeners(),stateObject||(stateObject=this.getState?this.getState(this.props):{});for(var prop in stateObject)if(stateObject.hasOwnProperty(prop)){var value=stateObject[prop];value instanceof Observable&&this._addListener(value.listen(this.onListener))}},disposeListeners:function disposeListenersFn(permanent){if(this._listeners){for(var i=0;i<this._listeners.length;++i)this._listeners[i].dispose();if(this._listeners=[],permanent)for(var i=0;i<this._permanentListeners.length;++i)this._permanentListeners[i].dispose()}if(this._dispatcherListeners)for(var i=0;i<this._dispatcherListeners.length;i++){var listener=this._dispatcherListeners[i],dispatcher=listener[0];listener.splice(0,1),dispatcher.unlisten.apply(dispatcher,listener)}},listenTo:function listenToFn(obj,canDispose){try{g.PAssert(4142,obj instanceof Trigger||obj instanceof Observable,"Can only listen to an Observable or a Trigger object")}catch(PERR){g.reportError(PERR)}if(obj instanceof Trigger||obj instanceof Observable){var v=obj.listen(this.onListener);canDispose!==!1?this._addListener(v):this._permanentListeners.push(v)}},listenToDispatcher:function listenToDispatcherFn(){this._dispatcherListeners||(this._dispatcherListeners=[]);var args=Array.prototype.slice.call(arguments);g.isString(args[0])?dispatcher=Dispatcher:(dispatcher=args[0],args.splice(0,1)),args.push(this.onListener),dispatcher.listen.apply(dispatcher,args),args.splice(0,0,dispatcher),this._dispatcherListeners.push(args)},_hasListener:function _hasListenerFn(target){try{g.PAssert(4143,target,"Must have a valid target")}catch(PERR){g.reportError(PERR)}for(var hasListener=!1,i=0;i<this._listeners.length;++i)if(this._listeners[i].target===target){hasListener=!0;break}return hasListener},_getState:function _getStateFn(props){var stateObject=this.getState?this.getState(props||this.props):{};return this._observables&&(stateObject=g.extend(stateObject,this._observables)),this.transformState(stateObject)},transformState:function transformStateFn(stateObject){for(var prop in stateObject)if(stateObject.hasOwnProperty(prop)){var value=stateObject[prop];value&&value instanceof Observable&&(stateObject[prop]=value.get(),value instanceof ObservableArray&&(stateObject[prop+"_arrVer"]=value.version))}return stateObject},onListener:function onListenerFn(){this.updateState()},updateState:function updateStateFn(props){try{g.PAssert(4145,this._isMounted,"updateState called on a component that is not yet mounted:",this.constructor&&this.constructor.displayName)}catch(PERR){g.reportError(PERR)}if(this._isMounted){var oldState=this.state,newState=this._getState(props);this.onBeforeChanged&&(newState=this.onBeforeChanged(newState,oldState,props)||newState),this.setState(newState),this.onAfterChanged&&this.onAfterChanged(newState,oldState)}},setData:function setDataFn(element,obj){try{g.PAssert(4146,this.__id,"A unique ID must have been generated for this object")}catch(PERR){g.reportError(PERR)}g.setDataFor(element,obj,this.__id),this.__elementData=element},clearData:function clearDataFn(){this.__elementData&&(this.__elementData=void 0,g.clearDataFor(this.__id))},componentWillUnmount:function componentWillUnmountFn(){this.disposeListeners(!0),this.clearData(),this.__hotkeys&&(Hotkeys.popStack(this.__hotkeys),this.__hotkeys=void 0),this.onUnmount&&this.onUnmount(this.state),this._isMounted=!1},addTap:function addTapFn(refName,obj,handler){var ref=this.refs[refName];try{g.PAssert(4147,ref,"Invalid refName to add tap to: ",refName)}catch(PERR){g.reportError(PERR)}ref&&g.setupClick(ref,obj,handler)},refElement:function refElementFn(refName){var ref=this.refs[refName];return g.isDOMNode(ref)?ref:ReactDOM.findDOMNode(ref)},getChildByKey:function getChildByKeyFn(key){var found;return React.Children.forEach(this.props.children,function(child){child&&child.key===key&&(found=child)}),found},getChildByDisplayName:function getChildByDisplayNameFn(name){var found;return React.Children.forEach(this.props.children,function(child){child&&child.type&&child.type.displayName===name&&(found=child)}),found},componentDidMount:function componentDidMountFn(e){this._isMounted=!0,this.getHotkeys?this.__hotkeys=Hotkeys.pushStack(this.getHotkeys()):this.onEscapeKey&&(this.__hotkeys=Hotkeys.pushStackEscape(this.onEscapeKey))},getUniqueID:function getUniqueIDFn(){return this.props["data-moo-id"]?this.props["data-moo-id"]:(this.__id||(this.__id="m_"+_nextID++),this.__id)}},MooReact});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("Components/FancyRippler",["require","exports","module","globals","platform","react","MooReact"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),rippleTime=1e3,FancyRippler=MooReact.createClass({displayName:"FancyRippler",propTypes:{rippleColor:React.PropTypes.string},init:function init(){this.createObservables({ripples:[]}),this.rippleNum=0},componentDidMount:function componentDidMount(){platform.mobile&&this.props.onClick&&g.setupClick(this.refs.element,this,this.onTap)},onMouseDown:function onMouseDown(e){var props=this.props;if(this.props.onMouseDown&&this.props.onMouseDown(e),this.props.children&&!e.defaultPrevented&&props.ripple!==!1){var left,top;if(this.props.center)left="50%",top="50%";else{var el=this.refs.element,elHeight=el.offsetHeight,elWidth=el.offsetWidth,offset=g.offset(el);left=e.clientX-offset.left,top=e.clientY-offset.top}var ripple={id:this.rippleNum++,left:left,top:top};this.ripples.push(ripple),setTimeout(this.removeRipple,rippleTime)}e.stopPropagation()},onTap:{onStart:function onStart(e){this.onMouseDown(e),e.stopPropagation()},onClick:function onClick(e){this.props.onClick(e),e.preventDefault(),e.stopPropagation()}},removeRipple:function removeRipple(){this.ripples.removeAt(0)},render:function render(){for(var state=this.state,props=this.props,ripples=[],i=0;i<state.ripples.length;i++){var ripple=state.ripples[i],rippleStyle={left:ripple.left,top:ripple.top};ripples.push(React.createElement("div",{key:"ripple_"+ripple.id,className:"fancyRipple",style:rippleStyle}))}var cls=g.classNames(this.props.className,"fancyRippler",{rippleCenter:this.props.center}),center=props.center,onClick=props.onClick,rest=_objectWithoutProperties(props,["center","onClick"]);return React.createElement("div",_extends({},rest,{className:cls,onMouseDown:!platform.mobile&&this.onMouseDown,onClick:!platform.mobile&&onClick,ref:"element"}),this.props.children,ripples.length>0&&React.createElement("div",{className:"fancyRipples"},ripples))}});return FancyRippler}),define("Components/FancyButton",["require","globals","platform","react","MooReact","Components/FancyRippler"],function(require){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),FancyRippler=require("Components/FancyRippler"),FancyButton=MooReact.createClass({displayName:"FancyButton",propTypes:{onClick:React.PropTypes.func,onMouseDown:React.PropTypes.func,id:React.PropTypes.string,enabled:React.PropTypes.bool,className:React.PropTypes.string,raised:React.PropTypes.bool,primary:React.PropTypes.bool,cancel:React.PropTypes.bool,icon:React.PropTypes.string,selected:React.PropTypes.bool,width:React.PropTypes.oneOfType([React.PropTypes.string,React.PropTypes.number]),height:React.PropTypes.oneOfType([React.PropTypes.string,React.PropTypes.number])},init:function init(){this.createObservables({isHovered:!1,isLoading:!1})},onMouseEnter:function onMouseEnter(){this.isHovered.set(!0)},onMouseLeave:function onMouseLeave(){this.isHovered.set(!1)},onClick:function onClick(e){if(!this.isLoading.get()){var fn=this.props.onClick||this.props.onMouseDown,isLoading=fn(e,this.onButtonClickCallback);isLoading&&this.isLoading.set(!0)}},onMouseDown:function onMouseDown(e){var ev={target:e.target};this._holdTimeout=setTimeout(this.onHold,150,ev)},onMouseUp:function onMouseUp(){this._clearHoldTimeout()},onHold:function onHold(e){this._clearHoldTimeout(),this.props.onHold(e)},_clearHoldTimeout:function _clearHoldTimeout(){this._holdTimeout&&(clearTimeout(this._holdTimeout),this._holdTimeout=0)},onButtonClickCallback:function onButtonClickCallback(){this.isLoading.set(!1)},removeRipple:function removeRipple(){this.ripples.removeAt(0)
},render:function render(){var state=this.state,props=this.props,textColor,bgColor,hoverColor,selectedColor,isIconButton=props.icon&&!props.children;props.primary?(props.raised?(bgColor=g.colorBlue,textColor="#fff"):textColor=g.colorBlue,hoverColor=g.colorLightBlue):props.cancel?(props.raised?(bgColor=g.colorRed,textColor="#fff"):textColor=g.colorRed,hoverColor=g.colorLightRed):(props.raised?(bgColor="#eaeaea",hoverColor="#f3f3f3"):(hoverColor=isIconButton?"#444":"#222",selectedColor="rgba(0,0,0,0.08)"),textColor=props.color||(isIconButton?"#aaa":"#666"));var outerStyle={display:props.display,color:textColor,lineHeight:props.height?"auto"===props.height?null:props.height+"px":"36px",height:props.height,width:props.width,textAlign:"center",margin:props.margin,paddingLeft:props.paddingLeft,paddingTop:props.paddingTop,paddingRight:props.paddingRight,paddingBottom:props.paddingBottom,fontSize:props.fontSize};void 0===props.margin&&(outerStyle.marginLeft=props.marginLeft,outerStyle.marginTop=props.marginTop,outerStyle.marginRight=props.marginRight,outerStyle.marginBottom=props.marginBottom),outerStyle=g.extend(outerStyle,this.props.style),props.raised?(outerStyle.backgroundColor=bgColor,state.isHovered&&(outerStyle.backgroundColor=hoverColor),!props.children&&props.icon&&(outerStyle.borderRadius="50%")):(state.isHovered&&(outerStyle.color=hoverColor),props.selected&&(outerStyle.backgroundColor=selectedColor)),state.isLoading&&(outerStyle.color="rgba(0,0,0,0.05)");var textStyle={fontSize:props.fontSize},icon;if(props.icon){var iconStyle={height:props.height,fontSize:props.iconSize};props.children?(textStyle.paddingLeft="6px",textStyle.paddingRight=0,outerStyle.paddingLeft="16px",outerStyle.paddingRight="16px"):(outerStyle.width=props.width||36,outerStyle.height=props.height||36,outerStyle.textAlign="center"),icon=React.createElement("i",{className:g.classNames("fancyButtonIcon",props.icon),style:iconStyle})}isNaN(props.padding)||(textStyle.padding="0 "+props.padding+"px");var content=props.children&&React.createElement("div",{className:"fancyButtonText",style:textStyle},props.children),className=g.classNames("fancyButton",{raised:props.raised},{loading:state.isLoading},{primary:props.primary},{cancel:props.cancel},{hasText:!!props.children},{hasIcon:!!props.icon},{disabled:props.enabled===!1},props.className),loading=state.isLoading&&React.createElement("div",{className:"fancyButtonLoading"},React.createElement("i",{className:"icon-spinner"}));return React.createElement(FancyRippler,{className:className,style:outerStyle,onMouseEnter:!platform.mobile&&this.onMouseEnter,onMouseLeave:!platform.mobile&&this.onMouseLeave,onMouseDown:!platform.mobile&&props.onMouseDown&&this.onClick||props.onHold&&this.onMouseDown,onMouseUp:!platform.mobile&&props.onHold&&this.onMouseUp,onClick:props.onClick&&this.onClick,id:props.id,center:!!props.icon&&!props.children,ripple:props.ripple,"data-tooltip":props.tooltip},icon,content,loading)}});return FancyButton}),define("Intro",["require","globals","data","Constants","react","util","tracker","platform","Observable","ObservableArray","ObservableComputed","IntroSection","Components/FancyButton"],function(require){function onClickSettings(){g.menus.openSettings(C.SettingsSections.Plugins)}function Intro(){platform.mobile||(g.intro=this)}var g=require("globals"),d=require("data"),C=require("Constants"),React=require("react"),util=require("util"),tracker=require("tracker"),platform=require("platform"),Observable=require("Observable"),ObservableArray=require("ObservableArray"),ObservableComputed=require("ObservableComputed"),IntroSection=require("IntroSection"),FancyButton=require("Components/FancyButton"),styleSpan={display:"inline-block",height:"24px"};return Intro.prototype={init:function init(){this.mode=new Observable(C.HelpMode.None),this.position=new Observable,this.sections=new ObservableArray,this.isImportShowing=new Observable(!1),this.isIntroComplete=new Observable(!1),this.paneIntros={},this.isVisible=new ObservableComputed([this.isImportShowing,this.mode],function(){return this.isHelpShowing()||this.isImportShowing.get()}.bind(this)),this.priKey=platform.priModKey,this.secKey=platform.secModKey,this.secKeyForce=platform.secModKeyForce;var helpState=g.settings.get(Settings.helpPaneState);void 0===helpState&&(helpState=C.HelpMode.Intro),this.initItemsDesktop(),g.isDemoMode()||(this.initPaneIntros(),this.initState(helpState));var importPaneState=util.storage.getItem("closedImport")||g.settings.get(Settings.closedImport);importPaneState||g.isDemoMode()||this.isImportShowing.set(!0),g.settings.registerForChangeNotification(Settings.helpPaneState,void 0,function(oldValue,newValue){void 0!==newValue&&newValue!==oldValue&&this.initState(newValue)}.bind(this)),g.settings.registerForChangeNotification(Settings.helpState,void 0,function(oldValue,newValue){newValue&&newValue!==oldValue&&this.loadState()}.bind(this)),g.settings.registerForChangeNotification(Settings.closedImport,void 0,function(oldValue,newValue){newValue===!0&&newValue!==oldValue&&this.isImportShowing.set(!1)}.bind(this)),tracker.addListener(this.onAction.bind(this))},isHelpShowing:function isHelpShowing(){return this.mode.get()!==C.HelpMode.None},initState:function initState(mode){try{g.PAssert(4148,void 0!==mode,"Must pass in a valid intro mode")}catch(PERR){g.reportError(PERR)}this.sections.clear(),this.mode.set(mode),this.isIntroMode()?this.initIntro():this.isHotkeyMode()?this.initHotkeys():this.initHelp(),this.loadStateLegacy(),this.loadState()},initItemsDesktop:function initItemsDesktop(){function onClickAddPanes(){var el=g.element("addPaneButton");g.menus.openContextMenuReact({componentName:"ReactContextMenuAddPane",element:el})}this.itemAddItem={id:"1590753965",text:'Press <span class="hHotkey">Enter</span> to add a new item',check:this.checkAddItem},this.itemIndent={id:"458052715",text:'Press <span class="hHotkey">Tab</span> to indent an item into a list and <span class="hHotkey">Shift + Tab</span> to unindent out of a list',check:this.checkIndent},this.itemDateTime={id:"321249113",text:"Add a date/time by typing @ in the text of an item",check:this.checkDate},this.itemRightClick={id:"3288459206",text:"Right click an item to explore more options",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick}},this.itemAddPanes={id:"2982070598",jsx:React.createElement("span",null,"Click ",React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{icon:"icon-add",iconSize:18,onClick:onClickAddPanes}))," in the top right to add more panes"),check:function check(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane?!0:void 0}};var pluginEmail=g.vmMain.getDefaultEmailPlugin(),pluginCal=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar),pluginDrive=g.vmMain.pluginManager.getPlugin(PluginID.Drive);this.itemPluginSettings={id:"ep",jsx:React.createElement("span",null,React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{raised:!0,primary:!0,marginRight:8,onClick:onClickSettings},"Enable plugins")),"to connect to your other services"),hiddenObservable:new ObservableComputed([pluginEmail.isActiveObs,pluginCal.isActiveObs,pluginDrive.isActiveObs]),check:function check(){}},this.itemOpenEmail={id:"dblE",text:"Double click an email to open it",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenEmail&&e.data.pane.type===PaneMode.Gmail}},this.itemDragEmail={id:"drgEm",text:"Drag an email to your Outline to organize it",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Gmail}},this.itemRightClickEmail={id:"rcE",text:"Right click an email to explore more options",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick&&e.data.pane.type===PaneMode.Gmail}},this.itemGmailLabels={id:"lbls",text:'Click <i class="overviewButtonNormal icon-list g"></i> in the top left to access your labels',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleOverview&&e.data.pane.type===PaneMode.Gmail}},this.itemGmailCompose={id:"cmp",text:'Click <i class="icon-envelope g"></i> in the top right to compose a new email',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ComposeEmail}}},setMode:function setMode(mode){this.mode.set(mode),g.settings.set(Settings.helpPaneState,mode)},isIntroMode:function isIntroMode(){return this.mode.get()===C.HelpMode.Intro},isHotkeyMode:function isHotkeyMode(){return this.mode.get()===C.HelpMode.Hotkeys},loadStateLegacy:function loadStateLegacy(){if(g.shouldWriteLocal())try{var stateString=util.storage.getItem("help");if(stateString){var state=JSON.parse(stateString);if(state){for(var i=0;i<this.sections.get().length;++i){var section=this.sections.get()[i];section.loadFromSaveData(state)}for(var key in this.paneIntros)this.paneIntros.hasOwnProperty(key)&&this.paneIntros[key].forceComplete();console.log("found old data and migrating it"),this.saveState(),util.storage.removeItem("help")}}}catch(err){g.reportError(err)}},_getHelpStateObj:function _getHelpStateObj(){var state={},stateString=g.settings.get(Settings.helpState);if(stateString)try{state=JSON.parse(stateString),(!state||g.isString(state))&&(state={})}catch(err){g.reportError(err)}return state||{}},loadState:function loadState(){var state=this._getHelpStateObj();if(state){for(var i=0;i<this.sections.get().length;++i)this.sections.get()[i].loadFromSaveData(state);for(var key in this.paneIntros)this.paneIntros.hasOwnProperty(key)&&this.paneIntros[key].loadFromSaveData(state)}},saveState:function saveState(){if(g.shouldWriteLocal())try{var state=this.getState();g.settings.set(Settings.helpState,JSON.stringify(state))}catch(err){g.reportError(err)}},getState:function getState(){for(var data=this._getHelpStateObj(),i=0;i<this.sections.get().length;++i){var section=this.sections.get()[i];section.saveData(data)}for(var key in this.paneIntros)if(this.paneIntros.hasOwnProperty(key)){var section=this.paneIntros[key];section.saveData(data,!0)}return data},clearState:function clearState(){g.shouldWriteLocal()&&(util.storage.setItem(this.ModeClassIntro,""),util.storage.setItem(this.ModeClassNormal,""))},notifyOfChange:function notifyOfChange(){this.saveState()},createSection:function createSection(id,title,desc,items){var section=new IntroSection(id,title,desc);section.owner=this;for(var i=0;i<items.length;i++)section.addStep(items[i]);return section},addSection:function addSection(id,title,desc,items){var section=this.createSection(id,title,desc,items);return this.sections.push(section),section},initHotkeys:function initHotkeys(){this.addSection(null,"Basic",null,[{text:'<span class="introHotkey">Tab</span>Indent an item'},{text:'<span class="introHotkey">'+this.secKey+" + ]</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKeyForce+" + Shift + Right</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">Shift + Tab</span>Un-indent an item'},{text:'<span class="introHotkey">'+this.secKey+" + [</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKeyForce+" + Shift + Left</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKey+" + /</span>Complete an item"},{text:'<span class="introHotkey">'+this.secKeyForce+" + Enter</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKey+" + 1 | 2 | 3</span>Set item priority"},{text:'<span class="introHotkey">'+this.secKey+" + 8</span>Star an item"},{text:'<span class="introHotkey">'+this.secKeyForce+" + Up</span>Collapse item"},{text:'<span class="introHotkey">'+this.secKeyForce+" + Down</span>Uncollapse item"},{text:'<span class="introHotkey">'+this.secKey+" + ,</span>Toggle collapsed"},{text:'<span class="introHotkey">'+this.secKey+" + .</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKeyForce+" + Space</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.priKey+" + F</span>Search for text"},{text:'<span class="introHotkey">'+this.secKeyForce+" + F</span>Search for text",isHotkeyOr:!0},{text:'<span class="introHotkey">Shift + Enter</span>Add multi-line note'}]),this.addSection(null,"Navigation",null,[{text:'<span class="introHotkey">'+this.priKey+" + Enter</span>Zoom a pane in an item"},{text:'<span class="introHotkey">'+this.priKey+" + Shift + Enter</span>Zoom out a pane"},{text:'<span class="introHotkey">'+this.priKey+" + "+(platform.mac?"Up":"Home")+"</span>Go to the top of a pane"},{text:'<span class="introHotkey">'+this.priKey+" + "+(platform.mac?"Down":"End")+"</span>Go to the bottom of a pane"},{text:'<span class="introHotkey">'+this.secKey+" + G</span>Go to selected item in all panes"}]),this.addSection(null,"Advanced",null,[{text:'<span class="introHotkey">'+this.secKey+" + Shift + /</span>Archive completed items"},{text:'<span class="introHotkey">'+(platform.mac?"Ctrl + ⌘ + Up":"Alt + Shift + Up")+"</span>Move an item up in a list"},{text:'<span class="introHotkey">'+this.secKey+" + Shift + Up</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+(platform.mac?"Ctrl + ⌘ + Down":"Alt + Shift + Down")+"</span>Move an item down in a list"},{text:'<span class="introHotkey">'+this.secKey+" + Shift + Down</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKey+" + Shift + ,</span>Collapse all top-level items"},{text:'<span class="introHotkey">'+this.secKey+" + Shift + .</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">'+this.secKey+" + Shift + Space</span>",isHotkeyOr:!0},{text:'<span class="introHotkey">Shift + F4</span>Close the current pane'},{text:'<span class="introHotkey">'+this.secKey+" + T</span>Add new pane"}]);var editor=this.addSection(null,"Text Editor",null,[{text:'<span class="introHotkey">'+this.secKey+" + Z</span>Undo your last action"},{text:'<span class="introHotkey">'+this.secKey+" + Y</span>Redo your last action"},{text:'<span class="introHotkey">'+(platform.mac?"Option":"Ctrl")+" + Backspace</span>Delete the previous word"},{text:'<span class="introHotkey">'+(platform.mac?"Option":"Ctrl")+" + Delete</span>Delete the next word"},{text:'<span class="introHotkey">'+this.secKeyForce+" + L</span>Select the current item"}]);platform.mac&&(editor.addStep({text:'<span class="introHotkey">'+this.secKeyForce+" + Shift + A</span>Select to start of line"}),editor.addStep({text:'<span class="introHotkey">'+this.secKeyForce+" + Shift + E</span>Select to end of line"})),this.addSection(null,"Gmail",null,[{text:'<span class="introHotkey">'+this.secKey+" + N</span>Compose new email"}]),this.addSection(null,"In Gmail Pane",null,[{text:'<span class="introHotkey">R</span>Reply'},{text:'<span class="introHotkey">Shift + R</span>Reply All'},{text:'<span class="introHotkey">F</span>Forward'},{text:'<span class="introHotkey">U</span>Mark as unread'},{text:'<span class="introHotkey">8</span>Star / unstar'},{text:'<span class="introHotkey">1 | 2 | 3</span>Priority'},{text:'<span class="introHotkey">D</span>Snooze'},{text:'<span class="introHotkey">L</span>Label'},{text:'<span class="introHotkey">M</span>Move to Outline'},{text:'<span class="introHotkey">C</span>Move to Calendar'},{text:'<span class="introHotkey">E</span>Archive'},{text:'<span class="introHotkey">Backspace</span>Delete'}])},initIntro:function initIntro(){var section=this.introSection=this.addSection("4069205379","Introduction to Moo.do","We'll walk you through the basics to get you started.",[this.itemAddItem,this.itemIndent,this.itemDateTime,this.itemRightClick]);g.isDemoMode()||(section.addStep(this.itemAddPanes),section.addStep(this.itemPluginSettings)),section.inOrder=!0,section.isComplete.listen(this.onIntroComplete.bind(this))},initPaneIntros:function initPaneIntros(){this.paneIntros[PaneMode.Outline]=this.createSection("pout","How to use the Outline Pane","Each Outline pane is a different view on the same data. Try these ways to filter your view:",[{id:"pnse",text:"Search for text, filter by priority, or hide completed items in the Search bar at the top",check:this.checkSearch},{id:"prcJ",text:"Right click an item to zoom into it and explore other options",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick&&e.data.pane.type!==PaneMode.Gmail}},{id:"pove",text:'Click <i class="overviewButtonNormal icon-list g"></i> in the top left to open the overview, then click an item to scroll to it or click <i class="icon-zoom-in g"></i> to zoom into it.',check:this.checkZoom}]),this.paneIntros[PaneMode.Timeline]=this.createSection("pag","How to use the Agenda Pane","Agenda panes show the items in your Outline sorted by date and priority. Try these ways to add items to your Agenda:",[{id:"prcI",text:'Add a date or time to an item by typing <span class="date">@</span> on an item in your Outline',check:this.checkDate},{id:"ppri",text:'Set a priority with the right click menu or <span class="hHotkey">'+this.secKey+" + 1|2|3</span>",check:this.checkPriority},{id:"adc",text:'Add an item with a date to Google Calendar by pressing <span class="hHotkey">'+this.secKeyForce+' + C</span> or right clicking the date.<span style="color: #777;"></span>',visibleObservable:g.billingManager.hasPremiumFeaturesObservable,check:this.checkGoogleCalendar}]),this.paneIntros[PaneMode.Gmail]=this.createSection("pgm","How to use the Gmail Pane","Each Gmail pane is a different view on your email. Try using multiple Gmail panes at once.",[this.itemOpenEmail,this.itemDragEmail,this.itemRightClickEmail,this.itemGmailLabels,this.itemGmailCompose])},checkAddItem:function checkAddItem(e){if(e.type===TrackerType.Create){var item=d.getModel(e.data[0].itemID);return!item||item.parent()===d.getRootModel()&&0===e.data[0].position?!1:!0}},checkIndent:function checkIndent(e){if(e.type===TrackerType.Move){var oldParentItem=d.getItem(e.data[0].oldParent);if(oldParentItem&&oldParentItem.items.indexOf(e.data[0].newParent)>=0)return!0}},checkSearch:function checkSearch(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged},checkComplete:function checkComplete(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isComplete"===v.field&&v.newValue}},checkOverview:function checkOverview(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleOverview},checkZoom:function checkZoom(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut&&g.focusedPane.overview.isVisible.get()},checkPriority:function checkPriority(e){var v=e.data[0];return e.type===TrackerType.Update&&"priority"===v.field&&v.newValue>0},checkDate:function checkDate(e){return e.type===TrackerType.Insert&&"@"===e.data[0].text},checkGoogleCalendar:function checkGoogleCalendar(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddToGCal},checkGoogleDrive:function checkGoogleDrive(){},initHelp:function initHelp(){function onClickDocuments(){var el=g.element("desktopMenuButton");g.menus.openContextMenuReact({componentName:"ReactContextMenuDocuments",element:el})}function onClickOptions(){var el=g.element("optionsButton");g.menus.openContextMenuReact({componentName:"ReactContextMenuOptions",element:el})}this.sections.clear(),this.addSection("2102025841","Organization","Moo.do works like a text editor so you can organize like you're writing a document.",[this.itemAddItem,this.itemIndent,{id:"3825397189",text:"Click and drag on the left edge of an item to move it",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&g.vmMain.isLoaded?!0:void 0}},{id:"3754573224",text:'Press <span class="hHotkey">'+this.priKey+' + Z</span> to undo and <span class="hHotkey">'+this.priKey+" + Y</span> to redo",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.UndoRedo?!0:void 0}},{id:"441256378",text:'Click the left edge of a list or press <span class="hHotkey">'+this.secKey+" + ,</span> to collapse its subitems",check:function check(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isCollapsed"===v.field&&v.newValue}}}]),this.addSection("3980400482","Dates","Scheduling items automatically puts them on your Agenda.",[this.itemDateTime,{id:"2538562480",text:'Write dates in plain English like <span class="date">@tomorrow</span>',check:function check(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data.date;return!!date}}},{id:"745092254",text:'Schedule a full date and time like <span class="date">@today 2:30pm</span> or <span class="date">@5/25 6:00</span>',check:function check(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data.date;if(date)return date.hasTimeOfDay()}}},{id:"3023653298",text:'Describe urgency with <span class="date">@now</span>, <span class="date">@soon</span>, or <span class="date">@later</span>',check:function check(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var item=d.getModel(e.data.itemID);return item?g.isDateSoft(item.dateText):!1}}},{id:"1941003875",text:'Create a repeating date like <span class="date">@every friday</span> or <span class="date">@every other tuesday</span>',check:function check(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data.date;if(date)return date.isRepeatDate()}}},{id:"766730775",text:'Create a repeating date with a beginning or end <span class="date">@every friday from tomorrow</span> or <span class="date">@every other tuesday until october</span>',check:function check(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&g.vmMain.isLoaded){var date=e.data.date;if(date&&date.isRepeatDate())return!date.getStartDate().equals(Date.today())||!!date.getEndDate()}}}]),this.addSection("cal","Google Calendar (Premium)","Sync items with dates to your Google Calendar.",[{id:"enableCalendar",jsx:React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{raised:!0,primary:!0,marginRight:8,onClick:onClickSettings},"Enable Google Calendar"),"to sync Google Calendar."),hiddenObservable:g.vmMain.pluginManager.getPlugin(PluginID.GCalendar).isActiveObs,check:function check(){}},{id:"adc2",text:'Add an item with a date to Google Calendar by pressing <span class="hHotkey">'+this.secKeyForce+' + C</span> or right clicking the date.<span style="color: #777;"></span>',check:this.checkGoogleCalendar}]),this.addSection("3971635305","Priority","Prioritizing items automatically puts them on your agenda and lets you manage what to do next.",[this.itemRightClick,{id:"215510164",text:'Set a priority with the right click menu or <span class="hHotkey">'+this.secKey+" + 1|2|3</span>",check:this.checkPriority},{id:"2165585377",text:'Click the right edge of an item or <span class="hHotkey">'+this.secKey+" + /</span> to complete it",check:this.checkComplete},{id:"4286506454",text:'Press <span class="hHotkey">'+this.secKey+" + 8</span> to star an item which highlights it in yellow",check:function check(e){if(e.type===TrackerType.Update){var v=e.data[0];return"isStarred"===v.field&&v.newValue}}}]),this.addSection("4240025947","Contacts","Add a contact to an item to easily start a call or email.",[{id:"9158366",text:"Add a contact by typing + in the text of an item",check:function check(e){return e.type===TrackerType.Insert&&"+"===e.data[0].text}},{id:"4275289818",text:"Select a contact's name from the list or start typing a name to narrow the search",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddContact}},{id:"1594166733",text:'Click on a <span class="contact">+contact</span> to start a call or email',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenContact}}]),this.addSection("992386136","Panes","The List pane is where you write and organize while the Agenda pane is organized automatically by time and priority.",[this.itemAddPanes,{id:"1533674769",text:'Click <i class="icon-close gd"></i> in the top right of a pane to close it',check:function check(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.RemovePane}}]),this.addSection("1493247039","Zooming","Zoom in on an item to show only the items under it",[{id:"1829655333",text:'To zoom in on an item, right click it and select Zoom In, press <span class="hHotkey">'+this.priKey+' + Enter</span>, or hold <span class="hHotkey">'+this.priKey+"</span> and click its left edge",check:function check(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut}},{id:"3440644647",text:"To zoom back out, click the title of the list you want to zoom to",check:function check(e){return e.type===TrackerType.Zoom&&e.data[0].zoomOut}},{id:"801492595",text:'Press <i class="overviewButtonNormal icon-list g"></i> in the top left of a pane to open the overview',check:this.checkOverview},{id:"1720747864",text:'Click an item in the Overview to scroll to it or click <i class="icon-zoom-in g"></i> to zoom into it',check:this.checkZoom}]),this.addSection("1393893782","Search","Filter for only the items you want to see right now",[{id:"12602242",text:"Filter for a keyword by searching for that word",check:this.checkSearch},{id:"3689209442",text:'Mark similar items with a <span class="tag">#tag</span> to easily search for all items matching that tag',check:function check(e){return e.type===TrackerType.Insert&&e.data[0].text===TagPrefix}},{id:"2783340419",text:'Filter by priority by clicking the <span class="searchPriority searchP0 hovered"></span> <span class="searchPriority searchP1 hovered"></span> <span class="searchPriority searchP2 hovered"></span> buttons',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&0!==e.data.priority}},{id:"923656242",text:'Show only starred items by clicking the<span class="searchButton"><span class="icon-star yes hovered"></span></span>button',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&0!==e.data.starred}},{id:"2227925102",text:'Hide completed items by clicking the <span class="searchButton"><span class="icon-ok no hovered"><span class="icon-minus"></span></span></span> button',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&0!==e.data.complete}},{id:"457209713",text:"Hide items you're not interested in by starting a search with - (dash)",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data.text.indexOf("-")>=0}}]),this.addSection("gm","Gmail","Integrate your email with your tasks and agenda.",[{id:"eG",jsx:React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{raised:!0,primary:!0,marginRight:8,onClick:onClickSettings},"Enable Gmail"),"to sync Gmail."),hiddenObservable:g.vmMain.pluginManager.getPlugin(PluginID.Gmail).isActiveObs,check:function check(){}},this.itemOpenEmail,this.itemDragEmail,this.itemRightClickEmail,this.itemGmailLabels,this.itemGmailCompose]),this.addSection("327865517","Collaboration","Collaborate with others by sharing documents with different groups of people",[{id:"3453735943",jsx:React.createElement("span",null,React.createElement("span",{style:styleSpan},"Click ",React.createElement(FancyButton,{icon:"icon-folder",iconSize:18,onClick:onClickDocuments}))," in the top left to open the documents menu"),check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocumentsMenu}},{id:"335807521",text:'Click <i class="icon-add f18 g"></i> to create a new document',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddDocument}},{id:"829392903",text:"Open your new document by clicking on it in the list of documents",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocument}},{id:"4176091097",text:'Click <i class="icon-settings f18 g"></i> to change the sharing settings',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocSharing}}]),this.addSection("drv","Google Drive (Premium)","Add files to your Moo.do documents.",[{id:"eD",jsx:React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{raised:!0,primary:!0,marginRight:8,onClick:onClickSettings},"Enable Google Drive"),"to sync Google Drive."),hiddenObservable:g.vmMain.pluginManager.getPlugin(PluginID.Drive).isActiveObs,check:function check(){}},{id:"drL",text:"Drag a file from the Google Drive Pane to an Outline Pane to add it to a list",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Drive}},{id:"drDr",text:"Drag a file from your "+(platform.mac?"Finder":"Explorer")+" to your Outline to upload it to Drive and add it to a list",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DriveUpload}}]),this.addSection("set","Settings","Customize Moo.do to your liking.",[{id:"oS",jsx:React.createElement("span",null,"Click ",React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{icon:"icon-settings",iconSize:18,onClick:onClickOptions}))," at the top right, then Settings, to access plugin and account settings."),check:function check(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.OpenSettingsMenu}},{id:"oDS",jsx:React.createElement("span",null,"Click ",React.createElement("span",{style:styleSpan},React.createElement(FancyButton,{icon:"icon-settings",iconSize:18,onClick:onClickOptions}))," at the top right, then Display Settings, to change display settings."),check:function check(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.OpenDisplaySettings}}]),this.addSection("3926176240","Data","Import data from another app to use in Moo.do or export your data out of Moo.do",[{id:"2124117653",text:'Paste into Moo.do by pressing <span class="hHotkey">'+this.priKey+" + V</span> or finding Paste in your browser's edit menu",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.Paste}},{id:"1754931400",text:'Copy the selected text by pressing <span class="hHotkey">'+this.priKey+" + C</span> or finding Copy in your browser's edit menu",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.Copy}},{id:"1927292896",text:'Click on Import Data in the options menu in the top right, then choose the app to import from and follow the instructions. If you do not see your app, try using copy and paste to paste it in to Moo.do. If that does not work, please <a href="mailto:support@moo.do?subject=Import Request">contact us</a> and tell us what app you want to import from.',check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenImport}},{id:"67562060",text:"Click on Export Data in the options menu in the top right, then choose the format you'd like. You can see your data in a new tab so you may copy or download it.",check:function check(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenExport}}])},onAction:function onAction(e){if(!g.menus.isModalOpen(Modals.ImportData))try{for(var scts=this.sections.get(),i=0;i<scts.length;++i)scts[i].isComplete.get()||scts[i].check(e);for(var key in this.paneIntros)if(this.paneIntros.hasOwnProperty(key)){var sct=this.paneIntros[key];sct.isComplete.get()||sct.check(e)}}catch(err){g.reportError(err)}},closeHelp:function closeHelp(){g.tooltip.hideTip(),this.setMode(C.HelpMode.None),g.sendEvent("Menu","CloseHelp")},onCloseImport:function onCloseImport(){g.tooltip.hideTip(),this.isImportShowing.set(!1),g.shouldWriteLocal()&&util.storage.setItem("closedImport",!0),g.settings.set(Settings.closedImport,!0)},onIntroComplete:function onIntroComplete(){this.isIntroComplete.set(!0)},switchToHelp:function switchToHelp(){delete this.introSection,this.setMode(C.HelpMode.Normal),this.saveState(),g.sendEvent("Menu","OpenHelp")},nextStep:function nextStep(){for(var scts=this.sections.get(),i=0;i<scts.length;++i)scts[i].isComplete.get()||scts[i].check(!0)
},onClickImport:function onClickImport(importer){g.sendEvent("Menu","HelpImport"+importer),g.menus.openModal(Modals.ImportData,{importer:importer})},onTapFeatures:function onTapFeatures(){this.setMode(C.HelpMode.Normal)},onTapHotkeys:function onTapHotkeys(){this.setMode(C.HelpMode.Hotkeys)}},new Intro}),define("Toast",["require","exports","module","globals","Constants","util","data","tracker","platform"],function(require,exports,module){function Toast(info,queue){try{g.PAssert(4149,info,"Must provide valid message info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4150,queue,"Must provide a valid message owner")}catch(PERR){g.reportError(PERR)}if(this.id=info.id||"Message_"+counter++,this.owner=queue,this.timeout=info.timeout||5e3,this.text=info.text,this.action=info.action||MessageAction.Default,this.isBig=info.big,this.data=info.data,this.hold=!info.timeout&&info.hold!==!1&&(info.hold||this.action!==MessageAction.Default),this.noIgnore=info.noIgnore,this.onCloseFn=info.onClose,this.clearTimeout=void 0,this._isVisible=!1,this.actionText=info.actionText,!this.actionText)switch(this.action){case MessageAction.Default:this.actionText="";break;case MessageAction.Reload:case MessageAction.ResetClient:this.actionText="RELOAD";break;case MessageAction.Okay:this.actionText="OKAY";break;case MessageAction.Blog:this.actionText="BLOG";break;case MessageAction.Undo:this.actionText="UNDO";break;case MessageAction.LoginScreen:this.actionText="LOGIN";break;case MessageAction.Contact:this.actionText="CONTACT";break;case MessageAction.OpenSettings:case MessageAction.OpenAccountSettings:case MessageAction.OpenLinkedSettings:this.actionText="SETTINGS";break;case MessageAction.OpenGoogleDrive:this.actionText="GOOGLE DRIVE";break;case MessageAction.OpenDisplaySettings:this.actionText="DISPLAY SETTINGS";break;case MessageAction.StartDemo:this.actionText="START DEMO"}}var counter=0,g=require("globals"),C=require("Constants"),util=require("util"),data=require("data"),tracker=require("tracker"),platform=require("platform");return Toast.prototype={show:function showFn(){this._isVisible||(this._isVisible=!0,this.hold||(this.clearTimeout=setTimeout(this.hide.bind(this),this.timeout)),this.owner.onMessageShow(this))},hide:function hideFn(noNotify){this._isVisible&&(this._isVisible=!1,clearTimeout(this.clearTimeout),this.clearTimeout=void 0,this.onCloseFn&&this.onCloseFn(this),noNotify||this.owner.onMessageHide(this))},isVisible:function isVisibleFn(){return this._isVisible},doAction:function doActionFn(e){if(this.isVisible()){if(g.isFunction(this.action))this.action();else switch(this.action){case MessageAction.None:case MessageAction.Okay:case MessageAction.Default:break;case MessageAction.Reload:g.reload();break;case MessageAction.Login:util.removeURLParam("demo");break;case MessageAction.Demo:util.insertURLParam("demo","true");break;case MessageAction.ResetClient:d.clearData(function(){g.reload()});break;case MessageAction.OpenURL:var targetUrl=this.data?this.data.url:void 0;try{g.PAssert(4151,targetUrl,"Should always have a valid URL to navigate")}catch(PERR){g.reportError(PERR)}targetUrl&&g.openUrl(targetUrl);break;case MessageAction.Blog:g.openUrl("https://www.moo.do/blog/updates");break;case MessageAction.Undo:tracker.undoAction();break;case MessageAction.LoginScreen:util.removeURLParam("demo",!0),util.removeURLParam("dmode");break;case MessageAction.Contact:g.menus.openModal(Modals.ReportBug);break;case MessageAction.OpenSettings:platform.mobile?g.menus.openModal(Modals.MobileSettings):g.menus.openSettings(C.SettingsSections.Plugins);break;case MessageAction.OpenAccountSettings:platform.mobile?g.menus.openModal(Modals.MobileSettings):g.menus.openSettings(C.SettingsSections.Account);break;case MessageAction.OpenLinkedSettings:platform.mobile||g.menus.openSettings(C.SettingsSections.Linked);break;case MessageAction.OpenGoogleDrive:g.openUrl("https://drive.google.com");break;case MessageAction.OpenDisplaySettings:platform.mobile||g.vmMain.isDisplaySettingsOpen.set(!0);break;case MessageAction.StartDemo:window.postMessage("resume","*");break;default:try{g.PAssert(4152,!1,"Invalid message action, add a new case here or pass in a function",this.action)}catch(PERR){g.reportError(PERR)}}this.hide()}},onTapIgnore:function onTapIgnoreFn(e){this.isVisible()&&!this.noIgnore&&this.hide()}},Toast}),define("Toasts",["require","exports","module","globals","Constants","platform","util","data","Toast","ObservableArray"],function(require,exports,module){function Toasts(){this.queue=new ObservableArray,this.remoteMessages={},this.defaultMessages=[],this.defaultMessages[MessageID.Undefined]=void 0,g.toasts=this}var g=require("globals"),C=require("Constants"),platform=require("platform"),util=require("util"),data=require("data"),Toast=require("Toast"),ObservableArray=require("ObservableArray");return Toasts.prototype={getMessageById:function getMessageByIdFn(id){void 0===this.defaultMessages[id]&&this.initMessageById(id);try{g.PAssert(4153,void 0!==this.defaultMessages[id],"After init message should always be defined")}catch(PERR){g.reportError(PERR)}return this.defaultMessages[id]},testMessageById:function testMessageByIdFn(id){return!!this.defaultMessages[id]},initMessageById:function initMessageByIdFn(id){switch(id){case MessageID.ConnectionError:this.defaultMessages[id]=new Toast({text:"Connection error detected. Please reload to try again.",action:MessageAction.Reload},this);break;case MessageID.OfflineUndo:this.defaultMessages[id]=new Toast({text:"Offline undo/redo has been disabled temporarily.",hold:!0},this);break;case MessageID.FatalError:this.defaultMessages[id]=new Toast({text:"There was a fatal error in the application. "+platform.actionVerbCaps()+" to restart.",action:MessageAction.Reload},this);break;case MessageID.MailbirdClick:this.defaultMessages[id]=new Toast({text:"Sorry, emails can currently only be opened from inside Mailbird.",action:MessageAction.Okay},this);break;case MessageID.ExitDemo:this.defaultMessages[id]=new Toast({text:"Changes are not saved in demo",action:MessageAction.LoginScreen,hold:!0,noIgnore:!0},this);break;case MessageID.ShareFailure:this.defaultMessages[id]=new Toast({text:"There was an error sharing the file you attached.",action:MessageAction.OpenSettings,timeout:8e3},this);break;case MessageID.ThisIsDemo:this.defaultMessages[id]=new Toast({text:"Click anywhere to try this live demo of <b>Moo.do</b>",onClose:function onCloseFn(){window.parent.postMessage("userInteracted","*")},hold:!0,big:!0},this);break;case MessageID.InviteFailure:this.defaultMessages[id]=new Toast({text:"Failed to use referral code. Please try again in your account settings.",action:MessageAction.OpenAccountSettings},this);break;case MessageID.InviteSuccess:this.defaultMessages[id]=new Toast({text:"You have successfully used your referral code. Enjoy your additional free trial of premium Moo.do!",action:MessageAction.Okay},this);break;case MessageID.PremiumRequired:this.defaultMessages[id]=new Toast({text:"You must be a premium subscriber to use plugins.",action:MessageAction.OpenAccountSettings,actionText:"LEARN MORE"},this);break;case MessageID.TrialOver:this.defaultMessages[id]=new Toast({text:"Your trial of Premium has come to an end. Please sign up to continue using Premium features.",action:MessageAction.OpenAccountSettings,actionText:"SETTINGS"},this);break;case MessageID.TrialEndSoon:this.defaultMessages[id]=new Toast({text:"Your trial of Premium is ending soon. Please sign up to continue using Premium features after your trial ends.",action:MessageAction.OpenAccountSettings,actionText:"SETTINGS"},this);break;case MessageID.DisabledFolderDrop:this.defaultMessages[id]=new Toast({text:"Drag/dropping folders is currently disabled while we polish some rough edges. Sorry for the inconvienience, please contact support@moo.do if you need this.",action:MessageAction.Okay},this);break;case MessageID.WarnLargeFile:this.defaultMessages[id]=new Toast({text:"Warning: You are uploading a large file. If the upload is not successful, try uploading directly to Google Drive.",action:MessageAction.OpenGoogleDrive},this);break;case MessageID.InviteInvalid:this.defaultMessages[id]=new Toast({text:"Invalid referral code. Please try again in your account settings.",action:MessageAction.OpenAccountSettings,actionText:"OKAY"},this);break;case MessageID.NoSharingWarning:this.defaultMessages[id]=new Toast({text:"You have shared your document with someone else, however the files attached have not been shared due to your permissions settings.",action:MessageAction.OpenSettings,actionText:"SETTINGS"},this);break;case MessageID.LostPermission:this.defaultMessages[id]=new Toast({text:"Moo.do has lost permissions for a plugin or option you enabled. Please update your plugin settings.",action:MessageAction.OpenSettings,actionText:"SETTINGS"},this);break;case MessageID.CalendarSync:this.defaultMessages[id]=new Toast({text:"There was an error syncing your calendars.",action:MessageAction.OpenSettings,actionText:"SETTINGS"},this);break;case MessageID.CalendarListSync:this.defaultMessages[id]=new Toast({text:"There was an error retreiving your calendars.",action:function actionFn(){g.vmMain.pluginManager.getPlugin(PluginID.GCalendar).runCalendarSync()},actionText:"RETRY"},this);break;case MessageID.EmailSendFail:this.defaultMessages[id]=new Toast({text:"Your email was not sent, there was an error contacting the remote server."},this);break;case MessageID.EmailUpdateFail:this.defaultMessages[id]=new Toast({text:"Unable to save draft to Gmail. Your draft is still saved locally."},this);break;case MessageID.EmailLabelFail:this.defaultMessages[id]=new Toast({text:"Unable to sync you changes to Gmail. Your changes are still saved locally."},this);break;case MessageID.EmailSyncFail:this.defaultMessages[id]=new Toast({text:"There was an error syncing your Gmail data.",action:function actionFn(){g.vmMain.pluginManager.getPlugin(PluginID.Gmail).runThreadSync()},actionText:"RETRY"},this);break;case MessageID.OldUserNewTrial:this.defaultMessages[id]=new Toast({text:"You have been started on a premium free trial. Enable premium plugins for free!",action:MessageAction.OpenSettings,actionText:"SETTINGS"},this);break;case MessageID.DemoPluginClick:this.defaultMessages[id]=new Toast({text:"Outside of demo mode this would show you more information about the plugin.",timeout:3e3},this);break;case MessageID.PromptScriptStart:this.defaultMessages[id]=new Toast({text:"Start demo",hold:!0,big:!0,action:MessageAction.StartDemo},this);break;case MessageID.SnoozeOffline:this.defaultMessages[id]=new Toast({text:"You must be online to Snooze. Please try again when Moo.do has connected.",action:MessageAction.Okay},this);break;case MessageID.NeedDrivePermission:this.defaultMessages[id]=new Toast({text:"Attaching files already in Drive requires 'Shared Drive' to be enabled in settings.",action:MessageAction.OpenSettings},this);break;case MessageID.NeedGmailPermission:this.defaultMessages[id]=new Toast({text:"Sending email requires the Gmail plugin to be enabled in settings.",action:MessageAction.OpenSettings},this);break;case MessageID.LostLinked:this.defaultMessages[id]=new Toast({text:"Moo.do has lost access to one of your linked accounts.",action:MessageAction.OpenLinkedSettings},this);break;case MessageID.GmailDisabled:this.defaultMessages[id]=new Toast({text:"Gmail is not enabled on your Google account. Please contact your domain admin.",action:MessageAction.Okay},this);break;case MessageID.LocalWritesDisabled:this.defaultMessages[id]=new Toast({text:"There was an error writing to the local cache. Please restart Moo.do.",action:MessageAction.Reload},this);break;default:try{g.PAssert(4154,!1,"Invalid MessageID")}catch(PERR){g.reportError(PERR)}}},pushMessage:function pushMessageFn(msg){try{g.PAssert(4155,msg,"Must supply a valid message to display")}catch(PERR){g.reportError(PERR)}var vmMsg;if(msg instanceof Toast)vmMsg=msg;else if(g.isObject(msg))vmMsg=new Toast(msg,this);else if(g.isString(msg))vmMsg=new Toast({text:msg},this);else if(vmMsg=this.getMessageById(msg),!vmMsg){try{g.PAssert(4156,!1,"Invalid data passed to message creation")}catch(PERR){g.reportError(PERR)}log("Message not created properly",msg)}return vmMsg&&vmMsg.show(),vmMsg},clearMessage:function clearMessageFn(msg){var vmMsg;return msg instanceof Toast?vmMsg=msg:this.testMessageById(msg)&&(vmMsg=this.getMessageById(msg)),vmMsg&&vmMsg.hide(),vmMsg},onMessageShow:function onMessageShowFn(msg){try{g.PAssert(4157,msg,"Must pass in a valid message to add to the queue")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4158,msg&&msg.doAction,"Message added to queue must have valid API exposed - doAction")}catch(PERR){g.reportError(PERR)}msg instanceof Toast?this.queue.push(msg):g.reportError(new Error("Toast message must be an instance of Toast"),msg)},onMessageHide:function onMessageHideFn(msg){try{g.PAssert(4159,msg,"Must pass in a valid message to be removed from the queue")}catch(PERR){g.reportError(PERR)}var index=this.queue.indexOf(msg);if(0>index)try{g.PAssert(4160,!1,"Trying to remove an invalid message from the queue")}catch(PERR){g.reportError(PERR)}else this.queue.splice(index,1)}},new Toasts}),define("VMAttachment",["globals","util","VMLI","International"],function(g,util,VMLI,International){function VMAttachment(plugin,id,requestedLoadState){this.id=id,this._oldLocalID=void 0,this._plugin=plugin,this._loadState=LoadState.Unloaded,this._requestedLoadState=void 0,this._subscribers=[],this._countInUse=0,this._iteratingSubscribers=!1,this.init(requestedLoadState)}var LoadState={Unloaded:1,Waiting:2,Requesting:3,LoadedPreview:4,LoadedFull:5,FailedRequest:6,Updating:7};return VMAttachment.prototype={init:function initFn(requestedLoadState){this.load(requestedLoadState)},load:function loadFn(requestedState){this._loadState=LoadState.Waiting,this._requestedLoadState=requestedState,this._plugin.requestData(this,requestedState)},notifyDataRequested:function notifyDataRequestedFn(){try{g.PAssert(4161,!this.isLoaded(),"Should not request additional data once loaded")}catch(PERR){g.reportError(PERR)}this._loadState=LoadState.Requesting},notifyDataLoaded:function notifyDataLoadedFn(type,isUpdate,updateFields){try{g.PAssert(4162,isUpdate||this._loadState!==LoadState.LoadedFull||g.isFlagSet(type,PluginLoad.Full),"Should not load preview data after full data has been loaded")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4163,!isUpdate||this._loadState===LoadState.LoadedPreview||g.isFlagSet(type,PluginLoad.Full),"Incoming update much match previous type")}catch(PERR){g.reportError(PERR)}this._loadState=g.isFlagSet(type,PluginLoad.Full)?LoadState.LoadedFull:LoadState.LoadedPreview,this.onUpdate(!0,updateFields,ChangeType.Remote)},notifyDataMutated:function notifyDataMutatedFn(updateFields,changeType){try{g.PAssert(4164,updateFields,"Must specify valid update fields when mutating attachment state manually")}catch(PERR){g.reportError(PERR)}this.onUpdate(!0,updateFields,changeType)},notifyDataRequestFailed:function notifyDataRequestFailedFn(){try{g.PAssert(4165,this._loadState===LoadState.Requesting||this._loadState===LoadState.LoadedPreview,"Must be requesting remote data or a preview cache was able to service after the request was sent")}catch(PERR){g.reportError(PERR)}if(this._loadState===LoadState.Requesting)this._loadState=LoadState.FailedRequest;else if(this._loadState===LoadState.LoadedPreview)try{g.PAssert(4166,!1,"Failed remote reuqest but serviced by preview cache, should not have made the request?")}catch(PERR){g.reportError(PERR)}else try{g.PAssert(4167,!1,"Invalid loadstate when remote request failed: ",this._loadState)}catch(PERR){g.reportError(PERR)}},isLoaded:function isLoadedFn(){return this._loadState===LoadState.LoadedPreview||this._loadState===LoadState.LoadedFull},needsRemoteData:function needsRemoteDataFn(){return this._loadState!==LoadState.LoadedFull},getOldID:function getOldIDFn(){return this._oldLocalID},changeID:function changeIDFn(newID){try{g.PAssert(4168,this.id!==newID,"Change the ID of an attachment to the same value")}catch(PERR){g.reportError(PERR)}if(this.id!==newID){var oldID=this.id;this.id=newID,this._oldLocalID=oldID;try{g.PAssert(4169,!this._iteratingSubscribers,"Should not nest subscriber iterations")}catch(PERR){g.reportError(PERR)}this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i)try{this._subscribers[i].onAttachmentIDChange(this,oldID)}catch(err){g.reportError(err)}this._iteratingSubscribers=!1,this._oldLocalID=void 0}},delayChangeID:function delayChangeIDFn(){try{g.PAssert(4170,!this._iteratingSubscribers,"Should not nest subscriber iterations")}catch(PERR){g.reportError(PERR)}this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i){var subscriber=this._subscribers[i];try{var changeFn=subscriber.onAttachmentIDChange.bind(subscriber,this,this.id);setTimeout(changeFn,0)}catch(err){g.reportError(err)}}this._iteratingSubscribers=!1},isFieldDefined:function isFieldDefinedFn(field){return this._plugin.isFieldDefined(field)},hasField:function hasFieldFn(field){return this._plugin.hasAttachField(this,field)},getField:function getFieldFn(field){return this._plugin.getAttachField(this,field)},updateField:function updateFieldFn(field,value){return this._plugin.updateAttachField(this,field,value)},fieldsHaveParseEffect:function fieldsHaveParseEffectFn(fields){return this._plugin.fieldsHaveParseEffect(fields)},isFieldDefault:function isFieldDefaultFn(field){return this._plugin.isAttachFieldDefault(this,field)},fieldNeedsWrite:function fieldNeedsWriteFn(field,value){return this._plugin.fieldNeedsWrite(this,field,value)},getFieldAsDate:function getFieldAsDateFn(field){var value=this._plugin.getAttachField(this,field);if(value){var date=new Date(value);return date.toString(International.getFormat(DFormat.MonthDay))}try{g.PAssert(4171,!1,"Invalid attachment date field: ",this._plugin.id,field)}catch(PERR){g.reportError(PERR)}return void 0},getPlugin:function getPluginFn(){return this._plugin},getData:function getDataFn(){return this._plugin.getCacheData(this.id)},getEmbedString:function getEmbedStringFn(){return this._plugin.getAttachmentEmbedString(this)},getTitleString:function getTitleStringFn(){return this._plugin.getAttachmentTitleString(this)},unload:function unloadFn(){this._loadState=LoadState.Unloaded,this._plugin.releaseAttachment(this)},match:function matchFn(text){return this.isLoaded()?this._plugin.matchAttachment(this,text):!1},markInUse:function markInUseFn(changeType){0===this._countInUse&&this._plugin.notifyAttachmentInUse(this,changeType),this._countInUse++},markUnused:function markUnusedFn(changeType){this._countInUse--,0===this._countInUse&&this._plugin.notifyAttachmentUnused(this,changeType);try{g.PAssert(4172,this._countInUse>=0,"Should never have negative users of the attachment")}catch(PERR){g.reportError(PERR)}},isInUse:function isInUseFn(){return this._countInUse>0},subscribe:function subscribeFn(subscriber){try{g.PAssert(4173,this._subscribers.indexOf(subscriber)<0,"Must not double subscribe")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4174,!this._iteratingSubscribers,"Should not modify subscriptions during iteration")}catch(PERR){g.reportError(PERR)}this._subscribers.push(subscriber)},unsubscribe:function unsubscribeFn(subscriber){try{g.PAssert(4176,this._subscribers.indexOf(subscriber)>=0,"Subscriber should be active")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4177,!this._iteratingSubscribers,"Should not modify subscriptions during iteration")}catch(PERR){g.reportError(PERR)}this._subscribers.remove(subscriber)},forEachItem:function forEachItemFn(itemStore,cb){try{g.PAssert(4179,!this._iteratingSubscribers,"Should not nest subscriber iterations")}catch(PERR){g.reportError(PERR)}this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i)if(this._subscribers[i]instanceof VMLI&&(!itemStore||this._subscribers[i].belongsToItemStore(itemStore)))try{cb(this._subscribers[i])}catch(err){g.reportError(err)}this._iteratingSubscribers=!1},onUpdate:function onUpdateFn(dataUpdated,updateFields,changeType){if(changeType=changeType||ChangeType.Remote,dataUpdated&&this.isInUse())try{this._plugin.notifyAttachmentUpdated(this)}catch(err){g.reportError(err)}dataUpdated||(changeType|=ChangeType.PluginLoad);try{g.PAssert(4180,!this._iteratingSubscribers,"Should not nest subscriber iterations")}catch(PERR){g.reportError(PERR)}this._iteratingSubscribers=!0;for(var i=0;i<this._subscribers.length;++i)try{this._subscribers[i].onAttachmentUpdate(this,updateFields,changeType)}catch(err){g.reportError(err)}this._iteratingSubscribers=!1},notifyItemTextChanged:function notifyItemTextChangedFn(item,isAttachDelete){this._plugin.notifyItemTextChanged(this,item,isAttachDelete)},notifyItemPropertyChanged:function notifyItemPropertyChangedFn(item,changeType){this._plugin.notifyItemPropertyChanged(this,item,changeType)},isLocalOnlyAttachment:function isLocalOnlyAttachmentFn(){return g.isTempId(this.id)},isType:function isTypeFn(type){return this._plugin.getType()===type},isPlugin:function isPluginFn(pluginID){return this._plugin.id===pluginID},shouldBeDeleted:function shouldBeDeletedFn(){return this.isFieldDefined("isDeleted")&&this.hasField("isDeleted")&&this.getField("isDeleted")&&this.isLocalOnlyAttachment()}},util.defineBase(VMAttachment),VMAttachment}),define("PluginRenderer",["globals","util","VMAttachment","Measure","International"],function(g,util,VMAttachment,Measure,International){function PluginRenderer(){this._registeredRenderers=[],this._registeredRenderers[PluginRenderTypes.Generic]={},this._registeredRenderers[PluginRenderTypes.StyledText]={},this._registeredRenderers[PluginRenderTypes.UnstyledText]={},this._registeredRenderers[PluginRenderTypes.AutocompleteText]={},this._registeredRenderers[PluginRenderTypes.AgendaEntry]={},this._registeredRenderers[PluginRenderTypes.Measure]={}}return PluginRenderer.prototype={registerDefaultRenderers:function registerDefaultRenderersFn(){var renderer=this;this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile,function(attach){return attach.isLoaded()?attach.hasField("isDeleted")&&attach.getField("isDeleted")?attach.getField("title")+"  (Deleted)":attach.getField("title"):attach.hasField("title")?attach.getField("title")+"  (Loading...)":"Loading..."},["title"]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.DriveFile,function(attach){return attach.hasField("title")?attach.getField("title"):"Loading..."},["title"]),this.registerRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.DriveFile,function(data,searchText){var text='<div class="autocompleteDrive">';if(data.parents||data.modifiedDate){if(text+='<div class="metadata">',data.parents){text+='<span class="folderNames">';for(var i=0;i<data.parents.length;++i){var t=data.parents[i].title;i>0&&(text+=", "),text+=t?t:"My Drive"}text+="</span>"}if(data.modifiedDate){var displayFormat;displayFormat=International.getFormat(data.modifiedDate.isToday()?DFormat.ShortTime:DFormat.MonthDay),text+='<span class="modified">'+data.modifiedDate.toString(displayFormat)+"</span>"}text+="</div>"}text+='<span class="plugin plugin_drive '+this.getMimetypeClass(data.mimeType)+'">';var text2="</span></div>",index=data.titleLower.indexOf(searchText);return index>=0&&(index+=text.length),{text:text+data.title+text2,index:index}},["mimeType","title","titleLower","parents","modifiedDate"]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.DriveFile,function(attach,pane,wordStyles){var renderFn=renderer.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile);return Measure.measureWord(pane,renderFn(attach),wordStyles,!1)},["title"]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread,function(attach,pane,maxWidth){var content="";if(attach.isLoaded()){var count=attach.getField("count"),subject=attach.getField("subject");if(subject&&""!==subject||(subject="(no subject)"),content+='<span class="subject'+(count>1?" hasCount":"")+'">'+subject+"</span>",pane&&pane.type===PaneMode.Gmail){var tags=attach.getPlugin().getDisplayTags(attach,pane),participants=attach.getPlugin().getDisplayParticipants(attach);content+='<span class="from">'+participants+"</span>";var line2="";if(count>1&&(line2+='<span class="count">'+count+"</span>"),attach.getField("hasAttachments")&&(line2+='<span class="attach icon-attach_file"></span>'),line2&&(content+='<span class="line2">'+line2+"</span>"),attach.hasField("snippet")&&(content+='<span class="snippet">'+attach.getField("snippet")+"</span>"),tags.length){content+='<span class="tags">';for(var i=0;i<tags.length;++i)content+='<span class="emailLabel">'+tags[i]+"</span>";content+="</span>"}var date=attach.getField("date"),displayFormat;displayFormat=International.getFormat(date.isToday()?DFormat.ShortTime:date.getYear()!==(new Date).getYear()?DFormat.MonthDayYearShort:DFormat.MonthDay),content+='<span class="emailDate">'+date.toString(displayFormat)+"</span>"}}else content="Loading...";return content},["from","subject","snippet","count","date"]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread,function(attach){var subject=attach.getField("subject");subject&&""!==subject||(subject="(no subject)");var fromData=attach.getField("from");return attach.isLoaded()?"From: "+(fromData.text||fromData.email)+" - "+subject:"Loading..."},["from","subject"]),this.registerRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.EmailThread,function(data,searchText){var subject=data.subject;subject&&""!==subject||(subject="(no subject)");var text='<span class="plugin plugin_gmail"><span class="from">',fromData=data.from,from=fromData.text||fromData.email,text2='</span><span class="subject">',text3=subject+"</span></span>";return index=data.subjectLower.indexOf(searchText),index+=text.length+from.length+text2.length,{text:text+from+text2+text3,index:index}},["from","subject","subjectLower"]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.EmailThread,function(attach,pane,wordStyles){var measureText;if(attach.isLoaded()){var measureText=attach.getField("subject");measureText&&""!==measureText||(measureText="(no subject)")}else measureText="Loading...";return Measure.measureWord(pane,measureText,wordStyles,!1)},[]),this.registerRenderer(PluginRenderTypes.AgendaEntry,PluginRenderers.CalendarEvent,function(attach){return"Agenda Entry!"},[]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.CalendarEvent,function(attach){var content="";return content},[]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.CalendarEvent,function(attach){return"Unstyled Text!"},[]),this.registerRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.CalendarEvent,function(data,searchText){return"ACText!"},[]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.CalendarEvent,function(attach,pane,wordStyles){var renderFn=renderer.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.CalendarEvent);return Measure.measureWord(pane,renderFn(attach),wordStyles,!1)},[]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.Unknown,function(attach){return"Unknown Plugin"},[])},registerRenderer:function registerRendererFn(type,id,fn,fields){try{g.PAssert(4181,this._registeredRenderers[type],"Invalid renderer type",type,id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4182,!this._registeredRenderers[type][id],"Cannot register a renderer twice",type,id)}catch(PERR){g.reportError(PERR)}this._registeredRenderers[type][id]={fn:fn,fields:fields}},useRenderer:function useRendererFn(type,id){try{g.PAssert(4183,this._registeredRenderers[type],"Invalid renderer type",type,id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4184,this._registeredRenderers[type][id],"Renderer has not been registered yet",type,id)}catch(PERR){g.reportError(PERR)}return this._registeredRenderers[type][id].fn},ensureRendererFields:function ensureRendererFieldsFn(type,id,plugin){}},PluginRenderer}),define("LowImpactTask",["require","exports","module","globals","util","Dispatcher"],function(require,exports,module){function LowImpactTask(taskCB){this._taskCB=taskCB,this._isRunning=!1,this._disabled=!1,this._workAvailable=!1,this._runCount=0,util.forceBind("handleLowImpactBegin",this),util.forceBind("_onTaskEndRun",this),Dispatcher.listen("lowImpactBegin",this.handleLowImpactBegin)}var g=require("globals"),util=require("util"),Dispatcher=require("Dispatcher");return LowImpactTask.prototype={getStats:function getStatsFn(){return{runCount:this._runCount,isRunning:this._isRunning,isDisabled:this._disabled}},disable:function disableFn(){this._disabled=!0},enable:function enableFn(){this._disabled=!1},handleLowImpactBegin:function handleLowImpactBeginFn(){this._startTaskRun()},requestRun:function requestRunFn(){this._forceRun=!0,this._startTaskRun()},notifyWorkAvailable:function notifyWorkAvailableFn(){this._workAvailable=!0,g.vmMain.isLowImpact()&&!this._isRunning&&this._startTaskRun()},_startTaskRun:function _startTaskRunFn(){if(!this._isRunning&&!this._disabled&&this._workAvailable){try{g.PAssert(4185,this._forceRun||g.vmMain.isLowImpact(),"Must always run a task during a low impact timeframe")}catch(PERR){g.reportError(PERR)}this._workAvailable=!1,this._isRunning=!0,this._runCount++,this._taskCB(this._onTaskEndRun)}},_onTaskEndRun:function _onTaskEndRunFn(hasMoreWork){try{g.PAssert(4186,this._isRunning,"Must be currently running task to finish")}catch(PERR){g.reportError(PERR)}this._isRunning=!1,this._forceRun=!1,(hasMoreWork||this._workAvailable)&&(this._workAvailable=!0,g.vmMain.isLowImpact()&&this._startTaskRun())}},LowImpactTask}),define("PageToken",["require","exports","module","globals","util"],function(require,exports,module){function PageToken(nextPageToken,q,info,maxResults,entryCB,doneCB){try{g.PAssert(4187,g.isFunction(entryCB),"Must supply a valid entry CB")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4188,g.isFunction(doneCB),"Must supply a valid done CB")}catch(PERR){g.reportError(PERR)}this._nextPageToken=nextPageToken,this._inUse=!1,this._q=q,this._info=info,this._maxResults=maxResults,this._entryCB=entryCB,this._doneCB=doneCB}var g=require("globals"),util=require("util"),PageTokenFns={updateToken:function updateTokenFn(newToken){try{g.PAssert(4189,this._nextPageToken!==newToken,"Should never update token to be same value")}catch(PERR){g.reportError(PERR)}this._nextPageToken=newToken},getNextPageToken:function getNextPageTokenFn(){return this._nextPageToken},getInfo:function getInfoFn(){return this._info},getQuery:function getQueryFn(){return this._q},getEntryCB:function getEntryCBFn(){return this._entryCB},getDoneCB:function getDoneCBFn(){return this._doneCB},getMaxResults:function getMaxResultsFn(){return this._maxResults},hasMorePages:function hasMorePagesFn(){return!!this._nextPageToken},notifyBeginUse:function notifyBeginUseFn(){try{g.PAssert(4190,!this._inUse,"Should not currently be in use")}catch(PERR){g.reportError(PERR)}this._inUse=!0},notifyEndUse:function notifyEndUseFn(){try{g.PAssert(4191,this._inUse,"Should always be using token when done")}catch(PERR){g.reportError(PERR)}this._inUse=!1},isInUse:function isInUseFn(){return this._inUse}};return util.defineBase(PageToken),util.extend(PageToken.prototype,PageTokenFns),PageToken}),define("MBatch",["require","exports","module","globals","Constants"],function(require,exports,module){var g=require("globals"),C=require("Constants"),MBatch=function(batchConstructor,params){this._batchConstructor=batchConstructor,this._batchParams=params,this._batchedRequests={},this._successCB=g.emptyFn,this._failureCB=g.emptyFn,this._context=void 0,this._hasRun=!1};return MBatch.prototype={add:function addFn(req,groupID){try{g.PAssert(4192,req,"Must provide a valid request to add to batch")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4193,groupID,"Must supply a valid group ID when adding to a batch")
}catch(PERR){g.reportError(PERR)}try{g.PAssert(4194,!this._hasRun,"Should never add new requests to a batch that has already run")}catch(PERR){g.reportError(PERR)}var createdGroup=this._ensureGroup(groupID);return this._addRequestToGroup(groupID,req),createdGroup},then:function thenFn(successCB,failureCB,context){this._successCB=successCB||g.emptyFn,this._failureCB=failureCB||g.emptyFn,this._context=context,this._run()},execute:function executeFn(cb){this._successCB=cb,this._failureCB=cb,this._run()},_ensureGroup:function _ensureGroupFn(groupID){var createdGroup=!1;return this._batchedRequests[groupID]||(this._batchedRequests[groupID]={size:0,batch:this._createBatchInternal()},createdGroup=!0),createdGroup},_addRequestToGroup:function _addRequestToGroupFn(groupID,req){var batch=this._getGroupBatch(groupID),size=this._getGroupSize(groupID);try{g.PAssert(4195,size<=C.MaxBatchSize,"Too many requests for a single batch")}catch(PERR){g.reportError(PERR)}batch.add(req)},_getGroupBatch:function _getGroupBatchFn(groupID){try{g.PAssert(4196,this._batchedRequests[groupID],"Must ensure before querying")}catch(PERR){g.reportError(PERR)}return this._batchedRequests[groupID].batch},_getGroupSize:function _getGroupSizeFn(groupID){try{g.PAssert(4197,this._batchedRequests[groupID],"Must ensure before querying")}catch(PERR){g.reportError(PERR)}return this._batchedRequests[groupID].size},_getBatchURL:function _getBatchURLFn(){return this._baseURL},_run:function _runFn(){try{g.PAssert(4198,!this._hasRun,"Should never run a batch twice")}catch(PERR){g.reportError(PERR)}this._hasRun=!0;for(var groupID in this._batchedRequests){var batch=this._getGroupBatch(groupID);batch.then(this._handleSuccess.bind(this),this._handleFailure.bind(this))}},_createBatchInternal:function _createBatchInternalFn(){return new this._batchConstructor(this._batchParams)},_handleSuccess:function _handleSuccessFn(response){try{g.PAssert(4199,this._hasRun,"Must run batch before success")}catch(PERR){g.reportError(PERR)}this._successCB.call(this._context,response)},_handleFailure:function _handleFailureFn(response){try{g.PAssert(4200,this._hasRun,"Must run batch before failure")}catch(PERR){g.reportError(PERR)}this._failureCB.call(this._context,response)}},MBatch}),define("apis",["require","exports","module","globals","MBatch","AccountManager"],function(require,exports,module){var g=require("globals"),MBatch=require("MBatch"),AccountManager=require("AccountManager"),apis=function(){};return apis.prototype={loadAPI:function loadAPIFn(name,version,callback){try{g.PAssert(4201,this._data[name],"Must specify a valid known API")}catch(PERR){g.reportError(PERR)}var api=this._data[name];callback(api)},_constructPath:function _constructPathFn(path,fields){var unusedFields=g.clone(fields);for(var field in fields){var reg=new RegExp("\\{"+field+"\\}"),newPath=path.replace(reg,encodeURIComponent(fields[field]));newPath!==path&&delete unusedFields[field],path=newPath}return delete unusedFields.resource,{path:path,fields:unusedFields}},_constructHeaders:function _constructHeadersFn(pathHeaders,accountID){var headers={Authorization:"Bearer "+AccountManager.getAccountTokenSync(accountID).access_token};for(var header in pathHeaders)headers[header]=pathHeaders[header];return headers},canConstruct:function canConstructFn(packedFn){var canConstruct=!1;return g.isFunction(packedFn)||(canConstruct=!!g.unpackFn(packedFn,this._data)),canConstruct},createBatch:function createBatchFn(params){return new MBatch(gapi.client.newBatch,params)},createRequest:function createRequestFn(accountID,packedFn,data){var req,fnData=g.unpackFn(packedFn,this._data);if(fnData){var pathData=this._constructPath(fnData.path,data),headers=this._constructHeaders(fnData.headers,accountID),requestData={path:pathData.path,method:fnData.method||"GET",params:pathData.fields,body:data.resource,headers:headers};g.isDemoMode()&&(requestData.__packedFn=packedFn,requestData.__rawParams=data),req=gapi.client.request(requestData)}else{var fnRequest=g.unpackFn(packedFn);fnRequest&&(req=fnRequest(data))}return req},getAPIForRequest:function getAPIForRequestFn(data){try{g.PAssert(4202,g.isDemoMode(),"Must only reverse the path in demo mode")}catch(PERR){g.reportError(PERR)}return g.unpackFn(data.__packedFn)},_data:{gapi:{client:{drive:{files:{get:void 0,list:void 0,trash:void 0,insert:void 0,patch:void 0},permissions:{list:void 0,insert:void 0,"delete":void 0},properties:{insert:void 0},parents:{insert:void 0},changes:{list:void 0},children:{list:void 0}},gmail:{users:{threads:{list:{path:"/gmail/v1/users/{userId}/threads",method:"GET"},get:{path:"/gmail/v1/users/{userId}/threads/{id}",method:"GET"},modify:{path:"/gmail/v1/users/{userId}/threads/{id}/modify",method:"POST"},trash:{path:"/gmail/v1/users/{userId}/threads/{id}/trash",method:"POST"},untrash:{path:"/gmail/v1/users/{userId}/threads/{id}/untrash",method:"POST"}},labels:{list:{path:"/gmail/v1/users/{userId}/labels",method:"GET"},create:{path:"/gmail/v1/users/{userId}/labels",method:"POST"}},history:{list:{path:"/gmail/v1/users/{userId}/history",method:"GET"}},messages:{get:{path:"/gmail/v1/users/{userId}/messages/{id}",method:"GET"},send:{path:"/gmail/v1/users/{userId}/messages/send",method:"POST"},trash:{path:"/gmail/v1/users/{userId}/messages/{id}/trash",method:"POST"},untrash:{path:"/gmail/v1/users/{userId}/messages/{id}/untrash",method:"POST"},attachments:{get:{path:"/gmail/v1/users/{userId}/messages/{messageId}/attachments/{id}",method:"GET"}}},drafts:{create:{path:"/gmail/v1/users/{userId}/drafts",method:"POST"},update:{path:"/gmail/v1/users/{userId}/drafts/{id}",method:"PUT"},send:{path:"/gmail/v1/users/{userId}/drafts/send",method:"POST"},"delete":{path:"/gmail/v1/users/{userId}/drafts/delete",method:"DELETE"},list:{path:"/gmail/v1/users/{userId}/drafts",method:"GET"}},settings:{sendAs:{list:{path:"/gmail/v1/users/{userId}/settings/sendAs",method:"GET"}}}}},calendar:{settings:{list:void 0},events:{get:void 0,list:void 0,patch:void 0,insert:void 0,"delete":void 0},calendars:{insert:void 0},calendarList:{list:void 0}}}}}},new apis}),define("VMPlugin",["globals","util","Constants","data","goog","gdata","PaneFactory","PluginRenderer","VMAttachment","Measure","Observable","LowImpactTask","AccountManager","PageToken","apis"],function(g,util,C,d,goog,gdata,PaneFactory,PluginRenderer,VMAttachment,Measure,Observable,LowImpactTask,AccountManager,PageToken,apis){function VMPlugin(id,name){try{g.PAssert(4203,id,"Must supply a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4204,name,"Must supply a valid name")}catch(PERR){g.reportError(PERR)}this.id=id,this.name=name,this._previewCache="p_"+id,this._offlineCache="ocache_"+id,this._paneType="Pane"+id,this._rootId=id+"Root",this._acProviderId="AC"+id,this._settingsGroup="plugin"+this.id,this.loadedEvent="Plugin_"+id+"_Loaded",this.pluginMargin=12,this.pluginPadding=24,this.isActiveObs=new Observable(!1),this._isReady=!1,this._hasDeactivated=!1,this._propertyDescriptors={},this._propertySets={},this._registeredAutocomplete=!1,this._attachKeys=[],this._attachCache={},this._dataKeys=[],this._dataCache={},this._scorchOfflineCache=!1,this._defaultItemStore=void 0,this._activeItemStore={},this._defaultZoomItems={},this._searchBuckets={},this._activeSearchBucket={},this._numDeferredReqs=0,this._numOutstandingReqs=0,this._pendingRequests=[],this._outstandingRequests=[],this._isRateLimited=!1,this._lastRateLimitTime=void 0,this._activeAttachments=[],this._numActivePanes=0,this._requestCounter=0,this._unloadedDependencies=this.getDependencies(),this._isFirstLoad=!0,this._hasRunOfflineLoad=!1,this._loadedInitialData=!1,this._hasLoadedCaches=!1,this._registeredCaches={},this._registeredModals={},this._createdModals={},this._recurringTasks=[],this._lowImpactTasks={},this.Settings={},window.PluginSettingsID[this.id]={},util.forceBind("_retryRemoteRequest",this),util.forceBind("_onGoogleAuthorized",this),g.settings.registerGroup(this._settingsGroup),this.registerSetting("IsEnabled","isEnabled",!0,!1,!this._isBuiltin),this.getDataPane()&&PaneFactory.registerPaneType(this,this._paneType,this.name,this.getDataPane(),this.getPaneIcon()),DETAILED_STATS&&(this.__Stats={requestData:0,remoteRequests:0,canceledRequests:0,dupedRequests:0,combinedRequests:0,remoteBatches:0,remoteRetries:0,canceledBatches:0,actualRemoteCallsSent:0,cacheWrites:0,cacheUpdates:0,findByField:0,createdAttachments:0,previewCacheIsAvailable:0,previewCacheUpdate:0,previewCacheQuery:0},this.__TrackedStats={},this.__ReqStats=[]),this.onSettingChanged(this.Settings.IsEnabled,function(oldValue,newValue){newValue&&g.vmMain.pluginManager.activatePlugin(this)}.bind(this))}var retryTimeouts=[0,5,15,35,80,170],retryErrorCodes=[0,408,429,500,502,503,504,null],rateLimitErrorCodes=[429],DefaultRequestTimeout=g.seconds(15),pluginDependencyInfo={};return pluginDependencyInfo[PluginDependency.DemoMode]={online:!1},pluginDependencyInfo[PluginDependency.DriveAPI]={online:!0},pluginDependencyInfo[PluginDependency.GmailAPI]={online:!0},pluginDependencyInfo[PluginDependency.CalendarAPI]={online:!0},pluginDependencyInfo[PluginDependency.GoogleLogin]={online:!0},pluginDependencyInfo[PluginDependency.PremiumSub]={online:!1},pluginDependencyInfo[PluginDependency.EarlyAccess]={online:!1},pluginDependencyInfo[PluginDependency.LocalLoaded]={online:!1},VMPlugin.prototype={getType:function getTypeFn(){return C.PluginType.Unknown},sendEvent:function sendEventFn(action,value){return g.sendEvent(this.id,action,value)},getSetting:function getSettingFn(key){return g.settings.get(key,this._settingsGroup)},setSetting:function setSettingFn(key,value){return g.settings.set(key,value,this._settingsGroup)},onAuthorizedSetting:function onAuthorizedSettingFn(key,value){},registerSetting:function registerSettingFn(name,key,syncRemote,defaultValue,serverNotification){window.PluginSettingsID[this.id][name]=key,this.Settings[name]=key,g.settings.registerSetting(key,this._settingsGroup,syncRemote,defaultValue),serverNotification&&g.settings.registerAPIServerNotification(key,this._settingsGroup),d.addDefaultSkipSetting(key,this._settingsGroup)},onSettingChanged:function onSettingChangedFn(key,cb){g.settings.registerForChangeNotification(key,this._settingsGroup,cb)},registerHotkey:function registerHotkeyFn(keyCode,primary,shift,callback,stopPropagation){return g.vmMain.hotkeyManager.registerHotkey(keyCode,primary,shift,callback,stopPropagation)},getCacheStats:function getCacheStatsFn(cb){var stats={};if(this.supportOfflineCache()&&g.shouldWriteLocal()){var offlineStats={},inString=util.storage.getItem(this.getOfflineCacheName());if(inString){offlineStats.size=inString.length;try{var inObj=JSON.parse(inString);if(inObj){offlineStats.props=inObj.props;var data=inObj.data;offlineStats.count=Object.keys(data).length}}catch(err){g.reportError(err)}}stats.Offline=offlineStats}var numCaches=Object.keys(this._registeredCaches).length,seenCaches=0;if(numCaches>0)for(var cacheID in this._registeredCaches){var cache=this._registeredCaches[cacheID];cache.getStats(function(cacheStats){stats[cacheStats.id]=cacheStats,numCaches===++seenCaches&&cb(stats)})}else cb()},getCacheState:function getCacheStateFn(){var state={};for(var cacheID in this._registeredCaches){var cache=this._registeredCaches[cacheID];state[cacheID]=cache.getState()}return state},registerLocalCache:function registerLocalCacheFn(name,storageType,isPrimary){var cacheID;cacheID=isPrimary?this.id:this.id+"_"+name;var cache=g.vmMain.cacheManager.registerLocalCache(cacheID,name,storageType);return this._registeredCaches[cacheID]=cache,cache},registerDeferredTaskType:function registerDeferredTaskTypeFn(type,cbRun,cbCancel,cbPersistRemote){try{g.PAssert(4205,type,"Must specify a valid deferred task type")}catch(PERR){g.reportError(PERR)}g.vmMain.deferredTaskManager.registerTaskType(type,cbRun,cbCancel,cbPersistRemote)},scheduleDeferredTask:function scheduleDeferredTaskFn(id,type,time,data){try{g.PAssert(4206,id,"Must supply a valid local ID for deferred task")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4207,type,"Must specify a valid deferred task type")}catch(PERR){g.reportError(PERR)}g.vmMain.deferredTaskManager.scheduleTask(id,type,time,!1,void 0,data)},cancelDeferredTask:function cancelDeferredTaskFn(id,type){g.vmMain.deferredTaskManager.cancelTask(id,type)},createRecurringTask:function createRecurringTaskFn(id,options){var taskID=this.id+"_"+id;return this._recurringTasks.push(id),g.vmMain.recurringTaskManager.createRecurringTask(taskID,options)},getRecurringTask:function getRecurringTaskFn(id){return g.vmMain.recurringTaskManager.getRecurringTask(this.id+"_"+id)},hasRecurringTask:function hasRecurringTaskFn(id){return g.vmMain.recurringTaskManager.hasRecurringTask(this.id+"_"+id)},cancelRecurringTask:function cancelRecurringTaskFn(id){var taskID=this.id+"_"+id;return this._recurringTasks.remove(id),g.vmMain.recurringTaskManager.cancelRecurringTask(taskID)},cancelRecurringTasks:function cancelRecurringTasksFn(){for(;this._recurringTasks.length>0;)this.cancelRecurringTask(this._recurringTasks[0])},getRecurringStats:function getRecurringStatsFn(){for(var stats={},i=0;i<this._recurringTasks.length;++i){var id=this._recurringTasks[i],task=this.getRecurringTask(id);stats[id]=task.getStats()}return stats},registerLowImpactTask:function registerLowImpactTaskFn(id,cb){try{g.PAssert(4208,!this._lowImpactTasks[id],"Must specify different IDs for each task: ",id)}catch(PERR){g.reportError(PERR)}var task=new LowImpactTask(cb);return this._lowImpactTasks[id]=task,task},getLowImpactStats:function getLowImpactStatsFn(){var stats={};for(var id in this._lowImpactTasks){var task=this._lowImpactTasks[id];stats[id]=task.getStats()}return stats},registerModal:function registerModalFn(id,constructor){var modalID=this.id+"_"+id;try{g.PAssert(4209,!this._registeredModals[modalID],"Modal already registered with this ID: "+id)}catch(PERR){g.reportError(PERR)}this._registeredModals[modalID]=constructor},openModal:function openModalFn(id,data){var modalID=this.id+"_"+id;this._createdModals[modalID]||(this._createdModals[modalID]=new this._registeredModals[modalID](modalID));var modal=this._createdModals[modalID];modal.openDialog(data)},closeModal:function closeModalFn(id){var modalID=this.id+"_"+id,modal=this._createdModals[modalID];try{g.PAssert(4210,modal,"Must have already created modal to close it")}catch(PERR){g.reportError(PERR)}modal.closeDialog()},addTrackedStat:function addTrackedStatFn(key){if(DETAILED_STATS){try{g.PAssert(4211,!this.__TrackedStats.hasOwnProperty(key),"Should not double define a tracked stat for a plugin")}catch(PERR){g.reportError(PERR)}this.__TrackedStats[key]=0}},reportTrackedStat:function reportTrackedStatFn(key){if(DETAILED_STATS){try{g.PAssert(4212,this.__TrackedStats.hasOwnProperty(key),"Must first register a tracked stat before reporting instantces of it")}catch(PERR){g.reportError(PERR)}this.__TrackedStats[key]++}},getStats:function getStatsFn(){return{fnCalls:DETAILED_STATS?this.__Stats:void 0,tracked:DETAILED_STATS?this.__TrackedStats:void 0,remoteReqs:DETAILED_STATS?this.__ReqStats:void 0,numItems:this._defaultItemStore?this._defaultItemStore.getCount():-1,activeAttachments:this._activeAttachments.length,numAttach:this._attachKeys.length,numDataCache:this._dataKeys.length,lowImpact:this.getLowImpactStats(),recurring:this.getRecurringStats()}},getState:function getStateFn(){return{isActive:this.isActiveObs.get(),isReady:this._isReady,isRateLimited:this._isRateLimited,hasDeactivated:this._hasDeactivated,scorchedCaches:this._scorchOfflineCache,numDeferredReqs:this._numDeferredReqs,numOutstandingReqs:this._numOutstandingReqs,numPendingReqs:this._pendingRequests.length,numActivePanes:this._numActivePanes,unloadedDeps:this._unloadedDependencies,isFirstLoad:this._isFirstLoad,hasRunOfflineLoad:this._hasRunOfflineLoad,loadedInitialData:this._loadedInitialData,hasLoadedCaches:this._hasLoadedCaches,cacheState:this.getCacheState()}},isPluginPane:function isPluginPaneFn(pane){return pane.type===this._paneType},getPaneType:function getPaneTypeFn(){return this._paneType},activate:function activateFn(loadedDeps){if(!this.isActiveObs.get()){if(this.isActiveObs.set(!0),this.useItemStore()){this._defaultItemStore=g.vmMain.itemStoreManager.registerItemStore(this.id,this,this.itemStoreOptions());var pluginStoreRoot=this._defaultItemStore.createRoot(this._rootId,"");setTimeout(function(){this.isActive()&&pluginStoreRoot.setText(this.useItemStore(),!0,ChangeType.Auto)}.bind(this),0)}if(this._hasLoadedCaches||(this.usesPreviewCache()&&this.registerPreviewCache(),this.supportOfflineCache()&&g.shouldWriteLocal()&&this.loadOfflineCache(),this._hasLoadedCaches=!0),this.ensurePaneTypeIsActive(),this.registerAutocomplete(),this._unloadedDependencies)for(var dep in loadedDeps)this.onDependencyLoaded(dep,loadedDeps[dep]);return this._unloadedDependencies||this.onAllDependenciesLoaded(),g.vmMain.pluginManager.fireEvent("pluginActiveChanged",this.id,"activated",[this,!0]),!0}return!1},deactivate:function deactivateFn(){try{g.PAssert(4213,this.isActiveObs.get(),"Must be active in order to deactivate pane")}catch(PERR){g.reportError(PERR)}return this.isActiveObs.set(!1),g.vmMain.pluginManager.fireEvent("pluginActiveChanged",this.id,"deactivated",[this,!1]),this.unregisterAutocomplete(),this.getDataPane()&&g.vmMain.paneFactory.deactivatePaneType(this._paneType),this.useItemStore()&&(g.vmMain.itemStoreManager.unregisterItemStore(this.id),this._defaultItemStore=void 0),this.cancelRecurringTasks(),this._loadedInitialData=!1,this._isFirstLoad=!0,this._hasRunOfflineLoad=!1,this._hasDeactivated=!0,!0},ensurePaneTypeIsActive:function ensurePaneTypeIsActiveFn(){var premiumIsValid=!this.hasDependency(PluginDependency.PremiumSub)||g.billingManager.hasPremiumFeatures();premiumIsValid&&this.getDataPane()&&!PaneFactory.isPaneTypeActive(this._paneType)&&this.getSetting(this.Settings.IsEnabled)&&PaneFactory.activatePaneType(this._paneType)},isActive:function isActiveFn(){return this.isActiveObs.get()},isReady:function isReadyFn(){return this._isReady},isEnabled:function isEnabledFn(){return g.isDemoMode()||this.isAvailable()&&this.getSetting(this.Settings.IsEnabled)},isAvailable:function isAvailableFn(){var isAvailable=!1,requiresEarlyAccess=this.hasDependency(PluginDependency.EarlyAccess),requiresPremiumSub=this.hasDependency(PluginDependency.PremiumSub);try{g.PAssert(4214,!requiresPremiumSub||!requiresEarlyAccess,"Must not require both early access and premium sub: "+this.id)}catch(PERR){g.reportError(PERR)}var hasEarlyAccess=g.billingManager.hasEarlyAccess(),hasPremiumSub=g.billingManager.hasPremiumFeatures();return requiresEarlyAccess&&hasEarlyAccess?isAvailable=!0:requiresPremiumSub&&hasPremiumSub?isAvailable=!0:requiresEarlyAccess||requiresPremiumSub?g.isDemoMode()&&(isAvailable=!0):isAvailable=!0,isAvailable},isCurrentlyAuthorized:function isCurrentlyAuthorizedFn(accountID){return AccountManager.isCurrentlyAuthorized(accountID)},_onGoogleAuthorized:function _onGoogleAuthorizedFn(accountID){try{g.PAssert(4215,"me"===accountID||AccountManager.isCurrentlyAuthorized(accountID),"Must have a valid access token")}catch(PERR){g.reportError(PERR)}this.onAuthorized(accountID)},onAuthorized:function onAuthorizedFn(accountID){this._pendingRequests.length>0&&g.vmMain.pluginManager.notifyHasPendingRemoteRequest()},isOnline:function isOnlineFn(){return g.vmMain.pluginManager.isOnline()},goOnline:function goOnlineFn(){},goOffline:function goOfflineFn(){},onDocumentShared:function onDocumentSharedFn(firstShare){},onShutdown:function onShutdownFn(){},onDependencyLoaded:function onDependencyLoadedFn(dep,data){if(this._unloadedDependencies){var depIndex=this._unloadedDependencies.indexOf(dep);if(depIndex>=0&&(this.isDependencyLoaded(dep,data)&&this._unloadedDependencies.removeAt(depIndex),dep===PluginDependency.PremiumSub&&this.ensurePaneTypeIsActive()),0===this._unloadedDependencies.length)this._unloadedDependencies=void 0,this.onAllDependenciesLoaded();else if(this.supportOfflineLoad()&&!this._hasRunOfflineLoad){for(var hasOfflineDep=!1,i=0;i<this._unloadedDependencies.length;++i){var unloadedDep=this._unloadedDependencies[i];pluginDependencyInfo[unloadedDep].online||(hasOfflineDep=!0)}!hasOfflineDep&&this.isActiveObs.get()&&this.offlineLoad()}}},onAllDependenciesLoaded:function onAllDependenciesLoadedFn(){this.isActiveObs.get()&&setTimeout(function(){this._isReady=!0,g.vmMain.paneManager.runForEachPane(function(pane){pane.isNotReady=!1},this._paneType),this._updateAttachmentStates(),this.offlineLoad(),this.load()}.bind(this),0)},areDependenciesLoaded:function areDependenciesLoadedFn(){return void 0===this._unloadedDependencies},hasDependencyBeenLoaded:function hasDependencyBeenLoadedFn(dep){var hasLoaded=!1;return this.hasDependency(dep)&&(this.getUnloadedDependencies()?this.getUnloadedDependencies().indexOf(dep)<0&&(hasLoaded=!0):hasLoaded=!0),hasLoaded},isDependencyLoaded:function isDependencyLoadedFn(dep,data){return!0},getUnloadedDependencies:function getUnloadedDependenciesFn(){return this._unloadedDependencies},loadRemoteAPIs:function loadRemoteAPIsFn(cb,timeout){cb&&cb()},areRemoteAPIsLoaded:function areRemoteAPIsLoadedFn(){return!0},forceLoad:function forceLoadFn(){this._loadedInitialData=!1,this.activate(),this._unloadedDependencies&&(this._unloadedDependencies=void 0,this.onAllDependenciesLoaded())},authorize:function authorizeFn(offlineAccess,cb){try{g.PAssert(4216,cb&&g.isFunction(cb),"Must provide a valid authoirzation callback")}catch(PERR){g.reportError(PERR)}this.googleScopes()?this._authorizeGoogle(offlineAccess,cb):cb(!0)},_authorizeGoogle:function _authorizeGoogleFn(offlineAccess,cb){try{g.PAssert(4217,this.googleScopes(),"Must have a valid google scope to request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4218,cb&&g.isFunction(cb),"Must provide a valid authoirzation callback")}catch(PERR){g.reportError(PERR)}offlineAccess?goog.runAuthenticateOffline(this.googleScopes(),function(token){cb(token&&!token.error)}):goog.runAuthenticate(this.googleScopes(),!1,!1,function(token){cb(token&&!token.error)})},googleScopes:function googleScopesFn(){return void 0},getDependencies:function getDependenciesFn(){return void 0},hasDependency:function hasDependencyFn(dep){var deps=this.getDependencies();return deps?deps.indexOf(dep)>=0:!1},getOfflineCacheName:function getOfflineCacheNameFn(){return this._offlineCache},loadOfflineCache:function loadOfflineCacheFn(){try{g.PAssert(4219,0===this._dataKeys.length,"Must have no data already loaded")}catch(PERR){g.reportError(PERR)}if(this.supportOfflineCache()&&g.shouldWriteLocal()){var inString=util.storage.getItem(this.getOfflineCacheName());if(inString)try{var inObj=JSON.parse(inString);inObj&&this.loadDataFromObject(inObj)}catch(err){g.reportError(err)}}},loadDataFromObject:function loadDataFromObjectFn(inObj){try{g.PAssert(4220,inObj,"Must provide a valid dataset to load")}catch(PERR){g.reportError(PERR)}var props=inObj.props,data=inObj.data;try{g.PAssert(4221,data,"Load object must contain valid data")}catch(PERR){g.reportError(PERR)}this._dataKeys=Object.keys(data);for(var i=0;i<this._dataKeys.length;++i){var key=this._dataKeys[i];this._dataCache[key]=this.createEntryFromLocal(key,data[key]),this._dataCache[key].id=key}},saveOfflineCache:function saveOfflineCacheFn(){if(this.supportOfflineCache()&&g.shouldWriteLocal()&&!this._scorchOfflineCache){for(var numEntries=0,outObjData={},i=0;i<this._activeAttachments.length;++i){var attach=this._activeAttachments[i];try{g.PAssert(4222,attach.isInUse(),"Attachments in the active list should always be in use")}catch(PERR){g.reportError(PERR)}if(attach.isInUse()){var serialObj=this.serializeEntry(attach.id);serialObj&&(outObjData[attach.id]=serialObj,numEntries++)}}var outObj={data:outObjData,info:{writeDate:Date.now(),entries:numEntries}};try{var outString=JSON.stringify(outObj);util.storage.setItem(this.getOfflineCacheName(),outString)}catch(err){g.reportError(err)}}},clearOfflineCache:function clearOfflineCacheFn(noFutureSave){this.supportOfflineCache()&&g.shouldWriteLocal()&&(util.storage.removeItem(this.getOfflineCacheName()),noFutureSave&&(this._scorchOfflineCache=!0))},supportOfflineLoad:function supportOfflineLoadFn(){return!1},supportOfflineCache:function supportOfflineCacheFn(){return!1},createEntryFromLocal:function createEntryFromLocalFn(id,info){try{g.PAssert(4223,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},clearData:function clearDataFn(){for(var i=0;i<this._attachKeys.length;++i)this._attachCache[this._attachKeys[i]].unload();this._attachKeys=[],this._attachCache={},this._dataKeys=[],this._dataCache={},this.useItemStore()&&(this.getDefaultItemStore().clearStore(),this._activeItemStore={}),this._searchBuckets={},this._activeSearchBucket={},this._numDeferredReqs=0,this._numOutstandingReqs=0,this._pendingRequests=[],this._outstandingRequests=[],this._activeAttachments=[]},changeID:function changeIDFn(attach,oldID,newID){try{g.PAssert(4224,oldID!==newID,"Should never be switching to the same ID")}catch(PERR){g.reportError(PERR)}var checkNewAttachID=this._attachCache[newID];if(checkNewAttachID)attach.delayChangeID(newID),this._attachCache[oldID]=void 0,this._attachKeys.remove(oldID),this._dataCache[oldID]=void 0,this._dataKeys.remove(oldID);else{var attachEntry=this._attachCache[oldID];try{g.PAssert(4225,attach===attachEntry,"Attach entries must match")}catch(PERR){g.reportError(PERR)}attachEntry&&(this._attachCache[oldID]=void 0,this._attachCache[newID]=attachEntry,this._attachKeys.remove(oldID),this._attachKeys.push(newID));var entry=this._dataCache[oldID];if(this._dataCache[oldID]=void 0,entry)entry.id===oldID&&(entry.id=newID),this._dataCache[newID]=entry,this._dataKeys.remove(oldID),this._dataKeys.push(newID);else try{g.PAssert(4226,this._dataKeys.indexOf(newID)>=0,"Should have already changed the ID")}catch(PERR){g.reportError(PERR)}var wasLocalOnlyAttach=attach.isLocalOnlyAttachment();attach.changeID(newID),attach.isInUse()&&wasLocalOnlyAttach&&this.notifyAttachmentUpdated(attach)}},_isPreviewData:function _isPreviewDataFn(data){for(var props=this.getPropertySet(PluginLoad.Preview),i=0;i<props.length;++i){var desc=this.getPropertyDescriptor(props[i]);if(!desc.isOpt&&!data.hasOwnProperty(props[i]))return!1}return!0},_isFullData:function _isFullDataFn(data){for(var props=this.getPropertySet(PluginLoad.Full),i=0;i<props.length;++i){var desc=this.getPropertyDescriptor(props[i]);if(!desc.isOpt&&!data.hasOwnProperty(props[i]))return!1}return!0},_addPreviewEntry:function _addPreviewEntryFn(id,data){var entry=this.createEntryFromLocal(id,data);return this.cacheData(id,entry),entry},cacheData:function cacheDataFn(key,data,isUpdate,updateFields){try{g.PAssert(4227,key,"Must supply a valid key for data")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&this.__Stats.cacheWrites++;var oldData=this._dataCache[key];if(this._dataCache[key]=data,oldData?DETAILED_STATS&&this.__Stats.cacheUpdates++:this._dataKeys.push(key),this._attachCache[key]){var attach=this._attachCache[key],loadState=this._getPluginLoadType(data);try{g.PAssert(4229,loadState,"Must either contain valid preview or full data")}catch(PERR){g.reportError(PERR)}attach.notifyDataLoaded(loadState,isUpdate,updateFields)}},getCacheData:function getCacheDataFn(key){return this._dataCache[key]},_attachMetadataFields:function _attachMetadataFieldsFn(){return void 0},fieldsHaveParseEffect:function fieldsHaveParseEffectFn(fields){var hasEffect=!1,metadataFields=this._attachMetadataFields();if(metadataFields&&fields){for(var i=0;i<fields.length;++i)if(metadataFields.indexOf(fields[i])<0){hasEffect=!0;break}}else hasEffect=!0;return hasEffect},isFieldDefined:function isFieldDefinedFn(field){return!!this.getPropertyDescriptor(field)},hasAttachField:function hasAttachFieldFn(attach,field){var hasField=!1,data=this._dataCache[attach.id];if(data&&data.hasOwnProperty(field))hasField=!0;else{var desc=this.getPropertyDescriptor(field);try{g.PAssert(4231,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}desc&&desc.isOpt&&(hasField=!0)}return hasField},getAttachField:function getAttachFieldFn(attach,field){var value,data=this._dataCache[attach.id];if(data&&data.hasOwnProperty(field))value=data[field];else{var desc=this.getPropertyDescriptor(field);try{g.PAssert(4232,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4233,!desc||desc.isOpt,"Field must be optional if it is not defined",field)}catch(PERR){g.reportError(PERR)}value=desc?desc.defaultValue:void 0}return value},updateAttachField:function updateAttachFieldFn(attach,field,value){var didUpdate=!1;try{g.PAssert(4234,this.isFieldDefined(field),"Must be updating a valid attachment field")}catch(PERR){g.reportError(PERR)}var data=this._dataCache[attach.id];try{g.PAssert(4235,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}if(data){var desc;this.dataFieldNeedsWrite(data,field,value)&&(data[field]=value,this.cacheData(attach.id,data,!0,[field])),didUpdate=!0}return didUpdate},isAttachFieldDefault:function isAttachFieldDefaultFn(attach,field){var isDefault=!1,data=this._dataCache[attach.id];try{g.PAssert(4238,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}if(data){var desc=this.getPropertyDescriptor(field);try{g.PAssert(4239,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}data.hasOwnProperty(field)?desc&&desc.isOpt&&desc.defaultValue===data[field]&&(isDefault=!0):desc&&desc.isOpt&&(isDefault=!0)}return isDefault},fieldNeedsWrite:function fieldNeedsWriteFn(attach,field,value){var data=this._dataCache[attach.id];try{g.PAssert(4240,data,"Invalid field request: ",this.id,field)}catch(PERR){g.reportError(PERR)}return this.dataFieldNeedsWrite(data,field,value)},dataFieldNeedsWrite:function dataFieldNeedsWriteFn(data,field,value){var needsWrite=!1;if(data){var desc=this.getPropertyDescriptor(field);try{g.PAssert(4241,desc,"Must have a valid field descriptor",field)}catch(PERR){g.reportError(PERR)}var compactValue=this.compactCacheField(data,field);data.hasOwnProperty(field)?(void 0!==value||compactValue!==desc.defaultValue)&&(desc&&desc.comparator?desc.comparator(compactValue,value)||(needsWrite=!0):compactValue!==value?needsWrite=!0:(g.isObject(compactValue)||g.isObject(value)||g.isArray(compactValue)||g.isArray(value))&&(needsWrite=!0)):void 0!==value&&(desc&&desc.isOpt&&desc.defaultValue===value||(needsWrite=!0))}return needsWrite},hasCacheData:function hasCacheDataFn(key){return!!this._dataCache[key]},findCachedItemsByField:function findCachedItemsByFieldFn(field,value,limit){DETAILED_STATS&&this.__Stats.findByField++;for(var matches=[],i=0;i<this._dataKeys.length;i++){var item=this._dataCache[this._dataKeys[i]];if(item[field]===value&&(matches.push(item),matches.length>=limit))break}return matches},findCachedItemsByFn:function findCachedItemsByFnFn(fn,limit){try{g.PAssert(4242,fn,"Must supply a valid match function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4243,g.isFunction(fn),"Match function must be a valid function")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&this.__Stats.findByFn++;for(var matches=[],i=0;i<this._dataKeys.length;i++){var item=this._dataCache[this._dataKeys[i]];if(fn(item)&&(matches.push(item),matches.length>=limit))break}return matches},notifyAttachmentInUse:function notifyAttachmentInUseFn(attach,changeType){try{g.PAssert(4244,this._activeAttachments.indexOf(attach)<0,"Attachment should not already be active")}catch(PERR){g.reportError(PERR)}this._activeAttachments.push(attach),g.isLocalChange(changeType)&&this.usesPreviewCache()&&this.isPreviewCacheAvailable()&&attach.isLoaded()&&!attach.isLocalOnlyAttachment()&&this.writeAttachmentToPreviewCache(attach)},notifyAttachmentUpdated:function notifyAttachmentUpdatedFn(attach){this.usesPreviewCache()&&this.isPreviewCacheAvailable()&&attach.isLoaded()&&!attach.isLocalOnlyAttachment()&&this.writeAttachmentToPreviewCache(attach)
},notifyAttachmentUnused:function notifyAttachmentUnusedFn(attach,changeType){try{g.PAssert(4245,this._activeAttachments.indexOf(attach)>=0,"Attachment should be marked active")}catch(PERR){g.reportError(PERR)}this._activeAttachments.remove(attach),g.isLocalChange(changeType)&&this.usesPreviewCache()&&this.isPreviewCacheAvailable()&&attach.isLoaded()&&!attach.isLocalOnlyAttachment()&&this.updatePreviewCache(attach.id,void 0)},notifyItemTextChanged:function notifyItemTextChangedFn(attach,item,isAttachDelete){},notifyItemPropertyChanged:function notifyItemPropertyChangedFn(attach,item,changeType){},getAttachment:function getAttachmentFn(key,requestedState){try{g.PAssert(4246,key,"Must provide a valid key")}catch(PERR){g.reportError(PERR)}return key&&!this._attachCache[key]&&(this._attachCache[key]=this._requestAttachment(key,requestedState),this._attachKeys.push(key)),this._attachCache[key]},hasAttachment:function hasAttachmentFn(key){return!!this._attachCache[key]},forEachActiveAttachment:function forEachActiveAttachmentFn(cb){for(var i=0;i<this._activeAttachments.length;++i)cb(this._activeAttachments[i])},forEachAttachment:function forEachAttachmentFn(cb){for(var i=0;i<this._attachKeys.length;++i)cb(this._attachCache[this._attachKeys[i]])},numActiveAttachments:function numActiveAttachmentsFn(){return this._activeAttachments.length},getAttachmentEmbedString:function getAttachmentEmbedStringFn(attach){return this._getTextForItem(attach)},getAttachmentTitleString:function getAttachmentTitleStringFn(attach){return this.getUnstyledText(attach)},_getTextForItem:function _getTextForItemFn(item){try{g.PAssert(4247,item,"Must pass in a valid item to get text for")}catch(PERR){g.reportError(PERR)}return window.EmbedAttachChar+"p:"+this.id+",id:"+item.id+window.EmbedAttachChar},_requestAttachment:function _requestAttachmentFn(key,requestedState){try{g.PAssert(4248,key,"Must provide a valid key")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&this.__Stats.createdAttachments++;var newAttach=new VMAttachment(this,key,requestedState);return newAttach},releaseAttachment:function releaseAttachmentFn(attach){},registerPreviewCache:function registerPreviewCacheFn(){var remoteCache=gdata.ensureCache(this._previewCache);gdata.requestNotifyWhenAvailable(this.serviceRemoteRequestsFromPreview.bind(this)),remoteCache||gdata.requestNotifyWhenAvailable(this.writeActiveAttachmentsToPreviewCache.bind(this))},isPreviewCacheAvailable:function isPreviewCacheAvailableFn(){return DETAILED_STATS&&this.__Stats.previewCacheIsAvailable++,gdata.isCacheAvailable(this._previewCache)},updatePreviewCache:function updatePreviewCacheFn(key,value){try{g.PAssert(4249,g.isString(key),"Key must be a valid string")}catch(PERR){g.reportError(PERR)}return DETAILED_STATS&&this.__Stats.previewCacheUpdate++,gdata.updateCache(this._previewCache,key,value)},queryPreviewCache:function queryPreviewCacheFn(key){try{g.PAssert(4250,g.isString(key),"Key must be a valid string")}catch(PERR){g.reportError(PERR)}return DETAILED_STATS&&this.__Stats.previewCacheQuery++,gdata.queryCache(this._previewCache,key)},onPreviewCacheChange:function onPreviewCacheChangeFn(type,id,data){switch(type){case DataChangeType.Add:break;case DataChangeType.Remove:break;case DataChangeType.Change:break;default:try{g.PAssert(4251,!1,"Invalid or unhandled DataChangeType: ",type)}catch(PERR){g.reportError(PERR)}}log("Preview Cache Change: ",arguments)},writeActiveAttachmentsToPreviewCache:function writeActiveAttachmentsToPreviewCacheFn(){gdata.ensureCache(this._previewCache);for(var i=0;i<this._activeAttachments.length;++i){var attach=this._activeAttachments[i];attach.isLoaded()&&!attach.isLocalOnlyAttachment()&&this.writeAttachmentToPreviewCache(attach)}},writeAttachmentToPreviewCache:function writeAttachmentToPreviewCacheFn(attach){try{g.PAssert(4252,attach.isLoaded(),"Attachments should have data before saving them")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4253,!attach.isLocalOnlyAttachment(),"Should never write a local-only attachment to the preview cache")}catch(PERR){g.reportError(PERR)}for(var previewProps=this.getPropertySet(PluginLoad.Preview),oldData=this.queryPreviewCache(attach.id),newData,unmatchedFields,doPreviewUpdate=!oldData,i=0;!doPreviewUpdate&&i<previewProps.length;++i){var field=previewProps[i];attach.fieldNeedsWrite(field,oldData[field])&&(doPreviewUpdate=!0)}doPreviewUpdate&&this.updatePreviewCache(attach.id,this.serializePreview(attach))},dataHasChanged:function dataHasChangedFn(oldData,newData){for(var hasChanged=!oldData,props=this.getPropertySet(PluginLoad.Full),i=0;!hasChanged&&i<props.length;++i){var field=props[i];this.dataFieldNeedsWrite(oldData,field,newData[field])&&(hasChanged=!0)}return hasChanged},getChangedFields:function getChangedFieldsFn(oldData,newData){for(var fields=[],props=this.getPropertySet(PluginLoad.Full),i=0;i<props.length;++i){var field=props[i];this.dataFieldNeedsWrite(oldData,field,newData[field])&&fields.push(field)}return fields},serviceRemoteRequestsFromPreview:function serviceRemoteRequestsFromPreviewFn(){for(var i=0;i<this._pendingRequests.length;++i){var requestData=this._pendingRequests[i];if(!g.isFunction(requestData)&&requestData.attach)for(var j=0;j<requestData.attach.length;++j){var previewData=this.queryPreviewCache(requestData.attach[j].id);previewData&&this._addPreviewEntry(requestData.attach[j].id,previewData)}}for(var i=0;i<this._activeAttachments.length;++i){var attach=this._activeAttachments[i];if(!attach.isLoaded()&&!attach.isLocalOnlyAttachment()){var previewData=this.queryPreviewCache(attach.id);previewData&&this._addPreviewEntry(attach.id,previewData)}}},usesPreviewCache:function usesPreviewCacheFn(){return!1},matchAttachment:function matchAttachmentFn(attach,text){try{g.PAssert(4254,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},getStyledText:function getStyledTextFn(attach){try{g.PAssert(4255,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},getUnstyledText:function getUnstyledTextFn(attach){try{g.PAssert(4256,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},getBlockedText:function getBlockedTextFn(attach){return"Blocked"},useRenderer:function useRendererFn(type,id){var renderer=g.vmMain.pluginManager.useRenderer(type,id),fnName;switch(type){case PluginRenderTypes.StyledText:fnName="getStyledText";break;case PluginRenderTypes.UnstyledText:fnName="getUnstyledText";break;case PluginRenderTypes.AutocompleteText:fnName="getItemStyledText";break;case PluginRenderTypes.AgendaEntry:fnName="getAgendaStyledText";break;case PluginRenderTypes.Measure:fnName="getAttachMeasure";break;default:try{g.PAssert(4257,!1,"Unknown plugin renderer type")}catch(PERR){g.reportError(PERR)}}fnName&&(this[fnName]=renderer)},_getDisplayText:function _getDisplayTextFn(attach,pane,maxWidth){var text;return text=this.isPluginBlocked()?this.getBlockedText(attach,pane,maxWidth):this.getStyledText(attach,pane,maxWidth)},createDisplayElement:function createDisplayElementFn(attach){var classes=this.getAttachmentClass(attach);try{g.PAssert(4258,g.isArray(classes),"Must have a valid class list")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4259,classes.indexOf("plugin")<0,"Should not already have plugin as a class")}catch(PERR){g.reportError(PERR)}classes.push("plugin"),this.isPluginBlocked()&&classes.push("blocked");var content=this._getDisplayText(attach),outObj={attrs:{cls:classes,plugin:this.id,"plugin-id":attach.id},text:content},tooltip=this.getAttachmentTooltip(attach);return tooltip&&(outObj.attrs["data-tooltip"]=tooltip),outObj},measureAttachment:function measureAttachmentFn(pane,wordStyles){try{g.PAssert(4260,wordStyles&&wordStyles.attrs&&wordStyles.attrs["plugin-id"],"Must have a valid word style obj with attachment ID")}catch(PERR){g.reportError(PERR)}var width;if(wordStyles.attrs&&!wordStyles.attrs.isUnknown){var attach=this.getAttachment(wordStyles.attrs["plugin-id"]);try{g.PAssert(4261,attach,"Must have valid attachment to measure: ",wordStyles.attrs["plugin-id"])}catch(PERR){g.reportError(PERR)}width=this.isPluginBlocked()?Measure.measureWord(pane,this.getBlockedText(attach),wordStyles):this.getAttachMeasure(attach,pane,wordStyles)}else width=Measure.measureWord(pane,"Unknown Plugin",wordStyles);if(wordStyles.attrs&&wordStyles.attrs.cls){var cls=wordStyles.attrs.cls;width+=this.pluginMargin,cls.indexOf("padB")>=0&&(width+=this.pluginMargin)}return width+=this.pluginPadding},getAttachmentClass:function getAttachmentClassFn(attach){return""},getAttachmentTooltip:function getAttachmentTooltipFn(attach){return void 0},isPluginBlocked:function isPluginBlockedFn(){var isBlocked=!1;return g.billingManager.hasPremiumFeatures()||!this.hasDependency(PluginDependency.PremiumSub)&&!this.hasDependency(PluginDependency.EarlyAccess)||(isBlocked=!0),isBlocked},_displayMissingProperties:function _displayMissingPropertiesFn(attach,data,loadType){try{g.PAssert(4262,!1,"This function is DEBUG only")}catch(PERR){g.reportError(PERR)}var isMissingProps=!1,props=this.getPropertySet(loadType);log("Displaying Missing Properties: ",attach.id);for(var i=0;i<props.length;++i){var desc=this.getPropertyDescriptor(props[i]);desc.isOpt||data.hasOwnProperty(props[i])||(console.log(" Missing Property: ",props[i]),isMissingProps=!0)}try{g.PAssert(4263,isMissingProps,"Must be missing props to run this")}catch(PERR){g.reportError(PERR)}},_getPluginLoadType:function _getPluginLoadTypeFn(data){try{g.PAssert(4264,data,"Must be querying loaded data for load state with valid data")}catch(PERR){g.reportError(PERR)}var loadState=PluginLoad.None;return this._isPreviewData(data)&&(loadState|=PluginLoad.Preview,this._isFullData(data)&&(loadState|=PluginLoad.Full)),loadState},requestData:function requestDataFn(attach,requestedState){DETAILED_STATS&&this.__Stats.requestData++,requestedState=requestedState||PluginLoad.Preview|PluginLoad.Full;var cacheData=this.getCacheData(attach.id),loadState;if(cacheData)loadState=this._getPluginLoadType(cacheData),g.isFlagSet(loadState,requestedState)?attach.notifyDataLoaded(loadState,!1):!attach.isLocalOnlyAttachment()&&this.allowRemoteRequests()&&this.getRemoteAttachmentData(attach,requestedState);else if(!attach.isLocalOnlyAttachment()){if(loadState=PluginLoad.None,this.isPreviewCacheAvailable()){var previewData=this.queryPreviewCache(attach.id);previewData&&(previewData=this.createEntryFromLocal(attach.id,previewData),this.cacheData(attach.id,previewData),loadState=this._getPluginLoadType(previewData),g.isFlagSet(loadState,requestedState)&&attach.notifyDataLoaded(loadState,!1))}this.allowRemoteRequests()&&!g.isFlagSet(loadState,requestedState)&&this.getRemoteAttachmentData(attach,requestedState)}},_appendDupeRequest:function _appendDupeRequestFn(queuedRequest,dupeRequest){try{g.PAssert(4265,queuedRequest,"Must provide a valid queued request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4266,dupeRequest,"Must provide a valid duped request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4267,!queuedRequest.duped,"Must never use an already duped request as a dupe for another request")}catch(PERR){g.reportError(PERR)}dupeRequest.attach&&(queuedRequest.attach||(queuedRequest.attach=[]),queuedRequest.attach.pushOnlyUniques(dupeRequest.attach)),queuedRequest.successCB.pushOnlyUniques(dupeRequest.successCB),queuedRequest.failureCB.pushOnlyUniques(dupeRequest.failureCB)},_areRequestFnsEqual:function _areRequestFnsEqualFn(fnA,fnB){return g.unpackFn(fnA)===g.unpackFn(fnB)},_areRequestsEqual:function _areRequestsEqualFn(reqA,reqB){try{g.PAssert(4268,reqA,"Must have a valid request A")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4269,reqB,"Must have a valid request B")}catch(PERR){g.reportError(PERR)}var areEqual=!0;if(g.isFunction(reqA)||g.isFunction(reqB)||reqA.accountID!==reqB.accountID)areEqual=!1;else if(reqA.id!==reqB.id&&this._areRequestFnsEqual(reqA.requestFn,reqB.requestFn))if(reqA.data===reqB.data)areEqual=!0;else{for(var aProp in reqA.data){if(!reqA.data.hasOwnProperty(aProp)||!reqB.data.hasOwnProperty(aProp)){areEqual=!1;break}if(reqA.data[aProp]!==reqB.data[aProp]){areEqual=!1;break}}if(areEqual)for(var bProp in reqB.data){if(!reqA.data.hasOwnProperty(bProp)||!reqB.data.hasOwnProperty(bProp)){areEqual=!1;break}if(reqA.data[bProp]!==reqB.data[bProp]){areEqual=!1;break}}}else areEqual=!1;return areEqual},_getDupeRequest:function _getDupeRequestFn(request){for(var dupeRequest,i=0;!dupeRequest&&i<this._outstandingRequests.length;++i)!this._outstandingRequests[i].duped&&this._areRequestsEqual(this._outstandingRequests[i],request)&&(dupeRequest=this._outstandingRequests[i]);for(var i=0;!dupeRequest&&i<this._pendingRequests.length;++i)!this._pendingRequests[i].duped&&this._areRequestsEqual(this._pendingRequests[i],request)&&(dupeRequest=this._pendingRequests[i]);return dupeRequest},_combineRequest:function _combineRequestFn(queuedRequest,combineRequest){try{g.PAssert(4270,queuedRequest,"Must provide a valid queued request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4271,combineRequest,"Must provide a valid combine request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4272,!queuedRequest.combined,"Must never use an already combined request as a target for another request")}catch(PERR){g.reportError(PERR)}queuedRequest.data=g.mergeObjects(queuedRequest.data,combineRequest.data),queuedRequest.successCB.pushOnlyUniques(combineRequest.successCB),queuedRequest.failureCB.pushOnlyUniques(combineRequest.failureCB)},_areRequestsCombinable:function _areRequestsCombinableFn(reqA,reqB){try{g.PAssert(4273,reqA,"Must have a valid request A")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4274,reqB,"Must have a valid request B")}catch(PERR){g.reportError(PERR)}var areCombinable=!1;return reqA.id!==reqB.id&&reqA.combinable&&reqB.combinable&&reqA.accountID===reqB.accountID&&this._areRequestFnsEqual(reqA.requestFn,reqB.requestFn)&&reqA.type===reqB.type&&(reqA.attach||reqB.attach?reqA.attach&&reqB.attach&&reqA.attach.equals(reqB.attach)&&(areCombinable=!0):areCombinable=!0),areCombinable},_getCombineRequest:function _getCombineRequestFn(request){var combineRequest;if(request.combinable)for(var i=0;!combineRequest&&i<this._pendingRequests.length;++i)!this._pendingRequests[i].combined&&this._areRequestsCombinable(this._pendingRequests[i],request)&&(combineRequest=this._pendingRequests[i]);return combineRequest},_handleBatchRequestResponse:function _handleBatchRequestResponseFn(success){this._numOutstandingReqs--;try{g.PAssert(4275,this._numOutstandingReqs>=0,"Outstanding requests cannot be negative")}catch(PERR){g.reportError(PERR)}},_handleRequestResponse:function _handleRequestResponseFn(attach,wasBatched){if(!wasBatched){this._numOutstandingReqs--;try{g.PAssert(4276,this._numOutstandingReqs>=0,"Outstanding requests cannot be negative")}catch(PERR){g.reportError(PERR)}}},_handleRequestTimeout:function _handleRequestTimeoutFn(request){var isPending=this._pendingRequests.indexOf(request)>=0;if(isPending){request.timedOut=!0;for(var result={error:{code:C.HTTPStatusCode.Network,message:"Internal request timeout"}},i=0;i<request.failureCB.length;++i)try{request.failureCB[i](result)}catch(err){g.reportError(err)}this._pendingRequests.remove(request)}},_queueRemoteRequestMulti:function _queueRemoteRequestMultiFn(accountID,requestFn,data,successCB,failureCB,attach,type,options){try{g.PAssert(4277,accountID,"Missing accountID parameter")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4278,!g.isArray(accountID),"Missing accountID paramter")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4279,!g.isFunction(accountID),"Missing accountID parameter")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4280,!options||void 0===options.accountID,"AccountID is specified as a separate param")}catch(PERR){g.reportError(PERR)}var opts=options?g.clone(options):{};return opts.accountID=accountID,this._queueRemoteRequest(requestFn,data,successCB,failureCB,attach,type,opts)},_computeTimeoutMS:function _computeTimeoutMSFn(options){var timeoutMS=void 0;return options&&options.timeoutMS>-1?options.timeoutMS:void 0,options&&void 0!==options.timeoutMS&&(0===options.timeoutMS?timeoutMS=DefaultRequestTimeout:options.timeoutMS>=1e3&&(timeoutMS=options.timeoutMS)),timeoutMS},_updateRequestTimeout:function _updateRequestTimeoutFn(reqObj){reqObj.timeoutMS&&(this._clearRequestTimeout(reqObj),reqObj.timeout=setTimeout(this._handleRequestTimeout.bind(this,reqObj),reqObj.timeoutMS))},_clearRequestTimeout:function _clearRequestTimeoutFn(reqObj){reqObj.timeout&&(clearTimeout(reqObj.timeout),reqObj.timeout=void 0)},_queueRemoteRequest:function _queueRemoteRequestFn(requestFn,data,successCB,failureCB,attach,type,options){try{g.PAssert(4281,g.isFunction(requestFn)||g.isArray(requestFn),"RequestFn must be a valid function or packed function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4282,data,"Must provide valid data for the request")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4284,successCB,"Must supply a callback for request success")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4285,g.isFunction(successCB),"Success callback must be a valid function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4286,failureCB,"Must supply a callback for request failure")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4287,g.isFunction(failureCB),"Failure callback must be a valid function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4288,type,"Request type must be specified")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4289,!options||!options.combinable,"Combinable is not currently a valid option. Do not use.")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4290,!attach||!attach.isLocalOnlyAttachment(),"Must either specify a valid remote attachment or none at all",attach?attach.id:"UNDEFINED")}catch(PERR){g.reportError(PERR)}DETAILED_STATS&&(this.__ReqStats[type]=this.__ReqStats[type]?this.__ReqStats[type]+1:1);var reqObj={id:++this._requestCounter,plugin:this,attach:attach?[attach]:void 0,request:void 0,requestFn:requestFn,data:data,successCB:[successCB],failureCB:[failureCB],type:type,handled:!1,failed:!1,duped:!1,canceled:!1,timedOut:!1,wasBatched:!1,accountID:options&&options.accountID?options.accountID:"me",combinable:options&&options.combinable,autoRetry:!options||void 0===options.autoRetry||options.autoRetry,timeoutMS:this._computeTimeoutMS(options)};reqObj.autoRetry&&(reqObj.numRetries=options&&options.numRetries?options.numRetries:2,reqObj.currentRetries=0),this._updateRequestTimeout(reqObj),this._pendingRequests.push(reqObj),g.vmMain.pluginManager.notifyHasPendingRemoteRequest()},_queuePagedRemoteRequestMulti:function _queuePagedRemoteRequestMultiFn(accountID,requestFn,requestData,successCB,failureCB,attach,type,options){try{g.PAssert(4291,accountID,"Missing accountID parameter")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4292,!g.isArray(accountID),"Missing accountID paramter")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4293,!g.isFunction(accountID),"Missing accountID parameter")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4294,!options||void 0===options.accountID,"AccountID is specified as a separate param")}catch(PERR){g.reportError(PERR)}var opts=options?g.clone(options):{};return opts.accountID=accountID,this._queuePagedRemoteRequest(requestFn,requestData,successCB,failureCB,attach,type,opts)},_queuePagedRemoteRequest:function _queuePagedRemoteRequestFn(requestFn,requestData,successCB,failureCB,attach,type,options){try{g.PAssert(4295,options,"Must supply a valid options param")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4296,!options.getAllPages||!options.maxPages,"Should only define either maxPages or getAllPages: ",options.getAllPages,options.maxPages)}catch(PERR){g.reportError(PERR)}options.maxPages=options.maxPages||1,options.getAllPages=options.getAllPages||!1,options.maxPageResults=options.maxPageResults||100,options.maxResults=options.maxResults||1/0,options.resultsField=options.resultsField||"items";var pagesRequested=0,outResults=[],_requestData=g.clone(requestData);_requestData.maxResults=options.maxPageResults;var _successCB=function(result){result[options.resultsField]?outResults.pushArray(result[options.resultsField]):result.items?outResults.pushArray(result.items):result.history&&outResults.pushArray(result.history),result.nextPageToken&&(options.getAllPages||options.maxPages>pagesRequested)&&outResults.length<options.maxResults?retrievePage(result.nextPageToken):result.nextPageToken||result.nextSyncToken||result.historyId?successCB(outResults,requestData,result):successCB(outResults)},_failureCB=function(response){failureCB(response,outResults)},retrievePage=function(token){token&&(_requestData.pageToken=token),pagesRequested++,this._queueRemoteRequest(requestFn,_requestData,_successCB,_failureCB,void 0,type,options)}.bind(this);retrievePage()},_retryRemoteRequest:function _retryRemoteRequestFn(requestData){DETAILED_STATS&&this.__Stats.remoteRetries++,requestData.request=void 0,requestData.wasBatched=void 0,setTimeout(function(){requestData.currentRetries=requestData.currentRetries?requestData.currentRetries+1:1,this._pendingRequests.push(requestData),g.vmMain.pluginManager.notifyHasPendingRemoteRequest()}.bind(this),this._getRetryDelay(requestData))},_queueDeferredRemoteRequest:function _queueDeferredRemoteRequestFn(fn){this._numDeferredReqs++,this._pendingRequests.push(fn)},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach,requestedState){try{g.PAssert(4297,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},_pumpRequestQueue:function _pumpRequestQueueFn(maxAllowed,cb,cbBatch){try{g.PAssert(4298,this.areRemoteAPIsLoaded(),"Must have loaded remote APIs before pumping the request queue")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4299,!this.hasDependency(PluginDependency.GoogleLogin)||this.hasDependencyBeenLoaded(PluginDependency.GoogleLogin),"Must be authorized to make remote requests")}catch(PERR){g.reportError(PERR)}var numRequested=0,numCanceled=0,numDuped=0,numCombined=0,numSkipped=0,batchCount=0,availReqs=maxAllowed-this._numOutstandingReqs;try{g.PAssert(4300,availReqs>=0,"Should never have more than max outstanding requests for a given plugin")}catch(PERR){g.reportError(PERR)}var batch;availReqs>1&&this._pendingRequests.length>1&&(batch=this.createBatch());for(var handledRequests=[],i=0;availReqs>0&&i<this._pendingRequests.length&&batchCount<C.MaxBatchSize;++i){var requestData=this._pendingRequests[i];if(g.isFunction(requestData))requestData(),this._numDeferredReqs--,handledRequests.push(requestData);else{try{g.PAssert(4301,requestData.handled===!1,"Should never service a request that has already been handled")}catch(PERR){g.reportError(PERR)}var dupeCandidate=this._getDupeRequest(requestData);if(dupeCandidate)DETAILED_STATS&&this.__Stats.dupedRequests++,requestData.duped=!0,handledRequests.push(requestData),numDuped++,this._appendDupeRequest(dupeCandidate,requestData);else{var combineCandidate=this._getCombineRequest(requestData);if(combineCandidate)DETAILED_STATS&&this.__Stats.combinedRequests++,requestData.combined=!0,handledRequests.push(requestData),numCombined++,this._combineRequest(combineCandidate,requestData);else{var doPerformRequest=!1;if(requestData.attach)for(var j=0;j<requestData.attach.length;++j)requestData.attach[j].needsRemoteData()&&(requestData.attach[j].notifyDataRequested(),doPerformRequest=!0);else doPerformRequest=!0;if(doPerformRequest)if(this.isCurrentlyAuthorized(requestData.accountID)){var batchInfo=this._runRemoteRequest(batch,requestData,cb);DETAILED_STATS&&this.__Stats.remoteRequests++,(batchInfo.isNewRequest||0===batchCount)&&(numRequested++,availReqs--,this._numOutstandingReqs++,DETAILED_STATS&&this.__Stats.actualRemoteCallsSent++),batchInfo.wasBatched&&batchCount++,handledRequests.push(requestData)}else AccountManager.notifyUnauthorizedRequest(requestData.accountID),numSkipped++;else DETAILED_STATS&&this.__Stats.canceledRequests++,requestData.canceled=!0,numCanceled++,handledRequests.push(requestData)}}}}this._pendingRequests=this._pendingRequests.removeArray(handledRequests);for(var i=0;i<handledRequests.length;++i)g.isFunction(handledRequests[i])||handledRequests[i].canceled||handledRequests[i].duped||this._addRequest(this._outstandingRequests,handledRequests[i]);try{g.PAssert(4302,!batch||batchCount+numCanceled+numDuped+numCombined+numSkipped>1,"Batches should always have multiple items in them")}catch(PERR){g.reportError(PERR)}return batch&&(batchCount>0?(DETAILED_STATS&&this.__Stats.remoteBatches++,this.commitBatch(batch,cbBatch)):DETAILED_STATS&&this.__Stats.canceledBatches++),numRequested},_clearRequestQueue:function _clearRequestQueueFn(){log("Clear Request Queue: ",this.id),this._pendingRequests=[],this._outstandingRequests=[],this._numDeferredReqs=0,this._numOutstandingReqs=0},_addRequest:function _addRequestFn(queue,req){try{g.PAssert(4303,queue.indexOf(req)<0,"Should never re-add a request to a queue without removing it first")}catch(PERR){g.reportError(PERR)}return queue.push(req)},_removeRequest:function _removeRequestFn(queue,req){return queue.remove(req)},isRateLimited:function isRateLimitedFn(){return this._isRateLimited},_notifyRateLimitedOver:function _notifyRateLimitedOverFn(){this._isRateLimited=!1},_notifyRateLimited:function _notifyRateLimitedFn(resp){this._isRateLimited=!0,this._lastRateLimitTime=new Date},_getRetryDelay:function _getRetryDelayFn(req){return 1e3*retryTimeouts[req.currentRetries]},computeBatchGroupID:function computeBatchGroupIDFn(req){return req.accountID},_runRemoteRequest:function _runRemoteRequestFn(batch,requestData,cb){var retInfo={wasBatched:!1,isNewRequest:!1},unpackedFn=g.unpackFn(requestData.requestFn);try{g.PAssert(4304,g.isFunction(unpackedFn,"Must specify a valid packed function: ",requestData.requestFn))}catch(PERR){g.reportError(PERR)}if(g.isFunction(unpackedFn)){requestData.request=apis.canConstruct(requestData.requestFn)?apis.createRequest(requestData.accountID,requestData.requestFn,requestData.data):unpackedFn(requestData.data);try{g.PAssert(4305,requestData.request,"Must be able to provide a valid request object to be sent remotely")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4306,requestData.request.then,"Remote request must be thenable")}catch(PERR){g.reportError(PERR)}if(batch){var batchID=this.computeBatchGroupID(requestData);retInfo.isNewRequest=batch.add(requestData.request,batchID);try{g.PAssert(4307,g.isBoolean(retInfo.isNewRequest),"Add must return whether it will create a new remote request for this request")}catch(PERR){g.reportError(PERR)}retInfo.wasBatched=!0,requestData.wasBatched=!0}else requestData.wasBatched=!1;try{g.PAssert(4308,this.isCurrentlyAuthorized(requestData.accountID),"Must be currently authorized to make this request")}catch(PERR){g.reportError(PERR)}this._clearRequestTimeout(requestData),requestData.request.then(function(response){try{g.PAssert(4309,requestData.handled===!1,"Must not handle the same request multiple times")}catch(PERR){g.reportError(PERR)}requestData.handled=!0,this._notifyRateLimitedOver();for(var i=0;i<requestData.successCB.length;++i)try{requestData.successCB[i](response.result)}catch(err){g.reportError(err)}this._notifyRateLimitedOver(),cb(requestData.attach,requestData.plugin,requestData.wasBatched),this._removeRequest(this._outstandingRequests,requestData)},function(response){try{g.PAssert(4310,requestData.handled===!1,"Must not handle the same request multiple times")}catch(PERR){g.reportError(PERR)}rateLimitErrorCodes.indexOf(response.status)>=0&&this._notifyRateLimited(response);var hasRetryErrorCode=retryErrorCodes.indexOf(response.status)>=0;if(hasRetryErrorCode&&requestData.autoRetry&&requestData.currentRetries<requestData.numRetries)cb(requestData.attach,requestData.plugin,requestData.wasBatched),this._removeRequest(this._outstandingRequests,requestData),this._retryRemoteRequest(requestData);else{if(requestData.handled=!0,requestData.failed=!0,requestData.attach)for(var i=0;i<requestData.attach.length;++i)requestData.attach[i].notifyDataRequestFailed();for(var i=0;i<requestData.failureCB.length;++i)try{requestData.failureCB[i](response.result)}catch(err){g.reportError(err)}cb(requestData.attach,requestData.plugin,requestData.wasBatched),this._removeRequest(this._outstandingRequests,requestData)}},this)}return retInfo},createPaginationToken:function createPaginationTokenFn(nextPageToken,q,info,maxResults,entryCB,doneCB){return new PageToken(nextPageToken,q,info,maxResults,entryCB,doneCB)},updatePaginationToken:function updatePaginationTokenFn(oldToken,nextPageToken){try{g.PAssert(4311,oldToken,"Must specify a valid token to update")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4312,nextPageToken,"Must update the pagination token with a valid next page token")}catch(PERR){g.reportError(PERR)}return oldToken.updateToken(nextPageToken),oldToken},createBatch:function createBatchFn(params){return apis.createBatch(params)},commitBatch:function commitBatchFn(batch,cb){try{g.PAssert(4313,batch,"Batch to commit must be specified")}catch(PERR){g.reportError(PERR)}batch.then(function(response){cb(this,!0)}.bind(this),function(){cb(this,!1)}.bind(this))},compactCacheField:function compactCacheFieldFn(entry,key){return entry[key]},_serializeObj:function _serializeObjFn(entry,props){try{g.PAssert(4314,entry,"Must specify a valid entry to serialize")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4315,props,"Must provide a valid property list")}catch(PERR){g.reportError(PERR)}for(var outObj={},i=0;i<props.length;++i){var prop=props[i],desc=this.getPropertyDescriptor(prop);if(!desc.isOpt||desc.defaultValue!==entry[prop]){var writeValue=this.compactCacheField(entry,prop);void 0!==writeValue&&(outObj[prop]=writeValue)}}var blobData=this.getBlobData(entry);return blobData&&(outObj._blob=blobData),outObj},serializeEntry:function serializeEntryFn(id){var props=this.getPropertySet(PluginLoad.Full),entry=this.getCacheData(id);return entry?this._serializeObj(entry,props):void 0},serializeExternalData:function serializeExternalDataFn(data){try{g.PAssert(4316,data,"Must supply valid data to serialize")}catch(PERR){g.reportError(PERR)}var props=this.getPropertySet(PluginLoad.Full),outData=this._serializeObj(data,props);return outData.id=data.id,data.parents&&(outData.parents=data.parents),outData},serializePreview:function serializePreviewFn(attach){var props=this.getPropertySet(PluginLoad.Preview),entry=this.getCacheData(attach.id);return entry?this._serializeObj(entry,props):void 0},registerAutocomplete:function registerAutocompleteFn(){if(g.autocomplete&&!this._registeredAutocomplete){var prefixes=this.getAutocompletePrefixes();if(prefixes){g.autocomplete.registerProvider(this._acProviderId,this);for(var i=0;i<prefixes.length;++i)g.autocomplete.registerPrefix(this._acProviderId,prefixes[i])}this._registeredAutocomplete=!0}},unregisterAutocomplete:function unregisterAutocompleteFn(){g.autocomplete&&this._registeredAutocomplete},declareProperty:function declarePropertyFn(name,requiredFor,isOpt,defaultValue,comparator){try{g.PAssert(4317,!this._propertyDescriptors[name],"Should not declare the same property twice")}catch(PERR){g.reportError(PERR)}requiredFor=requiredFor||PluginLoad.Preview|PluginLoad.Full,isOpt=isOpt||!1,g.forEachFlagSet(requiredFor,function(flag){this._propertySets[flag]||(this._propertySets[flag]=[]),this._propertySets[flag].push(name)}.bind(this)),this._propertyDescriptors[name]={isOpt:isOpt,defaultValue:defaultValue,comparator:comparator}},getPropertySet:function getPropertySetFn(name){return this._propertySets[name]||[]},getPropertyDescriptor:function getPropertyDescriptorFn(name){return this._propertyDescriptors[name]},getBlobData:function getBlobDataFn(entry){return void 0},_updateAttachmentStates:function _updateAttachmentStatesFn(){try{g.vmMain.beginUpdateItems();for(var i=0;i<this._attachKeys.length;++i){var attach=this._attachCache[this._attachKeys[i]];attach.onUpdate(!1)}g.vmMain.commitUpdateItems()}catch(err){g.reportError(err)
}},offlineLoad:function offlineLoadFn(){if(!this._hasRunOfflineLoad&&this.supportOfflineLoad()){this._hasRunOfflineLoad=!0;try{this._offlineLoad&&this._offlineLoad()}catch(err){g.reportError(err)}}},load:function loadFn(){if(this._isFirstLoad){this._isFirstLoad=!1;try{this._load&&this._load()}catch(err){g.reportError(err)}}this._loadedInitialData||!g.isDemoMode()&&!this.hasActiveDataPanes()||this.isPluginBlocked()||this.loadInitialData()},loadInitialData:function loadInitialDataFn(){try{g.PAssert(4318,!this._loadedInitialData,"Do not make multiple requests for initial data load")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4319,!this.isPluginBlocked(),"Should not load data for blocked plugins")}catch(PERR){g.reportError(PERR)}this._loadedInitialData=!0},finishedLoading:function finishedLoadingFn(){g.fireCustomEvent(this.loadedEvent)},getDataPane:function getDataPaneFn(){return void 0},getPaneIcon:function getPaneIconFn(){return"icon-question"},getDefaultDisplayItem:function getDefaultDisplayItemFn(){return void 0},useItemStore:function useItemStoreFn(){return void 0},itemStoreOptions:function itemStoreOptionsFn(){return void 0},getDefaultItemStore:function getDefaultItemStoreFn(){try{g.PAssert(4320,this.useItemStore(),"Must request an item store")}catch(PERR){g.reportError(PERR)}return this._defaultItemStore},getActiveItemStore:function getActiveItemStoreFn(paneID){try{g.PAssert(4321,paneID,"Must specify a valid paneID to get the item store for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4322,this.useItemStore(),"Must request item store usage")}catch(PERR){g.reportError(PERR)}var activeStore=this._activeItemStore[paneID];return activeStore?activeStore:this._defaultItemStore},getBucketItemStore:function getBucketItemStoreFn(bucketID){return this._searchBuckets[bucketID]},allowRemoteRequests:function allowRemoteRequestsFn(){return!1},handleDropEvent:function handleDropEventFn(e,cb){return!1},handleTapClick:function handleTapClickFn(vmli,id,e){return!1},handleDoubleTap:function handleDoubleTapFn(vmli,id,e){return!1},handleRightClick:function handleRightClickFn(id){return void 0},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return void 0},notifyPaneCreated:function notifyPaneCreatedFn(){this._numActivePanes++,!this.isActive()||this._loadedInitialData||this.isPluginBlocked()||(this.areDependenciesLoaded()?this.loadInitialData():this.loadRemoteAPIs())},notifyPaneDestroyed:function notifyPaneDestroyedFn(){this._numActivePanes--;try{g.PAssert(4325,this._numActivePanes>=0,"Should never have negative active panes")}catch(PERR){g.reportError(PERR)}},notifyPanesReadyForLoad:function notifyPanesReadyForLoadFn(){g.vmMain.paneManager.runForEachPane(function(pane){pane.notifyPluginLoaded()},this.getPaneType())},hasActiveDataPanes:function hasActiveDataPanesFn(){return this._numActivePanes>0},allowTextEditing:function allowTextEditingFn(item,attach){return!0},_createSearchBucket:function _createSearchBucketFn(search){var searchBucketID;searchBucketID=g.generateTempId();var bucket=g.vmMain.itemStoreManager.registerItemStore(searchBucketID,this,{trackGlobally:!1});return bucket.createRoot(g.generateTempId(),"Search Results"),this._searchBuckets[searchBucketID]=bucket,searchBucketID},_destroySearchBucket:function _destroySearchBucketFn(bucketID){var bucket=this._searchBuckets[bucketID];bucket.clearStore()},swapInSearchBucket:function swapInSearchBucketFn(bucketID,paneID){try{g.PAssert(4326,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}var pane=g.vmMain.paneManager.getPaneById(paneID),bucket=this._searchBuckets[bucketID];if(!this._activeSearchBucket[paneID]||this._activeSearchBucket[paneID].id!==bucketID){var root=bucket.getRoot();this._activeSearchBucket[paneID]||(this._defaultZoomItems[paneID]=pane.getItem()),this._activeItemStore[paneID]=bucket,this._activeSearchBucket[paneID]=bucket,pane.setRootItem(root,!0),pane.useItemStore(bucket)}},swapOutSearchBucket:function swapOutSearchBucketFn(paneID,zoomItem){try{g.PAssert(4327,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}var bucketID=this._activeSearchBucket[paneID].id,pane=g.vmMain.paneManager.getPaneById(paneID),oldBucket=this._searchBuckets[bucketID];try{g.PAssert(4328,oldBucket,"Must have a valid bucket we are swapping from")}catch(PERR){g.reportError(PERR)}var oldRoot=pane.getRootItem();try{g.PAssert(4329,oldRoot===oldBucket.getRoot(),"Current root for pane should match bucket root")}catch(PERR){g.reportError(PERR)}zoomItem=zoomItem||this._defaultZoomItems[paneID];try{g.PAssert(4330,zoomItem,"Must always be able to get a valid default zoom item")}catch(PERR){g.reportError(PERR)}this._activeItemStore[paneID]=void 0,this._activeSearchBucket[paneID]=void 0,this._defaultZoomItems[paneID]=void 0,pane.setItem(zoomItem,!0),pane.stopUsingItemStore(oldBucket),this._destroySearchBucket(bucketID)},runSearch:function runSearchFn(search,paneID,createBucket,cb){try{g.PAssert(4331,this.useItemStore(),"Must be marked as using an item store to support searches")}catch(PERR){g.reportError(PERR)}var bucketID;return createBucket&&(bucketID=this._createSearchBucket(search)),this.runRemoteSearch(search,paneID,bucketID,cb)},getSearchRoot:function getSearchRootFn(bucketID){var bucket=this._searchBuckets[bucketID];try{g.PAssert(4332,bucket,"Should always reference a valid search bucket")}catch(PERR){g.reportError(PERR)}return bucket.getRoot()},runRemoteSearch:function runRemoteSearchFn(search,paneID,cb){try{g.PAssert(4333,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},isRemoteSearchBucketActive:function isRemoteSearchBucketActiveFn(paneID){return!!this._activeSearchBucket[paneID]},clearSearch:function clearSearchFn(paneID,zoomItem){this._activeSearchBucket[paneID]&&this.swapOutSearchBucket(paneID,zoomItem)},refreshCurrentView:function refreshCurrentViewFn(paneID){try{g.PAssert(4334,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},dumpRequestQueue:function dumpRequestQueueFn(showHandled){console.log("---- Outstanding Requests ["+this._numOutstandingReqs+"] ----");for(var i=0;i<this._outstandingRequests.length;++i){var req=this._outstandingRequests[i];console.log("  ",req.requestFn,":",req.id," - ",req.data)}console.log("---- Pending Requests ["+this._pendingRequests.length+"] ----");for(var i=0;i<this._pendingRequests.length;++i){var req=this._pendingRequests[i];console.log("  ",req.requestFn,":",req.id," - ",req.data)}if(showHandled){console.log("---- Handled Requests ["+this._handledRequests.length+"] ----");for(var i=0;i<this._handledRequests.length;++i){var req=this._handledRequests[i];req.failed?console.log(" !",req.requestFn,":",req.id," - ",req.data):console.log("  ",req.requestFn,":",req.id," - ",req.data)}}},getCssClass:function getCssClassFn(attach){return""}},util.defineBase(VMPlugin),VMPlugin}),define("TokenHolder",["globals","util"],function(g,util){function TokenHolder(cb){this._cb=cb,this._pageToken=void 0,this._validToken=!1}var TokenHolderFns={hasPaginationToken:function hasPaginationTokenFn(){return this._validToken},needsPaginationToken:function needsPaginationTokenFn(){return!this.hasPaginationToken()&&!this._pageToken},setPaginationToken:function setPaginationTokenFn(token){this._pageToken=token,this._validToken=!0,this._cb&&this._cb(this)},beginDataPageLoad:function beginDataPageLoadFn(){return this._pageToken.notifyBeginUse(),this._pageToken},endDataPageLoad:function endDataPageLoadFn(hasMoreData){hasMoreData?this._pageToken.notifyEndUse():this._validToken=!1},notifyPaginationUpdate:function notifyPaginationUpdateFn(){log("Pagination Update")}};return util.defineBase(TokenHolder),util.extend(TokenHolder.prototype,TokenHolderFns),TokenHolder}),define("CachedSearch",["globals","util","TokenHolder"],function(g,util,TokenHolder){function CachedSearch(searchQuery,pageSize,remoteRequestCB){this._super.constructor.call(this),this._searchQuery=searchQuery,this._invalid=!1,this._hasError=!1,this._remoteRequestCB=remoteRequestCB,this._activePageRequest=void 0,this._lastPageRequest=void 0,this._cachedResults=[],this._localPageOffset=0,this._automaticPageRequests=0,this._pageSize=pageSize,util.forceBind("onEntry",this)}var MaxAutomaticRequests=5,CachedSearchFns={invalidate:function invalidateFn(){this._invalid=!0},isValid:function isValidFn(){return!this._invalid},hasError:function hasErrorFn(){return this._hasError},getNextPage:function getNextPageFn(entryCB,doneCB){try{g.PAssert(4335,g.isFunction(entryCB)&&g.isFunction(doneCB)||this._lastPageRequest,"Must provide valid callbacks")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4336,!this._invalid,"Should never request another page from an invalidated search")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4337,this.hasMoreResults(),"Should never request another page if there are no possible results")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4338,!this._activePageRequest,"Should only run a single request at a time")}catch(PERR){g.reportError(PERR)}if(entryCB||doneCB||!this._lastPageRequest||(entryCB=this._lastPageRequest.entryCB,doneCB=this._lastPageRequest.doneCB),this._activePageRequest)doneCB(!1);else if(this._cachedResults.length>this._localPageOffset+this._pageSize){for(var i=0;i<this._pageSize;++i){var entry=this._cachedResults[this._localPageOffset+i];try{entryCB(entry)}catch(err){g.reportError(err)}}this._localPageOffset+=this._pageSize,doneCB(!0)}else if(this.hasPaginationToken()&&this._automaticPageRequests<MaxAutomaticRequests)this._activePageRequest={entryCB:entryCB,doneCB:doneCB},this._automaticPageRequests++,this._remoteRequestCB(this);else if(this._localPageOffset<this._cachedResults.length){for(var i=this._localPageOffset;i<this._cachedResults.length;++i){var entry=this._cachedResults[i];try{entryCB(entry)}catch(err){g.reportError(err)}this._localPageOffset++}doneCB(!0)}},onEntry:function onEntryFn(entry){this._invalid||this._cachedResults.push(entry)},onDone:function onDoneFn(success){this._invalid||this._activePageRequest&&(this._lastPageRequest=this._activePageRequest,this._activePageRequest=void 0,success?this.getNextPage(this._lastPageRequest.entryCB,this._lastPageRequest.doneCB):(this._invalid=!0,this._hasError=!0,pageRequest.doneCB(success)))},hasResults:function hasResultsFn(){return this._cachedResults.length>0},hasMoreResults:function hasMoreResultsFn(){return this._cachedResults.length>this._localPageOffset||this.hasPaginationToken()}};return util.inherit(TokenHolder,CachedSearch),util.extend(CachedSearch.prototype,CachedSearchFns),CachedSearch}),define("plugins/Plugin_Drive_Pane",["ko","Constants","globals","util","data","VMPane"],function(ko,C,g,util,d,VMPane){function Plugin_Drive_Pane(p){this.plugin=g.vmMain.pluginManager.getPlugin(PluginID.Drive),this.type=this.plugin._paneType,this.paneClass="paneOutline panePlugin paneDrive noComplete",this.paneEmptyMessage="Loading Google Drive...",this.paneEmptySearchMessage="",this.dropEffect=function(){return C.DropEffect.Copy},this.isWriteable=!1,this.isDropTarget=!1,this.overrideCopyBehavior=!1,this.supportCollapsing=!0,this.supportCompleting=!1,this.supportOffline=!1,this.supportPerformArchive=!1,this.supportDataRefresh=!1,this.supportPagination=!0,this.supportSearchAutocomplete=!1,this.supportSearchListenTextChanges=!1,this.supportClickOverviewScroll=!1,this.supportClone=!1,this.supportDates=!1,this.searchFilters=[],this._super.constructor.call(this,p),this._isSearchingRemote=ko.observable(),this._currentSearch=void 0,this.initDrive()}var searchDelay=2500,researchDelay=5e3,Plugin_Drive_PaneFns={initDrive:function initDriveFn(){this.search.onChanged.listen(util.forceBind("notifySearchChanged",this)),this._searchTimeout=void 0,this._lastSearchValue=void 0,this._lastSearchTime=0},destroy:function destroyFn(){this.search.onChanged.unlisten(this.notifySearchChanged),clearTimeout(this._searchTimeout),this._searchTimeout=void 0,this._super.destroy.call(this)},_getNotReadyStatus:function _getNotReadyStatusFn(){var msg="Unknown Error: Unable to load pane data.",unloadedDeps=this.plugin.getUnloadedDependencies();return unloadedDeps&&(unloadedDeps.indexOf(PluginDependency.DriveAPI)>=0?msg="Pane data is only available while online.":unloadedDeps.indexOf(PluginDependency.PremiumSub)>=0?msg="Only available to premium subscribers.":unloadedDeps.indexOf(PluginDependency.GoogleLogin)>=0&&(msg="Missing permissions for Google Drive access.")),msg},getItemStore:function getItemStoreFn(){return this.plugin.getActiveItemStore(this.id)},getRootItem:function getRootItemFn(){var itemStore=this.getItemStore();return itemStore?itemStore.getRoot():void 0},bottomListMessage:function bottomListMessageFn(){var listMessage;return!this.isSearched()&&this.getItem().hasPaginationToken()&&(listMessage="LOAD MORE"),listMessage},searchACName:function searchACNameFn(){return void 0},getPaneIcon:function getPaneIconFn(){return this.plugin.getPaneIcon()},requestDemandLoadData:function requestDemandLoadDataFn(item){this.plugin.requestDemandLoadData(this.id,item)},requestDataPage:function requestDataPageFn(item){this.plugin.requestDataPage(item)},updateContents:function updateContentsFn(){this._super.updateContents.call(this)},onAfterLoaded:function onAfterLoadedFn(){this._super.onAfterLoaded.call(this)},onClose:function onCloseFn(){this._super.onClose.call(this)},_runRemoteSearch:function _runRemoteSearchFn(){if(g.vmMain.paneManager.isPaneActive(this.id)){clearTimeout(this._searchTimeout),this._searchTimeout=void 0;var search=this.search.getValue();this._lastSearchValue=search,this._lastSearchTime=Date.now(),this.isLoading.set(!0),this.paneTopText.set("Searching..."),this._isSearchingRemote(!0),this._currentSearch&&(this._currentSearch.invalidate(),this._currentSearch=void 0),this._currentSearch=this.plugin.runSearch(search,this.id,!1,function(status){switch(this.isLoading.set(!1),status){case SearchResultStatus.Done:this.paneTopText.set("");break;case SearchResultStatus.TooMany:this.paneTopText.set("Too many search results! Be more specific.");break;case SearchResultStatus.None:this.paneTopText.set("There were no search results");break;case SearchResultStatus.Error:this.paneTopText.set("There was an error running your search, try again.");break;default:try{g.PAssert(4339,!1,"Invalid search state: ",status)}catch(PERR){g.reportError(PERR)}}}.bind(this))}},notifySearchChanged:function notifySearchChangedFn(force){var search=this.search.getValue();if(search!==this._lastSearchValue||Date.now()-this._lastSearchTime>researchDelay)if(clearTimeout(this._searchTimeout),this._searchTimeout=void 0,search){var actualDelay=force?0:searchDelay;this._searchTimeout=setTimeout(this._runRemoteSearch.bind(this),actualDelay)}else this._isSearchingRemote(!1),this.plugin.clearSearch(this.id),this.isLoading.set(!1),this.paneTopText.set("")},refreshPaneData:function refreshPaneDataFn(){this.plugin.refreshCurrentView(this.id)},notifyDropFrom:function notifyDropFromFn(droppedItem,toPane){this.plugin.notifyDropFrom(droppedItem,toPane)},notifyDropFromToEdit:function notifyDropFromToEditFn(droppedItem,dropElement){return this.plugin.notifyDropFromToEdit(droppedItem,dropElement)},dropEffectCopyBehavior:function dropEffectCopyBehaviorFn(copyItem,targetItem){return this.plugin.isItemDroppable(copyItem)?this._super.dropEffectCopyBehavior.call(this,copyItem,targetItem):void g.toasts.pushMessage(MessageID.DisabledFolderDrop)},setupContextMenu:function setupContextMenuFn(item,e){return g.element("contextMenuItem_Drive")},isSearchingRemote:function isSearchingRemoteFn(){return this._isSearchingRemote()},_onRemoteDataLoaded:function _onRemoteDataLoadedFn(){},isItemHeader:function isItemHeaderFn(item,overview){if(overview){var plugin=this.plugin,attachments=item.getAttachments(),attach=attachments&&attachments[0];return driveItem=plugin.getCacheData(attach.id),plugin.isFolder(driveItem)}return item.isHeader()}};return util.inherit(VMPane,Plugin_Drive_Pane),util.extend(Plugin_Drive_Pane.prototype,Plugin_Drive_PaneFns),Plugin_Drive_Pane}),define("plugins/Plugin_Drive",["globals","util","platform","Constants","AccountManager","goog","TokenHolder","CachedSearch","PluginRenderer","VMPlugin","plugins/Plugin_Drive_Pane","tracker","DuchessHelpers"],function(g,util,platform,C,AccountManager,goog,TokenHolder,CachedSearch,PluginRenderer,VMPlugin,Plugin_Drive_Pane,tracker,DuchessHelpers){function Plugin_Drive(){this._super.constructor.call(this,PluginID.Drive,"Drive"),this.autocompleteReplace=!0,this.displaySharedWithMe=!g.isDemoMode(),util.forceBind("sortFn",this),this.registerSetting("WriteAccess","writeAccess",!0),this.registerSetting("LastChangeId","lastChangeId"),this.registerSetting("DriveRootId","driveRootId"),this._folderCache=this.registerLocalCache("FolderCache",StorageType.IndexedDB,!0),this.declareProperty("titleLower",PluginLoad.Runtime,!1,""),this.declareProperty("pinToTop",PluginLoad.Runtime,!0,!1),this.declareProperty("title"),this.declareProperty("mimeType"),this.declareProperty("fileSize",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("alternateLink",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("isDeleted",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("modifiedDate",PluginLoad.Autocomplete,!0),this.declareProperty("parents",PluginLoad.Autocomplete,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.DriveFile)}var MimeTypes={Unknown:"application/octet-stream",Folder:"application/vnd.google-apps.folder",Sheet:"application/vnd.google-apps.spreadsheet",Slide:"application/vnd.google-apps.presentation",Document:"application/vnd.google-apps.document",Moodo:goog.REALTIME_MIMETYPE+"."+goog.APP_ID,ImagePng:"image/png",ImageJpg:"image/jpg"},RequestType={SingleFile:1,FolderStruct:2,SubFolder:3,Search:4,DataPage:5,ChangeList:6,SingleFolder:7},SpecialFolderIDs={SharedWithMe:"S~SharedWithMe"},openUrl="https://drive.google.com/open?id=",DEFAULT_FOLDER_MAX_RESULTS=999,DEFAULT_SEARCH_MAX_RESULTS=100,DEFAULT_SEARCH_DISPLAY_RESULTS=10,DEFAULT_FILE_MAX_RESULTS=70,MAX_CHANGE_ID=1e8,MAX_CHANGE_RESULTS=500,MAX_FILE_UPLOAD_SIZE=20971520,boundary="-------314159265358979323846",delimiter="\r\n--"+boundary+"\r\n",close_delim="\r\n--"+boundary+"--",requestFields="id,mimeType,title,alternateLink,modifiedDate,parents",Plugin_DriveFns={getType:function getTypeFn(){return C.PluginType.Storage},getDataPane:function getDataPaneFn(){try{g.PAssert(4340,!!this.getPaneIcon(),"Should have a pane icon specified")}catch(PERR){g.reportError(PERR)}return Plugin_Drive_Pane},getPaneIcon:function getPaneIconFn(){return"icon-drive-file"},useItemStore:function useItemStoreFn(){return"Google Drive"},itemStoreOptions:function itemStoreOptionsFn(){return{parserFn:DuchessHelpers.parseSinglePlugin.bind(DuchessHelpers)}},allowRemoteRequests:function allowRemoteRequestsFn(){return!0},onAuthorizedSetting:function onAuthorizedSettingFn(key,value){switch(key){case this.Settings.WriteAccess:value&&this._ensureAttachmentsAreShared()}},_ensureSpecialFolders:function _ensureSpecialFoldersFn(){var itemStore=this.getDefaultItemStore();if(itemStore){var rootItem=itemStore.getRoot();if(this.displaySharedWithMe&&!itemStore.hasItem(SpecialFolderIDs.SharedWithMe)){var sharedItemID=g.generateTempId();this.cacheData(sharedItemID,{title:"Shared With Me",titleLower:"shared with me",mimeType:MimeTypes.Folder,pinToTop:!0});var sharedAttach=this.getAttachment(sharedItemID),sharedWithMeItem=itemStore.createItem(SpecialFolderIDs.SharedWithMe,this.getAttachmentEmbedString(sharedAttach),rootItem.id,{demandLoadChildren:!0});rootItem.insertSorted(sharedWithMeItem,this.sortFn)}}},_load:function _loadFn(){this._ensureSpecialFolders(),g.isDemoMode()||this.createRecurringTask("ChangeListUpdates",{delay:g.minutes(15),minDelay:g.minutes(5),runOnCreate:!0,pauseWhileIdle:!0,task:this.performChangeListUpdate.bind(this)})},loadInitialData:function loadInitialDataFn(){this._super.loadInitialData.call(this),this._ensureSpecialFolders();var folderManager=new TokenHolder(function(item){}.bind(this));setTimeout(function(){this._folderCache.onCacheMetadataReady(function(){this._folderCache.getMetadata("isSyncd",function(isSyncd){isSyncd||(log("Folder cache unsyncd - running folder sync"),this._folderCache.onCacheReady(function(){var numFolderRequests=0,numFolders=0,qFolderStruct="trashed=false and mimeType contains '"+MimeTypes.Folder+"'";this._requestRemoteFiles(RequestType.FolderStruct,folderManager,qFolderStruct,DEFAULT_FOLDER_MAX_RESULTS,function(entry){this._folderCache.cacheEntry(entry.id,this.serializeExternalData(entry)),numFolders++}.bind(this),function(success){numFolderRequests++}.bind(this)),this._folderCache.setMetadata("isSyncd",!0)}.bind(this)))}.bind(this))}.bind(this))}.bind(this),100);var firstRequestLoaded=!1,itemStore=this.getDefaultItemStore(),item=itemStore.getRoot(),qRootItems="trashed=false and 'root' in parents and mimeType != '"+MimeTypes.Moodo+"'";this._requestRemoteFiles(RequestType.SubFolder,item,qRootItems,DEFAULT_FILE_MAX_RESULTS,function(entry){if(this.hasCacheData(entry.id)||this._addRemoteEntry(entry),!this._hasSameItem(entry.id,item.id,itemStore)){var vmli=itemStore.createItem(this._createItemID(entry.id,itemStore),this._getTextForItem(entry),item.id,{demandLoadChildren:entry.mimeType===MimeTypes.Folder});item.insertSorted(vmli,this.sortFn)}if(!this.getSetting(this.Settings.DriveRootId)&&entry.parents)for(var i=0;i<entry.parents.length;++i)entry.parents[i].isRoot&&this.setSetting(this.Settings.DriveRootId,entry.parents[i].id)}.bind(this),function(){firstRequestLoaded||(firstRequestLoaded=!0,this.finishedLoading())}.bind(this))},performChangeListUpdate:function performChangeListUpdateFn(){var maxChangeId=-1,startChangeId=this.getSetting(this.Settings.LastChangeId);this._requestChangeList(startChangeId,function(entry){try{g.PAssert(4341,!startChangeId||parseInt(entry.id)>parseInt(startChangeId),"Must have correctly ordered change entry")}catch(PERR){g.reportError(PERR)}maxChangeId=entry.id;try{!entry.fileId||entry.file&&entry.file.mimeType===MimeTypes.Moodo||this._handleChange(entry)}catch(err){g.reportError(err)}}.bind(this),function(success){success&&-1!=maxChangeId&&this.setSetting(this.Settings.LastChangeId,maxChangeId)}.bind(this))},_handleChange:function _handleChangeFn(change){try{g.PAssert(4342,change&&(change.deleted||change.file),"Must have a valid formed change entry to handle")}catch(PERR){g.reportError(PERR)}(change.deleted||change.file.mimeType===MimeTypes.Folder)&&(change.deleted?this._folderCache.hasEntry(change.fileId,function(hasEntry){hasEntry&&this._folderCache.removeEntry(change.fileId)}.bind(this)):this._folderCache.cacheEntry(change.fileId,this.serializeExternalData(change.file)));var cacheEntry=this.getCacheData(change.fileId);if(cacheEntry){change.deleted||this.dataHasChanged(cacheEntry,change.file)&&this._addRemoteEntry(change.file);var itemStore=this.getDefaultItemStore();if(change.deleted){var attach=this.getAttachment(change.fileId);attach.forEachItem(itemStore,function(item){item.parent().removeChild(item,ChangeType.Remote),item.parent(void 0)}.bind(this)),attach.updateField("isDeleted",!0)}else{var seenParents=[],attach=this.getAttachment(change.fileId);attach.forEachItem(itemStore,function(item){for(var keepItem=!1,i=0;i<change.file.parents.length;++i){var tParent=change.file.parents[i];if(tParent.isRoot&&item.parent()&&item.parent().isRootItem()||item.parent()&&item.parent().hasAttachment(tParent.id)){keepItem=!0,seenParents.push(tParent.id);break}}item.parent()&&this._isSpecialFolder(item.parent().id)&&(keepItem=!0,seenParents.push(item.parent().id)),!keepItem&&item.parent()&&(item.parent().removeChild(item,ChangeType.Remote),item.parent(void 0))}.bind(this));for(var i=0;i<change.file.parents.length;++i){var tParent=change.file.parents[i];if(seenParents.indexOf(tParent.id)<0)if(tParent.isRoot){var storeRoot=itemStore.getRoot(),childItem=itemStore.createItem(this._createItemID(change.fileId,itemStore),this._getTextForItem(change.file),storeRoot.id,{demandLoadChildren:change.file.mimeType===MimeTypes.Folder});storeRoot.insertSorted(childItem,this.sortFn)}else{var parentAttach=this.getAttachment(tParent.id);parentAttach.forEachItem(itemStore,function(item){var childItem=itemStore.createItem(this._createItemID(change.fileId,itemStore),this._getTextForItem(change.file),item.id,{demandLoadChildren:change.file.mimeType===MimeTypes.Folder});item.insertSorted(childItem,this.sortFn)}.bind(this))}}if(this.displaySharedWithMe&&change.file.sharedWithMeDate&&seenParents.indexOf(SpecialFolderIDs.SharedWithMe)<0){var sharedItem=itemStore.getItem(SpecialFolderIDs.SharedWithMe),childItem=itemStore.createItem(this._createItemID(change.fileId,itemStore),this._getTextForItem(change.file),sharedItem.id,{demandLoadChildren:change.file.mimeType===MimeTypes.Folder});sharedItem.insertSorted(childItem,this.sortFn)}}}},_isValidFileID:function _isValidFileIDFn(fileID){return fileID.indexOf("~")<0},_createItemID:function _createItemIDFn(fileID,itemStore){try{g.PAssert(4343,fileID,"Must provide a fileID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4344,this._isValidFileID(fileID),"Invalid fileID - "+fileID)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4345,itemStore,"Must provide a valid itemStore")}catch(PERR){g.reportError(PERR)}for(var outID=fileID,dupeCounter=0;itemStore.hasItem(outID)&&50>dupeCounter;)outID=fileID+"~"+ ++dupeCounter;try{g.PAssert(4346,50>dupeCounter,"SANITY: Should not have items with 50+ parents")}catch(PERR){g.reportError(PERR)}return outID},_hasSameItem:function _hasSameItemFn(fileID,parentID,itemStore){for(var isSame=!1,itemID=fileID,dupeCounter=0;itemStore.hasItem(itemID)&&50>dupeCounter;){var existItem=itemStore.getItem(itemID);if(existItem&&existItem.parent()&&existItem.parent().id===parentID){isSame=!0;break}itemID=fileID+"~"+ ++dupeCounter}return isSame},_isSpecialFolder:function _isSpecialFolderFn(id){return id.startsWith("S~")},requestDemandLoadData:function requestDemandLoadDataFn(paneID,item){try{g.PAssert(4347,1===item.getNumAttachments(),"Should only have a single attachment for Drive Pane VMLIs")}catch(PERR){g.reportError(PERR)}var pane=g.vmMain.paneManager.getPaneById(paneID),attach=item.getAttachments()[0],q;if(this._isSpecialFolder(item.id))switch(item.id){case SpecialFolderIDs.SharedWithMe:q="trashed=false and sharedWithMe and mimeType != '"+MimeTypes.Moodo+"'";break;default:try{g.PAssert(4348,!1,"Invalid special folder ID")}catch(PERR){g.reportError(PERR)}}q||(q="trashed=false and '"+attach.id+"' in parents and mimeType != '"+MimeTypes.Moodo+"'");var itemStore=this.getActiveItemStore(paneID);this._requestRemoteFiles(RequestType.SubFolder,item,q,DEFAULT_FILE_MAX_RESULTS,function(entry){if(this.hasCacheData(entry.id)||this._addRemoteEntry(entry),!this._hasSameItem(entry.id,item.id,itemStore)){var vmli=itemStore.createItem(this._createItemID(entry.id,itemStore),this._getTextForItem(entry),item.id,{demandLoadChildren:entry.mimeType===MimeTypes.Folder});item.insertSorted(vmli,this.sortFn,!0)}}.bind(this),function(success){success||item.hasPaginationToken()||item.notifyLoadDataFailed(pane)}.bind(this)),this.sendEvent("RequestDemandLoadData")},requestDataPage:function requestDataPageFn(item){this._requestRemoteFiles(RequestType.DataPage,item)},_ensureAncestorChain:function _ensureAncestorChainFn(itemStore,entry,successCB,errorCB){try{g.PAssert(4349,successCB,"Must provide a valid success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4350,errorCB,"Must provide a valid error callback")}catch(PERR){g.reportError(PERR)}if(entry.parents&&entry.parents.length)for(var expectedResponses=entry.parents.length,receivedResponses=0,updateOnSuccess=function(){++receivedResponses===expectedResponses&&successCB()},parseFileInfo=function(fileInfo){try{g.PAssert(4351,fileInfo,"Must provide valid fileInfo up ancestor chain")}catch(PERR){g.reportError(PERR)}this.hasCacheData(fileInfo.id)||this._addRemoteEntry(fileInfo),this._ensureAncestorChain(itemStore,fileInfo,updateOnSuccess,errorCB)}.bind(this),remoteSuccessCB=function(result){if(result){var resultInfo=this.serializeExternalData(result);this._folderCache.cacheEntry(resultInfo.id,resultInfo),parseFileInfo(resultInfo)}else errorCB({error:"Undefined success result."})}.bind(this),onFolderCacheResult=function(cacheResult,id){if(cacheResult)parseFileInfo(cacheResult);else{var remoteFolderRequestFn=["gapi","client","drive","files","get"],remoteFolderRequestData={fileId:id};this._queueRemoteRequest(remoteFolderRequestFn,remoteFolderRequestData,remoteSuccessCB,errorCB,void 0,RequestType.SingleFolder)}}.bind(this),i=0;i<entry.parents.length;++i){var parentId=entry.parents[i].id;try{g.PAssert(4352,parentId,"Must supply a valid parent ID to query")}catch(PERR){g.reportError(PERR)}this._folderCache.getEntry(parentId,onFolderCacheResult)}else successCB()},_hasAttachmentChild:function _hasAttachmentChildFn(item,attachID){for(var ret=!1,i=0;i<item.numItems();++i){var child=item.itemAtIndex(i);if(child.hasAttachment(attachID)){ret=!0;break}}return ret},_attachAncestorChain:function _attachAncestorChainFn(itemStore,entry){try{g.PAssert(4353,entry,"Must provide a valid cache entry to create items for")}catch(PERR){g.reportError(PERR)}if(entry.parents&&entry.parents.length>0)for(var i=0;i<entry.parents.length;++i){var parentEntry=entry.parents[i];try{g.PAssert(4354,parentEntry&&parentEntry.id,"Must supply a valid parent ID to query")}catch(PERR){g.reportError(PERR)}if(parentEntry.isRoot){var storeRoot=itemStore.getRoot();if(!this._hasAttachmentChild(storeRoot,entry.id)){var childItem=itemStore.createItem(this._createItemID(entry.id,itemStore),this._getTextForItem(entry),storeRoot.id,{demandLoadChildren:entry.mimeType===MimeTypes.Folder});storeRoot.insertSorted(childItem,this.sortFn)}}else this._folderCache.getEntry(parentEntry.id,function(folderEntry){this._attachAncestorChain(itemStore,folderEntry);var parentAttach=this.getAttachment(folderEntry.id);parentAttach.forEachItem(itemStore,function(item){if(!this._hasAttachmentChild(item,entry.id)){var childItem=itemStore.createItem(this._createItemID(entry.id,itemStore),this._getTextForItem(entry),item.id,{demandLoadChildren:entry.mimeType===MimeTypes.Folder});item.insertSorted(childItem,this.sortFn)}}.bind(this))}.bind(this))}},getNextSearchPage:function getNextSearchPageFn(){this._lastCompletedSearch&&this._lastCompletedSearch.isValid()&&this._lastCompletedSearch.getNextPage()},runRemoteSearch:function runRemoteSearchFn(search,paneID,bucketID,cb){try{g.PAssert(4355,search,"Must provide a valid search")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4356,paneID,"Must provide a valid pane")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4357,g.isFunction(cb),"Must provide a valid search callback")}catch(PERR){g.reportError(PERR)}var doneProcessingEntries=!1,totalEntries=0,finishedEntries=0,errorEntries=0,runningSearch=new CachedSearch(search,DEFAULT_SEARCH_DISPLAY_RESULTS,this.requestDataPage.bind(this)),checkSearchCompleted=function(){if(totalEntries===finishedEntries&&doneProcessingEntries){log("Done Searching! "+totalEntries);var resultStatus=SearchResultStatus.Done;if(runningSearch.isValid()){var pane=g.vmMain.paneManager.getPaneById(paneID);pane.search.update(!0),runningSearch.isValid()&&runningSearch.hasMoreResults()?(log("Too many search results"),resultStatus=SearchResultStatus.TooMany):runningSearch.hasError()||errorEntries>0?resultStatus=SearchResultStatus.Error:0===totalEntries&&(resultStatus=SearchResultStatus.None),this._lastCompletedSearch=runningSearch}cb(resultStatus)}}.bind(this),entryCB=function(entry){totalEntries++,this.hasCacheData(entry.id)||this._addRemoteEntry(entry);var itemStore=this.getActiveItemStore(paneID);
this._ensureAncestorChain(itemStore,entry,function(){runningSearch.isValid()&&this._attachAncestorChain(itemStore,entry),finishedEntries++,checkSearchCompleted()}.bind(this),function(err){g.reportError(new Error("Error during remote search: ",err)),finishedEntries++,errorEntries++,checkSearchCompleted()}.bind(this))}.bind(this),doneCB=function(success){doneProcessingEntries=!0,checkSearchCompleted()}.bind(this),firstSearchIsDone=!1,firstSearchDoneCB=function(success){runningSearch.onDone(success),firstSearchIsDone||(firstSearchIsDone=!0,runningSearch.isValid()&&(runningSearch.hasResults()?runningSearch.getNextPage(entryCB,doneCB):doneCB(success)))},q="trashed=false and (fullText contains '"+search+"')";return this._requestRemoteFiles(RequestType.Search,runningSearch,q,DEFAULT_SEARCH_MAX_RESULTS,runningSearch.onEntry,firstSearchDoneCB),this.sendEvent("RemoteSearch"),runningSearch},_requestRemoteFiles:function _requestRemoteFilesFn(type,reqItem,q,maxResults,entryCB,doneCB){var paginationToken;reqItem&&reqItem.hasPaginationToken()&&!reqItem.paginationTokenInUse()?(paginationToken=reqItem.beginDataPageLoad(),q=paginationToken.getQuery(),maxResults=paginationToken.getMaxResults(),entryCB=paginationToken.getEntryCB(),doneCB=paginationToken.getDoneCB()):reqItem&&reqItem.needsPaginationToken()&&(paginationToken=this.createPaginationToken(void 0,q,{},maxResults,entryCB,doneCB),reqItem.setPaginationToken(paginationToken),reqItem.beginDataPageLoad()),maxResults=maxResults||DEFAULT_FILE_MAX_RESULTS;try{g.PAssert(4358,entryCB&&g.isFunction(entryCB),"Must define a valid entry callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4359,doneCB&&g.isFunction(doneCB),"Must define a valid done callback")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","drive","files","list"],requestData={fields:"items,nextPageToken",maxResults:maxResults,q:q,pageToken:paginationToken&&paginationToken.hasMorePages()?paginationToken.getNextPageToken():void 0},successCB,failureCB;paginationToken||!reqItem?(successCB=function(results){if(results.items){g.vmMain.beginUpdateItems();for(var i=0;i<results.items.length;++i)entryCB(results.items[i]);g.vmMain.commitUpdateItems()}results.nextPageToken&&paginationToken&&this.updatePaginationToken(paginationToken,results.nextPageToken),reqItem&&paginationToken&&reqItem.endDataPageLoad(!!results.nextPageToken),doneCB(!0)}.bind(this),failureCB=function(){paginationToken&&reqItem.endDataPageLoad(!!paginationToken),doneCB(!1)}.bind(this)):(successCB=function(){doneCB(!0)},failureCB=function(){doneCB(!1)}),this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,type)},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach){function _doAction(){var requestFn=["gapi","client","drive","files","get"],requestData={fileId:attach.id},successCB=function(result){try{g.PAssert(4360,!result||result.id===attach.id,"If valid result, attachment should match remote file ID")}catch(PERR){g.reportError(PERR)}result&&(this._addRemoteEntry(result),(result.deleted||result.mimeType===MimeTypes.Folder)&&(result.deleted?this._folderCache.hasEntry(result.id,function(hasEntry){hasEntry&&this._folderCache.removeEntry(result.id)}.bind(this)):this._folderCache.cacheEntry(result.id,this.serializeExternalData(result))))}.bind(this),failureCB=function(result){attach.notifyDataRequestFailed()}.bind(this);this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,attach,RequestType.SingleFile)}window.gapi&&window.gapi.client&&window.gapi.client.drive?_doAction.bind(this)():this._queueDeferredRemoteRequest(_doAction.bind(this))},_requestChangeList:function _requestChangeListFn(startChangeId,entryCB,doneCB){if(startChangeId){try{g.PAssert(4361,entryCB,"Must supply a valid entry CB")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4362,doneCB,"Must provide a valid done CB")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","drive","changes","list"],requestData={includeDeleted:!0,includeSubscribed:!0,maxResults:MAX_CHANGE_RESULTS,startChangeId:+startChangeId+1,fields:"items,nextPageToken"},successCB=function(results){var newMaxID=startChangeId;g.vmMain.beginUpdateItems();for(var i=0;i<results.items.length;++i){var entry=results.items[i];try{g.PAssert(4363,entry,"Must have a valid change entry")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4364,parseInt(entry.id)<MAX_CHANGE_ID,"Must have a valid entry ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4365,parseInt(entry.id)>parseInt(newMaxID),"Must be ordered monotonic increasing")}catch(PERR){g.reportError(PERR)}newMaxID=entry.id,entryCB(entry)}g.vmMain.commitUpdateItems(),results.nextPageToken?this._requestChangeList(newMaxID,entryCB,doneCB):doneCB(!0)}.bind(this),failureCB=function(results){doneCB(!1)}}else var requestFn=["gapi","client","drive","changes","list"],requestData={includeDeleted:!0,includeSubscribed:!0,maxResults:1,startChangeId:MAX_CHANGE_ID},successCB=function(results){var lastChangeId=results.largestChangeId;entryCB({id:lastChangeId}),doneCB(!0)},failureCB=function(results){doneCB(!1)};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.ChangeList)},_createRemoteEntry:function _createRemoteEntryFn(info){var entry={id:info.id,mimeType:info.mimeType,title:info.title,titleLower:info.title.toLowerCase(),alternateLink:info.alternateLink,fileSize:+info.fileSize,parents:info.parents,modifiedDate:info.modifiedDate?new Date(info.modifiedDate):void 0};if(entry.parents)for(var i=0;i<entry.parents.length;++i)this._updateParentsEntry(entry.parents[i]);if(info.properties)for(var i=0;i<info.properties.length;++i){if(info.properties[i].key===goog.DocFolderTitleProperty){entry.title=info.properties[i].value;break}if(info.properties[i].key===goog.DefaultRootFolderProperty){entry.title="Shared Files",entry.pinToTop=!0;break}}return this.isFolder(entry)&&(entry.items=[]),entry},_addRemoteEntry:function _addRemoteEntryFn(info){var entry=this._createRemoteEntry(info);this.cacheData(entry.id,entry)},createEntryFromLocal:function createEntryFromLocalFn(id,info){if(this.isFolder(info)&&(info.items=[]),info.titleLower=info.title.toLowerCase(),info.modifiedDate=info.modifiedDate?new Date(info.modifiedDate):void 0,info.isDeleted=info.isDeleted||g.isTempId(id),info.parents)for(var i=0;i<info.parents.length;++i)this._updateParentsEntry(info.parents[i]);return info},_updateParentsEntry:function _updateParentsEntryFn(data){this._folderCache.getEntry(data.id,function(parentEntry){parentEntry&&(data.title=parentEntry.title)})},isFolder:function isFolderFn(data){return data.mimeType===MimeTypes.Folder},_getCompStringForItem:function _getCompStringForItemFn(item){return item.hasAttachments()?item.getAttachments()[0].getTitleString():item.getParsedText()},_isItemPinnedToTop:function _isItemPinnedToTopFn(item){return item.hasAttachments()?item.getAttachments()[0].getField("pinToTop"):!1},sortFn:function sortFnFn(left,right){return this._isItemPinnedToTop(left)?-1:this._isItemPinnedToTop(right)?1:this._getCompStringForItem(left).localeCompare(this._getCompStringForItem(right))},getAttachmentClass:function getAttachmentClassFn(attach){var classes=["plugin_drive"];return classes.push(attach.hasField("mimeType")?this.getMimetypeClass(attach.getField("mimeType")):"plugin_drive_unk"),attach.hasField("isDeleted")&&attach.getField("isDeleted")&&classes.push("fileDeleted"),classes},getMimetypeClass:function getMimetypeClassFn(mimeType){switch(mimeType){case MimeTypes.Folder:return"plugin_drive_folder";case MimeTypes.Sheet:return"plugin_drive_sheet";case MimeTypes.Slide:return"plugin_drive_slide";case MimeTypes.Document:return"plugin_drive_doc";case MimeTypes.ImagePng:case MimeTypes.ImageJpg:return"plugin_drive_image";default:return"plugin_drive_unk"}},googleScopes:function googleScopesFn(full){return full||this.getSetting(this.Settings.WriteAccess)?[GScope.DriveFull]:[GScope.DriveMetadataRO]},getDependencies:function getDependenciesFn(){return[PluginDependency.LocalLoaded,PluginDependency.PremiumSub,PluginDependency.DriveAPI,PluginDependency.GoogleLogin]},onDependencyLoaded:function onDependencyLoadedFn(dep,data){if(this._super.onDependencyLoaded.call(this,dep,data),dep===PluginDependency.GoogleLogin){try{g.PAssert(4366,g.isArray(data),"Must provide a valid scope array")}catch(PERR){g.reportError(PERR)}this.getSetting(this.Settings.IsEnabled)&&(data.indexOf(GScope.DriveMetadataRO)<0&&data.indexOf(GScope.DriveFull)<0&&(g.toasts.pushMessage(MessageID.LostPermission),AccountManager.notifyUnauthorizedAccount("me",[GScope.DriveMetadataRO,GScope.DriveFull],"Missing Scope"),this.setSetting(this.Settings.IsEnabled,!1)),this.getSetting(this.Settings.WriteAccess)&&data.indexOf(GScope.DriveFull)<0&&(g.toasts.pushMessage(MessageID.LostPermission),AccountManager.notifyUnauthorizedAccount("me",[GScope.DriveFull],"Missing Write Scope"),this.setSetting(this.Settings.WriteAccess,!1)))}},isDependencyLoaded:function isDependencyLoadedFn(dep,data){var isLoaded=!1;switch(dep){case PluginDependency.GoogleLogin:data&&(data.indexOf(GScope.DriveMetadataRO)>=0||data.indexOf(GScope.DriveFull)>=0)&&(isLoaded=!0);break;default:isLoaded=!0}return isLoaded},loadRemoteAPIs:function loadRemoteAPIsFn(cb){this.areRemoteAPIsLoaded()?cb&&cb():g.loadGoogleAPI("drive","v2",function(){try{g.PAssert(4367,this.areRemoteAPIsLoaded(),"Must have loaded calendar remote APIs")}catch(PERR){g.reportError(PERR)}g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.DriveAPI),cb&&cb()}.bind(this))},areRemoteAPIsLoaded:function areRemoteAPIsLoadedFn(){return window.gapi&&window.gapi.client&&window.gapi.client.drive},handleDropEvent:function handleDropEventFn(e,cb){var url=e.dataTransfer.getData("text/uri-list");if(url&&url.startsWith(openUrl)){var str=url.replace(openUrl,""),andIndex=str.indexOf("&"),id=str.substr(0,andIndex),attach=this.getAttachment(id);return cb(attach.getEmbedString()),!0}if(e.dataTransfer.files&&e.dataTransfer.files.length>0){for(var i=0,f;f=e.dataTransfer.files[i];i++)this._handleDropFile(f,e,cb);return tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DriveUpload}),!0}return!1},isItemDroppable:function isItemDroppableFn(item){var isDroppable=!0,attach=item.getAttachments()[0];try{g.PAssert(4368,attach,"Should always have a valid attachment when copying from a Drive pane.")}catch(PERR){g.reportError(PERR)}if(attach){var mimeType=attach.getField("mimeType");mimeType===MimeTypes.Folder&&(isDroppable=!1)}return isDroppable},_handleDropFile:function _handleDropFileFn(file,e,cb){for(var matched=!1,matches=this.findCachedItemsByField("title",file.name),dropPane=g.getPaneForElement(e.srcElement),i=0;i<matches.length;++i){var item=matches[i];if(item.fileSize===file.size&&!item.isDeleted){var attach=this.getAttachment(item.id);dropPane&&dropPane.isWriteable&&dropPane.plugin!==this?cb(this.getAttachmentEmbedString(attach),!1):dropPane&&dropPane.plugin===this&&attach.forEachItem(itemStore,function(item){item.highlight()}),matched=!0;break}}if(!matched){var itemID=g.generateTempId();this.cacheData(itemID,{title:file.name,mimeType:file.type});var attach=this.getAttachment(itemID),doShare=dropPane&&dropPane.isWriteable&&dropPane.plugin!==this,itemStore=this.getDefaultItemStore(),destItem;if(dropPane&&dropPane.isWriteable&&dropPane.plugin!==this)cb(this.getAttachmentEmbedString(attach),!0);else if(this.getSetting(this.Settings.WriteAccess)){var target=e.srcElement||e.target;destItem=g.hasClass(target,"paneContent")?dropPane.getItem():g.getItemForElement(target),destItem&&!destItem.isHeader()&&(destItem=destItem.parent())}var forceParentId;if(destItem){if(!destItem.isRootItem()){var destAttach=destItem.getAttachments()[0];try{g.PAssert(4369,destAttach,"Drive items must have valid attachments")}catch(PERR){g.reportError(PERR)}forceParentId=destAttach.id}}else destItem=itemStore.getRoot(),forceParentId=this.getSetting(this.Settings.DriveRootId);this._upload(file,attach,doShare,dropPane.getPaneDoc(),forceParentId);try{g.PAssert(4370,!itemStore.hasItem(attach.id),"When uploading a new file, should never have duplicated items")}catch(PERR){g.reportError(PERR)}var newDriveItem=itemStore.createItem(attach.id,this.getAttachmentEmbedString(attach),destItem.id);destItem.insertSorted(newDriveItem,this.sortFn)}},notifyDropFrom:function notifyDropFromFn(droppedItem,toPane){try{g.PAssert(4371,droppedItem,"Must have a valid item that was dropped")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4372,toPane,"Must have a valid pane the item was dropped on")}catch(PERR){g.reportError(PERR)}if(!g.isDemoMode()){var attach=droppedItem.getAttachments()[0],paneDoc=toPane.getPaneDoc();paneDoc.shareFile(attach.id,function(success,result){success||(this.getSetting(this.Settings.WriteAccess)&&result.code===C.HTTPStatusCode.Unauthorized&&this.setSetting(this.Settings.WriteAccess,!1),paneDoc.isShared()&&g.toasts.pushMessage(MessageID.ShareFailure))}.bind(this)),this.sendEvent("AttachmentDropped")}},notifyDropFromToEdit:function notifyDropFromToEditFn(droppedItem,dropElement){if(!g.isDemoMode())if(this.getSetting(this.Settings.WriteAccess)){var attach=droppedItem.getAttachments()[0];if(attach){var ev=document.createEvent("Event");ev.item=droppedItem,ev.initEvent("cdrop",!0,!0),dropElement.dispatchEvent(ev)}this.sendEvent("AttachmentDroppedEdit")}else g.toasts.pushMessage(MessageID.NeedDrivePermission)},handleTapStart:function handleTapStartFn(vmli,id,e){return platform.mobile&&e.preventDefault(),!0},handleTapClick:function handleTapClickFn(vmli,id,e){var item=this.getCacheData(id);if(item){if(this.isPluginPane(g.focusedPane)&&this.isFolder(item))g.vmMain.zoomin(vmli),this.sendEvent("Tap_FolderZoom");else if(platform.mobile){var attach=this.getAttachment(id),html=this.createDisplayElement(attach).text;e.preventDefault(),g.preventClick(),g.menus.openMenuExternalApp(html,function(){item.alternateLink?g.openUrl(item.alternateLink,e):g.openUrl(this._createDriveURL(item.id,item.mimeType),e)}.bind(this)),this.sendEvent("Tap_OpenFileMobile")}else g.isDemoMode()?g.toasts.pushMessage(MessageID.DemoPluginClick):(item.alternateLink?g.openUrl(item.alternateLink,e):g.openUrl(this._createDriveURL(item.id,item.mimeType),e),this.sendEvent("Tap_OpenFileDesktop"));return!0}return!1},_createDriveURL:function _createDriveURLFn(id,mimeType){var startURL="https://docs.google.com/";switch(mimeType){case MimeTypes.Folder:return startURL+"folderview?id="+id+"&usp=drivesdk";case MimeTypes.Sheet:return startURL+"spreadsheets/d/"+id+"/edit?usp=drivesdk";case MimeTypes.Document:return startURL+"document/d/"+id+"/edit?usp=drivesdk";case MimeTypes.Slide:return startURL+"presentation/d/"+id+"/edit?usp=drivesdk";default:return startURL+"file/d/"+id+"/edit?usp=drivesdk"}},compactCacheField:function compactCacheFieldFn(entry,key){var outValue;switch(key){case"alternateLink":entry[key]!==this._createDriveURL(entry.id,entry.mimeType)&&(outValue=entry[key]);break;default:outValue=entry[key]}return outValue},supportOfflineCache:function supportOfflineCacheFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},matchAttachment:function matchAttachmentFn(attach,text){return attach.getField("titleLower").indexOf(text)>=0},getBlockedText:function getBlockedTextFn(attach){return"Go Premium to view Drive files"},onDocumentShared:function onDocumentSharedFn(firstShare){this.getSetting(this.Settings.WriteAccess)?firstShare&&this._ensureAttachmentsAreShared():this.numActiveAttachments()>0&&g.toasts.pushMessage(MessageID.NoSharingWarning)},_ensureAttachmentsAreShared:function _ensureAttachmentsAreSharedFn(){var openDoc=g.vmMain.docManager.getOpenDoc();this.forEachActiveAttachment(function(attach){openDoc.shareFile(attach.id,function(success){})}.bind(this))},notifyAttachmentUnused:function notifyAttachmentUnusedFn(attach,changeType){this._super.notifyAttachmentUnused.call(this,attach,changeType);var openDoc=g.vmMain.docManager.getOpenDoc();openDoc.unshareFile(attach.id,function(success){})},_upload:function _uploadFn(fileData,attach,doShare,paneDoc,defaultParent){fileData.size>MAX_FILE_UPLOAD_SIZE?(g.toasts.pushMessage(MessageID.WarnLargeFile),this.sendEvent("Upload_Large")):this.sendEvent("Upload"),g.loadGoogleAPI("drive","v2",function(){var reader=new FileReader;reader.readAsBinaryString(fileData),reader.onload=function(e){var contentType=fileData.type||MimeTypes.Unknown,runUpload=function(folderID){var metadata={title:fileData.name,mimeType:contentType,parents:defaultParent?[{id:defaultParent}]:[]};doShare&&folderID&&metadata.parents.push({id:folderID});var base64Data=btoa(reader.result),body=delimiter+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+delimiter+"Content-Type: "+contentType+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+base64Data+close_delim,request=gapi.client.request({path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+boundary+'"'},body:body}),callback=function(file){this.changeID(attach,attach.id,file.id),this._addRemoteEntry(file)}.bind(this);request.execute(callback)}.bind(this);if(doShare){try{g.PAssert(4373,paneDoc,"Must supply a valid paneDoc if sharing a file")}catch(PERR){g.reportError(PERR)}paneDoc.getDocumentFolder(function(folderID){runUpload(folderID)})}else runUpload()}.bind(this)}.bind(this))},findMatchExact:function findMatchExactFn(text){},findMatchLike:function findMatchLikeFn(text,maxCount){var textLower=text.toLowerCase(),results=this.findCachedItemsByFn(function(item){return item.titleLower.indexOf(textLower)>=0},maxCount);return results.sort(function(lEntry,rEntry){return lEntry.modifiedDate&&rEntry.modifiedDate?Date.compare(lEntry.modifiedDate,rEntry.modifiedDate):lEntry.modifiedDate?-1:rEntry.modifiedDate?1:lEntry.titleLower.localeCompare(rEntry.titleLower)}),results},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return this.getAttachmentEmbedString(item)},getItemTextLength:function getItemTextLengthFn(item){return 1},autocompleteWidth:function autocompleteWidthFn(){return 350}};return util.inherit(VMPlugin,Plugin_Drive),util.extend(Plugin_Drive.prototype,Plugin_DriveFns),Plugin_Drive}),define("plugins/Plugin_Mailbird",["globals","util","platform","goog","VMPlugin","DragDrop"],function(g,util,platform,goog,VMPlugin,DragDrop){function Plugin_Mailbird(){if(this._isBuiltin=!0,this._super.constructor.call(this,PluginID.Mailbird,"Mailbird"),this.autocompleteReplace=!0,this.declareProperty("subject",PluginLoad.Preview|PluginLoad.Full,!1,""),this.declareProperty("from",PluginLoad.Preview|PluginLoad.Full,!1,""),this.declareProperty("date",PluginLoad.Preview|PluginLoad.Full,!0,new Date),this.declareProperty("subjectLower",PluginLoad.Runtime,!1,""),this.declareProperty("fromLower",PluginLoad.Runtime,!1,""),this.declareProperty("unread",PluginLoad.Runtime,!0,!1),this.declareProperty("snippet",PluginLoad.Runtime,!0,""),this.declareProperty("count",PluginLoad.Runtime,!0,1),this.declareProperty("latestMessageAt",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("provider",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("threadID",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("hasAttachments",PluginLoad.Full,!0,!1),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.EmailThread),this.isMailbirdEmbed=platform.embed===EmbedApps.Mailbird,this.isMailbirdEmbed){this.setSetting(this.Settings.IsEnabled,!0),g.nativeBridge.registerEmbedBridge(this);var nativeInAPI=g.nativeBridge.registerInboundAPI("mailbird");try{g.PAssert(4374,nativeInAPI,"Error creating native inbound API for mailbird")}catch(PERR){g.reportError(PERR)}nativeInAPI&&(nativeInAPI.registerVariable("_prevX"),nativeInAPI.registerVariable("_prevY"),nativeInAPI.registerFunction("dragOver",nativeAPIFns.dragOver,!0),nativeInAPI.registerFunction("drop",nativeAPIFns.drop,!0),nativeInAPI.registerFunction("dragLeave",nativeAPIFns.dragLeave,!0),nativeInAPI.registerFunction("reportError",nativeAPIFns.reportError,!0)),this._mailbirdOutAPI=g.nativeBridge.registerOutboundAPI("mailbird");try{g.PAssert(4375,this._mailbirdOutAPI,"Error creating native outbound API for mailbird")}catch(PERR){g.reportError(PERR)}this._mailbirdOutAPI&&(this._mailbirdOutAPI.requireFunction("selectConversation"),this._mailbirdOutAPI.requireFunction("selectConversationEx",!0),this._mailbirdOutAPI.requireFunction("scheduleNotifications",!0))}}var KnownEmailProviders={Gmail:"Gmail"},nativeAPIFns={dragOver:function dragOverFn(obj){var element=g.elementFromPoint(obj.x,obj.y);if(element){var diffX=void 0!==this._prevX?obj.x-this._prevX:0,diffY=void 0!==this._prevY?obj.y-this._prevY:0;this._prevX=obj.x,this._prevY=obj.y;var e={clientX:obj.x,clientY:obj.y,diffX:diffX,diffY:diffY,srcElement:element,target:element,dataTransfer:{}};DragDrop.handleDragOver(e)}},drop:function dropFn(obj){var element=g.elementFromPoint(obj.x,obj.y),options={clientX:obj.x,clientY:obj.y,target:element,srcElement:element,dataTransfer:{getData:function getDataFn(type){if("mailbird/email"===type){var inData={subject:obj.subject||"",from:obj.from||"",id:obj.mailMessageId?obj.mailMessageId:"mailbird_"+obj.id,latestMessageAt:obj.latestMessageAt};return obj.gmailID&&(inData.provider="Gmail",inData.threadID=obj.gmailID),inData}}},preventDefault:g.emptyFn,stopPropagation:g.emptyFn};setTimeout(function(){DragDrop.handleDrop(options)},0)},dragLeave:function dragLeaveFn(){DragDrop.handleDragLeave({target:document.getElementById("container")})},reportError:function reportErrorFn(errString){g.reportError(new Error(errString))}},Plugin_MailbirdFns={getPaneIcon:function getPaneIconFn(){return"icon-envelope"},useItemStore:function useItemStoreFn(){return"Mailbird"},_addRemoteEntry:function _addRemoteEntryFn(info){var entry={id:info.id,provider:info.provider,threadID:info.threadID,subject:info.subject,subjectLower:info.subject.toLowerCase(),from:info.from,fromLower:info.from.toLowerCase(),latestMessageAt:info.latestMessageAt};return this.cacheData(entry.id,entry),entry},createEntryFromLocal:function createEntryFromLocalFn(id,info){return info.subjectLower=info.subject.toLowerCase(),info.fromLower=info.from.toLowerCase(),info},getAttachmentClass:function getAttachmentClassFn(attach){return["plugin_mailbird"]},isPluginBlocked:function isPluginBlockedFn(){return!1},handleEmbedMessage:function handleEmbedMessageFn(method,data){switch(method){case"scheduledItems":if(this._mailbirdOutAPI.hasOptionalFunction("scheduleNotifications"))try{var notificationData=JSON.stringify(data);this._mailbirdOutAPI.call("scheduleNotifications",notificationData)}catch(err){g.reportError(err)}break;default:try{g.PAssert(4376,!1,"Unknown embed message: "+method)}catch(PERR){g.reportError(PERR)}}},handleDropEvent:function handleDropEventFn(e,cb){try{g.PAssert(4377,cb,"Must provide a valid callback to the drop event")}catch(PERR){g.reportError(PERR)}var info=e.dataTransfer.getData("mailbird/email");if(info){var email=this._addRemoteEntry(info);cb(this._getTextForItem(email));var newAttach=this.getAttachment(email.id);try{g.PAssert(4378,newAttach.isLoaded(),"Mailbird attachments must always be loaded after creation")}catch(PERR){g.reportError(PERR)}return this.writeAttachmentToPreviewCache(newAttach),!0}return!1},handleTapStart:function handleTapStartFn(vmli,id,e){return!0},handleTapClick:function handleTapClickFn(vmli,id,e){var item=this.getCacheData(id);if(item){if(this.isMailbirdEmbed){var requireLegacySelect=item.id.startsWith("mailbird_"),returnValue;if(!requireLegacySelect&&this._mailbirdOutAPI.hasOptionalFunction("selectConversationEx")){var gmailID=null;if("Gmail"===item.provider){try{g.PAssert(4379,item.threadID,"Must provide a valid Gmail ID if it is defined as the provider")}catch(PERR){g.reportError(PERR)}gmailID=parseInt(item.threadID)}var id=item.id;returnValue=this._mailbirdOutAPI.call("selectConversationEx",gmailID,id,item.latestMessageAt)}else{var id=item.id.replace("mailbird_","");returnValue=this._mailbirdOutAPI.call("selectConversation",id)}try{g.PAssert(4380,void 0!==returnValue,"Must always receive a value back from Mailbird")}catch(PERR){g.reportError(PERR)}if(returnValue===!0||returnValue===!1)try{g.PAssert(4381,returnValue,"Must have successfully selected the email conversation in Mailbird: ",item.id,item.provider)}catch(PERR){g.reportError(PERR)}else{try{g.PAssert(4382,returnValue&&returnValue.then,"Must have a valid promise object returned")}catch(PERR){g.reportError(PERR)}returnValue.then(function(success){try{g.PAssert(4383,success,"Must have successfully selected the email conversation in Mailbird: ",item.id,item.provider)}catch(PERR){g.reportError(PERR)}},function(failure){try{g.PAssert(4384,!1,"Failed to successfully select the email conversation in Mailbird: ",item.id,item.provider)}catch(PERR){g.reportError(PERR)}})}}else switch(item.provider){case KnownEmailProviders.Gmail:g.openUrl("https://mail.google.com/mail/u/0/#inbox/"+item.threadID);break;default:g.toasts.pushMessage(MessageID.MailbirdClick)}return!0}return!1},getDisplayTags:function getDisplayTagsFn(attach){return[]},getDisplayParticipants:function getDisplayParticipantsFn(attach){return""},matchAttachment:function matchAttachmentFn(attach,text){return attach.getField("fromLower").indexOf(text)>=0||attach.getField("subjectLower").indexOf(text)>=0},findMatchExact:function findMatchExactFn(text){},findMatchLike:function findMatchLikeFn(text,maxCount){var textLower=text.toLowerCase();return this.findCachedItemsByFn(function(item){return item.subjectLower.indexOf(textLower)>=0||item.fromLower.indexOf(textLower)>=0},maxCount)},supportOfflineCache:function supportOfflineCacheFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return this.getAttachmentEmbedString(item)},getItemTextLength:function getItemTextLengthFn(item){return 1},autocompleteWidth:function autocompleteWidthFn(){return 450},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return["m:","mailbird:"]}};return util.inherit(VMPlugin,Plugin_Mailbird),util.extend(Plugin_Mailbird.prototype,Plugin_MailbirdFns),Plugin_Mailbird}),define("UndoStack",["require","exports","module","globals"],function(require,exports,module){function UndoStack(size){this._maxSize=size,this._groups=[],this._groupID=0,this._cursor=-1,this._performingActions=!1,this._actionsPreventUndo=!1,this._aggregateActions=0,this._currentAction=[],this._registeredOwners={},this._registeredActions={}}var g=require("globals");return UndoStack.prototype={registerOwner:function registerOwnerFn(owner,ownerID){try{g.PAssert(4385,owner,"Must supply a valid owner object")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4386,!this._registeredOwners[ownerID],"Must not double define an owner")}catch(PERR){g.reportError(PERR)}this._registeredOwners[ownerID]=owner,this._registeredActions[ownerID]={}},registerAction:function registerActionFn(ownerID,actionID,data){try{g.PAssert(4387,ownerID,"Must provide a valid owner")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4388,actionID,"Must provide a valid action ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4389,this._registeredOwners[ownerID],"Must have already registered a valid owner")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4390,!this._registeredActions[ownerID][actionID],"Must not double define an action for an owner")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4391,data,"Must pass in a valid undo/redo descriptor")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4392,g.isFunction(data.undo),"Must provide a valid undo fn")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4393,g.isFunction(data.redo),"Must provide a valid redo fn")}catch(PERR){g.reportError(PERR)}this._registeredActions[ownerID][actionID]=data},_getOwner:function _getOwnerFn(action){try{g.PAssert(4394,this._registeredOwners[action.ownerID],"Must have previously registered owner")}catch(PERR){g.reportError(PERR)}return this._registeredOwners[action.ownerID]},_getActionData:function _getActionDataFn(action){try{g.PAssert(4395,this._registeredOwners[action.ownerID],"Must have previously registered owner")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4396,this._registeredActions[action.ownerID][action.actionID],"Must have previously registered action for owner")}catch(PERR){g.reportError(PERR)}return this._registeredActions[action.ownerID][action.actionID]},_useNextGroupID:function _useNextGroupIDFn(){return++this._groupID},_getCurrentGroup:function _getCurrentGroupFn(){return this._groups[this._cursor]},_createGroup:function _createGroupFn(actions){return{id:this._useNextGroupID(),events:actions||[]}},_pushNewGroup:function _pushNewGroupFn(actions){var group=this._createGroup(actions);this._groups.length>this._cursor+1&&(this._groups=this._groups.slice(0,this._cursor+1)),this._groups.push(group),this._cursor<this._maxSize-1&&this._cursor++,this._groups.length>this._maxSize&&this._trimAction()},_trimAction:function _trimActionFn(){this._groups.shift()},isUndoableAction:function isUndoableActionFn(){return!this._actionsPreventUndo},beginAction:function beginActionFn(preventUndo){if(0===this._aggregateActions){try{g.PAssert(4397,0===this._currentAction.length,"Current actions should be flushed")}catch(PERR){g.reportError(PERR)}this._actionsPreventUndo=!!preventUndo}this._aggregateActions++},runAction:function runActionFn(ownerID,actionID,params){var action={ownerID:ownerID,actionID:actionID},owner=this._getOwner(action),actionData=this._getActionData(action);return actionData.redo.apply(owner,params)},performAction:function performActionFn(ownerID,actionID,data){try{g.PAssert(4398,this._aggregateActions>0,"Must be in a begin/end action block")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4399,data,"Must provide valid data for the action")}catch(PERR){g.reportError(PERR)}this._currentAction.push({ownerID:ownerID,actionID:actionID,data:data})},performActions:function performActionsFn(actions){if(actions&&actions.length>0){this.beginAction();for(var i=0;i<actions.length;++i){var action=actions[i];this.performAction(action.ownerID,action.actionID,action.data)}this.endAction()}},endAction:function endActionFn(){1===this._aggregateActions&&(this._currentAction.length>0&&(this._pushNewGroup(this._currentAction),this._currentAction=[]),this._actionsPreventUndo=!1),this._aggregateActions=Math.max(0,this._aggregateActions-1)},undoAction:function undoActionFn(){if(this._cursor>=0)for(var group=this._groups[this._cursor--],i=group.events.length-1;i>=0;i--){var action=group.events[i],owner=this._getOwner(action),actionData=this._getActionData(action);actionData.undo.apply(owner,action.data.undoParams)}},redoAction:function redoActionFn(){if(this._cursor>=-1&&this._cursor<this._groups.length-1)for(var group=this._groups[++this._cursor],i=0;i<group.events.length;++i){var action=group.events[i],owner=this._getOwner(action),actionData=this._getActionData(action);actionData.redo.apply(owner,action.data.redoParams)}}},UndoStack}),define("GmailLabel",["require","exports","module","globals","Constants"],function(require,exports,module){function GmailLabel(accountID,labelID,name,oldestSync,options,labelStore){try{g.PAssert(4400,accountID,"Must specify a valid account ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4401,labelID,"Must specify a valid label ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4403,!oldestSync||g.isDateValid(oldestSync),"Must provide a valid oldestSync date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4404,labelStore,"Must supply a valid label store this label belongs to")}catch(PERR){g.reportError(PERR)}this._labelStore=labelStore,this._accountID=accountID,this._labelID=labelID,this._fullName=name,this._oldestSync=oldestSync,this._numUnread=0,this._ancestors=[],this._name=void 0,this._labelListVisibility=options&&options.labelListVisibility?options.labelListVisibility:C.LabelListVisibility.Show,this._messageListVisibility=options&&options.messageListVisibility?options.messageListVisibility:C.MessageListVisibility.Show,this._origLabelID=void 0
}var g=require("globals"),C=require("Constants"),RootLabelName="Moo.do",SystemLabelDisplayNames={INBOX:"Inbox",SPAM:"Spam",TRASH:"Trash",UNREAD:"Unread",STARRED:"Starred",IMPORTANT:"Important",SENT:"Sent Mail",DRAFT:"Draft",CHAT:"Chat",CATEGORY_PERSONAL:"Primary",CATEGORY_SOCIAL:"Social",CATEGORY_PROMOTIONS:"Promotions",CATEGORY_UPDATES:"Updates",CATEGORY_FORUMS:"Forums"},LabelDisplayPriority={INBOX:100,UNREAD:99,STARRED:98,IMPORTANT:97,SENT:96,DRAFT:95,"==MOODO_ARCHIVED==":94,TRASH:93,CATEGORY_PERSONAL:80,CATEGORY_SOCIAL:79,CATEGORY_PROMOTIONS:78,CATEGORY_UPDATES:77,CATEGORY_FORUMS:76},SpecialLabelDisplayNames={"==MOODO_ARCHIVED==":"Archived"},CategoryLabels={CATEGORY_PERSONAL:!0,CATEGORY_SOCIAL:!0,CATEGORY_PROMOTIONS:!0,CATEGORY_UPDATES:!0,CATEGORY_FORUMS:!0},NotDroppable={DRAFT:!0,CHAT:!0,SENT:!0,SPAM:!0};return GmailLabel.prototype={_getDisplayPriority:function _getDisplayPriorityFn(){return LabelDisplayPriority[this.getLabelID()]||-1},displayCompare:function displayCompareFn(other){var thisSpecial=this.isSystemOrSpecialLabel(),otherSpecial=other.isSystemOrSpecialLabel();return thisSpecial&&otherSpecial?this._getDisplayPriority()<other._getDisplayPriority()?1:-1:thisSpecial?-1:otherSpecial?1:this.getName().startsWith(other.getName())?-1:other.getName().startsWith(this.getName())&&!other.getName().startsWith(this.getName()+"/")?1:this.getName().localeCompare(other.getName())},isDropTarget:function isDropTargetFn(){return!NotDroppable[this.getLabelID()]},_getStoreLabel:function _getStoreLabelFn(labelName){var label,compName=labelName.toUpperCase();for(var id in this._labelStore)if(this._labelStore[id].getName().toUpperCase()===compName){label=this._labelStore[id];break}return label},_computeAncestors:function _computeAncestorsFn(){try{g.PAssert(4405,this._fullName||this.isSystemLabel()||this.isSpecialLabel(),"Must specify a valid fullName to run _computeAncestors")}catch(PERR){g.reportError(PERR)}if(this._ancestors=[],!this.isSystemLabel()&&!this.isSpecialLabel()&&this._fullName&&this._fullName.indexOf("/")>0)for(var parts=this._fullName.split("/"),candidate="",i=0;i<parts.length;++i){candidate+=parts[i];var candidateLabel=this._getStoreLabel(candidate);candidateLabel&&candidateLabel!==this?(this._ancestors.push(candidateLabel),candidate=""):i!==parts.length-1?candidate+="/":this._name=candidate}else this._name=this._fullName;try{g.PAssert(4406,this._ancestors.indexOf(this)<0,"Self should never be in the ancestors list")}catch(PERR){g.reportError(PERR)}},getAccountID:function getAccountIDFn(){return this._accountID},getLabelID:function getLabelIDFn(){return this._labelID},getRawName:function getRawNameFn(){return this._fullName},isMatched:function isMatchedFn(partial){try{g.PAssert(4407,g.isString(partial),"Must pass in a valid string for label name")}catch(PERR){g.reportError(PERR)}var isMatched=!1,rawName=this.getRawName();return partial&&rawName&&rawName.toUpperCase().indexOf(partial.toUpperCase())>=0&&(isMatched=!0),isMatched},isNamed:function isNamedFn(name){try{g.PAssert(4408,g.isString(name),"Must pass in a valid string for label name")}catch(PERR){g.reportError(PERR)}var isNamed=!1,rawName=this.getRawName();return name&&rawName&&(rawName===name||rawName.toUpperCase()===name.toUpperCase())&&(isNamed=!0),isNamed},getName:function getNameFn(){var fullName;if(SystemLabelDisplayNames[this.getLabelID()])fullName=SystemLabelDisplayNames[this.getLabelID()];else if(SpecialLabelDisplayNames[this.getLabelID()])fullName=SpecialLabelDisplayNames[this.getLabelID()];else if(this._fullName)fullName=this._fullName;else{try{g.PAssert(4409,!this.isLocalOnly(),"Should not have a local-only label without a name")}catch(PERR){g.reportError(PERR)}fullName=this.getLabelID()}return fullName||""},hasName:function hasNameFn(){return SystemLabelDisplayNames[this.getLabelID()]||SpecialLabelDisplayNames[this.getLabelID()]||!!this._fullName},clearOldestSync:function clearOldestSyncFn(){this._oldestSync=void 0},getOldestSync:function getOldestSyncFn(){return this._oldestSync},setOldestSync:function setOldestSyncFn(oldestSync){try{g.PAssert(4410,g.isDateValid(oldestSync),"Must provide a valid oldestSync date")}catch(PERR){g.reportError(PERR)}this._oldestSync=oldestSync},getMessageListVisibility:function getMessageListVisibilityFn(){return this._messageListVisibility},getLabelListVisibility:function getLabelListVisibilityFn(){return this._labelListVisibility},isLocalOnly:function isLocalOnlyFn(){return g.isTempId(this.getLabelID())},updateLabelID:function updateLabelIDFn(newID){try{g.PAssert(4412,this.isLocalOnly(),"Should only ever modify local labels")}catch(PERR){g.reportError(PERR)}this._origLabelID=this.getLabelID(),this._labelID=newID},updateLabelName:function updateLabelNameFn(newName){this._fullName=newName},getSaveData:function getSaveDataFn(){return{id:this.getLabelID(),name:this._fullName,oldestSync:this.getOldestSync(),messageListvisibility:this.getMessageListVisibility(),labelListVisibility:this.getLabelListVisibility()}},getDisplayText:function getDisplayTextFn(){var displayText;return this.getName()&&(displayText=this.getName().startsWith(RootLabelName+"/")?this.getName().substr(RootLabelName.length+1):this.getName()),displayText},matchesText:function matchesTextFn(text){return this.getDisplayText().toLowerCase().indexOf(text)>=0},hasAncestors:function hasAncestorsFn(){return this._fullName?this.getAncestors().length>0:!1},getAncestors:function getAncestorsFn(){return this._computeAncestors(),this._ancestors},getParent:function getParentFn(){var ancestors=this.getAncestors();return ancestors[ancestors.length-1]},isSystemLabel:function isSystemLabelFn(){return!!SystemLabelDisplayNames[this.getLabelID()]},isSpecialLabel:function isSpecialLabelFn(){return!!SpecialLabelDisplayNames[this.getLabelID()]},isSystemOrSpecialLabel:function isSystemOrSpecialLabelFn(){return this.isSystemLabel()||this.isSpecialLabel()},isCategoryLabel:function isCategoryLabelFn(){return!!CategoryLabels[this.getLabelID()]},isArchived:function isArchivedFn(){return"Archived"===this.getName()},isStarred:function isStarredFn(){return"Starred"===this.getName()},isInbox:function isInboxFn(){return"Inbox"===this.getName()},isDraft:function isDraftFn(){return"Draft"===this.getName()},isTrash:function isTrashFn(){return"Trash"===this.getName()},isCustom:function isCustomFn(){return!this.isSystemLabel()&&!this.isSpecialLabel()},getUnreadCount:function getUnreadCountFn(){return this._numUnread},shouldDisplayInLabelList:function shouldDisplayInLabelListFn(){var shouldDisplay=!1;return this.getLabelListVisibility()===C.LabelListVisibility.Show?shouldDisplay=!0:this.getLabelListVisibility()===C.LabelListVisibility.ShowIfUnread&&this.getUnreadCount()>0&&(shouldDisplay=!0),shouldDisplay},shouldDisplayInMessageList:function shouldDisplayInMessageListFn(){return this._messageListVisibility===C.MessageListVisibility.Show}},GmailLabel}),define("RFC822Message",["require","exports","module","globals","EmailHTML"],function(require,exports,module){function RFC822Message(plugin){this._plugin=plugin,this._headers=[],this._mimeTree=void 0}var g=require("globals"),EmailHTML=require("EmailHTML"),idx=0;return RFC822Message.prototype={reset:function resetFn(){this._headers=[],this._mimeTree=void 0},getMessageText:function getMessageTextFn(draft,includeAttachments){return draft.decoded},updateFromDraft:function updateFromDraftFn(thread,draft,fromName,fromEmail,includeAttachments,cb){this.reset(),this.addHeader("From",this._plugin._formatAddressText(fromName,fromEmail,!0)),this.addHeader("To",this._plugin._createAddressTextFromTokens(draft.to,!0)),draft.cc&&this.addHeader("Cc",this._plugin._createAddressTextFromTokens(draft.cc,!0)),draft.bcc&&this.addHeader("Bcc",this._plugin._createAddressTextFromTokens(draft.bcc,!0)),this.addHeader("X-Mailer","Moo.do (https://moo.do)"),this.addHeader("Subject",g.encodeMIMEHeader(draft.subject||"(no subject)"));var replyMsg;if(draft.inReplyTo){this.addHeader("In-Reply-To",draft.inReplyTo.trim()),this.addHeader("References",draft.references.trim());var replyMsgIndex=thread.messages.indexOfWithProperty("messageID",draft.inReplyTo);try{g.PAssert(4413,replyMsgIndex>=0,"Must always be able to find the message being replied to")}catch(PERR){g.reportError(PERR)}replyMsg=thread.messages[replyMsgIndex]}var plaintext=EmailHTML.generatePlaintext(this.getMessageText(draft,includeAttachments),{}),optRootPart,attachedResources=this._getAttachedResources(draft);if(attachedResources.length>0&&(optRootPart=this.createMimePart("multipart/mixed"),this.addMimePart(optRootPart)),plaintext){var rootPart=this.createMimePart("multipart/alternative");this.addMimePart(rootPart,optRootPart);var plainPart=this.createMimePart("text/plain",plaintext,"7bit");this.addMimePart(plainPart,rootPart);var inlineResources=this._getInlineResources(draft);if(inlineResources.length>0){var relatedPart=this.createMimePart("multipart/related");this.addMimePart(relatedPart,rootPart);var htmlPart=this.createMimePart("text/html",this.getMessageText(draft,includeAttachments),"7bit");this.addMimePart(htmlPart,relatedPart);for(var i=0;i<inlineResources.length;++i){var res=inlineResources[i],resPart=this.createResourcePart(res);resPart&&this.addMimePart(resPart,relatedPart)}}else{var htmlPart=this.createMimePart("text/html",this.getMessageText(draft,includeAttachments),"7bit");this.addMimePart(htmlPart,rootPart)}}else{var rootPart=this.createMimePart(draft.contentType,this.getMessageText(draft,includeAttachments),"7bit");this.addMimePart(rootPart,optRootPart)}if(optRootPart&&includeAttachments)for(var numLoaded=0,onResourceLoaded=function(){if(++numLoaded===attachedResources.length){for(var i=0;i<attachedResources.length;++i){var res=attachedResources[i],resPart=this.createResourcePart(res);resPart&&this.addMimePart(resPart,optRootPart)}cb()}}.bind(this),i=0;i<attachedResources.length;++i)this._plugin.loadResource(thread.id,draft.id,attachedResources[i].cid,onResourceLoaded);else setTimeout(cb,0)},_getInlineResources:function _getInlineResourcesFn(draft){var resources=[];for(var id in draft.resources)"inline"===draft.resources[id].disposition&&resources.push(draft.resources[id]);return resources},_getAttachedResources:function _getAttachedResourcesFn(draft){var resources=[];for(var id in draft.resources){var res=draft.resources[id];"attachment"===res.disposition&&res.id&&resources.push(res)}return resources},addHeader:function addHeaderFn(name,value){try{g.PAssert(4414,value.indexOf("\n")<0,"Header should not have a newline: "+name)}catch(PERR){g.reportError(PERR)}var safeValue=value.trim().replace(/[\r\n]/g,"");this._headers.push(name+": "+safeValue)},_generateBoundary:function _generateBoundaryFn(){return"=========3141592653589moodo"+Date.now()+ ++idx},createMimePart:function createMimePartFn(contentType,content,contentEncoding,contentDisposition){try{g.PAssert(4415,contentType,"Must supply a valid content type")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4416,void 0===content||contentEncoding,"Must supply a valid content encoding")}catch(PERR){g.reportError(PERR)}var part={boundary:this._generateBoundary(),contentType:contentType,content:content,contentEncoding:contentEncoding,contentDisposition:contentDisposition,children:[]};return part},createResourcePart:function createResourcePartFn(res){try{g.PAssert(4417,res&&res.data,"Must have valid data loaded for resource to embed it in message")}catch(PERR){g.reportError(PERR)}var part;if(res&&res.data){var contentType=res.mimeType+'; name="'+res.cid+'"',contentDisposition=res.disposition+'; filename="'+res.cid+'"';part=this.createMimePart(contentType,res.data,res.contentEncoding,contentDisposition),part.contentID=res.cid}return part},addMimePart:function addMimePartFn(part,parentPart){try{g.PAssert(4418,part,"Must supply a valid mime part")}catch(PERR){g.reportError(PERR)}if(parentPart)parentPart.children.push(part);else{try{g.PAssert(4419,!this._mimeTree,"Must not yet have a valid mime tree root")}catch(PERR){g.reportError(PERR)}this._mimeTree=part}},_mimePartToBlob:function _mimePartToBlobFn(part){function addPartHeader(name,value){if(value){try{g.PAssert(4420,value.indexOf("\n")<0,"Header should not have a newline: "+name)}catch(PERR){g.reportError(PERR)}var safeValue=value.trim().replace(/[\r\n]/g,"");partHeaders.push(name+": "+safeValue)}}var blob="\r\n",partHeaders=[],contentType=part.contentType;if(part.content||(contentType+='; boundary="'+part.boundary+'"'),addPartHeader("MIME-Version","1.0"),addPartHeader("Content-Type",contentType),addPartHeader("Content-Transfer-Encoding",part.contentEncoding),addPartHeader("Content-Disposition",part.contentDisposition),part.contentID){var contentID="<"+part.contentID+">";addPartHeader("Content-ID",contentID)}if(blob=partHeaders.join("\r\n").trim(),blob+="\r\n",part.content)blob+="\r\n"+part.content+"\r\n";else{for(var i=0;i<part.children.length;++i)blob+="\r\n--"+part.boundary+"\r\n",blob+=this._mimePartToBlob(part.children[i]);blob+="--"+part.boundary+"--\r\n"}return blob},generateBlob:function generateBlobFn(){var blob=this._headers.join("\r\n").trim();return blob+="\r\n"+this._mimePartToBlob(this._mimeTree)}},RFC822Message}),define("plugins/Plugin_Gmail_Pane",["require","exports","module","globals","data","Constants","platform","util","tracker","Observable","Dispatcher","Measure","AccountManager","EmailPreview","Autocomplete","Multiselect","VMPane"],function(require,exports,module){function Plugin_Gmail_Pane(p){this.isInitializing=!0,this.plugin=g.vmMain.pluginManager.getPlugin(PluginID.Gmail),this.searchFilters=[{name:"unread",initialValue:1,icon:"icon-unread",remoteStringFn:this._remoteFnUnread.bind(this),matchFn:this._matchFnUnread.bind(this)},{name:"starred",initialValue:1,icon:"icon-star",remoteStringFn:this._remoteFnStarred.bind(this),matchFn:this._matchFnStarred.bind(this)},{name:"priority",remoteStringFn:this._remoteFnPriority.bind(this),matchFn:this._matchFnPriority.bind(this)},{name:"category",remoteStringFn:this._remoteFnCategory.bind(this),matchFn:this._matchFnCategory.bind(this)}],this.type=this.plugin._paneType,this.paneClass="panePlugin paneGmail noSelect",this.contextMenu="contextMenuItem_Gmail",this.paneEmptyMessage="No emails here",this.paneEmptySearchMessageDefault="Press enter to search",this.paneEmptySearchMessage=this.paneEmptySearchMessageDefault,this.overviewEmptyMessage="No labels",this.dropEffect=function(){return C.DropEffect.Copy},this.isWriteable=!1,this.overrideCopyBehavior=!1,this.supportCollapsing=!1,this.supportCompleting=!0,this.supportOffline=!1,this.supportPerformArchive=!1,this.supportDataRefresh=!0,this.supportReportError=!0,this.supportCompose=!0,this.supportPagination=!0,this.supportBullets=!1,this.supportVertLines=!1,this.supportSearchItemAutocomplete=!1,this.supportSearchListenTextChanges=!1,this.supportLocalSearch=!1,this.supportClone=!1,this.supportDeferredItemLoad=!0,this.shouldSearchMatchParents=!1,this.noOverviewStyle=!0,this.supportStarClick=!0,this.supportClickOverviewScroll=!1,this.overviewTracksScroll=!1,this.overviewPadLevels=-1,this.maxWidth=C.GmailPaneMaxWidth,this.setPropDefault("pluginCursor",function(){return"default"}),this._super.constructor.call(this,p),this.dragMarginTop=25,this.topBoxHeight.set(0,!1),this.blocks=[],this.blocksByKey={},this._focusedTrash=!1,this.shouldCheckHeight=!0,this.maxScrollOffset=0,this.selectedIndex=new Observable(-1,this.onSelectedIndexChanged.bind(this)),this._isSearchingRemote=new Observable(!1),this._currentSearch=void 0,this._ignoreRestoreScroll=!0,this._failedPageRequest=new Observable(!1),this.sortType=new Observable(p.sortType||C.GmailSortType.TimeReceived),this.item.listen(this._onItemChange.bind(this)),this.sortType.listen(this._onSortChange.bind(this)),util.forceBind("onScroll",this),util.forceBind("_runRemoteSearch",this),util.forceBind("searchCompare",this),util.forceBind("onTopTextChanged",this),util.forceBind("headerSearchCompare",this),util.forceBind("onMultiselectReset",this),Multiselect.listen("reset",this.onMultiselectReset),this.initGmail(),p.isExpanded&&(EmailPreview.startOpenOnLoad(this),this._needsSelectFirst=!0),this.isInitializing=void 0}var g=require("globals"),d=require("data"),C=require("Constants"),platform=require("platform"),util=require("util"),tracker=require("tracker"),Observable=require("Observable"),Dispatcher=require("Dispatcher"),Measure=require("Measure"),AccountManager=require("AccountManager"),EmailPreview=require("EmailPreview"),Autocomplete=require("Autocomplete"),Multiselect=require("Multiselect"),VMPane=require("VMPane"),searchDelay=2500,researchDelay=5e3,Plugin_Gmail_PaneFns={initGmail:function initGmailFn(){this.search.isSearched()&&this.onSearchChanged(!0),this._onItemChange(this.getItem()),this._searchTimeout=void 0,this._lastSearchValue=void 0,this._lastSearchTime=0,this.paneTopText.listen(this.onTopTextChanged),Dispatcher.listen("EmailCompose","onClosed",util.forceBind("onEmailComposeClosed",this))},destroy:function destroyFn(){clearTimeout(this._searchTimeout),this._searchTimeout=void 0,this.paneTopText.unlisten(this.onTopTextChanged),Dispatcher.unlisten("EmailCompose","onClosed",this.onEmailComposeClosed),this._super.destroy.call(this)},onLoad:function onLoadFn(e){this._super.onLoad.call(this,e),this.addScrollListener(this.onScroll)},notifyPluginLoaded:function notifyPluginLoadedFn(){var state=this.deferredItemState;if(state){var item=this.getItemStore().getItem(state.itemID);item&&this.setItem(item,!0)}},getItemStore:function getItemStoreFn(){return this.plugin.getActiveItemStore(this.id)},getRootItem:function getRootItemFn(){var itemStore=this.getItemStore();return itemStore?itemStore.getRoot():void 0},getDefaultDisplayItem:function getDefaultDisplayItemFn(){return this.plugin.getDefaultDisplayItem()},searchCompare:function searchCompareFn(item){var isValid=!1;return g.vmMain.isOnline()?(!this.isSearched()||!this.isLoading.get()&&this.paneTopText.get()||this.isRemoteSearchActive())&&this.plugin.isDisplayItem(item,this._focusedTrash)&&(isValid=!0):this.search.isMatched(item,!1)&&this.plugin.isDisplayItem(item,this._focusedTrash)&&(isValid=!0),isValid},getItemSearchParams:function getItemSearchParamsFn(){var focusLabel=this.plugin.getLabelForVMLI(this.getItem());return this._focusedTrash=focusLabel&&focusLabel.isTrash(),{item:this.getItem(),comparator:this.searchCompare,pane:this}},headerSearchCompare:function headerSearchCompareFn(item){if(this.plugin.isLabelItem(item)){var label=this.plugin.getLabelForVMLI(item);return!label||label.shouldDisplayInLabelList()}return this.plugin.isAccountItem(item)?!0:!1},getHeaderSearchParams:function getHeaderSearchParamsFn(){return{item:this.plugin.getDefaultItemStore().getRoot(),comparator:this.headerSearchCompare,noCollapsed:!0,collapseAfterDepth:this.plugin.numSyncAccounts()>1?0:0/0,overview:!0,pane:this}},saveSelection:function saveSelectionFn(){return Multiselect.getSelectedItems(this)},restoreSelection:function restoreSelectionFn(selectedItems){if(selectedItems.length>0){for(var indices=[],i=0;i<selectedItems.length;i++){var index=this.indexOfItem(selectedItems[i]);index>=0&&indices.push(index)}if(indices.length>1)this.selectedIndex.set(indices[0],!1),Multiselect.setSelected(indices,this);else if(1===indices.length)this.selectIndex(indices[0]);else{var index=this.selectedIndex.get();index>=this.numItems()&&(index=this.numItems()-1),this.selectIndex(index,!0)}}},setItems:function setItemsFn(items,forceNotify){if(!items.equals(this._allItems)){var savedSelection=this.saveSelection(),displayItems=[],itemMap={},sortFn=this.sortType.get()===C.GmailSortType.TimeReceived?this.plugin.threadSortFn:this.plugin.threadSortPriorityFn;this._allItems=items;for(var i=0;i<this._allItems.length;++i){var item=this._allItems[i],threadID=this.plugin._getThreadIDFromItem(item);threadID&&!itemMap[threadID]&&(displayItems.insertSorted(item,sortFn),itemMap[threadID]=!0)}this.items.set(displayItems),this.restoreSelection(savedSelection),this._needsSelectFirst&&items.length>0&&(this.selectIndex(0),this._needsSelectFirst=!1)}},setHeaders:function setHeadersFn(headers,forceNotify){this._allHeaders=headers;for(var displayHeaders=[],accounts={},accountItems={},i=0;i<this._allHeaders.length;++i){var header=this._allHeaders[i],accountID=this.plugin._getAccountIDFromItem(header);if(accounts[accountID]||(accounts[accountID]=[]),this.plugin.isAccountItem(header))accountItems[accountID]=header;else{var accountGroup=accounts[accountID];this.plugin.isDisplayHeader(header)&&accountGroup.insertSorted(header,this.plugin.labelVMLISortFn)}}var count=0;for(var accountID in accounts){var accountHeaders=accounts[accountID];count>0&&displayHeaders.push({type:"hr",id:"hr"+accountID+"x",heightInPane:this.heightOverviewHR}),count++;var accountItem=accountItems[accountID];try{g.PAssert(4421,accountItem,"Must have valid account item")}catch(PERR){g.reportError(PERR)}if(accountItem){displayHeaders.push(accountItem);for(var i=1;i<accountHeaders.length;++i){var label1=this.plugin.getLabelForVMLI(accountHeaders[i-1]),label2=this.plugin.getLabelForVMLI(accountHeaders[i]);displayHeaders.push(accountHeaders[i-1]),(label1.isSystemOrSpecialLabel()&&!label2.isSystemOrSpecialLabel()||!label1.isCategoryLabel()&&label2.isCategoryLabel())&&displayHeaders.push({type:"hr",id:"hr"+accountID+i,heightInPane:this.heightOverviewHR})}}}this.headers.set(displayHeaders)},heightOverviewHR:function heightOverviewHRFn(){return 4},getTitleList:function getTitleListFn(){if(this.getItem().isDescendantOf(this.getRootItem())){var info=this.plugin.getDescriptorForItem(this.getItem()),accountItem=this.plugin.getVMLIForAccount(info.accountID);return accountItem===this.getItem()?[this.getRootItem(),this.getItem(),"Everything"]:this.plugin.numSyncAccounts()>1?[this.getRootItem(),accountItem,this.getItem()]:[this.getRootItem(),this.getItem()]}return[this.getItem()]},onClickTitle:function onClickTitleFn(e,item){this.plugin.isAccountItem(item)?item=this.plugin.getDefaultDisplayItem(this.plugin._getAccountIDFromItem(item)):item===this.getRootItem()?item=this.plugin.getDefaultDisplayItem(this.plugin._getAccountIDFromItem(this.getItem())):this.plugin.isLabelItem(item)||(item=this.plugin.getDefaultDisplayItem()),this._super.onClickTitle.call(this,e,item)},onTopTextChanged:function onTopTextChangedFn(){this.topBoxHeight.set(this.paneTopText.get()?36:0)},searchACName:function searchACNameFn(){return void 0},getPaneIcon:function getPaneIconFn(){return this.plugin.getPaneIcon()},requestDataPage:function requestDataPageFn(item){this.isLoadingNewPage.set(!0),this.plugin.requestDataPage(item,this.onDataPagedIn.bind(this))},dropEffectCopyBehavior:function dropEffectCopyBehaviorFn(copyItem,targetItem){try{g.PAssert(4422,!copyItem.belongsToSameItemStore(targetItem),"Dropping onto a Gmail pane is not supported")}catch(PERR){g.reportError(PERR)}return this.plugin.createOutlinePaneItem(copyItem,targetItem)},refreshPaneData:function refreshPaneDataFn(){this.plugin.refreshCurrentView(this.id)},reportPaneError:function reportPaneErrorFn(){g.menus.openModal(Modals.ReportBug)},_onItemChange:function _onItemChangeFn(newItem){Multiselect.reset(this),this._clearCurrentSearch();var focusLabel=this.plugin.getLabelForVMLI(newItem);this._focusedTrash=focusLabel&&focusLabel.isTrash(),newItem.hasPaginationToken()||this.plugin.handleItemChange(newItem,function(){this.isLoading.set(!1)}.bind(this)),this.isInitializing||(this.numItems()>0?this.selectIndex(0):this._needsSelectFirst=!0)},_onSortChange:function _onSortChangeFn(newSort){Multiselect.reset(this),this.plugin.handleSortChange(this.getItem(),newSort),setTimeout(function(){this.numItems()>0&&this.selectIndex(0)}.bind(this),0),g.vmMain.paneManager.updatePaneStateForPane(this),this.setScrollOffset(0)},getItemLabel:function getItemLabelFn(useActual){var item=useActual?this.getActualPaneItem():this.getItem();return this.plugin.getLabelForVMLI(item)},onDataPagedIn:function onDataPagedInFn(success){this._failedPageRequest.set(success?!1:!0),this.isLoadingNewPage.set(!1)},onScroll:function onScrollFn(e){if(!this.isLoadingNewPage.get()&&!this.isSearched()){var maxScrollOffset=this._infiniteList.getMaxScrollOffset(),scroll=this.getScrollOffset();scroll>=maxScrollOffset&&this.requestDataPage(this.getItem())}},_matchFnUnread:function _matchFnUnreadFn(filterValue,item,matchState){var isUnread=this.plugin.isItemUnread(item);return filterValue?isUnread&&filterValue>0||!isUnread&&0>filterValue?C.MatchState.Yes:C.MatchState.No:void 0},_matchFnStarred:function _matchFnStarredFn(filterValue,item,matchState){var isStarred=this.plugin.isItemStarred(item);if(filterValue){var ret=isStarred&&filterValue>0||!isStarred&&0>filterValue?C.MatchState.Yes:C.MatchState.No;return ret}},_matchFnPriority:function _matchFnPriorityFn(filterValue,item,matchState){var priority=this.plugin.getItemPriority(item);return priority>=filterValue?C.MatchState.Yes:C.MatchState.No},_matchFnCategory:function _matchFnCategoryFn(filterValue,item,matchState){return filterValue?this.plugin.itemHasLabel(item,filterValue)?C.MatchState.Yes:C.MatchState.No:C.MatchState.Yes},_remoteFnUnread:function _remoteFnUnreadFn(val){var remoteStr;switch(val){case-1:remoteStr="-in:trash -is:unread";break;case 1:remoteStr="-in:trash is:unread";break;default:remoteStr=""}return remoteStr},_remoteFnStarred:function _remoteFnStarredFn(val){var remoteStr;switch(val){case-1:remoteStr="-is:starred";break;case 1:remoteStr="is:starred";break;default:remoteStr=""}return remoteStr},_remoteFnPriority:function _remoteFnPriorityFn(val){var remoteStr;switch(val){case VMLIFlag.P0:remoteStr="label:Moo.do/Priority High";break;case VMLIFlag.P1:remoteStr="label:Moo.do/Priority Medium";break;case VMLIFlag.P2:remoteStr="label:Moo.do/Priority Low";break;default:remoteStr=""}return remoteStr},_remoteFnCategory:function _remoteFnCategoryFn(val){return val?"category:"+val:""},bottomListMessage:function bottomListMessageFn(){var listMessage;return this.getItem().hasPaginationToken()&&(listMessage=this._failedPageRequest.get()?"RETRY LOAD":this.isLoadingNewPage.get()||this.getItem().paginationTokenInUse()?"Loading...":"Click to load more emails"),listMessage},_onRemoteDataLoaded:function _onRemoteDataLoadedFn(){},heightOfItem:function heightOfItemFn(item,overview){return"blockHeader"===item.type?40:overview?this._super.heightOfItem.call(this,item,overview):overview?Measure.lineItemHeight(item,1):86},onClickItem:function onClickItemFn(index,item,e){g.vmMain.activeInput.get()&&g.vmMain.activeInput.get().blur();var passClick=!0;if((platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&Multiselect.getSelected(this).length>0)Multiselect.toggleSelected(index,this),passClick=!1;else if(e.shiftKey){var first=Multiselect.getFirstSelectedIndex(this),last=Multiselect.getLastSelectedIndex(this);first>index?first=index:index>last&&(last=index),Multiselect.selectInOrder(first,last,this),passClick=!1}else if(g.hasClass(e.target,"emailLabel")){var text=e.target.textContent,attach=item.getAttachmentByPlugin(this.plugin.id),accountID=attach.getField("accountID"),label=this.plugin._getLabelByName(accountID,text);try{g.PAssert(4423,label,"Must be able to get a valid label if clicking a valid label: ",text)}catch(PERR){g.reportError(PERR)}if(label){var itemZoom=this.plugin.getVMLIForLabel(accountID,label);g.vmMain.zoomin(itemZoom),passClick=!1}}else g.hasClass(e.target,"itemCheckbox")||this.selectIndex(index);passClick&&item.onClick(index,e)},onRightClickItem:function onRightClickItemFn(index,item,e){(Multiselect.numSelectedInPane(this)<=1||!Multiselect.isSelected(index,this))&&this.selectIndex(index),g.menus.openItemMenu(item,e),e.preventDefault(),e.stopPropagation()},handleRightSideTap:function handleRightSideTapFn(item){if(item&&item.hasPluginAttachment(this.plugin.id)){var attach=item.getAttachmentByPlugin(this.plugin.id),label=this.getItemLabel(!0),archive=label.isArchived()?!1:!0;this.archiveItem(archive,item),label.isInbox()||label.isArchived()||this.removeItemFromCurrentLabel(item);var index=this.selectedIndex.get();index>=this.numItems()&&(index=this.numItems()-1),this.selectIndex(index,!0)}},onMultiselectReset:function onMultiselectResetFn(pane){this===pane&&this.selectedIndex.set(-1)},selectIndex:function selectIndexFn(index,notify){var oldSel=this.selectedIndex.get();this.selectedIndex.set(index,notify),index>=0?Multiselect.setSelected([index],this):Multiselect.reset(this),(notify||oldSel!==index)&&this.selectedIndex.notify()},selectItem:function selectItemFn(item,notify){if(item){var index=this.indexOfItem(item);index>=0&&this.selectIndex(index,notify)}else this.selectIndex(-1,notify)},onSelectedIndexChanged:function onSelectedIndexChangedFn(index,prevIndex){if(index>=0&&EmailPreview.isOpen()){var item=this.itemAtIndex(index);this.openEmailByItem(item)}else 0>index&&EmailPreview.reset()},openEmailByItem:function openEmailByItemFn(item){if(item&&item.hasPluginAttachment(this.plugin.id)){var attach=item.getAttachmentByPlugin(this.plugin.id);attach===EmailPreview.getThreadAttach()&&EmailPreview.isOpenOnPane(this)||this.plugin.openEmailByID(attach.id,this)}},_runRemoteSearch:function _runRemoteSearchFn(){if(g.vmMain.paneManager.isPaneActive(this.id)){clearTimeout(this._searchTimeout),this._searchTimeout=void 0;var search=this.search.getRemoteValue(),desc=this.plugin.getDescriptorForItem(this.item.get());if(desc.labelID){var paneLabel=this.plugin._getLabelByID(desc.accountID,desc.labelID);!paneLabel.isSpecialLabel()&&paneLabel.hasName()&&(search+=" label:"+paneLabel.getName())}this._lastSearchValue=search,this._lastSearchTime=Date.now(),this.paneEmptySearchMessage="",this.paneTopText.set("Searching..."),this._isSearchingRemote.set(!0),this._clearCurrentSearch(),this._currentSearch=this.plugin.runSearch(search,this.id,!0,function(status){if(this._isSearchingRemote.get())switch(this.paneEmptySearchMessage=status===SearchResultStatus.Done?this.paneEmptySearchMessageDefault:"",this.isLoading.set(!1),status){case SearchResultStatus.Done:this.paneTopText.set(""),this.setScrollOffset(0);break;case SearchResultStatus.TooMany:this.paneTopText.set("Too many search results! Be more specific.");break;case SearchResultStatus.None:this.paneTopText.set("There were no search results");break;case SearchResultStatus.Error:this.paneTopText.set("There was an error running your search, try again.");break;default:try{g.PAssert(4424,!1,"Invalid search state: ",status)}catch(PERR){g.reportError(PERR)}}}.bind(this))}},_clearCurrentSearch:function _clearCurrentSearchFn(){this._currentSearch&&(this._currentSearch.invalidate(),this._currentSearch=void 0)},onSearchChanged:function onSearchChangedFn(force){var selectedItem=this.items.get()[this.selectedIndex.get()],search=this.search.getRemoteValue();if(search!==this._lastSearchValue||Date.now()-this._lastSearchTime>researchDelay)if(clearTimeout(this._searchTimeout),this._searchTimeout=void 0,search){var actualDelay=force?0:searchDelay;this._searchTimeout=setTimeout(this._runRemoteSearch,actualDelay)}else this._isSearchingRemote.set(!1),this.plugin.clearSearch(this.id),this._clearCurrentSearch(),this.isLoading.set(!1),this.paneTopText.set("")},isSearchingRemote:function isSearchingRemoteFn(){return this._isSearchingRemote.get()},isRemoteSearchActive:function isRemoteSearchActiveFn(){return this.plugin.isRemoteSearchBucketActive(this.id)},onEmailComposeClosed:function onEmailComposeClosedFn(){var plugin=this.plugin,accountID=plugin.getDefaultAccount(),label=plugin._getLabelByID(accountID,plugin.SystemLabels.DRAFT),draftItem=plugin.getVMLIForLabel(accountID,label);this.item.get()===draftItem&&this.selectIndex(-1)},applyToSelection:function applyToSelectionFn(fn,options){var savedSelection=this.saveSelection();Multiselect.applyFnToSelected(fn,this),this.restoreSelection(savedSelection)},_autocompletePopup:function _autocompletePopupFn(params,itemCB,doneCB){if(!params.elementDisplay){var index=Multiselect.getFirstSelectedIndex(this),element=this.elementAtIndex(index);
params.elementDisplay=element}params.onSelected=function(params){this.plugin.beginAction(),Multiselect.applyFnToSelected(function(item){itemCB(item,params)},this),doneCB&&doneCB(),this.plugin.endAction()}.bind(this),Autocomplete.showPopup(params)},getPaddingForItem:function getPaddingForItemFn(item,overview){return overview?this._super.getPaddingForItem.call(this,item,overview):30},getWidth:function getWidthFn(){return this.rect.get().width},autocompleteLabel:function autocompleteLabelFn(params,removedCB){params=params||{};var tags;Multiselect.applyFnToSelected(function(item){var attach=item.getAttachments()[0],itemTags=attach.getPlugin().getDisplayTags(attach);tags=tags?g.arrayIntersection(tags,itemTags):itemTags},this),params.tokens=(tags||[]).map(function(tag){return{text:tag}}),this._super.autocompleteLabel.call(this,params,function(tagObj){var tag=tagObj.text;this.plugin.beginAction(),Multiselect.applyFnToSelected(function(item){var attach=item.getAttachmentByPlugin(this.plugin.id);if(this.plugin.attachmentHasLabel(attach,tag))this.plugin.performAction(C.PluginAction.Gmail.RemoveLabel,!1,attach,tag);else try{g.PAssert(4426,!1,"Tried to remove a tag from an attachment without a tag")}catch(PERR){g.reportError(PERR)}}.bind(this),this),this.plugin.endAction(),removedCB&&removedCB(tagObj)}.bind(this))},_moveItem:function _moveItemFn(item,target,noClone){noClone||(item=item.clone(target,ChangeType.Local));var attach=item.getAttachmentByPlugin(this.plugin.id);try{g.PAssert(4427,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}this.plugin.beginAction(),this.plugin.performAction(C.PluginAction.Gmail.Move,!1,attach,item,target),this.plugin.getSetting(this.plugin.Settings.ArchiveOnOrganize)&&this.plugin.performAction(C.PluginAction.Gmail.Archive,!1,attach),this.plugin.endAction()},autocompleteSchedule:function autocompleteScheduleFn(params,doneCB){var index=this.selectedIndex.get();this._super.autocompleteSchedule.call(this,params,function(){index>=this.numItems()&&(index=this.numItems()-1),this.selectIndex(index,!0),doneCB&&doneCB()}.bind(this))},autocompleteSnooze:function autocompleteSnoozeFn(params,accountID,doneCB){if(!accountID){var item=Multiselect.getFirstSelectedItem();if(item){var attach=item.getAttachments()[0];attach&&(accountID=attach.getField("accountID"))}}if(accountID){var index=this.selectedIndex.get();this._super.autocompleteSnooze.call(this,params,accountID,function(){index>=this.numItems()&&(index=this.numItems()-1),this.selectIndex(index,!0),doneCB&&doneCB()}.bind(this))}},autocompleteMove:function autocompleteMoveFn(params,doneCB){var index=this.selectedIndex.get();this._super.autocompleteMove.call(this,params,function(){index>=this.numItems()&&(index=this.numItems()-1),this.selectIndex(index,!0),doneCB&&doneCB()}.bind(this))},toggleStarSelected:function toggleStarSelectedFn(){var action;this.plugin.beginAction(),this.applyToSelection(function(item){var attach=item.getAttachments()[0];try{g.PAssert(4428,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}var plugin=attach.getPlugin(),isStarred=plugin.isItemStarred(item);void 0===action&&(action=isStarred?C.PluginAction.Gmail.Unstar:C.PluginAction.Gmail.Star),(isStarred&&action===C.PluginAction.Gmail.Unstar||!isStarred&&action===C.PluginAction.Gmail.Star)&&this.plugin.performAction(action,!1,attach),this.updateItems()}.bind(this)),this.plugin.endAction()},toggleStar:function toggleStarFn(item){var attach=item.getAttachments()[0];try{g.PAssert(4429,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}var plugin=attach.getPlugin();plugin.isItemStarred(item)?plugin.performAction(C.PluginAction.Gmail.Unstar,!1,attach):plugin.performAction(C.PluginAction.Gmail.Star,!1,attach),this.updateItems()},markReadSelected:function markReadSelectedFn(val){var action=val?C.PluginAction.Gmail.MarkRead:C.PluginAction.Gmail.MarkUnread;this.plugin.beginAction(),this.applyToSelection(function(item){var attach=item.getAttachments()[0];try{g.PAssert(4430,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}var plugin=attach.getPlugin();(val&&plugin.isItemUnread(item)||!val&&!plugin.isItemUnread(item))&&this.plugin.performAction(action,!1,attach)}.bind(this)),this.plugin.endAction()},_openSelectedInMode:function _openSelectedInModeFn(mode){var index=Multiselect.getFirstSelectedIndex(this);if(this.selectIndex(index),EmailPreview.isOpen())EmailPreview.setLastMessageResponseMode(mode);else{var cb=function(messages){if(messages.length>0){EmailPreview.messages.unlisten(cb);var lastMessage=messages[messages.length-1];lastMessage.labelIds.indexOf("DRAFT")<0&&EmailPreview.setLastMessageResponseMode(mode)}};EmailPreview.messages.listen(cb);var item=this.itemAtIndex(index);this.openEmailByItem(item)}},replySelected:function replySelectedFn(){this._openSelectedInMode(C.EmailResponseMode.Reply)},replyAllSelected:function replyAllSelectedFn(){this._openSelectedInMode(C.EmailResponseMode.ReplyAll)},forwardSelected:function forwardSelectedFn(){this._openSelectedInMode(C.EmailResponseMode.Forward)},archiveSelected:function archiveSelectedFn(value){this.plugin.beginAction(),this.applyToSelection(this.archiveItem.bind(this,value)),this.plugin.endAction()},archiveItem:function archiveItemFn(value,item){var attach=item.getAttachmentByPlugin(this.plugin.id);try{g.PAssert(4431,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}!value&&this.plugin.isItemArchived(item)?this.plugin.performAction(C.PluginAction.Gmail.Unarchive,!1,attach):value&&!this.plugin.isItemArchived(item)&&this.plugin.performAction(C.PluginAction.Gmail.Archive,!1,attach)},deleteSelected:function deleteSelectedFn(comparator,value){this.plugin.beginAction(),this.applyToSelection(function(item){var attach=item.getAttachmentByPlugin(this.plugin.id);try{g.PAssert(4432,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}var focusedLabel=this.plugin.getLabelForVMLI(this.getItem());value&&focusedLabel&&focusedLabel.isDraft()&&this.plugin.itemHasDraft(item)?this.plugin.performAction(C.PluginAction.Gmail.DiscardDraft,!0,attach):!value&&this.plugin.isItemFullTrashed(item)?this.plugin.performAction(C.PluginAction.Gmail.Untrash,!1,attach):value&&!this.plugin.isItemFullTrashed(item)&&this.plugin.performAction(C.PluginAction.Gmail.Trash,!1,attach)}.bind(this)),this.plugin.endAction()},applyPriorityToSelection:function applyPriorityToSelectionFn(pri,toggle){var val=pri,first=!0;this.plugin.beginAction(),this.applyToSelection(function(item){var attach=item.getAttachments()[0];try{g.PAssert(4433,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}toggle&&first&&(this.plugin.getAttachmentPriority(attach)===pri&&(val=VMLIFlag.None),first=!1),this.plugin.performAction(C.PluginAction.Gmail.SetPriority,!1,attach,val),this.updateItems()}.bind(this)),this.plugin.endAction()},handleUndo:function handleUndoFn(){this.plugin.handleUndo()},handleRedo:function handleRedoFn(){this.plugin.handleRedo()},keyMoveDown:function keyMoveDownFn(e){if(e.shiftKey)if(Multiselect.isInverted(this)&&1===Multiselect.numSelectedInPane(this)&&Multiselect.setInverted(!1,this),Multiselect.isInverted(this)){var newIndex=Multiselect.getFirstSelectedIndex(this);Multiselect.removeSelected(newIndex,this)}else{var newIndex=this.indexOfNextVMLI(Multiselect.getLastSelectedIndex(this));newIndex>=0&&newIndex<this.numItems()&&(Multiselect.addSelected(newIndex,this),this.scrollIndexIntoView(newIndex,ScrollDuration.Default))}else{var newIndex=this.indexOfNextVMLI(Multiselect.getLastSelectedIndex(this));newIndex>=0&&newIndex<this.numItems()&&(this.selectIndex(newIndex),this.scrollIndexIntoView(newIndex,ScrollDuration.Default))}},keyMoveUp:function keyMoveUpFn(e){if(e.shiftKey)if(Multiselect.isInverted(this)||1!==Multiselect.numSelectedInPane(this)||Multiselect.setInverted(!0,this),Multiselect.isInverted(this)){var newIndex=this.indexOfPrevVMLI(Multiselect.getFirstSelectedIndex(this));newIndex>=0&&(Multiselect.addSelected(newIndex,this),this.scrollIndexIntoView(newIndex,ScrollDuration.Default))}else{var newIndex=Multiselect.getLastSelectedIndex(this);Multiselect.removeSelected(newIndex,this)}else{var newIndex=this.indexOfPrevVMLI(Multiselect.getFirstSelectedIndex(this));newIndex>=0&&(this.selectIndex(newIndex),this.scrollIndexIntoView(newIndex,ScrollDuration.Default))}},keydown:function keydownFn(e){if(this.selectedIndex.get()>=0){var item=this.itemAtIndex(this.selectedIndex.get()),hasNoModifiers=!e.metaKey&&!e.ctrlKey&&!e.altKey;if(item){var prevent=hasNoModifiers;switch(e.normCode){case KeyCode.DownArrow:hasNoModifiers&&this.keyMoveDown(e),e.preventDefault();break;case KeyCode.J:hasNoModifiers&&this.keyMoveDown(e);break;case KeyCode.UpArrow:hasNoModifiers&&this.keyMoveUp(e),e.preventDefault();break;case KeyCode.K:hasNoModifiers&&this.keyMoveUp(e);break;case KeyCode.Enter:EmailPreview.isOpenOnPane(this)||this.openEmailByItem(item);break;case KeyCode.Slash:case KeyCode.E:var label=this.getItemLabel(!0),archive=label.isArchived()?!1:!0;this.archiveSelected(archive);break;case KeyCode.BackSpace:case KeyCode.Delete:this.deleteSelected(this.plugin.isGmailItem,!0);break;case KeyCode.C:hasNoModifiers&&this.autocompleteSchedule();break;case KeyCode.D:hasNoModifiers&&this.autocompleteSnooze();break;case KeyCode.M:case KeyCode.V:hasNoModifiers&&this.autocompleteMove();break;case KeyCode.L:this.autocompleteLabel();break;case KeyCode.I:this.markReadSelected(!0);break;case KeyCode.U:this.markReadSelected(!1);break;case KeyCode.D8:case KeyCode.S:this.toggleStarSelected();break;case KeyCode.R:hasNoModifiers&&(e.shiftKey?this.replyAllSelected():this.replySelected());break;case KeyCode.A:hasNoModifiers&&this.replyAllSelected();break;case KeyCode.F:hasNoModifiers&&this.forwardSelected();break;case KeyCode.D1:this.applyPriorityToSelection(VMLIFlag.P0,!0);break;case KeyCode.D2:this.applyPriorityToSelection(VMLIFlag.P1,!0);break;case KeyCode.D3:this.applyPriorityToSelection(VMLIFlag.P2,!0);break;case KeyCode.Y:this.search.isSearched()||(this.plugin.beginAction(),this.applyToSelection(this.removeItemFromCurrentLabel.bind(this)),this.plugin.endAction());break;default:prevent=!1}prevent&&e.preventDefault()}}},removeItemFromCurrentLabel:function removeItemFromCurrentLabelFn(item){var label=this.getItemLabel(),attach=item.getAttachments()[0];try{g.PAssert(4434,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}label.isCustom()?this.plugin.performAction(C.PluginAction.Gmail.RemoveLabel,!1,attach,label.getName()):label.isInbox()?this.plugin.performAction(C.PluginAction.Gmail.Archive,!1,attach):label.isArchived()?this.plugin.performAction(C.PluginAction.Gmail.Unarchive,!1,attach):label.isStarred()&&this.plugin.performAction(C.PluginAction.Gmail.Unstar,!1,attach)},canAcceptDragOver:function canAcceptDragOverFn(fromPane,item,target,overview){if(fromPane&&this.type===fromPane.type&&(overview||fromPane&&this!==fromPane)){var fromLabel=fromPane.getItemLabel(),targetItem;if(overview){var li=g.getElementParent(target);targetItem=li&&g.getItemForElement(li)}else targetItem=this.getItem();if(targetItem&&this.plugin.isLabelItem(targetItem)&&this.plugin.areItemsFromSameAccount(item,targetItem)&&(newLabel=this.plugin.getLabelForVMLI(targetItem),newLabel!==fromLabel&&newLabel.isDropTarget()))return!0}return!1},_handleDragOverPane:function _handleDragOverPaneFn(fromPane,item,target,li,targetItem,x,y){return{targetElement:target,targetItem:this.getItem()}},_handleDragDrop:function _handleDragDropFn(item,e,dragInfo,isNew){if(dragInfo){var fromPane=e.dataTransfer.pane,fromLabel=fromPane.getItemLabel(),targetItem=dragInfo.targetItem,newLabel=this.plugin.getLabelForVMLI(targetItem),attach=void 0;if(item.hasPluginAttachment(this.plugin.id)&&this.plugin.areItemsFromSameAccount(item,targetItem)){attach=item.getAttachmentByPlugin(this.plugin.id);try{g.PAssert(4435,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}this.plugin.beginAction(),this.plugin.performAction(C.PluginAction.Gmail.RemoveLabel,!1,attach,fromLabel.getName()),this.plugin.attachmentHasLabel(attach,newLabel.getName())||this.plugin.performAction(C.PluginAction.Gmail.AddLabel,!1,attach,newLabel.getName()),fromPane.notifyDropFrom(item,this),this.plugin.endAction()}}},notifyDropFrom:function notifyDropFromFn(droppedItem,toPane){if(this.selectIndex(-1),toPane.type===PaneMode.Outline){var attach=droppedItem.getAttachmentByPlugin(this.plugin.id);try{g.PAssert(4436,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}this.plugin.attachmentHasLabel(attach,"Moo.do/Handled")||(this.plugin.beginAction(),this.plugin.getSetting(this.plugin.Settings.ArchiveOnOrganize)&&this.plugin.performAction(C.PluginAction.Gmail.RemoveLabel,!1,attach,this.plugin.SystemLabels.INBOX),this.plugin.performAction(C.PluginAction.Gmail.AddLabel,!1,attach,"Moo.do/Handled"),this.plugin.endAction());var pri=this.plugin.getAttachmentPriority(attach);pri!==VMLIFlag.None&&droppedItem.priority(pri,ChangeType.Local),this.plugin.attachmentHasLabel(attach,"STARRED")&&droppedItem.isStarred(!0,ChangeType.Local)}},maxWidthOfItem:function maxWidthOfItemFn(item){return this.getWidth()-66},allowZoom:function allowZoomFn(item){var allowZoom=!1;return this.plugin.isLabelItem(item)&&(allowZoom=!0),allowZoom},performOverviewAction:function performOverviewActionFn(item){if(this.plugin.isAccountItem(item)){item.setCollapsed(!item.isCollapsed(this,!0),this,!0);var zoomItem=item=this.plugin.getDefaultDisplayItem(this.plugin._getAccountIDFromItem(item));g.vmMain.zoomin(zoomItem),g.sendEvent("Menu","OverviewZoom_Gmail")}},setItem:function setItemFn(newItem,notify){this.isLoading.set(!0);var oldItem=this.getItem();this.selectIndex(-1);var ret=this._super.setItem.call(this,newItem,notify);return ret},isItemHeader:function isItemHeaderFn(item,overview){if(!overview)return item.isHeader();for(var plugin=this.plugin,items=item.getItems(),i=0;i<items.length;i++)if(plugin.isLabelItem(items[i])||plugin.isAccountItem(items[i]))return!0},getActualPaneItem:function getActualPaneItemFn(){return this.plugin._defaultZoomItems[this.id]||this.item.get()},canResetMultiselect:function canResetMultiselectFn(){return!EmailPreview.isOpenOnPane(this)},setExpanded:function setExpandedFn(value){this._super.setExpanded.call(this,value),value||this===g.focusedPane||Multiselect.reset(this)},applyAgendaDropToItem:function applyAgendaDropToItemFn(agendaInfo,item){var a=agendaInfo,attach=item.getAttachmentByPlugin(this.plugin.id);try{g.PAssert(4437,attach,"Must be able to get a valid attachment")}catch(PERR){g.reportError(PERR)}if(a.isDate){var date=a.dateTime||a.date;try{g.PAssert(4438,g.isDateValid(date),"Must provide a valid date when scheduling an email",a.dateTime,a.date)}catch(PERR){g.reportError(PERR)}g.isDateValid(date)&&this.plugin.scheduleEmail(item,date)}else{var pri;a.isStarred?this.plugin.performAction(C.PluginAction.Gmail.Star,!1,attach):a.p0||a.isImportant?pri=VMLIFlag.P0:a.p1?pri=VMLIFlag.P1:a.p2&&(pri=VMLIFlag.P2),pri&&this.plugin.performAction(C.PluginAction.Gmail.SetPriority,!1,attach,pri)}},getSaveInfo:function getSaveInfoFn(){var state=this._super.getSaveInfo.call(this);return state.sortType=this.sortType.get(),state},setIgnoreRestoreScroll:function setIgnoreRestoreScrollFn(){}};return util.inherit(VMPane,Plugin_Gmail_Pane),util.extend(Plugin_Gmail_Pane.prototype,Plugin_Gmail_PaneFns),Plugin_Gmail_Pane}),define("Aggregator",["require","exports","module","globals","util"],function(require,exports,module){function Aggregator(entryCB,doneCB,delay){try{g.PAssert(4439,g.isFunction(entryCB),"Must provide a valid entry callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4440,g.isFunction(doneCB),"Must provide a valid done callback")}catch(PERR){g.reportError(PERR)}this._entryCB=entryCB,this._doneCB=doneCB,this._delay=delay||DefaultDelay,this._flushTimeout=void 0,this._entries=[],util.forceBind("_onEntry",this),util.forceBind("_onDone",this),util.forceBind("_flushEntries",this),util.forceBind("_flushEntriesWatchdog",this)}var g=require("globals"),util=require("util"),DefaultDelay=5e3;return Aggregator.prototype={getEntryCB:function getEntryCBFn(){return this._onEntry},getDoneCB:function getDoneCBFn(){return this._onDone},_onEntry:function _onEntryFn(entry){entry&&this._entries.push(entry),this._flushTimeout||(this._flushTimeout=setTimeout(this._flushEntriesWatchdog,this._delay))},_onDone:function _onDoneFn(success,errorResult){g.vmMain.beginUpdateItems(),this._flushEntries(),this._doneCB(success,errorResult),g.vmMain.commitUpdateItems()},_flushEntriesWatchdog:function _flushEntriesWatchdogFn(){},_flushEntries:function _flushEntriesFn(){this._flushTimeout&&(clearTimeout(this._flushTimeout),this._flushTimeout=void 0),g.vmMain.beginUpdateItems();for(var i=0;i<this._entries.length;++i){var entry=this._entries[i];this._entryCB(entry)}this._entries=[],g.vmMain.commitUpdateItems()}},Aggregator}),define("DriveUploader",["require","exports","module","globals","Constants","goog","AccountManager"],function(require,exports,module){function DriveUploader(file,email,onProgress,onComplete,onError){this.file=file,this.contentType=file.type,this.email=email,this.onComplete=onComplete||g.emptyFn,this.onError=onError||g.emptyFn,this.onProgress=onProgress||g.emptyFn,this._callbacks=[],this.offset=0,this.chunkSize=1048576,this._isDone=!1,this._isCanceled=!1,this._hasError=!1;var params={uploadType:"resumable"};this.url=this._buildURL(void 0,params),this._percent=0}var g=require("globals"),C=require("Constants"),goog=require("goog"),AccountManager=require("AccountManager");return DriveUploader.prototype={upload:function uploadFn(){if(g.isDemoMode())return void setTimeout(function(){this.onComplete()}.bind(this),2e3);var token=AccountManager.getDefaultAccessToken();if(token){var headers={Authorization:"Bearer "+token,"Content-Type":"application/json","X-Upload-Content-Length":this.file.size,"X-Upload-Content-Type":this.contentType};goog.getAttachFolder(function(attachFolderID){var metadata={title:this.file.name,mimeType:this.contentType,parents:attachFolderID?[{id:attachFolderID}]:[]},metadataStr;try{metadataStr=JSON.stringify(metadata)}catch(err){g.reportError(err)}metadataStr?g.XHR({url:this.url,type:"POST",headers:headers,data:metadataStr,autoRetry:!0,cb:function cbFn(xhr){if(xhr.status<C.HTTPStatusCode.BadRequest){var location=xhr.getResponseHeader("Location");this.url=location,this._runUpload()}else this._onError(xhr)}.bind(this)}):this._onError()}.bind(this))}},_runUpload:function _runUploadFn(){var endOffset=Math.min(this.offset+this.chunkSize,this.file.size),content=this.file.slice(this.offset,endOffset),headers={"Content-Type":this.contentType,"Content-Range":"bytes "+this.offset+"-"+(endOffset-1)+"/"+this.file.size,"X-Upload-Content-Type":this.contentType};g.XHR({url:this.url,type:"PUT",headers:headers,data:content,autoRetry:!0,cb:function cbFn(xhr){if(xhr.status===C.HTTPStatusCode.Success||xhr.status===C.HTTPStatusCode.Created)this.isCanceled()||this._onComplete(xhr);else if(xhr.status===C.HTTPStatusCode.PermRedirect){var newOffset=this._extractRange(xhr.getResponseHeader("Range"));this.offset=newOffset,this._onProgress(this.offset/this.file.size),this.isCanceled()||this._runUpload()}else this._onError(xhr)}.bind(this)})},resume:function resumeFn(){try{g.PAssert(4441,!this.isDone(),"Should not resume a completed upload")}catch(PERR){g.reportError(PERR)}this._hasError=!1,this._isCanceled=!1;var headers={"Content-Range":"bytes */"+this.file.size,"X-Upload-Content-Type":this.contentType};g.XHR({url:this.url,type:"PUT",headers:headers,autoRetry:!0,cb:function cbFn(xhr){if(xhr.status===C.HTTPStatusCode.PermRedirect){var newOffset=this._extractRange(xhr.getResponseHeader("Range"));this.offset=newOffset,this._onProgress(this.offset/this.file.size),this._runUpload()}else this._onError(xhr)}.bind(this)})},cancel:function cancelFn(){try{g.PAssert(4442,!this._isDone,"Cannot cancel an upload that is already complete")}catch(PERR){g.reportError(PERR)}this._isCanceled=!0},_onError:function _onErrorFn(xhr){this._hasError=!0,this.onError()},_onComplete:function _onCompleteFn(xhr){try{g.PAssert(4443,!this._isDone,"Should not call the complete CB twice")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4444,!this._isCanceled,"Should not be able to complete a canceled upload")}catch(PERR){g.reportError(PERR)}this._isDone=!0;var metadata={};if(xhr&&xhr.response)try{metadata=JSON.parse(xhr.response)}catch(err){g.reportError(err)}this._onProgress(1),this.onComplete(metadata);for(var i=0;i<this._callbacks.length;++i)try{this._callbacks[i](metadata)}catch(err){g.reportError(err)}this._callbacks=[]},_onProgress:function _onProgressFn(percent){try{g.PAssert(4445,!this._hasError,"Should not make forward progress when an error has occurred")}catch(PERR){g.reportError(PERR)}this._percent=percent,this.onProgress(percent)},_extractRange:function _extractRangeFn(range){return g.parseInt(range.match(/\d+/g).pop())+1},_buildQueryString:function _buildQueryStringFn(params){return params=params||{},Object.keys(params).map(function(key){return encodeURIComponent(key)+"="+encodeURIComponent(params[key])}).join("&")},_buildURL:function _buildURLFn(id,params){var baseURL="https://www.googleapis.com/upload/drive/v2/files/",outURL=baseURL;id&&(outURL+=id);var query=this._buildQueryString(params);return query&&(outURL+="?"+query),outURL},notifyOnComplete:function notifyOnCompleteFn(fn){try{g.PAssert(4446,this._callbacks.indexOf(fn)<0,"Should not include fn twice")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4447,!this.isDone(),"Should not notify on complete after done")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4448,!this.hasError(),"Should not notify on complete after error")}catch(PERR){g.reportError(PERR)}this._callbacks.push(fn)},isCanceled:function isCanceledFn(){return this._isCanceled},isDone:function isDoneFn(){return this._isDone},hasError:function hasErrorFn(){return this._hasError},getPercent:function getPercentFn(){return this._percent}},DriveUploader}),define("plugins/Plugin_Gmail",["require","exports","module","globals","Constants","data","util","platform","tracker","apis","DuchessHelpers","UndoStack","gdata","AccountManager","VMPlugin","CachedSearch","GmailLabel","RFC822Message","plugins/Plugin_Gmail_Pane","Favorites","Aggregator","EmailPreview","EmailHTML","DriveUploader","Multiselect","VMAttachment"],function(require,exports,module){function Plugin_Gmail(){this._super.constructor.call(this,PluginID.Gmail,"Gmail"),this.autocompleteReplace=!0,this.SystemLabels=SystemLabels,this.SpecialLabels=SpecialLabels,this._lastSyncTime=void 0,util.forceBind("threadSortFn",this),util.forceBind("threadSortPriorityFn",this),util.forceBind("labelSortFn",this),util.forceBind("labelVMLISortFn",this),util.forceBind("sortFn",this),util.forceBind("_fromComparator",this),util.forceBind("_toComparator",this),util.forceBind("_dateComparator",this),util.forceBind("_messagesComparator",this),util.forceBind("_shallowObjComparator",this),util.forceBind("isGmailItem",this),util.forceBind("_flushPendingDraftUpdates",this),util.forceBind("driveMessageContentSync",this),util.forceBind("_handleDeferredSnoozeTask",this),util.forceBind("_cancelDeferredSnoozeTask",this),util.forceBind("_persistRemoteSnoozeTask",this),util.forceBind("_handleDeferredSendMailTask",this),util.forceBind("_cancelDeferredSendMailTask",this),util.forceBind("_persistRemoteSendMailTask",this),this._labels={},this._priorityLabels={},this._creatingDrafts={},this._pendingDraftUpdates={},this._activeDraftUpdates=0,this._accountSettings={},this._pendingSends={},this._draftCache={},this._unsyncdMessages={},this._pendingSyncdMessages={},this._numUnsyncdMessages=0,this._numSyncdMessages=0,this._outstandingContentSync=!1,this._undoStack=new UndoStack(10),this._generateUndoRedo(),this._syncingOfflineChanges=!1,this._draftFlushTimer=void 0,this.registerSetting("WriteAccess","writeAccess",!0),this.registerSetting("SyncTime","syncTime",!0,C.MaxGmailSyncTime.Free),this.registerSetting("SyncAccounts","syncAccounts",!0,["me"]),this.registerSetting("ArchiveOnSchedule","archiveOnSchedule",!0,!1),this.registerSetting("ArchiveOnOrganize","archiveOnOrganize",!0,!1),this.addTrackedStat(TrackedStat.EnsureLabelVMLI),this.addTrackedStat(TrackedStat.CreateLabelVMLI),this.addTrackedStat(TrackedStat.MergeThread),this.addTrackedStat(TrackedStat.SyncdMessage),this.addTrackedStat(TrackedStat.ErrorSyncdMessage),this.addTrackedStat(TrackedStat.UnsyncdMessage),this.addTrackedStat(TrackedStat.OldUnsyncdMessage),this.addTrackedStat(TrackedStat.MessagesSyncd),this._threadCache=this.registerLocalCache("GmailThreadCache",StorageType.IndexedDB,!0),this._rawCache=this.registerLocalCache("RawCache",StorageType.IndexedDB,!1),this.registerDeferredTaskType(DeferredTaskType.Snooze,this._handleDeferredSnoozeTask,this._cancelDeferredSnoozeTask,this._persistRemoteSnoozeTask),this.registerDeferredTaskType(DeferredTaskType.SendMail,this._handleDeferredSendMailTask,this._cancelDeferredSendMailTask,this._persistRemoteSendMailTask),this._contentSyncTask=this.registerLowImpactTask("ContentSync",this.driveMessageContentSync),g.isDemoMode()?this.declareProperty("accountID",PluginLoad.Preview|PluginLoad.Full,!0,"me"):this.declareProperty("accountID",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("from",PluginLoad.Preview|PluginLoad.Full,!1,void 0,this._fromComparator),this.declareProperty("to",PluginLoad.Preview|PluginLoad.Full,!1,void 0,this._toComparator),this.declareProperty("subject",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("date",PluginLoad.Preview|PluginLoad.Full,!0,new Date(0),this._dateComparator),this.declareProperty("lastModifiedDate",PluginLoad.Full,!0,void 0,this._dateComparator),this.declareProperty("modifiedOffline",PluginLoad.Full,!0,!1),this.declareProperty("pendingSend",PluginLoad.Full,!0,!1),this.declareProperty("messages",PluginLoad.Full,!0,[],this._messagesComparator),this.declareProperty("snippet",PluginLoad.Full),this.declareProperty("participants",PluginLoad.Runtime,!0,[]),this.declareProperty("subjectLower",PluginLoad.Runtime),this.declareProperty("count",PluginLoad.Runtime),this.declareProperty("dataLoaded",PluginLoad.Runtime,!0,!1),this.declareProperty("labelIds",PluginLoad.Runtime,!0,[]),this.declareProperty("hasAttachments",PluginLoad.Full,!0,!1),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.EmailThread)}var g=require("globals"),C=require("Constants"),d=require("data"),util=require("util"),platform=require("platform"),tracker=require("tracker"),apis=require("apis"),DuchessHelpers=require("DuchessHelpers"),UndoStack=require("UndoStack"),gdata=require("gdata"),AccountManager=require("AccountManager"),VMPlugin=require("VMPlugin"),CachedSearch=require("CachedSearch"),GmailLabel=require("GmailLabel"),RFC822Message=require("RFC822Message"),Plugin_Gmail_Pane=require("plugins/Plugin_Gmail_Pane"),Favorites=require("Favorites"),Aggregator=require("Aggregator"),EmailPreview=require("EmailPreview"),EmailHTML=require("EmailHTML"),DriveUploader=require("DriveUploader"),DraftUpdateDelay=3e4,TrackedStat={EnsureLabelVMLI:"EnsureLabelVMLI",CreateLabelVMLI:"CreateLabelVMLI",MergeThread:"MergeThread",SyncdMessage:"SyncdMessage",ErrorSyncdMessage:"ErrorSyncdMessage",UnsyncdMessage:"UnsyncdMessage",OldUnsyncdMessage:"OldUnsyncdMessage",MessagesSyncd:"MessagesSyncd"},DeferredTaskType={Snooze:"snoozemail",SendMail:"sendmail"},RequestType={FullSync:1,History:2,ThreadFull:3,ThreadMeta:4,Search:5,DataPage:6,Send:7,Labels:8,CreateLabel:9,ModifyLabels:10,Trash:11,ThreadLabel:12,DraftCreate:13,DraftUpdate:14,DraftDelete:15,DraftSend:16,DraftList:17,GetAttachment:18,MessageFull:19,SendAs:20},CacheMetadata={HistoryIDs:"historyIDs",Labels:"labels",SendAs:"sendAs"},RootLabelName="Moo.do",SystemLabels={INBOX:"INBOX",SPAM:"SPAM",TRASH:"TRASH",UNREAD:"UNREAD",STARRED:"STARRED",IMPORTANT:"IMPORTANT",SENT:"SENT",DRAFT:"DRAFT",CHAT:"CHAT",CATEGORY_PERSONAL:"CATEGORY_PERSONAL",CATEGORY_SOCIAL:"CATEGORY_SOCIAL",CATEGORY_PROMOTIONS:"CATEGORY_PROMOTIONS",CATEGORY_UPDATES:"CATEGORY_UPDATES",CATEGORY_FORUMS:"CATEGORY_FORUMS"},SpecialLabels={ARCHIVED:"==MOODO_ARCHIVED=="},PriorityLabels={PRI0:RootLabelName+"/Priority High",PRI1:RootLabelName+"/Priority Medium",PRI2:RootLabelName+"/Priority Low"},SnoozeLabelName=RootLabelName+"/Snoozed",HandledLabelName=RootLabelName+"/Handled",ScheduleLabelName=RootLabelName+"/Scheduled",ScheduledSendLabelName=RootLabelName+"/ScheduledSend",FullMessageFields=["id","labelIds","messageID","draftID","decoded","mimeType","contentType","from","replyTo","to","cc","bcc","snippet","subject","date","internalDate","references","inReplyTo","listUnsubscribe","resources","cached","cachedError"],MessageHeaders=["Content-Transfer-Encoding","Content-Type","DKIM-Signature","From","Reply-To","To","Cc","Bcc","Subject","Date","Message-ID","References","In-reply-to","List-Unsuscribe"],AltKnownHeaders=["Delivered-To","Received","X-Received","Return-Path","Received-SPF","Authentication-Results","DKIM-Signature","MIME-Version","Content-Type","Content-Transfer-Encoding","Sender","Precedence"],MessagePartType={Signed:"multipart/signed",Related:"multipart/related",Mixed:"multipart/mixed",Report:"multipart/report",Parallel:"multipart/parallel",Alternative:"multipart/alternative",Digest:"multipart/digest",Calendar:"text/calendar",Plain:"text/plain",HTML:"text/html"},ContentDisposition={Unknown:"unknown",Inline:"inline",FormData:"form-data",Attachment:"attachment"},DefaultContentType="text/html;charset=utf-8",ValidMimetypePrefixes=["application","audio","example","image","message","model","video","text"],ValidDisplayTypes=[MessagePartType.Alternative,MessagePartType.Mixed,MessagePartType.Plain,MessagePartType.HTML,MessagePartType.Report],fromRegexp=/(?:\"?([^\"]*)\"?\s)?<(.*)>/g,DEFAULT_THREAD_MAX_RESULTS=40,DEFAULT_HISTORY_MAX_RESULTS=999,DEFAULT_THREAD_SYNC_RESULTS=999,Plugin_GmailFns={getType:function getTypeFn(){return C.PluginType.Email},_attachMetadataFields:function _attachMetadataFieldsFn(){return["modifiedOffline","pendingSend"]},getDataPane:function getDataPaneFn(){try{g.PAssert(4450,!!this.getPaneIcon(),"Should have a pane icon specified")}catch(PERR){g.reportError(PERR)}return Plugin_Gmail_Pane},getPaneIcon:function getPaneIconFn(){return"icon-envelope"},useItemStore:function useItemStoreFn(){return"Gmail"},itemStoreOptions:function itemStoreOptionsFn(){var enabledFilters=ItemStoreFilter.Priority;return{enabledFilters:enabledFilters,parserFn:DuchessHelpers.parseSinglePlugin.bind(DuchessHelpers)}},allowRemoteRequests:function allowRemoteRequestsFn(){return!0},ensureAccountEmail:function ensureAccountEmailFn(accountID){return"me"===accountID?this.getDefaultAccount():accountID},getDefaultAccount:function getDefaultAccountFn(){var defaultAccount,currentUser=g.getUserIdentifier();if(currentUser){try{g.PAssert(4451,g.isDemoMode()||"me"!==currentUser,'Should never return "me" as a valid user')}catch(PERR){g.reportError(PERR)}defaultAccount=currentUser}else{try{g.PAssert(4452,!1,'Unable to get default account name, returning "me"')}catch(PERR){g.reportError(PERR)}defaultAccount="me"}return defaultAccount},isSameAccount:function isSameAccountFn(accA,accB){return"me"===accA&&(accA=this.getDefaultAccount()),"me"===accB&&(accB=this.getDefaultAccount()),accA===accB},areItemsFromSameAccount:function areItemsFromSameAccountFn(itemA,itemB){var accA=this._getAccountIDFromItem(itemA),accB=this._getAccountIDFromItem(itemB);return this.isSameAccount(accA,accB)},_handleAccountChanges:function _handleAccountChangesFn(){var removePanes=[];
g.vmMain.paneManager.runForEachPane(function(pane){var accountID=this._getAccountIDFromItem(pane.getItem());this.hasSyncAccount(accountID)||removePanes.push(pane)}.bind(this),this.getPaneType());for(var i=0;i<removePanes.length;++i)g.vmMain.paneManager.removePane(removePanes[i]);0===removePanes.length&&g.vmMain.paneManager.notifyPanes()},addSyncAccount:function addSyncAccountFn(accountID,cb){var syncAccounts=this.getSetting(this.Settings.SyncAccounts);try{g.PAssert(4453,syncAccounts.indexOf(accountID)<0,"Must not double add sync accounts to list")}catch(PERR){g.reportError(PERR)}syncAccounts.indexOf(accountID)<0&&syncAccounts.push(accountID),this.setSetting(this.Settings.SyncAccounts,syncAccounts),this.isActive()?this._forceLabelSync(function(){this._forceThreadSync(cb)}.bind(this)):cb(!0),this._handleAccountChanges()},removeSyncAccount:function removeSyncAccountFn(accountID,cb){var syncAccounts=this.getSetting(this.Settings.SyncAccounts);try{g.PAssert(4454,syncAccounts.indexOf(accountID)>=0,"Must be able to find sync account if removing")}catch(PERR){g.reportError(PERR)}if(syncAccounts.remove(accountID),this.setSetting(this.Settings.SyncAccounts,syncAccounts),this._clearCachedData(accountID,cb),this.getDefaultItemStore()){var accountVMLI=this.getVMLIForAccount(accountID);accountVMLI&&(accountVMLI.deleteSelf(ChangeType.Local),accountVMLI.getItemStore().destroyItem(accountVMLI.id))}this._handleAccountChanges()},_iterateSendAs:function _iterateSendAsFn(cb){for(var syncAccounts=this.getSyncAccounts(),isDone=!1,i=0;!isDone&&i<syncAccounts.length;++i){var sendAs=this.getAccountSetting(syncAccounts[i],"sendAs");if(sendAs)for(var j=0;j<sendAs.length;++j){var entry=sendAs[j];if(cb(syncAccounts[i],entry)){isDone=!0;break}}else cb(syncAccounts[i])}},getSignature:function getSignatureFn(sendingAccountID){var signature;return this._iterateSendAs(function(accountID,entry){return entry&&entry.sendAsEmail===sendingAccountID?(signature=entry.signature,!0):void 0}),signature},getReplyToAddress:function getReplyToAddressFn(sendingAccountID){var replyTo;return this._iterateSendAs(function(accountID,entry){return entry&&entry.sendAsEmail===sendingAccountID&&entry.replyToAddress?(replyTo=entry.replyToAddress,!0):void 0}),replyTo},getDisplayName:function getDisplayNameFn(sendingAccountID){var displayName;return this._iterateSendAs(function(accountID,entry){return entry&&entry.sendAsEmail===sendingAccountID?(displayName=!entry.displayName&&entry.isPrimary?AccountManager.getAccountName(accountID):entry.displayName,!0):void 0}),displayName},getDefaultSendingAccount:function getDefaultSendingAccountFn(reqAccountID){var sendingAccountID;return this._iterateSendAs(function(accountID,entry){return accountID===reqAccountID&&entry&&entry.isDefault?(sendingAccountID=entry.sendAsEmail,!0):void 0}),sendingAccountID},getDefaultFromInfo:function getDefaultFromInfoFn(accountID){var sendingAccountID=this.getDefaultSendingAccount(accountID),displayName=this.getDisplayName(sendingAccountID);try{g.PAssert(4455,sendingAccountID,"Must have found a valid account to send from")}catch(PERR){g.reportError(PERR)}return{text:displayName,email:sendingAccountID}},getSendingAccounts:function getSendingAccountsFn(reqAccountID){var sendAccounts=[];return this._iterateSendAs(function(accountID,entry){reqAccountID&&reqAccountID!==accountID||(entry?"pending"!==entry.verificationStatus&&sendAccounts.push(entry.sendAsEmail):sendAccounts.push(accountID))}),sendAccounts},getSyncAccount:function getSyncAccountFn(sendingAccountID){var syncAccount;return this._iterateSendAs(function(accountID,entry){if(entry){if(entry.sendAsEmail===sendingAccountID)return syncAccount=accountID,!0}else if(sendingAccountID===accountID)return syncAccount=accountID,!0}),syncAccount},getSendingAccountInfo:function getSendingAccountInfoFn(sendingAccountID){var accountInfo;return this._iterateSendAs(function(accountID,entry){if(entry){if(entry.sendAsEmail===sendingAccountID)return accountInfo={text:entry.displayName,email:sendingAccountID},!0}else if(sendingAccountID===accountID)return accountInfo={text:AccountManager.getAccountName(accountID),email:accountID},!0}),accountInfo},getSyncAccounts:function getSyncAccountsFn(){for(var rawSyncAccounts=this.getSetting(this.Settings.SyncAccounts),syncAccounts=[],i=0;i<rawSyncAccounts.length;++i)syncAccounts.push("me"===rawSyncAccounts[i]?this.getDefaultAccount():rawSyncAccounts[i]);try{g.PAssert(4456,g.isDemoMode()||syncAccounts.indexOf("me")<0,'Must not contain "me" as an account')}catch(PERR){g.reportError(PERR)}return syncAccounts},numSyncAccounts:function numSyncAccountsFn(){return this.getSetting(this.Settings.SyncAccounts).length},hasSyncAccount:function hasSyncAccountFn(accountID){return this.getSyncAccounts().indexOf(accountID)>=0},_getSettingsSendAs:function _getSettingsSendAsFn(cb){for(var syncAccounts=this.getSyncAccounts(),expectedReqs=syncAccounts.length,numResponses=0,sendAsData={},responseCB=function(success,accountID,settings){success&&(sendAsData[accountID]=settings.sendAs),++numResponses===expectedReqs&&cb(sendAsData)},i=0;i<syncAccounts.length;++i)this._requestSettings(syncAccounts[i],responseCB)},_requestSettings:function _requestSettingsFn(accountID,cb){var requestFn=["gapi","client","gmail","users","settings","sendAs","list"],requestData={userId:accountID},successCB=function(result){cb(!0,accountID,result)},failureCB=function(result){cb(!1,accountID,result),this._notifyFailedRequest(result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.SendAs)},_fromComparator:function _fromComparatorFn(oldValue,newValue){var isEqual=!1;if(oldValue||newValue){if(oldValue&&newValue){try{g.PAssert(4457,!g.isString(oldValue),"Old from must not be a string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4458,!g.isString(newValue),"New from must not be a string")}catch(PERR){g.reportError(PERR)}oldValue.text===newValue.text&&oldValue.email===newValue.email&&(isEqual=!0)}}else isEqual=!0;return isEqual},_toComparator:function _toComparatorFn(oldValue,newValue){var isEqual=!1;if(oldValue||newValue){if(oldValue&&newValue){try{g.PAssert(4459,g.isArray(oldValue),"Old to must be an array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4460,g.isArray(newValue),"New to must be an array")}catch(PERR){g.reportError(PERR)}isEqual=newValue.equals(oldValue)}}else isEqual=!0;return isEqual},_dateComparator:function _dateComparatorFn(oldValue,newValue){var isEqual=!1;if(oldValue||newValue){if(oldValue&&newValue){g.isString(oldValue)&&(oldValue=new Date(oldValue)),g.isString(newValue)&&(newValue=new Date(newValue));try{g.PAssert(4461,g.isDateValid(oldValue),"Must be an old valid date to compare")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4462,g.isDateValid(newValue),"Must be a new valid date to compare")}catch(PERR){g.reportError(PERR)}isEqual=oldValue.equals(newValue)}}else isEqual=!0;return isEqual},_messagesComparator:function _messagesComparatorFn(oldValue,newValue){var isEqual=!0;if(oldValue&&newValue)if(oldValue.length===newValue.length)for(var i=0;isEqual&&i<newValue.length;++i)for(var oldVal=oldValue[i],newVal=newValue[i],msgFieldDiff,j=0;j<FullMessageFields.length;++j){var field=FullMessageFields[j],fieldMatches=!0;switch(field){case"from":fieldMatches=this._fromComparator(oldVal[field],newVal[field]);break;case"to":fieldMatches=this._toComparator(oldVal[field],newVal[field]);break;case"resources":case"listUnsubscribe":fieldMatches=this._shallowObjComparator(oldVal[field],newVal[field]);break;case"labelIds":fieldMatches=newVal[field].equals(oldVal[field]);break;case"date":fieldMatches=this._dateComparator(oldVal[field],newVal[field]);break;case"internalDate":fieldMatches=this._dateComparator(oldVal[field],newVal[field]);break;default:fieldMatches=oldVal[field]===newVal[field]}fieldMatches||(isEqual=!1)}else isEqual=!1;else isEqual=!1;return isEqual},_shallowObjComparator:function _shallowObjComparatorFn(oldValue,newValue){var isEqual=!1;if(oldValue||newValue){if(oldValue&&newValue)if(oldValue===newValue)isEqual=!0;else{isEqual=!0;for(var key in oldValue)if(!newValue.hasOwnProperty(key)){isEqual=!1;break}}}else isEqual=!0;return isEqual},_offlineLoad:function _offlineLoadFn(){this._threadCache.onCacheReady(function(){this._threadCache.onCacheMetadataReady(function(){g.isDemoMode()||this._threadCache.getMetadata(CacheMetadata.SendAs,function(sendAsData){if(sendAsData)for(var accountID in sendAsData)this.setAccountSetting(accountID,"sendAs",sendAsData[accountID])}.bind(this)),this._threadCache.getMetadata(CacheMetadata.Labels,function(labelData){var syncAccounts=this.getSyncAccounts();if(g.isDemoMode()&&(labelData={}),labelData){labelData.me&&!labelData[this.getDefaultAccount()]&&(labelData[this.getDefaultAccount()]=labelData.me),g.vmMain.beginUpdateItems();for(var i=0;i<syncAccounts.length;++i){var accountID=syncAccounts[i];if(this._ensureLabel(accountID,SystemLabels.INBOX,"Inbox",void 0,void 0,ChangeType.Local),this._ensureLabel(accountID,SystemLabels.UNREAD,"Unread",void 0,void 0,ChangeType.Local),this._ensureLabel(accountID,SpecialLabels.ARCHIVED,"Archived",void 0,void 0,ChangeType.Local),labelData){var labels=labelData[accountID];if(labels){for(var labelID in labels){var label=labels[labelID],labelName=label.name||"LocalLabel"+Date.now();this._ensureLabel(accountID,labelID,labelName,label.oldestSync,label,ChangeType.Local)}for(var labelID in SystemLabels){var labelName=SystemLabels[labelID];this._ensureLabel(accountID,labelID,labelName,void 0,void 0,ChangeType.Local)}}}this._ensureLabelVMLIsForAccount(accountID)}g.vmMain.commitUpdateItems(),this.notifyPanesReadyForLoad()}var filterDate=this._getMetadataSyncTime(),unreadDate=this._getUnreadSyncTime(),accountFilter=function(entry){return syncAccounts.indexOf(entry.accountID)>=0&&entry.date.isAfter(unreadDate)};this._threadCache.getFilterEntries(accountFilter,function(entries){if(entries){g.vmMain.beginUpdateItems();for(var i=0;i<entries.length;++i){var entry=entries[i],cacheEntry=this.createEntryFromLocal(entry.id,entry);(this.isPriorityData(cacheEntry)||entry.date.isAfter(filterDate))&&(this.cacheData(cacheEntry.id,cacheEntry),this._ensureVMLIsForThread(cacheEntry))}g.vmMain.commitUpdateItems()}}.bind(this))}.bind(this))}.bind(this))}.bind(this))},isPriorityData:function isPriorityDataFn(data){var isPriorityData=!1;return data.labelIds.indexOf(SystemLabels.UNREAD)>=0?isPriorityData=!0:data.labelIds.indexOf(PriorityLabels.PRI0)>=0?isPriorityData=!0:data.labelIds.indexOf(PriorityLabels.PRI1)>=0?isPriorityData=!0:data.labelIds.indexOf(PriorityLabels.PRI2)>=0&&(isPriorityData=!0),isPriorityData},_load:function _loadFn(){g.isDemoMode()||this.createRecurringTask("GmailThreadSync",{delay:g.minutes(15),minDelay:g.seconds(90),runOnCreate:!0,pauseWhileIdle:!0,minDelayOnResume:!0,async:!0,task:this.runThreadSync.bind(this)}),this.runSettingsSync(),this.createRecurringTask("GmailLabelSync",{delay:g.minutes(30),minDelay:g.minutes(15),runOnCreate:!0,pauseWhileIdle:!0,async:!0,task:this.runLabelSync.bind(this)})},_notifyFailedRequest:function _notifyFailedRequestFn(accountID,result){if(result&&result.error)if(result.error.code===C.HTTPStatusCode.Unauthorized)AccountManager.isDefaultEmail(accountID)?(g.toasts.pushMessage(MessageID.LostPermission),this.setSetting(this.Settings.IsEnabled,!1)):g.toasts.pushMessage(MessageID.LostLinked),AccountManager.notifyUnauthorizedAccount(accountID,[GScope.GmailCompose,GScope.GmailModify],result.error.message);else if(result.error.code===C.HTTPStatusCode.BadRequest)for(var errors=result.error.errors,i=0;i<errors.length;++i){var err=errors[i];err.reason===C.GoogleError.FailedPrecondition&&(g.toasts.pushMessage(MessageID.GmailDisabled),this.setSetting(this.Settings.IsEnabled,!1))}else if(result.error.code===C.HTTPStatusCode.Forbidden)for(var errors=result.error.errors,i=0;i<errors.length;++i){var err=errors[i];err.reason===C.GoogleError.InsufficientPermissions&&(g.toasts.pushMessage(MessageID.GmailDisabled),this.setSetting(this.Settings.IsEnabled,!1))}else result.error.code>=400&&result.error.code<500&&this._reportErrorCode(result.error.code)&&g.reportError(new Error("Failed Gmail request: "+result.error.code),result)},_reportErrorCode:function _reportErrorCodeFn(code){var doReport=!1;return code!==C.HTTPStatusCode.NotFound&&(doReport=!0),doReport},_notifySendFailed:function _notifySendFailedFn(){g.toasts.pushMessage(MessageID.EmailSendFail)},_createResourceCID:function _createResourceCIDFn(resources,name){for(var cid=name,addedIndex=1;resources[cid];){var parts=name.split(".");cid=parts[0]+"_"+addedIndex,parts[1]&&(cid+="."+parts[1]),addedIndex++}return cid},_createResource:function _createResourceFn(resources,file){try{g.PAssert(4463,resources,"Must have valid resources lib to add to")}catch(PERR){g.reportError(PERR)}return{cid:this._createResourceCID(resources,file.name),id:void 0,attID:void 0,realAttrID:void 0,data:void 0,size:void 0,thumbnail:void 0,uploader:void 0,link:void 0,error:!1,disposition:ContentDisposition.Attachment,parentType:MessagePartType.Mixed,mimeType:file.type,contentEncoding:void 0}},_getLinkedResourceString:function _getLinkedResourceStringFn(res){var img='<img style="vertical-align:top;border:none;margin-right:8px;" src="https://ssl.gstatic.com/docs/doclist/images/icon_10_generic_list.png">';return'<a id="'+res.cid+'" style="background-color:#f3f3f3;border:1px solid #dddddd;padding:8px;width:396px;font-weight:bold;min-height:18px;display:block;border-radius:3px;margin-bottom:8px;" href="'+res.link+'">'+img+res.cid+"</a>"},_removeAttachContent:function _removeAttachContentFn(attach,msg,res){msg.decoded=EmailHTML.removeElementById(msg.decoded,res.cid)},notifyAttachLinkedFile:function notifyAttachLinkedFileFn(attach,msg,attachFile,cb){var fileInfo={name:attachFile.getField("title"),type:attachFile.getField("mimeType")},res=this._createResource(msg.resources,fileInfo);res.size=attachFile.getField("fileSize"),res.link=attachFile.getField("alternateLink"),g.vmMain.remoteAPI().drivePermissionsPublic(attachFile.id,function(result){attach.notifyDataMutated(["messages"],ChangeType.Local),cb&&cb()},function(result){res.error=!0,attach.notifyDataMutated(["attachments"],ChangeType.Local)}),msg.resources[res.cid]=res,attach.notifyDataMutated(["attachments"],ChangeType.Local)},notifyAttachFiles:function notifyAttachFilesFn(attach,msg,fileList,cb){for(var accountID=attach.getField("accountID"),i=0;i<fileList.length;++i){var file=fileList[i],res=this._createResource(msg.resources,file),progressCB=function(res,percent){attach.notifyDataMutated(["attachments"],ChangeType.Local)}.bind(this,res),successCB=function(res,metadata){res.link=metadata.alternateLink,res.thumbnail=metadata.thumbnailLink,g.vmMain.remoteAPI().drivePermissionsPublic(metadata.id,function(result){attach.notifyDataMutated(["messages"],ChangeType.Local),cb&&cb()}.bind(this),function(result){res.error=!0,attach.notifyDataMutated(["attachments"],ChangeType.Local)})}.bind(this,res),failureCB=function(res){res.error=!0,g.toasts.pushMessage({text:"There was an error uploading your attachment.",actionText:"RETRY",action:function actionFn(){res.uploader.resume()}}),attach.notifyDataMutated(["attachments"],ChangeType.Local)}.bind(this,res);res.size=file.size,res.uploader=new DriveUploader(file,accountID,progressCB,successCB,failureCB),res.uploader.upload(),msg.resources[res.cid]=res}attach.notifyDataMutated(["messages"],ChangeType.Local)},removeAttachFiles:function removeAttachFilesFn(attach,msg,res){var res=msg.resources[res.cid];res.uploader&&!res.uploader.isDone()&&res.uploader.cancel(),delete msg.resources[res.cid],this._removeAttachContent(attach,msg,res),attach.notifyDataMutated(["messages"],ChangeType.Local)},notifyItemPropertyChanged:function notifyItemPropertyChangedFn(attach,item,changeType){if(item.belongsToItemStore(this.getDefaultItemStore())){var isComplete=item.dateCompleted,isArchived=this.attachmentIsArchived(attach);isComplete&&!isArchived&&this.archiveAttachment(attach)}},createLabelString:function createLabelStringFn(labelName){return SystemLabels[labelName.toUpperCase()]?void 0:labelName},isDisplayTag:function isDisplayTagFn(label,paneLabel){var isDisplay=!1;if(label&&label.shouldDisplayInMessageList()){var isDefaultDisplay=label.isCustom()||label.getLabelID()===SystemLabels.DRAFT,isContextDisplay=paneLabel&&!paneLabel.isInbox()&&label.isInbox();if(isDefaultDisplay||isContextDisplay)switch(isDisplay=!0,label.getName()){case PriorityLabels.PRI0:case PriorityLabels.PRI1:case PriorityLabels.PRI2:case HandledLabelName:case SystemLabels.STARRED:isDisplay=!1}}return isDisplay},isDisplayHeader:function isDisplayHeaderFn(header){var isDisplayHeader=!1;if(this.isLabelItem(header)){var labelID=this._getLabelIDFromItem(header);labelID!==SystemLabels.UNREAD&&(isDisplayHeader=!0)}return isDisplayHeader},isMessageDraft:function isMessageDraftFn(msgData){return msgData&&msgData.labelIds&&msgData.labelIds.indexOf(SystemLabels.DRAFT)>=0},getDisplayTags:function getDisplayTagsFn(attach,paneContext){var labelIDs=attach.getField("labelIds"),accountID=attach.getField("accountID"),labelNames=[],paneLabel;paneContext&&(paneLabel=paneContext.getItemLabel(!0));for(var i=0;i<labelIDs.length;++i){var label=this._getLabelByID(accountID,labelIDs[i]);if(this.isDisplayTag(label,paneLabel)){var displayText=label.getDisplayText();displayText&&labelNames.push(displayText)}}return labelNames},_getParticipantDisplayName:function _getParticipantDisplayNameFn(part,total){var displayName;if(this.isMyAccountID(part.email))displayName="me";else if(part.text)if(1===total)displayName=part.text;else{var nameParts=part.text.split(" ");displayName=nameParts&&nameParts.length>0?nameParts[0]:part.email}else displayName=part.email;return displayName},getDisplayParticipants:function getDisplayParticipantsFn(attach){for(var parts=attach.getField("participants"),displayParts=[],i=0;i<parts.length;++i)displayParts.push(this._getParticipantDisplayName(parts[i],parts.length));return displayParts.join(", ")},getDefaultDisplayItem:function getDefaultDisplayItemFn(accountID){accountID=accountID||this.getDefaultAccount();var label=this._getLabelByID(accountID,SystemLabels.INBOX);return this.getVMLIForLabel(accountID,label)},getEmailRootItem:function getEmailRootItemFn(){return Favorites.getItems(C.FavoriteGroup.EmailRoot)[0]},hasEmailRootItem:function hasEmailRootItemFn(){return Favorites.hasItems(C.FavoriteGroup.EmailRoot)},createEmailRootItem:function createEmailRootItemFn(){try{g.PAssert(4464,!this.hasEmailRootItem(),"Should not create email root if it already exists")}catch(PERR){g.reportError(PERR)}var itemStore=g.vmMain.itemStoreManager.getDefaultItemStore(),rootItem=itemStore.getRoot(),item=d.createVMLI({text:"Email",favorites:[C.FavoriteGroup.EmailRoot]},{parent:rootItem,changeType:ChangeType.AllLocal});return rootItem.insertItem(item,0),g.toasts.pushMessage({text:'A new "Email" item was created at the top of your document for snoozed emails.',action:MessageAction.Okay,hold:!0}),item},ensureEmailItem:function ensureEmailItemFn(name){tracker.beginAction(),this.hasEmailRootItem()||this.createEmailRootItem();for(var rootItem=this.getEmailRootItem(),items=rootItem.getItems(),emailItem,i=0;i<items.length;++i)if(items[i].getRawText()===name){emailItem=items[i];break}return emailItem||(emailItem=d.createVMLI({text:name},{parent:rootItem,changeType:ChangeType.AllLocal}),rootItem.insertItem(emailItem,0)),tracker.endAction(),emailItem},getWaitingItem:function getWaitingItemFn(cb){var item=this.ensureEmailItem("Waiting");cb(item)},allowTextEditing:function allowTextEditingFn(item,attach){var allowEditing=!0,itemStore=this.getDefaultItemStore();return item.belongsToItemStore(itemStore)&&(allowEditing=!1),allowEditing},getDraftForMessage:function getDraftForMessageFn(accountID,threadID,messageID){try{g.PAssert(4465,threadID,"Must have a valid thread ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4466,messageID,"Must have a valid message ID")}catch(PERR){g.reportError(PERR)}var draft,attach=this.getAttachment(threadID),msgIndex=attach.getField("messages").indexOfWithProperty("id",messageID);try{g.PAssert(4467,msgIndex>=0,"Must be able to find the requested message")}catch(PERR){g.reportError(PERR)}var draftCandidate=attach.getField("messages")[msgIndex+1];draftCandidate&&draftCandidate.labelIds.indexOf(SystemLabels.DRAFT)>=0?draft=draftCandidate:(this.createDraft(accountID,threadID,messageID),draft=attach.getField("messages")[msgIndex+1]);try{g.PAssert(4468,draft.labelIds.indexOf(SystemLabels.DRAFT)>=0,"Must return a valid draft")}catch(PERR){g.reportError(PERR)}return draft},getDraftByID:function getDraftByIDFn(accountID,threadID,messageID,initData){var attach,draftMsg;if(threadID){attach=this.getAttachment(threadID),draftMsg=messageID?this._getMessageFromAttachment(attach,messageID):attach.getField("messages")[0];try{g.PAssert(4469,draftMsg.labelIds.indexOf(SystemLabels.DRAFT)>=0,"Must be a valid draft")}catch(PERR){g.reportError(PERR)}}else{var draftData=this.createDraft(accountID,void 0,void 0,initData);attach=this.getAttachment(draftData.threadID),draftMsg=attach.getField("messages")[0]}return{attach:attach,draftMsg:draftMsg}},_notifyDraftMessage:function _notifyDraftMessageFn(accountID,threadID,messageID){setTimeout(function(){this._getRemoteDraftID(accountID,threadID,messageID,function(draftID){log("DraftID: ",draftID)})}.bind(this),0)},_updateModifiedOffline:function _updateModifiedOfflineFn(entry,fields){try{g.PAssert(4470,entry,"Must have a valid cache entry to update")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4471,g.isBoolean(fields)||g.isArray(fields),"Incoming fields must be valid")}catch(PERR){g.reportError(PERR)}var prevFields=entry.modifiedOffline||!1;try{g.PAssert(4472,g.isBoolean(prevFields)||g.isArray(prevFields),"Previous fields must be valid")}catch(PERR){g.reportError(PERR)}prevFields===!1?entry.modifiedOffline=fields:prevFields===!0?fields===!1&&(entry.modifiedOffline=!1):fields===!0?entry.modifiedOffline=!0:fields===!1?entry.modifiedOffline=!1:entry.modifiedOffline.pushOnlyUniques(fields)},_getInlineResources:function _getInlineResourcesFn(msg){var res={};for(var id in msg.resources)msg.resources[id].disposition===ContentDisposition.Inline&&(res[id]=g.clone(msg.resources[id]));return res},createDraft:function createDraftFn(accountID,threadID,messageID,initData){initData=initData||{};try{g.PAssert(4473,!initData.body||!initData.decoded,"Must not supply both a decoded field and a body")}catch(PERR){g.reportError(PERR)}this.sendEvent("CreateDraft");var newMessageID=g.generateTempId(),fromData=initData.from||this.getDefaultFromInfo(accountID),decodedData=initData.body||initData.decoded||"";""===decodedData&&(decodedData=this.createSignature(fromData.email));var fullMsgData={id:newMessageID,modifiedOffline:!0,labelIds:[SystemLabels.DRAFT],messageID:void 0,raw:"",decoded:decodedData,mimeType:MessagePartType.HTML,contentType:DefaultContentType,from:fromData,replyTo:this.getReplyToAddress(fromData.email),to:initData.to||[],cc:initData.cc||[],bcc:initData.bcc||[],snippet:"",subject:initData.subject||"",date:new Date,references:void 0,inReplyTo:void 0,resources:{}},threadData,cacheEntry;if(threadID){threadData=this.getCacheData(threadID);try{g.PAssert(4474,messageID,"When supplying a thread ID, must also supply a valid message ID")}catch(PERR){g.reportError(PERR)}var msgIndex=threadData.messages.indexOfWithProperty("id",messageID);try{g.PAssert(4475,msgIndex>=0,"If requesting a reply to a message, it must exist in the thread")}catch(PERR){g.reportError(PERR)}var replyMsg=threadData.messages[msgIndex];if(replyMsg){try{g.PAssert(4476,replyMsg.messageID,"Trying to reply to a message that does not have a valid MessageID")}catch(PERR){g.reportError(PERR)}fullMsgData.references=replyMsg.messageID+(replyMsg.references?" "+replyMsg.references:""),fullMsgData.inReplyTo=replyMsg.messageID,fullMsgData.resources=this._getInlineResources(replyMsg)}if(threadData.messages.splice(msgIndex+1,0,fullMsgData),this.hasAttachment(threadID)){var attach=this.getAttachment(threadID);this._updateAttachmentFromMessages(attach,ChangeType.Local),attach.notifyDataMutated(["messages"],ChangeType.Local)}this._updateModifiedOffline(threadData,["messages"]),cacheEntry=threadData}else threadData={id:newMessageID,accountID:accountID,modifiedOffline:!0,messages:[fullMsgData],labelIds:[SystemLabels.DRAFT],subject:initData.subject||"",from:accountID},cacheEntry=this.createEntryFromLocal(newMessageID,threadData),this.cacheData(cacheEntry.id,cacheEntry),this._ensureVMLIsForThread(threadData);return this._threadCache.cacheEntry(cacheEntry.id,this.serializeExternalData(cacheEntry)),{threadID:cacheEntry.id,draftID:newMessageID,messageID:messageID}},_updateDraftID:function _updateDraftIDFn(attach,messageID,draftInfo){try{g.PAssert(4477,draftInfo,"Must provide a valid set of draft info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4478,draftInfo.id&&draftInfo.message,"Draft info must contain valid data")}catch(PERR){g.reportError(PERR)}var needIDChange=attach.isLocalOnlyAttachment();needIDChange&&(this._handleThreadLabelUpdates(attach.getData(),[],attach.getData().labelIds),this.changeID(attach,attach.id,draftInfo.message.threadId),this._threadCache.removeEntry(messageID));var draft=this._findDraft(attach,messageID,draftInfo.id);if(draft){draft.id=draftInfo.message.id;try{g.PAssert(4479,draft.draftID===draftInfo.id,"Should have valid draft ID associated with the message")}catch(PERR){g.reportError(PERR)}this._draftCache[draft.id]=draftInfo.id,needIDChange&&this._ensureVMLIsForThread(attach.getData()),this._pendingDraftUpdates[messageID]&&(this._pendingDraftUpdates[draft.id]=this._pendingDraftUpdates[messageID],delete this._pendingDraftUpdates[messageID]),attach.notifyDataMutated(["messages"],ChangeType.Local),this._threadCache.cacheEntry(attach.id,this.serializeExternalData(attach.getData()))}},_updateDraftFromSend:function _updateDraftFromSendFn(attach,messageID,sentInfo){try{g.PAssert(4480,sentInfo,"Must provide a valid set of draft info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4481,sentInfo.id&&sentInfo.threadId,"Draft info must contain valid data")}catch(PERR){g.reportError(PERR)}var needIDChange=attach.isLocalOnlyAttachment();if(attach.isLocalOnlyAttachment()){this._handleThreadLabelUpdates(attach.getData(),[],attach.getData().labelIds),this.changeID(attach,attach.id,sentInfo.threadId);try{g.PAssert(4482,!g.isTempId(attach.id),"After an ID change, should never be a temp ID")}catch(PERR){g.reportError(PERR)}this._threadCache.removeEntry(messageID)}var draft=this._getMessageFromAttachment(attach,messageID);draft.id=sentInfo.id,draft.labelIds=sentInfo.labelIds,this._updateAttachmentFromMessages(attach,ChangeType.Remote),this._draftCache[draft.id]=sentInfo.id,this._pendingDraftUpdates[messageID]&&(this._pendingDraftUpdates[draft.id]=this._pendingDraftUpdates[messageID],delete this._pendingDraftUpdates[messageID]),attach.notifyDataMutated(["messages"],ChangeType.Local),this._threadCache.cacheEntry(attach.id,this.serializeExternalData(attach.getData()))},_createRemoteDraft:function _createRemoteDraftFn(attach,messageID,cb){if(!this._creatingDrafts[messageID]){this._creatingDrafts[messageID]=!0;var draft=this._getMessageFromAttachment(attach,messageID);this._createRFC822Message(attach.getData(),draft,!1,function(rawData){var messageData={raw:rawData};attach.isLocalOnlyAttachment()||(messageData.threadId=attach.id);var requestFn=["gapi","client","gmail","users","drafts","create"],requestData={userId:attach.getField("accountID"),resource:{message:messageData}},successCB=function(result){this._attachmentHasMessage(attach,messageID)&&(delete this._creatingDrafts[messageID],draft.draftID=result.id,this._updateModifiedOffline(attach.getData(),!1),this._updateModifiedOffline(draft,!1),this._pendingDraftUpdates[messageID]&&this._notifyPendingDraftUpdate(),this._updateDraftID(attach,messageID,result),this._updateIsSavingDrafts()),cb(!0)}.bind(this),failureCB=function(result){delete this._creatingDrafts[messageID],g.toasts.pushMessage(MessageID.EmailUpdateFail),this._updateIsSavingDrafts(),cb(!1,result),this._notifyFailedRequest(attach.getField("accountID"),result)}.bind(this);this._queueRemoteRequestMulti(attach.getField("accountID"),requestFn,requestData,successCB,failureCB,void 0,RequestType.DraftCreate)}.bind(this))}},_updateIsSavingDrafts:function _updateIsSavingDraftsFn(){g.isSavingDrafts=this._activeDraftUpdates>0||!g.isEmpty(this._pendingDraftUpdates)||!g.isEmpty(this._creatingDrafts)},_notifyPendingDraftUpdate:function _notifyPendingDraftUpdateFn(attach,messageID,forceFlush){attach&&messageID&&(this._pendingDraftUpdates[messageID]={attach:attach,lastUpdate:Date.now()},forceFlush&&this._runDraftUpdate(messageID)),this._draftFlushTimer&&clearTimeout(this._draftFlushTimer),this._draftFlushTimer=setTimeout(this._flushPendingDraftUpdates,DraftUpdateDelay),this._updateIsSavingDrafts()},_flushPendingDraftUpdates:function _flushPendingDraftUpdatesFn(){if(this.isOnline()){for(var messageID in this._pendingDraftUpdates)this._runDraftUpdate(messageID);this._draftFlushTimer=void 0}},_runDraftUpdate:function _runDraftUpdateFn(messageID){if(!this._creatingDrafts[messageID]){var draftInfo=this._pendingDraftUpdates[messageID];this._updateRemoteDraft(draftInfo.attach,messageID,!1,function(updateResult){updateResult?g.toasts.clearMessage(MessageID.EmailUpdateFail):g.toasts.pushMessage(MessageID.EmailUpdateFail),this._updateIsSavingDrafts()}.bind(this)),delete this._pendingDraftUpdates[messageID],this.sendEvent("UpdateDraft")}},_clearPendingDraftUpdate:function _clearPendingDraftUpdateFn(attach,messageID){var draftInfo=this._pendingDraftUpdates[messageID];if(draftInfo){try{g.PAssert(4483,draftInfo.attach===attach,"Must have the correct attachment for the draft update")}catch(PERR){g.reportError(PERR)}delete this._pendingDraftUpdates[messageID]}},hasPendingSends:function hasPendingSendsFn(){return this._pendingSends.length>0},notifyPendingSend:function notifyPendingSendFn(attach,messageID){try{g.PAssert(4484,!this._pendingSends[messageID],"Must not have an already pending send for a message")}catch(PERR){g.reportError(PERR)}this._pendingSends[messageID]=attach,g.isSendingEmail=!0},notifySent:function notifySentFn(attach,messageID){try{g.PAssert(4485,this._pendingSends[messageID],"Must have a pending send to be sent")}catch(PERR){g.reportError(PERR)}delete this._pendingSends[messageID],this.hasPendingSends()||(g.isSendingEmail=!1)},notifySendError:function notifySendErrorFn(attach,messageID){try{g.PAssert(4486,this._pendingSends[messageID],"Must have a pending send to have an error")}catch(PERR){g.reportError(PERR)}delete this._pendingSends[messageID],this.hasPendingSends()||(g.isSendingEmail=!1)},onShutdown:function onShutdownFn(){clearTimeout(this._draftFlushTimer),this._draftFlushTimer=void 0,this._flushPendingDraftUpdates(),this._updateIsSavingDrafts()},_getLinkedResources:function _getLinkedResourcesFn(resMap){var resources=[];for(var id in resMap){var res=resMap[id];"attachment"===res.disposition&&res.link&&resources.push(res)}return resources},_createDraftBody:function _createDraftBodyFn(body,resMap){var decoded;if(resMap){var resources=this._getLinkedResources(resMap);if(resources.length>0){for(var resString="<br/><br/>",i=0;i<resources.length;++i)resString+=this._getLinkedResourceString(resources[i]);decoded=body+'<div id="moodoAttach">'+resString+"</div>"}else decoded=body}else decoded=body;return decoded},updateDraft:function updateDraftFn(attach,messageID,draftID,data,snippet,updateRemoteDraft,forceFlush,cb){try{g.PAssert(4487,g.isBoolean(updateRemoteDraft),"Must supply a valid bool for updateRemoteDraft")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4488,g.isBoolean(forceFlush),"Must supply a valid bool for forceFlush")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4489,g.isFunction(cb),"Must supply a valid bool for cb")
}catch(PERR){g.reportError(PERR)}var draft;if(draftID){var messages=attach.getField("messages"),draftIndex=messages.indexOfWithProperty("draftID",draftID);try{g.PAssert(4490,draftIndex>=0,"Must have a valid draft in thread during update")}catch(PERR){g.reportError(PERR)}draft=messages[draftIndex]}else draft=this._getMessageFromAttachment(attach,messageID);if(draft)draft.to=data.to,draft.from=data.from||draft.from,draft.cc=data.cc,draft.bcc=data.bcc,draft.subject=data.subject,draft.decoded=this._createDraftBody(data.body||data.decoded,draft.resources),draft.snippet=snippet?g.escape(snippet.substring(0,30)):"",data.hasOwnProperty("resources")&&(draft.resources=data.resources),this._updateAttachmentFromMessages(attach,ChangeType.Local),attach.notifyDataMutated(["messages"],ChangeType.Local),this._threadCache.cacheEntry(attach.id,this.serializeExternalData(this.getCacheData(attach.id))),!this._creatingDrafts[messageID]&&updateRemoteDraft&&g.isTempId(messageID)?this._createRemoteDraft(attach,messageID,cb):(this._notifyPendingDraftUpdate(attach,messageID,forceFlush),cb(!0)),this._updateIsSavingDrafts();else{try{g.PAssert(4491,!1,"Unable to update draft as expected from compose window")}catch(PERR){g.reportError(PERR)}cb(!1)}return{threadID:attach.id,draftID:draftID,messageID:messageID}},_updateRemoteDraft:function _updateRemoteDraftFn(attach,messageID,includeAttachments,cb){try{g.PAssert(4492,!this._creatingDrafts[messageID],"Should not send a remote update while the original draft is being created")}catch(PERR){g.reportError(PERR)}var draft=this._getMessageFromAttachment(attach,messageID);try{g.PAssert(4493,draft&&draft.labelIds.indexOf(SystemLabels.DRAFT)>=0,"Must be updating a valid draft")}catch(PERR){g.reportError(PERR)}this._activeDraftUpdates++,this._getRemoteDraftID(attach.getField("accountID"),attach.id,messageID,function(draftID){if(draftID)this._createRFC822Message(attach.getData(),draft,includeAttachments,function(rawData){var requestFn=["gapi","client","gmail","users","drafts","update"],requestData={userId:attach.getField("accountID"),id:draftID,resource:{message:{raw:rawData,threadId:attach.id}}},successCB=function(result){this._updateDraftID(attach,messageID,result),this._activeDraftUpdates--,cb(result)}.bind(this),failureCB=function(result){cb(void 0,result),this._activeDraftUpdates--,this._notifyFailedRequest(attach.getField("accountID"),result)}.bind(this);this._queueRemoteRequestMulti(attach.getField("accountID"),requestFn,requestData,successCB,failureCB,void 0,RequestType.DraftUpdate)}.bind(this));else{try{g.PAssert(4494,!1,"Must always be able to get a valid draft ID when updating")}catch(PERR){g.reportError(PERR)}cb(!1)}}.bind(this))},sendDraft:function sendDraftFn(attach,messageID,scheduleTime,cb){try{g.PAssert(4495,!attach.getField("pendingSend"),"Should not try to re-send a message after it has already been sent")}catch(PERR){g.reportError(PERR)}var hasValidData=!0,msg=this._getMessageFromAttachment(attach,messageID),handleSendResponse=function(success,errorResult){success?(attach.updateField("pendingSend",!1),this._updateModifiedOffline(attach.getData(),!1),this._updateModifiedOffline(msg,!1),this.notifySent(attach,messageID)):(g.isHTTPStatusCode(errorResult,C.HTTPStatusCode.Network)||attach.updateField("pendingSend",!1),this.notifySendError(attach,messageID)),cb(success,errorResult)}.bind(this),errorInfo=this._verifyEmailRecipients(attach,messageID);if(errorInfo||(errorInfo=this._verifyEmailAttachments(attach,messageID)),errorInfo){hasValidData=!1;var errorMessage=g.toasts.pushMessage({text:errorInfo.message,action:MessageAction.Okay});errorInfo.handleMessageFn&&errorInfo.handleMessageFn(errorMessage),this.notifyPendingSend(attach,messageID),handleSendResponse(!1)}else if(!scheduleTime){attach.updateField("pendingSend",!0),this.notifyPendingSend(attach,messageID);var hasSent=!1;this.onEmailReadyToSend(msg,function(){try{g.PAssert(4496,!hasSent,"Should not send an email twice")}catch(PERR){g.reportError(PERR)}hasSent||(hasSent=!0,attach.isLocalOnlyAttachment()||g.isTempId(msg.id)?this._sendEmail(attach,messageID,handleSendResponse):this._sendRemoteDraft(attach,messageID,handleSendResponse))}.bind(this))}return hasValidData},onEmailReadyToSend:function onEmailReadyToSendFn(draft,cb){var uploadsDone=!0;for(var id in draft.resources){var res=draft.resources[id];if(res.uploader&&!res.uploader.isDone())if(uploadsDone=!1,res.uploader.hasError())try{g.PAssert(4497,!1,"Attachment has error when sending.")}catch(PERR){g.reportError(PERR)}else res.uploader.notifyOnComplete(this.onEmailReadyToSend.bind(this,draft,cb))}uploadsDone&&setTimeout(cb,0)},_sendRemoteDraft:function _sendRemoteDraftFn(attach,messageID,cb){this.sendEvent("SendDraft"),this._clearPendingDraftUpdate(attach,messageID),this._getRemoteDraftID(attach.getField("accountID"),attach.id,messageID,function(draftID){if(draftID)this._updateRemoteDraft(attach,messageID,!0,function(updateResult){if(updateResult&&updateResult.message){var requestFn=["gapi","client","gmail","users","drafts","send"],requestData={userId:attach.getField("accountID"),resource:{id:draftID}},successCB=function(result){this._updateLocalDraftFromSend(attach,updateResult.message.id,result,cb)}.bind(this),failureCB=function(result){this._notifySendFailed(),cb(!1,result),this._notifyFailedRequest(attach.getField("accountID"),result)}.bind(this);this._queueRemoteRequestMulti(attach.getField("accountID"),requestFn,requestData,successCB,failureCB,void 0,RequestType.DraftSend)}else g.toasts.pushMessage(MessageID.EmailUpdateFail),cb(!1)}.bind(this));else{try{g.PAssert(4498,!1,"Must always be able to get a valid draft ID when sending")}catch(PERR){g.reportError(PERR)}g.toasts.pushMessage(MessageID.EmailUpdateFail),cb(!1)}}.bind(this))},_updateLocalDraftFromSend:function _updateLocalDraftFromSendFn(attach,messageID,result,cb){try{g.PAssert(4499,result,"Must have a valid draft result")}catch(PERR){g.reportError(PERR)}var sentMessage=this._getMessageFromAttachment(attach,messageID);try{g.PAssert(4500,sentMessage,"Must always be able to find the sent message")}catch(PERR){g.reportError(PERR)}this._updateModifiedOffline(attach.getData(),!1),this._updateModifiedOffline(sentMessage,!1),this._updateDraftFromSend(attach,messageID,result),g.isDemoMode()||this._requestRemoteMessageData(attach,result.id,function(success){try{g.PAssert(4501,success,"Should always be able to update message data after send")}catch(PERR){g.reportError(PERR)}}),cb(!0)},runDiscardDraft:function runDiscardDraftFn(attach){var draft=this._getDraftFromAttachment(attach);this.discardDraft(attach,draft.id,function(success){try{g.PAssert(4502,success,"Must be able to discard message draft")}catch(PERR){g.reportError(PERR)}})},discardDraft:function discardDraftFn(attach,messageID,cb){var threadData=attach.getData(),draftIndex=threadData.messages.indexOfWithProperty("id",messageID);try{g.PAssert(4503,draftIndex>=0,"If requesting a draft, must have a valid message")}catch(PERR){g.reportError(PERR)}g.isTempId(messageID)?cb(!0):this._deleteRemoteDraft(attach,messageID,cb);var draft=threadData.messages[draftIndex];threadData.messages.splice(draftIndex,1),this._removeRemoteResources(draft),this._updateAttachmentFromMessages(attach,ChangeType.Local),this._clearPendingDraftUpdate(attach,messageID),attach.notifyDataMutated(["messages"],ChangeType.Local),this._threadCache.cacheEntry(threadData.id,this.serializeExternalData(threadData)),this.sendEvent("DiscardDraft")},_removeRemoteResources:function _removeRemoteResourcesFn(draft){for(var id in draft.resources){var res=draft.resources[id];res.uploader&&!res.uploader.isDone()&&res.uploader.cancel()}},_deleteRemoteDraft:function _deleteRemoteDraftFn(attach,messageID,cb){try{g.PAssert(4504,!g.isTempId(messageID),"Should not try to remotely delete a local message")}catch(PERR){g.reportError(PERR)}this._getRemoteDraftID(attach.getField("accountID"),attach.id,messageID,function(draftID){if(draftID){var requestFn=["gapi","client","gmail","users","drafts","delete"],requestData={userId:attach.getField("accountID"),id:draftID},successCB=function(result){cb(!0)},failureCB=function(result){g.isHTTPStatusCode(result,C.HTTPStatusCode.NotFound)?cb(!0):cb(!1,result),this._notifyFailedRequest(attach.getField("accountID"),result)}.bind(this);this._queueRemoteRequestMulti(attach.getField("accountID"),requestFn,requestData,successCB,failureCB,void 0,RequestType.DraftDelete)}else{try{g.PAssert(4505,!1,"Must always be able to get a valid draft ID when deleting")}catch(PERR){g.reportError(PERR)}g.toasts.pushMessage(MessageID.EmailUpdateFail),cb(!1)}}.bind(this))},_getRemoteDraftID:function _getRemoteDraftIDFn(accountID,threadID,messageID,cb){try{g.PAssert(4506,g.isString(accountID),"Must provide a valid accountID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4507,g.isString(messageID)&&!g.isTempId(messageID),"Should not try to remotely get the draft ID of a local draft")}catch(PERR){g.reportError(PERR)}var attach=this.getAttachment(threadID);try{g.PAssert(4508,attach,"Must be able to find a valid attachment for the requested thread")}catch(PERR){g.reportError(PERR)}var msg=this._getMessageFromAttachment(attach,messageID);try{g.PAssert(4509,msg,"Must be able to find a valid message for the requested draft")}catch(PERR){g.reportError(PERR)}if(msg)if(msg.draftID)setTimeout(cb,0,msg.draftID);else{try{g.PAssert(4510,msg.messageID,"Must have a valid messageID for the draft being queried")}catch(PERR){g.reportError(PERR)}if(msg.messageID){var requestFn=["gapi","client","gmail","users","drafts","list"],requestData={userId:accountID,q:"rfc822msgid:"+msg.messageID},options={getAllPages:!0,resultsField:"drafts"},successCB=function(results){try{g.PAssert(4511,results&&1===results.length,"Must find only a single draft ID for a given message")}catch(PERR){g.reportError(PERR)}if(results)for(var i=0;i<results.length;++i){var res=results[i];if(1===results.length||res.message.threadId===threadID){try{g.PAssert(4512,!msg.draftID||msg.draftID===res.id,"Draft ID must either match or not be known yet")}catch(PERR){g.reportError(PERR)}msg.draftID=res.id}}cb(msg.draftID)}.bind(this),failureCB=function(result){cb(void 0),this._notifyFailedRequest(accountID,result)};this._queuePagedRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.DraftList,options)}else setTimeout(cb,0,void 0)}else setTimeout(cb,0,void 0)},_attachmentHasMessage:function _attachmentHasMessageFn(attach,messageID){var messages=attach.getField("messages"),draftIndex=messages.indexOfWithProperty("id",messageID);return draftIndex>=0},_getMessageFromAttachment:function _getMessageFromAttachmentFn(attach,messageID){var messages=attach.getField("messages"),draftIndex=messages.indexOfWithProperty("id",messageID);try{g.PAssert(4513,draftIndex>=0,"Must have a vald draft")}catch(PERR){g.reportError(PERR)}return messages[draftIndex]},_getDraftFromAttachment:function _getDraftFromAttachmentFn(attach,draftID){for(var draft,messages=attach.getField("messages"),i=0;i<messages.length;++i)if(messages[i].labelIds.indexOf(SystemLabels.DRAFT)>=0){draftID&&draftID!==messages[i].draftID||(draft=messages[i]);break}return draft},_findDraft:function _findDraftFn(attach,messageID,draftID){var draft,messages=attach.getField("messages"),msgIndex=messages.indexOfWithProperty("id",messageID);if(msgIndex>=0)draft=messages[msgIndex];else{var draftIndex=messages.indexOfWithProperty("draftID",draftID);draftIndex>=0&&(draft=messages[draftIndex])}return draft},isAttachmentDraftOnly:function isAttachmentDraftOnlyFn(attach){return this.attachmentHasLabel(attach,SystemLabels.DRAFT)&&1===attach.getField("messages").length},archiveAttachment:function archiveAttachmentFn(attach){try{g.PAssert(4514,!this.attachmentIsArchived(attach),"Should not archive a thread that is already archived")}catch(PERR){g.reportError(PERR)}return this.sendEvent("ArchiveMail"),this.removeLabelFromAttachment(attach,SystemLabels.INBOX)},unarchiveAttachment:function unarchiveAttachmentFn(attach){try{g.PAssert(4515,this.attachmentIsArchived(attach),"Thread must be unarchived to archive it")}catch(PERR){g.reportError(PERR)}return this.sendEvent("UnarchiveMail"),this.addLabelToAttachment(attach,SystemLabels.INBOX)},trashAttachment:function trashAttachmentFn(attach){return this.sendEvent("TrashMail"),this.trashMail(attach.getField("accountID"),attach.id,void 0,function(success){try{g.PAssert(4516,success,"Must have successfully trashed remote thread")}catch(PERR){g.reportError(PERR)}})},untrashAttachment:function untrashAttachmentFn(attach){return this.sendEvent("UntrashMail"),this.untrashMail(attach.getField("accountID"),attach.id,void 0,function(success){try{g.PAssert(4517,success,"Must have successfully untrashed remote thread")}catch(PERR){g.reportError(PERR)}})},markAttachmentRead:function markAttachmentReadFn(attach){return this.sendEvent("MarkMailRead"),this.removeLabelFromAttachment(attach,SystemLabels.UNREAD)},markAttachmentUnread:function markAttachmentUnreadFn(attach){return this.sendEvent("MarkMailUnread"),this.addLabelToAttachment(attach,SystemLabels.UNREAD)},snoozeAttachment:function snoozeAttachmentFn(attach,delay){this.sendEvent("SnoozeThread");var scheduleTimeMS=Date.now()+delay,scheduleDate=new Date(scheduleTimeMS);this.addLabelToAttachment(attach,SnoozeLabelName),this.attachmentHasLabel(attach,SystemLabels.INBOX)&&this.removeLabelFromAttachment(attach,SystemLabels.INBOX),this.attachmentHasLabel(attach,SystemLabels.UNREAD)&&this.removeLabelFromAttachment(attach,SystemLabels.UNREAD);var snoozeData={scheduleDate:scheduleDate.toISOString(),gidLinked:AccountManager.getAccountGID(attach.getField("accountID")),threadID:attach.id,labelID:this._getLabelByName(attach.getField("accountID"),SnoozeLabelName).getLabelID()};this.scheduleDeferredTask(attach.id,DeferredTaskType.Snooze,scheduleDate,snoozeData)},unsnoozeAttachment:function unsnoozeAttachmentFn(attach){this.sendEvent("UnsnoozeThread"),this.removeLabelFromAttachment(attach,SnoozeLabelName),this.addLabelToAttachment(attach,SystemLabels.INBOX),this.addLabelToAttachment(attach,SystemLabels.UNREAD),this.cancelDeferredTask(attach.id,DeferredTaskType.Snooze)},_handleDeferredSnoozeTask:function _handleDeferredSnoozeTaskFn(task){var data=task.getData();try{g.PAssert(4518,data.gidLinked,"Must have valid accountID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4519,data.threadID,"Must have a valid threadID")}catch(PERR){g.reportError(PERR)}log("Handling deferred snooze: ",task);var accountID=AccountManager.getAccountEmail(data.gidLinked),scheduleDate=new Date(data.scheduleDate);this.setLastModifiedDate(accountID,data.threadID,scheduleDate),task.isPersistedRemote()?(this.removeLabelsFromMessage(accountID,data.threadID,void 0,[data.labelID],ChangeType.Auto),this.addLabelsToMessage(accountID,data.threadID,void 0,[SystemLabels.INBOX,SystemLabels.UNREAD],ChangeType.Auto)):(this.removeLabel(accountID,data.threadID,void 0,SnoozeLabelName),this.addLabel(accountID,data.threadID,void 0,SystemLabels.INBOX),this.addLabel(accountID,data.threadID,void 0,SystemLabels.UNREAD))},scheduleSendMessage:function scheduleSendMessageFn(attach,messageID,delay){this.sendEvent("ScheduleMail");var scheduleTimeMS=Date.now()+delay,scheduleDate=new Date(scheduleTimeMS);this._getRemoteDraftID(attach.getField("accountID"),attach.id,messageID,function(draftID){if(draftID){this.addLabelFromAttachment(attach,ScheduledSendLabelName);var sendData={delay:delay,scheduleDate:scheduleDate.toISOString(),gidLinked:AccountManager.getAccountGID(attach.getField("accountID")),threadID:attach.id,draftID:draftID,labelID:this._getLabelByName(attach.getField("accountID"),ScheduledSendLabelName).getLabelID()};this.scheduleDeferredTask(draftID,DeferredTaskType.SendMail,scheduleDate,sendData)}}.bind(this))},cancelSendMessage:function cancelSendMessageFn(attach,messageID){this.sendEvent("UnscheduleMail"),this.removeLabelFromAttachment(attach,ScheduledSendLabelName),this._getRemoteDraftID(attach.getField("accountID"),attach.id,messageID,function(draftID){draftID&&this.cancelDeferredTask(draftID,DeferredTaskType.SendMail)}.bind(this))},_handleDeferredSendMailTask:function _handleDeferredSendMailTaskFn(task){var data=task.getData();try{g.PAssert(4520,data.gidLinked,"Must have valid gidLinked")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4521,data.threadID,"Must have a valid threadID")}catch(PERR){g.reportError(PERR)}log("Handling deferred send mail: ",data)},_ensureNoPriority:function _ensureNoPriorityFn(attach){var origLabel=VMLIFlag.None;return this.attachmentHasLabel(attach,PriorityLabels.PRI0)&&(this.removeLabelFromAttachment(attach,PriorityLabels.PRI0),origLabel=VMLIFlag.P0),this.attachmentHasLabel(attach,PriorityLabels.PRI1)&&(this.removeLabelFromAttachment(attach,PriorityLabels.PRI1),origLabel=VMLIFlag.P1),this.attachmentHasLabel(attach,PriorityLabels.PRI2)&&(this.removeLabelFromAttachment(attach,PriorityLabels.PRI2),origLabel=VMLIFlag.P2),origLabel},getAttachmentPriority:function getAttachmentPriorityFn(attach){return this._attachmentHasPriorityLabel(attach,VMLIFlag.P0)&&VMLIFlag.P0||this._attachmentHasPriorityLabel(attach,VMLIFlag.P1)&&VMLIFlag.P1||this._attachmentHasPriorityLabel(attach,VMLIFlag.P2)&&VMLIFlag.P2||VMLIFlag.None},setAttachmentPriority:function setAttachmentPriorityFn(attach,pri){this.sendEvent("SetMailPriority");var origPriority=this._ensureNoPriority(attach);switch(pri){case VMLIFlag.None:break;case VMLIFlag.P0:this.addLabelToAttachment(attach,PriorityLabels.PRI0);break;case VMLIFlag.P1:this.addLabelToAttachment(attach,PriorityLabels.PRI1);break;case VMLIFlag.P2:this.addLabelToAttachment(attach,PriorityLabels.PRI2);break;default:try{g.PAssert(4522,!1,"Invalid priority for email attachment")}catch(PERR){g.reportError(PERR)}}return origPriority},markAttachmentStarred:function markAttachmentStarredFn(attach){return this.sendEvent("StarMail"),this.addLabelToAttachment(attach,SystemLabels.STARRED)},markAttachmentUnstarred:function markAttachmentUnstarredFn(attach){return this.sendEvent("UnstarMail"),this.removeLabelFromAttachment(attach,SystemLabels.STARRED)},attachmentHasLabelByID:function attachmentHasLabelByIDFn(attach,labelID){return this.hasLabelByID(attach.getField("accountID"),attach.id,void 0,labelID)},attachmentHasLabel:function attachmentHasLabelFn(attach,labelName){return this.hasLabel(attach.getField("accountID"),attach.id,void 0,labelName)},attachmentHasFullLabel:function attachmentHasFullLabelFn(attach,labelName){return this.hasFullLabel(attach.getField("accountID"),attach.id,labelName)},attachmentIsArchived:function attachmentIsArchivedFn(attach){return this._threadIsArchived(attach.getData())},addLabelToAttachment:function addLabelToAttachmentFn(attach,labelName){return this.addLabel(attach.getField("accountID"),attach.id,void 0,labelName)},removeLabelFromAttachment:function removeLabelFromAttachmentFn(attach,labelName){return this.removeLabel(attach.getField("accountID"),attach.id,void 0,labelName)},trashMail:function trashMailFn(accountID,threadID,msgID,cb){var attach=this.getAttachment(threadID);this.isAttachmentDraftOnly(attach)?this.discardDraft(attach,attach.getField("messages")[0].id,cb):(this.removeLabelsFromMessage(accountID,threadID,msgID,[SystemLabels.INBOX],ChangeType.Local),this.addLabelsToMessage(accountID,threadID,msgID,[SystemLabels.TRASH],ChangeType.Local),g.isTempId(threadID)?cb(!0):this._trashRemoteMail(accountID,threadID,msgID,cb))},untrashMail:function untrashMailFn(accountID,threadID,msgID,cb){this.removeLabelsFromMessage(accountID,threadID,msgID,[SystemLabels.TRASH],ChangeType.Local),this.addLabelsToMessage(accountID,threadID,msgID,[SystemLabels.INBOX],ChangeType.Local),g.isTempId(threadID)?cb(!0):this._untrashRemoteMail(accountID,threadID,msgID,cb)},moveItem:function moveItemFn(attach,item,target){return target.insertItem(item,0),[item,target]},unmoveItem:function unmoveItemFn(attach,item,target){return target.removeChild(item,ChangeType.Local),[item,target]},hasLabelByID:function hasLabelByIDFn(accountID,threadID,msgID,labelID){try{g.PAssert(4523,!msgID,"We don't support individual queries on messages, only threads")}catch(PERR){g.reportError(PERR)}var attach=this.getAttachment(threadID);return attach.getField("labelIds").indexOf(labelID)>=0},hasLabel:function hasLabelFn(accountID,threadID,msgID,labelName){try{g.PAssert(4524,!msgID,"We don't support individual queries on messages, only threads")}catch(PERR){g.reportError(PERR)}var hasLabel=!1;if(!msgID){var label=this._getLabelByName(accountID,labelName);label&&(hasLabel=this.hasLabelByID(accountID,threadID,msgID,label.getLabelID()))}return hasLabel},hasFullLabel:function hasFullLabelFn(accountID,threadID,labelName){var hasFullLabel=!1,data=this.getCacheData(threadID),label=this._getLabelByName(accountID,labelName);if(label){var msgs=data.messages;hasFullLabel=!0;for(var i=0;i<msgs.length;++i)if(msgs[i].labelIds.indexOf(label.getLabelID())<0){hasFullLabel=!1;break}}return hasFullLabel},hasLabelLike:function hasLabelLikeFn(accountID,threadID,partialName){var hasLabel=!1,attach=this.getAttachment(threadID),labelIds=attach.getField("labelIds"),accountLabels=this._labels[accountID];if(accountLabels)for(var i=0;i<labelIds.length;++i){var label=accountLabels[labelIds[i]];label&&label.isMatched(partialName)&&(hasLabel=!0)}return hasLabel},addLabel:function addLabelFn(accountID,threadID,msgID,labelName){try{g.PAssert(4525,!msgID,"We currently do not support setting labels on single messages")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4526,!this.hasLabel(accountID,threadID,msgID,labelName),"Should not add the same label to a thread/message twice")}catch(PERR){g.reportError(PERR)}var label=this._getLabelByName(accountID,labelName);if(label)label.isLocalOnly()?this._createRemoteLabel(accountID,labelName,function(result){if(result){try{g.PAssert(4528,result,"Should have successfully created the remote label")}catch(PERR){g.reportError(PERR)}this._changeLabelID(accountID,label.getLabelID(),result.id),this._modifyRemoteThreadLabels(accountID,threadID,[result.id],void 0)}}.bind(this)):this._modifyRemoteThreadLabels(accountID,threadID,[label.getLabelID()],void 0);else{var labelID=g.generateTempId();label=this._ensureLabel(accountID,labelID,labelName,void 0,void 0,ChangeType.Local),this._ensureVMLIsForLabel(accountID,label),this._writeLabelsToCache(function(localSuccess){localSuccess&&this._createRemoteLabel(accountID,labelName,function(result){try{g.PAssert(4527,result,"Should have successfully created the remote label")}catch(PERR){g.reportError(PERR)}result&&(this._changeLabelID(accountID,labelID,result.id),this._modifyRemoteThreadLabels(accountID,threadID,[result.id],void 0))}.bind(this))}.bind(this))}return this.addLabelsToMessage(accountID,threadID,msgID,[label.getLabelID()],ChangeType.Local),labelName},removeLabel:function removeLabelFn(accountID,threadID,msgID,labelName){try{g.PAssert(4529,!msgID,"We currently do not support setting labels on single messages")}catch(PERR){g.reportError(PERR)}var label=this._getLabelByName(accountID,labelName);try{g.PAssert(4530,label,"Must have valid label for gmail in order to remove")}catch(PERR){g.reportError(PERR)}return label&&!label.isLocalOnly()&&this._modifyRemoteThreadLabels(accountID,threadID,void 0,[label.getLabelID()]),this.removeLabelsFromMessage(accountID,threadID,msgID,[label.getLabelID()],ChangeType.Local),labelName},_threadIsArchived:function _threadIsArchivedFn(thread){if(thread){var hasInbox=thread.labelIds.indexOf(SystemLabels.INBOX)>=0,hasTrash=this.hasFullLabel(thread.accountID,thread.id,SystemLabels.TRASH),hasSpam=thread.labelIds.indexOf(SystemLabels.SPAM)>=0,hasDraft=thread.labelIds.indexOf(SystemLabels.DRAFT)>=0;return!(g.isTempId(thread.id)||hasInbox||hasTrash||hasSpam||hasDraft)}return!1},_trashRemoteMail:function _trashRemoteMailFn(accountID,threadID,msgID,cb){try{g.PAssert(4531,!g.isTempId(threadID),"Should not try to trash local only threads")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4532,!msgID||!g.isTempId(msgID),"Should not try to trash local only messages")}catch(PERR){g.reportError(PERR)}var requestFn,requestData;msgID?(requestFn=["gapi","client","gmail","users","messages","trash"],requestData={userId:accountID,id:msgID}):(requestFn=["gapi","client","gmail","users","threads","trash"],requestData={userId:accountID,id:threadID});var successCB=function(result){cb(!0)},failureCB=function(result){cb(!1,result),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.Trash)},_untrashRemoteMail:function _untrashRemoteMailFn(accountID,threadID,msgID,cb){try{g.PAssert(4533,!g.isTempId(threadID),"Should not try to untrash local only threads")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4534,!msgID||!g.isTempId(msgID),"Should not try to untrash local only messages")}catch(PERR){g.reportError(PERR)}var requestFn,requestData;msgID?(requestFn=["gapi","client","gmail","users","messages","untrash"],requestData={userId:accountID,id:msgID}):(requestFn=["gapi","client","gmail","users","threads","untrash"],requestData={userId:accountID,id:threadID});var successCB=function(result){cb(!0)},failureCB=function(result){cb(!1,result),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.Trash)},_createRemoteLabel:function _createRemoteLabelFn(accountID,labelName,cb){var requestFn=["gapi","client","gmail","users","labels","create"],requestData={userId:accountID,resource:{name:labelName,labelListVisibility:"labelHide",messageListVisibility:"hide"}},successCB=function(result){cb&&cb(result)},failureCB=function(result){g.isHTTPStatusCode(result,C.HTTPStatusCode.Conflict)?cb&&cb(void 0,result):(cb&&cb(void 0,result),this._notifyFailedRequest(accountID,result))}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.CreateLabel)},_modifyRemoteThreadLabels:function _modifyRemoteThreadLabelsFn(accountID,threadID,addLabelIDs,removeLabelIDs,cb){var requestFn=["gapi","client","gmail","users","threads","modify"],requestData={userId:accountID,id:threadID,resource:{addLabelIds:addLabelIDs,removeLabelIds:removeLabelIDs}},successCB=function(result){cb&&cb(result)},failureCB=function(result){cb&&cb(void 0,result),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.ModifyLabels)},_ensureRemoteLabel:function _ensureRemoteLabelFn(accountID,labelName,changeType,cb){this._getLabelByName(accountID,labelName)?cb&&cb(!0):(this._ensureLabel(accountID,g.generateTempId(),labelName,void 0,void 0,changeType),this._createRemoteLabel(accountID,labelName,function(result,errorResult){try{g.PAssert(4535,result,"Should have successful root label creation")}catch(PERR){g.reportError(PERR)}cb&&cb(!!result)}))},_ensureLabel:function _ensureLabelFn(accountID,labelID,labelName,oldestSync,options,changeType){var labelGroup=this._labels[accountID];if(labelGroup||(labelGroup=this._labels[accountID]={}),labelGroup[labelID])(g.isRemoteChange(changeType)||!labelGroup[labelID].hasName())&&labelGroup[labelID].updateLabelName(labelName);else{var sameNameLabel=this._getLabelByName(accountID,labelName);if(sameNameLabel)sameNameLabel.isLocalOnly()&&!g.isTempId(labelID)?this._changeLabelID(accountID,sameNameLabel.getLabelID(),labelID):sameNameLabel.isLocalOnly()||(this._labels[accountID][labelID]=sameNameLabel);else{try{g.PAssert(4537,labelName||!g.isTempId(labelID),"All local labels must have a valid name")}catch(PERR){g.reportError(PERR)}labelGroup[labelID]=new GmailLabel(accountID,labelID,labelName,this._clampSyncTime(oldestSync),options,labelGroup)}}return labelGroup[labelID]},_clampSyncTime:function _clampSyncTimeFn(rawSyncTime){var syncTime;return syncTime=rawSyncTime&&rawSyncTime.isBefore(this._getMetadataSyncTime())?this._getMetadataSyncTime():rawSyncTime},_ensureLabelVMLIsForAccount:function _ensureLabelVMLIsForAccountFn(accountID){var labelGroup=this._labels[accountID];for(var labelID in labelGroup)this._ensureVMLIsForLabel(accountID,labelGroup[labelID])},_changeLabelID:function _changeLabelIDFn(accountID,oldLabelID,newLabelID){var label=this._getLabelByID(accountID,oldLabelID,!0);g.vmMain.beginUpdateItems(),label.updateLabelID(newLabelID);var labelGroup=this._labels[accountID];labelGroup[newLabelID]=label,this._ensureVMLIsForLabel(accountID,label),g.vmMain.commitUpdateItems(),this.forEachAttachment(function(attach){var labelIDs=attach.getField("labelIds");if(labelIDs.remove(oldLabelID)>=0){for(var messages=attach.getField("messages"),i=0;i<messages.length;++i)messages[i].labelIds.remove(oldLabelID)>=0&&messages[i].labelIds.push(newLabelID);labelIDs.push(newLabelID),attach.updateField("labelIds",labelIDs)}});var itemStore=itemStore||this.getDefaultItemStore(),oldItemID="L~"+accountID+"~"+oldLabelID;itemStore.hasItem(oldItemID)&&itemStore.destroyItem(oldItemID)},labelExists:function labelExistsFn(accountID,labelID){return this._labels[accountID]&&this._labels[accountID][labelID]},_getLabelByID:function _getLabelByIDFn(accountID,labelID){try{g.PAssert(4540,accountID,"Must supply a valid accountID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4541,labelID,"Must supply a valid labelID")}catch(PERR){g.reportError(PERR)}if(this._labels[accountID]||(this._labels[accountID]={}),!this._labels[accountID][labelID]){var labelName=SystemLabels[labelID];this._labels[accountID][labelID]=new GmailLabel(accountID,labelID,labelName,void 0,void 0,this._labels[accountID])}return this._labels[accountID][labelID]},_getLabelByName:function _getLabelByNameFn(accountID,labelName){var labels=this._labels[accountID];if(labels)for(var id in labels)if(labels[id].isNamed(labelName))return labels[id];return void 0},_getPriorityLabel:function _getPriorityLabelFn(accountID,pri){if(this._priorityLabels[accountID]||(this._priorityLabels[accountID]={}),!this._priorityLabels[accountID][pri]){var labelName;switch(pri){case VMLIFlag.P0:labelName=PriorityLabels.PRI0;break;case VMLIFlag.P1:labelName=PriorityLabels.PRI1;break;case VMLIFlag.P2:labelName=PriorityLabels.PRI2;break;default:try{g.PAssert(4542,!1,"Invalid priority for email attachment")}catch(PERR){g.reportError(PERR)}}this._priorityLabels[accountID][pri]=this._getLabelByName(accountID,labelName)}return this._priorityLabels[accountID][pri]},_attachmentHasPriorityLabel:function _attachmentHasPriorityLabelFn(attach,pri){var label=this._getPriorityLabel(attach.getField("accountID"),pri);return label?attach.getField("labelIds").indexOf(label.getLabelID())>=0:!1},getLabels:function getLabelsFn(text,maxResults){var labels=[],searchText=text.toLowerCase(),num=0;for(var accountID in this._labels){var labelGroup=this._labels[accountID];for(var labelID in labelGroup){var label=labelGroup[labelID];if(label.matchesText(searchText)&&this.isDisplayTag(label)&&labels.indexOf(label)<0&&(labels.push(label),num++),maxResults&&num>=maxResults)break}if(maxResults&&num>=maxResults)break}return labels},_writeLabelsToCache:function _writeLabelsToCacheFn(cb){var cacheData={};for(var accountID in this._labels){cacheData[accountID]={};var labelGroup=this._labels[accountID];for(var labelID in labelGroup)cacheData[accountID][labelID]=labelGroup[labelID].getSaveData()}this._threadCache.setMetadata(CacheMetadata.Labels,cacheData,cb)},_writeSendAsToCache:function _writeSendAsToCacheFn(cb){var cacheData={};this._iterateSendAs(function(accountID,entry){cacheData[accountID]||(cacheData[accountID]=[]),cacheData[accountID].push(entry)}),this._threadCache.setMetadata(CacheMetadata.SendAs,cacheData,cb)},runLabelSync:function runLabelSyncFn(cb){this._threadCache.onCacheMetadataReady(function(){for(var checkLabelSyncDone=function(accountID,labels){if(g.vmMain.beginUpdateItems(),labels)for(var i=0;i<labels.length;++i)this._ensureLabel(accountID,labels[i].id,labels[i].name,void 0,labels[i],ChangeType.Remote);
this._ensureLabelVMLIsForAccount(accountID),this._ensureRemoteLabel(accountID,RootLabelName,ChangeType.Local),this._ensureRemoteLabel(accountID,PriorityLabels.PRI0,ChangeType.Local),this._ensureRemoteLabel(accountID,PriorityLabels.PRI1,ChangeType.Local),this._ensureRemoteLabel(accountID,PriorityLabels.PRI2,ChangeType.Local),this._ensureRemoteLabel(accountID,SnoozeLabelName,ChangeType.Local),this._ensureRemoteLabel(accountID,HandledLabelName,ChangeType.Local),this._ensureRemoteLabel(accountID,ScheduleLabelName,ChangeType.Local),this._ensureRemoteLabel(accountID,ScheduledSendLabelName,ChangeType.Local);var localLabels=this._labels[accountID];if(localLabels)for(var localID in localLabels){var localLabel=localLabels[localID];if(localLabel.isLocalOnly()){try{g.PAssert(4543,localLabel.hasName(),"Label must have a valid name to be created on remote")}catch(PERR){g.reportError(PERR)}this._createRemoteLabel(accountID,localLabel.getName(),function(labelID,result){result&&this._changeLabelID(accountID,labelID,result.id)}.bind(this,localID))}}g.vmMain.commitUpdateItems(),this._writeLabelsToCache(),numLabelsFail+numLabelsSuccess===numLabelRequests&&cb&&cb()}.bind(this),syncAccounts=this.getSyncAccounts(),numLabelRequests=syncAccounts.length,numLabelsSuccess=0,numLabelsFail=0,successCB=function(accountID,result){numLabelsSuccess++,checkLabelSyncDone(accountID,result.labels)},failureCB=function(accountID,result){numLabelsFail++,checkLabelSyncDone(accountID),this._notifyFailedRequest(result)}.bind(this),i=0;i<syncAccounts.length;++i){var requestFn=["gapi","client","gmail","users","labels","list"],requestData={userId:syncAccounts[i],timeoutMS:0};this._queueRemoteRequestMulti(syncAccounts[i],requestFn,requestData,successCB.bind(this,syncAccounts[i]),failureCB.bind(this,syncAccounts[i]),void 0,RequestType.Labels)}}.bind(this))},getDescriptorForItem:function getDescriptorForItemFn(item){try{g.PAssert(4545,item,"Must have a valid item to get a description for")}catch(PERR){g.reportError(PERR)}var accountID=this._getAccountIDFromItem(item),labelID=this._getLabelIDFromItem(item),threadID=this._getThreadIDFromItem(item),desc={accountID:accountID,labelID:labelID,threadID:threadID};if(accountID&&labelID){var label=this._getLabelByID(accountID,labelID);desc.labelName=label.getName()}return desc},handleItemChange:function handleItemChangeFn(item,cb){this._threadCache.onCacheReady(function(){this._threadCache.onCacheMetadataReady(function(){var desc=this.getDescriptorForItem(item);if(desc.labelID){try{g.PAssert(4546,desc.accountID,"Must specify a valid accountID")}catch(PERR){g.reportError(PERR)}this._getThreadsForLabel(desc.accountID,this._getLabelByID(desc.accountID,desc.labelID),item,function(success){try{g.PAssert(4547,success,"Expected success when querying for remote threads")}catch(PERR){g.reportError(PERR)}cb&&cb()})}}.bind(this))}.bind(this))},handleSortChange:function handleSortChangeFn(item,newSort){newSort===C.GmailSortType.Priority&&this._threadCache.onCacheReady(function(){var accountID=this._getAccountIDFromItem(item),labelP0=this._getLabelByName(accountID,PriorityLabels.PRI0);labelP0&&this._getThreadsForLabel(accountID,labelP0,void 0,function(success){try{g.PAssert(4548,success,"Expected success when querying for remote PRI0 threads")}catch(PERR){g.reportError(PERR)}});var labelP1=this._getLabelByName(accountID,PriorityLabels.PRI1);labelP1&&this._getThreadsForLabel(accountID,labelP1,void 0,function(success){try{g.PAssert(4549,success,"Expected success when querying for remote PRI1 threads")}catch(PERR){g.reportError(PERR)}});var labelP2=this._getLabelByName(accountID,PriorityLabels.PRI2);labelP2&&this._getThreadsForLabel(accountID,labelP2,void 0,function(success){try{g.PAssert(4550,success,"Expected success when querying for remote PRI2 threads")}catch(PERR){g.reportError(PERR)}})}.bind(this))},_getThreadsForLabel:function _getThreadsForLabelFn(accountID,label,reqItem,cb){try{g.PAssert(4551,label,"Must provide a valid label to get thrads for")}catch(PERR){g.reportError(PERR)}var q="-in:chats -in:spam label:"+label.getName(),oldestSync=label.getOldestSync();g.isDateValid(oldestSync)&&(q+=" before:"+oldestSync.getTime());var oldestThreadDate=new Date,entryCB=function(entry){if(entry){var cacheEntry=this._addRemoteEntry(accountID,entry);cacheEntry.internalDate.isBefore(oldestThreadDate)&&(oldestThreadDate=cacheEntry.internalDate),this._threadCache.cacheEntry(cacheEntry.id,this.serializeExternalData(cacheEntry)),this._ensureVMLIsForThread(cacheEntry)}}.bind(this),doneCB=function(success){label.setOldestSync(oldestThreadDate),this._writeLabelsToCache(),cb(success)}.bind(this),agg=new Aggregator(entryCB,doneCB);this._requestRemoteThreads(accountID,RequestType.ThreadLabel,reqItem,q,DEFAULT_THREAD_MAX_RESULTS,agg.getEntryCB(),agg.getDoneCB())},createOutlinePaneItem:function createOutlinePaneItemFn(copyItem,targetItem){for(var itemStore=targetItem.getItemStore(),itemText=copyItem.getRawText(),attach=copyItem.getAttachments()[0],displayTags=this.getDisplayTags(attach),i=0;i<displayTags.length;++i)itemText+=" #"+displayTags[i];return itemStore.createItem(g.generateTempId(),itemText,targetItem.id,void 0,ChangeType.Local)},refreshCurrentView:function refreshCurrentViewFn(){this._forceThreadSync()},goOnline:function goOnlineFn(){this._forceThreadSync(this._notifyPendingDraftUpdate.bind(this))},loadInitialData:function loadInitialDataFn(){this._super.loadInitialData.call(this),g.isDemoMode()&&this._forceThreadSync()},_forceThreadSync:function _forceThreadSyncFn(cb){if(this.hasRecurringTask("GmailThreadSync")){var syncEventTask=this.getRecurringTask("GmailThreadSync");syncEventTask.forceUpdate(cb)}},_forceLabelSync:function _forceLabelSyncFn(cb){if(this.hasRecurringTask("GmailLabelSync")){var syncEventTask=this.getRecurringTask("GmailLabelSync");syncEventTask.forceUpdate(cb)}},_syncOfflineChanges:function _syncOfflineChangesFn(syncAccounts,cb){if(!this._syncingOfflineChanges){this._syncingOfflineChanges=!0;var numChanges=0,successChanges=0,failureChanges=0,failureResults=[],notifyComplete=function(accountID,syncResult){syncResult===C.SyncResult.Success?successChanges++:(failureChanges++,failureResults.push({id:accountID,result:syncResult})),numChanges===successChanges+failureChanges&&(this._syncingOfflineChanges=!1,cb(successChanges,failureChanges,failureResults))}.bind(this),filterFn=function(entry){return!!entry.modifiedOffline};this._threadCache.getFilterEntries(filterFn,function(entries){numChanges=entries.length;for(var i=0;i<entries.length;++i){var cacheEntry=this.createEntryFromLocal(entries[i].id,entries[i]);g.isTempId(cacheEntry.id)}}.bind(this))}},_cleanupLocalCaches:function _cleanupLocalCachesFn(cb){try{g.PAssert(4552,g.isFunction(cb),"Must have a valid callback when cleaning local caches")}catch(PERR){g.reportError(PERR)}var numPrunedMeta=0,numPrunedRaw=0,filterDate=this._getFullSyncTime(),unreadDate=this._getUnreadSyncTime(),metadataDate=this._getMetadataSyncTime(),filterFn=function(entry){return entry.date.isBefore(filterDate)};this._threadCache.getFilterEntries(filterFn,function(entries){if(entries)for(var i=0;i<entries.length;++i){var entry=entries[i],removeThread=!0;if(!entry.date.isBefore(unreadDate))for(var j=0;removeThread&&j<entry.messages.length;++j){var msg=entry.messages[j];if(this.isPriorityData(msg)){removeThread=!1;break}}if(removeThread){entry.date.isBefore(metadataDate)&&(this._threadCache.removeEntry(entry.id),numPrunedMeta++);for(var j=0;j<entry.messages.length;++j){var msg=entry.messages[j];this._rawCache.removeEntry(msg.id),numPrunedRaw++}}}log("Gmail Cache Pruned: ",numPrunedMeta,numPrunedRaw),cb()}.bind(this))},_cleanupRawCache:function _cleanupRawCacheFn(cb){try{g.PAssert(4553,g.isFunction(cb),"Must have a valid callback when cleaning local caches")}catch(PERR){g.reportError(PERR)}var numPruned=0,unreadDate=this._getUnreadSyncTime(),filterFn=function(entry){return!entry.internalDate||new Date(parseInt(entry.internalDate)).isBefore(unreadDate)};this._rawCache.getFilterEntries(filterFn,function(entries){if(entries)for(var i=0;i<entries.length;++i){var entry=entries[i];this._rawCache.removeEntry(entry.id),numPruned++}log("Raw Cache Pruned: ",numPruned),cb()}.bind(this))},getAccountSetting:function getAccountSettingFn(accountID,field){var value;return this._accountSettings[accountID]&&(value=this._accountSettings[accountID][field]),value},setAccountSetting:function setAccountSettingFn(accountID,field,value){var oldValue;return this._accountSettings[accountID]||(this._accountSettings[accountID]={}),oldValue=this._accountSettings[accountID][field],this._accountSettings[accountID][field]=value,oldValue},runSettingsSync:function runSettingsSyncFn(){this._getSettingsSendAs(function(sendAs){for(var accountID in sendAs)this.setAccountSetting(accountID,"sendAs",sendAs[accountID]);this._writeSendAsToCache(function(){})}.bind(this))},_getSyncDays:function _getSyncDaysFn(){var syncDays=this.getSetting(this.Settings.SyncTime);return g.billingManager.isTrialOver()&&(syncDays=C.MaxGmailSyncTime.Free),syncDays},_getUnreadSyncTime:function _getUnreadSyncTimeFn(){var syncDays=this._getSyncDays();return(new Date).addDays(-(1.5*syncDays))},_getFullSyncTime:function _getFullSyncTimeFn(){var syncDays=this._getSyncDays();return(new Date).addDays(-syncDays)},_getMetadataSyncTime:function _getMetadataSyncTimeFn(){var syncDays=Math.max(this.getSetting(this.Settings.SyncTime),15);return(new Date).addDays(-syncDays)},_getFullSyncTimeStr:function _getFullSyncTimeStrFn(){var syncDays=this._getSyncDays();return syncDays+"d"},_getMetadataSyncTimeStr:function _getMetadataSyncTimeStrFn(){var syncDays=Math.max(this.getSetting(this.Settings.SyncTime),15);return syncDays+"d"},runThreadSync:function runThreadSyncFn(cb){var numSyncSuccess=0,numSyncFail=0,expectedSyncs,successAccounts=[],failureAccounts=[],threadSyncComplete=function(success,accountID,result){success?(numSyncSuccess++,successAccounts.push(accountID)):(numSyncFail++,!g.isHTTPStatusCode(result,C.HTTPStatusCode.Network)&&g.vmMain.isOnline()&&failureAccounts.push(accountID)),numSyncFail+numSyncSuccess===expectedSyncs&&(failureAccounts.length>0?g.toasts.pushMessage(MessageID.EmailSyncFail):g.toasts.clearMessage(MessageID.EmailSyncFail),successAccounts.length>0&&this._contentSyncTask.requestRun(),cb&&cb(0===failureAccounts.length))}.bind(this),forceFullSync=!1,syncTime=this.getSetting(this.Settings.SyncTime);void 0!==this._lastSyncTime&&this._lastSyncTime<syncTime&&(forceFullSync=!0,log("Forcing full gmail sync")),this._lastSyncTime=syncTime,this._threadCache.onCacheMetadataReady(function(){this._threadCache.getMetadata(CacheMetadata.HistoryIDs,function(historyIDs){var syncAccounts=this.getSyncAccounts();expectedSyncs=syncAccounts.length;for(var i=0;i<syncAccounts.length;++i){var historyID;if(!forceFullSync){var historySyncData=historyIDs?historyIDs[syncAccounts[i]]:void 0;historyID=historySyncData?historySyncData.historyID:void 0}this.performThreadSync(syncAccounts[i],historyID,threadSyncComplete)}}.bind(this))}.bind(this))},performThreadSync:function performThreadSyncFn(accountID,historyID,cb){historyID?this._performThreadSyncPartial(accountID,historyID,function(success,accountID,errorResult){success?this._cleanupLocalCaches(function(){cb(success,accountID,errorResult)}):cb(success,accountID,errorResult)}.bind(this)):this._performThreadSyncFull(accountID,cb)},_performThreadSyncFull:function _performThreadSyncFullFn(accountID,cb){var q="-in:chats -in:spam newer_than:"+this._getMetadataSyncTimeStr(),itemStore=this.getDefaultItemStore(),item=itemStore.getRoot(),historyID,entryCB=function(entry){if(entry&&(!historyID&&entry.historyId&&(historyID=entry.historyId,this.setHistoryID(accountID,historyID)),this._shouldCacheThread(entry))){var cacheEntry=this._addRemoteEntry(accountID,entry);this._threadCache.cacheEntry(cacheEntry.id,this.serializeExternalData(cacheEntry)),this._ensureVMLIsForThread(cacheEntry)}}.bind(this),doneCB=function(success){cb(success,accountID)},agg=new Aggregator(entryCB,doneCB);this._requestRemoteThreads(accountID,RequestType.FullSync,item,q,DEFAULT_THREAD_SYNC_RESULTS,agg.getEntryCB(),agg.getDoneCB()),this._getThreadsForLabel(accountID,this._getLabelByID(accountID,SystemLabels.UNREAD),void 0,function(success){try{g.PAssert(4554,success,"Expect to be able to get all unread messages")}catch(PERR){g.reportError(PERR)}})},_compactHistoryEntries:function _compactHistoryEntriesFn(entries){for(var historyMap={messages:{},messagesAdded:{},messagesDeleted:{},labelsAdded:{},labelsRemoved:{}},i=0;i<entries.length;++i){var entry=entries[i],numHandled=0;if(entry.messagesAdded){for(var j=0;j<entry.messagesAdded.length;++j){var msg=entry.messagesAdded[j].message,thread=historyMap.messagesAdded[msg.threadId];thread||(thread=historyMap.messagesAdded[msg.threadId]=[]),thread.indexOf(msg.id)<0&&thread.push(msg.id)}numHandled+=entry.messagesAdded.length}if(entry.messagesDeleted){for(var j=0;j<entry.messagesDeleted.length;++j){var msg=entry.messagesDeleted[j].message,thread=historyMap.messagesDeleted[msg.threadId];thread||(thread=historyMap.messagesDeleted[msg.threadId]=[]),thread.indexOf(msg.id)<0&&thread.push(msg.id)}numHandled+=entry.messagesDeleted.length}if(entry.labelsAdded){for(var j=0;j<entry.labelsAdded.length;++j){var msg=entry.labelsAdded[j].message,thread=historyMap.labelsAdded[msg.threadId];thread||(thread=historyMap.labelsAdded[msg.threadId]={}),thread[msg.id]||(thread[msg.id]=[]),thread[msg.id].pushOnlyUniques(entry.labelsAdded[j].labelIds)}numHandled+=entry.labelsAdded.length}if(entry.labelsRemoved){for(var j=0;j<entry.labelsRemoved.length;++j){var msg=entry.labelsRemoved[j].message,thread=historyMap.labelsRemoved[msg.threadId];thread||(thread=historyMap.labelsRemoved[msg.threadId]={}),thread[msg.id]||(thread[msg.id]=[]),thread[msg.id].pushOnlyUniques(entry.labelsRemoved[j].labelIds)}numHandled+=entry.labelsRemoved.length}try{g.PAssert(4555,0===numHandled||numHandled===entry.messages.length,"Must have handled all or none of the generic messages")}catch(PERR){g.reportError(PERR)}if(0===numHandled)for(var j=0;j<entry.messages.length;++j){var msg=entry.messages[j],thread=historyMap.messages[msg.threadId];thread||(thread=historyMap.messages[msg.threadId]=[]),thread.indexOf(msg.id)<0&&thread.push(msg.id)}}var compactMap={messages:[],messagesAdded:[],messagesDeleted:[],labelsAdded:[],labelsRemoved:[]};for(var threadID in historyMap.messages)compactMap.messages.push({id:threadID,msgIDs:historyMap.messages[threadID]});for(var threadID in historyMap.messagesAdded)historyMap.messages[threadID]||compactMap.messagesAdded.push({id:threadID,msgIDs:historyMap.messagesAdded[threadID]});for(var threadID in historyMap.messagesDeleted)historyMap.messages[threadID]||compactMap.messagesDeleted.push({id:threadID,msgIDs:historyMap.messagesDeleted[threadID]});for(var threadID in historyMap.labelsAdded)if(!historyMap.labelsAdded[threadID])for(var msgID in historyMap.labelsAdded[threadID])compactMap.labelsAdded.push({id:threadID,msgID:msgID,labelIDs:historyMap.labelsAdded[threadID][msgID]});for(var threadID in historyMap.labelsRemoved)if(!historyMap.messages[threadID])for(var msgID in historyMap.labelsRemoved[threadID])compactMap.labelsRemoved.push({id:threadID,msgID:msgID,labelIDs:historyMap.labelsRemoved[threadID][msgID]});return compactMap},_performThreadSyncPartial:function _performThreadSyncPartialFn(accountID,historyID,cb){var requestFn=["gapi","client","gmail","users","history","list"],requestData={userId:accountID,startHistoryId:historyID},options={getAllPages:!0,maxPageResults:DEFAULT_HISTORY_MAX_RESULTS,resultsField:"history",timeoutMS:0},reportHistoryFailure=function(accountID,threadID){log("History Sync Request Failed: ",accountID,threadID)}.bind(this),successCB=function(result,outData,response){var nextHistoryID;response&&(nextHistoryID=response.historyId,this.setHistoryID(accountID,nextHistoryID)),g.vmMain.beginUpdateItems();var compactHistory=this._compactHistoryEntries(result),compactOps=this._handleCompactHistory(accountID,compactHistory,reportHistoryFailure);g.vmMain.commitUpdateItems(),cb(!0,accountID)}.bind(this),failureCB=function(result){result&&result.error&&result.error.code===C.HTTPStatusCode.NotFound?this._clearCachedData(accountID,function(success){success?this.performThreadSync(accountID,void 0,cb):cb(!1,accountID,result)}.bind(this)):(cb(!1,accountID,result),this._notifyFailedRequest(accountID,result))}.bind(this);this._queuePagedRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.History,options)},_handleCompactHistory:function _handleCompactHistoryFn(accountID,history,reportFailure){for(var ops=0,i=0;i<history.messages.length;++i)for(var thread=history.messages[i],j=0;j<thread.msgIDs.length;++j)this._handleMessageUpdated(accountID,thread.id,thread.msgIDs[j],reportFailure),ops++;for(var i=0;i<history.messagesAdded.length;++i)for(var thread=history.messagesAdded[i],j=0;j<thread.msgIDs.length;++j)this._handleMessageAdded(accountID,thread.id,thread.msgIDs[j],reportFailure),ops++;for(var i=0;i<history.messagesDeleted.length;++i)for(var thread=history.messagesDeleted[i],j=0;j<thread.msgIDs.length;++j)this._handleMessageDeleted(accountID,thread.id,thread.msgIDs[j]),ops++;for(var i=0;i<history.labelsAdded.length;++i){var thread=history.labelsAdded[i];this._handleLabelsAdded(accountID,thread.id,thread.msgID,thread.labelIDs),ops++}for(var i=0;i<history.labelsRemoved.length;++i){var thread=history.labelsRemoved[i];this._handleLabelsRemoved(accountID,thread.id,thread.msgID,thread.labelIDs),ops++}return ops},_handleMessageAdded:function _handleMessageAddedFn(accountID,threadID,msgID,reportFailure){this.refreshThreadCacheData(accountID,threadID,msgID,reportFailure)},_handleMessageDeleted:function _handleMessageDeletedFn(accountID,threadID,msgID){this._deleteCachedMessage(accountID,threadID,msgID)},_handleLabelsAdded:function _handleLabelsAddedFn(accountID,threadID,msgID,labels){this.addLabelsToMessage(accountID,threadID,msgID,labels,ChangeType.Remote)},_handleLabelsRemoved:function _handleLabelsRemovedFn(accountID,threadID,msgID,labels){this.removeLabelsFromMessage(accountID,threadID,msgID,labels,ChangeType.Remote)},_handleMessageUpdated:function _handleMessageUpdatedFn(accountID,threadID,msgID,reportFailure){this.refreshThreadCacheData(accountID,threadID,msgID,reportFailure)},getLastSyncTime:function getLastSyncTimeFn(accountID,cb){this._threadCache.getMetadata(CacheMetadata.HistoryIDs,function(historyIDs){var syncTime;if(historyIDs){var historyData=historyIDs[accountID];historyData&&historyData.date&&(syncTime=new Date(historyData.date))}cb(syncTime)})},setHistoryID:function setHistoryIDFn(accountID,historyID,cb){try{g.PAssert(4557,g.isString(accountID),"Must provide a valid account ID to set history ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4558,g.isString(historyID),"Must provide a valid history ID to set")}catch(PERR){g.reportError(PERR)}this._threadCache.getMetadata(CacheMetadata.HistoryIDs,function(historyIDs){historyIDs=historyIDs||{},historyIDs[accountID]={historyID:historyID,date:Date.now()},this._threadCache.setMetadata(CacheMetadata.HistoryIDs,historyIDs,cb)}.bind(this))},clearHistoryID:function clearHistoryIDFn(accountID,cb){try{g.PAssert(4559,g.isString(accountID),"Must provide a valid account ID to clear history ID for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4560,g.isFunction(cb),"Must provide valid CB function when clearing history ID")}catch(PERR){g.reportError(PERR)}this._threadCache.getMetadata(CacheMetadata.HistoryIDs,function(historyIDs){historyIDs?(delete historyIDs[accountID],this._threadCache.setMetadata(CacheMetadata.HistoryIDs,historyIDs,cb)):cb(!1)}.bind(this))},clearCachedLabel:function clearCachedLabelFn(accountID,cb){try{g.PAssert(4561,g.isString(accountID),"Must provide a valid account ID to clear history ID for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4562,g.isFunction(cb),"Must provide valid CB function when clearing history ID")}catch(PERR){g.reportError(PERR)}this._threadCache.getMetadata(CacheMetadata.Labels,function(labels){labels?(delete labels[accountID],this._threadCache.setMetadata(CacheMetadata.Labels,labels,cb)):cb(!1)}.bind(this))},_clearCachedData:function _clearCachedDataFn(accountID,cb){this.clearHistoryID(accountID,function(success){success?this.clearCachedLabel(accountID,function(successLabel){successLabel?this.clearAccountThreadCache(accountID,cb):cb(!1)}.bind(this)):cb(!1)}.bind(this))},clearAccountThreadCache:function clearAccountThreadCacheFn(accountID,cb){try{g.PAssert(4563,g.isString(accountID),"Must provide a valid account ID to clear thread cache for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4564,g.isFunction(cb),"Must provide valid CB function when clearing thread cache")}catch(PERR){g.reportError(PERR)}var filterFn=function(entry){return entry.accountID===accountID};this._threadCache.getFilterEntries(filterFn,function(entries){if(entries){log("Clearing account thread cache: "+accountID);for(var i=0;i<entries.length;++i)this._threadCache.removeEntry(entries[i].id);cb(!0)}else cb(!1)}.bind(this))},requestDataPage:function requestDataPageFn(item,doneCB){log("Data Page: ",item.hasPaginationToken()),item.hasPaginationToken()&&!item.paginationTokenInUse()?this._requestRemoteThreads(void 0,RequestType.DataPage,item,void 0,DEFAULT_THREAD_MAX_RESULTS,void 0,doneCB):doneCB(!0)},_requestRemoteThreads:function _requestRemoteThreadsFn(accountID,type,reqItem,q,maxResults,entryCB,doneCB){var paginationToken;if(reqItem&&reqItem.hasPaginationToken()&&!reqItem.paginationTokenInUse()){paginationToken=reqItem.beginDataPageLoad();try{g.PAssert(4567,!q,"Should not define a new q for paged token")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4568,!entryCB,"Should not define a new entryCB for paged token")}catch(PERR){g.reportError(PERR)}if(q=paginationToken.getQuery(),maxResults=paginationToken.getMaxResults(),entryCB=paginationToken.getEntryCB(),doneCB){var newDoneCB=doneCB;doneCB=function(){paginationToken.getDoneCB().apply(null,arguments),newDoneCB.apply(null,arguments)}}else doneCB=paginationToken.getDoneCB();accountID=accountID||paginationToken.getInfo().accountID}else reqItem&&reqItem.needsPaginationToken()&&(paginationToken=this.createPaginationToken(void 0,q,{accountID:accountID},maxResults,entryCB,doneCB),reqItem.setPaginationToken(paginationToken),reqItem.beginDataPageLoad());maxResults=maxResults||DEFAULT_THREAD_MAX_RESULTS;try{g.PAssert(4569,entryCB&&g.isFunction(entryCB),"Must define a valid entry callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4570,doneCB&&g.isFunction(doneCB),"Must define a valid done callback")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","gmail","users","threads","list"],requestData={userId:accountID,maxResults:maxResults,q:q,pageToken:paginationToken&&paginationToken.hasMorePages()?paginationToken.getNextPageToken():void 0},successThreadCB,failureThreadCB;paginationToken||!reqItem?(successThreadCB=function(results){if(results.nextPageToken&&paginationToken&&this.updatePaginationToken(paginationToken,results.nextPageToken),reqItem&&paginationToken&&reqItem.endDataPageLoad(!!results.nextPageToken),results.threads)for(var numThreads=results.threads.length,numThreadsSuccess=0,numThreadsFail=0,threadGetCB=function(result){result?(entryCB(result),numThreadsSuccess++):(entryCB(void 0),numThreadsFail++),numThreadsSuccess+numThreadsFail===numThreads&&doneCB(!0)},i=0;i<results.threads.length;++i){var thread=results.threads[i];this._requestRemoteThreadMetadata(accountID,thread.id,void 0,threadGetCB)}else doneCB(!0)}.bind(this),failureThreadCB=function(result){reqItem&&paginationToken&&reqItem.endDataPageLoad(paginationToken),doneCB(!1),this._notifyFailedRequest(accountID,result)}.bind(this)):(successThreadCB=function(){doneCB(!0)},failureThreadCB=function(result){doneCB(!1),this._notifyFailedRequest(accountID,result)}.bind(this)),this._queueRemoteRequestMulti(accountID,requestFn,requestData,successThreadCB,failureThreadCB,void 0,type)},_requestRemoteMessageData:function _requestRemoteMessageDataFn(attach,msgID,cb){try{g.PAssert(4571,!attach.isLocalOnlyAttachment(),"Should never request remote data for a local only attachment")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","gmail","users","messages","get"],requestData={userId:attach.getField("accountID"),id:msgID,format:"full"},successCB=function(result){var pMessage=this._parseMailMessage(result);try{g.PAssert(4572,pMessage,"Must be able to parse message")}catch(PERR){g.reportError(PERR)}this._updateMessageData(attach,msgID,pMessage),cb(!0)}.bind(this),failureCB=function(result){cb(!1,result),this._notifyFailedRequest(attach.getField("accountID"),result)}.bind(this);this._queueRemoteRequestMulti(attach.getField("accountID"),requestFn,requestData,successCB,failureCB,void 0,RequestType.MessageFull)},_requestRemoteMessageDataRaw:function _requestRemoteMessageDataRawFn(accountID,threadID,messageID,cb){var requestFn=["gapi","client","gmail","users","messages","get"],requestData={userId:accountID,id:messageID,format:"full"},failureCB=function(result){cb(void 0,result),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,cb,failureCB,void 0,RequestType.MessageFull)},_requestRemoteThreadDataRaw:function _requestRemoteThreadDataRawFn(accountID,threadID,cb){var requestFn=["gapi","client","gmail","users","threads","get"],requestData={userId:accountID,id:threadID,format:"full"},failureCB=function(result){cb(void 0,result),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,cb,failureCB,void 0,RequestType.ThreadFull)},_requestRemoteThreadMetadata:function _requestRemoteThreadMetadataFn(accountID,threadID,attach,cb){var requestThreadFn=["gapi","client","gmail","users","threads","get"],requestThreadData={userId:accountID,id:threadID,format:"metadata"},successCB=function(result){cb(result)},failureCB=function(result){cb(void 0,result),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestThreadFn,requestThreadData,successCB,failureCB,attach,RequestType.ThreadMeta)},_persistRemoteSnoozeTask:function _persistRemoteSnoozeTaskFn(task,cb){var data=task.getData();g.XHR_PrivateAPI({type:"POST",path:"/tasks/snoozeMail",data:data,requireAuth:!0,autoRetry:!1,cb:this._handleRemotePersist.bind(this,cb)})},_cancelDeferredSnoozeTask:function _cancelDeferredSnoozeTaskFn(task,cb){var data=task.getData();g.XHR_PrivateAPI({type:"POST",path:"/tasks/snoozeMail/cancel",data:data,requireAuth:!0,autoRetry:!1,cb:function cbFn(xhr){cb(xhr.status===C.HTTPStatusCode.Success)}})},_persistRemoteSendMailTask:function _persistRemoteSendMailTaskFn(task,cb){var data=task.getData();g.XHR_PrivateAPI({type:"POST",path:"/tasks/sendMail",data:data,requireAuth:!0,autoRetry:!1,cb:this._handleRemotePersist.bind(this,cb)})},_cancelDeferredSendMailTask:function _cancelDeferredSendMailTaskFn(task,cb){var data=task.getData();g.XHR_PrivateAPI({type:"POST",path:"/tasks/sendMail/cancel",data:data,requireAuth:!0,autoRetry:!1,cb:function cbFn(xhr){cb(xhr.status===C.HTTPStatusCode.Success)}})},_handleRemotePersist:function _handleRemotePersistFn(cb,xhr){if(xhr.status!==C.HTTPStatusCode.Success)return cb(!1);try{var statusData=JSON.parse(xhr.response).data;return cb(!0,statusData.messageID)}catch(err){return g.reportError(err),cb(!1)}},_parseMailThread:function _parseMailThreadFn(attach,thread){for(var messages=[],i=0;i<thread.messages.length;++i){var pMessage=this._parseMailMessage(thread.messages[i]);try{g.PAssert(4573,pMessage,"Must be able to parse each message")}catch(PERR){g.reportError(PERR)}pMessage&&messages.push(pMessage)}var oldMessages=attach.getField("messages");this._mergeMessagesData(oldMessages,messages,["labelIds"]),attach.updateField("dataLoaded",!0),attach.updateField("messages",messages),this._updateAttachmentFromMessages(attach,ChangeType.Remote)},getAttachmentURL:function getAttachmentURLFn(accountID,msgID,attID){var base="https://mail-attachment.googleusercontent.com/attachment/b/"+accountID+"/?view=att&disp=safe",thread="&th="+msgID,attachment="&attid="+attID;return base+thread+attachment},getPreviewURL:function getPreviewURLFn(res){return res.link},reportMessage:function reportMessageFn(accountID,threadID,msgID,description,sendContent){var requestFn=["gapi","client","gmail","users","messages","get"],requestData={userId:accountID,id:msgID,format:"full"},failureCB=function(){try{g.PAssert(4574,!1,"Failed to report message")}catch(PERR){g.reportError(PERR)}};this._queueRemoteRequestMulti(accountID,requestFn,requestData,this._sendReport.bind(this,sendContent,description),failureCB,void 0,RequestType.MessageFull)},_sanitizeMessage:function _sanitizeMessageFn(part){if(part.parts)for(var i=0;i<part.parts.length;++i)this._sanitizeMessage(part.parts[i]);if(part.body&&part.body.data){var decodedData=this._runDecodeEmail(part);part.body.data=this._encodeEmail(decodedData&&decodedData.mimeType===MessagePartType.HTML?EmailHTML.sanitizeContent(decodedData.decoded):"<<NonHTML-Sanitized>>")}if(part.headers)for(var i=0;i<part.headers.length;++i){var header=part.headers[i];switch(header.name.toUpperCase()){case"TO":case"CC":case"BCC":case"FROM":header.value=header.value.replace(/[A-Za-z0-9]/g,"#");break;case"SUBJECT":case"SNIPPET":header.value=new Array(header.name.length+1).join("#")}}},_sendReport:function _sendReportFn(sendContent,description,rawData){try{g.PAssert(4575,g.isBoolean(sendContent),"Must provide a valid boolean for sendContent")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4576,g.isString(description),"Must provide a valid description string")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4577,g.isObject(rawData),"Must provide valid raw data")}catch(PERR){g.reportError(PERR)}try{log("Sending Message Report",rawData),sendContent||this._sanitizeMessage(rawData.payload);var report={description:description,payload:rawData.payload};g.reportError(new Error("Report Message"),report)}catch(err){g.reportError(err)}},loadResource:function loadResourceFn(threadID,messageID,cid,cb){if(this.hasCacheData(threadID)){var attach=this.getAttachment(threadID),msg=this._getMessageFromAttachment(attach,messageID),resource=msg.resources?msg.resources[cid]:void 0;resource?(resource.data?cb(resource):this._requestRemoteAttachment(attach.getField("accountID"),messageID,resource.id,function(data,size){data&&(resource.data=data,resource.size=size),cb(resource)}),this.sendEvent("FetchAttachment")):cb()}else cb()},_requestRemoteAttachment:function _requestRemoteAttachmentFn(accountID,messageID,attachmentID,cb){var requestFn=["gapi","client","gmail","users","messages","attachments","get"],requestData={id:attachmentID,messageId:messageID,userId:accountID},successCB=function(result){cb(result.data.replace(/-/g,"+").replace(/_/g,"/"),result.size)},failureCB=function(result){cb(void 0),this._notifyFailedRequest(accountID,result)}.bind(this);this._queueRemoteRequestMulti(accountID,requestFn,requestData,successCB,failureCB,void 0,RequestType.GetAttachment)},_parseAttachment:function _parseAttachmentFn(lib,parent,part){try{g.PAssert(4578,lib,"Must have valid multipart lib")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4579,part.body,"Must have a valid attachment body")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4580,part.body.attachmentId,"Must have a valid attachment ID")}catch(PERR){g.reportError(PERR)}var id,attrID,disposition,contentEncoding,attID="0."+part.partId;if(part.headers)for(var i=0;i<part.headers.length;++i){var header=part.headers[i];switch(header.name.toUpperCase()){case"CONTENT-ID":var contentIDRegex=/^<(.*)>$/,contentMatch=contentIDRegex.exec(header.value);id=contentMatch?contentMatch[1]:header.value;break;case"CONTENT-TRANSFER-ENCODING":contentEncoding=header.value;break;case"CONTENT-DISPOSITION":var parts=header.value.split(";");
disposition=parts[0];break;case"X-ATTACHMENT-ID":attrID=header.value}}id&&disposition!==ContentDisposition.Attachment||!part.filename?!id&&part.body.attachmentId&&(id=part.body.attachmentId):id=part.filename;try{g.PAssert(4581,id,"Must be able to find a valid resource ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4582,!lib[id],"Must not have a duplicate filename")}catch(PERR){g.reportError(PERR)}lib[id]={cid:id,id:part.body.attachmentId,attID:attID,realAttrID:attrID,data:void 0,size:part.body.size,uploader:void 0,disposition:disposition,parentType:parent.mimeType,mimeType:part.mimeType,contentEncoding:contentEncoding}},_decodeFlowed:function _decodeFlowedFn(str,delSp){return str.split(/\r?\n/).reduce(function(previousValue,currentValue,index){var body=previousValue;return delSp&&(body=body.replace(/[ ]+$/,"")),/ $/.test(previousValue)&&!/(^|\n)\-\- $/.test(previousValue)||1===index?body+currentValue:body+"\n"+currentValue}).replace(/^ /gm,"")},_decodeEmail:function _decodeEmailFn(encoded,transferEncoding,contentTypeInfo){try{g.PAssert(4583,g.isString(encoded),"Passing in an invalid string to decode")}catch(PERR){g.reportError(PERR)}var decoded;if(encoded)try{decoded=g.b64_to_utf8(encoded.replace(/-/g,"+").replace(/_/g,"/")),"FLOWED"===contentTypeInfo.format&&(decoded=this._decodeFlowed(decoded,contentTypeInfo.delSp))}catch(err){g.reportError(err)}return decoded},_encodeEmail:function _encodeEmailFn(decoded){var encoded;try{encoded=g.utf8_to_b64(decoded).replace(/\+/g,"-").replace(/\//g,"_")}catch(err){g.reportError(err)}return encoded},_runDecodeEmail:function _runDecodeEmailFn(part){try{g.PAssert(4584,part&&part.body,"Must pass in a valid part")}catch(PERR){g.reportError(PERR)}var transferEncoding=this._getHeader(part,"Content-Transfer-Encoding"),rawContentType=this._getHeader(part,"Content-Type")||DefaultContentType;try{g.PAssert(4585,rawContentType,"Must have a valid contentType")}catch(PERR){g.reportError(PERR)}var contentTypeInfo=this._sanitizeContentType(rawContentType),hasError,decodedMessage;return part.body&&part.body.data?decodedMessage=this._decodeEmail(part.body.data,transferEncoding,contentTypeInfo):part.body&&part.body.attachmentId?decodedMessage='<a href="attach:'+part.body.attachmentId+'">Load Message</a>':(decodedMessage="Unable to decode email content",hasError=!0),{decoded:decodedMessage,mimeType:part.mimeType,contentType:contentTypeInfo.type,name:contentTypeInfo.name,hasError:hasError}},_decodeMessagePart:function _decodeMessagePartFn(part){var decoded=[];if(part)if(part.mimeType===MessagePartType.Mixed)for(var i=0;i<part.parts.length;++i){var decodedPart=this._decodeMessagePart(part.parts[i]);decoded.pushArray(decodedPart)}else if(part.mimeType===MessagePartType.Related||part.mimeType===MessagePartType.Signed||part.mimeType===MessagePartType.Alternative||part.mimeType===MessagePartType.Report){for(var i=part.parts.length-1;i>=0;i--)if(this._isValidDisplayPart(part.parts[i])){var decodedPart=this._decodeMessagePart(part.parts[i]);if(decodedPart.length>0){decoded.pushArray(decodedPart);break}}}else this._isValidDisplayPart(part)&&decoded.push(this._runDecodeEmail(part));return decoded},_combineMessageParts:function _combineMessagePartsFn(decodedParts){var combined="",mimeType=MessagePartType.Plain,contentType=DefaultContentType,reportMessage=!1;if(decodedParts&&decodedParts.length>0){mimeType=decodedParts[0].mimeType,contentType=decodedParts[0].contentType;for(var i=0;i<decodedParts.length;++i){var part=decodedParts[i];part.mimeType!==mimeType&&(reportMessage=!0)}combined=EmailHTML.combineParts(decodedParts)}else combined=" ";return mimeType===MessagePartType.Plain&&(mimeType=MessagePartType.HTML,contentType=MessagePartType.HTML+";charset="+contentType.split(";charset=")[1]),{decoded:combined,mimeType:mimeType,contentType:contentType,reportMessage:reportMessage}},_isValidDisplayPart:function _isValidDisplayPartFn(part){var isDisplayPart=!1;return!this._isResourcePart(part)&&ValidDisplayTypes.indexOf(part.mimeType)>=0&&(isDisplayPart=!0),isDisplayPart},_isResourcePart:function _isResourcePartFn(part){var isResourcePart=!1;return part.filename?isResourcePart=!0:this._getHeader(part,"CONTENT-ID")&&(this._getHeader(part,"CONTENT-DISPOSITION")||ValidDisplayTypes.indexOf(part.mimeType)<0)&&(isResourcePart=!0),isResourcePart},_parseMessagePart:function _parseMessagePartFn(part,parentNode){var mimeNode={parent:parentNode,raw:part,mimeType:part.mimeType,children:[],resources:[]};switch(part.mimeType){case MessagePartType.Plain:case MessagePartType.HTML:break;case MessagePartType.Signed:case MessagePartType.Related:case MessagePartType.Parallel:case MessagePartType.Report:case MessagePartType.Mixed:for(var i=0;i<part.parts.length;++i){var subPart=part.parts[i],parsedPart=this._parseMessagePart(subPart,mimeNode);this._isResourcePart(subPart)?mimeNode.resources.push(parsedPart):mimeNode.children.push(parsedPart)}break;case MessagePartType.Alternative:for(var i=0;i<part.parts.length;++i){var parsedPart=this._parseMessagePart(part.parts[i],mimeNode);mimeNode.children.push(parsedPart)}break;default:var topLevel=part.mimeType.split("/")[0];ValidMimetypePrefixes.indexOf(topLevel)<0&&(log("Unknown Part Mimetype: ",part),g.reportError(new Error("Unknown attachment mimetype: "+part.mimeType)))}return mimeNode},_getMessageDisplay:function _getMessageDisplayFn(mimeNode,displayNodes){switch(mimeNode.mimeType){case MessagePartType.Plain:case MessagePartType.HTML:case MessagePartType.Mixed:case MessagePartType.Report:case MessagePartType.Parallel:displayNodes.push(mimeNode);break;case MessagePartType.Related:case MessagePartType.Signed:case MessagePartType.Alternative:for(var i=0;i<mimeNode.children.length;++i)this._getMessageDisplay(mimeNode.children[i],displayNodes);break;case MessagePartType.Calendar:break;default:try{g.PAssert(4586,!1,"Should never have an unknown multipart mimetype in the tree: ",mimeNode.mimeType)}catch(PERR){g.reportError(PERR)}}},_getResourcesForNode:function _getResourcesForNodeFn(mimeNode,resources){for(var mimeResources=mimeNode.resources,i=0;i<mimeResources.length;++i){var res=mimeResources[i].raw;this._parseAttachment(resources,mimeNode,res)}mimeNode.raw&&mimeNode.raw.body&&mimeNode.raw.body.attachmentId&&this._parseAttachment(resources,mimeNode.parent,mimeNode.raw)},_getResourcesForPart:function _getResourcesForPartFn(mimeNode){var resources={};if(mimeNode.mimeType===MessagePartType.Mixed||mimeNode.mimeType===MessagePartType.Report)for(var i=0;i<mimeNode.children.length;++i)this._getResourcesForNode(mimeNode.children[i],resources);for(;mimeNode;)this._getResourcesForNode(mimeNode,resources),mimeNode=mimeNode.parent;return resources},_displayAttachment:function _displayAttachmentFn(res){var shouldDisplay=!1;return res.disposition===ContentDisposition.Attachment?shouldDisplay=!0:res.disposition===ContentDisposition.Inline&&res.parentType===MessagePartType.Mixed&&(shouldDisplay=!0),shouldDisplay},getMessageAttachments:function getMessageAttachmentsFn(msg){var attachments=[];for(var id in msg.resources)if(msg.resources.hasOwnProperty(id)){var res=msg.resources[id];this._displayAttachment(res)&&attachments.push(res)}return attachments},getMessageDisplayAttachments:function getMessageDisplayAttachmentsFn(msg){var attachments=this.getMessageAttachments(msg),attachLinks;attachLinks=msg.initialiedForDisplay?msg.specialLinks?msg.specialLinks.attachments:[]:EmailHTML.getAttachmentLinks(msg.decoded);for(var i=0;i<attachLinks.length;++i){var linkData=attachLinks[i];if(!msg.resources[linkData.name]){var res=this._createResource(msg.resources,linkData);res.link=linkData.href,attachments.push(res)}}return attachments},_verifyDKIM:function _verifyDKIMFn(dkim){var infoDKIM={};if(dkim)for(var tags=dkim.split(";"),tagSplit=/([a-z]+)[=](.*)/i,i=0;i<tags.length;++i){var tag=tags[i].trim();if(tag){var tagInfo=tagSplit.exec(tag);switch(tagInfo[1]){case"d":infoDKIM.domain=tagInfo[2];break;case"h":infoDKIM.headers=tagInfo[2].split(":").map(Function.prototype.call,String.prototype.trim)}}}return infoDKIM},_sanitizeContentType:function _sanitizeContentTypeFn(rawContentType){var contentType=DefaultContentType;try{var parts=rawContentType.replace(/[\"\']/g,"").split(";"),mediaType=parts[0].trim().toLowerCase();try{g.PAssert(4587,mediaType===MessagePartType.Plain||mediaType===MessagePartType.HTML,"Unknown ContentType MediaType: "+mediaType)}catch(PERR){g.reportError(PERR)}for(var charset,format,delSp,name,i=1;i<parts.length;++i){var part=parts[i].trim(),partValues=part.split("=");if(partValues&&2===partValues.length){var key=partValues[0].trim(),value=partValues[1].trim();switch(key.toUpperCase()){case"CHARSET":charset=value;break;case"FORMAT":format=value.toUpperCase();break;case"DELSP":delSp="YES"===value.toUpperCase();break;case"NAME":name=value;break;default:try{g.PAssert(4588,!1,"Unknown param in ContentType: "+part)}catch(PERR){g.reportError(PERR)}}}else try{g.PAssert(4589,!1,"Invalid contentType part: ",part)}catch(PERR){g.reportError(PERR)}}charset||(charset="utf-8"),mediaType&&charset&&(contentType=mediaType+";charset="+charset)}catch(err){g.reportError(err)}return{type:contentType,format:format,delSp:delSp,name:name}},_getHeader:function _getHeaderFn(part,name){var headerValue;if(part&&part.headers)for(var i=0;i<part.headers.length;++i)if(part.headers[i].name.toUpperCase()===name.toUpperCase()){headerValue=part.headers[i].value;break}return headerValue},_parseMailMessage:function _parseMailMessageFn(message){var outMessage={},payload=message.payload,hasBody=payload.body?payload.body.size>0:!1;try{g.PAssert(4591,hasBody!==payload.mimeType.startsWith("multipart/"),"Checking the body size should be the same as checking whether this is a multipart message")}catch(PERR){g.reportError(PERR)}for(var infoDKIM=this._verifyDKIM(this._getHeader(message.payload,"DKIM-Signature")),headers=message.payload.headers,j=0;j<headers.length;++j){var header=headers[j];switch(header.name.toUpperCase()){case"FROM":message.from=this.parseEmailAddress(header.value);break;case"REPLY-TO":message.replyTo=this.parseEmailAddress(header.value);break;case"TO":message.to=this.parseEmailAddresses(header.value);break;case"CC":message.cc=this.parseEmailAddresses(header.value);break;case"BCC":message.bcc=this.parseEmailAddresses(header.value);break;case"SUBJECT":message.subject=header.value;break;case"DATE":message.date=new Date(header.value);try{g.PAssert(4592,g.isDateValid(message.date),"Must have a valid message date: ",message.date)}catch(PERR){g.reportError(PERR)}break;case"MESSAGE-ID":message.messageID=header.value;break;case"REFERENCES":message.references=header.value;break;case"IN-REPLY-TO":message.inReplyTo=header.value;break;case"LIST-UNSUBSCRIBE":message.listUnsubscribe=header.value}}try{g.PAssert(4593,message.messageID,"Must have a valid message ID defined")}catch(PERR){g.reportError(PERR)}var resources,bestPart;if(hasBody)bestPart=payload,resources={};else{var mimeTree=this._parseMessagePart(payload),displayNodes=[];this._getMessageDisplay(mimeTree,displayNodes);for(var bestNode,i=displayNodes.length-1;!bestNode&&i>=0;i--){var isKnownDisplayType=ValidDisplayTypes.indexOf(displayNodes[i].mimeType)>=0;try{g.PAssert(4594,isKnownDisplayType,"Unknown mimePart display type: ",displayNodes[i].mimeType)}catch(PERR){g.reportError(PERR)}isKnownDisplayType?bestNode=displayNodes[i]:log("Unknown best mimepart: ",displayNodes[i])}bestNode?(resources=this._getResourcesForPart(bestNode),bestPart=bestNode.raw):this._sendReport(!1,"Missing bestNode",message)}try{g.PAssert(4595,bestPart,"Must have found a valid message part to display")}catch(PERR){g.reportError(PERR)}var decodedParts=this._decodeMessagePart(bestPart),decodedMessage=this._combineMessageParts(decodedParts);if(decodedMessage){outMessage={id:message.id,labelIds:message.labelIds,messageID:message.messageID,decoded:decodedMessage.decoded,mimeType:decodedMessage.mimeType,contentType:decodedMessage.contentType,from:message.from,to:message.to||[],cc:message.cc,bcc:message.bcc,snippet:message.snippet,subject:message.subject||"",date:message.date,internalDate:message.internalDate?new Date(g.parseInt(message.internalDate)):new Date,references:message.references,inReplyTo:message.inReplyTo,listUnsubscribe:message.listUnsubscribe,resources:resources||{}},decodedMessage.reportMessage&&this._sendReport(!1,"Mismatch mimeType/contentType",message);var attachments}return outMessage},parseEmailAddress:function parseEmailAddressFn(str){fromRegexp.lastIndex=0;var fromMatch=fromRegexp.exec(str),ret={};return fromMatch?(ret.text=fromMatch[1],ret.email=fromMatch[2]):ret.email=str,ret},parseEmailAddresses:function parseEmailAddressesFn(str){for(var arr=[],split=str.split(","),i=0;i<split.length;++i){var ret=this.parseEmailAddress(split[i]);arr.push(ret)}return arr},runRemoteSearch:function runRemoteSearchFn(search,paneID,bucketID,cb){try{g.PAssert(4596,search,"Must provide a valid search")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4597,paneID,"Must provide a valid pane")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4598,bucketID,"Must provide a valid bucket ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4599,g.isFunction(cb),"Must provide a valid search callback")}catch(PERR){g.reportError(PERR)}var q="-in:chats -in:spam "+search,pane=g.vmMain.paneManager.getPaneById(paneID),accountID=this._getAccountIDFromItem(pane.getItem())||this.getDefaultAccount(),doneProcessingEntries=!1,totalEntries=0,finishedEntries=0,errorEntries=0,runningSearch=new CachedSearch(search,DEFAULT_THREAD_MAX_RESULTS,this.requestDataPage.bind(this)),checkSearchCompleted=function(hasError){if(totalEntries===finishedEntries&&doneProcessingEntries){log("Done Searching: ",totalEntries);var resultStatus=hasError?SearchResultStatus.Error:totalEntries>0?SearchResultStatus.Done:SearchResultStatus.None;runningSearch.isValid()&&this.swapInSearchBucket(bucketID,paneID),cb(resultStatus)}}.bind(this),entryCB=function(entry){if(totalEntries++,entry){var cacheEntry=this._addRemoteEntry(accountID,entry),itemStore=this.getBucketItemStore(bucketID);this._ensureVMLIsForSearchResult(cacheEntry,itemStore),finishedEntries++}else finishedEntries++,errorEntries++;checkSearchCompleted()}.bind(this),doneCB=function(success){doneProcessingEntries=!0,checkSearchCompleted(!success)}.bind(this),firstSearchIsDone=!1,firstSearchDoneCB=function(success){runningSearch.onDone(success),firstSearchIsDone||(firstSearchIsDone=!0,runningSearch.isValid()&&runningSearch.hasResults()?runningSearch.getNextPage(entryCB,doneCB):doneCB(success))},agg=new Aggregator(runningSearch.onEntry,firstSearchDoneCB);return this._requestRemoteThreads(accountID,RequestType.Search,void 0,q,DEFAULT_THREAD_MAX_RESULTS,agg.getEntryCB(),agg.getDoneCB()),runningSearch},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach){this.loadRemoteAPIs(),gdata.requestNotifyWhenAvailable(function(){try{g.PAssert(4600,attach.hasField("accountID"),"Must have a valid accountID for a thread")}catch(PERR){g.reportError(PERR)}if(attach.hasField("accountID")){var dataCB=function(result,errorResult){result?this._addRemoteEntry(attach.getField("accountID"),result):(attach.notifyDataRequestFailed(),this._notifyFailedRequest(attach.getField("accountID"),errorResult))}.bind(this);this._requestRemoteThreadMetadata(attach.getField("accountID"),attach.id,attach,dataCB)}}.bind(this))},_updateThreadFromMessages:function _updateThreadFromMessagesFn(thread){var oldLabels=thread.labelIds||[],currentUser=g.getUserIdentifier();"me"===thread.accountID&&"me"!==currentUser&&(thread.accountID=currentUser),thread.labelIds=[],thread.date=void 0,thread.participants=[],thread.count=thread.messages.length,thread.snippet=thread.count>0?thread.messages[thread.messages.length-1].snippet:"",thread.hasPriority=!1;for(var i=0;i<thread.messages.length;++i){var message=thread.messages[i];try{g.PAssert(4601,message.id,"Each message must have a valid ID")}catch(PERR){g.reportError(PERR)}thread.labelIds.pushOnlyUniques(message.labelIds);var isDraft=message.labelIds.indexOf(SystemLabels.DRAFT)>=0,isToMe=!1;if(message.labelIds.indexOf(SystemLabels.SENT)>=0)for(var j=0;j<message.to.length;++j){var toData=message.to[j];if(this.isMyAccountID(toData.email)){isToMe=!0;break}}else isToMe=!0;for(var resID in message.resources)if(message.resources.hasOwnProperty(resID)){var res=message.resources[resID];this._displayAttachment(res)&&(thread.hasAttachments=!0)}(!thread.date||message.date&&thread.date.isBefore(message.date)&&!isDraft&&isToMe)&&(thread.date=message.date),(!thread.internalDate||message.internalDate&&thread.internalDate.isBefore(message.internalDate))&&(thread.internalDate=message.internalDate),message.from&&thread.participants.indexOfWithProperty("email",message.from.email)<0&&thread.participants.push(message.from)}thread.date=new Date(thread.date?thread.date:0),thread.internalDate=thread.internalDate?new Date(thread.internalDate):new Date,thread.lastModifiedDate=thread.lastModifiedDate?new Date(thread.lastModifiedDate):thread.date,g.isDateValid(thread.date)||(thread.date=new Date(0)),g.isDateValid(thread.internalDate)||(thread.internalDate=new Date),(!g.isDateValid(thread.lastModifiedDate)||thread.lastModifiedDate.isBefore(thread.date))&&(thread.lastModifiedDate=thread.date),thread.messages.length>0&&(thread.subject=thread.messages[0].subject,thread.subjectLower=thread.subject.toLowerCase(),thread.from=thread.messages[thread.messages.length-1].from,thread.to=thread.messages[0].to);var labelsAdded=thread.labelIds.removeArray(oldLabels),labelsRemoved=oldLabels.removeArray(thread.labelIds);return{labelsAdded:labelsAdded,labelsRemoved:labelsRemoved}},_updateAttachmentFromMessages:function _updateAttachmentFromMessagesFn(attach,changeType){var changes=this._updateThreadFromMessages(attach.getData());this._handleThreadLabelUpdates(attach.getData(),changes.labelsAdded,changes.labelsRemoved),attach.notifyDataMutated(["labelIds","date","internalDate","lastModifiedDate","count","snippet","subject","subjectLower","from","to"],changeType)},_createRemoteEntry:function _createRemoteEntryFn(accountID,info){for(var entry={id:info.id,accountID:accountID,messages:[],labelIds:[]},i=0;i<info.messages.length;++i){var msg=info.messages[i];try{g.PAssert(4602,msg.id,"Message must have a valid id")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4603,!msg.labelIds||msg.labelIds.indexOf(SystemLabels.CHAT)<0,"Should never receive a chat message")}catch(PERR){g.reportError(PERR)}msg.labelIds&&msg.labelIds.indexOf(SystemLabels.DRAFT)>=0&&this._notifyDraftMessage(accountID,info.id,msg.id);for(var msgEntry={id:msg.id,messageID:void 0,internalDate:msg.internalDate?new Date(g.parseInt(msg.internalDate)):new Date,snippet:msg.snippet,labelIds:msg.labelIds||[],to:[],resources:{},subject:""},j=0;j<msg.payload.headers.length;++j){var header=msg.payload.headers[j];switch(header.name.toUpperCase()){case"TO":msgEntry.to=this.parseEmailAddresses(header.value);break;case"FROM":msgEntry.from=this.parseEmailAddress(header.value);break;case"SUBJECT":msgEntry.subject=header.value;break;case"MESSAGE-ID":msgEntry.messageID=header.value;break;case"IN-REPLY-TO":msgEntry.inReplyTo=header.value;break;case"DATE":msgEntry.date=new Date(header.value);try{g.PAssert(4605,g.isDateValid(msgEntry.date),"Must have a valid message date: ",header.value)}catch(PERR){g.reportError(PERR)}}}try{g.PAssert(4606,msgEntry.messageID,"Message must have a valid messageID")}catch(PERR){g.reportError(PERR)}msgEntry.date||(msgEntry.date=msgEntry.internalDate),msgEntry.subject||(msgEntry.subject=""),entry.messages.push(msgEntry)}return this._updateThreadFromMessages(entry),entry},_addRemoteEntry:function _addRemoteEntryFn(accountID,info){var newEntry=this._createRemoteEntry(accountID,info);if(this.hasCacheData(newEntry.id)){var oldEntry=this.getCacheData(newEntry.id);if(oldEntry){this._mergeThreadData(oldEntry,newEntry);var labelChanges=this._updateThreadFromMessages(newEntry);this._handleThreadLabelUpdates(newEntry,labelChanges.labelsAdded,labelChanges.labelsRemoved)}var changedFields=this.getChangedFields(oldEntry,newEntry);if(this.cacheData(newEntry.id,newEntry,!!oldEntry,changedFields),this.fieldsHaveParseEffect(changedFields)&&this.hasAttachment(newEntry.id)){var attach=this.getAttachment(newEntry.id);attach.notifyDataMutated(changedFields,ChangeType.Remote)}}else this.cacheData(newEntry.id,newEntry),this._updateSearchPanes(newEntry,newEntry.labelIds,[]);return newEntry},cacheData:function cacheDataFn(key,data,isUpdate,updateFields){this._super.cacheData.call(this,key,data,isUpdate,updateFields),data.messages&&this._checkUnsyncdMessageContent(data)},createEntryFromLocal:function createEntryFromLocalFn(id,info){info.subjectLower=info.subject.toLowerCase(),info.messages=info.messages||[];for(var i=0;i<info.messages.length;++i){var msg=info.messages[i];g.isString(msg.date)?msg.date=new Date(msg.date):msg.date||(msg.date=new Date),g.isString(msg.internalDate)?msg.internalDate=new Date(msg.internalDate):msg.internalDate||(msg.internalDate=new Date),msg.to||(msg.to=[]),msg.resources||(msg.resources={});try{g.PAssert(4607,msg.draftID||msg.messageID||g.isTempId(msg.id),"Remotely saved messages must have a valid message ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4608,g.isDateValid(msg.date),"Must have a valid message date: ",msg.date)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4609,g.isDateValid(msg.internalDate),"Must have a valid internal message date: ",msg.internalDate)}catch(PERR){g.reportError(PERR)}}return this._updateThreadFromMessages(info),info},_updateMessageData:function _updateMessageDataFn(attach,msgID,msgData){var messages=attach.getField("messages"),oldMsgIndex=messages.indexOfWithProperty("id",msgID);try{g.PAssert(4610,oldMsgIndex>=0,"Must always be able to find the message being updated")}catch(PERR){g.reportError(PERR)}this._mergeMessageData(messages[oldMsgIndex],msgData,["labelIds"]),messages[oldMsgIndex]=msgData,attach.updateField("messages",messages),this._updateAttachmentFromMessages(attach,ChangeType.Remote)},_mergeMessageData:function _mergeMessageDataFn(oldMsg,newMsg,forceLocalFields){try{g.PAssert(4611,g.isObject(oldMsg),"Must pass in a valid old message")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4612,g.isObject(newMsg),"Must pass in a valid new message")}catch(PERR){g.reportError(PERR)}if(oldMsg.modifiedOffline){var fields=oldMsg.modifiedOffline;try{g.PAssert(4613,g.isArray(fields),"Should not be receiving an update for an event that was created locally")}catch(PERR){g.reportError(PERR)}for(var i=0;i<fields.length;++i)newMsg[fields[i]]=oldMsg[fields[i]];newMsg.modifiedOffline=oldMsg.modifiedOffline}if(forceLocalFields)for(var i=0;i<forceLocalFields.length;++i)oldMsg.hasOwnProperty(forceLocalFields[i])&&(newMsg[forceLocalFields[i]]=oldMsg[forceLocalFields[i]]);for(var field in oldMsg)newMsg.hasOwnProperty(field)||(newMsg[field]=oldMsg[field])},_mergeMessagesData:function _mergeMessagesDataFn(oldMessages,newMessages,forceLocalFields){try{g.PAssert(4614,g.isArray(oldMessages),"Must have a valid old messages array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4615,g.isArray(newMessages),"Must have a valid new messages array")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4616,oldMessages!==newMessages,"Should not pass in the same array for old and new")}catch(PERR){g.reportError(PERR)}for(var i=0;i<oldMessages.length;++i){var oldMsg=oldMessages[i],newMsgIndex=newMessages.indexOfWithProperty("id",oldMsg.id);if(newMsgIndex>=0){var newMsg=newMessages[newMsgIndex];try{g.PAssert(4617,newMsg,"Must have a valid new message")}catch(PERR){g.reportError(PERR)}this._mergeMessageData(oldMsg,newMsg,forceLocalFields)}else if(oldMsg.labelIds.indexOf(SystemLabels.DRAFT)>=0){var replyToMsgIndex=newMessages.indexOfWithProperty("messageID",oldMsg.inReplyTo);try{g.PAssert(4618,replyToMsgIndex>=0,"Must be able to find the message being replied to")}catch(PERR){g.reportError(PERR)}replyToMsgIndex>=0&&newMessages.splice(replyToMsgIndex+1,0,oldMsg)}}},_mergeThreadData:function _mergeThreadDataFn(oldData,newData){if(this.reportTrackedStat(TrackedStat.MergeThread),this._mergeMessagesData(oldData.messages,newData.messages,["resources"]),oldData.modifiedOffline){var fields=oldData.modifiedOffline;try{g.PAssert(4619,g.isArray(fields),"Should not be receiving an update for an event that was created locally")}catch(PERR){g.reportError(PERR)}for(var i=0;i<fields.length;++i){var field=fields[i];switch(field){case"messages":break;default:newData[field]=oldData[field]}}newData.modifiedOffline=oldData.modifiedOffline}for(var field in oldData)newData.hasOwnProperty(field)||(newData[field]=oldData[field]);newData.labelIds=oldData.labelIds},_shouldCacheThread:function _shouldCacheThreadFn(result){for(var shouldCache=!0,i=0;i<result.messages.length;++i){var msg=result.messages[i];if(msg.labelIds&&(msg.labelIds.indexOf(SystemLabels.SPAM)>=0||msg.labelIds.indexOf(SystemLabels.CHAT)>=0)){shouldCache=!1;break}}return shouldCache},_shouldCacheMessageData:function _shouldCacheMessageDataFn(entry){var shouldCache=!1,filterDate=this._getFullSyncTime(),unreadDate=this._getUnreadSyncTime();if(entry.date.isAfter(filterDate))shouldCache=!0;else if(entry.date.isAfter(unreadDate))for(var j=0;j<entry.messages.length;++j){var msg=entry.messages[j];if(this.isPriorityData(msg)){shouldCache=!0;break}}return shouldCache},refreshThreadCacheData:function refreshThreadCacheDataFn(accountID,threadID,msgID,reportFailure,cb){this._requestRemoteThreadMetadata(accountID,threadID,void 0,function(result,errorResult){if(result)if(this._shouldCacheThread(result)){var newEntry=this._addRemoteEntry(accountID,result);this._ensureVMLIsForThread(newEntry),this._threadCache.cacheEntry(threadID,this.serializeExternalData(newEntry),cb)}else this._deleteCachedThread(accountID,threadID,cb);else errorResult&&errorResult.error&&errorResult.error.code===C.HTTPStatusCode.NotFound?this._deleteCachedThread(accountID,threadID,cb):(reportFailure(accountID,threadID),cb&&cb(!1))}.bind(this))},_deleteCachedThread:function _deleteCachedThreadFn(accountID,threadID,cb){if(this.hasCacheData(threadID)){var attach=this.getAttachment(threadID);attach.updateField("messages",[]),this._updateAttachmentFromMessages(attach,ChangeType.Remote)}this._threadCache.removeEntry(threadID,function(success){try{g.PAssert(4620,success,"Should be able to delete the thread from the local thread cache")}catch(PERR){g.reportError(PERR)}cb&&cb(success)})},_deleteCachedMessage:function _deleteCachedMessageFn(accountID,threadID,msgID){if(this.hasCacheData(threadID))for(var attach=this.getAttachment(threadID),messages=attach.getField("messages"),i=0;i<messages.length;++i)if(messages[i].id===msgID){messages.removeAt(i),this._updateAttachmentFromMessages(attach,ChangeType.Remote),attach.updateField("messages",messages);break}this._threadCache.getEntry(threadID,function(entry){if(entry){for(var foundMessage=!1,i=0;i<entry.messages.length;++i)if(entry.messages[i].id===msgID){entry.messages.removeAt(i),this._threadCache.cacheEntry(threadID,entry),foundMessage=!0;break}try{g.PAssert(4622,foundMessage,"Must have found message to modify")}catch(PERR){g.reportError(PERR)}}}.bind(this))},setLastModifiedDate:function setLastModifiedDateFn(accountID,threadID,date){if(this.hasCacheData(threadID)){var attach=this.getAttachment(threadID);attach.updateField("lastModifiedDate",date)}this._threadCache.getEntry(threadID,function(entry){entry&&(entry.lastModifiedDate=date,this._threadCache.cacheEntry(threadID,entry))}.bind(this))},addLabelsToMessage:function addLabelsToMessageFn(accountID,threadID,msgID,labels,changeType){if(this.hasCacheData(threadID)){for(var attach=this.getAttachment(threadID),messages=attach.getField("messages"),i=0;i<messages.length&&(msgID&&messages[i].id!==msgID||(messages[i].labelIds.pushOnlyUniques(labels),!msgID));++i);this._updateAttachmentFromMessages(attach,changeType),attach.updateField("messages",messages)}this._threadCache.getEntry(threadID,function(entry){if(entry){for(var foundMessage=!1,i=0;i<entry.messages.length;++i)if(!msgID||entry.messages[i].id===msgID){entry.messages[i].labelIds.pushOnlyUniques(labels),this._threadCache.cacheEntry(threadID,entry),foundMessage=!0;break}try{g.PAssert(4623,foundMessage,"Must have found message to modify")}catch(PERR){g.reportError(PERR)}}}.bind(this))},removeLabelsFromMessage:function removeLabelsFromMessageFn(accountID,threadID,msgID,labels,changeType){if(this.hasCacheData(threadID)){for(var attach=this.getAttachment(threadID),messages=attach.getField("messages"),i=0;i<messages.length;++i)if(!msgID||messages[i].id===msgID){for(var j=0;j<labels.length;++j)messages[i].labelIds.remove(labels[j]);if(msgID)break}this._updateAttachmentFromMessages(attach,changeType),attach.updateField("messages",messages)}this._threadCache.getEntry(threadID,function(entry){if(entry){for(var foundMessage=!1,i=0;i<entry.messages.length;++i)if(!msgID||entry.messages[i].id===msgID){for(var j=0;j<labels.length;++j)entry.messages[i].labelIds.remove(labels[j]);this._threadCache.cacheEntry(threadID,entry),foundMessage=!0;break}try{g.PAssert(4624,foundMessage,"Must have found message to modify")}catch(PERR){g.reportError(PERR)}}}.bind(this))},changeMessageAccount:function changeMessageAccountFn(attach,messageID,newAccountID,sendingAccountID,newFromContact){try{g.PAssert(4625,newFromContact,"Must supply a valid from contact")}catch(PERR){g.reportError(PERR)}var newData,changedAccounts=newAccountID!==attach.getField("accountID"),message=this._getMessageFromAttachment(attach,messageID);return changedAccounts&&this.discardDraft(attach,messageID,function(success){try{g.PAssert(4626,success,"Must successfully delete remote draft")}catch(PERR){g.reportError(PERR)}}),message.from=newFromContact,message.replyTo=this.getReplyToAddress(newFromContact.email),message.decoded=EmailHTML.replaceSignature(message.decoded,this.getSignature(sendingAccountID)),newData=changedAccounts?this.createDraft(newAccountID,void 0,void 0,message):this.updateDraft(attach,messageID,message.draftID,message,message.snippet,!0,!0,function(success){try{g.PAssert(4627,success,"Must be able to successfully update the draft when swiching sending accounts")}catch(PERR){g.reportError(PERR)}})},_ensureVMLIsForSearchResult:function _ensureVMLIsForSearchResultFn(thread,itemStore){try{g.PAssert(4628,itemStore,"Should never be ensuring a search VMLI in the default item store")}catch(PERR){g.reportError(PERR)}var sAccountID="S~"+thread.accountID,accountVMLI=this._ensureVMLIsForAccount(sAccountID,itemStore),threadItemID=this._createThreadID(sAccountID,"",thread.id);if(!itemStore.hasItem(threadItemID)){var threadVMLI=itemStore.createItem(threadItemID,this._getTextForItem(thread),accountVMLI.id);accountVMLI.insertSorted(threadVMLI,this.sortFn)}},_removeVMLIFromSearchResult:function _removeVMLIFromSearchResultFn(thread,itemStore){try{g.PAssert(4629,itemStore,"Should never be ensuring a search VMLI in the default item store")}catch(PERR){g.reportError(PERR)}var sAccountID="S~"+thread.accountID,threadItemID=this._createThreadID(sAccountID,"",thread.id);itemStore.hasItem(threadItemID)&&itemStore.destroyItem(threadItemID)},_createThreadID:function _createThreadIDFn(accountID,labelID,threadID){return"T~"+accountID+"~"+labelID+"~"+threadID},_getItemProps:function _getItemPropsFn(thread,label){var props;return label.isNamed(PriorityLabels.PRI0)?props={priority:VMLIFlag.P0}:label.isNamed(PriorityLabels.PRI1)?props={priority:VMLIFlag.P1}:label.isNamed(PriorityLabels.PRI2)&&(props={priority:VMLIFlag.P2}),props},_ensureThreadLabelVMLI:function _ensureThreadLabelVMLIFn(thread,labelID,itemStore){var itemStore=itemStore||this.getDefaultItemStore(),label=this._getLabelByID(thread.accountID,labelID),labelVMLI=this._ensureVMLIsForLabel(thread.accountID,label,itemStore),threadItemID=this._createThreadID(thread.accountID,labelID,thread.id);if(this.reportTrackedStat(TrackedStat.EnsureLabelVMLI),!itemStore.hasItem(threadItemID)){this.reportTrackedStat(TrackedStat.CreateLabelVMLI);
var itemProps=this._getItemProps(thread,label),threadVMLI=itemStore.createItem(threadItemID,this._getTextForItem(thread),labelVMLI.id,itemProps);labelVMLI.insertSorted(threadVMLI,this.threadSortFn)}},_removeThreadLabelVMLI:function _removeThreadLabelVMLIFn(thread,labelID,itemStore){var itemStore=itemStore||this.getDefaultItemStore(),threadItemID=this._createThreadID(thread.accountID,labelID,thread.id);itemStore.hasItem(threadItemID)&&itemStore.destroyItem(threadItemID)},_ensureVMLIsForThread:function _ensureVMLIsForThreadFn(thread,itemStore){g.vmMain.beginUpdateItems();for(var i=0;i<thread.labelIds.length;++i)this._ensureThreadLabelVMLI(thread,thread.labelIds[i],itemStore);this._updateSpecialLabels(thread,itemStore),g.vmMain.commitUpdateItems()},_getRequiredSearchLabels:function _getRequiredSearchLabelsFn(search){for(var labels=[SystemLabels.INBOX],parts=search.split(" "),i=0;i<parts.length;++i){var part=parts[i],partInfo=part.split(":");partInfo&&2===partInfo.length&&("label"===partInfo[0]||"category"===partInfo[0]||"is"===partInfo[0])&&labels.push(partInfo[1].toUpperCase())}return labels},_handleThreadLabelUpdates:function _handleThreadLabelUpdatesFn(thread,labelsAdded,labelsRemoved){var itemStore=this.getDefaultItemStore();g.vmMain.beginUpdateItems();for(var i=0;i<labelsAdded.length;++i)this._ensureThreadLabelVMLI(thread,labelsAdded[i]);for(var i=0;i<labelsRemoved.length;++i)this._removeThreadLabelVMLI(thread,labelsRemoved[i]);this._updateSpecialLabels(thread,itemStore),this._updateSearchPanes(thread,labelsAdded,labelsRemoved),g.vmMain.commitUpdateItems()},_updateSearchPanes:function _updateSearchPanesFn(thread,labelsAdded,labelsRemoved){g.vmMain.beginUpdateItems(),g.vmMain.paneManager.runForEachPane(function(pane){if(pane.isSearchingRemote()){var paneStore=this.getActiveItemStore(pane.id),search=pane.search.getRemoteValue(),reqLabels=this._getRequiredSearchLabels(search),needsRemove=!1,needsAdd=!1;reqLabels.forEach(function(label){labelsRemoved.indexOf(label)>=0?needsRemove=!0:labelsAdded.indexOf(label)>=0&&(needsAdd=!0)}),needsRemove?paneStore!==this.getDefaultItemStore()&&(g.focusedPane!==pane||0!==labelsAdded.length||1!==labelsRemoved.length||labelsRemoved[0]!==SystemLabels.UNREAD)&&this._removeVMLIFromSearchResult(thread,paneStore):needsAdd&&paneStore!==this.getDefaultItemStore()&&this._ensureVMLIsForSearchResult(thread,paneStore)}}.bind(this),this.getPaneType()),g.vmMain.commitUpdateItems()},_updateSpecialLabels:function _updateSpecialLabelsFn(thread,itemStore){this._threadIsArchived(thread)?this._ensureThreadLabelVMLI(thread,SpecialLabels.ARCHIVED,itemStore):this._removeThreadLabelVMLI(thread,SpecialLabels.ARCHIVED,itemStore)},_ensureVMLIsForAccount:function _ensureVMLIsForAccountFn(accountID,itemStore){try{g.PAssert(4630,accountID,"Must specify a valid account ID")}catch(PERR){g.reportError(PERR)}var itemStore=itemStore||this.getDefaultItemStore(),id="A~"+accountID,accountVMLI=itemStore.getItem(id);if(!accountVMLI){var root=itemStore.getRoot();accountVMLI=itemStore.createItem(id,accountID,root.id),root.insertSorted(accountVMLI,this.sortFn)}return accountVMLI},_ensureVMLIsForLabel:function _ensureVMLIsForLabelFn(accountID,label,itemStore){try{g.PAssert(4631,label,"Must specify a valid label")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4632,label instanceof GmailLabel,"Must pass in a valid label object")}catch(PERR){g.reportError(PERR)}var itemStore=itemStore||this.getDefaultItemStore(),id="L~"+accountID+"~"+label.getLabelID(),labelVMLI=itemStore.getItem(id);if(labelVMLI)labelVMLI.getParsedText()!==label.getDisplayText()&&labelVMLI.setText(label.getDisplayText(),!0,ChangeType.Auto);else{var parentVMLI;if(label.hasAncestors()){var parentLabel=this._getLabelByName(accountID,label.getParent().getRawName());parentVMLI=parentLabel?this._ensureVMLIsForLabel(accountID,parentLabel,itemStore):this._ensureVMLIsForAccount(accountID,itemStore)}else parentVMLI=this._ensureVMLIsForAccount(accountID,itemStore);labelVMLI=itemStore.createItem(id,label.getDisplayText(),parentVMLI.id),parentVMLI.insertSorted(labelVMLI,this.sortFn)}return labelVMLI},getVMLIForAccount:function getVMLIForAccountFn(accountID){return this._ensureVMLIsForAccount(accountID)},getVMLIForLabel:function getVMLIForLabelFn(accountID,label){return this._ensureVMLIsForLabel(accountID,label)},getLabelForVMLI:function getLabelForVMLIFn(item){var desc=this.getDescriptorForItem(item),label;return desc.accountID&&desc.labelID&&(label=this._getLabelByID(desc.accountID,desc.labelID)),label},_getAccountIDFromItem:function _getAccountIDFromItemFn(item){var accountID,text=item.id;text.startsWith("A~")?(accountID=text.substr(2),accountID.startsWith("S~")&&(accountID=accountID.substr(2))):text.startsWith("L~")?accountID=text.substring(2,text.indexOf("~",2)):text.startsWith("T~")&&(accountID=text.substring(2,text.indexOf("~",2)));try{g.PAssert(4633,!accountID||accountID.indexOf("~")<0,"Should not contain delim in label ID")}catch(PERR){g.reportError(PERR)}return accountID},_getLabelIDFromItem:function _getLabelIDFromItemFn(item){var labelID,text=item.id;text.startsWith("L~")?labelID=text.substr(text.indexOf("~",2)+1):text.startsWith("T~")&&(labelID=text.substr(text.indexOf("~",2)+1));try{g.PAssert(4634,!labelID||g.isTempId(labelID)||labelID.indexOf("~")<0,"Should not contain delim in label ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4635,!labelID||labelID.length>3,"Label ID should be longer than a couple of chars")}catch(PERR){g.reportError(PERR)}return labelID},_getThreadIDFromItem:function _getThreadIDFromItemFn(item){return this._getThreadID(item.id)},_getThreadID:function _getThreadIDFn(text){var threadID;text.startsWith("T~")?threadID=text.substr(text.lastIndexOf("~")+1):text.startsWith("A~")||text.startsWith("L~")||(threadID=text);try{g.PAssert(4636,!threadID||g.isTempId(threadID)||threadID.indexOf("~")<0,"Should not contain delim in thread ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4637,!threadID||threadID.length>3,"Thread ID should be longer than a couple of chars")}catch(PERR){g.reportError(PERR)}return threadID},isAccountItem:function isAccountItemFn(item){return item.id.startsWith("A~")},isLabelItem:function isLabelItemFn(item){return item.id.startsWith("L~")},isThreadItem:function isThreadItemFn(item){return item.id.startsWith("T~")},getAttachmentClass:function getAttachmentClassFn(){return["plugin_gmail"]},googleScopes:function googleScopesFn(){return[GScope.GmailModify,GScope.GmailCompose]},getDependencies:function getDependenciesFn(){return[PluginDependency.LocalLoaded,PluginDependency.GmailAPI,PluginDependency.GoogleLogin]},isDependencyLoaded:function isDependencyLoadedFn(dep,data){var isLoaded=!1;switch(dep){case PluginDependency.GoogleLogin:data&&data.indexOf(GScope.GmailModify)>=0&&(isLoaded=!0);break;default:isLoaded=!0}return isLoaded},loadRemoteAPIs:function loadRemoteAPIsFn(cb,timeout){if(this.areRemoteAPIsLoaded())cb&&cb();else{var loadTimeout;cb&&void 0!==timeout&&(loadTimeout=setTimeout(cb,timeout)),g.loadGoogleAPI("gmail","v1",function(){try{g.PAssert(4638,this.areRemoteAPIsLoaded(),"Must have loaded gmail remote APIs")}catch(PERR){g.reportError(PERR)}g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GmailAPI),loadTimeout&&(clearTimeout(loadTimeout),loadTimeout=void 0),cb&&cb()}.bind(this))}},areRemoteAPIsLoaded:function areRemoteAPIsLoadedFn(){return window.gapi&&window.gapi.client&&window.gapi.client.gmail},handleTapStart:function handleTapStartFn(item,id,e){return platform.mobile&&e.preventDefault(),!0},handleTapClick:function handleTapClickFn(item,id,e){var element=e.target,pane=g.getPaneForElement(element);try{g.PAssert(4639,pane,"Gmail tapped but is not actually a pane",g.getElementPath(element))}catch(PERR){g.reportError(PERR)}return pane&&!this.isPluginPane(pane)?this.openEmailByID(id,pane):void 0},handleDoubleTap:function handleDoubleTapFn(item,id,e){var element=e.target,pane=g.getPaneForElement(element);this.openEmailByID(id,pane),platform.mobile&&(e.preventDefault(),g.preventClick())},isMyAccountID:function isMyAccountIDFn(accountID){try{g.PAssert(4640,"me"!==accountID||g.isDemoMode(),"Should not be checking me")}catch(PERR){g.reportError(PERR)}var currentUser=g.getUserIdentifier();try{g.PAssert(4641,g.isDemoMode()||"me"!==currentUser,"Should not be checking against current account until loaded")}catch(PERR){g.reportError(PERR)}return accountID===currentUser},createURLForThread:function createURLForThreadFn(attach){var accountID=attach.getField("accountID");return"me"===accountID&&(accountID=g.getUserIdentifier()),"https://mail.google.com/mail/b/"+accountID+"#all/"+attach.id},createPrintURLForThread:function createPrintURLForThreadFn(attach){var accountID=attach.getField("accountID");return"me"===accountID&&(accountID=g.getUserIdentifier()),"https://mail.google.com/mail/b/"+accountID+"/?ui=2&view=pt&search=all&th="+attach.id},openEmailByID:function openEmailByIDFn(id,pane){var emailInfo=this.getCacheData(id);if(emailInfo){var attach=this.getAttachment(emailInfo.id),isDraftOnly=this.isAttachmentDraftOnly(attach);return isDraftOnly?(this.sendEvent("Tap_DesktopDraft"),this.loadThread(attach,function(success){g.menus.openComposeEmail(this,attach.id)}.bind(this))):EmailPreview.open(attach,pane),!0}},_convertRawMessage:function _convertRawMessageFn(attach,messageID,messageEntry,cb){var remoteMessage={id:messageID,payload:messageEntry},cacheMessage=this._getMessageFromAttachment(attach,messageID);try{g.PAssert(4642,cacheMessage,"Must be able to get message metadata")}catch(PERR){g.reportError(PERR)}remoteMessage.labelIds=cacheMessage.labelIds,remoteMessage.messageID=cacheMessage.messageID,remoteMessage.snippet=cacheMessage.snippet,remoteMessage.internalDate=messageEntry.internalDate,cb(remoteMessage)},getThreadData:function getThreadDataFn(attach,cb,timeout){var messages=attach.getField("messages");return 0!==messages.length?this._getThreadData(attach,cb,timeout):void this.loadRemoteAPIs(function(){this._requestRemoteThreadMetadata(attach.getField("accountID"),attach.id,void 0,function(result,errorResult){var fetchData=!0;result?this._addRemoteEntry(attach.getField("accountID"),result):errorResult&&errorResult.error&&errorResult.error.code===C.HTTPStatusCode.NotFound&&(fetchData=!1),fetchData?this._getThreadData(attach,cb,timeout):cb(!1,"The conversation that you requested no longer exists.")}.bind(this))}.bind(this),timeout)},_getThreadData:function _getThreadDataFn(attach,cb,timeout){function checkThreadFetched(){if(numFetched===expectedFetch&&doneFetching){for(var remoteThread={messages:[]},i=0;i<messages.length;++i){var outMessage=outMessages[messages[i].id];if(outMessage)remoteThread.messages.push(outMessage);else try{g.PAssert(4643,!1,"Do not currently handle loading threads with a missing message")}catch(PERR){g.reportError(PERR)}}try{g.PAssert(4644,remoteThread.messages.length===messages.length,"Messages should always be found for thread")}catch(PERR){g.reportError(PERR)}0===messages.length?cb(void 0,"This message is not cached locally and we could not contact the remote server."):cb(remoteThread)}}for(var messages=attach.getField("messages"),expectedFetch=messages.length,numFetched=0,doneFetching=!1,outMessages={},i=0;i<messages.length;++i){var msg=messages[i];this.getMessageData(attach,msg.id,function(remoteMessage,error){remoteMessage&&(outMessages[remoteMessage.id]=remoteMessage),++numFetched,checkThreadFetched()}.bind(this),timeout)}doneFetching=!0,setTimeout(checkThreadFetched.bind(this),0)},getMessageData:function getMessageDataFn(attach,messageID,cb,timeout){this._rawCache.getEntry(messageID,function(msgEntry){msgEntry?this._convertRawMessage(attach,messageID,msgEntry,function(remoteMessage){cb(remoteMessage)}.bind(this)):this.loadRemoteAPIs(function(){this.areRemoteAPIsLoaded()?this._requestRemoteMessageDataRaw(attach.getField("accountID"),attach.id,messageID,function(result,error){cb(result,error)}.bind(this)):cb()}.bind(this),timeout)}.bind(this))},loadThread:function loadThreadFn(attach,cb){var isDraftOnly=this.isAttachmentDraftOnly(attach);if(AccountManager.isAuthorized(attach.getField("accountID"),GScope.GmailModify))if(attach.getField("dataLoaded")||attach.isLocalOnlyAttachment()){for(var messages=attach.getField("messages"),doneLoading=!1,loadedData=!1,missingMessages=0,messagesLoaded=0,totalMessages=messages.length,alreadyLoadedMessages=0,checkMessagesLoaded=function(){doneLoading&&missingMessages===messagesLoaded&&(totalMessages===alreadyLoadedMessages&&(loadedData=!0),setTimeout(function(){cb(!0,loadedData)},0))},i=0;i<messages.length;++i){var msg=messages[i];void 0===msg.decoded?(msg.decoded="",missingMessages++,this.getMessageData(attach,msg.id,function(result){if(messagesLoaded++,result){""===result.decoded&&(result.decoded=void 0);var pMessage=this._parseMailMessage(result);try{g.PAssert(4645,pMessage,"Must be able to parse message")}catch(PERR){g.reportError(PERR)}this._updateMessageData(attach,pMessage.id,pMessage),loadedData=!0}checkMessagesLoaded()}.bind(this),5e3)):(msg.decoded||msg.labelIds.indexOf(SystemLabels.DRAFT)>=0)&&alreadyLoadedMessages++}doneLoading=!0,checkMessagesLoaded()}else if(isDraftOnly){var draft=attach.getField("messages")[0];this.getMessageData(attach,draft.id,function(result){if(result){var pMessage=this._parseMailMessage(result);try{g.PAssert(4646,pMessage,"Must be able to parse message")}catch(PERR){g.reportError(PERR)}this._updateMessageData(attach,pMessage.id,pMessage)}loadedData=!0,cb(!0,loadedData)}.bind(this),5e3)}else this.getThreadData(attach,function(result,errorMessage){result&&this._parseMailThread(attach,result),loadedData=!0,cb(!!attach.getField("dataLoaded"),loadedData,errorMessage)}.bind(this),5e3);else cb(!1,!1,"This thread belongs to an account ("+attach.getField("accountID")+") you are not authorized to access.")},_verifyEmailAttachments:function _verifyEmailAttachmentsFn(attach,messageID){var errorMessage,handleMessageFn,draft=this._getMessageFromAttachment(attach,messageID);if(draft)for(var id in draft.resources){var res=draft.resources[id];res.uploader&&(res.uploader.hasError()?errorMessage="There was an error uploading one or more attachments. Please remove them or try uploading again.":res.uploader.isDone()||(errorMessage="One or more of your attachments is still uploading.",handleMessageFn=function(toast){this.onEmailReadyToSend(draft,function(){g.toasts.clearMessage(toast)})}.bind(this)))}return errorMessage?{message:errorMessage,handleMessageFn:handleMessageFn}:void 0},_verifyEmailRecipients:function _verifyEmailRecipientsFn(attach,messageID){var errorMessage,draft=this._getMessageFromAttachment(attach,messageID);if(draft)if(draft.to&&0!==draft.to.length)for(var i=0;i<draft.to.length;++i){var token=draft.to[i];token&&token.email?g.isEmail(token.email)||(errorMessage="You have entered an invalid email"):errorMessage="You have entered a contact with an invalid email address"}else errorMessage="You must enter at least one person to send this email to";else errorMessage="Unable to find the message you are trying to send";return errorMessage?{message:errorMessage}:void 0},_formatAddressText:function _formatAddressTextFn(name,email,encode){var text;return text=name?encode?'"'+g.encodeMIMEHeader(name)+'" <'+email+">":'"'+name+'" <'+email+">":email},_createAddressTextFromTokens:function _createAddressTextFromTokensFn(tokens,encode){var text="";if(tokens)for(var i=0;i<tokens.length;++i){var token=tokens[i];g.isEmail(token.email)&&(0!==i&&(text+=", "),text+=this._formatAddressText(token.text,token.email,encode))}try{g.PAssert(4647,!text.startsWith(","),"Should not start with a comma")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4648,!text.endsWith(","),"Should not end with a comma")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4649,text.indexOf(",,")<0,"Should not have two commas in a row")}catch(PERR){g.reportError(PERR)}return text.trim()},_createRFC822Message:function _createRFC822MessageFn(thread,draft,includeAttachments,cb){try{g.PAssert(4650,draft,"Must specify a valid draft")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4651,draft.contentType,"Must specify a valid content type for the draft")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4652,draft.from,"Must be able to get the from information for a user.")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4653,!draft.inReplyTo||draft.inReplyTo.indexOf("undefined")<0,"Should not have an undefined message id in reply-to: "+draft.inReplyTo)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4654,!draft.references||draft.references.indexOf("undefined")<0,"Should not have an undefined message id in references: "+draft.references)}catch(PERR){g.reportError(PERR)}var fromName=draft.from.text||g.vmMain.getUserName(),fromEmail=draft.from.email,msg=new RFC822Message(this);msg.updateFromDraft(thread,draft,fromName,fromEmail,includeAttachments,function(){var msgBlob=msg.generateBlob();cb(this._encodeEmail(msgBlob))}.bind(this))},createSignature:function createSignatureFn(sendingAccountID){var signature,rawSignature=this.getSignature(sendingAccountID)||"";return signature=rawSignature?'<br/><br/>--<br/><div class="gmail_signature">'+rawSignature+"</div>":'<div class="gmail_signature"></div>'},createReplyQuote:function createReplyQuoteFn(msg){var quote;if(msg){var dateQuote="On "+msg.date.toString("MMM dd, y")+" at "+msg.date.toString("hh:mm tt")+", "+g.escape(this._createAddressTextFromTokens([msg.from]))+" wrote:";quote='<br>\n<div class="gmail_extra">\n<br>\n<div class="gmail_quote">'+dateQuote+'\n<br>\n<blockquote class="gmail_quote" style="margin:0 0 0 0.8ex;border-left:1px #ccc solid;padding-left:1ex">\n'+msg.decoded+"\n</blockquote>\n</div>\n<br>\n</div>\n"}return quote},createForwardQuote:function createForwardQuoteFn(msg){var quote,to=g.isArray(msg.to)?msg.to:[msg.to];return msg&&(quote='<br>\n<div class="gmail_quote">\n<br>\n---------- Forwarded message ----------<br>\nFrom: '+g.escape(this._createAddressTextFromTokens([msg.from]))+"<br>\nDate: "+msg.date.toString("ddd, MMM dd, y")+" at "+msg.date.toString("hh:mm tt")+"<br>\nSubject: "+msg.subject+"<br>\nTo: "+g.escape(this._createAddressTextFromTokens(to))+"\n<br>\n<br>\n"+msg.decoded+"\n</div>\n<br>\n"),quote},_sendEmail:function _sendEmailFn(attach,messageID,cb){this.sendEvent("SendDraft"),this._clearPendingDraftUpdate(attach,messageID);var draft=this._getMessageFromAttachment(attach,messageID);this._createRFC822Message(attach.getData(),draft,!0,function(encoded){var successCB=function(result){this._updateLocalDraftFromSend(attach,draft.id,result,cb)}.bind(this),failureCB=function(result){this._notifySendFailed(),cb(!1,result),this._notifyFailedRequest(attach.getField("accountID"),result)}.bind(this),messageData={raw:encoded};attach.isLocalOnlyAttachment()||(messageData.threadId=attach.id);var requestFn=["gapi","client","gmail","users","messages","send"],requestData={userId:attach.getField("accountID"),resource:messageData};this._queueRemoteRequestMulti(attach.getField("accountID"),requestFn,requestData,successCB,failureCB,void 0,RequestType.Send)}.bind(this))},_shouldSaveMessageContent:function _shouldSaveMessageContentFn(thread,msg){return msg.labelIds.indexOf(SystemLabels.DRAFT)>=0},compactCacheField:function compactCacheFieldFn(entry,key){var outValue;switch(key){case"messages":outValue=[];for(var messages=entry[key],i=0;i<messages.length;++i){for(var inMsg=messages[i],outMsg={},j=0;j<FullMessageFields.length;++j)outMsg[FullMessageFields[j]]=inMsg[FullMessageFields[j]];if(this._shouldSaveMessageContent(entry,inMsg)||(delete outMsg.decoded,delete outMsg.mimeType,delete outMsg.contentType,delete outMsg.listUnsubscribe),outMsg.resources&&!g.isEmpty(outMsg.resources)){var resMap={};for(var id in outMsg.resources){var res=g.clone(outMsg.resources[id]);delete res.data,delete res.size,delete res.uploader,resMap[id]=res}outMsg.resources=resMap}outValue.push(outMsg)}break;default:outValue=entry[key]}return outValue},_generateUndoRedo:function _generateUndoRedoFn(){this._undoStack.registerOwner(this,this.id),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Archive,{undo:this.unarchiveAttachment,redo:this.archiveAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Unarchive,{undo:this.archiveAttachment,redo:this.unarchiveAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Trash,{undo:this.untrashAttachment,redo:this.trashAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Untrash,{undo:this.trashAttachment,redo:this.untrashAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.AddLabel,{undo:this.removeLabelFromAttachment,redo:this.addLabelToAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.RemoveLabel,{undo:this.addLabelToAttachment,redo:this.removeLabelFromAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.MarkRead,{undo:this.markAttachmentUnread,redo:this.markAttachmentRead}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.MarkUnread,{undo:this.markAttachmentRead,redo:this.markAttachmentUnread}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Star,{undo:this.markAttachmentUnstarred,redo:this.markAttachmentStarred}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Unstar,{undo:this.markAttachmentStarred,redo:this.markAttachmentUnstarred}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.SetPriority,{undo:this.setAttachmentPriority,redo:this.setAttachmentPriority}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Move,{undo:this.unmoveItem,redo:this.moveItem}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.Snooze,{undo:this.unsnoozeAttachment,redo:this.snoozeAttachment}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.ScheduleSend,{undo:this.cancelSendMessage,redo:this.scheduleSendMessage}),this._undoStack.registerAction(this.id,C.PluginAction.Gmail.DiscardDraft,{undo:g.emptyFn,redo:this.runDiscardDraft})},performAction:function performActionFn(action,preventUndo,attach,param1,param2){try{g.PAssert(4655,action,"Must supply a valid action")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4656,g.isBoolean(preventUndo),"Invalid preventUndo param")}catch(PERR){g.reportError(PERR)}this.beginAction(preventUndo);var undoParams,redoParams=[attach,param1,param2];try{undoParams=this._undoStack.runAction(this.id,action,redoParams)}catch(err){g.reportError(err)}if(this._undoStack.isUndoableAction()){var flattenParams=[attach];g.isArray(undoParams)?flattenParams.pushArray(undoParams):flattenParams.push(undoParams),this._undoStack.performAction(this.id,action,{undoParams:flattenParams,redoParams:redoParams})}this.endAction()},performActions:function performActionsFn(actionList,preventUndo){this.beginAction(preventUndo);for(var i=0;i<actionList.length;++i)this.performAction(actionList[i].action,actionList[i].attach,actionList[i].param);this.endAction()},beginAction:function beginActionFn(preventUndo){this._undoStack.beginAction(preventUndo),tracker.beginAction()},endAction:function endActionFn(){this._undoStack.endAction(),tracker.endAction()},handleUndo:function handleUndoFn(){tracker.beginAction(),this._undoStack.undoAction(),tracker.endAction()},handleRedo:function handleRedoFn(){tracker.beginAction(),this._undoStack.redoAction(),tracker.endAction()},supportOfflineCache:function supportOfflineCacheFn(){return!0},supportOfflineLoad:function supportOfflineLoadFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},_matchParticipant:function _matchParticipantFn(part,text){var matched=!1;return part&&(part.text&&(matched=part.text.toLowerCase().indexOf(text)>=0),!matched&&part.email&&(matched=part.email.toLowerCase().indexOf(text)>=0)),matched},_matchLabels:function _matchLabelsFn(entry,text){return this.hasLabelLike(entry.accountID,entry.id,text)},_matchEntry:function _matchEntryFn(entry,text){return entry.subjectLower.indexOf(text)>=0||this._matchParticipant(entry.from,text)||this._matchLabels(entry,text)},matchAttachment:function matchAttachmentFn(attach,text){return this._matchEntry(attach.getData(),text)},findMatchExact:function findMatchExactFn(text){},findMatchLike:function findMatchLikeFn(text,maxCount){var textLower=text.toLowerCase();return this.findCachedItemsByFn(function(entry){return this._matchEntry(entry,textLower)}.bind(this),maxCount)},previewTemplate:function previewTemplateFn(){return void 0},getItemText:function getItemTextFn(item){return this.getAttachmentEmbedString(item)},getItemTextLength:function getItemTextLengthFn(item){return 1},autocompleteWidth:function autocompleteWidthFn(){return 350},getAutocompletePrefixes:function getAutocompletePrefixesFn(){return["g:","gmail:"]},isGmailItem:function isGmailItemFn(item){return!!item.getAttachmentByPlugin(this.id)},itemHasLabelByID:function itemHasLabelByIDFn(item,labelID){var attach=item.getAttachmentByPlugin(this.id);return attach?this.attachmentHasLabelByID(attach,labelID):!1},itemHasLabel:function itemHasLabelFn(item,labelName){var attach=item.getAttachmentByPlugin(this.id);return attach?this.attachmentHasLabel(attach,labelName):!1},itemHasFullLabel:function itemHasFullLabelFn(item,labelName){var attach=item.getAttachmentByPlugin(this.id);return attach?this.attachmentHasFullLabel(attach,labelName):!1},itemHasDraft:function itemHasDraftFn(item){return this.itemHasLabel(item,SystemLabels.DRAFT)},isItemUnread:function isItemUnreadFn(item){return this.itemHasLabel(item,SystemLabels.UNREAD)},isItemImportant:function isItemImportantFn(item){return this.itemHasLabel(item,SystemLabels.IMPORTANT)},isItemStarred:function isItemStarredFn(item){return this.itemHasLabel(item,SystemLabels.STARRED)},isItemArchived:function isItemArchivedFn(item){var attach=item.getAttachmentByPlugin(this.id);return attach?this.attachmentIsArchived(attach):!1},isItemTrashed:function isItemTrashedFn(item){return this.itemHasLabel(item,SystemLabels.TRASH)},isItemFullTrashed:function isItemFullTrashedFn(item){return this.itemHasFullLabel(item,SystemLabels.TRASH)},isItemSpam:function isItemSpamFn(item){return this.itemHasLabel(item,SystemLabels.SPAM)},isDisplayItem:function isDisplayItemFn(item,isFocusedTrash){var isDisplay=!1;return this.isItemSpam(item)||!this.isThreadItem(item)||this.isItemFullTrashed(item)&&!isFocusedTrash||(isDisplay=!0),isDisplay},getItemPriority:function getItemPriorityFn(item){return item.hasAttachments()?this.getAttachmentPriority(item.getAttachments()[0]):0},_getCompDateForItem:function _getCompDateForItemFn(item){return item.hasAttachments()?item.getAttachments()[0].getField("lastModifiedDate"):new Date(0)},threadSortFn:function threadSortFnFn(left,right){return this._getCompDateForItem(right).compareTo(this._getCompDateForItem(left))},threadSortPriorityFn:function threadSortPriorityFnFn(left,right){var lAttach=left.getAttachments()[0],rAttach=right.getAttachments()[0],lPri=this.getAttachmentPriority(lAttach),rPri=this.getAttachmentPriority(rAttach),lStar=this.attachmentHasLabel(lAttach,SystemLabels.STARRED),rStar=this.attachmentHasLabel(rAttach,SystemLabels.STARRED);return lPri>rPri?-1:rPri>lPri?1:lStar&&!rStar?-1:rStar&&!lStar?1:this._getCompDateForItem(right).compareTo(this._getCompDateForItem(left))},labelSortFn:function labelSortFnFn(left,right){return left.displayCompare(right)},labelVMLISortFn:function labelVMLISortFnFn(leftVMLI,rightVMLI){var left=this._getLabelByID(this._getAccountIDFromItem(leftVMLI),this._getLabelIDFromItem(leftVMLI)),right=this._getLabelByID(this._getAccountIDFromItem(rightVMLI),this._getLabelIDFromItem(rightVMLI));return this.labelSortFn(left,right)},sortFn:function sortFnFn(left,right){return left.getParsedText().localeCompare(right.getParsedText())},getCssClass:function getCssClassFn(attach){return g.classNames({starred:this.attachmentHasLabel(attach,SystemLabels.STARRED)},{unread:this.attachmentHasLabel(attach,SystemLabels.UNREAD)},{p0:this.attachmentHasLabel(attach,PriorityLabels.PRI0)},{p1:this.attachmentHasLabel(attach,PriorityLabels.PRI1)},{p2:this.attachmentHasLabel(attach,PriorityLabels.PRI2)})},getTotalMessageCount:function getTotalMessageCountFn(cb){var cache=this._threadCache;cache.onCacheReady(function(){cache.count(cb)})},getSyncdMessageCount:function getSyncdMessageCountFn(cb){var cache=this._rawCache;cache.onCacheReady(function(){cache.count(cb)})},getUnsyncdMessageCount:function getUnsyncdMessageCountFn(){return this._numUnsyncdMessages},getSyncdMessageCount:function getSyncdMessageCountFn(){return this._numSyncdMessages},_checkUnsyncdMessageContent:function _checkUnsyncdMessageContentFn(cacheEntry){for(var i=0;i<cacheEntry.messages.length;++i){var msg=cacheEntry.messages[i];msg.cached?(this.reportTrackedStat(TrackedStat.SyncdMessage),this._numSyncdMessages++):msg.cachedError?this.reportTrackedStat(TrackedStat.ErrorSyncdMessage):this._shouldCacheMessageData(cacheEntry)?(this.reportTrackedStat(TrackedStat.UnsyncdMessage),this._notifyUnsyncdMessage(cacheEntry.accountID,cacheEntry.id,msg.id)):this.reportTrackedStat(TrackedStat.OldUnsyncdMessage)}},_notifyUnsyncdMessage:function _notifyUnsyncdMessageFn(accountID,threadID,messageID){g.isTempId(threadID)||g.isTempId(messageID)||(this._handleSyncContentCacheOp(this._unsyncdMessages,accountID,threadID,messageID),this._numUnsyncdMessages++,this._contentSyncTask.notifyWorkAvailable())},_notifyContentCached:function _notifyContentCachedFn(accountID,threadID,messageID){this._numSyncdMessages++,this._handleSyncContentCacheOp(this._pendingSyncdMessages,accountID,threadID,messageID)},_handleSyncContentCacheOp:function _handleSyncContentCacheOpFn(cache,accountID,threadID,messageID){var accountData;cache[accountID]||(cache[accountID]={}),accountData=cache[accountID],accountData[threadID]?accountData[threadID]!==!0&&accountData[threadID].indexOf(messageID)<0&&accountData[threadID].push(messageID):accountData[threadID]=messageID?[messageID]:!0},_removeUnsyncdMessage:function _removeUnsyncdMessageFn(accountID,threadID,messageID){this.reportTrackedStat(TrackedStat.MessagesSyncd),this._numUnsyncdMessages--;var accountData=this._unsyncdMessages[accountID];if(messageID){var threadData=accountData[threadID];threadData.remove(messageID),0===threadData.length&&delete accountData[threadID]}else delete accountData[threadID];g.isEmpty(accountData)&&delete this._unsyncdMessages[accountID]},_setCachedFieldForMessage:function _setCachedFieldForMessageFn(accountID,threadID,messageIDs){if(this.hasCacheData(threadID))for(var attach=this.getAttachment(threadID),messages=attach.getField("messages"),i=0;i<messages.length;++i)(messageIDs===!0||messageIDs.indexOf(messages[i].id)>=0)&&(messages[i].cached=!0);this._threadCache.getEntry(threadID,function(entry){if(entry){for(var i=0;i<entry.messages.length;++i){var msg=entry.messages[i];(messageIDs===!0||messageIDs.indexOf(msg.id)>=0)&&(msg.cached=!0)}this._threadCache.cacheEntry(threadID,entry)}}.bind(this))},_updateCachedErrorFieldForMessage:function _updateCachedErrorFieldForMessageFn(accountID,threadID,messageIDs){if(this.hasCacheData(threadID))for(var attach=this.getAttachment(threadID),messages=attach.getField("messages"),i=0;i<messages.length;++i)(messageIDs===!0||messageIDs.indexOf(messages[i].id)>=0)&&(messages[i].cachedError?messages[i].cachedError++:messages[i].cachedError=1);this._threadCache.getEntry(threadID,function(entry){if(entry){for(var i=0;i<entry.messages.length;++i){var msg=entry.messages[i];(messageIDs===!0||messageIDs.indexOf(msg.id)>=0)&&(msg.cached?msg.cachedError++:msg.cachedError=1)}this._threadCache.cacheEntry(threadID,entry)}}.bind(this))},_processSyncdContent:function _processSyncdContentFn(){for(var accountID in this._pendingSyncdMessages){var accountData=this._pendingSyncdMessages[accountID];for(var threadID in accountData){var threadData=accountData[threadID];if(g.isArray(threadData)){for(var i=0;i<threadData.length;++i){var messageID=threadData[i];this._removeUnsyncdMessage(accountID,threadID,messageID)
}this._setCachedFieldForMessage(accountID,threadID,threadData)}else threadData===!0&&this._removeUnsyncdMessage(accountID,threadID)}}this._pendingSyncdMessages={}},_processSyncErrors:function _processSyncErrorsFn(failedAccounts){log("Process Sync Errors: ",failedAccounts);for(var accountID in failedAccounts){var accountData=failedAccounts[accountID];for(var threadID in accountData){var threadData=accountData[threadID];try{g.PAssert(4658,g.isArray(threadData),"Must have a valid message ID list")}catch(PERR){g.reportError(PERR)}for(var i=0;i<threadData.length;++i){var messageID=threadData[i];this._removeUnsyncdMessage(accountID,threadID,messageID)}this._updateCachedErrorFieldForMessage(accountID,threadID,threadData)}}},driveMessageContentSync:function driveMessageContentSyncFn(doneCB){this._rawCache.onCacheReady(function(){var requestLimit=35;this._outstandingContentSync=!0;var numRequested=this._runMessageContentSync(requestLimit,function(success,failedAccounts){if(!success)try{this._processSyncErrors(failedAccounts)}catch(err){g.reportError(err)}this._processSyncdContent(),this._outstandingContentSync=!1,doneCB(!g.isEmpty(this._unsyncdMessages))}.bind(this))}.bind(this))},_runMessageContentSync:function _runMessageContentSyncFn(requestLimit,cb){function checkSyncDone(success,accountID,failedThreads){if(success?numSuccess++:(numFailure++,failedAccounts[accountID]=failedThreads),doneProcessing&&numSuccess+numFailure===numAccounts){var totalSuccess=0===numFailure;cb(totalSuccess,totalSuccess?void 0:failedAccounts)}}var numRequested=0,numAccounts=0,doneProcessing=!1,numSuccess=0,numFailure=0,failedAccounts={},syncAccounts=this.getSyncAccounts();for(var accountID in this._unsyncdMessages)if(syncAccounts.indexOf(accountID)>=0&&(numRequested+=this._syncMessageContentForAccount(accountID,this._unsyncdMessages[accountID],requestLimit-numRequested,checkSyncDone),numAccounts++,numRequested>=requestLimit))break;return doneProcessing=!0,0===numRequested&&setTimeout(function(){cb(!0)},0),numRequested},_syncMessageContentForAccount:function _syncMessageContentForAccountFn(accountID,data,requestLimit,cb){function checkAccountRequestsDone(success,threadID,failedMessageIDs){if(success?numSuccess++:(numFailure++,failedThreads[threadID]=failedMessageIDs),numSuccess+numFailure===numThreads){var totalSuccess=0===numFailure;cb(totalSuccess,accountID,totalSuccess?void 0:failedThreads)}}var numRequested=0,numThreads=0,doneProcessing=!1,numSuccess=0,numFailure=0,failedThreads={};for(var threadID in data)if(numRequested+=this._syncMessageContentForThread(accountID,threadID,data[threadID],requestLimit-numRequested,checkAccountRequestsDone),numThreads++,numRequested>=requestLimit)break;return doneProcessing=!0,numRequested},_syncMessageContentForThread:function _syncMessageContentForThreadFn(accountID,threadID,messageIDs,requestLimit,cb){function checkThreadRequestsDone(messageID,success){if(success?(numSuccess++,this._notifyContentCached(accountID,threadID,messageID)):failedMessageIDs.push(messageID),doneProcessing&&numSuccess+failedMessageIDs.length===numRequested){var totalSuccess=0===failedMessageIDs.length;cb(totalSuccess,threadID,totalSuccess?void 0:failedMessageIDs)}}var numRequested=0;if(g.isArray(messageIDs)){for(var doneProcessing=!1,numSuccess=0,failedMessageIDs=[],i=0;i<messageIDs.length&&requestLimit>numRequested;++i)this._requestRemoteMessageDataRaw(accountID,threadID,messageIDs[i],function(messageID,result,errorResult){result?this._handleContentSyncdMessage(accountID,threadID,result,checkThreadRequestsDone.bind(this,messageID)):checkThreadRequestsDone.call(this,messageID,!1)}.bind(this,messageIDs[i])),numRequested++;doneProcessing=!0}else this._requestRemoteThreadDataRaw(accountID,threadID,function(result,errorResult){result?this._handleContentSyncdThread(accountID,result,function(success){this._notifyContentCached(accountID,threadID),cb(success,threadID)}.bind(this)):cb(!1,threadID,!0)}.bind(this)),numRequested++;return numRequested},_handleContentSyncdMessage:function _handleContentSyncdMessageFn(accountID,threadID,data,cb){data.payload.id=data.id,data.payload.internalDate=data.internalDate,this._rawCache.cacheEntry(data.id,data.payload,cb)},_handleContentSyncdThread:function _handleContentSyncdThreadFn(accountID,data,cb){for(var i=0;i<data.messages.length;++i){var msg=data.messages[i];this._handleContentSyncdMessage(accountID,data.id,msg,cb)}},scheduleEmail:function scheduleEmailFn(item,date){tracker.beginAction();var attach=item.getAttachmentByPlugin(this.id);try{g.PAssert(4659,attach,"Must be able to get a valid attachment from item")}catch(PERR){g.reportError(PERR)}var subject=attach.getField("subject"),url=this.createURLForThread(attach),duration=C.MSPerHour,calendarPlugin=g.vmMain.getDefaultCalendarPlugin();calendarPlugin?calendarPlugin.getSetting(calendarPlugin.Settings.WriteAccess)?calendarPlugin.createEventForEmail(subject,url,date,duration,function(success){try{g.PAssert(4660,success,"Should always be able to schedule an event for an email")}catch(PERR){g.reportError(PERR)}success?(this.addLabelToAttachment(attach,"Moo.do/Scheduled"),this.getSetting(this.Settings.ArchiveOnSchedule)&&this.archiveAttachment(attach)):g.toasts.pushMessage({text:"There was an error adding the event to your Google Calendar.",action:MessageAction.Okay})}.bind(this)):g.toasts.pushMessage({text:"You must select an export calendar to enable scheduling and editing of events.",action:MessageAction.OpenSettings}):g.toasts.pushMessage({text:"The GCalendar plugin must be enabled to schedule emails.",action:MessageAction.OpenSettings}),tracker.endAction()}};return util.inherit(VMPlugin,Plugin_Gmail),util.extend(Plugin_Gmail.prototype,Plugin_GmailFns),Plugin_Gmail}),define("plugins/Plugin_Moodo",["globals","util","platform","VMPlugin"],function(g,util,platform,VMPlugin){function Plugin_Moodo(){this._isBuiltin=!0,this._super.constructor.call(this,PluginID.Moodo,"Moodo"),this.setSetting(this.Settings.IsEnabled,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.Unknown)}var RequestType={GenericSingle:1,GenericPaged:2,DrivePermissionsInsert:3,DrivePermissionsDelete:4,DrivePermissionsList:5,DriveFilesGet:6,DriveFilesList:7,DriveFilesTrash:8,DrivePropertiesInsert:9,DrivePropertiesUpdate:10,DriveParentsInsert:11,DriveParentsDelete:12,DriveChildrenList:13},drivePermissionFields="id,name,role,type,emailAddress",drivePermissionListFields="items("+drivePermissionFields+")",driveFileFields="createdDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,userPermission(id,role,type)",driveFileListFields="items("+driveFileFields+"),nextPageToken",driveChildFields="id",driveChildListFields="items("+driveChildFields+"),nextPageToken",Plugin_MoodoFns={isPluginBlocked:function isPluginBlockedFn(){return!1},allowRemoteRequests:function allowRemoteRequestsFn(){return!0},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach){this.cacheData(attach.id,{})},runRemoteSingleRequest:function runRemoteSingleRequestFn(requestFn,requestData,successCB,failureCB){this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.GenericSingle)},runRemotePagedRequest:function runRemotePagedRequestFn(requestFn,requestData,successCB,failureCB,options,type){this._queuePagedRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,type,options)},drivePermissionsInsert:function drivePermissionsInsertFn(fileID,emailAddr,sendNotificationEmails,successCB,failureCB){try{g.PAssert(4661,g.isEmail(emailAddr),"Should pass in a valid email address")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","drive","permissions","insert"],requestData={fileId:fileID,sendNotificationEmails:sendNotificationEmails,resource:{value:emailAddr,type:"user",role:"writer",withLink:!1}};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DrivePermissionsInsert)},drivePermissionsDelete:function drivePermissionsDeleteFn(fileID,permissionID,successCB,failureCB){var requestFn=["gapi","client","drive","permissions","delete"],requestData={fileId:fileID,permissionId:permissionID};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DrivePermissionsDelete)},drivePermissionsList:function drivePermissionsListFn(fileID,successCB,failureCB){var requestFn=["gapi","client","drive","permissions","list"],requestData={fileId:fileID,fields:drivePermissionListFields};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DrivePermissionsList)},drivePermissionsPublic:function drivePermissionsPublicFn(fileID,successCB,failureCB){var requestFn=gapi.client.drive.permissions.insert,requestData={fileId:fileID,sendNotificationEmails:!1,resource:{type:"anyone",role:"reader",withLink:!0}};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DrivePermissionsInsert)},driveFilesGet:function driveFilesGetFn(fileID,successCB,failureCB){var requestFn=["gapi","client","drive","files","get"],requestData={fileId:fileID,fields:driveFileFields};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DriveFilesGet)},driveFilesList:function driveFilesListFn(q,successCB,failureCB,options){var requestFn=["gapi","client","drive","files","list"],requestData={q:q,fields:driveFileListFields};this.runRemotePagedRequest(requestFn,requestData,successCB,failureCB,options,RequestType.DriveFilesList)},driveFilesTrash:function driveFilesTrashFn(fileID,successCB,failureCB){var requestFn=["gapi","client","drive","files","trash"],requestData={fileId:fileID};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DriveFilesTrash)},drivePropertiesInsert:function drivePropertiesInsertFn(fileID,key,value,successCB,failureCB){var requestFn=["gapi","client","drive","properties","insert"],requestData={fileId:fileID,resource:{key:key,value:value,visibility:"PRIVATE"}};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DrivePropertiesInsert)},drivePropertiesUpdate:function drivePropertiesUpdateFn(fileID,key,value,successCB,failureCB){var requestFn=["gapi","client","drive","properties","update"],requestData={fileId:fileID,propertyKey:key,resource:{key:key,value:value,visibility:"PRIVATE"}};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DrivePropertiesUpdate)},driveParentsInsert:function driveParentsInsertFn(fileID,parentID,successCB,failureCB){var requestFn=["gapi","client","drive","parents","insert"],requestData={fileId:fileID,resource:{id:parentID}};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DriveParentsInsert)},driveParentsDelete:function driveParentsDeleteFn(fileID,parentID,successCB,failureCB){var requestFn=["gapi","client","drive","parents","delete"],requestData={fileId:fileID,parentId:parentID};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DriveParentsDelete)},driveChildrenList:function driveChildrenListFn(folderID,successCB,failureCB,options){var requestFn=["gapi","client","drive","children","list"],requestData={folderId:folderID,fields:driveChildListFields};this.runRemotePagedRequest(requestFn,requestData,successCB,failureCB,options,RequestType.DriveChildrenList)}};return util.inherit(VMPlugin,Plugin_Moodo),util.extend(Plugin_Moodo.prototype,Plugin_MoodoFns),Plugin_Moodo}),define("PluginSettings",["globals","data","util","platform","goog","tracker","Observable","ObservableArray"],function(g,d,util,platform,goog,tracker,Observable,ObservableArray){function PluginSettings(){this.pluginsAvailable=[PluginID.Contacts,PluginID.Drive,PluginID.GCalendar,PluginID.Gmail],this._pluginEnabledObservables={},this._pluginOptionObservables={},this.isRefreshingContacts=new Observable(!1),this.GCalendarsAvailable=new ObservableArray,this.GCalendarSyncErrors=new ObservableArray(void 0),this.GCalendarAddFailure=new Observable(!1),this.GCalendarListFailure=new Observable(!1),this.GCalendarListLoading=new Observable(!1),this.GmailNumSyncd=new Observable(0),this.GmailNumTotal=new Observable(0),this.GmailCacheSize=new Observable(0),this.GmailSyncAccounts=new ObservableArray,this.enableOfflineAuth=new Observable(!1),util.forceBind("calendarComparator",this)}return PluginSettings.prototype={refresh:function refreshFn(pluginID){for(var i=0;i<this.pluginsAvailable.length;++i){var pid=this.pluginsAvailable[i],authed;authed=pid===PluginID.Contacts?g.settings.get(Settings.syncContacts):g.vmMain.pluginManager.isAuthorized(pid),this.updatePluginStatus(pid,authed)}pluginID&&pluginID!==PluginID.GCalendar||(this.GCalendarAddFailure.set(!1),this.GCalendarListFailure.set(!1),this.updateCalendarList(),this.updatePluginOptionStatus(PluginID.GCalendar,PluginSettingsID.GCalendar.WriteAccess),this.updatePluginOptionStatus(PluginID.GCalendar,PluginSettingsID.GCalendar.ImportCalendars,!0),this.updatePluginOptionStatus(PluginID.GCalendar,PluginSettingsID.GCalendar.ExportCalendar)),pluginID&&pluginID!==PluginID.Drive||this.updatePluginOptionStatus(PluginID.Drive,PluginSettingsID.Drive.WriteAccess),pluginID&&pluginID!==PluginID.Gmail||this.updateGmailInfo(),this.enableOfflineAuth.set(g.settings.get(Settings.enableOfflineAuth))},calendarComparator:function calendarComparatorFn(a,b){return a.summary.localeCompare(b.summary)},updateGmailInfo:function updateGmailInfoFn(){var pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);pluginGmail.getTotalMessageCount(function(count){this.GmailNumTotal.set(count)}.bind(this)),pluginGmail.getSyncdMessageCount(function(count){this.GmailNumSyncd.set(count)}.bind(this)),this.GmailSyncAccounts.set(pluginGmail.getSyncAccounts())},updateCalendarList:function updateCalendarListFn(){if(g.vmMain.pluginManager.isAuthorized(PluginID.GCalendar)){var pluginGCalendar=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar);this.GCalendarListLoading.set(!0),pluginGCalendar.loadRemoteAPIs(function(){pluginGCalendar.getFullCalendarList(function(calendars){this.GCalendarListLoading.set(!1,!1),calendars?(calendars.sort(this.calendarComparator),this.GCalendarsAvailable.set(calendars),this.GCalendarListFailure.set(!1)):this.GCalendarListFailure.set(!0)}.bind(this))}.bind(this))}},getEnabledPlugins:function getEnabledPluginsFn(){var en=this._pluginEnabledObservables;return Object.keys(en).filter(function(value){return en[value].get()})},getPluginEnabledObservable:function getPluginEnabledObservableFn(id){return this._pluginEnabledObservables[id]},getPluginOptionObservable:function getPluginOptionObservableFn(id,option){return this._pluginOptionObservables[id][option]},getPluginOptions:function getPluginOptionsFn(id){return this._pluginOptionObservables[id]},isPluginAnOption:function isPluginAnOptionFn(id){return id===PluginID.Mailbird?platform.embed===EmbedApps.Mailbird:this.pluginsAvailable.indexOf(id)>=0},updatePluginStatus:function updatePluginStatusFn(pluginID,status,notify){this._pluginEnabledObservables[pluginID]?this._pluginEnabledObservables[pluginID].set(status,notify):this._pluginEnabledObservables[pluginID]=new Observable(status)},updatePluginOptionStatus:function updatePluginOptionStatusFn(pluginID,option,isArray){var status=g.vmMain.pluginManager.getSetting(pluginID,option);this._pluginOptionObservables[pluginID]||(this._pluginOptionObservables[pluginID]={}),this._pluginOptionObservables[pluginID][option]?this._pluginOptionObservables[pluginID][option].set(status||isArray&&[]):this._pluginOptionObservables[pluginID][option]=isArray?new ObservableArray(status):new Observable(status)},onFailedAuthenticate:function onFailedAuthenticateFn(pluginID){g.toasts.pushMessage({text:"We failed to successfully authenticate you for "+pluginID+", please try again.",actionText:"OKAY"})},enablePlugins:function enablePluginsFn(arr,useOffline,cb){var scopes=arr.map(function(p){var id=p.id,plugin=g.vmMain.pluginManager.getPlugin(p.id);return plugin?id===PluginID.Drive?plugin.googleScopes(p.shared):plugin.googleScopes():id===PluginID.Contacts?[GScope.Contacts]:void 0}).reduce(function(pre,cur){return pre.concat(cur)},[]);if(scopes&&scopes.length>0){var handleAuthentication=function(token){token&&!token.error?(this.refresh(),useOffline&&(this.enableOfflineAuth.set(!0),g.settings.set(Settings.enableOfflineAuth,!0)),arr.map(function(p){if(p.id===PluginID.Contacts)this.enableSyncContacts();else{var plugin=g.vmMain.pluginManager.getPlugin(p.id);g.vmMain.pluginManager.onPluginAuthorized(plugin,!0),p.id===PluginID.Drive&&p.shared&&plugin.setSetting(PluginSettingsID.Drive.WriteAccess,!0)}}.bind(this)),cb(!0)):cb(!1)}.bind(this);useOffline?goog.runAuthenticateOffline(scopes,handleAuthentication):goog.runAuthenticate(scopes,!1,!1,handleAuthentication)}else this.enableOfflineAuth.set(!0),g.settings.set(Settings.enableOfflineAuth,!0),cb(!0)},enablePlugin:function enablePluginFn(pluginID){var obs=this._pluginEnabledObservables[pluginID];g.vmMain.pluginManager.authorizePlugin(pluginID,this.enableOfflineAuth.get(),function(success){success?(obs.set(!0),this.refresh(pluginID),g.sendEvent(pluginID,"PluginEnabled")):(this.onFailedAuthenticate(pluginID),g.sendEvent(pluginID,"PluginEnableFailed"))}.bind(this))},togglePlugin:function togglePluginFn(pluginID){var obs=this._pluginEnabledObservables[pluginID],enabled=!obs.get();pluginID===PluginID.Contacts?enabled?this.enableSyncContacts():(g.sendEvent("Settings","DisableContacts"),goog.loadedContacts=!1,g.settings.set(Settings.syncContacts,!1),d.clearContacts(),obs.set(!1)):enabled?this.enablePlugin(pluginID):g.vmMain.pluginManager.deauthorizePlugin(pluginID,function(){obs.set(!1),g.sendEvent(pluginID,"PluginDisabled")}.bind(this))},togglePluginOption:function togglePluginOptionFn(pluginID,option){var obs=this._pluginOptionObservables[pluginID][option],enabled=!obs.get();g.vmMain.pluginManager.setSetting(pluginID,option,enabled),enabled?g.vmMain.pluginManager.authorizePlugin(pluginID,this.enableOfflineAuth.get(),function(success){success?(g.vmMain.pluginManager.onAuthorizedSetting(pluginID,option,enabled),obs.set(!0),g.sendEvent(pluginID,"OptionEnabled_"+option)):(this.onFailedAuthenticate(option),g.vmMain.pluginManager.setSetting(pluginID,option,!enabled),g.sendEvent(pluginID,"OptionEnableFailed_"+option))}.bind(this)):(obs.set(!1),g.sendEvent(pluginID,"OptionDisabled_"+option))},setPluginOption:function setPluginOptionFn(pluginID,option,value,requireAuth,cb){var obs=this._pluginOptionObservables[pluginID][option],oldValue=obs.get();g.vmMain.pluginManager.setSetting(pluginID,option,value),value&&requireAuth?g.vmMain.pluginManager.authorizePlugin(pluginID,this.enableOfflineAuth.get(),function(success){success?(g.vmMain.pluginManager.onAuthorizedSetting(pluginID,option,value),obs.set(value),g.sendEvent(pluginID,"OptionSet_"+option+"_"+value),cb&&cb(!0)):(this.onFailedAuthenticate(option),g.vmMain.pluginManager.setSetting(pluginID,option,oldValue),g.sendEvent(pluginID,"OptionEnableFailed_"+option+"_"+value),cb&&cb(!1))}.bind(this)):(obs.set(value),g.sendEvent(pluginID,"OptionSet_"+option+"_"+value),cb&&cb(!0))},toggleOfflineFeatures:function toggleOfflineFeaturesFn(newValue,cb){var oldValue=this.enableOfflineAuth.get();if(newValue){var enabledPlugins=this.getEnabledPlugins(),pluginData=enabledPlugins.map(function(id){return id===PluginID.Drive?{id:id,shared:this.getPluginOptionObservable(id,PluginSettingsID.Drive.WriteAccess).get()}:{id:id}}.bind(this));this.enablePlugins(pluginData,!0,function(success){success?(g.settings.set(Settings.enableOfflineAuth,newValue),g.sendEvent("OfflineAccess",!0)):(g.toasts.pushMessage({text:"We failed to successfully authenticate you for offline access.",actionText:"OKAY"}),g.sendEvent("OfflineAccessFailed",!0),this.enableOfflineAuth.set(oldValue),g.settings.set(Settings.enableOfflineAuth,oldValue)),cb&&cb(success)}.bind(this))}else this.enableOfflineAuth.set(!1),g.settings.set(Settings.enableOfflineAuth,newValue),g.sendEvent("OfflineAccess",!1)},enableSyncContacts:function enableSyncContactsFn(handler){function handleContactsLoaded(numContacts){0>numContacts?(g.toasts.pushMessage({text:"There was an error syncing your contacts. Please try again.",actionText:"SYNC",action:function actionFn(){this.enableSyncContacts(handler)}.bind(this)}),handler&&handler(!1)):numContacts>0&&(g.vmMain.parseSubtree(g.vmMain.root(),ChangeType.Auto),handler&&handler(!0))}g.sendEvent("Settings","EnableContacts"),goog.runAuthenticate([GScope.Contacts],!1,!1,function(token){token&&!token.error?(g.settings.set(Settings.syncContacts,!0),goog.loadContacts(handleContactsLoaded.bind(this)),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SyncContacts}),this._pluginEnabledObservables[PluginID.Contacts].set(!0),g.settings.set(Settings.syncContacts,!0)):(this._pluginEnabledObservables[PluginID.Contacts].set(!1),g.settings.set(Settings.syncContacts,!1),g.toasts.pushMessage({text:"To sync your contacts we need permission to access them. Please try again.",actionText:"SYNC",action:function actionFn(){this.enableSyncContacts(handler)}.bind(this)}),handler&&handler(!1))}.bind(this))},onTapRefreshContacts:function onTapRefreshContactsFn(e,cb){var isLoading=!1;return this.isRefreshingContacts.get()||(this.isRefreshingContacts.set(!0),isLoading=goog.refreshContacts(function(success){this.isRefreshingContacts.set(!1),cb&&cb()}.bind(this)),g.sendEvent("Menu","RefreshContacts")),isLoading},onAllDayTimeValid:function onAllDayTimeValidFn(value){this.isAllDayTimeValid(value),value&&this.datesAllDayTime(g.element("settings-allday").value)},addCalendar:function addCalendarFn(name){var pluginGCalendar=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar);this.GCalendarListLoading.set(!0),pluginGCalendar.createCalendar(name,function(calendarInfo){this.GCalendarListLoading.set(!1),calendarInfo?this.updateCalendarList():this.GCalendarAddFailure.set(!0)}.bind(this))},notifySyncError:function notifySyncErrorFn(syncFailureCalendars){this.GCalendarSyncErrors.set(syncFailureCalendars||[])}},new PluginSettings}),define("plugins/Plugin_GCalendar",["globals","util","platform","Constants","Sel","goog","gdata","RepeatDate","VMPlugin","International","PluginSettings","AccountManager","Hotkeys","tracker"],function(g,util,platform,C,Sel,goog,gdata,RepeatDate,VMPlugin,International,PS,AccountManager,Hotkeys,tracker){function Plugin_GCalendar(){this._super.constructor.call(this,PluginID.GCalendar,"Calendar"),this.pluginMargin=4,this.pluginPadding=14,this._numEntriesSyncd=0,this._calendarList={},this.registerSetting("WriteAccess","writeAccess",!0),this.registerSetting("ImportCalendars","importCalendars",!0),this.registerSetting("ExportCalendar","exportCalendar",!0),this.registerSetting("WeeksPast","weeksPast",!0,1),this.registerSetting("WeeksFuture","weeksFuture",!0,4),this._updateSyncTimes(),Hotkeys.registerHotkey(KeyCode.C,C.Primary.Never,C.Shift.No,this.hotkeyCreateEvent.bind(this)),this._eventCache=this.registerLocalCache("EventCache",StorageType.IndexedDB,!0),this.declareProperty("isInvalid",PluginLoad.Runtime,!0,!1),g.isDemoMode()?this.declareProperty("calendarID",PluginLoad.Preview|PluginLoad.Full,!0,"me"):this.declareProperty("calendarID",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("summary",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("status",PluginLoad.Preview|PluginLoad.Full,!0,"confirmed"),this.declareProperty("startTime",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("endTime",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("allDayEvent",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("recurringEventId",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("eid",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("isComplete",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("isArchived",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("isStarred",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("priority",PluginLoad.Preview|PluginLoad.Full,!0,VMLIFlag.None),this.declareProperty("locked",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("modifiedOffline",PluginLoad.Full,!0,!1),this.declareProperty("source",PluginLoad.Full,!0),this.declareProperty("location",PluginLoad.Full,!0),this.declareProperty("description",PluginLoad.Full,!0),this.declareProperty("attendees",PluginLoad.Full,!0),this.declareProperty("organizer",PluginLoad.Full,!0),this.useRenderer(PluginRenderTypes.AgendaEntry,PluginRenderers.CalendarEvent),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.CalendarEvent),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.CalendarEvent),this.useRenderer(PluginRenderTypes.AutocompleteText,PluginRenderers.CalendarEvent),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.CalendarEvent),util.forceBind("_flushEventUpdateQueue",this),this._pendingCreates={},this._syncingOfflineChanges=!1,this._hasInitializedTasks=!1,this._purgeOldDataTimeout=void 0,this._eventUpdateTimeout=void 0,this._eventUpdateQueue={}}var EventUpdateQueueDelay=2e3,requestFieldsEvent="id,description,end,location,start,status,summary,htmlLink,recurrence,attendees,source,locked,extendedProperties",requestFieldsCalendar="",EventUpdateFields=["description","end","location","start","status","summary","recurrence","attendees","extendedProperties"],PluginModals={EventView:"EventView"},CacheMetadata={SyncTokens:"syncTokens",CalendarList:"calendarList"},CalendarPropertiesPrefix="MDCProp_",CalendarProperties={IsComplete:"isComplete",Priority:"priority",IsStarred:"isStarred",IsArchived:"isArchived"},RequestType={Settings:1,EventSync:2,PropUpdate:3,CalendarList:4,Colors:5,SingleEvent:6,CreateEvent:7,EventUpdate:8,OfflineUpdate:9,DeleteEvent:10,CreateCalendar:11,SummaryUpdate:12},DefaultEventDuration=36e5,DefaultEventDurationText="1hr",Plugin_GCalendarFns={getType:function getTypeFn(){return C.PluginType.Calendar},_attachMetadataFields:function _attachMetadataFieldsFn(){return["modifiedOffline"]},allowRemoteRequests:function allowRemoteRequestsFn(){return!0},useItemStore:function useItemStoreFn(){return"Google Calendar"},itemStoreOptions:function itemStoreOptionsFn(){var enabledFilters=ItemStoreFilter.Dates;return{enabledFilters:enabledFilters}},supportOfflineLoad:function supportOfflineLoadFn(){return!0},supportOfflineCache:function supportOfflineCacheFn(){return!0},usesPreviewCache:function usesPreviewCacheFn(){return!0},googleScopes:function googleScopesFn(){return this.getSetting(this.Settings.WriteAccess)?[GScope.Calendar]:[GScope.CalendarRO]},getDependencies:function getDependenciesFn(){return[PluginDependency.LocalLoaded,PluginDependency.PremiumSub,PluginDependency.CalendarAPI,PluginDependency.GoogleLogin]},onDependencyLoaded:function onDependencyLoadedFn(dep,data){if(this._super.onDependencyLoaded.call(this,dep,data),dep===PluginDependency.GoogleLogin){try{g.PAssert(4662,g.isArray(data),"Must provide a valid scope array")}catch(PERR){g.reportError(PERR)}this.getSetting(this.Settings.IsEnabled)&&(data.indexOf(GScope.CalendarRO)<0&&data.indexOf(GScope.Calendar)<0&&(g.toasts.pushMessage(MessageID.LostPermission),AccountManager.notifyUnauthorizedAccount("me",[GScope.CalendarRO,GScope.Calendar],"Missing Scope"),this.setSetting(this.Settings.IsEnabled,!1)),this.getSetting(this.Settings.WriteAccess)&&data.indexOf(GScope.Calendar)<0&&(g.toasts.pushMessage(MessageID.LostPermission),AccountManager.notifyUnauthorizedAccount("me",[GScope.Calendar],"Missing Write Scope"),this.setSetting(this.Settings.WriteAccess,!1)))}},isDependencyLoaded:function isDependencyLoadedFn(dep,data){var isLoaded=!1;switch(dep){case PluginDependency.GoogleLogin:data&&(data.indexOf(GScope.CalendarRO)>=0||data.indexOf(GScope.Calendar)>=0)&&(isLoaded=!0);break;default:isLoaded=!0}return isLoaded},getBlockedText:function getBlockedTextFn(attach){return""},loadRemoteAPIs:function loadRemoteAPIsFn(cb){this.areRemoteAPIsLoaded()?cb&&cb():g.loadGoogleAPI("calendar","v3",function(){try{g.PAssert(4663,this.areRemoteAPIsLoaded(),"Must have loaded calendar remote APIs")}catch(PERR){g.reportError(PERR)}g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.CalendarAPI),cb&&cb()}.bind(this))},computeBatchGroupID:function computeBatchGroupIDFn(req){var batchID="me";return req.data&&req.data.calendarId&&(batchID=req.data.calendarId),batchID},areRemoteAPIsLoaded:function areRemoteAPIsLoadedFn(){return window.gapi&&window.gapi.client&&window.gapi.client.calendar},_serializeDate:function _serializeDateFn(value){var outValue;return outValue=value instanceof Date?value.toISOString():g.isNumber(value)?new Date(value).toISOString():value},compactCacheField:function compactCacheFieldFn(entry,key){var outValue;switch(key){case"startTime":case"endTime":outValue=this._serializeDate(entry[key]);break;default:outValue=entry[key]}return outValue},_updateSyncTimes:function _updateSyncTimesFn(){var weeksPast=-this.getSetting(this.Settings.WeeksPast),weeksFuture=this.getSetting(this.Settings.WeeksFuture);try{g.PAssert(4664,0>=weeksPast&&weeksPast>=-7,"Must have valid date range for start display date: ",weeksPast)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4665,weeksFuture>=0&&12>=weeksFuture,"Must have valid date range for end display date",weeksFuture)}catch(PERR){g.reportError(PERR)}this._minSyncStartTime=(new Date).addWeeks(-7),this._maxSyncStartTime=(new Date).addWeeks(20),this._syncTokenDuration=g.weeks(10),this._minDisplayStartTime=(new Date).addWeeks(weeksPast),this._maxDisplayStartTime=(new Date).addWeeks(weeksFuture);try{g.PAssert(4666,this._minDisplayStartTime.isBefore(this._maxDisplayStartTime),"Must have a valid start display date")}catch(PERR){g.reportError(PERR)}},_shouldDisplayTime:function _shouldDisplayTimeFn(startDate,endDate){return endDate>=this._minDisplayStartTime&&endDate<=this._maxDisplayStartTime||startDate>=this._minDisplayStartTime&&startDate<=this._maxDisplayStartTime},_filterDates:function _filterDatesFn(field,min,max){return function(entry){var dt=new Date(entry[field]);return dt>=min&&max>=dt}},_purgeOldData:function _purgeOldDataFn(cb){this._eventCache.onCacheReady(function(){this._eventCache.getFilterEntries(this._filterDates("startTime",new Date(0),this._minDisplayStartTime),function(entries){if(entries){log("Removing "+entries.length+" old calendar entries.");for(var i=0;i<entries.length;++i)this._eventCache.removeEntry(entries[i].id);cb&&cb(!0)}else cb&&cb(!1)}.bind(this))}.bind(this))},_offlineLoad:function _offlineLoadFn(){this._eventCache.onCacheMetadataReady(function(){this._eventCache.getMetadata(CacheMetadata.CalendarList,function(calendarList){g.isEmpty(this._calendarList)&&(this._calendarList=calendarList||{})}.bind(this))}.bind(this)),this._eventCache.onCacheReady(function(){this._eventCache.getFilterEntries(this._filterDates("startTime",this._minDisplayStartTime,this._maxDisplayStartTime),function(entries){g.vmMain.beginUpdateItems();for(var itemStore=this.getDefaultItemStore(),parent=itemStore.getRoot(),i=0;i<entries.length;++i){var entry=entries[i],cacheEntry=this.createEntryFromLocal(entry.id,entry);this.cacheData(cacheEntry.id,cacheEntry);try{g.PAssert(4667,!itemStore.hasItem(cacheEntry.id),"Load should never try to create a VMLI that has already been created")}catch(PERR){g.reportError(PERR)}if("cancelled"!==cacheEntry.status&&!cacheEntry.isArchived){if(cacheEntry.source){var urlInfo=g.vmMain.pluginManager.parseEmailURL(cacheEntry.source.url);if(urlInfo.plugin&&!urlInfo.plugin.hasCacheData(urlInfo.threadID)){var emailEntry=urlInfo.plugin.createEntryFromLocal(urlInfo.threadID,{accountID:urlInfo.accountID,subject:cacheEntry.source.title});urlInfo.plugin.cacheData(urlInfo.threadID,emailEntry)}}var vmli=this._createItem(itemStore,cacheEntry,parent.id);parent.insertItem(vmli)
}}g.vmMain.paneManager.runForEachPane(function(pane){pane.search.update(!1)}),g.vmMain.commitUpdateItems()}.bind(this))}.bind(this))},_load:function _loadFn(){g.isDemoMode()||(this.createRecurringTask("CalendarListSync",{delay:g.hours(2),minDelay:g.hours(1),runOnCreate:!0,pauseWhileIdle:!0,task:this.runCalendarListSync.bind(this)}),this.createRecurringTask("CalendarEventSync",{delay:g.minutes(15),minDelay:g.minutes(2),runOnCreate:!0,pauseWhileIdle:!0,minDelayOnResume:!0,task:this.runCalendarSync.bind(this)}),this._hasInitializedTasks=!0)},goOnline:function goOnlineFn(){if(this._hasInitializedTasks){var syncEventTask=this.getRecurringTask("CalendarEventSync");syncEventTask.forceUpdate()}},handleTapStart:function handleTapStartFn(vmli,id,e){return platform.mobile&&e.preventDefault(),!0},handleTapClick:function handleTapClickFn(vmli,id,e){var item=this.getCacheData(id);if(item){var attach=this.getAttachment(id);if(platform.mobile){var html=this.createDisplayElement(attach);e.preventDefault(),g.preventClick(),g.menus.openMenuExternalApp(html,function(){var url;item.eid&&(url="https://www.google.com/calendar/event?eid="+item.eid),url&&g.openUrl(url,e)}.bind(this)),this.sendEvent("Tap_OpenGCalendarMobile")}else if(g.isDemoMode())g.toasts.pushMessage(MessageID.DemoPluginClick);else{var url;item.eid&&(url="https://www.google.com/calendar/event?eid="+item.eid),url&&g.openUrl(url,e),this.sendEvent("Tap_OpenGCalendarDesktop")}return!0}return!1},handleRightClick:function handleRightClickFn(){return g.element("contextMenuItem_Calendar")},getDateContextMenu:function getDateContextMenuFn(item){var contextMenu;return g.isDateSoft(item.dateText)||item.hasPluginAttachment(this.id)||(contextMenu=g.element("contextMenuItem_Date")),contextMenu},_durationToString:function _durationToStringFn(durationMS){var minutes,hours,days;minutes=durationMS/6e4,minutes>0&&(hours=Math.floor(minutes/60),minutes-=60*hours,hours>0&&(days=Math.floor(hours/24),hours-=24*days));var durationStr="";return days>0&&(durationStr+=days+"d "),hours>0&&(durationStr+=hours+"h "),minutes>0&&(durationStr+=minutes+"m "),durationStr.trim()},_createItemDateText:function _createItemDateTextFn(entry){var dateText;return dateText=entry.startTime.toString(entry.allDayEvent?International.getFormat(DFormat.MonthDayYear):International.getFormat(DFormat.DayYearTime))},_createItemDurationText:function _createItemDurationTextFn(entry){var durationText,duration=entry.endTime-entry.startTime;return durationText=entry.allDayEvent?duration>g.days(1)?"until "+entry.endTime.toString(International.getFormat(DFormat.MonthDayYear)):"":this._durationToString(duration)},_createItemSummaryText:function _createItemSummaryTextFn(entry){var summary;if(entry.source&&entry.source.url){var urlInfo=g.vmMain.pluginManager.parseEmailURL(entry.source.url);urlInfo.plugin&&(summary=urlInfo.plugin._getTextForItem({id:urlInfo.threadID}))}return summary||(summary=entry.summary?entry.summary.replace(/\u2000/g,""):""),summary},_createItemText:function _createItemTextFn(entry){try{g.PAssert(4668,entry,"Must specify a valid attachment")}catch(PERR){g.reportError(PERR)}var outText,startTimeStr=this._createItemDateText(entry),durationStr=this._createItemDurationText(entry),summaryStr=this._createItemSummaryText(entry);return outText=this._assembleItemText(entry,startTimeStr,durationStr,summaryStr)},_assembleItemText:function _assembleItemTextFn(entry,startTimeStr,durationStr,summaryStr){return summaryStr+" "+DatePrefix+startTimeStr+" "+(durationStr?durationStr+" ":"")+this._getTextForItem(entry)},_createItem:function _createItemFn(itemStore,cacheEntry,parentID){var dateCompleted="false"!==cacheEntry.isComplete&&"true"!==cacheEntry.isComplete?cacheEntry.isComplete:void 0,createData={date:cacheEntry.startTime.getTime(),dateText:this._createItemDateText(cacheEntry),priority:cacheEntry.priority,isComplete:!!dateCompleted,isArchived:cacheEntry.isArchived,dateCompleted:dateCompleted,isStarred:cacheEntry.isStarred,duration:void 0,durationText:void 0};return cacheEntry.allDayEvent||(createData.duration=cacheEntry.endTime-cacheEntry.startTime,createData.durationText=this._createItemDurationText(cacheEntry)),itemStore.createItem(cacheEntry.id,this._createItemText(cacheEntry),parentID,createData,ChangeType.Auto)},getRemoteAttachmentData:function getRemoteAttachmentDataFn(attach,requestedState){this.loadRemoteAPIs(),gdata.requestNotifyWhenAvailable(function(){try{g.PAssert(4669,attach.hasField("calendarID"),"Must have a valid calendarID for an event")}catch(PERR){g.reportError(PERR)}if(attach.hasField("calendarID")){var calendarID=attach.getField("calendarID"),requestFn=["gapi","client","calendar","events","get"],requestData={eventId:attach.id,calendarId:calendarID},successCB=function(result){try{g.PAssert(4670,!result||result.id===attach.id,"If valid result, attachment should match remote event ID")}catch(PERR){g.reportError(PERR)}if(result){var cacheEntry=this._addRemoteEntry(calendarID,result);this._eventCache.cacheEntry(result.id,this.serializeExternalData(cacheEntry))}}.bind(this),failureCB=function(){attach.notifyDataRequestFailed()};this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,attach,RequestType.SingleEvent)}else attach.updateField("status","cancelled")}.bind(this))},_createRemoteEntry:function _createRemoteEntryFn(calendarID,info){var startTime,endTime,allDayEvent=!1,eid;try{g.PAssert(4671,info.start,"Must always have valid start data")}catch(PERR){g.reportError(PERR)}if(info.start.dateTime){try{g.PAssert(4672,info.end.dateTime,"End date format should always match start")}catch(PERR){g.reportError(PERR)}startTime=new Date(info.start.dateTime),endTime=new Date(info.end.dateTime)}else if(info.start.date){try{g.PAssert(4673,info.end.date,"End date format should always match start")}catch(PERR){g.reportError(PERR)}var startParts=info.start.date.split("-"),endParts=info.end.date.split("-");startTime=new Date(startParts[0],startParts[1]-1,startParts[2]),endTime=new Date(endParts[0],endParts[1]-1,endParts[2]),allDayEvent=!0}info.htmlLink&&(eid=info.htmlLink.split("?eid=")[1]);var dateCompleted=this._getRemoteProperty(info,CalendarProperties.IsComplete),entry={id:info.id,calendarID:calendarID,status:info.status,summary:info.summary,startTime:startTime,endTime:endTime,allDayEvent:allDayEvent,recurringEventId:info.recurringEventId,eid:eid,isComplete:dateCompleted,isArchived:this._getRemoteProperty(info,CalendarProperties.IsArchived),isStarred:this._getRemoteProperty(info,CalendarProperties.IsStarred),priority:this._getRemoteProperty(info,CalendarProperties.Priority),locked:info.locked||!1,attendees:info.attendees,location:info.location,description:info.description,organizer:info.organizer?info.organizer.displayName||info.organizer.email||info.organizer.id:"Unknown"};return info.source&&(entry.source={title:info.source.title,url:info.source.url}),entry},_addRemoteEntry:function _addRemoteEntryFn(calendarID,info){var entry=this._createRemoteEntry(calendarID,info);return this.cacheData(entry.id,entry),entry},createEntryFromLocal:function createEntryFromLocalFn(id,info){return info.startTime=info.startTime?new Date(info.startTime):void 0,info.endTime=info.endTime?new Date(info.endTime):void 0,info},_notifyFailedRequest:function _notifyFailedRequestFn(result,calendarID){try{g.PAssert(4674,this.hasDependencyBeenLoaded(PluginDependency.GoogleLogin),"Must have properly loaded google apis before making remote requests")}catch(PERR){g.reportError(PERR)}result&&result.error&&(result.error.code===C.HTTPStatusCode.Unauthorized?(g.toasts.pushMessage(MessageID.LostPermission),AccountManager.notifyUnauthorizedAccount("me",[GScope.CalendarRO,GScope.Calendar],result.error.message)):result.error.code>=400&&result.error.code<500&&g.reportError(new Error("Failed GCalendar request: "+result.error.code),result))},_getRemoteProperty:function _getRemotePropertyFn(info,prop){try{g.PAssert(4675,info,"Must provide valid event info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4676,prop,"Must provide valid remote prop")}catch(PERR){g.reportError(PERR)}var value;return info.extendedProperties&&info.extendedProperties.private&&(value=info.extendedProperties.private[CalendarPropertiesPrefix+prop]),value},_updateAttachFromData:function _updateAttachFromDataFn(attach,info){var updatedFields=[];for(var field in info)info.hasOwnProperty(field)&&attach.isFieldDefined(field)&&(attach.updateField(field,info[field]),updatedFields.push(field));return updatedFields},_runRemoteUpdate:function _runRemoteUpdateFn(attach,fields,fn,cb){try{g.PAssert(4677,this.getSetting(this.Settings.WriteAccess),"Should not be calling _runRemoteUpdate without proper permission")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4678,!attach.getField("locked"),"Should never try to modify an event that is locked")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4679,g.isBoolean(fields)||g.isArray(fields),"Must specify a boolean or list of fields for modified value")}catch(PERR){g.reportError(PERR)}attach.updateField("modifiedOffline",fields),this._eventCache.cacheEntry(attach.id,this.serializeExternalData(this.getCacheData(attach.id)),function(updateSuccess){updateSuccess?fn(function(remoteSuccess,remoteResult){remoteSuccess?(attach.updateField("modifiedOffline",!1),this._eventCache.cacheEntry(attach.id,this.serializeExternalData(this.getCacheData(attach.id)),function(flushSuccess){try{g.PAssert(4680,flushSuccess,"Must always be able to write the modifiedOffline flag")}catch(PERR){g.reportError(PERR)}cb(!0)})):cb(!1,remoteResult)}.bind(this)):cb(!1)}.bind(this))},_updateEvent:function _updateEventFn(attach,info,requestType,cb){var updatedFields=this._updateAttachFromData(attach,info),updateFn=function(updateCB){this._updateRemoteEvent(attach.getField("calendarID"),attach.id,info,requestType,updateCB)}.bind(this);this._runRemoteUpdate(attach,updatedFields,updateFn,cb)},_updateRemoteEvent:function _updateRemoteEventFn(calendarID,eventID,info,requestType,cb){try{g.PAssert(4681,this.getSetting(this.Settings.WriteAccess),"Should not be calling _updateRemoteEvent without proper permission")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","calendar","events","patch"],requestData={calendarId:calendarID,eventId:eventID,resource:this._createEventUpdateInfo(info)},successCB=function(){cb(!0)},failureCB=function(result){result&&result.error&&result.error.code===C.HTTPStatusCode.NotFound?(this._eventCache.removeEntry(eventID),cb(!0)):(cb(!1,result),this._notifyFailedRequest(result,calendarID))}.bind(this);this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.EventUpdate||requestType)},_updateRemoteProperty:function _updateRemotePropertyFn(attach,prop,value,cb){attach.updateField(prop,value);var propObj={};propObj[CalendarPropertiesPrefix+prop]=value;var info={extendedProperties:{"private":propObj}},updateFn=function(updateCB){this._updateRemoteEvent(attach.getField("calendarID"),attach.id,info,RequestType.PropUpdate,updateCB)}.bind(this);this._runRemoteUpdate(attach,["extendedProperties"],updateFn,cb)},_getStartEndFromDateInfo:function _getStartEndFromDateInfoFn(date,duration){var startTime,endTime,allDayEvent=!1,recurrence;if(date instanceof Date)date.hasTimeOfDay()||(allDayEvent=!0),startTime=date,endTime=date.clone().addMilliseconds(duration);else if(date instanceof RepeatDate)startTime=date.getStartDate(),endTime=date.getEndDate(),recurrence=date.toICal();else try{g.PAssert(4682,!1,"Should always have a valid date")}catch(PERR){g.reportError(PERR)}return{startTime:startTime,endTime:endTime,allDayEvent:allDayEvent,recurrence:recurrence}},deleteCalendarEventForItem:function deleteCalendarEventForItemFn(item,attach,localDoneCB,remoteDoneCB){this.sendEvent("DeleteEvent");var updateFn=function(updateCB){var text=item.getCalendarRawText().replace(attach.getEmbedString(),"");item.setText(text,!0,ChangeType.Local),attach.isLocalOnlyAttachment()?(attach.updateField("status","cancelled"),updateCB(!0)):this.deleteCalendarEvent(attach,updateCB),localDoneCB()}.bind(this);this._runRemoteUpdate(attach,["status"],updateFn,remoteDoneCB)},deleteCalendarEvent:function deleteCalendarEventFn(attach,cb){this.loadRemoteAPIs();var requestFn=["gapi","client","calendar","events","delete"],requestData={calendarId:attach.getField("calendarID"),eventId:attach.id},onSuccessDelete=function(){var itemStore=this.getDefaultItemStore();attach.forEachItem(itemStore,function(item){item.parent()&&(item.parent().removeChild(item),item.parent(void 0))}),attach.updateField("status","cancelled"),this._eventCache.cacheEntry(attach.id,this.serializeExternalData(attach.getData())),cb(!0)}.bind(this),successCB=function(){onSuccessDelete()},failureCB=function(result){result&&result.error&&result.error.code===C.HTTPStatusCode.Gone?onSuccessDelete():(cb(!1,result),this._notifyFailedRequest(result,attach.getField("calendarID")))}.bind(this);this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.DeleteEvent)},forceRemoteEventSync:function forceRemoteEventSyncFn(){if(!g.isDemoMode()&&this._hasInitializedTasks){if(this.hasRecurringTask("CalendarEventSync")){var syncEventTask=this.getRecurringTask("CalendarEventSync");syncEventTask.forceUpdate()}if(this.hasRecurringTask("CalendarListSync")){var syncListTask=this.getRecurringTask("CalendarListSync");syncListTask.forceUpdate()}}},getDefaultExportCalendarID:function getDefaultExportCalendarIDFn(){var calendarID=this.getSetting(this.Settings.ExportCalendar);return calendarID},createEventForEmail:function createEventForEmailFn(subject,url,date,duration,cb){try{g.PAssert(4683,g.isString(subject),"Must provide a valid subject")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4684,g.isString(url),"Must provide a valid email url")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4685,g.isDateValid(date),"Must provide a valid schedule date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4686,g.isNumber(duration),"Must provide a valid event duration")}catch(PERR){g.reportError(PERR)}var calendarID=this.getDefaultExportCalendarID();if(calendarID){this.sendEvent("AddEmailEvent");var info={duration:duration,summary:subject,date:date,source:{title:subject,url:url}};this.createNewCalendarEvent(calendarID,info,function(cacheEntry){try{g.PAssert(4687,cacheEntry,"Must have created a valid local cache entry for email event")}catch(PERR){g.reportError(PERR)}if(cacheEntry){g.vmMain.beginUpdateItems();var itemStore=this.getDefaultItemStore(),parent=itemStore.getRoot(),item=this._createItem(itemStore,cacheEntry,parent.id);parent.insertItem(item),g.vmMain.commitUpdateItems()}}.bind(this),cb)}},createEventForItem:function createEventForItemFn(item){if(!g.isDateSoft(item.dateText)&&!item.hasPluginAttachment(this.id)&&(item.date()||item.repeatDate())){var calendarID=this.getDefaultExportCalendarID();calendarID?item.date()?(this.sendEvent("AddSingleEvent"),this.newCalendarEventForItem(calendarID,item,function(success,errorResult){success||(errorResult&&errorResult.error&&-1===errorResult.error.code?tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddToGCal,data:{item:item}}):g.toasts.pushMessage({text:"There was an error adding the event to your Google Calendar.",action:MessageAction.Okay}))})):(this.sendEvent("AddRepeatEvent"),g.toasts.pushMessage({text:"Moo.do does not currently support adding repeated dates to Google Calendar.",action:MessageAction.Okay})):g.toasts.pushMessage({text:"Please select a valid Google Calendar to save your events to.",action:MessageAction.OpenSettings})}},hotkeyCreateEvent:function hotkeyCreateEventFn(){this.isActive()&&!this.isPluginBlocked()&&g.vmMain.applyToSelection(this.createEventForItem.bind(this))},newCalendarEventForItem:function newCalendarEventForItemFn(calendarID,item,cb){try{g.PAssert(4688,item,"Must provide a valid item")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4689,item.date()||item.repeatDate(),"Item must have a valid date")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4690,!item.hasPluginAttachment(PluginID.GCalendar),"Must not already have a valid calendar attachment associated with the item")}catch(PERR){g.reportError(PERR)}var isValid=!0,duration=item.getDuration();duration||item.allDayDate()||(duration=DefaultEventDuration);var info={duration:duration,summary:item.getCalendarParsedText()};if(item.date())info.date=item.date();else if(item.repeatDate()){try{g.PAssert(4691,!1,"Repeated dates are not yet supported")}catch(PERR){g.reportError(PERR)}isValid=!1}if(item.hasNote()&&(info.description=item.getNote().getParsedText()),item.hasAttachmentType(C.PluginType.Email)){var emailAttach=item.getAttachmentByType(C.PluginType.Email);info.source={title:emailAttach.getField("subject"),url:emailAttach.getPlugin().createURLForThread(emailAttach)}}isValid?this.createNewCalendarEvent(calendarID,info,function(cacheEntry){if(cacheEntry){var text=item.getCalendarRawText()+" "+DatePrefix+item.getDateText();item.getDurationText()?text+=" "+item.getDurationText():item.allDayDate()||(text+=" "+DefaultEventDurationText),text+=" "+this._getTextForItem(cacheEntry),item.setText(text,!0,ChangeType.Local)}}.bind(this),cb):cb(!1)},createNewCalendarEvent:function createNewCalendarEventFn(calendarID,info,localDoneCB,remoteDoneCB){try{g.PAssert(4692,info,"Must have valid event info passed in")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4693,info.date,"Must have valid date for event")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4694,void 0!==info.duration,"Must have a valid event duration")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4695,info.summary,"Must have a valid event summary")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4696,g.isFunction(localDoneCB),"Must supply a valid local done CB")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4697,g.isFunction(remoteDoneCB),"Must supply a valid remote done CB")}catch(PERR){g.reportError(PERR)}var itemID=g.generateTempId(),dateInfo=this._getStartEndFromDateInfo(info.date,info.duration),itemData={id:itemID,calendarID:calendarID,status:"confirmed",summary:info.summary,source:info.source,description:info.description,startTime:dateInfo.startTime,endTime:dateInfo.endTime,allDayEvent:dateInfo.allDayEvent,recurrence:dateInfo.recurrence,organizer:goog.getCurrentUserEmail(),modifiedOffline:!0};this.cacheData(itemID,itemData),this._eventCache.cacheEntry(itemID,itemData,function(initialSuccess){if(initialSuccess){var updateFn=function(updateCB){this._createRemoteEventFromCacheData(calendarID,itemData,updateCB)}.bind(this),attach=this.getAttachment(itemData.id);this._runRemoteUpdate(attach,!0,updateFn,remoteDoneCB),localDoneCB(itemData)}else localDoneCB(),remoteDoneCB(!1)}.bind(this))},_createRemoteEventFromCacheData:function _createRemoteEventFromCacheDataFn(calendarID,cacheData,cb){this._pendingCreates[cacheData.id]=!0,this._createNewRemoteEvent(calendarID,cacheData,function(result,errorResult){delete this._pendingCreates[cacheData.id];var attach=this.getAttachment(cacheData.id);if(result){var oldID=cacheData.id;this.changeID(attach,attach.id,result.id),this._eventCache.removeEntry(oldID,function(removeSuccess){try{g.PAssert(4698,removeSuccess,"Must always successfully remove the temp cached event: "+cacheData.id)}catch(PERR){g.reportError(PERR)}});var cacheEntry=this._addRemoteEntry(calendarID,result);this._eventCache.cacheEntry(result.id,this.serializeExternalData(cacheEntry),cb),attach.updateField("isInvalid",!1)}else attach.updateField("isInvalid",!0),cb(!1,errorResult)}.bind(this))},_createNewRemoteEvent:function _createNewRemoteEventFn(calendarID,info,cb){try{g.PAssert(4699,info,"Must specify valid event info")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4700,info.startTime instanceof Date,"Must have a valid start time")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4701,info.endTime instanceof Date,"Must have a valid end time")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4702,info.summary,"Must have a valid event title")}catch(PERR){g.reportError(PERR)}this.loadRemoteAPIs();var startInfo,endInfo;info.allDayEvent?(startInfo={date:info.startTime.toString("yyyy-MM-dd")},endInfo={date:info.endTime.toString("yyyy-MM-dd")}):(startInfo={dateTime:info.startTime.toISOString()},endInfo={dateTime:info.endTime.toISOString()});var requestFn=["gapi","client","calendar","events","insert"],requestData={calendarId:calendarID,resource:{start:startInfo,end:endInfo,recurrence:info.recurrence,summary:info.summary,status:info.status,source:info.source}},successCB=function(result){cb(result)},failureCB=function(result){cb(void 0,result),this._notifyFailedRequest(result,calendarID)}.bind(this);this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.CreateEvent)},getReadableCalendarList:function getReadableCalendarListFn(cb){return this._getCalendarList("reader",cb)},getWritableCalendarList:function getWritableCalendarListFn(cb){return this._getCalendarList("writer",cb)},getFullCalendarList:function getFullCalendarListFn(cb){var importCalendars=this.getSetting(this.Settings.ImportCalendars);this.getReadableCalendarList(function(calendarList){if(importCalendars&&calendarList){var missingCals=importCalendars.map(function(calInfo){if(!g.isObject(calInfo))return{id:calInfo,accessRole:"none"};var retData=g.clone(calInfo);return retData.accessRole="none",retData}).filter(function(calInfo){for(var i=0;i<calendarList.length;++i)if(calendarList[i].id===calInfo.id)return!1;return!0});calendarList.pushArray(missingCals)}cb(calendarList)})},createCalendar:function createCalendarFn(title,cb){var requestFn=["gapi","client","calendar","calendars","insert"],requestData={summary:title},successCB=function(calendarInfo){cb(calendarInfo)},failureCB=function(result){cb(),this._notifyFailedRequest(result,void 0)}.bind(this);this._queueRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.CreateCalendar),this.sendEvent("CreateCalendar")},_getCalendarList:function _getCalendarListFn(minAccessRole,cb){var requestFn=["gapi","client","calendar","calendarList","list"],requestData={minAccessRole:minAccessRole},options={getAllPages:!0},successCB=function(result){cb(result)},failureCB=function(result){cb(),this._notifyFailedRequest(result,void 0)}.bind(this);this._queuePagedRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.CalendarList,options)},handleEventUpdate:function handleEventUpdateFn(calendarID,entry){this._numEntriesSyncd++;var itemStore=this.getDefaultItemStore();if("cancelled"===entry.status){if(this._eventCache.removeEntry(entry.id),this.hasCacheData(entry.id)){var attach=this.getAttachment(entry.id);attach.updateField("status","cancelled"),attach.forEachItem(itemStore,function(item){item.parent()&&(item.parent().removeChild(item,ChangeType.Remote),item.parent(void 0))})}}else{var oldData=this.getCacheData(entry.id),cacheEntry=this._createRemoteEntry(calendarID,entry);oldData&&oldData.modifiedOffline&&this._mergeEventData(oldData,cacheEntry),this.cacheData(cacheEntry.id,cacheEntry),this._eventCache.cacheEntry(entry.id,this.serializeExternalData(cacheEntry));var parent=itemStore.getRoot(),attach=this.getAttachment(entry.id);if(this.updateVMLIsFromUpdate(attach,oldData,cacheEntry),!itemStore.hasItem(cacheEntry.id)&&this._shouldDisplayTime(cacheEntry.startTime,cacheEntry.endTime)&&!cacheEntry.isArchived){var vmli=this._createItem(itemStore,cacheEntry,parent.id);parent.insertItem(vmli)}}},_mergeEventData:function _mergeEventDataFn(oldData,newData){try{g.PAssert(4703,oldData.modifiedOffline,"Should only merge events that were locally modified")}catch(PERR){g.reportError(PERR)}var fields=oldData.modifiedOffline;try{g.PAssert(4704,g.isArray(fields),"Should not be receiving an update for an event that was created locally")}catch(PERR){g.reportError(PERR)}for(var i=0;i<fields.length;++i){var field=fields[i];newData[field]=oldData[field]}newData.modifiedOffline=oldData.modifiedOffline},updateVMLIsFromUpdate:function updateVMLIsFromUpdateFn(attach,oldData,newData){try{g.PAssert(4705,attach,"Must provide a valid attachment")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4706,newData,"Must provide valid new data")}catch(PERR){g.reportError(PERR)}if(oldData)attach.forEachItem(void 0,function(item){var hasDiffText=!1,updatedText=item.getParsedText(),newDateText;this.areDatesEqual(oldData.startTime,newData.startTime)||(newDateText=this._createItemDateText(newData),updatedText=updatedText.replace(DatePrefix+item.getDateText(),DatePrefix+newDateText),hasDiffText=!0);var newDurationText;if(oldData.endTime-oldData.startTime!==newData.endTime-newData.startTime){if(newDurationText=this._createItemDurationText(newData),item.getDurationText())updatedText=updatedText.replace(item.getDurationText(),newDurationText);else{var durationPrefix=DatePrefix+(newDateText?newDateText:item.getDateText());updatedText=updatedText.replace(durationPrefix,durationPrefix+" "+newDurationText)}hasDiffText=!0}if(oldData.summary!==newData.summary&&!item.hasAttachmentType(C.PluginType.Email)){var startTimeStr=newDateText?newDateText:item.getDateText(),durationStr=newDurationText?newDurationText:item.getDurationText(),summaryStr=newData.summary?newData.summary.replace(/\u2000/g,""):"";updatedText=this._assembleItemText(newData,startTimeStr,durationStr,summaryStr),hasDiffText=!0}if(hasDiffText){var newParsedText=item.generateSaveText(updatedText);item.setText(newParsedText,!0,ChangeType.Remote)}}.bind(this));else{var itemText=this._createItemText(newData);attach.forEachItem(void 0,function(item){item.setText(itemText,!0,ChangeType.Remote)}.bind(this))}},setSyncToken:function setSyncTokenFn(calendarID,syncToken,cb){try{g.PAssert(4707,g.isString(calendarID),"Must provide a valid calendar ID to clear sync token for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4708,g.isString(syncToken),"Must provide a valid calendar ID to clear sync token for")}catch(PERR){g.reportError(PERR)}this._eventCache.getMetadata(CacheMetadata.SyncTokens,function(syncTokens){syncTokens=syncTokens||{};var validUntil=Date.now()+this._syncTokenDuration;syncTokens[calendarID]={token:syncToken,date:Date.now(),expires:validUntil},this._eventCache.setMetadata(CacheMetadata.SyncTokens,syncTokens,cb)}.bind(this))},clearSyncToken:function clearSyncTokenFn(calendarID,cb){try{g.PAssert(4709,g.isString(calendarID),"Must provide a valid calendar ID to clear sync token for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4710,g.isFunction(cb),"Must provide valid CB function when clearing sync token")}catch(PERR){g.reportError(PERR)}this._eventCache.getMetadata(CacheMetadata.SyncTokens,function(syncTokens){syncTokens?(delete syncTokens[calendarID],this._eventCache.setMetadata(CacheMetadata.SyncTokens,syncTokens,cb)):cb(!1)}.bind(this))},clearCalendarEventCache:function clearCalendarEventCacheFn(calendarID,cb){try{g.PAssert(4711,g.isString(calendarID),"Must provide a valid calendar ID to clear event cache for")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4712,g.isFunction(cb),"Must provide valid CB function when clearing event cache")}catch(PERR){g.reportError(PERR)}var filterFn=function(entry){return entry.calendarID===calendarID};this._eventCache.getFilterEntries(filterFn,function(entries){if(entries){log("Clearing calendar cache: "+calendarID);for(var i=0;i<entries.length;++i)this._eventCache.removeEntry(entries[i].id);cb(!0)}else cb(!1)}.bind(this))},_calendarSyncComplete:function _calendarSyncCompleteFn(syncSuccessCalendars,syncFailureCalendars){syncFailureCalendars.length>0?(PS.notifySyncError(syncFailureCalendars),g.toasts.pushMessage(MessageID.CalendarSync)):(PS.notifySyncError(void 0),g.toasts.clearMessage(MessageID.CalendarSync));var exportCalendarID=this.getSetting(this.Settings.ExportCalendar);if(exportCalendarID){for(var exportSyncFailed=!1,i=0;i<syncFailureCalendars.length;++i)if(syncFailureCalendars[i].id===exportCalendarID){exportSyncFailed=!0;break}exportSyncFailed||this._syncOfflineChanges(this._notifyOfflineSyncFailures)}},_shouldExpireToken:function _shouldExpireTokenFn(syncToken){var needsExpire=!0;return syncToken&&(syncToken.expires?needsExpire=syncToken.expires<Date.now():syncToken.date&&(needsExpire=syncToken.date+this._syncTokenDuration<Date.now())),needsExpire},_getCalendarInfo:function _getCalendarInfoFn(calendarID){return this._calendarList[calendarID]},allowTextEditing:function allowTextEditingFn(item,attach){var hasWriteAccess=!1;if(this.getSetting(this.Settings.WriteAccess)){var calendarID=attach.getField("calendarID"),calendarInfo=this._getCalendarInfo(calendarID);calendarInfo?("writer"===calendarInfo.accessRole||"owner"===calendarInfo.accessRole)&&(hasWriteAccess=!0):attach.isLocalOnlyAttachment()&&(hasWriteAccess=!0)}return hasWriteAccess},runCalendarListSync:function runCalendarListSyncFn(){this.getReadableCalendarList(function(calendarList){if(calendarList){this._calendarList={};for(var i=0;i<calendarList.length;++i){var cal=calendarList[i];this._calendarList[cal.id]={id:cal.id,summary:cal.summary,accessRole:cal.accessRole}}g.toasts.clearMessage(MessageID.CalendarListSync),this._eventCache.onCacheMetadataReady(function(){this._eventCache.setMetadata(CacheMetadata.CalendarList,this._calendarList)}.bind(this))}else g.toasts.pushMessage(MessageID.CalendarListSync)}.bind(this))},_notifyTokenExpired:function _notifyTokenExpiredFn(calendarID){this._purgeOldDataTimeout&&clearTimeout(this._purgeOldDataTimeout);var runPurge=function(){this._purgeOldData(function(success){success||log("Failure during old data purge")})}.bind(this);this._purgeOldDataTimeout=setTimeout(runPurge,0)},_notifyCalendarUnsyncd:function _notifyCalendarUnsyncdFn(calendarID){log("Detected calendar "+calendarID+" is no longer syncd"),this._clearCachedData(calendarID,function(success){success||log("Failure unsyncing calendar "+calendarID)}),this._clearCalendarItems(calendarID)},_clearCalendarItems:function _clearCalendarItemsFn(calendarID){var itemStore=this.getDefaultItemStore();g.vmMain.beginUpdateItems(),itemStore.forEach(function(item){if(item.hasAttachments()){var attach=item.getAttachment(0);attach.getField("calendarID")===calendarID&&itemStore.destroyItem(item.id)}}),g.vmMain.commitUpdateItems()},_getSyncResultFromResult:function _getSyncResultFromResultFn(calendarID,result){var syncResult=C.SyncResult.Success;if(result&&result.error&&result.error.code){var errorCode=result.error.code;if(errorCode===C.HTTPStatusCode.Unauthorized){var calInfo=this._getCalendarInfo(calendarID);syncResult=calInfo&&"owner"===calInfo.accessRole?C.SyncResult.FailureOAuth:calInfo&&"writer"===calInfo.accessRole?C.SyncResult.FailureNoWrite:C.SyncResult.FailureNoRead}else syncResult=errorCode===C.HTTPStatusCode.NotFound?C.SyncResult.FailureNoRead:errorCode===C.HTTPStatusCode.Network?C.SyncResult.FailureNetwork:errorCode===C.HTTPStatusCode.Forbidden?C.SyncResult.FailureNoRead:C.SyncResult.FailureUnknown}return syncResult},runCalendarSync:function runCalendarSyncFn(){var numCalendarsSyncing=0,numCalendarsSyncd=0,calendarsSuccessfulSync=[],calendarsFailedSync=[],calendarSyncComplete=function(success,calendarID,resultError){try{g.PAssert(4713,numCalendarsSyncing>numCalendarsSyncd,"Should never have more calendars syncd than we tried to sync")}catch(PERR){g.reportError(PERR)}success?calendarsSuccessfulSync.push({id:calendarID,result:C.SyncResult.Success}):calendarsFailedSync.push({id:calendarID,result:this._getSyncResultFromResult(calendarID,resultError)}),++numCalendarsSyncd===numCalendarsSyncing&&this._calendarSyncComplete(calendarsSuccessfulSync,calendarsFailedSync)}.bind(this);this._eventCache.onCacheMetadataReady(function(){this._eventCache.getMetadata(CacheMetadata.SyncTokens,function(syncTokens){var syncList=this.getSetting(this.Settings.ImportCalendars);if(syncList&&syncList.length>0){numCalendarsSyncing=syncList.length;for(var i=0;i<syncList.length;++i){var syncCalInfo=syncList[i];g.isObject(syncCalInfo)||(syncCalInfo={id:syncList[i]});var syncToken=syncTokens?syncTokens[syncCalInfo.id]:void 0,token;
this._shouldExpireToken(syncToken)?(this._notifyTokenExpired(syncCalInfo.id),token=void 0):token=syncToken.token,this.performCalendarSync(syncCalInfo.id,token,calendarSyncComplete)}for(var calendarID in syncTokens){for(var isSyncCal=!1,i=0;i<syncList.length;++i){var syncCalInfo=syncList[i];if(g.isObject(syncCalInfo)||(syncCalInfo={id:syncList[i]}),syncCalInfo.id===calendarID){isSyncCal=!0;break}}isSyncCal||this._notifyCalendarUnsyncd(calendarID)}}else this._clearAllData(),this._calendarSyncComplete([],[])}.bind(this))}.bind(this))},performCalendarSync:function performCalendarSyncFn(calendarID,syncToken,cb){try{g.PAssert(4714,g.isString(calendarID),"Must provide a valid calendar ID for each sync op")}catch(PERR){g.reportError(PERR)}var requestFn=["gapi","client","calendar","events","list"],requestData={calendarId:calendarID,singleEvents:!0},options={getAllPages:!0};syncToken?requestData.syncToken=syncToken:(requestData.timeMin=this._minSyncStartTime.toISOString(),requestData.timeMax=this._maxSyncStartTime.toISOString());var successCB=function(result,outData,response){var nextSyncToken;response&&(nextSyncToken=response.nextSyncToken,this.setSyncToken(calendarID,nextSyncToken)),g.vmMain.beginUpdateItems();for(var i=0;i<result.length;++i)this.handleEventUpdate(calendarID,result[i]);g.vmMain.commitUpdateItems(),cb(!0,calendarID)}.bind(this),failureCB=function(result){result&&result.error&&result.error.code===C.HTTPStatusCode.Gone?this._clearCachedData(calendarID,function(success){success?this.performCalendarSync(calendarID,void 0,cb):cb(!1,calendarID,result)}.bind(this)):(cb(!1,calendarID,result),this._notifyFailedRequest(result,calendarID))}.bind(this);this._queuePagedRemoteRequest(requestFn,requestData,successCB,failureCB,void 0,RequestType.EventSync,options)},_createEventUpdateInfo:function _createEventUpdateInfoFn(info){var updateInfo={};for(var field in info)info.hasOwnProperty(field)&&EventUpdateFields.indexOf(field)>=0&&(updateInfo[field]=info[field]);return updateInfo},_notifyOfflineSyncFailures:function _notifyOfflineSyncFailuresFn(numSuccess,numFailure,failureResults){numFailure>0&&(PS.notifySyncError(failureResults),log("Failed to sync offlineChanges: ",numFailure))},_syncOfflineChanges:function _syncOfflineChangesFn(cb){if(!this._syncingOfflineChanges){this._syncingOfflineChanges=!0;var numChanges=0,successChanges=0,failureChanges=0,failureResults=[],notifyComplete=function(calendarID,syncResult){syncResult===C.SyncResult.Success?successChanges++:(failureChanges++,failureResults.push({id:calendarID,result:syncResult})),numChanges===successChanges+failureChanges&&(this._syncingOfflineChanges=!1,cb(successChanges,failureChanges,failureResults))}.bind(this),filterFn=function(entry){return!!entry.modifiedOffline};this._eventCache.getFilterEntries(filterFn,function(entries){numChanges=entries.length;for(var i=0;i<entries.length;++i){var cacheEntry=this.createEntryFromLocal(entries[i].id,entries[i]);cacheEntry.isInvalid||(g.isTempId(cacheEntry.id)&&!this._pendingCreates[cacheEntry.id]?this._createRemoteEventFromCacheData(cacheEntry.calendarID,cacheEntry,function(calendarID,successCreate,resultError){notifyComplete(calendarID,this._getSyncResultFromResult(calendarID,resultError))}.bind(this,cacheEntry.calendarID)):this._updateRemoteEvent(cacheEntry.calendarID,cacheEntry.id,cacheEntry,RequestType.OfflineUpdate,function(calendarID,successUpdate,resultError){successUpdate?(delete cacheEntry.modifiedOffline,this._eventCache.cacheEntry(cacheEntry.id,cacheEntry,function(success){success?notifyComplete(calendarID,C.SyncResult.Success):notifyComplete(calendarID,C.SyncResult.FailureUnknown)})):notifyComplete(calendarID,this._getSyncResultFromResult(calendarID,resultError))}.bind(this,cacheEntry.calendarID)))}}.bind(this))}},_getEventDuration:function _getEventDurationFn(attach){try{g.PAssert(4715,!attach.getField("allDayEvent"),"All day events do not have valid durations")}catch(PERR){g.reportError(PERR)}var startTime=attach.getField("startTime"),endTime=attach.getField("endTime");try{g.PAssert(4716,startTime&&endTime,"Must always have valid start and end times")}catch(PERR){g.reportError(PERR)}return endTime-startTime},_computeItemDates:function _computeItemDatesFn(outInfo,item,attach){try{g.PAssert(4717,item.date()||item.getRepeatDate(),"Must have a valid date")}catch(PERR){g.reportError(PERR)}var startTime,endTime;item.date()&&(startTime=item.date().clone(),endTime=startTime.clone().addMilliseconds(item.getDuration())),item.allDayDate()?(outInfo.start={date:startTime.toString("yyyy-MM-dd"),dateTime:null},outInfo.end={date:endTime.toString("yyyy-MM-dd"),dateTime:null}):(outInfo.start={dateTime:startTime.toISOString(),date:null},outInfo.end={dateTime:endTime.toISOString(),date:null}),outInfo.startTime=startTime,outInfo.endTime=endTime},_queueEventUpdate:function _queueEventUpdateFn(attach,info){if(this._updateAttachFromData(attach,info),this.loadRemoteAPIs(),this._eventUpdateTimeout&&clearTimeout(this._eventUpdateTimeout),this._eventUpdateTimeout=setTimeout(this._flushEventUpdateQueue,EventUpdateQueueDelay),!attach.isLocalOnlyAttachment()){var prevInfo=this._eventUpdateQueue[attach.id];if(prevInfo)for(var field in info)info.hasOwnProperty(field)&&(prevInfo.info[field]=info[field]);else this._eventUpdateQueue[attach.id]={attach:attach,info:info}}},_flushEventUpdateQueue:function _flushEventUpdateQueueFn(){this._eventUpdateTimeout=void 0;var onUpdate=function(success){success||log("Failed event update")};for(var id in this._eventUpdateQueue)if(this._eventUpdateQueue.hasOwnProperty(id)){var updateInfo=this._eventUpdateQueue[id];this._updateEvent(updateInfo.attach,updateInfo.info,RequestType.SummaryUpdate,onUpdate)}this._eventUpdateQueue={}},_handleAttachDeleted:function _handleAttachDeletedFn(attach,item){if(item.belongsToItemStore(this.getDefaultItemStore())){var prevStatus=attach.getField("status");this.deleteCalendarEvent(attach,function(success){if(success){var undoAction=function(){this._updateEvent(attach,{status:prevStatus},RequestType.UndoDelete,function(undoSuccess){undoSuccess||g.toasts.pushMessage({text:"There was an error re-adding the event to your calendar",actionText:"RETRY",action:undoAction,timeout:1e4})});var restoreText=this._createItemText(attach.getData());item.setText(restoreText,!0,ChangeType.Local),item.parent()||item.parent(this.getDefaultItemStore().getRoot()),item.getIndex()<0&&item.parent().insertItem(item)}.bind(this);g.toasts.pushMessage({text:"Event removed from your calendar.",actionText:"UNDO",action:undoAction,timeout:1e4})}else g.toasts.pushMessage({text:"There was an error removing the event from your calendar.",actionText:"RETRY",action:this._handleAttachDeleted.bind(this,attach,item),timeout:1e4})}.bind(this))}},notifyItemTextChanged:function notifyItemTextChangedFn(attach,item,isAttachDelete){if(isAttachDelete)this._handleAttachDeleted(attach,item);else if(attach.getField("recurringEventId")&&item.getCalendarParsedText()===attach.getField("summary"))g.toasts.pushMessage({text:"Moo.do does not currently support modifying repeated events.",actionText:"OKAY"});else if(!g.isDemoMode())if(item.date()){var newText=item.getCalendarParsedText(),oldText=attach.getField("summary"),oldSource=attach.getField("source"),newSource;if(item.hasAttachmentType(C.PluginType.Email)){var emailAttach=item.getAttachmentByType(C.PluginType.Email);newSource={title:emailAttach.getField("subject"),url:emailAttach.getPlugin().createURLForThread(emailAttach)}}var info={summary:newText,start:void 0,end:void 0,source:void 0},hasUpdate=!1;newText!==oldText&&(hasUpdate=!0),oldSource&&!newSource||!oldSource&&newSource?hasUpdate=!0:oldSource&&newSource&&(oldSource.title!==newSource.title||oldSource.url!==newSource.url)&&(hasUpdate=!0);var newStartDate=item.getDate(!0),oldStartDate=attach.getField("startTime");this.areDatesEqual(oldStartDate,newStartDate)||(hasUpdate=!0);var newEndDate=item.getEndDate(!0),oldEndDate=attach.getField("endTime");this.areDatesEqual(oldEndDate,newEndDate)||(hasUpdate=!0),hasUpdate&&(this._computeItemDates(info,item,attach),info.source=newSource,this._queueEventUpdate(attach,info)),attach.updateField("isInvalid",!1)}else attach.updateField("isInvalid",!0)},notifyItemPropertyChanged:function notifyItemPropertyChangedFn(attach,item,changeType){if(this.loadRemoteAPIs(),this.getSetting(this.Settings.WriteAccess)&&!attach.getField("locked")){var lastCompleted=attach.getField("isComplete"),lastArchived=attach.getField("isArchived"),lastStarred=attach.getField("isStarred"),lastPriority=attach.getField("priority"),itemCompleted=item.dateCompleted,itemArchived=item.isArchived(),itemStarred=item.isStarred(),itemPriority=item.priority(),cb=function(success){};lastCompleted!==itemCompleted&&(g.isLocalChange(changeType)?this._updateRemoteProperty(attach,"isComplete",itemCompleted,cb):attach.updateField("isComplete",itemCompleted)),lastArchived!==itemArchived&&(g.isLocalChange(changeType)?this._updateRemoteProperty(attach,"isArchived",itemArchived,cb):attach.updateField("isArchived",itemArchived)),lastStarred!==itemStarred&&(g.isLocalChange(changeType)?this._updateRemoteProperty(attach,"isStarred",itemStarred,cb):attach.updateField("isStarred",itemStarred)),lastPriority!==itemPriority&&(g.isLocalChange(changeType)?this._updateRemoteProperty(attach,"priority",itemPriority,cb):attach.updateField("priority",itemPriority))}},_clearCachedData:function _clearCachedDataFn(calendarID,cb){this.clearSyncToken(calendarID,function(success){success?this.clearCalendarEventCache(calendarID,cb):cb&&cb(!1)}.bind(this))},_clearAllData:function _clearAllDataFn(cb){this._eventCache.clearMetadata(function(success){success?this._eventCache.clearCache(function(cacheSuccess){cb&&cb(cacheSuccess)}):cb&&cb(!1)}.bind(this)),this.getDefaultItemStore().clearStore()},getAttachmentClass:function getAttachmentClassFn(attach){var classes=["plugin_gcalendar"];return attach.isLoaded()&&(attach.getField("isInvalid")&&classes.push("invalid"),"cancelled"===attach.getField("status")&&classes.push("eventDeleted")),classes},getAttachmentTooltip:function getAttachmentTooltipFn(attach){var tooltip;return this.isPluginBlocked()?tooltip="Go premium to view calendar events":attach.isLoaded()?(attach.isLocalOnlyAttachment()?tooltip="Syncing event...":attach.getField("isInvalid")&&(tooltip="Item has an invalid date"),"cancelled"===attach.getField("status")&&(tooltip="Item was deleted from Google Calendar")):tooltip="Plugin is loading data",tooltip},matchAttachment:function matchAttachmentFn(attach,text){var startTimeStr=DatePrefix+attach.getField("startTime").toString(International.getFormat(DFormat.ShortDayTime)),summary=attach.getField("summary")||"";return summary.indexOf(text)>=0||startTimeStr.indexOf(text)>=0},areDatesEqual:function areDatesEqualFn(ldate,rdate){var areEqual=!1;return ldate&&rdate?g.isDateValid(ldate)&&g.isDateValid(rdate)&&(areEqual=ldate.equals(rdate)):areEqual=!ldate&&!rdate,areEqual}};return util.inherit(VMPlugin,Plugin_GCalendar),util.extend(Plugin_GCalendar.prototype,Plugin_GCalendarFns),Plugin_GCalendar}),define("VMPluginManager",["globals","util","Constants","platform","EventDispatcher","Dispatcher","PluginRenderer","VMPlugin","plugins/Plugin_Drive","plugins/Plugin_Mailbird","plugins/Plugin_Gmail","plugins/Plugin_Moodo","plugins/Plugin_GCalendar"],function(g,util,C,platform,EventDispatcher,Dispatcher,PluginRenderer,VMPlugin,Plugin_Drive,Plugin_Mailbird,Plugin_Gmail,Plugin_Moodo,Plugin_GCalendar){function VMPluginManager(){this._plugins={},this._activePlugins=[],this._loadedDependencies={},this._isOnline=navigator.onLine,this._iteratingPlugins=!1,this._queueTimeout=void 0,this._forcedLastPossible=!1,this._numOutstandingReqs=0,this._pluginRenderer=new PluginRenderer,this.init()}var maxRequestsAtOnce=6,maxSinglePluginRequestsAtOnce=4,queueRequestTimeoutTime=g.seconds(30);return VMPluginManager.prototype={init:function initFn(){util.forceBind("_pumpRequestQueues",this),util.forceBind("_handleRequestResponse",this),util.forceBind("_handleBatchRequestResponse",this),this._setupRequestQueues(),this._pluginRenderer.registerDefaultRenderers(),g.billingManager.hasPremiumFeatures()?(this.notifyDependencyLoad(PluginDependency.EarlyAccess),this.notifyDependencyLoad(PluginDependency.PremiumSub)):g.billingManager.hasEarlyAccess()&&this.notifyDependencyLoad(PluginDependency.EarlyAccess),g.isDemoMode()&&this.notifyDependencyLoad(PluginDependency.DemoMode),window.addEventListener("offline",this.goOffline.bind(this)),window.addEventListener("online",this.goOnline.bind(this)),Dispatcher.listen("resetEverything",this._clearRequestQueues.bind(this))},printStats:function printStatsFn(id){if(log("---- Plugin Stats ----"),void 0!==id){var plugin=this._plugins[id];log(plugin.name),log(" Stats: ",plugin.getStats())}else for(var pluginKeys=Object.keys(this._plugins),i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]],pStat=plugin.getStats();log(plugin.name),log(" Stats: ",pStat)}log("----------------------")},dumpQueueState:function dumpQueueStateFn(){var pluginKeys=Object.keys(this._plugins);console.log("Queue State: ["+this._numOutstandingReqs+"]");for(var i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]];console.log(plugin.name),plugin.dumpRequestQueue(!1)}},getStats:function getStatsFn(id){var stats={};if(void 0!==id)stats[id]=this._plugins[id].getStats();else for(var pluginKeys=Object.keys(this._plugins),i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]];stats[plugin.id]=plugin.getStats()}return stats},getCacheStats:function getCacheStatsFn(id,cb){var stats={};if(void 0!==id)this._plugins[id].getCacheStats(cb);else for(var pluginKeys=Object.keys(this._plugins),seen=0,i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]];plugin.getCacheStats(function(pluginID,cacheStats){cacheStats&&(stats[pluginID]=cacheStats),pluginKeys.length===++seen&&cb(stats)}.bind(this,pluginKeys[i]))}},getState:function getStateFn(id){var state={};if(void 0!==id)state[id]=this._plugins[id].getState();else for(var pluginKeys=Object.keys(this._plugins),i=0;i<pluginKeys.length;++i){var plugin=this._plugins[pluginKeys[i]];state[plugin.id]=plugin.getState()}return state},registerPlugins:function registerPluginsFn(){try{this.registerPlugin(new Plugin_Moodo)}catch(err){g.reportError(err)}try{this.registerPlugin(new Plugin_Drive)}catch(err){g.reportError(err)}try{this.registerPlugin(new Plugin_Gmail)}catch(err){g.reportError(err)}try{this.registerPlugin(new Plugin_GCalendar)}catch(err){g.reportError(err)}try{this.registerPlugin(new Plugin_Mailbird)}catch(err){g.reportError(err)}},registerPlugin:function registerPluginFn(plugin){try{g.PAssert(4718,!this._plugins[plugin.id],"Should never double-register a plguin")}catch(PERR){g.reportError(PERR)}this._plugins[plugin.id]=plugin,this.isAuthorized(plugin.id)&&this.loadPlugin(plugin.id)},getPlugin:function getPluginFn(id){return this._plugins[id]},loadPlugin:function loadPluginFn(id){var plugin=this.getPlugin(id);try{g.PAssert(4719,plugin,"Must register a plugin before loading it")}catch(PERR){g.reportError(PERR)}this.activatePlugin(plugin)},unloadPlugin:function unloadPluginFn(id){},authorizePlugin:function authorizePluginFn(id,offlineAccess,cb){try{g.PAssert(4720,cb&&g.isFunction(cb),"Must provide a valid callback fn")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(id);try{g.PAssert(4721,plugin,"Must register a plugin before loading it")}catch(PERR){g.reportError(PERR)}plugin.authorize(offlineAccess,function(success){this.onPluginAuthorized(plugin,success),cb(success)}.bind(this))},deauthorizePlugin:function deauthorizePluginFn(id,cb){try{g.PAssert(4722,cb&&g.isFunction(cb),"Must provide a valid callback fn")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(id);try{g.PAssert(4723,plugin,"Must register a plugin before loading it")}catch(PERR){g.reportError(PERR)}plugin.setSetting(plugin.Settings.IsEnabled,!1),this.deactivatePlugin(plugin),cb(!0)},onPluginAuthorized:function onPluginAuthorizedFn(plugin,success){plugin.setSetting(plugin.Settings.IsEnabled,success),success&&this.activatePlugin(plugin)},activatePlugin:function activatePluginFn(plugin){try{g.PAssert(4724,plugin,"Plugin must be valid to be activated")}catch(PERR){g.reportError(PERR)}if(this._activePlugins.indexOf(plugin.id)<0){var success=plugin.activate(this._loadedDependencies);success&&this._activePlugins.push(plugin.id)}else plugin.ensurePaneTypeIsActive()},deactivatePlugin:function deactivatePluginFn(plugin){try{g.PAssert(4725,plugin,"Plugin must be valid to be deactivated")}catch(PERR){g.reportError(PERR)}if(this._activePlugins.indexOf(plugin.id)>=0){var success=plugin.deactivate();success&&this._activePlugins.remove(plugin.id)}},isOnline:function isOnlineFn(){return this._isOnline||g.isDemoMode()},goOnline:function goOnlineFn(){var OnlineDelay=2500;this._isOnline=!0,setTimeout(function(){this._setupRequestQueues(!0);for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.goOnline()}catch(err){this._reportPluginError(err)}}}.bind(this),OnlineDelay)},goOffline:function goOfflineFn(){this._isOnline=!1;for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.goOffline()}catch(err){this._reportPluginError(err)}}},onDocumentShared:function onDocumentSharedFn(firstShare){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.onDocumentShared(firstShare)}catch(err){this._reportPluginError(err)}}},writeCaches:function writeCachesFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.saveOfflineCache()}catch(err){this._reportPluginError(err)}}},onShutdown:function onShutdownFn(writeCaches){writeCaches&&this.writeCaches();for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.onShutdown()}catch(err){this._reportPluginError(err)}}},onPurgeData:function onPurgeDataFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.clearOfflineCache(!0)}catch(err){this._reportPluginError(err)}}},onClearData:function onClearDataFn(){for(var i=0;i<this._activePlugins.length;++i){var plugin=this._plugins[this._activePlugins[i]];try{plugin.clearData()}catch(err){this._reportPluginError(err)}}},getPluginsForType:function getPluginsForTypeFn(type){var plugins;switch(type){case C.PluginType.Calendar:plugins=[PluginID.GCalendar];break;case C.PluginType.Email:plugins=[PluginID.Gmail];break;case C.PluginType.Storage:plugins=[PluginID.Drive];break;case C.PluginType.Unknown:plugins=[PluginID.Mailbird,PluginID.Moodo]}return plugins},hasAttachmentType:function hasAttachmentTypeFn(item,type){var hasType=!1;if(item.hasAttachments())for(var plugins=this.getPluginsForType(type),i=0;i<plugins.length;++i)if(item.hasPluginAttachment(plugins[i])){hasType=!0;break}return hasType},allowTextEditing:function allowTextEditingFn(item){var allowTextEditing=!0;if(item&&item.hasAttachments())for(var attachments=item.getAttachments(),i=0;i<attachments.length;++i)if(!attachments[i].getPlugin().allowTextEditing(item,attachments[i])){allowTextEditing=!1;break}return allowTextEditing},validatePlugin:function validatePluginFn(id){},runForEachPlugin:function runForEachPluginFn(fn){this._iteratingPlugins=!0;for(var i=0;i<this._activePlugins.length;++i)try{fn(this.getPlugin(this._activePlugins[i]))}catch(err){g.reportError(err)}this._iteratingPlugins=!1},getAttachment:function getAttachmentFn(obj){try{g.PAssert(4726,obj.p,"Must specify the plugin string to be used")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4727,obj.id,"Must specify the ID of the data to use from the plugin")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(obj.p);try{g.PAssert(4728,plugin,"Must specify a valid plugin")}catch(PERR){g.reportError(PERR)}return plugin?(plugin.isActive()||this.activatePlugin(plugin),plugin.getAttachment(obj.id)):void 0},createDisplayElement:function createDisplayElementFn(obj){try{g.PAssert(4729,obj.p,"Must specify the plugin string to be used")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4730,obj.id,"Must specify the ID of the data to use from the plugin")}catch(PERR){g.reportError(PERR)}var styledText,plugin=this.getPlugin(obj.p);if(plugin){var attach=this.getAttachment(obj);try{styledText=plugin.createDisplayElement(attach)}catch(err){this._reportPluginError(err),styledText=this.createUnknownPluginElement(obj.p)}}else styledText=this.createUnknownPluginElement(obj.p);return styledText},createUnknownPluginElement:function createUnknownPluginElementFn(id){return{attrs:{cls:[],isUnknown:!0,plugin:PluginID.Moodo,"plugin-id":"Invalid"}}},measureAttachment:function measureAttachmentFn(pane,wordStyles){try{g.PAssert(4731,wordStyles&&wordStyles.attrs&&wordStyles.attrs.plugin,"Must have a valid plugin ID for measuring")}catch(PERR){g.reportError(PERR)}var width=0,plugin=this.getPlugin(wordStyles.attrs.plugin);try{g.PAssert(4732,plugin,"Should always be able to find a valid plugin: ",wordStyles.attrs.plugin)}catch(PERR){g.reportError(PERR)}return plugin&&(width=plugin.measureAttachment(pane,wordStyles)),width},parseAttachmentEmbedString:function parseAttachmentEmbedStringFn(str){try{g.PAssert(4733,str,"Must provide a valid string to parse")}catch(PERR){g.reportError(PERR)}var properties=str.replace(/&quot;/g,'"').split(","),obj={};return properties.forEach(function(property){var indexColon=property.indexOf(":"),key=property.substr(0,indexColon),value=property.substr(indexColon+1,property.length-indexColon-1);obj[key]=value}),obj.displayElement=this.createDisplayElement(obj),obj},getAttachmentFromElement:function getAttachmentFromElementFn(element){var pluginName=element.getAttribute("plugin"),pluginID=element.getAttribute("plugin-id");try{g.PAssert(4734,pluginName,"Element must have a plugin set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4735,pluginID,"Element must have a plugin ID set")}catch(PERR){g.reportError(PERR)}var plugin=this.getPlugin(pluginName),attachment=plugin.getAttachment(pluginID);return attachment},handleDropEvent:function handleDropEventFn(e,cb){for(var handled=!1,i=0;i<this._activePlugins.length&&!handled;++i){var pluginID=this._activePlugins[i],plugin=this.getPlugin(pluginID);try{handled=plugin.handleDropEvent(e,cb)}catch(err){this._reportPluginError(err)}}return handled},handleTapEvent:function handleTapEventFn(vmli,e,fn){var handled=!1,pluginElement=g.getPluginForElement(e.srcElement);if(pluginElement){var pluginName=pluginElement.getAttribute("plugin"),plugin=this.getPlugin(pluginName);try{g.PAssert(4736,plugin,"Must be able to get a valid plugin from a plugin element")}catch(PERR){g.reportError(PERR)}if(plugin.isPluginBlocked())g.toasts.pushMessage(MessageID.PremiumRequired),handled=!0;else{var itemID=pluginElement.getAttribute("plugin-id");try{g.PAssert(4737,itemID,"Must have a valid item ID for a plugin element")}catch(PERR){g.reportError(PERR)}try{handled=plugin[fn](vmli,itemID,e)}catch(err){this._reportPluginError(err)}}}return handled},handleTapStart:function handleTapStartFn(vmli,e){return this.handleTapEvent(vmli,e,"handleTapStart")},handleTapClick:function handleTapClickFn(vmli,e){return this.handleTapEvent(vmli,e,"handleTapClick")},handleDoubleTap:function handleDoubleTapFn(vmli,e){return this.handleTapEvent(vmli,e,"handleDoubleTap")},handleRightClick:function handleRightClickFn(vmli,e){return this.handleTapEvent(vmli,e,"handleRightClick")},isAuthorized:function isAuthorizedFn(id){return g.isDemoMode()?!0:this.getPlugin(id)?!!this.getSetting(id,this.getPlugin(id).Settings.IsEnabled):!1},getSetting:function getSettingFn(pluginID,key){return this.getPlugin(pluginID).getSetting(key)},setSetting:function setSettingFn(pluginID,key,value){return this.getPlugin(pluginID).setSetting(key,value)},onAuthorizedSetting:function onAuthorizedSettingFn(pluginID,key,value){this.getPlugin(pluginID).onAuthorizedSetting(key,value)},isDependencyLoaded:function isDependencyLoadedFn(dep){return!!this._loadedDependencies[dep]},notifyDependencyLoad:function notifyDependencyLoadFn(dep,data){this._loadedDependencies[dep]=data||!0;for(var id in this._plugins)try{this.getPlugin(id).onDependencyLoaded(dep,data)}catch(err){this._reportPluginError(err)}},notifyDependencyUnload:function notifyDependencyUnloadFn(dep,data){},_handleBatchRequestResponse:function _handleBatchRequestResponseFn(plugin,success){try{g.PAssert(4739,plugin,"Plugin must be passed to response to know who is handling it")}catch(PERR){g.reportError(PERR)}this._numOutstandingReqs--;try{g.PAssert(4740,this._numOutstandingReqs>=0,"Outstanding requests cannot be negative")}catch(PERR){g.reportError(PERR)}try{plugin._handleBatchRequestResponse(success)}catch(err){this._reportPluginError(err)}0===this._numOutstandingReqs&&this.notifyNoOutstandingReqs()},_handleRequestResponse:function _handleRequestResponseFn(attach,plugin,wasBatched){try{g.PAssert(4741,plugin,"Plugin must be passed to response to know who is handling it")}catch(PERR){g.reportError(PERR)}if(!wasBatched){this._numOutstandingReqs--;try{g.PAssert(4742,this._numOutstandingReqs>=0,"Outstanding requests cannot be negative")}catch(PERR){g.reportError(PERR)}}try{plugin._handleRequestResponse(attach,wasBatched)}catch(err){this._reportPluginError(err)}0===this._numOutstandingReqs&&this.notifyNoOutstandingReqs()},notifyNoOutstandingReqs:function notifyNoOutstandingReqsFn(){try{g.PAssert(4743,0===this._numOutstandingReqs,"Should only notify when there are no outstanding reqs left")}catch(PERR){g.reportError(PERR)}0===this._numOutstandingReqs&&this._setupRequestQueues(!0)},notifyHasPendingRemoteRequest:function notifyHasPendingRemoteRequestFn(){this._numOutstandingReqs<maxRequestsAtOnce&&this._setupRequestQueues(!0)},notifyAuthorizationAdded:function notifyAuthorizationAddedFn(email){this._numOutstandingReqs<maxRequestsAtOnce&&this._setupRequestQueues(!0)},_setupRequestQueues:function _setupRequestQueuesFn(nextPossible){var delay=nextPossible?1:queueRequestTimeoutTime;this._forcedLastPossible||(clearTimeout(this._queueTimeout),this._queueTimeout=setTimeout(this._pumpRequestQueues,delay)),this._forcedLastPossible=this._forcedLastPossible||!!nextPossible},_pumpRequestQueues:function _pumpRequestQueuesFn(){var numRequested=0;if(this.isOnline()){var availReqs=maxRequestsAtOnce-this._numOutstandingReqs;try{g.PAssert(4744,availReqs>=0,"Should never have more than max outstanding requests at any given point in time")}catch(PERR){g.reportError(PERR)}for(var i=0;availReqs>0&&i<this._activePlugins.length;++i){var pluginID=this._activePlugins[i],plugin=this.getPlugin(pluginID),pluginMaxRequests=Math.min(availReqs,maxSinglePluginRequestsAtOnce);if(pluginMaxRequests>0&&plugin.isReady()){var numReqSent=0;try{numReqSent=plugin._pumpRequestQueue(maxSinglePluginRequestsAtOnce,this._handleRequestResponse,this._handleBatchRequestResponse);try{g.PAssert(4745,numReqSent>=0,"Number of requests sent can never be negative")}catch(PERR){g.reportError(PERR)}}catch(err){this._reportPluginError(err)}numRequested+=numReqSent,availReqs-=numReqSent,this._numOutstandingReqs+=numReqSent}}}return this._forcedLastPossible=!1,this._setupRequestQueues(),numRequested},_clearRequestQueues:function _clearRequestQueuesFn(){this._numOutstandingReqs=0;for(var i=0;i<this._activePlugins.length;++i){var pluginID=this._activePlugins[i],plugin=this.getPlugin(pluginID);try{plugin._clearRequestQueue()}catch(err){this._reportPluginError(err)}}},useRenderer:function useRendererFn(type,id){return this._pluginRenderer.useRenderer(type,id)},_reportPluginError:function _reportPluginErrorFn(err){g.reportError(err)},parseEmailURL:function parseEmailURLFn(url){var info={accountID:void 0,threadID:void 0,plugin:void 0},gmailRegex=/https:\/\/mail.google.com\/mail\/b\/(.*)#all\/(.*)/g,urlInfo=gmailRegex.exec(url);return urlInfo&&(info.accountID=urlInfo[1],info.threadID=urlInfo[2],info.plugin=this.getPlugin(PluginID.Gmail)),info},isAvailable:function isAvailableFn(pluginID){return this.getPlugin(pluginID).isAvailable()},isActive:function isActiveFn(pluginID){return this.getPlugin(pluginID).isActive()},isEnabled:function isEnabledFn(pluginID){return this.getPlugin(pluginID).isEnabled()}},util.defineBase(VMPluginManager),util.extend(VMPluginManager.prototype,EventDispatcher),VMPluginManager}),define("PaneManager",["globals","Constants","util","platform","PaneFactory","Dispatcher","Trigger","Sel","Observable","ObservableArray","tracker"],function(g,C,util,platform,PaneFactory,Dispatcher,Trigger,Sel,Observable,ObservableArray,tracker){function PaneManager(){this.enableTempPanePosition=!1,this.totalWidth=0,this._panesById={},this._panes=new ObservableArray,this.displayPanes=new ObservableArray,this._iteratingPanes=!1,this._savedPaneState=void 0,this._activePaneState=[],this._swappedOutPanes=[],g.getLoginState()===LoginState.LOGGED_IN&&this.setupInitialTimeout(),this.init()}window.__TOTAL_PANES=0;var LoadFailedTimeout=3e4;return PaneManager.prototype={init:function initFn(){util.forceBind("onResize",this),util.forceBind("updateDisplayPanes",this),this._panes.listen(this.updateDisplayPanes),platform.onResize.listen(this.onResize),Dispatcher.listen("panesChanged",this.updateDisplayPanes),platform.mobile||setTimeout(function(){g.intro.isVisible.listen(this.onResize)}.bind(this),0),this.onResize()},getStats:function getStatsFn(paneID){var stats={};return void 0===paneID?this.runForEachPane(function(pane){stats[pane.id]=pane.getStats()}):stats=this.getPaneById(paneID).getStats(),stats},setupInitialTimeout:function setupInitialTimeoutFn(){0===this._panes.length()&&(this._initialTimeout=setTimeout(this._timeoutLoadFailed.bind(this),LoadFailedTimeout))},_timeoutLoadFailed:function _timeoutLoadFailedFn(){g.reportError(new Error("Pane Load Timeout")),this._initialTimeout=void 0},notifyPanes:function notifyPanesFn(){this._panes.notify()},trackPaneState:function trackPaneStateFn(){return!g.isRunningScript()&&!g.isDemoMode()},getPaneTopPadding:function getPaneTopPaddingFn(){return platform.mobile?g.topBarHeight:g.paneTop},onResize:function onResizeFn(){var pane=this.getPaneAtIndex(0);pane&&this.updatePaneRects()},getNextPaneID:function getNextPaneIDFn(){return++window.__TOTAL_PANES},getAllPerPaneState:function getAllPerPaneStateFn(itemID,field){for(var state=[],paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);state.push(pane.getPerPaneState(itemID,field))}return state},setAllPerPaneState:function setAllPerPaneStateFn(itemID,field,data){for(var paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);pane.setPerPaneState(itemID,field,data)}},deletePerPaneState:function deletePerPaneStateFn(paneID,itemID){var pane=this.getPaneById(paneID);pane&&pane.deletePerPaneState(itemID)},getPaneState:function getPaneStateFn(){if(this.trackPaneState()){var activeDocId=g.settings.get(Settings.gdocId);void 0===this._savedPaneState&&(this._savedPaneState=this.loadPaneState()),this._activePaneState=this._savedPaneState[activeDocId]||[]}try{g.PAssert(4746,this._activePaneState,"Must always return a valid pane state to callers")}catch(PERR){g.reportError(PERR)}return this._activePaneState},loadPaneState:function loadPaneStateFn(){if(this.trackPaneState()){var savedState=util.storage.getItem("paneState"),savedObj;try{savedObj=JSON.parse(savedState),g.isString(savedObj)&&(g.reportError(new Error("Invalid saved PaneState: "+savedObj)),util.storage.removeItem("paneState"),savedObj=void 0)}catch(err){util.storage.removeItem("paneState"),savedObj=void 0,g.reportError(err)}return savedObj||{}}return{}},savePaneState:function savePaneStateFn(){if(this.trackPaneState()){var activeDocId=g.settings.get(Settings.gdocId);if(activeDocId){this._savedPaneState[activeDocId]=this._activePaneState;try{var paneStateString=JSON.stringify(this._savedPaneState);
util.storage.setItem("paneState",paneStateString)}catch(err){if("Safari"!==platform.browser||!err||"QuotaExceededError"!==err.name){g.reportError(err);try{this._activePaneState=this.recreatePaneState(),this._savedPaneState[activeDocId]=this._activePaneState,paneStateString=JSON.stringify(this._savedPaneState),util.storage.setItem("paneState",paneStateString)}catch(err2){g.reportError(err2)}}}}}},clearPaneState:function clearPaneStateFn(){this._activePaneState=[],this.savePaneState()},updatePaneStateForPane:function updatePaneStateForPaneFn(pane){try{g.PAssert(4747,pane,"Must pass in a valid pane to update")}catch(PERR){g.reportError(PERR)}if(this.trackPaneState()){for(var paneState=this.getPaneState(),found=!1,i=0;i<paneState.length;++i){var info=paneState[i];if(info.id===pane.id){paneState[i]=pane.getSaveInfo(),found=!0;break}}found||(paneState=this.recreatePaneState()),this._activePaneState=paneState,this.savePaneState()}},recreatePaneState:function recreatePaneStateFn(){var paneState=[];return this.runForEachPane(function(tPane){paneState.push(tPane.getSaveInfo())}),paneState},updatePaneScrollState:function updatePaneScrollStateFn(){if(this.trackPaneState()){var paneState=this.getPaneState();this.runForEachPane(function(pane){for(var i=0;i<paneState.length;++i){var entry=paneState[i];if(pane.id===entry.id){entry.offset=pane.getScrollOffset();break}}}),this.savePaneState()}},isPaneActive:function isPaneActiveFn(id){return!!this._panesById[id]},createPaneAtIndex:function createPaneAtIndexFn(type,index,params,notify){try{g.PAssert(4748,type,"Must supply a valid pane type")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4749,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}isNaN(index)&&(index=this.paneCount()),params=params||{},params.id=this.getNextPaneID();var newPane=PaneFactory.createPane(type,params);return newPane?this.addPaneAtIndex(newPane,index,void 0,notify):g.reportError(new Error("Invalid pane created: "+type+" | "+index)),newPane},addPaneAtIndex:function addPaneAtIndexFn(pane,index,noSaveState,notify){try{g.PAssert(4750,pane,"Must supply a valid pane")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4751,!this._panesById[pane.id],"Should never add the same pane twice")}catch(PERR){g.reportError(PERR)}if(this._panesById[pane.id]=pane,this.enableTempPanePosition&&this._panes.length()>0&&index===this._panes.length()){var lastPane=this._panes.get()[this._panes.length()-1];this.tempPositionForNewPane={pane:lastPane,left:lastPane.rect.get().left+C.PaneSpaceSize}}if(isNaN(index)?this._panes.push(pane,notify):this._panes.splice(index,0,pane,notify),pane.init(),pane.isExpanded.listen(this.onResize),this.tempPositionForNewPane&&(this.tempPositionForNewPane=null,setTimeout(this.onResize.bind(this),0)),this.ensurePaneInView(pane),!noSaveState&&this.trackPaneState()){var paneState=this.getPaneState();isNaN(index)?paneState.push(pane.getSaveInfo()):paneState.splice(index,0,pane.getSaveInfo()),this.savePaneState()}},removePaneAtIndex:function removePaneAtIndexFn(index,notify){try{g.PAssert(4752,!isNaN(index),"Must supply a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4753,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}var removedID,doRemove=!1,removeCandidate=this.getPaneAtIndex(index);if((this.paneCount()>1||removeCandidate.type!==PaneMode.Outline)&&(doRemove=!0),doRemove){var removedPane=this._panes.splice(index,1,void 0,notify)[0];try{g.PAssert(4754,removedPane,"Must have removed a valid pane")}catch(PERR){g.reportError(PERR)}removedPane.isExpanded.unlisten(this.onResize),Dispatcher.fireEvent("paneRemoved",[removedPane]);try{g.PAssert(4755,this._panesById[removedPane.id],"Should never add the same pane twice")}catch(PERR){g.reportError(PERR)}if(this._panesById[removedPane.id]=void 0,removedPane.destroy(),this.trackPaneState()){var paneState=this.getPaneState();paneState.splice(index,1),this.savePaneState(),removedID=removedPane.id}0===this.paneCount()&&this.createPaneAtIndex(PaneMode.Outline,0)}return this.ensurePaneInView(),removedID},removePanesByType:function removePanesByTypeFn(type){var removePanes=[];this.runForEachPane(function(pane){removePanes.push(pane)},type);for(var i=0;i<removePanes.length;++i)this.removePane(removePanes[i])},swapPaneAtIndex:function swapPaneAtIndexFn(index,pane){try{g.PAssert(4756,!isNaN(index)&&0===index,"Must supply a valid index to remove from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4757,platform.mobile,"We only perform pane swapping on mobile currently")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4758,pane,"Must supply a valid pane to swap out")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4759,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4760,1===this.paneCount(),"Swapping panes should only happen when there is a single pane present")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4761,1===this._swappedOutPanes.length,"Swapping panes should only happen when there is a single pane swapped out")}catch(PERR){g.reportError(PERR)}var prevPaneInfo=this._swappedOutPanes.pop();try{g.PAssert(4762,prevPaneInfo.pane===pane,"Swapped out pane must match")}catch(PERR){g.reportError(PERR)}var currentPane=this._panes.get()[index];if(this._swappedOutPanes.push({pane:currentPane,data:{offset:currentPane.getScrollOffset()}}),this._panesById[currentPane.id]=void 0,this._panesById[pane.id]=pane,this._panes.set([pane]),pane.notifySwappedIn(prevPaneInfo.data.offset),tracker.miscAction({type:TrackerType.Mobile,misc:pane.type===PaneMode.Timeline?TrackerMiscMobile.PaneAgenda:TrackerMiscMobile.PaneOutline}),!g.isRunningScript()&&!g.isDemoMode()&&this.trackPaneState()){var paneState=this.getPaneState();paneState.splice(index,1,pane.getSaveInfo());try{g.PAssert(4763,1===paneState.length,"Must only have a single entry when swapping panes")}catch(PERR){g.reportError(PERR)}this.savePaneState()}},getSwappedPaneByType:function getSwappedPaneByTypeFn(type){try{g.PAssert(4764,platform.mobile,"Mobile platform will only ever have a single instance of each pane type")}catch(PERR){g.reportError(PERR)}for(var i=0;i<this._swappedOutPanes.length;++i){var swapInfo=this._swappedOutPanes[i];if(swapInfo&&swapInfo.pane&&swapInfo.pane.type===type)return swapInfo.pane}var newPane=PaneFactory.createPane(type,{id:this.getNextPaneID()});return newPane.init(),this._swappedOutPanes.push({pane:newPane,data:{offset:0}}),newPane},removeFocusedPane:function removeFocusedPaneFn(){return this.removePane(g.focusedPane)},removePane:function removePaneFn(pane){var index=this.getPaneIndex(pane);return this.removePaneAtIndex(index)},movePane:function movePaneFn(indexFrom,indexTo){try{g.PAssert(4765,!this._iteratingPanes,"Should not change pane array while iterating")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4766,!1,"Not Implemented")}catch(PERR){g.reportError(PERR)}},clearPanes:function clearPanesFn(notify){try{g.PAssert(4767,g.isDemoMode(),"Should only be clearing panes in demo mode")}catch(PERR){g.reportError(PERR)}this.runForEachPane(function(pane){pane.destroy()}),this._panesById={},this._panes.set([],notify),Sel.setFocusedPane(void 0)},clearPaneCaches:function clearPaneCachesFn(){this.runForEachPane(function(pane){pane.getInfiniteList().clearCache()})},getPaneAtIndex:function getPaneAtIndexFn(index){return this._panes.get()[index]},getPaneIndex:function getPaneIndexFn(pane){return this._panes.get().indexOf(pane)},getPaneById:function getPaneByIdFn(id){try{g.PAssert(4770,this._panesById[id],"Should never request a pane that is not currently loaded")}catch(PERR){g.reportError(PERR)}return this._panesById[id]},getPanesByType:function getPanesByTypeFn(type){for(var panes=[],paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);type&&pane.type!==type||panes.push(pane)}return panes},paneCount:function paneCountFn(){return this._panes.get().length},runForEachPane:function runForEachPaneFn(fn,type){this._iteratingPanes=!0;for(var paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);if(!type||pane.type===type)try{fn(pane)}catch(err){g.reportError(err)}}this._iteratingPanes=!1},applyFnToPanes:function applyFnToPanesFn(fnName,type){this._iteratingPanes=!0;for(var paneCount=this.paneCount(),i=0;paneCount>i;++i){var pane=this.getPaneAtIndex(i);if(!type||pane.type===type){var fn=pane[fnName];try{g.PAssert(4771,fn,"Must provide a valid function name for the given pane type")}catch(PERR){g.reportError(PERR)}try{fn.apply(pane,Array.prototype.slice.call(arguments,2))}catch(err){g.reportError(err)}}}this._iteratingPanes=!1},dragPaneTo:function dragPaneToFn(pane,left,right){for(var panes=this._panes.get(),index=panes.indexOf(pane),closestIndex=-1,closestDist=Number.MAX_VALUE,paneCount=this.paneCount(),changed,i=0;paneCount>i;++i){var paneTo=this.getPaneAtIndex(i),rect=paneTo.rect.get(),dist=Math.abs(index>=i?rect.left-left:rect.right-right);closestDist>dist&&(closestDist=dist,closestIndex=i)}if(closestIndex>=0){var originalIndex=panes.indexOf(pane);originalIndex!==closestIndex&&(panes.splice(closestIndex,0,panes.splice(originalIndex,1)[0]),this._panes.set(panes),this._activePaneState=this.recreatePaneState(),this.savePaneState(),changed=!0)}return changed},paneSortFn:function paneSortFnFn(a,b){return a.id-b.id},updateDisplayPanes:function updateDisplayPanesFn(){this._initialTimeout&&(clearTimeout(this._initialTimeout),this._initialTimeout=void 0);for(var panes=this._panes.get().slice(0).sort(this.paneSortFn),displayPanes=[],i=0;i<panes.length;++i){var pane=panes[i];pane.isOverviewVisible()&&displayPanes.push({type:"overview",pane:pane}),displayPanes.push({type:"pane",pane:pane}),pane.isExpanded.get()&&displayPanes.push({type:"emailPreview",pane:pane})}this.updatePaneRects(),this.displayPanes.set(displayPanes)},updatePaneRects:function updatePaneRectsFn(){var panes=this._panes.get(),windowWidth=platform.windowWidth(),paneHeight=platform.windowHeight()-this.getPaneTopPadding();if(platform.android&&0>=windowWidth&&(windowWidth=window.screen.width),g.isDemoInIframe()&&(windowWidth-=5),platform.mobile)for(var i=0;i<panes.length;i++){var pane=panes[i],rect={left:0,top:0,width:windowWidth,height:paneHeight,right:windowWidth,bottom:paneHeight};g.areObjectsEqual(pane.rect.get(),rect)||pane.rect.set(rect)}else{for(var SpaceBetween=C.PaneSpaceSize,minPaneWidth=g.minPaneWidth,maxPaneWidth=g.isDemoInIframe()?440:g.maxPaneWidth,numFlexPanes=0,numFixedPanes=0,numFullscreenPanes=0,numOverviews=0,numSpaces=0,i=0;i<panes.length;i++){var pane=panes[i];pane.isExpanded.get()?numFullscreenPanes++:pane.maxWidth===g.minPaneWidth?numFixedPanes++:numFlexPanes++,pane.getOverview().isVisible.get()?numOverviews++:i>0&&numSpaces++}g.intro&&g.intro.isVisible.get()&&numFixedPanes++;var widthFixed=minPaneWidth,widthExpanded=platform.emailPreviewSize()+minPaneWidth,totalSpace=numSpaces*SpaceBetween,widthToFlex=windowWidth-totalSpace-widthFixed*numFixedPanes-widthExpanded*numFullscreenPanes-numOverviews*C.OverviewWidth,widthFlex=numFlexPanes>0?Math.min(maxPaneWidth,Math.max(minPaneWidth,Math.round(widthToFlex/numFlexPanes))):0,totalPaneSize=widthFixed*numFixedPanes+widthFlex*numFlexPanes+widthExpanded*numFullscreenPanes+numOverviews*C.OverviewWidth+totalSpace,left=Math.round(Math.max((windowWidth-totalPaneSize)/2,0));g.isDemoInIframe()&&(left+=2);for(var i=0;i<panes.length;i++){var pane=panes[i],w=pane.isExpanded.get()?minPaneWidth:pane.maxWidth===minPaneWidth?widthFixed:widthFlex;pane.isOverviewVisible()?left+=C.OverviewWidth:0!==i&&(left+=SpaceBetween),this.tempPositionForNewPane&&pane.rect.get()?(pane.rect.get().width=w,pane.rect.notify()):pane.rect.set({left:left,top:0,width:w,height:paneHeight,right:left+w,bottom:paneHeight}),left+=w,pane.isExpanded.get()&&(left+=platform.emailPreviewSize())}g.intro&&g.intro.isVisible.get()&&(left+=SpaceBetween,g.intro.position.set(left),left+=minPaneWidth)}if(this.totalWidth=left,this.tempPositionForNewPane){var lastPane=panes[panes.length-1],r=lastPane.rect.get(),t=this.tempPositionForNewPane;r.left=t.left+t.pane.rect.get().width}Dispatcher.fireEvent("paneSizeChanged",[])},ensurePaneInView:function ensurePaneInViewFn(pane){if(g.vmMain.panesContainer){if(!pane){var panes=this._panes.get();pane=panes[panes.length-1]}var rect=pane.rect.get();if(rect){var width=rect.width+(pane.isExpanded.get()?platform.emailPreviewSize():0),scrollOffset=g.vmMain.getScrollOffset(),left=rect.left-scrollOffset,right=rect.left+width-scrollOffset;(0>left||right>platform.windowWidth())&&g.vmMain.setScrollOffset(rect.left)}}}},util.defineBase(PaneManager),PaneManager}),define("RemoteDoc",["globals","data","util","platform","goog"],function(g,d,util,platform,goog){function RemoteDoc(type,name){this._type=type,this._name=name,this._doc=void 0,this._loadFn=void 0,this._errorFn=void 0,this._initFn=void 0}return RemoteDoc.prototype={open:function openFn(id,loadFn,initFn,errorFn){try{g.PAssert(4772,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},close:function closeFn(){try{g.PAssert(4773,!1,"SubClass must override")}catch(PERR){g.reportError(PERR)}},_getDocument:function _getDocumentFn(){return this._doc},getModel:function getModelFn(){return this._doc.getModel()},setLoadFn:function setLoadFnFn(loadFn){return this._loadFn=loadFn,this._onLoad.bind(this)},setInitFn:function setInitFnFn(initFn){return this._initFn=initFn,this._onInit.bind(this)},setErrorFn:function setErrorFnFn(errorFn){return this._errorFn=errorFn,this._onError.bind(this)},_onLoad:function _onLoadFn(doc){this._doc=doc;try{this._loadFn(doc)}catch(err){g.reportError(err)}},_onError:function _onErrorFn(err){this._errorFn(err)},_onInit:function _onInitFn(model){try{this._initFn(model)}catch(err){g.reportError(err)}}},util.defineBase(RemoteDoc),RemoteDoc}),define("GRealtimeDoc",["globals","data","util","platform","goog","RemoteDoc"],function(g,d,util,platform,goog,RemoteDoc){function GRealtimeDoc(name){this._super.constructor.call(this,DocType.GRealtime,name),this.init()}var GRealtimeDocFns={init:function initFn(){},open:function openFn(id,loadFn,initFn,errorFn){gdata.driveRealtimeLoad(id,this.setLoadFn(loadFn),this.setInitFn(initFn),this.setErrorFn(errorFn))},close:function closeFn(){}};return util.inherit(RemoteDoc,GRealtimeDoc),util.extend(GRealtimeDoc.prototype,GRealtimeDocFns),GRealtimeDoc}),define("GAppDataDoc",["globals","data","util","platform","goog","RemoteDoc"],function(g,d,util,platform,goog,RemoteDoc){function GAppDataDoc(name){this._super.constructor.call(this,DocType.GAppData,name),this.init()}var GAppDataDocFns={init:function initFn(){},open:function openFn(id,loadFn,initFn,errorFn){gapi.drive.realtime.loadAppDataDocument(this.setLoadFn(loadFn),this.setInitFn(initFn),this.setErrorFn(errorFn))},close:function closeFn(){}};return util.inherit(RemoteDoc,GAppDataDoc),util.extend(GAppDataDoc.prototype,GAppDataDocFns),GAppDataDoc}),define("RealtimeDocManager",["globals","data","util","platform","goog","GRealtimeDoc","GAppDataDoc"],function(g,d,util,platform,goog,GRealtimeDoc,GAppDataDoc){function RealtimeDocManager(){this._activeDocuments={},this._activeTypes={},this._authorizedTypes={},this._listeners=[],this.init()}return window.DocType={GRealtime:0,GAppData:1},RealtimeDocManager.prototype={init:function initFn(){var checkDrive=function(){window.gapi.drive?(this._activateType(DocType.GRealtime),this._activateType(DocType.GAppData)):(g.reportError(new Error("Fatal error while loading google drive - did not add self to gapi")),window.addEventListener("gapiDriveLoaded",checkDrive.bind(this)))}.bind(this);window.gapi&&window.gapi.drive?checkDrive():window.addEventListener("gapiDriveLoaded",checkDrive.bind(this))},_activateType:function _activateTypeFn(type){if(this._activeTypes[type])try{g.PAssert(4774,!1,"Should only be activating a doc type once")}catch(PERR){g.reportError(PERR)}else this._activeTypes[type]=!0,this._authorizedTypes[type]&&this._notifyListeners(type)},_authorizeType:function _authorizeTypeFn(type){this._authorizedTypes[type]||(this._authorizedTypes[type]=!0,this._activeTypes[type]&&this._notifyListeners(type))},registerForReadyNotification:function registerForReadyNotificationFn(type,cb){if(g.isArray(this._listeners[type]))this._listeners[type].push(cb);else if(void 0===this._listeners[type])this._listeners[type]=[cb];else{try{g.PAssert(4775,-1===this._listeners[type],"After a type is loaded, do not queue listners")}catch(PERR){g.reportError(PERR)}cb()}},_notifyListeners:function _notifyListenersFn(type){if(g.isArray(this._listeners[type]))for(var i=0;i<this._listeners[type].length;++i)this._listeners[type][i]();this._listeners[type]=-1},notifyGoogleAuthorization:function notifyGoogleAuthorizationFn(){for(var scopes=goog.getAuthorizedScopes(),i=0;i<scopes.length;++i)switch(scopes[i]){case GScope.Drive:case GScope.DriveFull:this._authorizeType(DocType.GRealtime);break;case GScope.DriveAppData:this._authorizeType(DocType.GAppData)}},createDocument:function createDocumentFn(type,name){try{g.PAssert(4776,type,"Must provide a document type")}catch(PERR){g.reportError(PERR)}name=name||g.generateTempId();try{g.PAssert(4777,!this._activeDocuments[name],"Should not name two documents the same thing")}catch(PERR){g.reportError(PERR)}var remoteDoc;switch(type){case DocType.GRealtime:remoteDoc=new GRealtimeDoc(name);break;case DocType.GAppData:remoteDoc=new GAppDataDoc(name);break;default:try{g.PAssert(4778,!1,"Invalid document type requested",type)}catch(PERR){g.reportError(PERR)}}return this._activeDocuments[name]=remoteDoc,remoteDoc}},util.defineBase(RealtimeDocManager),RealtimeDocManager}),define("RecurringTimedTask",["globals","util","RingBuffer"],function(g,util,RingBuffer){function RecurringTimedTask(id,options){try{g.PAssert(4779,options,"Must provide a valid set of task options: "+id)}catch(PERR){g.reportError(PERR)}var opt;this._id=id,this._iterationID=g.generateTempId(),this._isAsync=options.async,this._isAsyncRunning=!1;try{g.PAssert(4781,options.task&&g.isFunction(options.task),"Must provide a valid task function")}catch(PERR){g.reportError(PERR)}this._task=options.task,this._delay=options.delay;try{g.PAssert(4782,void 0===options.asyncTimeout||options.async,"Should never specify an async timeout for a non-async task")}catch(PERR){g.reportError(PERR)}this._asyncTimeout=options.asyncTimeout||0,this._pauseWhileIdle=options.pauseWhileIdle||!1,this._minDelayOnResume=options.minDelayOnResume||!1;try{g.PAssert(4783,this._pauseWhileIdle||!this._minDelayOnResume,"Must use pauseWhileIdle to support minDelayOnResume")}catch(PERR){g.reportError(PERR)}this._suspended=!1,this._remainingTime=0,this._lastUpdate=options.runOnCreate?0:Date.now(),this._numUpdatesRun=0,this._numUpdatesSkipped=0,this._numUpdatesAsyncSkipped=0,this._minDelay=options.minDelay||0,this._lastSetDelay=this._delay,this._runningTimeout=void 0,this._updateIsRunning=!1,this._isCancelled=!1,this._updateTimes=new RingBuffer(10),this.init()}var validOptions=["delay","async","minDelay","task","pauseWhileIdle","minDelayOnResume","runOnCreate","asyncTimeout"],RecurringTimedTaskFns={init:function initFn(){util.forceBind("_runUpdate",this),util.forceBind("_notifyAsyncComplete",this),this._lastUpdate>0?this._runningTimeout=setTimeout(this._runUpdate,this._delay):this._runUpdate()},getStats:function getStatsFn(){var stats={numUpdatesRun:this._numUpdatesRun,numUpdatesSkipped:this._numUpdatesSkipped,numUpdatesAsyncSkipped:this._numUpdatesAsyncSkipped,updateIsRunning:this._updateIsRunning,isAsyncRunning:this._isAsyncRunning,cancelled:this._isCancelled,suspended:this._suspended,lastUpdate:this._lastUpdate,timeSinceLastUpdate:this._timeSinceLastUpdate(),updateTimes:this._updateTimes.ordered()};return stats},cancel:function cancelFn(){this._isCancelled=!0,clearTimeout(this._runningTimeout),this._runningTimeout=void 0},notifyOfSuspend:function notifyOfSuspendFn(){this._pauseWhileIdle&&(this._suspended=!0,this._remainingTime=this._lastSetDelay-this._timeSinceLastUpdate(),clearTimeout(this._runningTimeout),this._runningTimeout=void 0)},notifyOfResume:function notifyOfResumeFn(){if(this._pauseWhileIdle){this._suspended=!1;var remainingTime;this._minDelayOnResume?remainingTime=Math.max(0,this._minDelay-this._timeSinceLastUpdate()):(remainingTime=this._remainingTime,this._remainingTime=0),remainingTime=Math.max(500,remainingTime),this._runningTimeout=setTimeout(this._runUpdate,remainingTime)}},isAsync:function isAsyncFn(){return this._isAsync},isAsyncRunning:function isAsyncRunningFn(){return this.isAsync()&&this._isAsyncRunning},_notifyUpdateAsyncSkipped:function _notifyUpdateAsyncSkippedFn(){this._numUpdatesAsyncSkipped++},_notifyUpdateSkipped:function _notifyUpdateSkippedFn(){this._numUpdatesSkipped++},_notifyUpdateRun:function _notifyUpdateRunFn(){this._lastUpdate=Date.now(),this._updateTimes.push(this._lastUpdate),this._numUpdatesRun++},_timeSinceLastUpdate:function _timeSinceLastUpdateFn(){return Date.now()-this._lastUpdate},_notifyAsyncBegin:function _notifyAsyncBeginFn(){this._isAsyncRunning=!0,this._iterationID=g.generateTempId()},_notifyAsyncComplete:function _notifyAsyncCompleteFn(){this._isAsyncRunning=!1},_runUpdate:function _runUpdateFn(cb){try{g.PAssert(4784,!this._isCancelled,"Should never run a cancelled task")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4786,!this._updateIsRunning,"Should not run another update while already running one: "+this._id)}catch(PERR){g.reportError(PERR)}if(!this._updateIsRunning){if(this._updateIsRunning=!0,clearTimeout(this._runningTimeout),this._runningTimeout=void 0,this._notifyUpdateRun(),this.isAsync())if(this.isAsyncRunning())this._notifyUpdateAsyncSkipped();else if(this._notifyAsyncBegin(),cb)try{this._task(function(){this._notifyAsyncComplete(),cb&&cb.apply(this,arguments)}.bind(this))}catch(err){g.reportError(err),this._notifyAsyncComplete()}else try{this._task(this._notifyAsyncComplete)}catch(err){g.reportError(err),this._notifyAsyncComplete()}else try{this._task()}catch(err){g.reportError(err)}this._runningTimeout=setTimeout(this._runUpdate,this._delay),this._lastSetDelay=this._delay,this._updateIsRunning=!1}},requestUpdate:function requestUpdateFn(){if(this._timeSinceLastUpdate()>this._minDelay)this._runUpdate();else{this._notifyUpdateSkipped();var minDelayTime=this._minDelay-this._timeSinceLastUpdate();clearTimeout(this._runningTimeout),this._runningTimeout=setTimeout(this._runUpdate,minDelayTime),this._lastSetDelay=this._minDelay}},forceUpdate:function forceUpdateFn(cb){this._runUpdate(cb)}};return util.extend(RecurringTimedTask.prototype,RecurringTimedTaskFns),RecurringTimedTask}),define("RecurringTaskManager",["globals","util","platform","RecurringTimedTask"],function(g,util,platform,RecurringTimedTask){function RecurringTaskManager(){this._tasks={},this.init()}var RecurringTaskManagerFns={init:function initFn(){window.addEventListener("focus",this._handleFocus.bind(this)),window.addEventListener("blur",this._handleBlur.bind(this))},getStats:function getStatsFn(){var outStats={};for(var id in this._tasks)outStats[id]=this._tasks[id].getStats();return outStats},createRecurringTask:function createRecurringTaskFn(id,options){try{g.PAssert(4787,!this._tasks[id],"Must not register multiple tasks with the same ID")}catch(PERR){g.reportError(PERR)}var newTask=new RecurringTimedTask(id,options);return this._tasks[id]=newTask,newTask},getRecurringTask:function getRecurringTaskFn(id){try{g.PAssert(4788,this._tasks[id],"Must only retreive a valid recurring task")}catch(PERR){g.reportError(PERR)}return this._tasks[id]},hasRecurringTask:function hasRecurringTaskFn(id){return!!this._tasks[id]},cancelRecurringTask:function cancelRecurringTaskFn(id){try{g.PAssert(4789,this._tasks[id],"Must only cancel a valid recurring task")}catch(PERR){g.reportError(PERR)}this._tasks[id].cancel(),delete this._tasks[id]},_handleFocus:function _handleFocusFn(){for(var id in this._tasks)this._tasks[id].notifyOfResume()},_handleBlur:function _handleBlurFn(){for(var id in this._tasks)this._tasks[id].notifyOfSuspend()}};return util.extend(RecurringTaskManager.prototype,RecurringTaskManagerFns),RecurringTaskManager}),define("DeferredTask",["require","exports","module","globals","util","AccountManager"],function(require,exports,module){function DeferredTask(id,type,scheduleDate,isCanceled,remoteID,data,cbRun,cbCancel,cbPersistRemote){this._id=id,this._remoteID=remoteID,this._type=type;try{g.PAssert(4790,g.isDateValid(scheduleDate),"Must specify a valid schedule date for deferred task")}catch(PERR){g.reportError(PERR)}this._scheduleDate=scheduleDate,this._timeout=void 0,this._data=data,this._cbRun=cbRun,this._cbCancel=cbCancel,this._cbPersistRemote=cbPersistRemote,this._hasRun=!1,this._isCanceled=isCanceled,this._destroyed=!1,util.forceBind("runTask",this),util.forceBind("_onCanceled",this),util.forceBind("_onPersistedRemote",this)}var g=require("globals"),util=require("util"),AccountManager=require("AccountManager");return DeferredTask.prototype={schedule:function scheduleFn(){try{g.PAssert(4791,!this._timeout,"Should not schedule the same task multiple times")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4792,!this._hasRun,"Should not schedule a task once it has already run once")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4793,!this._isCanceled,"Should not schedule canceled tasks")}catch(PERR){g.reportError(PERR)}var delay=Math.max(0,this._scheduleDate.getTime()-Date.now());this._timeout=setTimeout(this.runTask,delay),!this._remoteID&&delay>0&&AccountManager.onUserAuthorized("me",function(){try{this._cbPersistRemote(this,this._onPersistedRemote)}catch(err){g.reportError(err)}}.bind(this))},_onCanceled:function _onCanceledFn(success){success&&(this._destroyed=!0,g.vmMain.deferredTaskManager._notifyTaskComplete(this._id))},_onPersistedRemote:function _onPersistedRemoteFn(success,remoteID){success&&(this._remoteID=remoteID,g.vmMain.deferredTaskManager._updateTask(this._id))},reschedule:function rescheduleFn(newScheduleDate){try{g.PAssert(4794,!this._hasRun,"Should never reschedule a task that has already run")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4795,!this._isCanceled,"Should not reschedule canceled tasks")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4796,this._timeout,"Must always have already schedule a task that is being rescheduled")}catch(PERR){g.reportError(PERR)}clearTimeout(this._timeout),this._timeout=void 0,this._scheduleDate=newScheduleDate,this.schedule()},cancel:function cancelFn(){try{g.PAssert(4797,this._timeout||this._remoteID,"Must always have already scheduled (locally or remotely) a task that is being canceled")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4798,!this._hasRun,"Should not cancel tasks that have already been run")}catch(PERR){g.reportError(PERR)}this._isCanceled=!0,clearTimeout(this._timeout),this._timeout=void 0,this._remoteID&&AccountManager.onUserAuthorized("me",function(){try{this._cbCancel(this,this._onCanceled)}catch(err){g.reportError(err)}}.bind(this)),g.vmMain.deferredTaskManager._updateTask(this._id)},runTask:function runTaskFn(){this._timeout=void 0,this._hasRun=!0;try{this._cbRun(this)}catch(err){g.reportError(err)}g.vmMain.deferredTaskManager._notifyTaskComplete(this._id)},getData:function getDataFn(){return this._data},getType:function getTypeFn(){return this._type},getScheduleDate:function getScheduleDateFn(){return this._scheduleDate},getSaveData:function getSaveDataFn(){var data={id:this._id,remoteID:this._remoteID,type:this._type,scheduleDate:this._scheduleDate,data:this._data,isCanceled:this._isCanceled};return data},isPersistedRemote:function isPersistedRemoteFn(){return!!this._remoteID}},DeferredTask}),define("DeferredTaskManager",["require","exports","module","globals","util","DeferredTask","CacheManager"],function(require,exports,module){function DeferredTaskManager(){this._taskCache=CacheManager.registerLocalCache("DeferredTasks","DeferredTasks",StorageType.LocalStorage),this._registeredTypes={},this._deferredTasks={},this._stats={},this.init()}var g=require("globals"),util=require("util"),DeferredTask=require("DeferredTask"),CacheManager=require("CacheManager");return DeferredTaskManager.prototype={init:function initFn(){this._taskCache.onCacheReady(function(){this._taskCache.loadAll(function(loadSuccess){try{g.PAssert(4799,loadSuccess,"Must be able to load task cache")}catch(PERR){g.reportError(PERR)}var tasks=this._taskCache.getFilterEntries(function(){return!0},function(tasks){for(var i=0;i<tasks.length;++i){var task=tasks[i];this.scheduleTask(task.id,task.type,new Date(task.scheduleDate),task.isCanceled,task.remoteID,task.data,!0)}}.bind(this))}.bind(this))}.bind(this))},getLastSyncDate:function getLastSyncDateFn(){var lastSync=g.settings.get(Settings.lastTaskSync);try{g.PAssert(4800,!lastSync||g.isString(lastSync),"Must have a valid string sync date")}catch(PERR){g.reportError(PERR)}return lastSync},getStats:function getStatsFn(){var outStats={};return outStats},notifyRemoteTasks:function notifyRemoteTasksFn(tasks){for(var i=0;i<tasks.length;++i)this._handleRemoteTask(tasks[i]);g.settings.set(Settings.lastTaskSync,new Date)},_handleRemoteTask:function _handleRemoteTaskFn(task){log("Remote Task: ",task),this.scheduleTask(task.data.threadID,task.type,new Date(task.data.scheduleDate),!1,task.messageID,task.data)},registerTaskType:function registerTaskTypeFn(type,cbRun,cbCancel,cbPersistRemote){try{g.PAssert(4801,!this._registeredTypes[type],"Must not double register task type")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4802,g.isFunction(cbRun),"Must register a valid run callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4803,g.isFunction(cbCancel),"Must register a valid cancel callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4804,g.isFunction(cbPersistRemote),"Must register a valid persist callback")}catch(PERR){g.reportError(PERR)}this._registeredTypes[type]={cbRun:cbRun,cbCancel:cbCancel,cbPersistRemote:cbPersistRemote}},_notifyTaskComplete:function _notifyTaskCompleteFn(id){this._removeTask(id)},scheduleTask:function scheduleTaskFn(id,type,scheduleDate,isCanceled,remoteID,data,fromLoad){try{g.PAssert(4805,id,"Must supply a valid task ID")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4806,type,"Must supply a valid task type")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4807,g.isDateValid(scheduleDate),"Must always have a valid scheduled date available")}catch(PERR){g.reportError(PERR)}this._taskCache.onCacheReady(function(){try{g.PAssert(4808,this._registeredTypes[type],"Must request a valid registered task type")}catch(PERR){g.reportError(PERR)}if(this._deferredTasks[id]){var oldTask=this._deferredTasks[id];try{g.PAssert(4809,oldTask.getType()===type,"Task types must match")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4810,oldTask.getScheduleDate().equals(scheduleDate),"Task schedule dates must match")}catch(PERR){g.reportError(PERR)}}else{var typeInfo=this._registeredTypes[type];if(typeInfo){var task=new DeferredTask(id,type,scheduleDate,isCanceled,remoteID,data,typeInfo.cbRun,typeInfo.cbCancel,typeInfo.cbPersistRemote);if(this._deferredTasks[id]){log("Overriding existing task");try{g.PAssert(4811,this._deferredTasks[id].type===type,"Should only update deferred tasks of the same type")}catch(PERR){g.reportError(PERR)}}this._addTask(id,task,fromLoad),isCanceled?task.cancel():task.schedule()}}}.bind(this))},cancelTask:function cancelTaskFn(id,type){var task=this._deferredTasks[id];task.cancel()},_updateTask:function _updateTaskFn(id){var task=this._deferredTasks[id];this._taskCache.cacheEntry(id,task.getSaveData())},_addTask:function _addTaskFn(id,task,fromLoad){this._deferredTasks[id]=task,fromLoad||this._updateTask(id)},_removeTask:function _removeTaskFn(id){this._deferredTasks[id]=void 0,this._taskCache.removeEntry(id)}},DeferredTaskManager}),define("DocManager",["require","exports","module","globals","data","util","goog","VMDocument","ObservableArray"],function(require,exports,module){function DocManager(){this._openDocuments={},this._docMap={},this._docList=new ObservableArray,this._openDoc=void 0,this._isLoading=!1,this._hasError=!1,this._loadingCallbacks=[],this.init()
}var g=require("globals"),d=require("data"),util=require("util"),goog=require("goog"),VMDocument=require("VMDocument"),ObservableArray=require("ObservableArray"),MaxFilePageRequests=12;return DocManager.prototype={init:function initFn(){},loadDocList:function loadDocListFn(cb){if(goog.isDriveAPILoaded()){if(this._loadingCallbacks.push(cb),!this._isLoading){this._isLoading=!0;var q="mimeType='"+goog.MoodoMimetype+"' and trashed=false",options={maxPageResults:999,maxPages:MaxFilePageRequests},successCB=function(results,hasMoreResults){try{g.PAssert(4812,!hasMoreResults,"Should not have additional results when requesting a file list")}catch(PERR){g.reportError(PERR)}for(var i=0;i<results.length;++i)results[i].appDataContents||this.loadDocFromData(results[i],!0,!1);this._docList.notify();for(var i=0;i<this._loadingCallbacks.length;++i)try{this._loadingCallbacks[i](!0)}catch(err){g.reportError(err)}this._isLoading=!1}.bind(this),failureCB=function(response,partialResults){this._hasError=!0;for(var i=0;i<this._loadingCallbacks.length;++i){try{this._loadingCallbacks[i](!1)}catch(err){g.reportError(err)}this._isLoading=!1}}.bind(this);g.vmMain.remoteAPI().driveFilesList(q,successCB,failureCB,options)}}else cb(!1)},loadDocFromData:function loadDocFromDataFn(data,isRemoteData,notify){try{g.PAssert(4813,data,"Must provide valid data to load doc from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4814,data.id,"Must have valid doc id in data")}catch(PERR){g.reportError(PERR)}var currentDoc=this._docMap[data.id];return currentDoc?currentDoc.updateData(data,isRemoteData):(currentDoc=new VMDocument(data,isRemoteData),this.setDoc(currentDoc,notify)),currentDoc},setDoc:function setDocFn(doc,notify){try{g.PAssert(4815,doc,"Must supply a valid doc to set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4816,!this._docMap[doc.id],"Should never override an existing doc with a new one")}catch(PERR){g.reportError(PERR)}this._docMap[doc.id]=doc,doc.isOpen()&&(this._openDoc=doc),this._docList.insertSorted(doc,this.sortFn,notify)},sortFn:function sortFnFn(left,right){return left.getTitle().localeCompare(right.getTitle())},getOpenDoc:function getOpenDocFn(){return this._openDoc},getDoc:function getDocFn(id){return this._docMap[id]},hasDoc:function hasDocFn(id){return!!this._docMap[id]},getDocList:function getDocListFn(){return this._docList},deleteDoc:function deleteDocFn(id,cb){var doc=this._docMap[id];try{g.PAssert(4817,doc,"Must be deleting a document that we know about")}catch(PERR){g.reportError(PERR)}doc.deleteData(function(success){success&&(delete this._docMap[id],this._docList.remove(doc),doc.isOpen()&&(delete this._openDocuments[id],d.clearDataAndReload(!0))),cb(success)}.bind(this))},deleteAllDocs:function deleteAllDocsFn(cb){goog.deleteAllFiles(this._docList.get(),cb)},createNewDoc:function createNewDocFn(){return new VMDocument},isLoading:function isLoadingFn(){return this._isLoading},getOpenDoc:function getOpenDocFn(){var openDoc;for(var id in this._openDocuments){openDoc=this._openDocuments[id];break}return openDoc},isDocOpen:function isDocOpenFn(id){return!!this._openDocuments[id]},setDocOpened:function setDocOpenedFn(id){try{g.PAssert(4818,id,"Must specify a valid ID when opening a doc")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4819,!this._openDocuments[id],"Document must not have already been opened")}catch(PERR){g.reportError(PERR)}var doc=this._docMap[id];try{g.PAssert(4820,doc,"Must supply a valid ID matching a created doc")}catch(PERR){g.reportError(PERR)}this._openDocuments[id]=doc},setDocClosed:function setDocClosedFn(id){var doc=this._openDocuments[id];try{g.PAssert(4821,doc,"Must have a valid opened doc")}catch(PERR){g.reportError(PERR)}delete this._openDocuments[id]}},util.defineBase(DocManager),DocManager}),define("ItemStoreManager",["globals","util","EventDispatcher","ItemStore","DuchessHelpers"],function(g,util,EventDispatcher,ItemStore,DuchessHelpers){function ItemStoreManager(){this._itemStores={},this._iteratingStores=!1,this.Events={StoreAdded:"StoreAdded",StoreRemoved:"StoreRemoved"},this.init()}var DefaultItemStoreID="DefaultStore";return window.ItemStoreFilter={None:0,Dates:1,Contacts:2,Priority:4},ItemStoreManager.prototype={init:function initFn(){var enabledFilters=ItemStoreFilter.Dates|ItemStoreFilter.Priority;defaultItemStore=this.registerItemStore(DefaultItemStoreID,void 0,{isReadonly:!1,isDestructible:!1,enabledFilters:enabledFilters}),defaultItemStore.listenToItemStateChanged()},registerItemStore:function registerItemStoreFn(id,owner,options){try{g.PAssert(4822,!this._itemStores[id],"Should only register a single item store per plugin: ",id)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4823,!this._iteratingStores,"Should never add a store while iterating")}catch(PERR){g.reportError(PERR)}var isReadonly=!0,isDestructible=!0,trackGlobally=!0,enabledFilters=ItemStoreFilter.None,parserFn=DuchessHelpers.parseText.bind(DuchessHelpers);options&&(void 0!==options.isReadonly&&(isReadonly=options.isReadonly),void 0!==options.isDestructible&&(isDestructible=options.isDestructible),void 0!==options.enabledFilters&&(enabledFilters=options.enabledFilters),void 0!==options.parserFn&&(parserFn=options.parserFn),void 0!==options.trackGlobally&&(trackGlobally=options.trackGlobally));var newStore=new ItemStore(id,isReadonly,isDestructible,trackGlobally,enabledFilters,parserFn,owner);return this._itemStores[id]=newStore,this.fireEvent(this.Events.StoreAdded,newStore.getEnabledFilters(),[newStore]),newStore},unregisterItemStore:function unregisterItemStoreFn(id){try{g.PAssert(4824,this._itemStores[id],"Must register an item store before destroying it")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4825,!this._iteratingStores,"Should never remove a store while iterating")}catch(PERR){g.reportError(PERR)}var oldStore=this._itemStores[id];delete this._itemStores[id],oldStore.destroy(),this.fireEvent(this.Events.StoreRemoved,oldStore.getEnabledFilters(),[oldStore])},getItemStore:function getItemStoreFn(id){try{g.PAssert(4826,this._itemStores[id],"Must register an item store before using it")}catch(PERR){g.reportError(PERR)}return this._itemStores[id]},getDefaultItemStore:function getDefaultItemStoreFn(){return this._itemStores[DefaultItemStoreID]},runForEachStore:function runForEachStoreFn(fn,filter){filter=filter||ItemStoreFilter.None,this._iteratingStores=!0;for(var storeID in this._itemStores){var store=this._itemStores[storeID];if(filter===ItemStoreFilter.None||store.areFiltersEnabled(filter))try{fn(store)}catch(err){g.reportError(err)}}this._iteratingStores=!1}},util.defineBase(ItemStoreManager),util.extend(ItemStoreManager.prototype,EventDispatcher),ItemStoreManager}),define("ReactWrapper",["require","globals","react","MooReact"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),ReactWrapper=MooReact.createClass({displayName:"ReactWrapper",getState:function getState(){return g.clone(this.props.observe)},render:function render(){var props=this.props,state=this.state;if(props.render)return props.render(state,props);var component=props.component||"div";return props=g.extend({style:props.renderStyle(state,props),ref:"ref"},props),React.createElement(component,props,props.children)}});return ReactWrapper}),define("ReactSearchButton",["require","exports","module","globals","platform","react","MooReact","Search"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Search=require("Search"),ReactSearchButton=MooReact.createClass({displayName:"ReactSearchButton",propTypes:{filter:React.PropTypes.object.isRequired},init:function init(){var filter=this.props.filter;this.firstValue=this.props.filterValue||filter.initialValue},onClickIcon:function onClickIcon(val){0!==val&&(this.firstValue=val),this.props.search.setFilter(this.props.filter.name,val)},render:function render(){var props=this.props,value=props.filterValue,cls=g.classNames("searchButton",{selected:!!value}),val1,yesFirst;val1=value?0:1,yesFirst=this.firstValue>0;var val2=-val1,clsIconYes=g.classNames(props.filter.icon,"yes"),clsIconNo=g.classNames(props.filter.icon,"no"),yes=React.createElement("i",{className:clsIconYes,onClick:this.onClickIcon.bind(this,1===value?0:1)},React.createElement("div",{className:"icon-minus"})),no=React.createElement("i",{className:clsIconNo,onClick:this.onClickIcon.bind(this,-1===value?0:-1)},React.createElement("div",{className:"icon-minus"}));return React.createElement("div",{className:cls},React.createElement("div",{className:"searchButtonBackground"}),yesFirst?yes:no,React.createElement("div",{className:"searchButtonExtra"},yesFirst?no:yes))}});return ReactSearchButton}),define("Components/FancyInput",["require","globals","data","platform","react","MooReact","Hotkeys","DuchessHelpers","Autocomplete","NativeSel","Autocomplete"],function(require){var g=require("globals"),d=require("data"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Hotkeys=require("Hotkeys"),DuchessHelpers=require("DuchessHelpers"),Autocomplete=require("Autocomplete"),NativeSel=require("NativeSel"),FancyInput=React.createClass({mixins:[MooReact.MooReactMixin,React.addons.PureRenderMixin],displayName:"FancyInput",propTypes:{onChange:React.PropTypes.func,id:React.PropTypes.string,className:React.PropTypes.string,value:React.PropTypes.string,mode:React.PropTypes.string,buttonText:React.PropTypes.string,onButtonClick:React.PropTypes.func,padding:React.PropTypes.object,height:React.PropTypes.number,onEscape:React.PropTypes.func},init:function init(){Autocomplete=require("Autocomplete");var obs={isFocused:this.props.focused,isComposing:!1,value:this.props.value||"",tokens:this.props.tokens||[]};this.isInput="password"===this.props.type,this.isInput||(this.html=this.parseHTML(obs.value||TextSpace)),this.props.buttonText&&(obs.isLoading=!1),this.createObservables(obs)},componentDidMount:function componentDidMount(){this.updateHTML(this.state.value,!1),this.props.focused&&(this.focus(),this.selectEnd())},onUnmount:function onUnmount(){this.isFocused.get()&&this.onBlur()},componentWillReceiveProps:function componentWillReceiveProps(nextProps){this.props.value!==nextProps.value&&nextProps.value!==this.state.value&&(this.setValue(nextProps.value,!(platform.mobile&&!g.isKeyboardOpen)),this.forceUpdate()),this.props.tokens!==nextProps.tokens&&nextProps.tokens!==this.state.tokens&&this.tokens.set(nextProps.tokens)},componentDidUpdate:function componentDidUpdate(){var dirty=this._isDirty;if(this._isDirty=void 0,dirty&&this._dirtyCallbacks){for(var i=0;i<this._dirtyCallbacks.length;i++)this._dirtyCallbacks[i]();this._dirtyCallbacks=void 0}},clearValue:function clearValue(){this.setValue("")},isButtonEnabled:function isButtonEnabled(){return void 0!==this.props.buttonEnabled?this.props.buttonEnabled:this.state.value||this.state.tokens.length>0},getValue:function getValue(){return this.value.get()},getTokens:function getTokens(){var val=this.getValue().trim(),arr=this.tokens.get();return val?arr.concat([{text:val,email:val,type:"contact"}]):arr},parseHTML:function parseHTML(value){var html;if(this.props.parse){var parsed=DuchessHelpers.parseText(value,null,null,null,null,null,d.contactManager.getContacts(),!0);this.props.onParsed&&this.props.onParsed(parsed),this.parsedEls=parsed.els,html=DuchessHelpers.generateHTML(parsed.els,!0)}else html=value&&g.escape(value).replace(/ /g,"&nbsp;");return html},addDirtyCallback:function addDirtyCallback(cb){this._dirtyCallbacks||(this._dirtyCallbacks=[]),this._dirtyCallbacks.push(cb)},focus:function focus(){this._isDirty?this.addDirtyCallback(this.focus):this.refs.input.focus()},blur:function blur(){this.refs.input.blur()},select:function select(){NativeSel.selectElement(this.refs.input)},selectEnd:function selectEnd(force){if(!force&&this._isDirty)this.addDirtyCallback(this.selectEnd);else{var text=this.refs.input.innerText;text.length>0&&text!==TextSpace&&NativeSel.selectElement(this.refs.input,text.length)}},onFocus:function onFocus(e){this.props.autocompleteMode&&Autocomplete.clearDisabled(),g.vmMain.activeInput.set(this),this.isFocused.set(!0),this.props.onEscape&&(this.__hotkeyEscape=Hotkeys.pushStackEscape(this.handleEscapeKey)),this.props.onFocus&&this.props.onFocus(e)},onBlur:function onBlur(e){g.vmMain.activeInput.set(null),this.isFocused.set(!1),this.__hotkeyEscape&&(Hotkeys.popStack(this.handleEscapeKey),this.__hotkeyEscape=void 0),this.props.onBlur&&this.props.onBlur(e)},getSelectionOffset:function getSelectionOffset(){var range=NativeSel._getSelectionRange(),offset=0;return range&&(offset=NativeSel.getSelectOffsetsInElement(this.refs.input,range).end),offset},_setSelectionOffset:function _setSelectionOffset(offset){var el,newOffset;if(offset>0){var offsetInfo=NativeSel.getOffsetChildElement(this.refs.input,offset);el=offsetInfo.element,newOffset=offsetInfo.offset}else el=this.refs.input,newOffset=0;var range=NativeSel.createFakeRange(el,newOffset,el,newOffset);try{g.PAssert(4827,range,"Range should be valid when setting selection offset")}catch(PERR){g.reportError(PERR)}range&&NativeSel.setSelectionRange(range)},setSelectionOffset:function setSelectionOffset(offset){this._setSelectionOffset(offset)},updateAutocomplete:function updateAutocomplete(){var input=this.refs.input,mode=this.props.autocompleteMode;if(mode&&!platform.mobile){var selection=NativeSel.getSelectionInElement(input);selection&&selection.start===selection.end&&Autocomplete.update({mode:mode,text:this.value.get(),offset:selection.start,owner:this,parsedEls:this.parsedEls,autocompleteOffset:this.props.autocompleteOffset,elementDisplay:this.props.autocompleteElementDisplay||this.refs.wrapper,elementInput:input,supportSearchItemAutocomplete:this.props.supportSearchItemAutocomplete})}},setValue:function setValue(value,shouldSelect,selectionOffset){this._isDirty=!0;try{g.PAssert(4828,void 0!==value,"Should not set FancyInput value to undefined")}catch(PERR){g.reportError(PERR)}value=value||"",this.updateHTML(value,shouldSelect,selectionOffset),this.value.set(value)},updateHTML:function updateHTML(value,shouldSelect,selectionOffset){var offset=selectionOffset;shouldSelect&&void 0===offset&&(offset=this.getSelectionOffset());var html=this.parseHTML(value||TextSpace);html!==this.refs.input.innerHTML&&(this.refs.input.innerHTML=html),shouldSelect&&(offset>value.length&&(offset=value.length),this.setSelectionOffset(offset))},updateTokens:function updateTokens(includeLast){for(var phrases=this.value.get().split(","),i=0;i<phrases.length-(includeLast?0:1);i++){var phrase=phrases[i].trim();phrase.length>0&&(this.tokens.push({text:phrase,email:phrase,type:"contact"}),phrases.removeAt(i--))}var value=phrases.join(",").trim();this.setValue(value,!0)},onChange:function onChange(){this.value.set(this.refs.input.value)},stripBRs:function stripBRs(element){for(var children=element.children,i=children.length-1;i>=0;i--){var c=children[i];"BR"===c.nodeName?c.remove():c.children.length>0&&this.stripBRs(c)}},onInput:function onInput(){if(!this.isComposing.get()){platform.mobile&&this.stripBRs(this.refs.input);var value=this.refs.input.textContent.replace(/\u00a0/g," ").replace(new RegExp(TextSpace,"g"),"").replace(/\n/g,"");this.setValue(value,!0),this.updateAutocomplete(),this.props.onChange&&this.props.onChange(value)}},handleEscapeKey:function handleEscapeKey(){this.props.onEscape?this.props.onEscape():this.isInput||this.select(),this.__hotkeyEscape&&(Hotkeys.popStack(this.handleEscapeKey),this.__hotkeyEscape=void 0)},onKeyDown:function onKeyDown(e){var props=this.props;this.isInput||(props.autocompleteMode&&Autocomplete.isShowing()||props.buttonText&&e.keyCode===KeyCode.Enter&&this.onButtonClick(),e.keyCode===KeyCode.BackSpace&&(!this.state.value&&this.state.tokens.length>0&&this.removeToken(this.tokens.length()-1),0===this.refs.input.textContent.length&&(this.refs.input.textContent=TextSpace)),e.keyCode===KeyCode.Tab&&Autocomplete.isShowing()&&Autocomplete.hide(),e.keyCode===KeyCode.Enter&&e.preventDefault()),props.onKeyDown&&props.onKeyDown(e)},onKeyUp:function onKeyUp(e){var props=this.props;!this.isInput&&props.autocompleteMode&&(e.keyCode===KeyCode.LeftArrow||e.keyCode===KeyCode.RightArrow)&&this.updateAutocomplete(),"email"===props.autocompleteMode&&(e.keyCode===KeyCode.Comma?this.updateTokens(!1):e.keyCode===KeyCode.Enter&&this.updateTokens(!0)),platform.mobile&&e.keyCode===KeyCode.Enter&&this.selectEnd(!0),props.onKeyUp&&props.onKeyUp(e)},onCompositionStart:function onCompositionStart(){platform.android||this.isComposing.set(!0)},onCompositionEnd:function onCompositionEnd(e){platform.android||(this.isComposing.set(!1),this.onInput(e))},onAutocompleteSelected:function onAutocompleteSelected(params){var props=this.props;void 0!==params.value&&(this.setValue(params.value,!0,params.offset),props.onChange&&props.onChange(params.value)),params.token&&this.tokens.push(params.token),props.onAutocompleteSelected&&props.onAutocompleteSelected(params)},onButtonClick:function onButtonClick(){var state=this.state;if(this.isButtonEnabled()){if(this.props.onButtonClick){var isLoading=this.props.onButtonClick(state.value,this.onButtonClickCallback);isLoading&&this.isLoading.set(!0)}Autocomplete.isShowing()&&Autocomplete.hide()}},onButtonClickCallback:function onButtonClickCallback(){this.value.set(""),this.isLoading.set(!1)},removeToken:function removeToken(index){var props=this.props,token=this.tokens.get()[index];this.tokens.removeAt(index),props.onTokenRemoved&&props.onTokenRemoved(token)},render:function render(){var state=this.state,props=this.props,floatingText,focusUnderline,paddingBottomFloating=5,padding=props.padding||{};isNaN(padding.left)&&(padding.left=8),isNaN(padding.right)&&(padding.right=8);var hasBorder=props.border!==!1,borderSize=hasBorder?2:0,cls=g.classNames("fancyInput",{hasFloatingText:!!props.floatingText},{hasButton:!!props.buttonText},{hasBorder:hasBorder},this.props.className),height=props.height||40,extraFloatingPadding=(height-40)/2,style={width:props.width,height:height,display:props.display};if(props.floatingText)padding.bottom=paddingBottomFloating+Math.min(extraFloatingPadding,2),padding.top=height-16-padding.bottom;else{var paddingAmt=(height-borderSize-16)/2;padding.top=paddingAmt,padding.bottom=paddingAmt}if(props.floatingText){var floatingStyle={marginBottom:paddingBottomFloating+extraFloatingPadding,marginLeft:padding.left,marginRight:padding.right};floatingStyle.color=state.isFocused||state.value?state.isFocused?g.colorBlue:"#ccc":"#aaa";var floatingClass=g.classNames("placeholder","noSelect",{floating:state.isFocused||state.value||state.tokens.length>0});floatingText=React.createElement("div",{className:floatingClass,style:floatingStyle},props.floatingText)}else if(props.placeholder&&!state.value&&!state.isComposing&&0===state.tokens.length){var stylePlaceholder={paddingTop:padding.top,marginLeft:padding.left,marginRight:padding.right};floatingText=React.createElement("div",{className:"placeholder noSelect",style:stylePlaceholder},props.placeholder)}if(props.floatingText){var focusUnderlineStyle={right:props.buttonText&&50};focusUnderlineStyle[platform.transform.react]=state.isFocused?"":"scale(0,1)",focusUnderline=React.createElement("div",{className:"focusUnderline",style:focusUnderlineStyle})}var button;if(props.buttonText){var classButton=g.classNames("fancyInputButton",{loading:state.isLoading},{disabled:!this.isButtonEnabled()}),styleButton={width:props.buttonWidth,lineHeight:height+"px"};button=React.createElement("span",{className:classButton,style:styleButton,onClick:this.onButtonClick},props.buttonText)}var inputClass="fancyInputInput",innerStyle={marginLeft:padding.left,marginRight:padding.right},inputStyle={paddingTop:padding.top,paddingBottom:padding.bottom},inputProps={ref:"input",className:inputClass,style:inputStyle,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onMouseDown:props.onMouseDown,autoComplete:"false",disabled:state.isLoading},input;this.isInput?(inputProps.type=props.type,inputProps.onChange=this.onChange,input=React.createElement("input",inputProps)):(inputProps.onInput=this.onInput,inputProps.contentEditable=props.readonly?null:"true",inputProps.onCompositionStart=this.onCompositionStart,inputProps.onCompositionEnd=this.onCompositionEnd,input=React.createElement("div",inputProps));var tokens=[];if(state.tokens)for(var i=0;i<state.tokens.length;i++){var token=state.tokens[i],styleToken={marginTop:padding.top-4};tokens.push(React.createElement("div",{key:"token"+i,className:"token",style:styleToken,onClick:this.removeToken.bind(this,i)},React.createElement("span",null,token.text),React.createElement("i",{className:"icon-close"})))}var clsWrap=g.classNames("fancyInputWrap",{hasTokens:tokens.length>0});return React.createElement("div",{className:cls,id:this.props.id,style:style},React.createElement("div",{className:"fancyInputContent"},React.createElement("div",{className:clsWrap,ref:"wrapper"},floatingText,React.createElement("div",{className:"fancyInputInner",style:innerStyle},tokens,React.createElement("div",{className:"fancyInputInner2"},input))),button,focusUnderline))}});return FancyInput}),define("ReactSearch",["require","exports","module","globals","data","Constants","platform","react","MooReact","VMPane","Sel","Autocomplete","MobileUI","ReactSearchButton","Components/FancyInput","Components/FancyButton"],function(require,exports,module){var g=require("globals"),d=require("data"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),Sel=require("Sel"),Autocomplete=require("Autocomplete"),MobileUI=require("MobileUI"),ReactSearchButton=require("ReactSearchButton"),FancyInput=require("Components/FancyInput"),FancyButton=require("Components/FancyButton"),ReactSearch=MooReact.createClass({displayName:"ReactSearch",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},componentDidMount:function componentDidMount(){this.props.pane.search.UI=this,this.listenTo(this.props.pane.search.onChanged),platform.mobile?(this.addTap("listTitle",this,this.onTapListTitle),this.addTap("searchInnerWrap",this,this.onTapBox)):this.forceUpdate()},getState:function getState(){for(var pane=this.props.pane,search=pane.search,state={search:search.value,paneItem:pane.item,paneTitle:pane.itemTitle()},i=0;i<search.filters.length;i++){var filter=search.filters[i];state[filter.name]=filter.value,state[filter.name+"Enabled"]=filter.enabled}return state},onChange:function onChange(value){this.props.pane.search.setValue(value)},onParsed:function onParsed(parsed){this.props.pane.search.onParsed(parsed)},setSearch:function setSearch(value,focus){this.props.pane.search.setValue(value),platform.mobile||focus===!1||this.setSelectionOffset(value.length)},getSelectionOffset:function getSelectionOffset(){return this.refs.input.getSelectionOffset()},setSelectionOffset:function setSelectionOffset(offset){this.refs.input.setSelectionOffset(offset)},onFocus:function onFocus(){var search=this.props.pane.search;search&&(this._selectionBeforeBlur=Sel.save(),Sel.reset(),search.isFocused.set(!0),g.autocomplete.hide(),platform.mobile?(g.keyboardToolbar.show(C.KeyboardToolbarMode.Search),g.sendEvent("SearchFocus","Mobile")):g.sendEvent("SearchFocus","Desktop"))},onBlur:function onBlur(){var search=this.props.pane.search;search&&search.isFocused.set(!1),platform.mobile&&g.keyboardToolbar.hide()},focus:function focus(){this.refs.input.focus(),this.refs.input.selectEnd(),this.props.pane.onBlur()},blur:function blur(){this.refs.input.blur()},onTapListTitle:function onTapListTitle(){MobileUI.toggleOverviewVisibility()},onTapBox:function onTapBox(e){platform.mobile&&(g.keyboardToolbar.preShow(),this.focus()),platform.mobile&&(g.keyboardToolbar.show(C.KeyboardToolbarMode.Search),e.preventDefault())},onTapX:function onTapX(e){var pane=this.props.pane,isMo=platform.mobile;if(this.state.search.length>0){if(!isMo)var savedSel=Sel.save();this.setSearch("",!1),!isMo&&savedSel&&pane.restoreSelection(savedSel),e.preventDefault(),g.sendEvent("Menu","ClearSearch")}else isMo?this.onTapBox(e):this.focus(),g.sendEvent("Menu","FocusSearch")},onKeyDown:function onKeyDown(e){if(this.saveScrollOfTop(),!platform.mobile){var pane=this.props.pane;if(e.keyCode===KeyCode.Enter){var search=pane.search;search.update(!0,!0),this.setSelectionOffset(this.state.search.length)}if(e.keyCode===KeyCode.Tab||e.keyCode===KeyCode.Enter){var firstIndex=pane.indexOfFirstItem();if(firstIndex>=0){var index=firstIndex,s=this._selectionBeforeBlur;s&&(Sel.restore(s)?(this._selectionBeforeBlur=void 0,index=s.startIndex):s=null),s||Sel.selectIndex(firstIndex,0),Sel.focusPane(pane),index>=0&&g.focusedPane.scrollIndexIntoView(index,ScrollDuration.Default)}else pane.type===PaneMode.Outline&&pane.addItem(e);e.preventDefault(),e.stopPropagation()}}},onToggleButton:function onToggleButton(name){this.saveScrollOfTop(),this.props.pane.search.toggleFilter(name)},setPriority:function setPriority(value){this.saveScrollOfTop();var search=this.props.pane.search;search.getFilter("priority")===value&&(value=0),search.setFilter("priority",value)},onAutocompleteSelected:function onAutocompleteSelected(params){params.item&&g.vmMain.zoomin(params.item)},saveScrollOfTop:function saveScrollOfTop(){var pane=this.props.pane;pane.getInfiniteList().saveScrollOfTop(!0)},renderSearchButton:function renderSearchButton(filter){var pane=this.props.pane;return React.createElement(ReactSearchButton,{key:filter.name,filter:filter,filterValue:filter.value,search:pane.search})},renderSearchPriority:function renderSearchPriority(){var pane=this.props.pane,prop=pane.search.filter_priority,val=prop.value,p;val&&(val===VMLIFlag.P0?p="p0":val===VMLIFlag.P1?p="p1":val===VMLIFlag.P2&&(p="p2"));var classPriorities=g.classNames("searchPriorities",p);return React.createElement("span",{key:"priority",className:classPriorities},React.createElement("span",{className:"searchPriority searchP0",onClick:this.setPriority.bind(this,VMLIFlag.P0)}),React.createElement("span",{className:"searchPriority searchP1",onClick:this.setPriority.bind(this,VMLIFlag.P1)}),React.createElement("span",{className:"searchPriority searchP2",onClick:this.setPriority.bind(this,VMLIFlag.P2)}))},render:function render(){var state=this.state,pane=this.props.pane,search=pane.search,searchValue=state.search,searchIcon=searchValue.length>0?"icon-close":"icon-search",searchColor=searchValue.length>0?"#aaa":"#ddd",headerTitle;platform.mobile&&(headerTitle=React.createElement("span",{className:"headerTitle",id:"listTitle",ref:"listTitle"},this.state.paneTitle));for(var renderedButtons=[],i=0;i<search.filters.length;i++){var filter=search.filters[i];filter.enabled.get()&&(filter.icon?renderedButtons.push(this.renderSearchButton(filter)):"priority"===filter.name&&renderedButtons.push(this.renderSearchPriority()))}var searchXSize=platform.mobile?40:30,searchX=React.createElement(FancyButton,{className:"searchX",color:searchColor,width:searchXSize,height:searchXSize,icon:searchIcon,onClick:this.onTapX});return React.createElement("div",{className:"searchWrap",ref:"searchWrap"},headerTitle,!platform.mobile&&searchX,React.createElement("div",{className:"searchInnerWrap",ref:"searchInnerWrap"},React.createElement(FancyInput,{ref:"input",className:"search",id:"search",height:30,value:searchValue,onChange:this.onChange,onKeyDown:this.onKeyDown,onFocus:this.onFocus,onBlur:this.onBlur,onParsed:this.onParsed,parse:"yes",placeholder:"Search",autocompleteMode:"all",border:!1,autocompleteElementDisplay:this.refs.searchWrap,padding:{left:0,right:0},onAutocompleteSelected:this.onAutocompleteSelected,supportSearchItemAutocomplete:pane.supportSearchItemAutocomplete})),!platform.mobile&&React.createElement("div",{className:"searchButtons"},renderedButtons),platform.mobile&&searchX)}});return ReactSearch}),define("ReactTitle",["require","globals","react","MooReact","VMPane","VMLI","Components/FancyRippler"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),VMLI=require("VMLI"),FancyRippler=require("Components/FancyRippler"),ReactTitle=MooReact.createClass({displayName:"ReactTitle",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired,item:React.PropTypes.instanceOf(VMLI).isRequired},componentDidMount:function componentDidMount(){this.listenTo(this.props.item.itemChanged)},onClick:function onClick(e){var pane=this.props.pane;g.isString(this.props.item)||pane.onClickTitle(e,this.props.item)},onDoubleClick:function onDoubleClick(e){var pane=this.props.pane;g.isString(this.props.item)||pane.onDoubleClickTitle(e,this.props.item)},render:function render(){var pane=this.props.pane,item=this.props.item,text;return text=item===g.vmMain.root()?pane.titleOfFirstItem:g.isString(item)?item:item.generateTitleText(item.getParsedText()),React.createElement(FancyRippler,{className:"titleWrapper","data-tooltip":text,onClick:this.onClick,onDoubleClick:this.onDoubleClick},React.createElement("span",{className:"title"},text))}});return ReactTitle}),define("Components/FancyContextMenu",["require","globals","Constants","platform","react","MooReact","Hotkeys"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Hotkeys=require("Hotkeys"),FancyContextMenu=MooReact.createClass({displayName:"FancyContextMenu",propTypes:{element:React.PropTypes.object,width:React.PropTypes.number,id:React.PropTypes.string,loading:React.PropTypes.bool,className:React.PropTypes.string,selected:React.PropTypes.bool,style:React.PropTypes.object,overflowHeight:React.PropTypes.string,autocompleteOffset:React.PropTypes.object,position:React.PropTypes.string},init:function init(){this.listenToDispatcher("windowResize"),this.props.supportArrows&&this.createObservables({selectedIndex:0})},getHotkeys:function getHotkeys(){var props=this.props,arr=[Hotkeys.createEscape(this.onEscapeKey)];return props.supportArrows&&(arr.push(Hotkeys.create(KeyCode.UpArrow,C.Primary.Either,C.Shift.Either,this.onUpKey)),arr.push(Hotkeys.create(KeyCode.DownArrow,C.Primary.Either,C.Shift.Either,this.onDownKey)),arr.push(Hotkeys.create(KeyCode.Enter,C.Primary.Either,C.Shift.Either,this.onEnterKey))),props.hotkeys&&(arr=arr.concat(props.hotkeys)),arr},componentDidMount:function componentDidMount(){platform.mobile||this.updateState()},getState:function getState(){var props=this.props;if(platform.mobile)return{top:this.isAtPosition("top")?g.topBarHeight:null,bottom:this.isAtPosition("bottom")?0:null};var offset=this.updateOffset();return{left:offset.left,top:offset.top,maxHeight:offset.maxHeight}},isAtPosition:function isAtPosition(pos){if(this.props.position){var position=this.props.position.split("-");if(position.indexOf(pos)>=0)return!0}return!1},onUpKey:function onUpKey(){var index=this.selectedIndex.get();index>0&&(index--,this.selectedIndex.set(index))},onDownKey:function onDownKey(){var index=this.selectedIndex.get();index<this.numItems-1&&(index++,this.selectedIndex.set(index))},onEnterKey:function onEnterKey(){var index=this.selectedIndex.get();if(index>=0){var ref=this.refs["el_"+index];ref.fireClick()}},onEscapeKey:function onEscapeKey(){g.menus.closeContextMenuReact()},onChildMouseEnter:function onChildMouseEnter(index){this.selectedIndex.set(index)},updateOffset:function updateOffset(){var props=this.props;try{g.PAssert(4829,props.element,"Context menu needs an element to open on")}catch(PERR){g.reportError(PERR)}if(props.element){var pos=props.element.getBoundingClientRect(),left=pos.left+(props.autocompleteOffset&&props.autocompleteOffset.left||0),top=pos.bottom+(props.autocompleteOffset&&props.autocompleteOffset.top||0),offset={left:left,top:top},menu=this.refs.menu;if(menu){var right=left+menu.clientWidth,bottom=top+menu.clientHeight;
right>platform.windowWidth()&&(offset.left+=platform.windowWidth()-right-8),bottom>platform.windowHeight()&&(offset.top+=platform.windowHeight()-bottom-8),(8>left||left+offset.left<8)&&(offset.left+=8-left),"shrink"===this.props.overflowHeight&&top>platform.windowHeight()-8&&(offset.maxHeight=platform.windowHeight()-top-8)}return offset}return{left:0,top:0,maxHeight:400}},render:function render(){var state=this.state,props=this.props,cls=g.classNames("fancyContextMenu",props.className,{loading:props.loading},{top:this.isAtPosition("top")},{bottom:this.isAtPosition("bottom")},{left:this.isAtPosition("left")},{right:this.isAtPosition("right")},{fill:this.isAtPosition("fill")}),styleMenu={left:state.left,top:state.top,bottom:isNaN(props.bottom)?state.bottom:props.bottom,width:props.width,maxHeight:state.maxHeight,maxWidth:props.maxWidth};platform.mobile&&this.isAtPosition("fill")&&(styleMenu.top=g.topBarHeight),styleMenu=g.extend(styleMenu,this.props.style);var childrenArr=this.props.children;if(props.supportArrows){var i=0;childrenArr=React.Children.map(this.props.children,function(el){return el&&"hr"!==el.type?React.cloneElement(el,{onMouseEnter:this.onChildMouseEnter,ref:"el_"+i,selected:platform.mobile?!1:state.selectedIndex===i++}):el}.bind(this)),this.numItems=i}return React.createElement("div",{ref:"menu",id:props.id,className:cls,style:styleMenu},childrenArr)}});return FancyContextMenu}),define("Components/FancyContextMenuItem",["require","globals","platform","react","MooReact","Components/FancyButton","Components/FancyRippler"],function(require){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),FancyButton=require("Components/FancyButton"),FancyRippler=require("Components/FancyRippler"),FancyContextMenuItem=MooReact.createClass({displayName:"FancyContextMenuItem",propTypes:{id:React.PropTypes.string,className:React.PropTypes.string,selected:React.PropTypes.bool,iconSize:React.PropTypes.number},init:function init(){this.createObservables({isHovered:!1})},closeMenu:function closeMenu(){this.props.canClose!==!1&&g.menus.closeContextMenuReact()},fireClick:function fireClick(e){var props=this.props;!this.didClickJustFire&&props.onClick&&(this.closeMenu(),props.onClick(e),this.didClickJustFire=!0,setTimeout(function(){this.didClickJustFire=!1}.bind(this),300))},onClickIcon:function onClickIcon(e){var props=this.props;props.onClickIcon?(this.closeMenu(),props.onClickIcon(e)):this.fireClick(e)},onMouseDown:function onMouseDown(e){var props=this.props;(props.onClickIcon||g.hasClass(e.target,"fancyContextMenuIcon"))&&e.preventDefault()},onMouseUp:function onMouseUp(e){var props=this.props;props.onClickIcon&&g.hasClass(e.target,"fancyContextMenuIcon")||this.fireClick(e)},onMouseEnter:function onMouseEnter(e){this.isHovered.set(!0),this.props.onMouseEnter&&this.props.onMouseEnter(e)},onMouseLeave:function onMouseLeave(){this.isHovered.set(!1)},render:function render(){var props=this.props,cls=g.classNames("fancyContextMenuItem",{selected:props.selected||props.hoverEffects!==!1&&this.state.isHovered},{disabled:props.disabled},{hasIcon:!!props.icon},{hasContent:!!props.children},{bold:props.bold},{hasHotkey:props.hotkey},this.props.className),icon;if(props.icon)if(props.onClickIcon)icon=React.createElement(FancyButton,{className:"fancyContextMenuIcon",icon:props.icon,tooltip:props.iconTooltip,width:36,onClick:this.onClickIcon});else{var classIcon=g.classNames("fancyContextMenuIcon",props.icon),styleIcon={fontSize:props.iconSize,height:props.height,lineHeight:props.height&&props.height+"px",color:props.iconColor};icon=React.createElement("span",{className:classIcon,style:styleIcon,onClick:this.onClickIcon})}var hotkey;props.hotkey&&(hotkey=React.createElement("span",{className:"fancyContextMenuHotkey"},props.hotkey));var style=props.style||{};style.height=props.height,style.lineHeight=props.height&&props.height+"px";var propsItem={className:cls,"data-tooltip":props.tooltip,onMouseOver:props.onMouseOver,style:style,ref:"element"};return props.onClick&&(propsItem.onMouseDown=props.onClick&&!platform.mobile&&this.onMouseDown,propsItem.onMouseUp=props.onClick&&!props.noMouseUp&&this.onMouseUp,propsItem.onClick=props.onClick&&(props.noMouseUp||platform.mobile)&&this.onMouseUp,propsItem.onMouseEnter=props.onClick&&!platform.mobile&&props.hoverEffects!==!1&&this.onMouseEnter,propsItem.onMouseLeave=props.onClick&&!platform.mobile&&props.hoverEffects!==!1&&this.onMouseLeave),React.createElement(props.onClick?FancyRippler:"div",propsItem,icon,props.children,hotkey)}});return FancyContextMenuItem}),define("ReactPaneHeader",["require","globals","data","Constants","platform","react","MooReact","VMPane","MobileUI","Multiselect","ReactSearch","ReactTitle","Components/FancyContextMenu","Components/FancyContextMenuItem","Components/FancyButton"],function(require){var g=require("globals"),d=require("data"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),MobileUI=require("MobileUI"),Multiselect=require("Multiselect"),ReactSearch=require("ReactSearch"),ReactTitle=require("ReactTitle"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),FancyButton=require("Components/FancyButton"),ReactPaneHeader=MooReact.createClass({displayName:"ReactPaneHeader",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired,startDragging:React.PropTypes.func},getState:function getState(){var pane=this.props.pane,state={numComplete:pane.numCompleteItems,isOverviewVisible:pane.overview.isVisible,item:pane.item,showingArchived:pane.showArchived,isSearchFocused:pane.search.isFocused};return platform.mobile?(state.topBarMode=MobileUI.topBarMode,state.numSelected=Multiselect.numSelected):state.titles=pane.getTitleList(),state},onMouseDown:function onMouseDown(e){platform.mobile||e.button!==ButtonCode.Left||this.props.startDragging(e)},onMouseDownMore:function onMouseDownMore(e){g.menus.openContextMenuReact({fn:this.renderContextMenu,element:e.target})},onTapCompose:function onTapCompose(){g.menus.openComposeEmail(g.vmMain.getDefaultEmailPlugin())},shouldShowContextMenu:function shouldShowContextMenu(){var pane=this.props.pane;return pane.supportCollapsing||pane.supportDataRefresh},clonePane:function clonePane(mode){var index=g.vmMain.paneManager.getPaneIndex(this.props.pane),params=this.props.pane.getSaveInfo();params.item=d.getModel(params.item),g.vmMain.paneManager.createPaneAtIndex(mode,index+1,params)},onTapOverviewButtonMobile:function onTapOverviewButtonMobile(){MobileUI.toggleOverviewVisibility()},onTapMoreButtonMobile:function onTapMoreButtonMobile(){g.menus.isContextMenuOpen()?g.menus.closeContextMenuReact():g.menus.openContextMenuReact({fn:this.renderContextMenuMobile})},onTapkMultiselectMobile:function onTapkMultiselectMobile(){MobileUI.setMultiselectVisibility(!0)},onTapCloseTopStatus:function onTapCloseTopStatus(){MobileUI.resetTopBarMode()},onTapSettings:function onTapSettings(){g.menus.openModal(Modals.MobileSettings)},renderContextMenuMobile:function renderContextMenuMobile(){var state=this.state,pane=this.props.pane,collapseAll;if(pane.supportCollapsing){var hasCollapsed=pane.hasCollapsed();collapseAll=React.createElement(FancyContextMenuItem,{icon:hasCollapsed?"icon-add":"icon-minus",onClick:pane.toggleCollapseAll.bind(pane)},(hasCollapsed?"Uncollapse":"Collapse")+" All Items")}return React.createElement(FancyContextMenu,{key:"contextMenuPaneHeader",position:"top-right"},pane.supportMultiselect&&React.createElement(FancyContextMenuItem,{icon:"icon-ok",onClick:this.onTapkMultiselectMobile},"Multiselect"),collapseAll,pane.supportPerformArchive&&React.createElement(FancyContextMenuItem,{icon:"icon-task",disabled:0===state.numComplete,onClick:pane.onTapArchiveCompleted.onClick.bind(pane)},"Archive Completed"))},renderContextMenu:function renderContextMenu(params){var pane=this.props.pane,collapseAll;if(pane.supportCollapsing){var hasCollapsed=pane.hasCollapsed();collapseAll=React.createElement(FancyContextMenuItem,{icon:hasCollapsed?"icon-add":"icon-minus",onClick:pane.toggleCollapseAll.bind(pane)},(hasCollapsed?"Uncollapse":"Collapse")+" All Items")}return React.createElement(FancyContextMenu,{key:"contextMenuPaneHeader",element:params.element},pane.supportDataRefresh&&React.createElement(FancyContextMenuItem,{icon:"icon-spinner",onClick:pane.onTapRefreshData.onClick.bind(pane)},"Refresh"),pane.supportReportError&&React.createElement(FancyContextMenuItem,{icon:"icon-warning",onClick:pane.onTapReportError.onClick.bind(pane)},"Report Error"),pane.supportCompose&&React.createElement(FancyContextMenuItem,{icon:"icon-envelope",onClick:this.onTapCompose},"Compose"),collapseAll,pane.supportClone&&platform.isFeatureEnabled(C.Feature.ClonePane)&&[React.createElement("hr",{key:"hr"}),React.createElement(FancyContextMenuItem,{key:"cloneOutline",icon:"icon-align-left",onClick:this.clonePane.bind(this,PaneMode.Outline)},"Clone as Outline Pane"),React.createElement(FancyContextMenuItem,{key:"cloneAgenda",icon:"icon-calendar",onClick:this.clonePane.bind(this,PaneMode.Timeline)},"Clone as Agenda Pane")])},renderTopStatus:function renderTopStatus(text){return React.createElement("div",{className:"paneHeader"},React.createElement("div",{className:"topStatus"},text),React.createElement(FancyButton,{className:"topRightButton",icon:"icon-close",color:"white",iconSize:24,width:g.topBarHeight,height:g.topBarHeight,onClick:this.onTapCloseTopStatus}))},render:function render(){var state=this.state,pane=this.props.pane,searchClass=g.classNames("searchAutocomplete","popup",{hidden:!state.isSearchFocused}),searchAutocomplete=!platform.mobile&&pane.supportSearchAutocomplete?React.createElement("div",{className:searchClass,ref:"searchAutocompleteWrap"},React.createElement("div",{className:"searchAutocompleteDefault",ref:"searchAutocomplete"},React.createElement("div",{className:"searchNegate"},React.createElement("i",null,"-"),React.createElement("div",null,"Not")),React.createElement("div",{className:"searchP2"},React.createElement("i",null," "),React.createElement("div",null,"Low")),React.createElement("div",{className:"searchP1"},React.createElement("i",null," "),React.createElement("div",null,"Med")),React.createElement("div",{className:"searchP0"},React.createElement("i",null," "),React.createElement("div",null,"High")),React.createElement("div",{className:"searchStarred"},React.createElement("i",{className:"icon-star"}),React.createElement("div",null,"Star")),React.createElement("div",{className:"searchComplete"},React.createElement("i",{className:"icon-ok"}),React.createElement("div",null,"Done")))):null;if(platform.mobile){if(state.topBarMode===C.TopBarMode.Normal){var styleSearch={left:g.topBarHeight,right:g.topBarHeight},searchDiv=React.createElement("div",{className:"searchDiv",style:styleSearch},React.createElement(ReactSearch,{pane:pane}),searchAutocomplete),leftButton,rightButton;return state.isOverviewVisible?(leftButton=React.createElement(FancyButton,{className:"topLeftButton",icon:"icon-settings",color:"white",iconSize:22,width:g.topBarHeight,height:g.topBarHeight,onClick:this.onTapSettings}),rightButton=React.createElement(FancyButton,{className:"topRightButton",icon:"icon-angle-right",color:"white",iconSize:24,width:g.topBarHeight,height:g.topBarHeight,onClick:this.onTapOverviewButtonMobile})):(leftButton=React.createElement(FancyButton,{className:"topLeftButton",icon:"icon-list",color:"white",iconSize:17,width:g.topBarHeight,height:g.topBarHeight,onClick:this.onTapOverviewButtonMobile}),rightButton=React.createElement(FancyButton,{className:"topRightButton",icon:"icon-more-vert",color:"white",iconSize:24,width:g.topBarHeight,height:g.topBarHeight,onClick:this.onTapMoreButtonMobile})),React.createElement("div",{className:"paneHeader"},searchDiv,leftButton,rightButton)}return this.renderTopStatus(state.topBarMode===C.TopBarMode.Multiselect?state.numSelected+" Selected":state.topBarMode)}return React.createElement("div",{className:"paneHeader"},React.createElement("div",{className:"paneHeaderRow",onMouseDown:this.onMouseDown},React.createElement(FancyButton,{icon:"icon-list",primary:state.isOverviewVisible,iconSize:14,margin:"6px",width:32,height:32,onClick:pane.onTapOverviewButton.bind(pane),tooltip:(state.isOverviewVisible?"Close":"Open")+" Overview"}),React.createElement(ReactSearch,{pane:pane}),React.createElement(FancyButton,{className:"paneCloseButton",icon:"icon-close",iconSize:18,margin:"6px",width:32,height:32,onClick:pane.onTapClosePane.bind(pane),tooltip:"Close Pane"})),React.createElement("div",{className:"paneHeaderRow paneHeaderRow2"},React.createElement("span",{className:"titles"},React.createElement("span",{className:"titlesInner"},state.titles.map(function(item,i){return React.createElement(ReactTitle,{key:"title_"+i,pane:pane,item:item})}))),this.getChildByKey("headerButtons"),pane.supportPerformArchive&&React.createElement(FancyButton,{icon:"icon-task",iconSize:16,width:32,height:32,className:0===state.numComplete?"disabled":null,tooltip:"Archive Completed",onClick:pane.onTapArchiveCompleted.onClick.bind(pane)}),this.shouldShowContextMenu()&&React.createElement(FancyButton,{icon:"icon-more-vert",iconSize:18,width:32,height:32,onMouseDown:this.onMouseDownMore,tooltip:"More"})))}});return ReactPaneHeader}),define("ReactMobileMultiselect",["require","globals","Constants","platform","react","MooReact","Multiselect","VMPane","tracker","MobileUI","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Multiselect=require("Multiselect"),VMPane=require("VMPane"),tracker=require("tracker"),MobileUI=require("MobileUI"),FancyButton=require("Components/FancyButton"),ReactMobileMultiselect=MooReact.createClass({displayName:"ReactMobileMultiselect",props:{pane:React.PropTypes.instanceOf(VMPane).isRequired},getState:function getState(){var MUI=MobileUI;return{offset:MUI.multiselectOffset,isAnimating:MUI.multiselectAnimate,isOpen:MUI.isInMultiselect()}},applyFn:function applyFn(firstSelected,fn,val){"zoom"===fn?(g.vmMain.zoomin(firstSelected),MobileUI.setMultiselectVisibility(!1)):(g.vmMain.beginUpdateItems(),tracker.beginAction(),Multiselect.applyFnToSelected(function(item){item.isNote()||(void 0!==val?item[fn](val,ChangeType.Local):item[fn](ChangeType.Local))},this.props.pane),tracker.endAction(),g.vmMain.commitUpdateItems()),"deleteSelf"===fn&&Multiselect.reset()},checkComplete:function checkComplete(valFirst){return!valFirst},checkStarred:function checkStarred(valFirst){return!valFirst},checkP0:function checkP0(valFirst){return valFirst===VMLIFlag.P0?VMLIFlag.None:VMLIFlag.P0},checkP1:function checkP1(valFirst){return valFirst===VMLIFlag.P1?VMLIFlag.None:VMLIFlag.P1},checkP2:function checkP2(valFirst){return valFirst===VMLIFlag.P2?VMLIFlag.None:VMLIFlag.P2},onClick:function onClick(fnCheck,fnName){var pane=this.props.pane,selectedItems=Multiselect.getSelected(pane);if(selectedItems.length>0){var firstSelected=Multiselect.getFirstSelectedItem(pane);if(firstSelected){var val;if(this[fnCheck]){var valFirst=firstSelected[fnName]();val=this[fnCheck](valFirst)}this.applyFn(firstSelected,fnName,val)}}},renderButton:function renderButton(icon,fnCheck,fnName){return React.createElement(FancyButton,{icon:icon,width:C.RightMenuWidth,height:C.RightMenuWidth,iconSize:24,onClick:this.onClick.bind(this,fnCheck,fnName)})},render:function render(){var state=this.state,cls=g.classNames("flexbox flexvert",{open:state.isOpen}),style={};return state.isOpen&&(style[platform.transform.react]="translate3d("+state.offset+"px,0,0)"),state.isAnimating&&(style[platform.transition.react]=platform.transform.style+" 0.15s"),React.createElement("div",{id:"mobileUIMultiselect",className:cls,style:style},this.renderButton("icon-ok","checkComplete","isComplete"),this.renderButton("icon-star","checkStarred","isStarred"),this.renderButton("priorityButton p0Button","checkP0","priority"),this.renderButton("priorityButton p1Button","checkP1","priority"),this.renderButton("priorityButton p2Button","checkP2","priority"),this.renderButton("icon-zoom-in",null,"zoom"),this.renderButton("icon-close",null,"deleteSelf"))}});return ReactMobileMultiselect}),define("ReactPaneMobileUI",["require","globals","Constants","react","MooReact","ReactMobileMultiselect","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),React=require("react"),MooReact=require("MooReact"),ReactMobileMultiselect=require("ReactMobileMultiselect"),FancyButton=require("Components/FancyButton"),ReactPaneMobileUI=MooReact.createClass({displayName:"ReactPaneMobileUI",getState:function getState(){var main=g.vmMain,pane=this.props.pane,state={gdriveStatus:main.gdriveStatusObs,showAddButton:pane.canAddItem},driveStatus=main.gdriveStatus();return state.onlineText=g.isDemoMode()&&"DEMO"||driveStatus===DriveStatus.Connecting&&"Connecting"||driveStatus===DriveStatus.Reconnecting&&"Connecting"||driveStatus===DriveStatus.Offline&&"OFFLINE"||"",state},switchPane:function switchPane(type){var pane=this.props.pane;pane.type!==type&&g.vmMain.togglePaneModeMobile(pane,type)},onClickAdd:function onClickAdd(e){this.props.pane.onTapAddItem(e)},renderButton:function renderButton(type,name,icon,size){return React.createElement(FancyButton,{className:"f1",icon:icon,primary:this.props.pane.type===type,color:"#777",iconSize:size,width:C.MobileBottomHeight,height:C.MobileBottomHeight,ripple:!1,onClick:this.switchPane.bind(this,type)},name)},render:function render(){var state=this.state,styleAddButton={bottom:68};return React.createElement("div",{id:"mobileUI"},React.createElement(ReactMobileMultiselect,{pane:this.props.pane}),React.createElement("div",{id:"mobileUIBottom",className:"mobileUIBottom"},state.onlineText&&React.createElement("div",{className:"mobileOnlineStatus"},state.onlineText),React.createElement("div",{id:"mobileBottomBar",className:"flexbox"},this.renderButton(PaneMode.Outline,"Outline","icon-align-left",18),this.renderButton(PaneMode.Timeline,"Agenda","icon-calendar",20))),state.showAddButton&&React.createElement(FancyButton,{icon:"icon-add",className:"mobileAddButton",width:50,height:50,color:"white",iconSize:24,style:styleAddButton,onClick:this.onClickAdd}))}});return ReactPaneMobileUI}),define("ReactHiddenInput",["require","exports","module","globals","platform","react","MooReact","VMPane"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),ReactHiddenInput=MooReact.createClass({displayName:"ReactHiddenInput",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},getState:function getState(){var pane=this.props.pane;return{position:pane.caretPosition}},getElement:function getElement(){return this.refs.hiddenInput},render:function render(){var state=this.state,position=this.state.position,style={};return position&&(style.left=position.left,style.top=position.top),React.createElement("div",{style:style,contentEditable:"true",className:"paneHiddenInput",ref:"hiddenInput"},TextSpace)}});return ReactHiddenInput}),define("ReactInfiniteList",["require","exports","module","globals","platform","data","react","MooReact","VMPane","Sel","Dispatcher","InfiniteList","DragDrop","ReactHiddenInput","Components/FancyButton"],function(require,exports,module){var g=require("globals"),platform=require("platform"),d=require("data"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),Sel=require("Sel"),Dispatcher=require("Dispatcher"),InfiniteList=require("InfiniteList"),DragDrop=require("DragDrop"),ReactHiddenInput=require("ReactHiddenInput"),FancyButton=require("Components/FancyButton"),ReactInfiniteList=MooReact.createClass({displayName:"ReactInfiniteList",propTypes:{owner:React.PropTypes.instanceOf(InfiniteList).isRequired,pane:React.PropTypes.instanceOf(VMPane).isRequired,overview:React.PropTypes.bool.isRequired,contentClass:React.PropTypes.string.isRequired,hiddenInput:React.PropTypes.bool,renderCell:React.PropTypes.func.isRequired,minItemHeight:React.PropTypes.number.isRequired},init:function init(){this.props.owner.notifyInit(this)},componentDidMount:function componentDidMount(){this.props.hiddenInput&&(this.props.pane.hiddenInput=this.refs.hiddenInput.getElement())},onUnmount:function onUnmount(){this.props.owner.notifyUnmounted()},getState:function getState(){var pane=this.props.pane,owner=this.props.owner,state={cells:owner.cellsObs,paddingBottom:pane.paddingBottom,contentHeight:owner.contentHeight,bottomListMessage:pane.bottomListMessage(),isLoadingNewPage:pane.isLoadingNewPage,isLoading:pane.isLoading,statusMessage:pane.getStatusMessage(this.props.overview),disablePointerEvents:owner.disablePointerEvents,items:owner._itemsObs};return state},isIndexMounted:function isIndexMounted(index){return!!this._getElementAtIndex(index)},_getElementAtIndex:function _getElementAtIndex(index){for(var props=this.props,state=this.state,found=!1,cellIndex,i=0;i<state.cells.length;i++){var cell=state.cells[i];if(cell.index===index){cellIndex=i;break}}var topBox=this.getChildByKey("topBox"),indexInChildren=cellIndex+(props.hiddenInput?1:0)+(topBox?1:0);return this.refs.contentElement.children[indexInChildren]},getElementAtIndex:function getElementAtIndex(index){var child=this._getElementAtIndex(index);try{g.PAssert(4830,child,"Must have a valid mounted item at index",index)}catch(PERR){g.reportError(PERR)}return child},renderItems:function renderItems(){for(var owner=this.props.owner,renderedItems=[],cells=this.state.cells,i=0;i<cells.length;i++){var c=cells[i];renderedItems.push(this.props.renderCell(i,cells[i]))}return renderedItems},render:function render(){var state=this.state,props=this.props,pane=props.pane,cls=props.contentClass,status=state.statusMessage,bottomListMessage,height=state.contentHeight+state.paddingBottom;if(!props.isLoading)if(props.owner.hasItems()){if(state.bottomListMessage&&!props.overview){var styleBottomMessage={};styleBottomMessage[platform.transform.react]="translateY("+state.contentHeight+"px)",bottomListMessage=React.createElement("div",{className:"paneBottomMessage",style:styleBottomMessage},React.createElement(FancyButton,{className:"paneDataPageLoad",height:40},state.bottomListMessage)),height+=40}}else cls+=" noItems"+(status?" displayStatus":"");var styles={pointerEvents:state.disablePointerEvents?"none":null,height:(height||200)+"px"},hiddenInput=null;props.hiddenInput&&(hiddenInput=React.createElement(ReactHiddenInput,{ref:"hiddenInput",pane:pane}));var topBox=this.getChildByKey("topBox");return React.createElement("ul",{className:cls,style:styles,spellCheck:"false",draggable:"false",ref:"contentElement","data-pane-status":status},hiddenInput,topBox,this.renderItems(),bottomListMessage)}});return ReactInfiniteList}),define("ReactCaret",["require","exports","module","globals","platform","react","MooReact","DisplaySettings","VMPane","Sel","Observable"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),DisplaySettings=require("DisplaySettings"),VMPane=require("VMPane"),Sel=require("Sel"),Observable=require("Observable"),ReactCaret=MooReact.createClass({displayName:"ReactCaret",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},init:function init(){this.createObservables({isOn:!1})},componentDidMount:function componentDidMount(){document.addEventListener("mousedown",this.setOn),document.addEventListener("mouseup",this.startAnim)},onUnmount:function onUnmount(){document.removeEventListener("mouseup",this.startAnim),document.removeEventListener("mousedown",this.setOn),clearTimeout(this.animTimeout)},getState:function getState(){var pane=this.props.pane;return{position:pane.caretPosition,isWindowFocused:Sel.isWindowFocused,activePane:Sel.pane,isPaneActive:Sel.isWindowFocused.get()&&Sel.getPane()===pane}},onAfterChanged:function onAfterChanged(state,oldState){!state.isPaneActive||state.isPaneActive===oldState.isPaneActive&&state.position===oldState.position||this.startAnim()},setOn:function setOn(){this.state.isPaneActive&&(clearTimeout(this.animTimeout),this.isOn.set(!0))},startAnim:function startAnim(){this.animTick(!0)},animTick:function animTick(on){this.state.isPaneActive&&(clearTimeout(this.animTimeout),this.isOn.set(on||!this.isOn.get()),this.animTimeout=setTimeout(this.animTick,500))},render:function render(){var state=this.state,position=this.state.position,style={};return style.opacity=state.isOn?1:0,position&&state.isPaneActive&&Sel.isValid()&&Sel.getStartItem()?(style.height=DisplaySettings.lineHeightForItem(Sel.getStartItem())-1+"px",style[platform.transform.react]="translate3d("+position.left+"px, "+position.top+"px, 0)"):(style.height="17px",style[platform.transform.react]="translate3d(-1000px, -1000px, 0)"),React.createElement("div",{className:"caret",style:style})}});return ReactCaret}),define("ReactIntroItem",["require","exports","module","globals","Constants","platform","react","MooReact"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),ReactIntroItem=MooReact.createClass({displayName:"ReactIntroItem",getState:function getState(){var item=this.props.item;return{isComplete:item.isComplete,isDisabled:item.isDisabled,isHotkeyOr:item.isHotkeyOr,text:item.text,jsx:item.jsx,isVisible:item.visibleObservable,isHidden:item.hiddenObservable}},render:function render(){var state=this.state,cls=g.classNames({checked:state.isComplete},{disabled:state.isDisabled},{hotkeyOr:state.isHotkeyOr});return state.isVisible!==!1&&state.isHidden!==!0&&React.createElement("li",{className:cls},React.createElement("span",{className:"icon-ok"}),state.text&&React.createElement("span",{dangerouslySetInnerHTML:{__html:state.text}}),state.jsx)}});return ReactIntroItem}),define("ReactIntroInPane",["require","exports","module","globals","react","MooReact","VMPane","ReactIntroItem","Components/FancyButton"],function(require,exports,module){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),ReactIntroItem=require("ReactIntroItem"),FancyButton=require("Components/FancyButton"),ReactIntroInPane=MooReact.createClass({displayName:"ReactIntroInPane",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},getState:function getState(){var type=this.props.pane.type,section=g.intro.paneIntros[type];return{section:section,isComplete:section.isComplete}},close:function close(){this.state.section.forceComplete()},render:function render(){var section=this.state.section,cls=g.classNames("introInPane",{none:this.state.isComplete});return React.createElement("div",{className:cls},React.createElement("div",{className:"intro"},React.createElement(FancyButton,{className:"paneClose",icon:"icon-close",iconSize:18,width:44,height:44,onClick:this.close,tooltip:"Close"}),React.createElement("div",{className:"helpTitle"},section.text),React.createElement("div",{className:"helpNote"},section.note),React.createElement("ul",null,section.items.map(function(item,i){return React.createElement(ReactIntroItem,{item:item,key:i})}))))}});return ReactIntroInPane}),define("CellRendererItem",["require","globals","Constants","platform","react","DisplaySettings","Sel","Multiselect","Measure","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),DisplaySettings=require("DisplaySettings"),Sel=require("Sel"),Multiselect=require("Multiselect"),Measure=require("Measure"),FancyButton=require("Components/FancyButton"),offsetFromItem=5,buttonWidth=20,renderSelection=function renderSelection(item,props,state,paddingLeft){var selection=[],pane=props.pane,spanWidth=pane.getSpanWidthForItem(item);if(state.selected){var styleSel={top:0,width:spanWidth,height:state.height};styleSel[platform.transform.react]="translateX("+paddingLeft+"px)",selection.push(React.createElement("span",{key:"selStart",className:"textSelected",style:styleSel}))}else if(void 0!==state.selectedStart){var textLength=item.getParsedText().length,isNextSelected,start=state.selectedStart,end=state.selectedEnd;0>start&&(start=0),0>end&&(end=textLength,isNextSelected=!0);var itemHeight=state.height,startPos=Measure.getCaretOffset(item,pane,start,Sel.preferLineStart),endPos=Measure.getCaretOffset(item,pane,end,Sel.preferLineStart),padTop=DisplaySettings.paddingForItemTop(item),padBottom=DisplaySettings.paddingForItemBottom(item),lineHeight=DisplaySettings.lineHeightForItem(item),multipleLines=endPos.line>startPos.line;if(startPos.lineOffset<startPos.lineLength||!multipleLines){var startTop=startPos.top,startHeight=lineHeight,width=multipleLines||isNextSelected?spanWidth-startPos.left:endPos.left-startPos.left;0===startTop?startHeight+=padTop:startTop+=padTop,startPos.top===itemHeight-lineHeight-(padTop+padBottom)&&(startHeight+=padBottom);var styleStart={top:startTop,width:width,height:startHeight};styleStart[platform.transform.react]="translateX("+(startPos.left+paddingLeft)+"px)",selection.push(React.createElement("span",{key:"selStart",className:"textSelected",style:styleStart}))}if(multipleLines){var diff=endPos.top-startPos.top,endTop=endPos.top+padTop,endHeight=lineHeight,endWidth=isNextSelected?spanWidth:endPos.left;if(diff>=2*lineHeight){var midHeight=endTop-startHeight-startTop,styleMid={top:startPos.top+padTop+lineHeight,width:spanWidth,height:midHeight};styleMid[platform.transform.react]="translateX("+paddingLeft+"px)",selection.push(React.createElement("span",{key:"selMid",className:"textSelected",style:styleMid}))}endPos.top===itemHeight-lineHeight-(padTop+padBottom)&&(endHeight+=padTop);var styleEnd={top:endTop,width:endWidth,height:endHeight};styleEnd[platform.transform.react]="translateX("+paddingLeft+"px)",selection.push(React.createElement("span",{key:"selEnd",className:"textSelected",style:styleEnd}))}}return selection},renderHtml=function renderHtml(item,props,state,paddingLeft){var lines=state.lines,pane=props.pane,overview=props.overview,width=pane.maxWidthOfItem(item),linesHtml=[];try{g.PAssert(4831,lines,"If an item is being rendered it must have styled lines")}catch(PERR){g.reportError(PERR)}if(lines){try{g.PAssert(4832,!isNaN(paddingLeft),"Should always have a valid number for padding")}catch(PERR){g.reportError(PERR)}var height=DisplaySettings.lineHeightForItem(item)+"px",style={width:width,lineHeight:height,height:height},styleLine;if(platform.isFirefox||props.padInsteadOfTransformLines?(style.marginLeft=paddingLeft,style.paddingLeft=0):style[platform.transform.react]="translateX("+paddingLeft+"px)",overview){var tooltip;style.width=C.OverviewWidth-paddingLeft-g.scrollbarWidth,style.paddingTop=DisplaySettings.paddingForItemTop(item),style.paddingBottom=DisplaySettings.paddingForItemBottom(item),linesHtml.push(React.createElement("span",{className:"line last",key:"line_0",style:style,dangerouslySetInnerHTML:{__html:lines[0]||TextSpace},"data-tooltip":tooltip}))}else if(width<g.MinItemWidth)linesHtml.push(React.createElement("span",{className:"line last",key:"line_0",style:style,dangerouslySetInnerHTML:{__html:"..."}}));else if(item.isNote())styleLine=g.extend({paddingTop:DisplaySettings.paddingForItemTop(item),paddingBottom:DisplaySettings.paddingForItemBottom(item)},style),linesHtml.push(React.createElement("span",{className:"line last",key:"line_0",style:styleLine,dangerouslySetInnerHTML:{__html:lines[0]||TextSpace}}));else for(var i=0;i<lines.length;++i)styleLine=g.extend({paddingTop:0===i?DisplaySettings.paddingForItemTop(item):0,paddingBottom:i===lines.length-1?DisplaySettings.paddingForItemBottom(item):0},style),linesHtml.push(React.createElement("span",{className:"line"+(i===lines.length-1?" last":""),key:"line_"+i,style:styleLine,dangerouslySetInnerHTML:{__html:lines[i]||TextSpace}}))
}return linesHtml},renderVertLines=function renderVertLines(item,props,state,paddingLeft){if(!props.inAutocomplete&&state.showVerticalLines){var left=DisplaySettings.itemIndentStart(props.pane)-offsetFromItem-buttonWidth/2,width=paddingLeft-left;if(width>0&&(!state.showBullets||width>DisplaySettings.itemIndentSize())){var vertLinesStyle={left:left,width:width};return React.createElement("div",{className:"vertLines",style:vertLinesStyle})}}},renderBullet=function renderBullet(item,props,state,paddingLeft){if(!props.inAutocomplete&&!props.isInDragDrop&&state.showBullets&&state.lines.length>0){var bulletClass=g.classNames("bullet"),height=Measure.lineItemHeight(item,1),bulletStyle={height:height,lineHeight:height+"px"};return bulletStyle[platform.transform.react]="translateX("+(paddingLeft-buttonWidth-offsetFromItem)+"px)",React.createElement("div",{className:bulletClass,style:bulletStyle})}},renderCollapser=function renderCollapser(item,props,state,paddingLeft){var overview=props.overview,pane=props.pane;if(!props.isInDragDrop&&(state.isCollapsed||!platform.mobile&&state.isHovered)&&(!overview||0!==state.levelsDeep)){var isHeader=state.isHeader,supportCollapsing=(pane.supportCollapsing||overview)&&!state.isOverviewAncestor&&!state.isOverviewFocused,collapserClass=g.classNames("collapser",{collapsed:supportCollapsing&&isHeader&&state.isCollapsed},{"icon-caret-down":supportCollapsing&&isHeader&&!state.isCollapsed},{"icon-caret-right":supportCollapsing&&isHeader&&state.isCollapsed}),collapserStyle={width:paddingLeft-offsetFromItem-(state.showBullets?buttonWidth:0)};return React.createElement("div",{className:collapserClass,style:collapserStyle})}},renderCheckbox=function renderCheckbox(item,props,state){var checkbox,overview=props.overview,pane=props.pane;if(!props.isInDragDrop&&!platform.mobile){var checkboxClass;overview||item.isNote()?overview&&state.isHovered&&pane.supportClickOverviewScroll&&(checkboxClass=g.classNames("itemCheckbox","itemOverviewZoom","icon-zoom-in"),checkbox=React.createElement("div",{className:checkboxClass,"data-tooltip":"Zoom In"})):pane.supportCompleting&&state.isHovered?(checkboxClass=g.classNames("itemCheckbox","icon-ok",{checked:item.isComplete()}),checkbox=React.createElement("div",{className:checkboxClass})):pane.supportArchiving&&item.isArchived()&&(checkboxClass=g.classNames("itemCheckbox","itemUnarchive","icon-task"),checkbox=React.createElement("div",{"data-tooltip":"Unarchive",className:checkboxClass}))}return checkbox},renderContext=function renderContext(item,props,state,paddingLeft){var pane=props.pane,context;if(!platform.mobile&&pane.type===PaneMode.Timeline&&state.isHovered&&state.isHoveredLong){var parentText=g.parentTextForItem(item);context=parentText&&React.createElement("div",{className:"itemContext"},parentText)}return context},CellRendererItem={onMount:function onMount(item,index,props,state){var pane=props.pane,overview=props.overview,field=overview?PerPaneStateField.NumLinesOverview:PerPaneStateField.NumLines;this.listenTo(item.itemChanged),pane.setPerPaneState(item.id,field,state.lines.length),pane&&!overview&&item.onLoad(pane),this.setData(this.refs.li,item)},getState:function getState(item,index,props){var pane=props.pane,overview=props.overview,state={flags:item.flags,levelsDeep:item.levelsDeep,styleProps:item.styleProps(pane),draggedInPane:item.draggedInPane,metrics:item.metricsInPane(pane,overview),isHoveredItem:Sel.isItemHovered(item),isHovered:Sel.isReactCellHovered(this),showBullets:!platform.mobile&&!overview&&pane.supportBullets&&!item.isNote()&&g.settings.get(Settings.showBullets,Settings.UISettingsGroup),showVerticalLines:!platform.mobile&&!overview&&pane.supportVertLines&&g.settings.get(Settings.showVerticalLines,Settings.UISettingsGroup),isSelected:!overview&&pane===g.focusedPane&&Multiselect.isSelected(index,pane),isCollapsed:item.isCollapsed(pane,overview),isHighlighted:item.isHighlighted};if(state.lines=state.metrics.styledLines,!overview){state.selected=state.selectedText=state.selectedStart=state.selectedEnd=void 0;var isSelected=Sel.isSelected(index,pane);if(isSelected){var selection=Sel.getSelectionAtIndex(index);selection===!0?state.selected=!0:selection.start!==selection.end&&(state.selectedStart=selection.start,state.selectedEnd=selection.end)}else state.selectedText=void 0;item.isNote()&&(state.parentFlags=item.parent().flags),platform.ios&&(state.isEditable=item.isEditable)}if(overview){if(platform.mobile){var paneItem=pane.item.get();state.isOverviewAncestor=paneItem.isDescendantOf(item)}else state.isOverviewAtTop=pane.getOverview().isItemAtTop(item),state.isOverviewDragHover=pane.getOverview().isItemDragHovered(item);state.isOverviewFocused=pane.getItem()===item}return state.isHeader=pane.isItemHeader(item,overview),state},render:function render(id,item,index,props,state,style,cls,swipeMenu){var pane=props.pane,overview=props.overview,isEditable=pane.isWriteable&&platform.ios&&state.isEditable?!0:null,paddingLeft=pane.getPaddingForItem(item,overview)+(props.paddingOffset?props.paddingOffset:0),liClassName=g.classNames("item",cls,state.styleProps,{overviewItem:overview},{overviewAncestor:overview&&state.isOverviewAncestor},{overviewFocused:overview&&state.isOverviewFocused},{overviewAtTop:overview&&state.isOverviewAtTop},{overviewDragHover:overview&&state.isOverviewDragHover},{collapsed:state.isCollapsed},{itemBeingDragged:state.draggedInPane===pane},{hovered:state.isHoveredItem&&!props.inAutocomplete&&!props.isInDragDrop},{faded:state.faded},{selected:state.isSelected},{highlighted:state.isHighlighted&&pane!==g.focusedPane});return React.createElement("li",{"data-moo-id":id,className:liClassName,style:style,ref:"li",contentEditable:isEditable},renderHtml(item,props,state,paddingLeft),renderVertLines(item,props,state,paddingLeft),renderCollapser(item,props,state,paddingLeft),renderBullet(item,props,state,paddingLeft),renderCheckbox(item,props,state),!overview&&(state.selected||void 0!==state.selectedStart)&&renderSelection(item,props,state,paddingLeft),renderContext(item,props,state,paddingLeft),swipeMenu)}};return CellRendererItem}),define("CellRendererAgendaHeader",["require","globals","react"],function(require){var g=require("globals"),React=require("react"),CellRendererAgendaHeader={onMount:function onMount(item,index,props){this.listenTo(props.pane.dragHoveredBlock)},getState:function getState(item,index,props){return{isHovered:props.cell.paneObject.block===props.pane.dragHoveredBlock.get()}},render:function render(id,item,index,props,state,style){var block=item.block,cls=g.classNames("dateHeader",{starredBlock:block.isStarred},{importantBlock:block.isImportant},{todayBlock:block.isToday},{nowBlock:block.isNow},{overdueBlock:block.isOverdue},{showLine:block.showLine},{hovered:this.state.isHovered});return React.createElement("li",{ref:"li","data-moo-id":id,className:cls,style:style},block.text)}};return CellRendererAgendaHeader}),define("CellRendererAgendaEmpty",["require","globals","react"],function(require){var g=require("globals"),React=require("react"),CellRendererAgendaEmpty={render:function render(id,item,index,props,state,style){var cls=g.classNames("agendaEmpty",props.className);return React.createElement("li",{ref:"li","data-moo-id":id,className:cls,style:style},item.text)}};return CellRendererAgendaEmpty}),define("CellRendererHR",["require","globals","react"],function(require){var g=require("globals"),React=require("react"),CellRendererHR={render:function render(id,item,index,props,state,style){var cls=g.classNames("hr",props.className);return React.createElement("li",{"data-moo-id":id,className:cls,style:style},item.text)}};return CellRendererHR}),define("CellRendererAgendaTime",["require","globals","react"],function(require){var g=require("globals"),React=require("react"),CellRendererAgendaTime={render:function render(id,item,index,props,state,style){var cls=g.classNames("timelineItemHeader",{pComplete:item.isComplete});return React.createElement("li",{ref:"li","data-moo-id":id,className:cls,style:style},item.text)}};return CellRendererAgendaTime}),define("ReactCell",["require","globals","Constants","platform","react","MooReact","InfiniteListCell","CellRendererItem","CellRendererAgendaHeader","CellRendererAgendaEmpty","CellRendererHR","CellRendererAgendaTime"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),InfiniteListCell=require("InfiniteListCell"),CellRendererItem=require("CellRendererItem"),CellRendererAgendaHeader=require("CellRendererAgendaHeader"),CellRendererAgendaEmpty=require("CellRendererAgendaEmpty"),CellRendererHR=require("CellRendererHR"),CellRendererAgendaTime=require("CellRendererAgendaTime"),ReactCell=React.createClass({mixins:[MooReact.MooReactMixin,React.addons.PureRenderMixin],displayName:"ReactCell",propTypes:{cell:React.PropTypes.instanceOf(InfiniteListCell).isRequired},init:function init(){this.DISABLE_LISTENER_ASSERT=!0,this.allowTransition=this.props.cell.isLive,this.createObservables({isHoveredLong:!1})},getState:function getState(props){var cell=props.cell,obj=cell.paneObject,item=obj,r;cell.isLive&&(r=this._getRenderer(),item=this._getRenderObj());var state={isLive:cell.isLive,item:item,index:cell.index,height:cell.height,offset:cell.offset,prevOffset:cell.prevOffset,renderer:r,offsetX:cell.offsetX,isAnimatingOffsetX:cell.isAnimatingOffsetX,faded:!1};return cell.isLive&&r&&r.getState&&(state=g.extend(state,r.getState.call(this,item,cell.index,this.props))),state},componentDidMount:function componentDidMount(){this.listenTo(this.props.cell.cellChanged,!1),g.setReactCell(this,this.__id),this._onMount()},onBeforeChanged:function onBeforeChanged(newState,oldState){this.allowTransition=newState.isLive&&this.props.cell.wasLive,newState.item!==oldState.item&&this.refreshListeners(),platform.mobile||this.props.pane.type===PaneMode.Timeline&&newState.isHovered!==oldState.isHovered&&(newState.isHovered?setTimeout(function(){this.state.isHovered&&this.isHoveredLong.set(!0)}.bind(this),C.TooltipDelay):(this.isHoveredLong.set(!1,!1),newState.isHoveredLong=!1))},componentDidUpdate:function componentDidUpdate(prevProps,prevState){var state=this.state,item=state.item,prev=prevState.item;item!==prev&&(prev&&(this.clearData(),prevState.renderer&&prevState.renderer.onUnmount&&prevState.renderer.onUnmount.call(this)),this._onMount())},_onMount:function _onMount(){var item=this.state.item,r=this.state.renderer;item&&r&&r.onMount&&r.onMount.call(this,item,this.state.index,this.props,this.state)},onUnmount:function onUnmount(){this.__id&&g.clearReactCell(this,this.__id)},_getRenderer:function _getRenderer(){var cell=this.props.cell,obj=cell.paneObject,r;return g.isVMLI(obj)?r=CellRendererItem:"agendaItem"===obj.type?r=CellRendererItem:"agendaHeader"===obj.type?r=CellRendererAgendaHeader:"agendaTime"===obj.type?r=CellRendererAgendaTime:"agendaEmpty"===obj.type?r=CellRendererAgendaEmpty:"hr"===obj.type&&(r=CellRendererHR),r},_getRenderObj:function _getRenderObj(){var cell=this.props.cell,obj=cell.paneObject;return"agendaItem"===obj.type?obj.item:obj},_getCellState:function _getCellState(){var state=this.state,ret={cell:this.props.cell.getState(),reactCell:{item:state.item.id,index:state.index,height:state.height,offset:state.offset,prevOffset:state.prevOffset,isLive:state.isLive}};return this.refs.li&&(ret.element=g.getElementPath(this.refs.li)),ret},getIndex:function getIndex(){try{g.PAssert(4834,this.state.isLive,"Should never get the index of a dead cell",this.state.isLive?void 0:this._getCellState())}catch(PERR){g.reportError(PERR)}return this.state.index},getItem:function getItem(){try{g.PAssert(4835,this.state.isLive,"Should never get the index of a dead cell",this.state.isLive?void 0:this._getCellState())}catch(PERR){g.reportError(PERR)}return this.state.item},getCell:function getCell(){return this.props.cell},renderSwipeMenu:function renderSwipeMenu(item,x){var pane=this.props.pane,style={left:(x>0?"-":"")+"100%"},styleIcon={},menu=pane.getSwipeMenuItem(item,x);if(menu){styleIcon[x>0?"right":"left"]=16;var icon=g.isFunction(menu.icon)?menu.icon(item):menu.icon,color=g.isFunction(menu.color)?menu.color(item):menu.color;return style.background=color,React.createElement("div",{className:"itemSwipeMenu",style:style},icon&&React.createElement("div",{className:"itemSwipeIcon "+icon,style:styleIcon}))}},render:function render(){var props=this.props,state=this.state,offset=state.isLive?state.offset:-1e3,id=this.getUniqueID(),r=state.renderer,animMode=g.vmMain.getItemAnimationMode(),style={height:state.height},cls=g.classNames({transition:this.allowTransition&&animMode!==C.ItemAnimationMode.None});if(state.offsetX?style[platform.transform.react]="translate3d("+state.offsetX+"px,"+offset+"px,0)":(state.isAnimatingOffsetX&&(style[platform.transition.react]=platform.transform.style+" 0.15s"),style[platform.transform.react]="translate(0,"+offset+"px)"),r&&state.isLive){var isSwiping=!!state.offsetX;return r.render.call(this,id,state.item,state.index,props,state,style,cls,isSwiping&&this.renderSwipeMenu(state.item,state.offsetX))}return React.createElement("li",{"data-moo-id":id,className:"item dead",style:style})}});return ReactCell}),define("ReactMobileFilterBar",["require","globals","react","MooReact","VMPane","Components/FancyButton"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),FancyButton=require("Components/FancyButton"),ReactMobileFilterBar=MooReact.createClass({displayName:"ReactMobileFilterBar",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},init:function init(){this.listenTo(this.props.pane.search.onChanged)},getState:function getState(){for(var search=this.props.pane.search,state={},i=0;i<search.filters.length;i++){var filter=search.filters[i];state[filter.name]=filter.value}return state},openMobileFilterMenu:function openMobileFilterMenu(){g.menus.openContextMenuReact({componentName:"ReactContextMenuMobileFilter",position:"top-right",pane:this.props.pane})},renderSearchButton:function renderSearchButton(filter){var value=filter.value,cls=g.classNames("searchFilterButton selected",{yes:value>0},{no:0>value});return React.createElement("div",{key:filter.name,className:cls},0>value&&React.createElement("i",{className:"icon-minus"}),React.createElement("i",{className:filter.icon}))},renderSearchPriorityButton:function renderSearchPriorityButton(filter){var value=filter.value,cls=g.classNames("searchPriorityButton",{p0:value===VMLIFlag.P0},{p1:value===VMLIFlag.P1},{p2:value===VMLIFlag.P2},{selected:value===filter.value});return React.createElement("div",{key:filter.name,className:cls})},render:function render(){for(var props=this.props,search=props.pane.search,renderedButtons=[],i=0;i<search.filters.length;i++){var filter=search.filters[i];filter.enabled.get()&&filter.value&&(filter.icon?renderedButtons.push(this.renderSearchButton(filter)):"priority"===filter.name&&renderedButtons.push(this.renderSearchPriorityButton(filter)))}return React.createElement("div",{className:"mobileFilterBar flexbox"},this.getChildByKey("headerButtons"),React.createElement("div",{className:"f1"}),React.createElement(FancyButton,{icon:0===renderedButtons.length?"icon-filter":null,iconSize:14,fontSize:14,height:40,onClick:this.openMobileFilterMenu},renderedButtons,React.createElement("span",{className:"text"},"Filter")))}});return ReactMobileFilterBar});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("Components/FancyScroller",["require","exports","module","globals","platform","react","Observable","MooReact"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),Observable=require("Observable"),MooReact=require("MooReact"),MinHeight=30,FancyScroller=MooReact.createClass({displayName:"FancyScroller",init:function init(){var props=this.props;try{g.PAssert(4836,!(props.noOwnScroll&&props.onScroll),"FancyScroller can not have onScroll prop if it does not own its own scroll")}catch(PERR){g.reportError(PERR)}if(!platform.mobile){var obs={isVisible:!1,isDragging:!1,thumbTop:0,thumbHeight:0};this.props.trackHasScrolled&&(obs.hasScrolled=!1),this.createObservables(obs)}},componentDidMount:function componentDidMount(){this.refs.thumb&&this.addTap("thumb",this,this.onTapThumb)},onUnmount:function onUnmount(){this.timeoutShow&&(clearTimeout(this.timeoutShow),this.timeoutShow=void 0),this.timeoutHide&&(clearTimeout(this.timeoutHide),this.timeoutHide=void 0)},getScrollHeight:function getScrollHeight(){return this.props.getScrollHeight?this.props.getScrollHeight():this.refs.scroller.scrollHeight},getClientHeight:function getClientHeight(){return this.props.getClientHeight?this.props.getClientHeight():this.refs.scroller.clientHeight},getScrollTop:function getScrollTop(){return this.props.getScrollTop?this.props.getScrollTop():this.refs.scroller.scrollTop},calculateThumb:function calculateThumb(){var props=this.props,scrollHeight=this.getScrollHeight(),clientHeight=this.getClientHeight(),scrollTop=this.getScrollTop(),thumbTop,thumbHeight;if(scrollHeight===clientHeight)thumbTop=0,thumbHeight=clientHeight;else{thumbHeight=clientHeight/scrollHeight*clientHeight,this.thumbExtraHeight=MinHeight>thumbHeight?MinHeight-thumbHeight:0,thumbHeight=Math.max(thumbHeight,MinHeight);var thumbTopPerc=scrollTop/(scrollHeight-clientHeight);thumbTop=thumbTopPerc*(clientHeight-thumbHeight)}var notify=thumbHeight!==this.thumbHeight.get()||thumbTop!==this.thumbTop.get();this.thumbHeight.set(thumbHeight,!1),this.thumbTop.set(thumbTop,notify)},onScroll:function onScroll(e){this.handleScroll(),this.props.onScroll&&this.props.onScroll(e)},handleScroll:function handleScroll(){this.isMouseDown||(this.calculateThumb(),this.isVisible.set(!0),this.hideTimeout()),this.props.trackHasScrolled&&this.hasScrolled.set(this.getScrollTop()>0)},onMouseMove:function onMouseMove(e){this.timeoutHide&&(clearTimeout(this.timeoutHide),this.timeoutHide=void 0)},onMouseEnter:function onMouseEnter(e){var scroller=this.refs.scroller;scroller.scrollHeight>scroller.clientHeight&&(this.timeoutShow&&clearTimeout(this.timeoutShow),this.timeoutShow=setTimeout(this.showScrollbar,100))},onMouseLeave:function onMouseLeave(e){this.timeoutShow&&(clearTimeout(this.timeoutShow),this.timeoutShow=void 0),this.isMouseDown||this.hideTimeout()},onTapThumb:{onStart:function onStart(e){e.button===ButtonCode.Left&&(this.isMouseDown=!0,this.lastY=e.clientY,g.disableMouseMove=!0,this.isDragging.set(!0)),e.stopPropagation()},onMove:function onMove(e){if(this.isMouseDown){var target=this.refs.scroller,yDiff=e.clientY-this.lastY;this.lastY=e.clientY;var top=g.clamp(this.thumbTop.get()+yDiff,0,target.clientHeight-this.thumbHeight.get());this.thumbTop.set(top);var scrollPos=top/(target.clientHeight-this.thumbExtraHeight)*target.scrollHeight;target.scrollTop=scrollPos,e.preventDefault()}},onEnd:function onEnd(e){this.isMouseDown&&e.button===ButtonCode.Left&&(this.isMouseDown=!1,g.disableMouseMove=!1,this.isDragging.set(!1),this.hideTimeout())}},hideTimeout:function hideTimeout(){this.timeoutHide&&clearTimeout(this.timeoutHide),this.timeoutHide=setTimeout(this.hideScrollbar,500)},hideScrollbar:function hideScrollbar(){this.isVisible.set(!1),this.timeoutHide=void 0},showScrollbar:function showScrollbar(){this.calculateThumb(this.refs.scroller),this.isVisible.set(!0),this.timeoutShow=void 0},getElement:function getElement(){return this.refs.element},getScrollElement:function getScrollElement(){return platform.mobile?this.getElement():this.refs.scroller},scrollTo:function scrollTo(x,y,duration){isNaN(duration)&&(duration=ScrollDuration.Default),g.scrollTo(x,y,duration,this.refs.scroller)},render:function render(){var state=this.state,scrollable=this.props.scrollable!==!1&&!g.noScrollbars,cls=g.classNames("fancyScroller",this.props.className,{flexbox:!platform.mobile},{trackHasScrolled:this.props.trackHasScrolled},{scrolled:state.hasScrolled}),clsScrollbar=g.classNames("fancyScrollbar",{visible:state.isVisible},{dragging:state.isDragging}),clsThumb=g.classNames("fancyScrollbarThumb",{dragging:state.isDragging}),styleThumb={height:state.thumbHeight};styleThumb[platform.transform.react]="translate3d(0,"+state.thumbTop+"px,0)";var clsContent=g.classNames("fancyScrollContent",{scrollable:scrollable});return platform.mobile?React.createElement("div",_extends({},this.props,{className:cls,ref:"element","data-moo-id":this.getUniqueID()}),this.props.children):React.createElement("div",_extends({},this.props,{className:cls,ref:"element"}),React.createElement("div",{className:clsContent,ref:"scroller",onScroll:!this.props.noOwnScroll&&this.onScroll,"data-moo-id":this.getUniqueID()},this.props.children),!platform.isFirefox&&scrollable&&React.createElement("div",{className:clsScrollbar,ref:"scrollbar",onMouseMove:this.onMouseMove,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},React.createElement("div",{className:clsThumb,style:styleThumb,ref:"thumb"})))}});return FancyScroller}),define("ReactPane",["require","globals","Constants","platform","react","MooReact","VMPane","Dispatcher","DragDrop","ReactWrapper","ReactPaneHeader","ReactPaneMobileUI","ReactInfiniteList","ReactCaret","ReactIntroInPane","ReactCell","ReactMobileFilterBar","Components/FancyScroller","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),Dispatcher=require("Dispatcher"),DragDrop=require("DragDrop"),ReactWrapper=require("ReactWrapper"),ReactPaneHeader=require("ReactPaneHeader"),ReactPaneMobileUI=require("ReactPaneMobileUI"),ReactInfiniteList=require("ReactInfiniteList"),ReactCaret=require("ReactCaret"),ReactIntroInPane=require("ReactIntroInPane"),ReactCell=require("ReactCell"),ReactMobileFilterBar=require("ReactMobileFilterBar"),FancyScroller=require("Components/FancyScroller"),FancyButton=require("Components/FancyButton"),ReactPane=MooReact.createClass({displayName:"ReactPane",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},init:function init(){this.createObservables({dragOffset:0})},componentDidMount:function componentDidMount(){var pane=this.props.pane,scrollElement=pane.scrollElement=this.refs.scroller.getScrollElement(),root=pane.rootElement=this.refElement("rootElement"),contentElement=pane.paneContent=this.refElement("contentElement"),infiniteList=pane.getInfiniteList(!1);pane.element=this.refs.pane,infiniteList.setupScroller(scrollElement,contentElement),platform.mobile||infiniteList.setScrollHandler(this.onScroll),root.addEventListener("textInput",pane.textInput),root.addEventListener("compositionstart",pane.compositionStart),root.addEventListener("compositionend",pane.compositionEnd),this.setData(pane.element,pane),g.setupClick(this.refs.scroller.getElement(),pane,pane.onTap),pane.onLoad(),Dispatcher.fireEvent("paneAdded",[pane])},getState:function getState(){var props=this.props,pane=props.pane,main=g.vmMain,state={rect:pane.rect,left:pane.rect.get().left,isExpanded:!platform.mobile&&pane.isExpanded,hasOverviewOpened:pane.overview.hasOpened,isOverviewVisible:pane.overview.isVisible,isNotReady:pane.isNotReady,item:pane.item,paneTopText:pane.paneTopText,showAddButton:pane.canAddItem};return platform.mobile?state.numComplete=pane.numCompleteItems:(state.parents=pane.getItem().parents(),state.cursor=pane.cursor),state},itemsObs:function itemsObs(){return this.props.pane.items},getScrollHeight:function getScrollHeight(){var infiniteList=this.props.pane.getInfiniteList(!1);return infiniteList.getScrollHeight()},getClientHeight:function getClientHeight(){return this.props.pane.getHeight()},getScrollTop:function getScrollTop(){var infiniteList=this.props.pane.getInfiniteList(!1);return infiniteList.getScrollTop()},onScroll:function onScroll(){this.refs.scroller&&this.refs.scroller.handleScroll()},startDragging:function startDragging(e){g.hasClass(e.target,"paneHeaderRow")&&g.vmMain.paneManager.paneCount()>1&&(this.hasMovedDrag=!1,this.dragStartX=e.clientX-this.props.pane.rect.get().left,document.addEventListener("mousemove",this.onDragMove),document.addEventListener("mouseup",this.onDragUp))},onDragMove:function onDragMove(e){this.hasMovedDrag||(this.hasMovedDrag=!0,DragDrop.isDraggingPane.set(!0),g.addClass(this.refs.pane,"dragging"));var rect=this.props.pane.rect.get(),offset=e.clientX-this.dragStartX-rect.left;this.updateDragOffset(offset),g.vmMain.paneManager.dragPaneTo(this.props.pane,rect.left+offset,rect.right+offset)&&this.updateDragOffset(e.clientX-this.dragStartX-this.props.pane.rect.get().left)},onDragUp:function onDragUp(){DragDrop.isDraggingPane.set(!1),g.removeClass(this.refs.pane,"dragging"),document.removeEventListener("mousemove",this.onDragMove),document.removeEventListener("mouseup",this.onDragUp),this.updateDragOffset(0)},updateDragOffset:function updateDragOffset(x){this.dragOffset.set(x)},renderScrollerWrapper:function renderScrollerWrapper(state,props){if(platform.mobile){var opacity=.5*state.offsetX/(platform.windowWidth()*C.MobileOverviewWidth),style={position:"relative"},offsetX=.94*Math.round(state.offsetX);isNaN(opacity)&&(opacity=0);var styleDarken={opacity:opacity};return offsetX&&(style[platform.transform.react]="translate3d("+offsetX+"px,0,0)"),this.props.pane.isAnimatingOffset&&(style[platform.transition.react]=platform.transform.style+" 0.15s",styleDarken[platform.transition.react]="opacity 0.15s"),React.createElement("div",{className:"f1 flexbox flexvert",style:style},props.children,React.createElement("div",{className:"mobilePaneDarken",style:styleDarken}))}return React.createElement("span",null,props.children)},renderCell:function renderCell(index,cell){var pane=this.props.pane;return React.createElement(ReactCell,{key:index,pane:pane,cell:cell})},render:function render(){var props=this.props,state=this.state,pane=props.pane,topBox,help,paneClass=g.classNames("pane",pane.paneClass,props.className,{overviewOpen:state.isOverviewVisible},{expanded:state.isExpanded},{hasTitles:platform.mobile?!1:state.parents.length>0},{"flexbox flexvert":platform.mobile}),paneScrollerClass=g.classNames("paneScroller",{customScroller:pane.useCustomScroller},"f1"),paneRootClass=g.classNames("paneRoot",{isNotReady:state.isNotReady}),paneContentClass=g.classNames("paneContent",{editable:pane.isWriteable}),paneRootStyle={cursor:state.cursor};pane.topBoxHeight.get()>0&&(platform.mobile?topBox=React.createElement(ReactMobileFilterBar,{pane:this.props.pane}):pane.isWriteable&&pane.canAddItem?topBox=React.createElement(FancyButton,{width:"100%",iconSize:20,display:"block",icon:"icon-add",className:"addItemButton",tooltip:"Add Item",ref:"addItemButton"}):state.paneTopText&&(topBox=React.createElement("span",{className:"loadingText"},state.paneTopText)));var list=React.createElement(ReactInfiniteList,{owner:pane.getInfiniteList(!1),pane:pane,overview:!1,renderCell:this.renderCell,itemsObs:props.itemsObs,hiddenInput:!platform.mobile,contentClass:paneContentClass,minItemHeight:props.minItemHeight,welcome:this.getChildByKey("welcome"),ref:"contentElement"},pane.topBoxHeight.get()>0&&React.createElement("div",{key:"topBox",className:"paneTopBox"},topBox)),caret=!platform.mobile&&pane.isWriteable?React.createElement(ReactCaret,{pane:pane}):null,rect=state.rect,stylePane={width:rect.width};platform.mobile||(platform.isFirefox&&!g.isRunningScript()?(stylePane.left=state.left,state.dragOffset&&(stylePane[platform.transform.react]="translate3d("+state.dragOffset+"px,0,0)")):stylePane[platform.transform.react]="translate3d("+(state.left+(state.dragOffset||0))+"px,0,0)"),!platform.mobile&&pane.shouldShowHelp()&&(help=React.createElement(ReactIntroInPane,{pane:pane}));var wrapperObserve={};return platform.mobile&&(wrapperObserve.offsetX=pane.offsetX),React.createElement("div",{key:"pane","data-moo-id":this.getUniqueID(),ref:"pane",className:paneClass,style:stylePane},React.createElement(ReactPaneHeader,{pane:pane,startDragging:this.startDragging},this.getChildByKey("headerButtons")),React.createElement(ReactWrapper,{observe:wrapperObserve,render:this.renderScrollerWrapper},React.createElement(FancyScroller,{className:paneScrollerClass,getScrollHeight:this.getScrollHeight,getClientHeight:this.getClientHeight,getScrollTop:this.getScrollTop,noOwnScroll:!0,ref:"scroller"},React.createElement("div",{className:paneRootClass,ref:"rootElement",style:paneRootStyle},list,caret)),platform.mobile&&React.createElement(ReactPaneMobileUI,{pane:pane})),help,this.getChildByKey("overlay"))}});return ReactPane}),define("ReactPaneList",["require","exports","module","globals","react","MooReact","VMPane","ReactPane","ReactCell"],function(require,exports,module){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),ReactPane=require("ReactPane"),ReactCell=require("ReactCell"),ReactPaneList=MooReact.createClass({displayName:"ReactPaneList",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},render:function render(){return React.createElement(ReactPane,{pane:this.props.pane,renderCell:this.renderCell,minItemHeight:g.minItemHeight})}});return ReactPaneList}),define("ReactItem",["require","globals","react","MooReact","VMPane","VMLI","CellRendererItem"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),VMLI=require("VMLI"),CellRendererItem=require("CellRendererItem"),ReactItem=MooReact.createClass({displayName:"ReactItem",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired,item:React.PropTypes.instanceOf(VMLI).isRequired,index:React.PropTypes.number.isRequired},getState:function getState(){var props=this.props;return CellRendererItem.getState.call(this,props.item,props.index,props)},render:function render(){var props=this.props;return CellRendererItem.render.call(this,this.getUniqueID(),props.item,props.index,props,this.state,null,null)}});return ReactItem}),define("ReactDayPreview",["require","exports","module","Constants","globals","react","MooReact","International","VMPane","DragDrop","ReactItem","Components/FancyScroller","Components/FancyButton"],function(require,exports,module){var C=require("Constants"),g=require("globals"),React=require("react"),MooReact=require("MooReact"),International=require("International"),VMPane=require("VMPane"),DragDrop=require("DragDrop"),ReactItem=require("ReactItem"),FancyScroller=require("Components/FancyScroller"),FancyButton=require("Components/FancyButton"),ReactDayPreview=React.createClass({mixins:[MooReact.MooReactMixin,React.addons.PureRenderMixin],displayName:"ReactDayPreview",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired,date:React.PropTypes.instanceOf(Date)},init:function init(){this.createObservables({hoveredTime:void 0,hoveredDuration:void 0})},componentDidMount:function componentDidMount(){var pos=g.position(this.refs.block_8);this.refs.scroller.scrollTo(0,pos.top-16,ScrollDuration.Snap)},getState:function getState(){return{paneItems:this.props.pane.items}},componentDidUpdate:function componentDidUpdate(prevProps,prevState){this.props.date!==prevProps.date&&(this.hoveredDuration.set(void 0,!1),this.hoveredTime.set(void 0))},onMouseUp:function onMouseUp(time,e){this.hoveredDuration.set(void 0,!1),this.hoveredTime.set(void 0)},onMouseEnter:function onMouseEnter(e){this.props.pane.retainOverlayAfterDrop.set(!0)},onMouseLeave:function onMouseLeave(e){this.props.pane.retainOverlayAfterDrop.set(!1)},onMouseEnterBlock:function onMouseEnterBlock(time,e){if(DragDrop.isDragging){var duration=1,item=DragDrop.dragItem;item&&item.getDuration()&&(duration=item.getDuration()/C.MSPerHour),this.hoveredDuration.set(duration,!1),this.hoveredTime.set(time);
var date=this.props.date.clone();date.setHours(Math.floor(time)),date.setMinutes(Math.floor(time)===time?0:30),DragDrop.setAgendaInfo({date:date,dateTime:date,duration:1!==duration?duration:null,isDate:!0})}},onMouseEnterAllDay:function onMouseEnterAllDay(e){if(DragDrop.isDragging){var date=this.props.date;this.hoveredDuration.set(1,!1),this.hoveredTime.set(-1),DragDrop.setAgendaInfo({date:date,isDate:!0})}},renderItemAtTime:function renderItemAtTime(key,duration,item,isPlaceholder){var style={height:200*duration+"%"},cls=g.classNames("dayTimeBlock f1",{placeholder:isPlaceholder});return React.createElement("div",{className:cls,key:key,style:style},item&&React.createElement(ReactItem,{key:item.id,index:0,item:item,pane:this.props.pane,inAutocomplete:!0}))},renderItemsAtTime:function renderItemsAtTime(items,hour,startMinutes,endMinutes){var arr=[],hovTime=this.state.hoveredTime;if(!isNaN(hovTime)&&Math.floor(hovTime)===hour&&(Math.floor(hovTime)===hovTime?0===startMinutes:30===startMinutes)){var hovDur=this.state.hoveredDuration;arr.push(this.renderItemAtTime("placeholder",hovDur,null,!0))}for(var i=0;i<items.length;i++){var date=items[i].date()||items[i].repeatDate();if(date.hasTimeOfDay()&&date.getHours()===hour){var m=date.getMinutes();if(m>=startMinutes&&endMinutes>=m){var dur=items[i].getDuration()?items[i].getDuration()/C.MSPerHour:1;arr.push(this.renderItemAtTime(i,dur,items[i]))}}}return arr},renderItemsAllDay:function renderItemsAllDay(items){for(var arr=[],i=0;i<items.length;i++){var date=items[i].date()||items[i].repeatDate();if(!date.hasTimeOfDay()){var item=items[i];arr.push(React.createElement("div",{className:"dayTimeBlock",key:i},React.createElement(ReactItem,{key:item.id,index:i,item:item,pane:this.props.pane,inAutocomplete:!0})))}}var hovTime=this.state.hoveredTime;return!isNaN(hovTime)&&0>hovTime&&arr.push(React.createElement("div",{className:"dayTimeBlock placeholder",key:"placeholder"})),React.createElement("div",{className:"allDay",onMouseEnter:this.onMouseEnterAllDay},React.createElement("span",{className:"time"},"All day"),React.createElement("ul",{className:"f1"},arr))},renderBlock:function renderBlock(matches,i){var itemsHour=this.renderItemsAtTime(matches,i,0,29),itemsHalf=this.renderItemsAtTime(matches,i,30,59),time=i%12;return 12===i?time="Noon":(time=0===i?12:i%12,time+=" "+(i>=12?"PM":"AM")),React.createElement("div",{key:i,ref:"block_"+i},React.createElement("span",{className:"time"},time),React.createElement("span",{className:"hourBlock"},React.createElement("div",{className:"flexbox",onMouseEnter:this.onMouseEnterBlock.bind(this,i)},itemsHour),React.createElement("div",{className:"flexbox",onMouseEnter:this.onMouseEnterBlock.bind(this,i+.5)},itemsHalf)))},render:function render(){var state=this.state,date=this.props.date,showYear=date.getYear()!==Date.today().getYear(),title=date.toString("ddd MMM d"),matches=[];g.searchVMLIs({itemStoreFilter:ItemStoreFilter.Dates,comparator:function comparator(item){return item.isOnDate(date)},each:function each(item){matches.push(item)}});for(var times=[],allDay=this.renderItemsAllDay(matches),i=0;24>i;i++)times.push(this.renderBlock(matches,i));return React.createElement("div",{className:"dayPreviewWrapper",onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},React.createElement("div",{className:"dayPreview flexbox flexvert",onMouseUp:this.onMouseUp},React.createElement("div",{className:"dayTitle"},title),allDay,React.createElement(FancyScroller,{ref:"scroller",className:"dayPreviewTimes f1",trackHasScrolled:!0},times)))}});return ReactDayPreview}),define("ReactAgendaOverlay",["require","exports","module","Constants","globals","react","MooReact","VMPane","DragDrop","ReactDayPreview","Components/FancyScroller","Components/FancyButton"],function(require,exports,module){var C=require("Constants"),g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),DragDrop=require("DragDrop"),ReactDayPreview=require("ReactDayPreview"),FancyScroller=require("Components/FancyScroller"),FancyButton=require("Components/FancyButton"),ReactAgendaOverlay=React.createClass({mixins:[MooReact.MooReactMixin,React.addons.PureRenderMixin],displayName:"ReactAgendaOverlay",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},init:function init(){this.listenToDispatcher("windowResize"),this.props.pane.dragHoveredBlock.listen(this.onDragHoveredBlockChanged),this.createObservables({hoveredDate:null}),this.hoveredDate.listen(function(value){this.hoveredDateIsDate=g.isDateValid(value)}.bind(this))},getState:function getState(){var pane=this.props.pane;return{paneIsBig:pane.getWidth()>520}},onDragHoveredBlockChanged:function onDragHoveredBlockChanged(block,oldBlock){this.hoveredDate.set(block?block.isDate?block.date:block.text:null)},onMouseEnterDate:function onMouseEnterDate(date,showText,e){this.props.pane.revertDrag(),this.hoveredDate.set(date);var info={};showText?g.isString(date)?(info.date=date.toLowerCase(),info.isDate=!0):(info.date=date,info.isDate=!0):"STARRED"===date?info.isStarred=!0:info[date]=date,DragDrop.setAgendaInfo(info)},onMouseLeave:function onMouseLeave(e){this.hoveredDate.set(null),this.props.pane.revertDrag()},renderDate:function renderDate(key,date,cls,text){var state=this.state,isDate=g.isDateValid(date),hoveredDate=state.hoveredDate,isHovered=hoveredDate&&(isDate&&this.hoveredDateIsDate?date.equals(hoveredDate):date===hoveredDate);return isHovered&&(cls+=" hovered"),React.createElement("div",{key:key,className:cls,onMouseEnter:this.onMouseEnterDate.bind(this,date,text&&date)},text)},render:function render(){for(var state=this.state,pane=this.props.pane,dates=[this.renderDate(0,Date.today(),"today","TODAY")],i=1;30>i;i++){var date=Date.today().addDays(i);dates.push(this.renderDate(i,date,"",date.toString("ddd M/d")))}var soft=["NOW","NEXT","SOON","LATER"];state.paneIsBig&&soft.push("SOMEDAY");for(var softDates=[],i=0;i<soft.length;i++){var date=soft[i];softDates.push(this.renderDate(date,date,"soft "+date,date))}for(var pri=["STARRED","p0","p1","p2"],i=0;i<pri.length;i++){var date=pri[i];softDates.push(this.renderDate(date,date,date,!1))}var dayPreview,times=[];return state.hoveredDate&&this.hoveredDateIsDate&&(dayPreview=React.createElement(ReactDayPreview,{date:state.hoveredDate,pane:this.props.pane})),React.createElement("div",{className:"paneOverlay agendaOverlay flexbox",onMouseLeave:this.onMouseLeave},React.createElement("div",{className:"agendaOverlayLeft f1 flexbox"},React.createElement("div",{className:"agendaOverlaySoftDates flexbox"},softDates),React.createElement("div",{className:"agendaOverlaySpacer"}),dayPreview),React.createElement(FancyScroller,{className:"agendaOverlayDates"},dates))}});return ReactAgendaOverlay});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("Components/FancyCalendarDay",["require","Constants","globals","react","MooReact","Components/FancyButton"],function(require){var C=require("Constants"),g=require("globals"),React=require("react"),MooReact=require("MooReact"),FancyButton=require("Components/FancyButton"),FancyCalendarDay=MooReact.createClass({displayName:"FancyCalendarDay",propTypes:{day:React.PropTypes.number.isRequired},render:function render(){return React.createElement(FancyButton,_extends({},this.props,{className:"fancyCalendarDay",padding:0,tooltip:"Goto Today",icon:"icon-calendar-o"}),this.props.day)}});return FancyCalendarDay}),define("ReactPaneAgenda",["require","exports","module","Constants","globals","react","MooReact","platform","VMPane","ReactPane","ReactAgendaOverlay","Components/FancyCalendarDay","Components/FancyButton"],function(require,exports,module){var C=require("Constants"),g=require("globals"),React=require("react"),MooReact=require("MooReact"),platform=require("platform"),VMPane=require("VMPane"),ReactPane=require("ReactPane"),ReactAgendaOverlay=require("ReactAgendaOverlay"),FancyCalendarDay=require("Components/FancyCalendarDay"),FancyButton=require("Components/FancyButton"),buttonHeight=30,ReactPaneAgenda=MooReact.createClass({displayName:"ReactPaneAgenda",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},init:function init(){this.listenToDispatcher("dateChanged")},getState:function getState(){var pane=this.props.pane;return{viewMode:pane.viewMode,isShowingOverlay:pane.isShowingOverlay,date:(new Date).getDate()}},onClickViewMode:function onClickViewMode(mode){var pane=this.props.pane;g.vmMain.setItemAnimationMode(C.ItemAnimationMode.None),pane.viewMode.set(mode),platform.mobile?g.vmMain.resetItemAnimationMode():(pane.scrollToToday(ScrollDuration.Snap),requestAnimationFrame(function(){pane.scrollToToday(ScrollDuration.Snap),g.vmMain.resetItemAnimationMode()}))},onClickToday:function onClickToday(){this.props.pane.scrollToToday(ScrollDuration.Default)},renderHeaderButton:function renderHeaderButton(mode,width){var style=mode===this.state.viewMode?{color:"#222"}:{fontWeight:"normal",color:"#aaa",lineHeight:buttonHeight+2+"px"};return React.createElement(FancyButton,{key:mode,height:buttonHeight,width:width,padding:0,style:style,onClick:this.onClickViewMode.bind(this,mode)},mode)},render:function render(){return React.createElement(ReactPane,{pane:this.props.pane,itemsObs:this.itemsObs,minItemHeight:20},React.createElement("span",{key:"headerButtons"},this.renderHeaderButton(C.AgendaViewMode.Day,46),this.renderHeaderButton(C.AgendaViewMode.Week,56),this.renderHeaderButton(C.AgendaViewMode.All,40),React.createElement(FancyCalendarDay,{day:this.state.date,height:buttonHeight,onClick:this.onClickToday})),!platform.mobile&&this.state.isShowingOverlay&&!g.isDemoRunning&&React.createElement(ReactAgendaOverlay,{key:"overlay",pane:this.props.pane}))}});return ReactPaneAgenda}),define("Components/FancyContextMenuHeader",["require","react","MooReact"],function(require){var React=require("react"),MooReact=require("MooReact"),FancyContextMenuHeader=MooReact.createClass({displayName:"FancyContextMenuHeader",render:function render(){return React.createElement("div",{className:"fancyContextMenuItem fancyContextMenuHeader"},this.props.children)}});return FancyContextMenuHeader}),define("plugins/ReactPaneGmail",["require","globals","Constants","react","MooReact","VMPane","EmailPreview","ReactPane","Components/FancyContextMenu","Components/FancyContextMenuHeader","Components/FancyContextMenuItem","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),EmailPreview=require("EmailPreview"),ReactPane=require("ReactPane"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuHeader=require("Components/FancyContextMenuHeader"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),FancyButton=require("Components/FancyButton"),ReactPaneGmail=MooReact.createClass({displayName:"ReactPaneGmail",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},componentDidMount:function componentDidMount(){this.listenTo(this.props.pane.search.onChanged)},getState:function getState(){var pane=this.props.pane;return{rootItem:pane.item,messages:EmailPreview.messages,isActivePane:EmailPreview.activePane===pane,searchCategory:pane.search.getFilter("category"),sortType:pane.sortType}},onClickCategoryButton:function onClickCategoryButton(e){g.menus.openContextMenuReact({fn:this.renderContextMenuCategory,element:e.target})},onHoldSortButton:function onHoldSortButton(e){g.menus.openContextMenuReact({fn:this.renderContextMenuSort,element:e.target})},onClickSortButton:function onClickSortButton(){var pane=this.props.pane,newSort=pane.sortType.get()===C.GmailSortType.Priority?C.GmailSortType.TimeReceived:C.GmailSortType.Priority;this.switchSort(newSort),g.menus.closeContextMenuReact()},switchCategory:function switchCategory(name){this.props.pane.search.setFilter("category","All"===name?"":name)},switchSort:function switchSort(name){var pane=this.props.pane;pane.sortType.set(name),pane.updateItems(!1,!0)},renderContextMenuCategory:function renderContextMenuCategory(params){for(var pane=this.props.pane,plugin=pane.plugin,accountID=plugin.getDefaultAccount(),categories=["All",plugin.SystemLabels.CATEGORY_PERSONAL,plugin.SystemLabels.CATEGORY_SOCIAL,plugin.SystemLabels.CATEGORY_PROMOTIONS,plugin.SystemLabels.CATEGORY_UPDATES,plugin.SystemLabels.CATEGORY_FORUMS],buttons=[],i=0;i<categories.length;i++){var cat=categories[i],name;if("All"===cat)name=cat;else{var label=plugin._getLabelByID(accountID,cat);name=label.getDisplayText()}buttons.push(React.createElement(FancyContextMenuItem,{key:i,onClick:this.switchCategory.bind(this,name)},name))}return React.createElement(FancyContextMenu,{key:"contextMenuGmailCategory",id:"contextMenuGmailCategory",element:params.element},buttons)},renderContextMenuSort:function renderContextMenuSort(params){return React.createElement(FancyContextMenu,{key:"contextMenuGmailCategory",id:"contextMenuGmailCategory",element:params.element},React.createElement(FancyContextMenuHeader,null,"Sort by"),React.createElement(FancyContextMenuItem,{icon:"icon-access_time",onClick:this.switchSort.bind(this,C.GmailSortType.TimeReceived)},C.GmailSortType.TimeReceived),React.createElement(FancyContextMenuItem,{icon:"icon-exclamation",onClick:this.switchSort.bind(this,C.GmailSortType.Priority)},C.GmailSortType.Priority))},renderCategoryButton:function renderCategoryButton(){var cat=this.state.searchCategory,text=cat?cat:"All";return React.createElement(FancyButton,{key:"category",height:30,onMouseDown:this.onClickCategoryButton},text,React.createElement("i",{className:"icon-caret-down"}))},renderSortButton:function renderSortButton(){var icon="Time"===this.state.sortType?"icon-access_time":"icon-exclamation";return React.createElement(FancyButton,{key:"sort",tooltip:"Sort Order",icon:icon,width:32,height:32,onHold:this.onHoldSortButton,onClick:this.onClickSortButton})},render:function render(){var pane=this.props.pane,plugin=pane.plugin,rootItem=pane.getActualPaneItem(),label=plugin.getLabelForVMLI(rootItem);return React.createElement(ReactPane,{key:"pane",pane:this.props.pane,minItemHeight:g.minItemHeight},React.createElement("span",{key:"headerButtons"},label.isInbox()&&this.renderCategoryButton(),this.renderSortButton()))}});return ReactPaneGmail}),define("ReactDragDrop",["require","exports","module","globals","platform","react","MooReact","Observable","DragDrop","ReactItem"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Observable=require("Observable"),DragDrop=require("DragDrop"),ReactItem=require("ReactItem"),ReactDragDrop=MooReact.createClass({displayName:"ReactDragDrop",getState:function getState(){var d=DragDrop,val={items:d.draggingItems,activePane:d.activePane,pane:d.startPane,position:d.position,transform:d.transform,isVisible:d.isVisible,linePosition:d.linePosition};return val},render:function render(){var state=this.state,pane=state.pane,items=state.items;if(pane&&state.isVisible){var dragItems=null;if(items&&items.length>0&&state.position&&state.transform){for(var paddingOffset=platform.mobile?0:-(pane.getPaddingForItem(items[0],!1)-g.overviewPaddingStart),renderedItems=[],numItems=Math.min(items.length,10),i=0;numItems>i;++i)renderedItems.push(React.createElement(ReactItem,{key:"drag_"+i,pane:pane,item:items[i],index:i,paddingOffset:paddingOffset,padInsteadOfTransformLines:!0,isInDragDrop:!0}));var numMore=items.length-numItems;numMore>0&&renderedItems.push(React.createElement("div",{className:"dotdotdot",key:"dotdotdot"},"... plus "+numMore+" more ..."));var ulPos=state.position,styleUL={left:platform.mobile?0:ulPos.left-paddingOffset,top:ulPos.top},transform=state.transform;styleUL[platform.transform.react]="translate3d("+transform.left+"px, "+transform.top+"px, 0)",dragItems=React.createElement("ul",{id:"dragUL",style:styleUL},renderedItems)}var dragLine=null;if(state.linePosition&&state.activePane){var styleLine={},linePos=state.linePosition;styleLine[platform.transform.react]="translate("+linePos.left+"px, "+linePos.top+"px) scale("+linePos.width+",1)",dragLine=React.createElement("div",{id:"dragLine",style:styleLine})}var cls=g.classNames("from_"+pane.type,state.activePane.paneClass);return React.createElement("div",{id:"dragdrop",className:cls},dragItems,dragLine)}return null}});return ReactDragDrop}),define("VMPane_Autocomplete",["require","exports","module","globals","util","VMPane"],function(require,exports,module){function VMPane_Autocomplete(){var p={id:"paneAutocomplete",rect:{width:400}};this._super.constructor.call(this,p)}var g=require("globals"),util=require("util"),VMPane=require("VMPane"),VMPane_AutocompleteFns={getPaddingForItem:function getPaddingForItemFn(item,overview){return 16},maxWidthOfItem:function maxWidthOfItemFn(item,overview){var padding=this.getPaddingForItem(item,overview);return this.getWidth()}};return util.inherit(VMPane,VMPane_Autocomplete),util.extend(VMPane_Autocomplete.prototype,VMPane_AutocompleteFns),VMPane_Autocomplete}),define("ReactAutocomplete",["require","exports","module","globals","data","platform","react","react-dom","MooReact","Autocomplete","ReactItem","VMPane_Autocomplete","Components/FancyButton","Components/FancyInput","Components/FancyScroller","Components/FancyContextMenu","Components/FancyContextMenuItem","Autocomplete"],function(require,exports,module){var g=require("globals"),d=require("data"),platform=require("platform"),React=require("react"),ReactDOM=require("react-dom"),MooReact=require("MooReact"),Autocomplete=require("Autocomplete"),ReactItem=require("ReactItem"),VMPane_Autocomplete=require("VMPane_Autocomplete"),FancyButton=require("Components/FancyButton"),FancyInput=require("Components/FancyInput"),FancyScroller=require("Components/FancyScroller"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),ReactAutocomplete=MooReact.createClass({displayName:"ReactAutocomplete",propTypes:{elementDisplay:React.PropTypes.object.isRequired,elementInput:React.PropTypes.object,mode:React.PropTypes.string,owner:React.PropTypes.object},init:function init(){var props=this.props;Autocomplete=require("Autocomplete"),this.createObservables({selectedIndex:props.elementInput?0:-1,expanded:!1}),props.elementInput&&props.elementInput.addEventListener("keydown",this.onInputKeyDown),this.pane=new VMPane_Autocomplete;var owner},componentDidMount:function componentDidMount(){if(!this.props.elementInput){var input=this.refs.input;input.focus(),input.updateAutocomplete()}},onUnmount:function onUnmount(){var props=this.props;props.elementInput&&props.elementInput.removeEventListener("keydown",this.onInputKeyDown)},onBeforeChanged:function onBeforeChanged(state,oldState){var refs=this.refs;if(state.matches!==oldState.matches&&!state.hasSpecialMatches){this.expanded.set(!1,!1),state.expanded=!1;var index=!refs.input||!this.props.allowCustom&&refs.input.getValue()&&this.state.matches.length>0?0:-1;this.selectedIndex.set(index,!1),state.selectedIndex=index}},onAfterChanged:function onAfterChanged(state,oldState){state.matches.length>oldState.matches.length&&setTimeout(function(){this.refs.contextMenu&&this.refs.contextMenu.updateState()}.bind(this),0)},getState:function getState(){var special=this.getSpecialMatches(),state={matches:special||Autocomplete.matches,hasSpecialMatches:!!special};return state},updateTextFromIndex:function updateTextFromIndex(){if(!this.props.elementInput){var input=this.refs.input,index=this.selectedIndex.get(),text="";if(index>=0){var match=this.state.matches[index];text=this.getInsertText(match)}input.setValue(text),input.selectEnd()}},onInputKeyDown:function onInputKeyDown(e){var state=this.state,props=this.props;if(props.allowCustom&&e.keyCode===KeyCode.Enter)this.onSelected(),e.preventDefault(),e.stopPropagation();else if(state.matches.length>0){var index=this.selectedIndex.get();if(e.keyCode===KeyCode.DownArrow||e.keyCode===KeyCode.UpArrow){if(e.keyCode===KeyCode.UpArrow?(index--,index<(props.allowCustom?-1:0)&&(index=state.matches.length-1)):e.keyCode===KeyCode.DownArrow&&(index++,index>state.matches.length-1&&(index=props.allowCustom?-1:0)),index!==this.selectedIndex.get()&&(this.selectedIndex.set(index),this.updateTextFromIndex(),index>=0)){var item=this.refs["item_"+this.selectedIndex.get()];try{g.PAssert(4837,item,"Item must exist in autocomplete to be scrolled to")}catch(PERR){g.reportError(PERR)}if(item){var element=ReactDOM.findDOMNode(item);g.scrollIntoView(element,ScrollDuration.Default)}}e.preventDefault()}else e.keyCode===KeyCode.RightArrow?this.expanded.set(index):e.keyCode===KeyCode.Enter&&index>=0&&(this.onSelected(),e.preventDefault(),e.stopPropagation())}},onEscapeKey:function onEscapeKey(){this.hide(!0)},hide:function hide(fromEscape){Autocomplete.hide(fromEscape)},onMouseOver:function onMouseOver(index,e){this.selectedIndex.set(index)},onClick:function onClick(index,e){this.updateTextFromIndex(),this.onSelected()},onButtonClick:function onButtonClick(){this.onSelected()},onSelected:function onSelected(){var props=this.props,results,match,params={};if(props.allowCustom)(props.allowEmpty||this.refs.input.getValue())&&(match={text:this.refs.input.getValue()});else var index=this.selectedIndex.get(),match=this.state.matches[index];match&&("contact"===match.type&&"email"===this.props.mode?(results=Autocomplete.insertMatch(""),params.token=match):"item"===match.type?(results=Autocomplete.insertMatch(""),params.item=match.item):results=Autocomplete.insertMatch(this.getInsertText(match)),results&&(params.value=results.text,params.offset=results.offset),props.owner?props.owner.onAutocompleteSelected(params):props.onSelected&&props.onSelected(params),this.hide())},componentWillReceiveProps:function componentWillReceiveProps(nextProps){this.props.elementInput!==nextProps.elementInput&&(this.props.elementInput.removeEventListener("keydown",this.onInputKeyDown),nextProps.elementInput.addEventListener("keydown",this.onInputKeyDown))},getInsertText:function getInsertText(obj){var mode=this.props.mode;return"email"===mode?obj.text+" <"+obj.email+">":"snooze"===obj.type?obj.insertText:obj.text},insertHighlight:function insertHighlight(text){var arr=[],searchText=Autocomplete.getText(),matchIndex=text.toUpperCase().indexOf(searchText.toUpperCase());return matchIndex>=0&&searchText.length>0?(matchIndex>0&&arr.push(text.substr(0,matchIndex)),arr.push(React.createElement("span",{key:"match",className:"ac-match"},text.substr(matchIndex,searchText.length))),text.length>matchIndex+searchText.length&&arr.push(text.substr(matchIndex+searchText.length))):arr=text,arr},onClickExpand:function onClickExpand(index,e){this.expanded.set(index),e.stopPropagation()},onSelectedAddChild:function onSelectedAddChild(e){var props=this.props,state=this.state,index=state.expanded,match=state.matches[index];if(props.onSelected){var params={item:match.item,subItemText:this.refs.inputAdd.getValue()};props.onSelected(params)}},getSpecialMatches:function getSpecialMatches(){if("snooze"===this.props.mode){var time=new Date,timeHours=time.getHours(),timeDay=time.getDay(),timeLater=time.clone().clearTime().addHours(Math.min(timeHours+3,23+59/60)),timeTonight=time.clone().clearTime();timeTonight.addHours(18>timeHours?19:Math.min(timeHours+2,23+59/60));var timeWeekend=time.clone().clearTime();6>timeDay?timeWeekend.addDays(6-time.getDay()).addHours(9):6===timeDay?timeWeekend.addDays(1).addHours(9):timeWeekend.addHours(Math.min(timeHours+3,23+59/60));var timeWeek=time.clone().clearTime();timeDay>0?timeWeek.addDays(8-time.getDay()).addHours(9):timeWeek.addDays(1).addHours(9);var timeTomMorn=time.clone().clearTime().addDays(1).addHours(9),timeTomNight=time.clone().clearTime().addDays(1).addHours(19);return[{type:"snooze",icon:"icon-access_time",iconColor:"#f30",text:"Later Today",insertText:"Today "+timeLater.toString("h:mm tt"),date:timeLater,showDay:!1},{type:"snooze",icon:"icon-access_time",iconColor:"#fa0",text:"Tonight",insertText:"Today "+timeTonight.toString("h:mm tt"),date:timeTonight,showDay:!1},{type:"snooze",icon:"icon-access_time",iconColor:"#fd0",text:"Tomorrow Morning",insertText:"Tomorrow "+timeTomMorn.toString("h:mm tt"),date:timeTomMorn,showDay:!0},{type:"snooze",icon:"icon-access_time",iconColor:"#2a6",text:"Tomorrow Night",insertText:"Tomorrow "+timeTomNight.toString("h:mm tt"),date:timeTomNight,showDay:!0},{type:"snooze",icon:"icon-access_time",iconColor:g.colorBlue,text:"This Weekend",insertText:timeWeekend.toString("M/dd h:mm tt"),date:timeWeekend,showDay:!0},{type:"snooze",icon:"icon-access_time",iconColor:"#b0d",text:"Next Week",insertText:timeWeek.toString("M/dd h:mm tt"),date:timeWeek,showDay:!0}]}},renderObject:function renderObject(obj,index){switch(obj.type){case"contact":if(obj.text&&obj.email){var text=this.insertHighlight(obj.text),email=this.insertHighlight(" <"+obj.email+">");return React.createElement("span",null,React.createElement("span",{className:"contact"},text),email)}if(obj.email)return obj.email;if(obj.text){var text=this.insertHighlight(obj.text);return React.createElement("span",{className:"contact"},text)}break;case"tag":var text=this.insertHighlight(obj.text);return[React.createElement("span",{key:"tag",className:"tag"},text),React.createElement("span",{key:"number",className:"number"},obj.count)];case"date":var text=this.insertHighlight(obj.text);return React.createElement("span",{className:"date"},text);case"snooze":var detail=(obj.showDay?obj.date.toString("dddd")+" ":"")+obj.date.toString("h:mm tt");return[React.createElement("span",{key:"snoozeDate",className:"snoozeDate"},obj.text),React.createElement("span",{key:"snoozeDetail",className:"snoozeDetail"},detail)];case"item":var item=obj.item,parentText=g.parentTextForItem(item),isExpanded=index===this.state.expanded,cls=g.classNames("autocompleteItem",{hasParent:!!parentText},{itemExpanded:isExpanded}),isMove="move"===this.props.mode;return React.createElement("span",{className:cls},parentText&&React.createElement("div",{className:"parentPath"},parentText),React.createElement(ReactItem,{key:item.id,item:item,index:index,pane:this.pane,inAutocomplete:!0}),isMove&&React.createElement(FancyButton,{icon:isExpanded?"icon-angle-down":"icon-angle-right",className:"autocompleteExpand",width:50,height:50,onClick:this.onClickExpand.bind(this,index),tooltip:"Add sub-item"}),isMove&&isExpanded&&React.createElement(FancyInput,{ref:"inputAdd",placeholder:"Add subitem",buttonText:"MOVE TO CHILD",focused:!0,onButtonClick:this.onSelectedAddChild}));case"gmailLabel":var text=this.insertHighlight(obj.text);return React.createElement("span",null,text);default:try{g.PAssert(4838,!1,"Invalid insert text",obj.type)}catch(PERR){g.reportError(PERR)}}},render:function render(){for(var state=this.state,props=this.props,matchesArr=[],i=0;i<state.matches.length;i++){var match=state.matches[i],cls=g.classNames({selected:i===state.selectedIndex},"autocomplete_"+match.type);matchesArr.push(React.createElement(FancyContextMenuItem,{key:i,ref:"item_"+i,icon:match.icon,iconColor:match.iconColor,className:cls,onMouseOver:this.onMouseOver.bind(this,i),canClose:!1,noMouseUp:!0,onClick:this.onClick.bind(this,i),hoverEffects:!1},this.renderObject(match,i)))}var cls=g.classNames("newAutocomplete",this.props.className),placeholder=props.text,buttonText=props.buttonText,buttonEnabled;props.elementInput||(buttonEnabled=props.allowEmpty?!0:props.allowCustom?void 0:state.selectedIndex>=0);var cls=g.classNames("newAutocomplete",{hasOwnInput:!this.props.elementInput},{expanded:state.expanded!==!1});return React.createElement(FancyContextMenu,{className:cls,element:this.props.elementDisplay,width:400,fitInsideBorder:!0,minWidth:260,autocompleteOffset:props.autocompleteOffset,overflowHeight:"shrink",ref:"contextMenu"},React.createElement("div",{className:"newAutocompleteWrapperOuter"},React.createElement("div",{className:"newAutocompleteWrapper flexbox flexvert"},!this.props.elementInput&&React.createElement(FancyInput,{ref:"input",display:"block",placeholder:placeholder,onKeyDown:this.onInputKeyDown,autocompleteMode:props.mode,padding:{left:16,right:16},tokens:props.tokens,onTokenRemoved:props.onTokenRemoved,border:!1,buttonText:buttonText,onEscape:this.onEscape,buttonEnabled:buttonEnabled,onButtonClick:this.onButtonClick}),React.createElement(FancyScroller,{className:"matches"},matchesArr))))}});return ReactAutocomplete}),define("Components/FancyTextarea",["require","globals","Constants","react","MooReact","platform","Hotkeys"],function(require){var g=require("globals"),C=require("Constants"),React=require("react"),MooReact=require("MooReact"),platform=require("platform"),Hotkeys=require("Hotkeys"),FancyTextArea=MooReact.createClass({displayName:"FancyTextArea",propTypes:{selectionStart:React.PropTypes.number,selectionEnd:React.PropTypes.number,spellCheck:React.PropTypes.bool,focused:React.PropTypes.bool,value:React.PropTypes.string,onFocus:React.PropTypes.func,onBlur:React.PropTypes.func},init:function init(){this.createObservables({isFocused:this.props.focused||!1})},componentDidMount:function componentDidMount(){var inputBox=this.refs.input;this.props.value&&(inputBox.value=this.props.value),this.props.focused&&requestAnimationFrame(function(){inputBox.focus(),void 0!==this.props.selectionStart&&(inputBox.selectionStart=this.props.selectionStart),void 0!==this.props.selectionEnd&&(inputBox.selectionEnd=this.props.selectionEnd),inputBox.scrollTop=0}.bind(this))},onUnmount:function onUnmount(){this.isFocused.get()&&this.onBlur()},focus:function focus(){this.refs.input.focus()},blur:function blur(){this.refs.input.blur()},getValue:function getValue(){return this.refs.input.value},setValue:function setValue(value){this.refs.input.value=value},getSelectionStart:function getSelectionStart(){return this.refs.input.selectionStart},getSelectionEnd:function getSelectionEnd(){return this.refs.input.selectionEnd},onFocus:function onFocus(e){g.vmMain.activeInput.set(this),this.isFocused.set(!0),this.props.onEscape&&(this.__hotkeyEscape=Hotkeys.pushStackEscape(this.handleEscapeKey)),this.props.onFocus&&this.props.onFocus(e)},onBlur:function onBlur(e){g.vmMain.activeInput.set(null),this.isFocused.set(!1),this.__hotkeyEscape&&(Hotkeys.popStack(this.__hotkeyEscape),this.__hotkeyEscape=void 0),this.props.onBlur&&this.props.onBlur(e)},onKeyPress:function onKeyPress(e){this.props.onKeyPress&&this.props.onKeyPress(e)},handleEscapeKey:function handleEscapeKey(){this.props.onEscape&&this.props.onEscape()},render:function render(){var props=this.props,cls=g.classNames("fancyTextarea",props.className),spellCheck=props.spellCheck?"true":null,style={fontSize:props.fontSize};return React.createElement("textarea",{className:cls,style:style,ref:"input",spellCheck:spellCheck,onClick:props.onClick,onChange:props.onChange,onFocus:this.onFocus,onBlur:this.onBlur,onKeyPress:this.onKeyPress})}});return FancyTextArea});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactNotePopup",["require","globals","Constants","react","MooReact","Multiselect","DisplaySettings","Sel","tracker","platform","android","Dispatcher","Components/FancyContextMenu","Components/FancyTextarea","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),React=require("react"),MooReact=require("MooReact"),Multiselect=require("Multiselect"),DisplaySettings=require("DisplaySettings"),Sel=require("Sel"),tracker=require("tracker"),platform=require("platform"),android=require("android"),Dispatcher=require("Dispatcher"),FancyContextMenu=require("Components/FancyContextMenu"),FancyTextarea=require("Components/FancyTextarea"),FancyButton=require("Components/FancyButton"),ReactNotePopup=MooReact.createClass({displayName:"ReactNotePopup",propTypes:{element:React.PropTypes.object.isRequired,note:React.PropTypes.object.isRequired,pane:React.PropTypes.object.isRequired,selectionStart:React.PropTypes.number,selectionEnd:React.PropTypes.number},componentDidMount:function componentDidMount(){platform.mobile||Dispatcher.listen("windowResize",this.onResize)
},onResize:function onResize(){this.updateState(),setTimeout(function(){this.refs.menu.updateState()}.bind(this),300)},onUnmount:function onUnmount(){platform.mobile||Dispatcher.unlisten("windowResize",this.onResize),clearTimeout(this._noteUpdateTimeout);var noteValue=this.refs.noteText.getValue();tracker.beginAction(),this.props.note.setText(noteValue,!0,ChangeType.Local);var parent=this.props.note.parent();noteValue||parent.setNote(void 0,ChangeType.Local),android.isEnabled()&&(android.getCurrentVMLI()===parent||android.getCurrentVMLI()===this.props.note)&&android.finishInput(!1),Sel.selectIndex(this.props.index-1,parent.getParsedText().length),platform.mobile&&g.keyboardToolbar.show(C.KeyboardToolbarMode.Item),tracker.endAction()},onKeyPress:function onKeyPress(e){platform.normalizeKeys(e),e.normCode!==KeyCode.Enter||!e.shiftKey||e.altKey||e.ctrlKey||e.metaKey||(g.menus.closeContextMenuReact(),e.preventDefault(),e.stopPropagation())},_saveNote:function _saveNote(){tracker.beginAction();var noteValue=this.refs.noteText.getValue();this.props.note.setText(noteValue,!0,ChangeType.Local),tracker.endAction()},onChange:function onChange(e){clearTimeout(this._noteUpdateTimeout),this._noteUpdateTimeout=setTimeout(this._saveNote,8e3)},getState:function getState(){return{maxWidth:this.props.pane.getWidth()-20}},render:function render(){var maxWidth=this.state.maxWidth,bottom=platform.mobile&&this.props.bottom,fontSize=DisplaySettings.fontSize();return React.createElement(FancyContextMenu,_extends({},this.props,{key:this.props.note.id+"_Note",id:"contextMenuNote",width:600,maxWidth:maxWidth,bottom:bottom,ref:"menu"}),React.createElement(FancyTextarea,{ref:"noteText",value:this.props.note.getParsedText(),focused:!0,onChange:this.onChange,onKeyPress:this.onKeyPress,selectionStart:this.props.selectionStart,selectionEnd:this.props.selectionEnd,fontSize:fontSize}))}});return ReactNotePopup}),define("ReactContextMenuAddPane",["require","globals","Constants","tracker","react","MooReact","Hotkeys","Sel","Components/FancyContextMenu","Components/FancyContextMenuItem"],function(require){var g=require("globals"),C=require("Constants"),tracker=require("tracker"),React=require("react"),MooReact=require("MooReact"),Hotkeys=require("Hotkeys"),Sel=require("Sel"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),ReactContextMenuAddPane=MooReact.createClass({displayName:"ReactContextMenuAddPane",init:function init(){this.addHotkey("O",PaneMode.Outline),this.addHotkey("A",PaneMode.Timeline),this.addHotkey("R",PaneMode.Archived),this.addHotkey("G",PaneMode.Gmail),this.addHotkey("D",PaneMode.Drive)},addHotkey:function addHotkey(key,mode){this.hotkeys||(this.hotkeys=[]),this.hotkeysByType||(this.hotkeysByType=[]),this.hotkeysByType[mode]=key,this.hotkeys.push(Hotkeys.create(KeyCode[key],C.Primary.Either,C.Shift.Either,this.onClickAddPaneType.bind(this,mode)))},getState:function getState(){var paneFactory=g.vmMain.paneFactory;return{registeredPanes:paneFactory.activePaneTypes,numInactivePanes:paneFactory.numInactivePanes}},onClickAddPaneType:function onClickAddPaneType(type){var newPane=g.vmMain.paneManager.createPaneAtIndex(type);newPane&&(tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.AddPane,data:newPane.id}),g.sendEvent("Menu","AddPane_"+type)),Sel.setFocusedPane(newPane),g.menus.closeContextMenuReact()},onClickEnableMorePanes:function onClickEnableMorePanes(){g.menus.openSettings(C.SettingsSections.Plugins)},render:function render(){for(var state=this.state,paneInfos=state.registeredPanes,addPanes=[],showAddMore=state.numInactivePanes>0,i=0;i<paneInfos.length;i++){var paneInfo=paneInfos[i],hotkey=this.hotkeysByType[paneInfo.type];addPanes.push(React.createElement(FancyContextMenuItem,{key:paneInfo.text,icon:paneInfo.icon,"data-tooltip":paneInfo.tooltip,hotkey:hotkey,onClick:this.onClickAddPaneType.bind(this,paneInfo.type)},paneInfo.text))}return React.createElement(FancyContextMenu,{ref:"menu",key:"contextMenuAdd",element:this.props.element,supportArrows:!0,hotkeys:this.hotkeys},addPanes,showAddMore&&React.createElement("hr",null),showAddMore&&React.createElement(FancyContextMenuItem,{onClick:this.onClickEnableMorePanes},"Enable more panes"))}});return ReactContextMenuAddPane});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactContextMenuAuthorize",["require","globals","react","MooReact","PluginSettings","Components/FancyContextMenu","Components/FancyButton"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),PS=require("PluginSettings"),FancyContextMenu=require("Components/FancyContextMenu"),FancyButton=require("Components/FancyButton"),ReactContextMenuAuthorize=MooReact.createClass({displayName:"ReactContextMenuAuthorize",propTypes:{element:React.PropTypes.object.isRequired},onClickEnable:function onClickEnable(){PS.refresh(),PS.toggleOfflineFeatures(!0,this.onEnable)},onEnable:function onEnable(success){success&&g.menus.closeContextMenuReact()},render:function render(){return React.createElement(FancyContextMenu,_extends({},this.props,{key:"contextMenuAuthorize",id:"contextMenuAuthorize"}),React.createElement("div",null,this.props.message),React.createElement("div",{className:"center"},React.createElement(FancyButton,{primary:!0,raised:!0,onClick:this.onClickEnable},"ENABLE")))}});return ReactContextMenuAuthorize});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("Components/DivX",["require","globals","Constants","platform","react","MooReact"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),DivX=MooReact.createClass({displayName:"DivX",componentDidMount:function componentDidMount(){platform.mobile&&this.props.onClick&&g.setupClick(this.refs.element,this,this.onTap)},onMouseDown:function onMouseDown(e){this.lastX=e.clientX,this.lastY=e.clientY,this.moveX=0,this.moveY=0,this.isDown=!0,this.props.onMouseDown&&this.props.onMouseDown(e)},onMouseMove:function onMouseMove(e){this.isDown&&(this.moveX+=Math.abs(e.clientX-this.lastX),this.moveY+=Math.abs(e.clientY-this.lastY),this.lastX=e.clientX,this.lastY=e.clientY,this.props.onMouseMove&&this.props.onMouseMove(e))},onClick:function onClick(e){this.moveX<g.ClickThreshold&&this.moveY<g.ClickThreshold&&this.props.onClick&&this.props.onClick(e)},onMouseUp:function onMouseUp(e){this.isDown=!1,this.props.onMouseUp&&this.props.onMouseUp(e)},onTap:{onStart:function onStart(e){this.onMouseDown(e),e.stopPropagation()},onClick:function onClick(e){this.props.onClick(e),e.stopPropagation()}},render:function render(){var _props=this.props,onClick=_props.onClick,rest=_objectWithoutProperties(_props,["onClick"]);return React.createElement("div",_extends({},rest,{onMouseDown:!platform.mobile&&this.onMouseDown,onMouseMove:this.onMouseMove,onClick:!platform.mobile&&this.onClick,onMouseUp:this.onMouseUp,ref:"element"}),this.props.children)}});return DivX});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactContextMenuMobileFilter",["require","globals","react","MooReact","VMPane","Components/DivX","Components/FancyButton","Components/FancyContextMenu","Components/FancyContextMenuItem"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),DivX=require("Components/DivX"),FancyButton=require("Components/FancyButton"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),ReactContextMenuMobileFilter=MooReact.createClass({displayName:"ReactContextMenuMobileFilter",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},init:function init(){this.listenTo(this.props.pane.search.onChanged)},getState:function getState(){for(var search=this.props.pane.search,state={},i=0;i<search.filters.length;i++){var filter=search.filters[i];state[filter.name]=filter.value}return state},onClickFilter:function onClickFilter(filter,value){var search=this.props.pane.search,currentValue=search.getFilter(filter.name);currentValue===value&&(value=0),search.setFilter(filter.name,value)},renderSearchButton:function renderSearchButton(filter,value){var cls=g.classNames("searchFilterButton",{yes:value>0},{no:0>value},{selected:value===filter.value});return React.createElement(DivX,{className:cls,onClick:this.onClickFilter.bind(this,filter,value)},0>value&&React.createElement("i",{className:"icon-minus"}),React.createElement("i",{className:filter.icon}))},renderSearchFilter:function renderSearchFilter(filter){return React.createElement("div",{key:filter.name,className:"searchFilter flexbox"},React.createElement("div",{className:"menuItemText f1"},filter.name[0].toUpperCase()+filter.name.substring(1)),this.renderSearchButton(filter,1),this.renderSearchButton(filter,-1))},renderSearchPriorityButton:function renderSearchPriorityButton(filter,value){var cls=g.classNames("searchPriorityButton",{p0:value===VMLIFlag.P0},{p1:value===VMLIFlag.P1},{p2:value===VMLIFlag.P2},{selected:value===filter.value});return React.createElement(DivX,{className:cls,onClick:this.onClickFilter.bind(this,filter,value)})},renderSearchPriority:function renderSearchPriority(filter){return React.createElement("div",{key:filter.name,className:"searchPriority flexbox"},React.createElement("div",{className:"menuItemText f1"},"Priority"),this.renderSearchPriorityButton(filter,VMLIFlag.P0),this.renderSearchPriorityButton(filter,VMLIFlag.P1),this.renderSearchPriorityButton(filter,VMLIFlag.P2))},render:function render(){for(var props=this.props,search=props.pane.search,renderedButtons=[],i=0;i<search.filters.length;i++){var filter=search.filters[i];filter.enabled.get()&&(filter.icon?renderedButtons.push(this.renderSearchFilter(filter)):"priority"===filter.name&&renderedButtons.push(this.renderSearchPriority(filter)))}return React.createElement(FancyContextMenu,_extends({},props,{key:"contextMenuMobileFilter",id:"contextMenuMobileFilter"}),renderedButtons)}});return ReactContextMenuMobileFilter}),define("ReactContextMenuOptions",["require","globals","Constants","gdata","react","MooReact","tracker","Components/FancyContextMenu","Components/FancyContextMenuItem"],function(require){var g=require("globals"),C=require("Constants"),gdata=require("gdata"),React=require("react"),MooReact=require("MooReact"),tracker=require("tracker"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),ReactContextMenuOptions=MooReact.createClass({displayName:"ReactContextMenuOptions",onClickSettings:function onClickSettings(){g.menus.openSettings()},onClickDisplaySettings:function onClickDisplaySettings(){g.vmMain.isDisplaySettingsOpen.set(!0),tracker.performAction(TrackerType.UIAction,{type:TrackerUIAction.OpenDisplaySettings})},onClickHelp:function onClickHelp(){g.vmMain.showHelp(C.HelpMode.Normal)},onClickImport:function onClickImport(){tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenImport}),g.menus.openModal("importData")},onClickExport:function onClickExport(){tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenExport}),g.menus.openModal("exportData")},onClickRevision:function onClickRevision(){g.menus.openModal(Modals.RevisionHistory)},onClickFeedback:function onClickFeedback(){g.menus.openModal("reportBug")},onClickBlog:function onClickBlog(){g.openUrl("/blog/")},onClickLogout:function onClickLogout(){g.vmSetup.logoutClicked()},render:function render(){var authedUser=g.isDemoMode()?"Demo":gdata.authenticatedUser()&&gdata.authenticatedUser().displayName;return React.createElement(FancyContextMenu,{key:"contextMenuOptions",id:"contextMenuOptions",element:this.props.element,supportArrows:!0},React.createElement(FancyContextMenuItem,{onClick:this.onClickSettings},"Settings"),React.createElement(FancyContextMenuItem,{onClick:this.onClickDisplaySettings},"Display Settings"),React.createElement(FancyContextMenuItem,{onClick:this.onClickHelp},"Help"),React.createElement("hr",null),React.createElement(FancyContextMenuItem,{onClick:this.onClickImport},"Import Data"),React.createElement(FancyContextMenuItem,{onClick:this.onClickExport},"Export Data"),React.createElement(FancyContextMenuItem,{onClick:this.onClickRevision},"Revision History"),React.createElement("hr",null),React.createElement(FancyContextMenuItem,{onClick:this.onClickFeedback},"Send Feedback"),React.createElement(FancyContextMenuItem,{onClick:this.onClickBlog},"Moo.do Blog"),React.createElement("hr",null),React.createElement(FancyContextMenuItem,{onClick:this.onClickLogout},"Logout"),React.createElement(FancyContextMenuItem,{className:"username","data-bind":"ripple: true, text: getUserName()"},authedUser),React.createElement(FancyContextMenuItem,{className:"useremail","data-bind":"ripple: true, text: getUserEmail()"},g.getUserIdentifier()))}});return ReactContextMenuOptions}),define("ReactContextMenus",["require","globals","platform","react","MooReact","ReactAutocomplete","ReactNotePopup","ReactContextMenuAddPane","ReactContextMenuAuthorize","ReactContextMenuMobileFilter","ReactContextMenuOptions"],function(require){var g=require("globals"),platform=require("platform"),React=require("react"),ReactCSSTransitionGroup=React.addons.CSSTransitionGroup,MooReact=require("MooReact"),ReactAutocomplete=require("ReactAutocomplete"),ReactNotePopup=require("ReactNotePopup"),ReactContextMenuAddPane=require("ReactContextMenuAddPane"),ReactContextMenuAuthorize=require("ReactContextMenuAuthorize"),ReactContextMenuMobileFilter=require("ReactContextMenuMobileFilter"),ReactContextMenuOptions=require("ReactContextMenuOptions"),ReactContextMenus=MooReact.createClass({displayName:"ReactContextMenus",propTypes:{},getState:function getState(){return{contextMenus:g.menus.contextMenuStack,noFade:g.menus.contextMenuNoFade}},close:function close(e){g.menus.closeContextMenuReact(),e.preventDefault(),e.stopPropagation()},render:function render(){for(var state=this.state,menus=[],i=0;i<state.contextMenus.length;i++){var menu=state.contextMenus[i];menu.fn?menus.push(menu.fn(menu)):menu.componentName&&(menu.key=menu.componentName,menus.push(React.createElement(require(menu.componentName),menu)))}var classMenus=g.classNames("contextMenusReact",{open:menus.length>0}),styleBackdrop={display:state.noFade&&"none"},backdrop=(platform.mobile||menus.length>0)&&React.createElement("div",{className:"contextMenusBackdrop",onMouseDown:!platform.mobile&&this.close,onTouchStart:platform.mobile&&this.close,style:styleBackdrop});return React.createElement(ReactCSSTransitionGroup,{className:classMenus,transitionName:"contextMenuAnim",transitionEnterTimeout:150,transitionLeaveTimeout:200},backdrop,menus)}});return ReactContextMenus}),define("Components/FancyProgressBar",["require","exports","module","Constants","globals","platform","react","MooReact","Components/FancyButton"],function(require,exports,module){var C=require("Constants"),g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),FancyButton=require("Components/FancyButton"),FancyProgressBar=MooReact.createClass({displayName:"FancyProgressBar",propTypes:{percent:React.PropTypes.number.isRequired},render:function render(){var props=this.props,style={height:props.height},styleInside={};styleInside[platform.transform.react]="scale("+props.percent+", 1)";var styleError={lineHeight:props.height-2+"px"};return React.createElement("div",{className:"fancyProgressBar",style:style},!props.error&&React.createElement("div",{className:"fancyProgressInside",style:styleInside}),props.error&&React.createElement("div",{className:"fancyProgressError",style:styleError},props.errorMsg))}});return FancyProgressBar}),define("ReactMessageAttachments",["require","exports","module","globals","Constants","platform","react","MooReact","EmailPreview","Components/FancyProgressBar","Components/FancyButton"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),EmailPreview=require("EmailPreview"),FancyProgressBar=require("Components/FancyProgressBar"),FancyButton=require("Components/FancyButton"),ReactMessageAttachments=React.createClass({mixins:[MooReact.MooReactMixin,React.addons.PureRenderMixin],displayName:"ReactMessageAttachments",propTypes:{threadAttach:React.PropTypes.object.isRequired,message:React.PropTypes.object.isRequired,editable:React.PropTypes.bool.isRequired},init:function init(){this.props.threadAttach.subscribe(this)},onUnmount:function onUnmount(){this.props.threadAttach.unsubscribe(this)},onAttachmentUpdate:function onAttachmentUpdate(attach,fields,changeType){this.updateState()},onAttachmentIDChange:function onAttachmentIDChange(){},getState:function getState(){var plugin=this.props.threadAttach.getPlugin();return{attachments:plugin.getMessageDisplayAttachments(this.props.message)}},onClickAttach:function onClickAttach(res,e){if(res.error)res.uploader&&!res.uploader.isDone()&&res.uploader.resume();else if(!res.uploader||res.uploader.isDone()){var url=this._getURL(res);this.props.editable?g.openUrl(url):res.attID?g.downloadFile(url):g.openUrl(url)}e.stopPropagation()},onClickDelete:function onClickDelete(res,e){var plugin=this.props.threadAttach.getPlugin();plugin.removeAttachFiles(this.props.threadAttach,this.props.message,res),this.props.onUpdate&&this.props.onUpdate(),e.stopPropagation()},onAttachDragStart:function onAttachDragStart(e){var downloadURL=e.target.getAttribute("data-downloadurl");e.stopPropagation(),e.dataTransfer.setData("DownloadURL",downloadURL)},_getURL:function _getURL(res){var url;return url=this.props.editable||!res.attID?EmailPreview.getPreviewURL(res):EmailPreview.getAttachmentURL(g.getUserIdentifier(),this.props.message.id,res.attID)},_renderAttachment:function _renderAttachment(attach){var dragDownloadURL=attach.mimeType+":"+attach.cid+":"+this._getURL(attach),perc=attach.uploader?g.clamp(attach.uploader.getPercent(),.05,1):1;return React.createElement("div",{key:attach.cid,className:"messageAttachment flexbox",draggable:!0,"data-downloadurl":dragDownloadURL,onClick:this.onClickAttach.bind(this,attach),onDragStart:this.onAttachDragStart},React.createElement("div",{className:"attachmentIcon icon-drive-file"}),React.createElement("div",{className:"attachmentText"},attach.cid),React.createElement("div",{className:"f1"}),1>perc&&React.createElement(FancyProgressBar,{percent:perc,height:22,error:attach.error,errorMsg:"Click to retry"}),React.createElement("div",{className:"attachmentSize"},g.toFileSize(attach.size)),this.props.editable&&React.createElement(FancyButton,{className:"attachmentClose",icon:"icon-close",onClick:this.onClickDelete.bind(this,attach),tooltip:"Remove"}))},render:function render(){var attachArea=null,msgAttachments=this.state.attachments;if(msgAttachments.length>0){for(var attachments=[],i=0;i<msgAttachments.length;++i){var attach=msgAttachments[i];attachments.push(this._renderAttachment(attach))}attachArea=React.createElement("div",{className:"messageAttachments"},attachments)}return attachArea}});return ReactMessageAttachments}),define("Components/FancyContenteditable",["require","globals","react","MooReact","NativeSel"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),NativeSel=require("NativeSel"),FancyContenteditable=MooReact.createClass({displayName:"FancyContenteditable",propTypes:{spellCheck:React.PropTypes.bool,focused:React.PropTypes.bool,value:React.PropTypes.string,onFocus:React.PropTypes.func,onBlur:React.PropTypes.func},init:function init(){this.createObservables({isFocused:this.props.focused||!1})},componentDidMount:function componentDidMount(){this.props.focused&&requestAnimationFrame(function(){this.refs.div.focus()}.bind(this))},onUnmount:function onUnmount(){this.isFocused.get()&&this.onBlur()},focus:function focus(){g.isDemoRunning||this.refs.div.focus()},blur:function blur(){this.refs.div.blur()},setValue:function setValue(value){this.refs.div.innerHTML=value},getValue:function getValue(){return this.refs.div.innerHTML},getTextValue:function getTextValue(){return this.refs.div.innerText},getElement:function getElement(){return this.refs.div},insertCharAtIndex:function insertCharAtIndex(char,index){var div=this.refs.div,str=div.innerHTML;str=str.substr(0,index)+char+str.substr(index,str.length),div.innerHTML=str,NativeSel.selectElement(div,index+1),this.props.onChange&&this.props.onChange()},onFocus:function onFocus(e){g.vmMain.activeInput.set(this),this.isFocused.set(!0),this.props.onFocus&&this.props.onFocus(e)},onBlur:function onBlur(e){g.vmMain.activeInput.set(null),this.isFocused.set(!1),this.props.onBlur&&this.props.onBlur(e)},onEscapeKey:function onEscapeKey(){this.props.onEscape&&this.props.onEscape()},onDrop:function onDrop(e){this.props.onDrop&&this.props.onDrop(e.dataTransfer)},onDragEnter:function onDragEnter(){this.props.onDrop&&g.addClass(this.refs.div,"dragTarget")},onDragLeave:function onDragLeave(){this.props.onDrop&&g.removeClass(this.refs.div,"dragTarget")},render:function render(){var props=this.props,cls=g.classNames("fancyContenteditable",props.className),spellCheck=props.spellCheck?"true":null;return React.createElement("div",{contentEditable:props.editable!==!1,className:cls,ref:"div",spellCheck:spellCheck,onInput:props.onChange,onClick:props.onClick,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onDrop:this.onDrop,onDragEnter:this.onDragEnter,onDragLeave:this.onDragLeave})}});return FancyContenteditable}),define("ReactEmailCompose",["require","exports","module","globals","Constants","platform","react","MooReact","Sel","EmailHTML","EmailPreview","NativeSel","Hotkeys","DragDrop","ReactMessageAttachments","AccountManager","Components/FancyInput","Components/FancyContenteditable","Components/FancyButton"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Sel=require("Sel"),EmailHTML=require("EmailHTML"),EmailPreview=require("EmailPreview"),NativeSel=require("NativeSel"),Hotkeys=require("Hotkeys"),DragDrop=require("DragDrop"),ReactMessageAttachments=require("ReactMessageAttachments"),AccountManager=require("AccountManager"),FancyInput=require("Components/FancyInput"),FancyContenteditable=require("Components/FancyContenteditable"),FancyButton=require("Components/FancyButton"),ReactEmailCompose=MooReact.createClass({displayName:"ReactEmailCompose",propTypes:{threadAttach:React.PropTypes.object.isRequired,message:React.PropTypes.object.isRequired,onClose:React.PropTypes.func.isRequired},init:function init(){var props=this.props;this.to=this._createTokensFromAddressText(props.message.to),this.cc=this._createTokensFromAddressText(props.message.cc),this.bcc=this._createTokensFromAddressText(props.message.bcc),this.createObservables({showSubject:props.showSubject||platform.mobile,showCc:!1,showBcc:!1,isSending:!1}),this.listenTo(AccountManager.onAccountsUpdated),g.isDemoMode()&&(g.reactEmailCompose=this)},_getHotkeys:function _getHotkeys(){return[Hotkeys.create(KeyCode.Escape,C.Primary.Either,C.Shift.Either,this.onEscape),Hotkeys.create(KeyCode.Enter,C.Primary.Yes,C.Shift.Either,this.send)]},getState:function getState(){var plugin=this.props.threadAttach.getPlugin();return{attachments:plugin.getMessageDisplayAttachments(this.props.message),fromAccounts:this.getSendingAccounts()}},componentDidMount:function componentDidMount(){var body=this._getComposeBody(this.props.message);body&&this.refs.body.setValue(body),this.refs.container.addEventListener("cdrop",this.onItemDrop);var self=this;this.refs.picker.addEventListener("change",function(){var emailPlugin=self.props.threadAttach.getPlugin();return emailPlugin.notifyAttachFiles(self.props.threadAttach,self.props.message,this.files,self.onAttachUpdated),this.value=null,!1},!1)},onUnmount:function onUnmount(){this._clearDraftDebounce(!0,!0)},discard:function discard(){this.close(!1,!0,!0)},onEscape:function onEscape(){this.refs.to.getTokens().length>0||this.refs.body.getValue()||this.state.attachments.length>0?g.menus.confirm("Do you want to discard this draft?",function(result){result&&this.discard()}.bind(this)):this.discard()},send:function send(){this.onClickSend()},onFocus:function onFocus(){this.__hotkeys||(this.__hotkeys=Hotkeys.pushStack(this._getHotkeys()))},onBlur:function onBlur(){this.__hotkeys&&(Hotkeys.popStack(this.__hotkeys),this.__hotkeys=void 0)},onClickAttach:function onClickAttach(e){this.refs.picker.click()},onAttachUpdated:function onAttachUpdated(){this._isMounted&&(this._clearDraftDebounce(!0,!0),this.updateState(),this.onDraftChanged())},onFileDrop:function onFileDrop(e){var data=e.dataTransfer;if(data.files&&data.files.length>0){var emailPlugin=this.props.threadAttach.getPlugin();emailPlugin.notifyAttachFiles(this.props.threadAttach,this.props.message,data.files,this.onAttachUpdated),e.preventDefault(),e.stopPropagation(),DragDrop.stop(),DragDrop.finish()}},onItemDrop:function onItemDrop(e){if(e.item&&e.item.hasAttachmentType(C.PluginType.Storage)){var attachFile=e.item.getAttachmentByType(C.PluginType.Storage),emailPlugin=this.props.threadAttach.getPlugin();emailPlugin.notifyAttachLinkedFile(this.props.threadAttach,this.props.message,attachFile,this.onAttachUpdated.bind(this))}},close:function close(saveDraft,discardDraft,forceFlush){try{g.PAssert(4839,g.isBoolean(saveDraft),"Must supply a valid value for sendDraft")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4840,g.isBoolean(discardDraft),"Must supply a valid value for discardDraft")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4841,g.isBoolean(forceFlush),"Must supply a valid value for forceFlush")}catch(PERR){g.reportError(PERR)}this._clearDraftDebounce(saveDraft,forceFlush),!saveDraft&&discardDraft&&this._discardDraftUpdates(),this.props.onClose()},_clearDraftDebounce:function _clearDraftDebounce(updateRemoteDraft,forceFlush){this._draftUpdateDebounce&&(clearTimeout(this._draftUpdateDebounce),this._draftUpdateDebounce=void 0,this._saveDraftUpdates(updateRemoteDraft,forceFlush))},openSubject:function openSubject(){this.showSubject.set(!0)},openCc:function openCc(){this.showCc.set(!0)},openBcc:function openBcc(){this.showBcc.set(!0)},focusTo:function focusTo(){this._setFocus(this.refs.to)},focusBody:function focusBody(){this._setFocus(this.refs.body)},_setFocus:function _setFocus(ele){ele.isFocused.get()||ele.focus()},_createTokensFromAddressText:function _createTokensFromAddressText(recip){var tokens=[];if(recip)for(var i=0;i<recip.length;i++){var objTo=recip[i];objTo.text?tokens.push(objTo):objTo.email&&tokens.push({email:objTo.email,text:objTo.email})}return{tokens:tokens}},onClickSend:function onClickSend(){var props=this.props,refs=this.refs,sendCB=function(success,errorResult){success?this.close(!1,!1,!0):(g.isHTTPStatusCode(errorResult,C.HTTPStatusCode.Network)?g.toasts.pushMessage({text:"You are offline. Your message will be sent when Moo.do is open and you are online.",action:MessageAction.Okay,hold:!0}):errorResult&&g.toasts.pushMessage({text:"There was an error sending your message. Please try again in a minute.",action:MessageAction.Okay}),this.isSending.set(!1)),EmailPreview.ensureDisplayMessages(props.threadAttach)}.bind(this),runSend=function(doSend){if(doSend){this._clearDraftDebounce(!1,!1),NativeSel.clearSelection(),this.isSending.set(!0);var emailPlugin=props.threadAttach.getPlugin();emailPlugin.sendDraft(props.threadAttach,props.message.id,void 0,sendCB)||this.isSending.set(!1)}}.bind(this);refs.subject&&!refs.subject.getValue()?g.menus.confirm("There is no email subject, send anyway?",runSend):refs.body.getValue()?runSend(!0):g.menus.confirm("There is no email body, send anyway?",runSend)},onDraftChanged:function onDraftChanged(){clearTimeout(this._draftUpdateDebounce),this._draftUpdateDebounce=void 0,this._isMounted&&(this._draftUpdateDebounce=setTimeout(this._saveDraftUpdates.bind(this,!0,!1),1e3))},_saveDraftUpdates:function _saveDraftUpdates(updateRemoteDraft,forceFlush){if(this._isMounted){var refs=this.refs,props=this.props,to=refs.to.getTokens(),cc=refs.cc&&refs.cc.getTokens(),bcc=refs.bcc&&refs.bcc.getTokens(),subject=refs.subject&&refs.subject.getValue()||this.props.message.subject,body=refs.body.getValue()||"(no text)",snippet=refs.body.getTextValue()||"(no text)",msgData={to:to,cc:cc,bcc:bcc,subject:subject,body:body},emailPlugin=props.threadAttach.getPlugin();emailPlugin.updateDraft(props.threadAttach,props.message.id,props.message.draftID,msgData,snippet,updateRemoteDraft,forceFlush,function(success){try{g.PAssert(4842,success,"Should always be able to update a draft")}catch(PERR){g.reportError(PERR)}}),clearTimeout(this._draftUpdateDebounce),this._draftUpdateDebounce=void 0}},_discardDraftUpdates:function _discardDraftUpdates(){var emailPlugin=this.props.threadAttach.getPlugin();emailPlugin.discardDraft(this.props.threadAttach,this.props.message.id,function(success){try{g.PAssert(4843,success,"Should always be able to delete a draft")}catch(PERR){g.reportError(PERR)}})},_getComposeBody:function _getComposeBody(message){var body;return message&&message.decoded&&(body=EmailHTML.getComposeBody(message.decoded,message.resources)),body},onChangeFrom:function onChangeFrom(){var sendingAccountID=this.refs.from.value,attach=this.props.threadAttach,plugin=attach.getPlugin(),accountID=plugin.getSyncAccount(sendingAccountID),newFromContact=plugin.getSendingAccountInfo(sendingAccountID);this.close(!1,!1,!1);var newData=plugin.changeMessageAccount(attach,this.props.message.id,accountID,sendingAccountID,newFromContact),newThreadID=newData?newData.threadID:attach.id;this.props.message.inReplyTo||g.menus.openComposeEmail(plugin,newThreadID),this.refs.body.setValue(this._getComposeBody(this.props.message))},getSendingAccounts:function getSendingAccounts(){var plugin=this.props.threadAttach.getPlugin(),restrictAccountID;return this.props.message.inReplyTo&&(restrictAccountID=this.props.threadAttach.getField("accountID")),plugin.getSendingAccounts(restrictAccountID)},getFromAccount:function getFromAccount(){var fromAccounts=this.state.fromAccounts;return fromAccounts.length<2?fromAccounts[0]:this.refs.from.value},render:function render(){var state=this.state,props=this.props,plugin=props.threadAttach.getPlugin(),to=this.to,cc=this.cc,bcc=this.bcc,subject="(no subject)"===props.message.subject?"":props.message.subject,showCc=this.state.showCc||this.cc&&this.cc.length>0,paddingRight=(platform.mobile?16:8)+(showCc?0:28)+(state.showBcc?0:34),accountID=props.threadAttach.getField("accountID"),sendingAccountID=props.message.from.email,displayAccounts=state.fromAccounts.slice(0),displayFromSelector=state.fromAccounts.length>1;displayAccounts.remove(sendingAccountID),displayAccounts.unshift(sendingAccountID);var clsHeader=g.classNames("composeHeader",{showingFrom:state.fromAccounts.length>1}),style;return platform.mobile&&(style={paddingBottom:platform.kbsize}),React.createElement("div",{className:"emailCompose validDropTarget",ref:"container",style:style,onDrop:this.onFileDrop,onFocus:this.onFocus,onBlur:this.onBlur},React.createElement("div",{className:clsHeader},React.createElement("div",{className:"composeButtons"},!state.showSubject&&React.createElement(FancyButton,{height:24,padding:6,onClick:this.openSubject},"Subject"),!showCc&&React.createElement(FancyButton,{height:24,padding:6,onClick:this.openCc},"Cc"),!state.showBcc&&React.createElement(FancyButton,{height:24,padding:6,onClick:this.openBcc},"Bcc")),React.createElement(FancyInput,{className:"toBox",height:50,floatingText:"To",display:"block",ref:"to",tokens:to.tokens,focused:"to"===this.props.focus,autocompleteMode:"email",padding:{right:paddingRight},onChange:this.onDraftChanged,onEscape:props.onEscape}),showCc&&React.createElement(FancyInput,{height:50,floatingText:"Cc",display:"block",ref:"cc",tokens:cc.tokens,autocompleteMode:"email",padding:props.paddingInput,onChange:this.onDraftChanged,onEscape:props.onEscape}),state.showBcc&&React.createElement(FancyInput,{height:50,floatingText:"Bcc",display:"block",ref:"bcc",autocompleteMode:"email",padding:props.paddingInput,onChange:this.onDraftChanged,onEscape:props.onEscape}),state.showSubject&&React.createElement(FancyInput,{height:50,floatingText:"Subject",display:"block",ref:"subject",value:subject,padding:props.paddingInput,onChange:this.onDraftChanged,onEscape:props.onEscape}),displayFromSelector&&React.createElement("div",{className:"composeFrom"},React.createElement("span",null,"From"),React.createElement("select",{ref:"from",onChange:this.onChangeFrom},displayAccounts.map(function(account){return React.createElement("option",{key:account,value:account},account)
})))),React.createElement(FancyContenteditable,{className:"emailComposeTextarea",ref:"body",onChange:this.onDraftChanged,spellCheck:!0,onEscape:props.onEscape,editable:!state.isSending}),React.createElement(ReactMessageAttachments,{onUpdate:this.onAttachUpdated,threadAttach:props.threadAttach,message:props.message,editable:!0}),!platform.mobile&&React.createElement("div",{className:"composeFooter"},React.createElement(FancyButton,{className:"discardDraft",icon:"icon-delete",iconSize:20,onClick:this.discard}),React.createElement(FancyButton,{className:"attachFile",icon:"icon-attach_file",iconSize:20,marginLeft:8,onClick:this.onClickAttach}),React.createElement(FancyButton,{className:"buttonSend",primary:!0,marginLeft:16,onClick:this.onClickSend},"SEND")),React.createElement("input",{type:"file",ref:"picker",className:"hidden"}),state.isSending&&React.createElement("div",{className:"clickBlocker flexbox flex-center"},React.createElement("div",{className:"f1 center"},"Sending...")))}});return ReactEmailCompose}),define("Components/FancyModal",["require","exports","module","globals","platform","react","MooReact","Components/FancyScroller","Components/FancyButton"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),FancyScroller=require("Components/FancyScroller"),FancyButton=require("Components/FancyButton"),FancyModal=MooReact.createClass({displayName:"FancyModal",propTypes:{id:React.PropTypes.string.isRequired,modalID:React.PropTypes.string.isRequired,width:React.PropTypes.number,height:React.PropTypes.number,title:React.PropTypes.string,backdropClose:React.PropTypes.bool},close:function close(callbackValue){platform.mobile&&g.closeKeyboard(),g.menus.closeModalNew(this.props.modalID,callbackValue)},onCloseButton:function onCloseButton(e){this.props.onCloseButton?this.props.onCloseButton():this.close()},onEscapeKey:function onEscapeKey(){this.close()},render:function render(){var props=this.props,sidebarChild=this.getChildByKey("sidebar"),contentChild=this.getChildByKey("content"),buttonsChild=this.getChildByKey("buttons"),styleModal={maxHeight:props.height?"95%":null};platform.mobile&&props.small||(styleModal.width=props.width,styleModal.height=props.height);var classModal=g.classNames("fancyModal","flexbox","flexvert",{small:props.small},{hasSidebar:!!sidebarChild},{hasTitle:!!props.title},{hasButtons:!!buttonsChild}),classWrapper=g.classNames("fancyModalWrapper"),sidebar;if(sidebarChild){var styleSidebar={width:sidebarChild.props.width||180};sidebar=React.createElement("div",{className:"fancyModalSidebar",style:styleSidebar},sidebarChild.props.children)}var classContent=g.classNames("fancyModalContent","flex1",contentChild.props.className),titleHeight=platform.mobile?g.topBarHeight:50;return React.createElement("span",{className:classWrapper},!platform.mobile&&React.createElement("div",{className:"fancyModalBackdrop",onClick:props.backdropClose!==!1&&this.close.bind(this,!1)}),React.createElement("div",{className:classModal,style:styleModal,id:props.id},props.closeButton!==!1&&React.createElement(FancyButton,{className:"fancyModalClose",icon:"icon-close",iconSize:20,width:titleHeight,height:titleHeight,onClick:this.onCloseButton,tooltip:"Close"}),platform.mobile&&props.confirmIcon&&React.createElement(FancyButton,{className:"fancyModalMobileConfirm",icon:props.confirmIcon,iconSize:20,width:titleHeight,height:titleHeight,onClick:props.onConfirm}),React.createElement("div",{className:"fancyModalTitle"},props.title),React.createElement("div",{className:"fancyModalInside flexbox flex1"},sidebar,React.createElement("div",{className:"fancyModalContentArea flexbox flexvert f1"},React.createElement(FancyScroller,{className:classContent,scrollable:props.scrollable},contentChild.props.children||contentChild),buttonsChild&&React.createElement("div",{className:g.classNames("fancyModalButtons",{border:props.buttonsBorder})},buttonsChild)))))}});return FancyModal});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactModalEmailReply",["require","exports","module","react","MooReact","Hotkeys","Constants","EmailPreview","ReactEmailCompose","Components/FancyButton","Components/FancyModal"],function(require,exports,module){var React=require("react"),MooReact=require("MooReact"),Hotkeys=require("Hotkeys"),C=require("Constants"),EmailPreview=require("EmailPreview"),ReactEmailCompose=require("ReactEmailCompose"),FancyButton=require("Components/FancyButton"),FancyModal=require("Components/FancyModal"),ReactModalEmailReply=MooReact.createClass({displayName:"ReactModalEmailReply",propTypes:{},componentDidMount:function componentDidMount(){var props=this.props,compose=this.refs.compose;setTimeout(function(){props.responseMode===C.EmailResponseMode.Forward?compose.focusTo():compose.focusBody()},250)},onUnmount:function onUnmount(){EmailPreview.setMessageResponseMode(this.props.inReplyToMessage.id,C.EmailResponseMode.None)},onClickSend:function onClickSend(){this.refs.compose.send(),this.refs.modal.close()},onComposeClose:function onComposeClose(){this.refs.modal.close()},onCloseButton:function onCloseButton(){this.refs.compose.discard()},render:function render(){var props=this.props,mode=props.responseMode,title;return mode===C.EmailResponseMode.Reply?title="Reply":mode===C.EmailResponseMode.ReplyAll?title="Reply All":mode===C.EmailResponseMode.Forward&&(title="Forward"),React.createElement(FancyModal,_extends({},this.props,{id:"modalEmailReply",title:title,modalID:Modals.EmailReply,ref:"modal",confirmIcon:"icon-send",onConfirm:this.onClickSend,onCloseButton:this.onCloseButton}),React.createElement(ReactEmailCompose,{key:"content",threadAttach:this.props.threadAttach,message:this.props.message,ref:"compose",onClose:this.onComposeClose,responseMode:this.state.responseMode}))}});return ReactModalEmailReply}),define("ReactInviteSection",["require","exports","module","globals","Constants","platform","data","react","MooReact","International","Sel","NativeSel","Components/FancyButton","Components/FancyInput"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),d=require("data"),React=require("react"),MooReact=require("MooReact"),International=require("International"),Sel=require("Sel"),NativeSel=require("NativeSel"),FancyButton=require("Components/FancyButton"),FancyInput=require("Components/FancyInput"),ReactInviteSection=MooReact.createClass({displayName:"ReactInviteSection",propTypes:{},getState:function getState(){var BM=g.billingManager;return{validBilling:BM._hasValidBillingData,premiumStatus:BM._premiumStatus,inviteEmailSuccess:BM.inviteEmailSuccess,inviteEmailError:BM.inviteEmailError,inviteCodeError:BM.inviteCodeError}},onTapInviteUrl:function onTapInviteUrl(e){var el=e.target;el!==document.activeElement&&(NativeSel.selectElement(el),e.preventDefault(),g.sendEvent("Billing","TapInviteUrl"))},inviteEmails:function inviteEmails(e){for(var tokens=this.refs.inviteEmails.getTokens(),emails=[],i=0;i<tokens.length;i++)emails.push(tokens[i].email);g.billingManager.sendInviteEmail(emails)},render:function render(){var BM=g.billingManager,state=this.state;return React.createElement("span",{className:"new-modal-group"},React.createElement("div",{className:"new-modal-title"},React.createElement("div",{className:"title"},"Share Moo.do with your friends"),React.createElement("div",{className:"subtext center"},"Thank you for spreading the ",React.createElement("i",{className:"icon-heart red"}))),React.createElement("div",{className:"new-modal-center"},React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Social"),React.createElement("span",{className:"shareIcons"},React.createElement(FancyButton,{iconSize:22,icon:"icon-twitter",tooltip:"@MooDoApp",onClick:BM.shareTwitter.bind(BM)}),React.createElement(FancyButton,{iconSize:22,marginLeft:16,marginRight:16,icon:"icon-facebook",tooltip:"@MooDoApp",onClick:BM.shareFacebook.bind(BM)}),React.createElement(FancyButton,{iconSize:22,icon:"icon-google-plus",tooltip:"@MooDoApp",onClick:BM.shareGoogle.bind(BM)})),React.createElement("br",null),React.createElement("br",null),React.createElement("div",{className:"subtitle"},"Share Link"),React.createElement("div",{className:"subtext"},BM.getSelectText()),React.createElement(FancyInput,{display:"inline-block",width:280,height:36,value:BM.getInviteUrl(),onMouseDown:this.onTapInviteUrl,readonly:!0}),React.createElement("br",null),React.createElement("br",null),React.createElement("div",{className:"subtitle"},"Share by email"),React.createElement("div",{className:"subtext"},"Separate multiple email addresses with commas."),React.createElement(FancyInput,{ref:"inviteEmails",width:350,buttonWidth:70,height:36,autocompleteMode:"email",placeholder:"Add friends' email addresses",buttonText:"SEND",onButtonClick:this.inviteEmails}),(state.inviteEmailSuccess||state.inviteEmailError)&&React.createElement("div",{id:"inviteEmailMessage",className:g.classNames({success:state.inviteEmailSuccess},{error:state.inviteEmailError})},state.inviteEmailSuccess||state.inviteEmailError))))}});return ReactInviteSection}),define("Components/FancyLoader",["require","exports","module","react","globals"],function(require,exports,module){var React=require("react"),g=require("globals"),FancyLoader=function FancyLoader(props){var style={},size=props.size||20,heightIcon=props.size||20,styleIcon={fontSize:size,height:heightIcon,width:heightIcon,lineHeight:heightIcon+"px"};(props.top||props.left)&&(style.position="absolute",style.left=props.left||"50%",style.top=props.top||"50%",styleIcon.marginLeft=-size/2,styleIcon.marginTop=-size/2+20);var cls=g.classNames("fancyLoader",{center:props.center},{inline:props.inline});return React.createElement("div",{className:cls,style:style},React.createElement("div",{className:"icon-spinner",style:styleIcon}),props.children&&React.createElement("div",{className:"fancyLoaderText"},props.children))};return FancyLoader}),define("Components/FancyCheckbox",["require","globals","react","Observable","MooReact"],function(require){var g=require("globals"),React=require("react"),Observable=require("Observable"),MooReact=require("MooReact"),animTime=300,FancyCheckbox=MooReact.createClass({displayName:"FancyCheckbox",propTypes:{id:React.PropTypes.string,onChange:React.PropTypes.func,className:React.PropTypes.string,checked:React.PropTypes.oneOfType([React.PropTypes.bool,Observable]),radio:React.PropTypes.bool,error:React.PropTypes.bool,disabed:React.PropTypes.bool,canChange:React.PropTypes.bool},init:function init(){var obs={animCheck:!1};this.props.checked instanceof Observable?(this.checked=this.props.checked,this.trackObservable=!0):obs.checked=this.props.checked,this.createObservables(obs)},getState:function getState(){return this.trackObservable?{checked:this.checked}:{}},onClick:function onClick(){var props=this.props;if(!props.disableToggle){this.animCheck.set(!0),setTimeout(function(){this.animCheck.set(!1)}.bind(this),animTime);var val=!this.checked.get();this.trackObservable||this.checked.set(val),props.onChange&&props.onChange(val)}props.onClick&&props.onClick(val)},getValue:function getValue(){return this.checked.get()},setValue:function setValue(value){return this.checked.set(value)},onChangeInput:function onChangeInput(){},componentWillReceiveProps:function componentWillReceiveProps(nextProps){this.trackObservable||nextProps.checked===this.state.checked||this.checked.set(nextProps.checked)},render:function render(){var props=this.props,checked=this.state.checked;this.isTrackingObservable&&(checked=checked.get());var cls=g.classNames("fancyCheckbox",{checked:checked},{disabled:props.disabled},{animate:this.state.animCheck},{radio:props.radio},{error:props.error},{noBG:props.noBG},props.className);return React.createElement("span",{className:cls,onClick:props.canChange!==!1&&this.onClick,id:props.id,style:props.style},React.createElement("input",{className:"fancyCheckboxInput",type:"checkbox",checked:checked,onChange:this.onChangeInput}),React.createElement("span",{className:"fancyCheckboxCheck"}),this.props.children&&React.createElement("span",{className:"fancyCheckboxText"},this.props.children))}});return FancyCheckbox}),define("Components/FancyTable",["require","exports","module","globals","platform","react","MooReact"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),FancyTable=MooReact.createClass({displayName:"FancyTable",propTypes:{id:React.PropTypes.string,className:React.PropTypes.string},render:function render(){var cls=g.classNames("fancyTable",this.props.className);return React.createElement("div",{className:cls,id:this.props.id},this.props.children)}});return FancyTable}),define("Components/FancyInputNumber",["require","exports","module","globals","platform","react","MooReact","Autocomplete","NativeSel"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Autocomplete=require("Autocomplete"),NativeSel=require("NativeSel"),FancyInputNumber=MooReact.createClass({displayName:"FancyInputNumber",propTypes:{onChange:React.PropTypes.func,value:React.PropTypes.number,id:React.PropTypes.string,className:React.PropTypes.string,minValue:React.PropTypes.number,maxValue:React.PropTypes.number},init:function init(){var obs={isFocused:!1,value:this.props.value||0};this.createObservables(obs)},componentWillReceiveProps:function componentWillReceiveProps(nextProps){nextProps.value!==this.props.value&&this.value.set(nextProps.value)},setValue:function setValue(value){try{g.PAssert(4844,g.isNumber(value),"Must only report a numerical value")}catch(PERR){g.reportError(PERR)}this.value.get()!==value&&(this.value.set(value),this.props.onChange&&this.props.onChange(value))},focus:function focus(){this.refs.input.focus()},onFocus:function onFocus(){this.isFocused.set(!0)},onBlur:function onBlur(){this.isFocused.set(!1)},onClickUp:function onClickUp(){var value=Math.min(this.value.get()+1,this.props.maxValue||1/0);this.setValue(value)},onClickDown:function onClickDown(){var value=Math.max(this.value.get()-1,this.props.minValue||0);this.setValue(value)},onChange:function onChange(e){var value=parseInt(this.refs.input.value);isNaN(value)?this.refs.input.value=this.value.get():this.setValue(value)},render:function render(){var state=this.state,props=this.props,cls=g.classNames("fancyInputNumber",this.props.className),style={};return React.createElement("div",{className:cls,id:this.props.id,style:style},React.createElement("input",{onChange:this.onChange,value:state.value,ref:"input"}),React.createElement("div",{className:"fancyInputNumberButton up icon-caret-up",onClick:this.onClickUp}),React.createElement("div",{className:"fancyInputNumberButton down icon-caret-down",onClick:this.onClickDown}))}});return FancyInputNumber}),define("ReactModalSettingsPlugins",["require","exports","module","globals","Constants","data","react","MooReact","PluginSettings","AccountManager","Components/FancyLoader","Components/FancyCheckbox","Components/FancyButton","Components/FancyTable","Components/FancyInputNumber","Components/FancyInput"],function(require,exports,module){var g=require("globals"),C=require("Constants"),d=require("data"),React=require("react"),MooReact=require("MooReact"),PS=require("PluginSettings"),AccountManager=require("AccountManager"),FancyLoader=require("Components/FancyLoader"),FancyCheckbox=require("Components/FancyCheckbox"),FancyButton=require("Components/FancyButton"),FancyTable=require("Components/FancyTable"),FancyInputNumber=require("Components/FancyInputNumber"),FancyInput=require("Components/FancyInput"),ReactModalSettingsPlugins=MooReact.createClass({displayName:"ReactModalSettingsPlugins",propTypes:{},init:function init(){this.hadCalendarSyncUpdated=!1,this.hadGmailSyncUpdated=!1,this.pluginsEnabled={},this.pluginOptions={},this.createObservables({addingCalendar:!1}),PS.refresh()},componentDidMount:function componentDidMount(){this.listenTo(AccountManager.onAccountsUpdated)},onUnmount:function onUnmount(){if(this.hadCalendarSyncUpdated){var pluginGCalendar=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar);pluginGCalendar.isActive()&&pluginGCalendar.forceRemoteEventSync()}if(this.hadGmailSyncUpdated){var pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);pluginGmail.isActive()&&pluginGmail._forceThreadSync()}},getState:function getState(){var state={premiumStatus:g.billingManager._premiumStatus,contacts:d.contactManager._contacts,GCalendarsAvailable:PS.GCalendarsAvailable,GCalendarSyncErrors:PS.GCalendarSyncErrors,GCalendarAddFailure:PS.GCalendarAddFailure,GCalendarListFailure:PS.GCalendarListFailure,GCalendarListLoading:PS.GCalendarListLoading,GmailNumSyncd:PS.GmailNumSyncd,GmailNumTotal:PS.GmailNumTotal,GmailCacheSize:PS.GmailCacheSize,enableOfflineAuth:PS.enableOfflineAuth,GmailSyncAccounts:PS.GmailSyncAccounts,linkedAccounts:AccountManager.getLinkedAccounts()};this.enableOfflineAuth=PS.enableOfflineAuth;for(var pluginsEnabled=PS.pluginsAvailable,i=0;i<pluginsEnabled.length;++i){var pluginID=pluginsEnabled[i];this.pluginsEnabled[pluginID]=state[pluginID+"Enabled"]=PS.getPluginEnabledObservable(pluginID);var options=PS.getPluginOptions(pluginID);for(var option in options)if(options.hasOwnProperty(option)){var a=pluginID+"_"+option;this.pluginOptions[a]=state[a]=options[option]}}return state},openSection:function openSection(section){this.props.openSection(section)},toggleCalendarImport:function toggleCalendarImport(calendar){var option=PluginSettingsID.GCalendar.ImportCalendars,importCalendars=(this.state[PluginID.GCalendar+"_"+option]||[]).slice(0),wasExportCalendar=this.isExportCalendar(calendar);wasExportCalendar&&this.disableCalendarExport(calendar);var calendarIndex=importCalendars.indexOfWithProperty("id",calendar.id);if(calendarIndex>=0)importCalendars.removeAt(calendarIndex);else{try{g.PAssert(4845,!wasExportCalendar,"Export calendar state must be matching with import calendar state")}catch(PERR){g.reportError(PERR)}importCalendars.push({id:calendar.id,summary:calendar.summary,accessRole:calendar.accessRole})}PS.setPluginOption(PluginID.GCalendar,option,importCalendars,!1),this.hadCalendarSyncUpdated=!0},enableCalendarExport:function enableCalendarExport(calendar){PS.setPluginOption(PluginID.GCalendar,PluginSettingsID.GCalendar.WriteAccess,!0,!0,function(success){success&&(PS.setPluginOption(PluginID.GCalendar,PluginSettingsID.GCalendar.ExportCalendar,calendar.id,!1),this.hadCalendarSyncUpdated=!0,this.isImportCalendar(calendar)||this.toggleCalendarImport(calendar))}.bind(this))},disableCalendarExport:function disableCalendarExport(calendar){PS.setPluginOption(PluginID.GCalendar,PluginSettingsID.GCalendar.WriteAccess,!1,!1,function(success){success&&PS.setPluginOption(PluginID.GCalendar,PluginSettingsID.GCalendar.ExportCalendar,null,!1)})},toggleCalendarExport:function toggleCalendarExport(calendar){this.isExportCalendar(calendar)?this.disableCalendarExport(calendar):this.enableCalendarExport(calendar)},onAddCalendarClick:function onAddCalendarClick(){PS.setPluginOption(PluginID.GCalendar,PluginSettingsID.GCalendar.WriteAccess,!0,!1,function(success){success?(this.addingCalendar.set(!0),setTimeout(function(){this.refs.addCalendar.focus()}.bind(this),0)):g.toasts.pushMessage({text:"Moo.do needs write access to create a new calendar.",actionText:"OKAY"})}.bind(this))},onAddButtonClick:function onAddButtonClick(){var text=this.refs.addCalendar.getValue();PS.addCalendar(text),this.addingCalendar.set(!1)},isImportCalendar:function isImportCalendar(calendarInfo){var isImport=!1;if(this.state.GCalendar_importCalendars)for(var i=0;i<this.state.GCalendar_importCalendars.length;++i){var info=this.state.GCalendar_importCalendars[i];if(g.isObject(info)||(info={id:info}),info.id===calendarInfo.id){isImport=!0;break}}return isImport},isExportCalendar:function isExportCalendar(calendarInfo){var isExport=!1;return this.state.GCalendar_exportCalendar&&(isExport=this.state.GCalendar_exportCalendar===calendarInfo.id),isExport},renderGmailSettings:function renderGmailSettings(){var pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail),syncTime=pluginGmail.getSetting(PluginSettingsID.Gmail.SyncTime),maxValue=g.billingManager.hasPremium()?C.MaxGmailSyncTime.Premium:C.MaxGmailSyncTime.Free,settings=React.createElement("div",{className:"flexbox",style:{lineHeight:"38px",padding:"16px 24px"}},React.createElement("span",{style:{width:140}},"Offline sync days"),React.createElement(FancyInputNumber,{value:syncTime,minValue:0,maxValue:maxValue,onChange:this.onSyncTimeChanged}));return React.createElement("div",{className:"subOption gmailSettings"},settings)},renderCalendarSettings:function renderCalendarSettings(){var state=this.state,table,displaySettings,divError,numErrors=0,syncErrors=state.GCalendarSyncErrors,isOAuthError=!1;if(syncErrors)for(var i=0;i<syncErrors.length;i++){var result=syncErrors[i].result;result===C.SyncResult.FailureOAuth?isOAuthError=!0:(result===C.SyncResult.FailureNoRead||result===C.SyncResult.FailureNoWrite)&&numErrors++}var pluginGCalendar=g.vmMain.pluginManager.getPlugin(PluginID.GCalendar),hasWriteAccess=pluginGCalendar.getSetting(PluginSettingsID.GCalendar.WriteAccess),weeksPast=pluginGCalendar.getSetting(PluginSettingsID.GCalendar.WeeksPast),weeksFuture=pluginGCalendar.getSetting(PluginSettingsID.GCalendar.WeeksFuture),noExportOAuth=!1;return!hasWriteAccess&&this.state.GCalendar_exportCalendar&&(noExportOAuth=!0),isOAuthError&&0===state.GCalendarsAvailable.length?divError=React.createElement("center",null,React.createElement("div",{className:"error"},"We encountered a sync error. Please allow access to your calendar."),React.createElement("br",null),React.createElement(FancyButton,{raised:!0,primary:!0,onClick:PS.enablePlugin.bind(PS,PluginID.GCalendar)},"ALLOW")):state.GCalendarListFailure?divError=React.createElement("center",null,React.createElement("div",{className:"error"},"There was an error syncing your calendar list. Please try again."),React.createElement("br",null),React.createElement(FancyButton,{raised:!0,primary:!0,onClick:PS.updateCalendarList.bind(PS)},"RETRY")):state.GCalendarListLoading?divError=React.createElement(FancyLoader,null,"Loading Google Calendars..."):(numErrors>0&&(divError=React.createElement("center",null,React.createElement("div",{style:{maxWidth:600,lineHeight:1.5,marginBottom:16},className:"error"},"There was an error reading or saving to your calendars. Please check your Google Calendar settings. The affected calendars are marked with a ",React.createElement(FancyCheckbox,{checked:!0,error:!0,style:{marginLeft:5,marginRight:5}})," below."))),table=React.createElement(FancyTable,{className:"calendarSettingsTable"},React.createElement("div",{key:"header"},React.createElement("div",null,"Calendar Name"),React.createElement("div",null,"Sync From"),React.createElement("div",null,"Save To")),state.GCalendarsAvailable.map(function(calendar,index){var isImport=this.isImportCalendar(calendar),isExport=this.isExportCalendar(calendar),isWritable="owner"===calendar.accessRole||"writer"===calendar.accessRole,cls=g.classNames("calendarSettingsName",{"import":isImport},{"export":isExport});if(syncErrors){var calErrorIndex=syncErrors.indexOfWithProperty("id",calendar.id),readError=null,writeError=null;if(calErrorIndex>=0){var calError=syncErrors[calErrorIndex];calError.result===C.SyncResult.FailureNoRead?readError=!0:calError.result===C.SyncResult.FailureNoRead&&(writeError=!0)}}return React.createElement("div",{key:"row"+index},React.createElement("div",{className:cls},calendar.summary||calendar.id),React.createElement(FancyCheckbox,{checked:isImport,error:readError,onChange:this.toggleCalendarImport.bind(this,calendar)}),isWritable?React.createElement(FancyCheckbox,{checked:isExport,enabled:isWritable,error:readError||writeError||isExport&&noExportOAuth,radio:!0,onChange:this.toggleCalendarExport.bind(this,calendar)}):React.createElement("div",null))}.bind(this)),state.GCalendarAddFailure&&React.createElement("div",{key:"footerError"},React.createElement("div",{style:{textAlign:"center"}},"There was an error creating your new calendar. Please try again.")),state.addingCalendar&&React.createElement("div",{key:"footer"},React.createElement(FancyInput,{ref:"addCalendar",floatingText:"New calendar name",padding:{left:24,right:24},height:50,buttonText:"ADD",onButtonClick:this.onAddButtonClick})),!state.addingCalendar&&React.createElement("div",{key:"footer"},React.createElement("div",{style:{textAlign:"center"}},React.createElement(FancyButton,{height:"auto",onClick:this.onAddCalendarClick},"ADD NEW CALENDAR")))),displaySettings=React.createElement("div",{style:{lineHeight:"38px",padding:"16px 24px"}},React.createElement("span",{style:{display:"inline-block",width:140}},"Weeks in the past"),React.createElement(FancyInputNumber,{value:weeksPast,minValue:0,maxValue:7,onChange:this.onChangeWeeksPast}),React.createElement("span",{style:{display:"inline-block",marginLeft:32,width:140}},"Weeks in the future"),React.createElement(FancyInputNumber,{value:weeksFuture,minValue:0,maxValue:12,onChange:this.onChangeWeeksFuture}))),React.createElement("div",{className:"subOption calendarSettings"},divError,displaySettings,table)},onChangeWeeksPast:function onChangeWeeksPast(value){g.vmMain.pluginManager.setSetting(PluginID.GCalendar,PluginSettingsID.GCalendar.WeeksPast,value)},onChangeWeeksFuture:function onChangeWeeksFuture(value){g.vmMain.pluginManager.setSetting(PluginID.GCalendar,PluginSettingsID.GCalendar.WeeksFuture,value)},onSyncTimeChanged:function onSyncTimeChanged(value){g.vmMain.pluginManager.setSetting(PluginID.Gmail,PluginSettingsID.Gmail.SyncTime,value),this.hadGmailSyncUpdated=!0},onEnablePremium:function onEnablePremium(){return g.billingManager.isTrialOver()?(this.openSection(C.SettingsSections.Account),!1):void g.billingManager.startTrial()},renderPluginOptionCheckbox:function renderPluginOptionCheckbox(pluginID,option,displayText){return React.createElement(FancyCheckbox,{checked:this.pluginOptions[pluginID+"_"+option],onChange:PS.togglePluginOption.bind(PS,pluginID,option)},displayText)},renderPluginCheckbox:function renderPluginCheckbox(pluginID,displayText,icon){return React.createElement(FancyCheckbox,{checked:this.pluginsEnabled[pluginID],onChange:PS.togglePlugin.bind(PS,pluginID)},icon,displayText)},render:function render(){var BM=g.billingManager,state=this.state,sectionOpened=state.sectionOpened,hasPremium=BM.hasPremiumFeatures(),isTrialOver=BM.isTrialOver(),textPremiumOrTrial=" ("+(BM.isTrialState()?"Trial":"Premium")+")";return React.createElement("div",{key:"content",className:"new-modal-group featureCheckboxes"},React.createElement("div",{className:"new-modal-title"},React.createElement("div",{className:"title"},"Integrate with your other services"),React.createElement("div",{className:"subtext center"},"Use ",React.createElement("b",null,"Moo.do")," to organize everything in one place")),React.createElement("div",{className:"new-modal-row new-modal-row-1c"},React.createElement("div",{className:"modal-group-title"},React.createElement(FancyCheckbox,{checked:this.enableOfflineAuth,onChange:PS.toggleOfflineFeatures.bind(PS)},"Offline Features")),React.createElement("div",{className:"settingPluginOptions"},React.createElement("div",{className:"subtext"},React.createElement("span",null,"Enable offline authorization to enable features like delayed mail send and snooze.")))),React.createElement("div",{className:"new-modal-row new-modal-row-1c"},React.createElement("div",{className:"modal-group-title"},this.renderPluginCheckbox(PluginID.Contacts,"Google Contacts",React.createElement("i",{className:"icon-group"}))),React.createElement("div",{className:"settingPluginOptions"},React.createElement("div",{className:"subtext"},React.createElement("span",null,"We will not send emails or otherwise communicate with your contacts unless you ask us to."),state.ContactsEnabled&&React.createElement("span",null," If you need instant access to contacts you just added you can sync them by pressing the button below, otherwise your contacts will appear automatically after a few hours.")),state.ContactsEnabled&&React.createElement("div",{className:"center"},React.createElement(FancyButton,{id:"refreshContacts",raised:!0,primary:!0,onClick:PS.onTapRefreshContacts.bind(PS)},"REFRESH CONTACTS"),React.createElement("div",{id:"numContacts"},state.contacts.length+" contacts loaded")))),React.createElement("div",{className:"new-modal-row new-modal-row-1c"},React.createElement("div",{className:"rowWrapper"},React.createElement("div",{className:"modal-group-title"},this.renderPluginCheckbox(PluginID.Gmail,"Gmail",React.createElement("img",{src:"/img/plugin-gmail.png"}))),state.GmailEnabled&&React.createElement("div",{className:"settingPluginOptions"},React.createElement("div",{className:"subtext"},"Enable Gmail to read, write, and organize your email. We do not send any of your email data to our servers."),this.renderGmailSettings()))),React.createElement("div",{className:!hasPremium&&"featureTier featuresDisabled",style:{marginTop:!hasPremium&&"32px"}},!hasPremium&&React.createElement("div",null,React.createElement("div",{className:"tierTitleWrapper"},React.createElement(FancyCheckbox,{ref:"free",className:"tierTitle",checked:!1,onChange:this.onEnablePremium},"Enable Premium Features")),isTrialOver&&React.createElement("div",{className:"featureTierDesc"},"Your free trial of Premium has ended. Please signup to continue using premium features or contact support@moo.do to extend."),!isTrialOver&&React.createElement("div",{className:"featureTierDesc"},"Enabling Premium features will start a free "+C.TrialDuration+" day trial of Moo.do Premium.")),React.createElement("div",{className:"new-modal-row new-modal-row-1c"},React.createElement("div",{className:"rowWrapper"},React.createElement("div",{className:"modal-group-title"},this.renderPluginCheckbox(PluginID.Drive,"Google Drive"+textPremiumOrTrial,React.createElement("img",{src:"/img/plugin-gdrive.png"}))),state.DriveEnabled&&hasPremium&&React.createElement("div",{className:"settingPluginOptions"},React.createElement("div",{className:"subtext"},"By default we are not able to read your files in Google Drive or change them in any way. Without this access, any files that you put in your Moo.do will not be automatically shared with collaborators. If you would like to share files using Moo.do, you need to provide additional access to your Drive files."),React.createElement("span",{className:"subOption"},this.renderPluginOptionCheckbox(PluginID.Drive,PluginSettingsID.Drive.WriteAccess,"Enable Shared Drive"))))),PS.isPluginAnOption("Mailbird")&&React.createElement("div",{className:"new-modal-row new-modal-row-1c"},React.createElement("div",{className:"modal-group-title"},React.createElement(FancyCheckbox,{checked:!0,disabled:!0},"Mailbird"))),PS.isPluginAnOption("GCalendar")&&React.createElement("div",{className:"new-modal-row new-modal-row-1c"},React.createElement("div",{className:"rowWrapper"},React.createElement("div",{className:"modal-group-title"},this.renderPluginCheckbox(PluginID.GCalendar,"Google Calendar"+textPremiumOrTrial,React.createElement("img",{src:"/img/plugin-gcal.png"}))),state.GCalendarEnabled&&hasPremium&&React.createElement("div",{className:"settingPluginOptions"},React.createElement("div",{className:"subtext"},"By default we are not able to modify your calendar or calendar events. Adding a 'Save To' calendar to below will sync your local changes to your Google Calendar."),this.renderCalendarSettings())))))}});return ReactModalSettingsPlugins
}),define("ReactModalSettingsAccounts",["require","exports","module","globals","gdata","goog","react","MooReact","International","Components/FancyButton"],function(require,exports,module){var g=require("globals"),gdata=require("gdata"),goog=require("goog"),React=require("react"),MooReact=require("MooReact"),International=require("International"),FancyButton=require("Components/FancyButton"),ReactModalSettingsAccounts=MooReact.createClass({displayName:"ReactModalSettingsAccounts",propTypes:{},componentDidMount:function componentDidMount(){this.listenTo(g.billingManager.triggerBlocksUpdated)},getState:function getState(){var BM=g.billingManager,state={validBilling:BM._hasValidBillingData,premiumStatus:BM._premiumStatus,daysLeftInTrial:BM.daysLeftInTrial,trialOverHidden:g.settings.get(Settings.trialOverHidden)};return state},onClickDismissTrial:function onClickDismissTrial(){g.settings.set(Settings.trialOverHidden,!0),this.updateState()},render:function render(){var BM=g.billingManager,state=this.state,user=gdata.authenticatedUser(),name=user&&user.displayName,email=goog.getCurrentUserEmail(),priceMonthly=BM.getMonthlyPrice(),priceYearly=BM.getYearlyPrice();return React.createElement("div",{key:"content",className:"new-modal-group"},BM.isTrialOver()&&!state.trialOverHidden&&React.createElement("div",{className:"new-modal-row-1c"},React.createElement("div",{className:"new-modal-row trialEnd"},React.createElement("div",null,"Your trial has ended. Please sign up to continue using Premium features."),React.createElement("div",{className:"center",style:{marginTop:16}},React.createElement(FancyButton,{raised:!0,onClick:this.onClickDismissTrial},"DISMISS"))),React.createElement("hr",null)),React.createElement("div",{className:"new-modal-title"},React.createElement("div",{className:"title"},name&&"Hi "+name),state.validBilling&&BM.isTrialState()&&React.createElement("div",{className:"subtext center"},"We hope your trial of Premium is going well."),state.validBilling&&BM.hasPremium()&&React.createElement("div",{className:"subtext center"},"We are very happy to have you as a Premium Member."),state.validBilling&&!BM.hasPremium()&&!BM.isTrialState()&&React.createElement("div",{className:"subtext center"},"We hope Moo.do is helping you be productive.")),React.createElement("div",{className:"new-modal-row new-modal-row-2c"},React.createElement("div",{className:"left-header"},"ACCOUNT STATUS"),React.createElement("div",{className:"right-content"},React.createElement("div",{className:"flexrow new-modal-subrow"},React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Account email"),React.createElement("div",{className:"subtext"},email))),React.createElement("div",{className:"accountStatus flexrow new-modal-subrow"},React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Member since"),React.createElement("div",{className:"subtext"},BM.getJoinDate().toString(International.getFormat(DFormat.LongStrDate)))),BM.isTrialState()&&!BM.isTrialOver()&&React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Days left in trial"),React.createElement("div",{className:"subtext"},state.daysLeftInTrial)),BM.canceledUserHasPremiumAccess()&&React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Premium end"),React.createElement("div",{className:"subtext"},BM.getPremiumEndDate().toString(International.getFormat(DFormat.LongStrDate)))),!BM.hasPremium()&&React.createElement("div",null,React.createElement(FancyButton,{raised:!0,onClick:BM.onTapDeleteAccount.bind(BM)},"DELETE ACCOUNT")),BM.hasPremium()&&React.createElement("div",null,React.createElement(FancyButton,{raised:!0,onClick:BM.onTapUpdatePaymentMethod.bind(this)},"UPDATE PAYMENT METHOD")),BM.hasPremium()&&React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Premium since"),React.createElement("div",{className:"subtext"},BM.getPremiumStartDate().toString(International.getFormat(DFormat.LongStrDate)))),BM.hasPremium()&&React.createElement("div",null,React.createElement(FancyButton,{raised:!0,onClick:BM.onTapCancelSubscription.bind(BM)},"CANCEL PREMIUM")),BM.hasPremium()&&React.createElement("div",null,React.createElement("div",{className:"subtitle"},"Next billing cycle"),React.createElement("div",{className:"subtext"},BM.getNextBillingDate().toString(International.getFormat(DFormat.LongStrDate))))))),!BM.hasPremium()&&React.createElement("span",null,React.createElement("hr",null),React.createElement("div",{className:"new-modal-title"},React.createElement("div",{className:"title"},"Premium pricing"),React.createElement("div",{className:"subtext center"},"Upgrade to Premium to connect Moo.do to all your other services."),React.createElement("div",{className:"center",style:{marginTop:16}},React.createElement(FancyButton,{fontSize:14,raised:!0,primary:!0,onClick:BM.onTapSignupMonth.bind(BM)},"$"+priceMonthly+" / month"),React.createElement(FancyButton,{fontSize:14,raised:!0,primary:!0,marginLeft:16,onClick:BM.onTapSignupYear.bind(BM)},"$"+priceYearly+" / year"))),React.createElement("table",{id:"pricingTable"},React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null),React.createElement("td",null,"Free"),React.createElement("td",null,"Premium")),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",{className:"header price"},React.createElement("td",null,"Price"),React.createElement("td",null,"Free"),React.createElement("td",null,React.createElement("div",null,"$"+priceMonthly+" / month"),React.createElement("div",null,"$"+priceYearly+" / year"))),React.createElement("tr",{className:"header"},React.createElement("td",null,"Core Features"),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",null,React.createElement("td",null,"Unlimited items"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Powerful search"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Realtime collaboration"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",{className:"header"},React.createElement("td",null,"Plugins"),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",null,React.createElement("td",null,React.createElement("i",{className:"icon-group"}),"Google Contacts"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,React.createElement("img",{src:"/img/plugin-mailbird.png"}),"Mailbird"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,React.createElement("img",{src:"/img/plugin-gdrive.png"}),"Google Drive"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",{className:"header"},React.createElement("td",null,React.createElement("img",{src:"/img/plugin-gmail.png"}),"Gmail"),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",null,React.createElement("td",null,"Standard email features"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Offline sync"),React.createElement("td",null,"2 days"),React.createElement("td",null,"30 days")),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",{className:"header"},React.createElement("td",null,React.createElement("img",{src:"/img/plugin-gcal.png"}),"Google Calendar"),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",null,React.createElement("td",null,"Sync Moo.do tasks"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Manage Calendar in Moo.do"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",{className:"header"},React.createElement("td",null,"Customization"),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",null,React.createElement("td",null,"Display settings presets"),React.createElement("td",{className:"icon-ok"}),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Advanced display settings"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",{className:"header"},React.createElement("td",null,"We love you",React.createElement("i",{className:"icon-heart"})),React.createElement("td",null),React.createElement("td",null)),React.createElement("tr",null,React.createElement("td",null,"Early access to new features"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Premium support"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",null,React.createElement("td",null,"Help us grow"),React.createElement("td",null),React.createElement("td",{className:"icon-ok"})),React.createElement("tr",{className:"empty"},React.createElement("td",null),React.createElement("td",null),React.createElement("td",null))))))}});return ReactModalSettingsAccounts}),define("ReactModalSettingsEarly",["require","exports","module","globals","gdata","react","MooReact","Components/FancyLoader","Components/FancyButton"],function(require,exports,module){var g=require("globals"),gdata=require("gdata"),React=require("react"),MooReact=require("MooReact"),FancyLoader=require("Components/FancyLoader"),FancyButton=require("Components/FancyButton"),ReactModalSettingsEarly=MooReact.createClass({displayName:"ReactModalSettingsEarly",propTypes:{},init:function init(){this.createObservables({isSendingFeedback:!1})},openSection:function openSection(section){this.props.openSection(section)},onClickDiscard:function onClickDiscard(){this.refs.feedback.value="",this.refs.feedback.focus()},onClickSend:function onClickSend(e,cb){var desc=this.refs.feedback.value;if(desc&&desc.length>2){this.isSendingFeedback.set(!0);var name="Early Access Feedback: "+this.refs.selectFeature.value;return g.sendFeedback(name,desc,function(){this.refs.feedback.value="",this.isSendingFeedback.set(!1),cb&&g.isFunction(cb)&&cb()}.bind(this)),!0}},render:function render(){var BM=g.billingManager,props=this.props,state=this.state;return React.createElement("div",{key:"content",className:"new-modal-group"},React.createElement("div",{className:"new-modal-title"},React.createElement("div",{className:"title"},(BM.hasEarlyAccess()?"":"Get ")+"Early Access to New Features"),React.createElement("div",{className:"subtext middle"},"Premium members get sneak previews of new features ahead of their full release. Your valuable feedback on Early Access features helps us build the features that people want :)."),React.createElement("div",{id:"earlyAccess"})),BM.hasEarlyAccess()&&React.createElement("div",{className:"earlyAccessFeedback"},React.createElement("div",{className:"subtitle",style:{fontSize:16,marginBottom:16}},"Send feedback"),React.createElement("div",{style:{margin:"12px 0"}},React.createElement("span",{style:{marginRight:16}},"Feature:"),React.createElement("select",{defaultValue:"Gmail",ref:"selectFeature"},React.createElement("option",{value:"Gmail"},"Gmail"),React.createElement("option",{value:"General"},"General"))),React.createElement("textarea",{className:"feedbackTextArea",ref:"feedback",style:{marginBottom:16,color:state.isSendingFeedback?"#aaa":null}}),state.isSendingFeedback&&React.createElement(FancyLoader,{top:100}),React.createElement("div",{style:{textAlign:"right"}},React.createElement(FancyButton,{raised:!0,onClick:this.onClickDiscard},"DISCARD"),React.createElement(FancyButton,{raised:!0,primary:!0,marginLeft:16,onClick:this.onClickSend},"SEND"))),!BM.hasEarlyAccess()&&React.createElement("div",{className:"new-modal-row center"},React.createElement("div",{className:"title"},"Learn more about premium"),React.createElement("div",{className:"subtext"},"Early access is one of many benefits of being a Premium Member."),React.createElement("br",null),React.createElement(FancyButton,{raised:!0,primary:!0,onClick:this.openSection.bind(this,"account")},"ABOUT PREMIUM")))}});return ReactModalSettingsEarly}),define("ReactModalSettingsLinked",["require","exports","module","globals","gdata","goog","react","MooReact","AccountManager","PluginSettings","Components/FancyLoader","Components/FancyButton","Components/FancyCheckbox","Components/FancyInput","Components/FancyTable"],function(require,exports,module){var g=require("globals"),gdata=require("gdata"),goog=require("goog"),React=require("react"),MooReact=require("MooReact"),AccountManager=require("AccountManager"),PluginSettings=require("PluginSettings"),FancyLoader=require("Components/FancyLoader"),FancyButton=require("Components/FancyButton"),FancyCheckbox=require("Components/FancyCheckbox"),FancyInput=require("Components/FancyInput"),FancyTable=require("Components/FancyTable"),ReactModalSettingsLinked=MooReact.createClass({displayName:"ReactModalSettingsLinked",propTypes:{},init:function init(){this.createObservables({addingAccount:!1,errorMessage:"",linkingAccount:!1}),PluginSettings.refresh()},componentDidMount:function componentDidMount(){this.listenTo(AccountManager.onAccountsUpdated)},getState:function getState(){var state={gmailSyncAccounts:PluginSettings.GmailSyncAccounts,linkedAccounts:AccountManager.getLinkedAccounts()};return state},linkAccount:function linkAccount(email,addScopes,cb){var scopes=[GScope.UserInfoEmail];return scopes.pushArray(addScopes),AccountManager.linkAccount(email,scopes,cb),!0},removeAccount:function removeAccount(email){this.errorMessage.set("");var pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail);AccountManager.removeLinkedAccount(email,function(success){success||g.toasts.pushMessage({text:"There was an error unlinking your account.",actionText:"RETRY",action:this.removeAccount.bind(this,email)})}.bind(this)),pluginGmail.hasSyncAccount(email)&&pluginGmail.removeSyncAccount(email,function(){PluginSettings.refresh()})},addAccount:function addAccount(email){AccountManager.isDefaultEmail(email)?g.toasts.pushMessage({text:"Please use the 'Plugins' section to manage your main account."}):(AccountManager.addLinkedAccount(email),this.enableGmailSync(email,!0))},enableGmailSync:function enableGmailSync(email,value){this.errorMessage.set("");var pluginGmail=g.vmMain.pluginManager.getPlugin(PluginID.Gmail),reportFailure=function(){this.errorMessage.set("There was an error linking your account. Please try again in a minute."),PluginSettings.refresh()}.bind(this);if(value){var linkingAccount=this.linkingAccount;linkingAccount.set(email),this.linkAccount(email,[GScope.GmailCompose,GScope.GmailModify],function(linkSuccess){linkSuccess?pluginGmail.addSyncAccount(email,function(success){success||reportFailure(),linkingAccount.set(!1),PluginSettings.refresh()}):(linkingAccount.set(!1),reportFailure())})}else pluginGmail.removeSyncAccount(email,function(success){success||reportFailure(),PluginSettings.refresh()})},onAddAccountClick:function onAddAccountClick(){this.errorMessage.set(""),this.addingAccount.set(!0),setTimeout(function(){this.refs.addAccount.focus()}.bind(this),0)},onAddButtonClick:function onAddButtonClick(){this.errorMessage.set("");var email=this.refs.addAccount.getValue();this.addAccount(email),this.addingAccount.set(!1)},renderAccount:function renderAccount(email){var isGmailEnabled=this.state.gmailSyncAccounts.indexOf(email)>=0,hasError=isGmailEnabled&&AccountManager.isConnected()&&(!AccountManager.isAuthorized(email,GScope.GmailCompose)||!AccountManager.isCurrentlyAuthorized(email)),isLinkingAccount=this.state.linkingAccount===email,clsRow=g.classNames("accountRow",{linking:isLinkingAccount});return React.createElement("div",{key:"row"+email,className:clsRow},React.createElement(FancyButton,{icon:"icon-close",iconSize:20,width:50,height:50,onClick:this.removeAccount.bind(this,email),tooltip:"Unlink Account"}),React.createElement("div",null,email),React.createElement(FancyCheckbox,{checked:isGmailEnabled,error:hasError,onChange:this.enableGmailSync.bind(this,email)}),isLinkingAccount&&React.createElement(FancyLoader,{inline:!0},"Linking account..."))},getAccountList:function getAccountList(){var accounts=[];accounts.pushOnlyUniques(this.state.linkedAccounts),accounts.pushOnlyUniques(this.state.gmailSyncAccounts);var defaultAccount=goog.getCurrentUserEmail();return accounts.filter(function(email){return email!==defaultAccount})},render:function render(){var accountList=this.getAccountList(),accountTable=React.createElement(FancyTable,{className:"gmailAccountTable"},React.createElement("div",{key:"header"},React.createElement("div",null),React.createElement("div",null,"Account"),React.createElement("div",null,"Gmail")),accountList.map(this.renderAccount));return React.createElement("div",{key:"content",className:"new-modal-group"},React.createElement("div",{className:"new-modal-title"},React.createElement("div",{className:"title"},"Linked Accounts"),React.createElement("div",{className:"subtext center"},"Link multiple accounts together")),accountTable,this.state.addingAccount&&React.createElement("div",{key:"footer",style:{padding:"0 32px"}},React.createElement(FancyInput,{ref:"addAccount",floatingText:"Account Email",padding:{left:24,right:24},height:50,buttonText:"ADD",onButtonClick:this.onAddButtonClick})),this.state.errorMessage&&React.createElement("div",{key:"errorMessage",style:{textAlign:"center"}},this.state.errorMessage),!this.state.addingAccount&&React.createElement("div",{key:"footer"},React.createElement("div",{style:{textAlign:"center"}},React.createElement(FancyButton,{height:50,onClick:this.onAddAccountClick},"LINK ACCOUNT"))))}});return ReactModalSettingsLinked});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("Components/FancyListItem",["require","exports","module","globals","platform","react","MooReact","Components/FancyRippler"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),FancyRippler=require("Components/FancyRippler"),FancyListItem=MooReact.createClass({displayName:"FancyListItem",propTypes:{id:React.PropTypes.string,className:React.PropTypes.string,selected:React.PropTypes.bool},render:function render(){var props=this.props,cls=g.classNames("fancyListItem",{header:props.header},{clickable:!props.header&&props.clickable!==!1},{selected:props.selected},{subtext:props.subtext},props.className),hasRipple=props.ripple!==!1&&!props.header&&props.clickable!==!1;return hasRipple?React.createElement(FancyRippler,_extends({},props,{className:cls}),props.children):React.createElement("div",_extends({},props,{className:cls}),this.props.children)}});return FancyListItem}),define("ReactModalSettings",["require","exports","module","globals","Constants","platform","goog","gdata","react","MooReact","Observable","International","ReactInviteSection","ReactModalSettingsPlugins","ReactModalSettingsAccounts","ReactModalSettingsEarly","ReactModalSettingsLinked","Components/FancyModal","Components/FancyListItem","Components/FancyButton"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),goog=require("goog"),gdata=require("gdata"),React=require("react"),MooReact=require("MooReact"),Observable=require("Observable"),International=require("International"),ReactInviteSection=require("ReactInviteSection"),ReactModalSettingsPlugins=require("ReactModalSettingsPlugins"),ReactModalSettingsAccounts=require("ReactModalSettingsAccounts"),ReactModalSettingsEarly=require("ReactModalSettingsEarly"),ReactModalSettingsLinked=require("ReactModalSettingsLinked"),FancyModal=require("Components/FancyModal"),FancyListItem=require("Components/FancyListItem"),FancyButton=require("Components/FancyButton"),ReactModalSettings=MooReact.createClass({displayName:"ReactModalSettings",propTypes:{},init:function init(){this.createObservables({sectionOpened:this.props.section||C.SettingsSections.Plugins})},componentDidMount:function componentDidMount(){this.listenTo(g.billingManager.triggerBlocksUpdated)},getState:function getState(){var state={};return state},openSection:function openSection(name){this.sectionOpened.set(name)},showEarlyAndAccount:function showEarlyAndAccount(){return!g.isDemoMode()||!1},render:function render(){var BM=g.billingManager,state=this.state,sectionOpened=state.sectionOpened,content;return sectionOpened===C.SettingsSections.Plugins?content=React.createElement(ReactModalSettingsPlugins,{key:"content",openSection:this.openSection}):sectionOpened===C.SettingsSections.Invite?content=React.createElement(ReactInviteSection,{key:"content",openSection:this.openSection}):sectionOpened===C.SettingsSections.Early?content=React.createElement(ReactModalSettingsEarly,{key:"content",openSection:this.openSection}):sectionOpened===C.SettingsSections.Account?content=React.createElement(ReactModalSettingsAccounts,{key:"content",openSection:this.openSection}):sectionOpened===C.SettingsSections.Linked&&(content=React.createElement(ReactModalSettingsLinked,{key:"content",openSection:this.openSection})),React.createElement(FancyModal,{id:"modalSettings",title:"Settings",width:960,height:900,modalID:Modals.Settings},React.createElement("div",{key:"sidebar",width:150},React.createElement(FancyListItem,{selected:sectionOpened===C.SettingsSections.Plugins,onClick:this.openSection.bind(this,C.SettingsSections.Plugins)},"Plugins"),this.showEarlyAndAccount()&&React.createElement(FancyListItem,{selected:sectionOpened===C.SettingsSections.Early,onClick:this.openSection.bind(this,C.SettingsSections.Early)},"Early Access"),this.showEarlyAndAccount()&&React.createElement(FancyListItem,{selected:sectionOpened===C.SettingsSections.Account,onClick:this.openSection.bind(this,C.SettingsSections.Account)},"Account"),this.showEarlyAndAccount()&&React.createElement(FancyListItem,{selected:sectionOpened===C.SettingsSections.Linked,onClick:this.openSection.bind(this,C.SettingsSections.Linked)},"Linked Accounts"),React.createElement(FancyListItem,{selected:sectionOpened===C.SettingsSections.Invite,onClick:this.openSection.bind(this,"invite")},"Invite Friends")),content)}});return ReactModalSettings}),define("ReactModalAlert",["require","exports","module","react","MooReact","Hotkeys","Constants","Components/FancyButton","Components/FancyModal"],function(require,exports,module){var React=require("react"),MooReact=require("MooReact"),Hotkeys=require("Hotkeys"),C=require("Constants"),FancyButton=require("Components/FancyButton"),FancyModal=require("Components/FancyModal"),ReactModalAlert=MooReact.createClass({displayName:"ReactModalAlert",propTypes:{text:React.PropTypes.string.isRequired,actionText:React.PropTypes.string},getHotkeys:function getHotkeys(){return[Hotkeys.create(KeyCode.Enter,C.Primary.Either,C.Shift.Either,this.onClickButton)]},onClickButton:function onClickButton(){this.refs.modal.close()},render:function render(){var text=this.props.actionText||"OKAY";return React.createElement(FancyModal,{id:"modalAlert",closeButton:!1,small:!0,backdropClose:!1,scrollable:!1,modalID:Modals.Alert,ref:"modal"},React.createElement("div",{key:"content",dangerouslySetInnerHTML:{__html:this.props.text}}),React.createElement("div",{key:"buttons"},React.createElement(FancyButton,{primary:!0,onClick:this.onClickButton},text)))}});return ReactModalAlert}),define("ReactModalBilling",["require","exports","module","react","globals","MooReact","Components/FancyButton","Components/FancyLoader","Components/FancyModal"],function(require,exports,module){var BillingFailureCode={None:null,NoBraintreeGlobal:1,AddScriptFailure:2,NoRemoteToken:3,RemoteTokenParse:4,ContactingServer:5,NoClientIdentifier:6},SignupFailureCode={None:null,MissingNonce:1,MissingPlanID:2,ServerFailure:3,UnauthorizedUser:4,InvalidParameter:5,MissingParameter:6,BraintreeUnknown:7},premiumPlans=["2m4b","gjgm","pmjw","5pm2"],React=require("react"),g=require("globals"),MooReact=require("MooReact"),FancyButton=require("Components/FancyButton"),FancyLoader=require("Components/FancyLoader"),FancyModal=require("Components/FancyModal"),ReactModalBilling=MooReact.createClass({displayName:"ReactModalBilling",init:function init(params){this._braintreeRequested=!1,this._braintreeLoaded=!1,this._clientTokenRequested=!1,this._clientTokenLoaded=!1,this._clientToken=void 0,this._btClient=void 0,this._btIntegration=void 0,this._isMethodUpdate=this.props.isUpdate,this.createObservables({isSubmitting:!1,isLoading:!0,billingFailureCode:BillingFailureCode.None,signupFailureCode:SignupFailureCode.None}),this._ensureBraintreeLib(),this._ensureClientToken()},onUnmount:function onUnmount(){this._btIntegration&&(this._btIntegration.teardown(),this._btIntegration=void 0)},_handlePaymentMethodUpdate:function _handlePaymentMethodUpdate(obj){this._isMethodUpdate?obj&&obj.nonce?this._processUpdateNonce(void 0,obj.nonce):this._processUpdateNonce({error:!0},void 0):obj&&obj.nonce?this._processPaymentNonce(void 0,obj.nonce):this._processPaymentNonce({error:!0},void 0)},_notifyDependencyLoaded:function _notifyDependencyLoaded(){this._braintreeLoaded&&this._clientTokenLoaded&&(this._btClient=new braintree.api.Client({clientToken:this._clientToken}),braintree.setup(this._clientToken,"dropin",{container:"braintreeDropin",onPaymentMethodReceived:this._handlePaymentMethodUpdate,onError:function onError(err){g.reportError(err)},onReady:function(btIntegration){this.isLoading.set(!1),this._btIntegration=btIntegration}.bind(this)}))},_notifyDependencyLoadError:function _notifyDependencyLoadError(code){this.billingFailureCode.set(code),g.reportError(new Error("Client hit error in billing: "+code)),g.billingManager.setLastSignupError(code),g.sendEvent("Billing","SignupError_"+code)},_ensureBraintreeLib:function _ensureBraintreeLib(){this._braintreeRequested||(window.braintree?(this._braintreeLoaded=!0,this._notifyDependencyLoaded()):(this._braintreeRequested=!0,g.addScriptHack("https://js.braintreegateway.com/v2/braintree.js","braintreeScript",function(){window.braintree?(this._braintreeLoaded=!0,this._notifyDependencyLoaded()):(this._braintreeRequested=!1,this._notifyDependencyLoadError(BillingFailureCode.NoBraintreeGlobal))}.bind(this),function(){this._braintreeRequested=!1,this._notifyDependencyLoadError(BillingFailureCode.AddScriptFailure)}.bind(this))))},_ensureClientToken:function _ensureClientToken(){var clientId=g.billingManager.getBillingIdentifier();clientId?this._clientTokenRequested||(this._clientTokenRequested=!0,g.XHR_PrivateAPI({type:"POST",path:"/billing/getToken",data:{email:clientId},requireAuth:!0,autoRetry:!0,maxRetries:1,cb:function(xhr){if(200===xhr.status){this._clientTokenLoaded=!0;try{var response=JSON.parse(xhr.responseText).data;response&&response.token?(this._clientToken=response.token,this._notifyDependencyLoaded()):this._notifyDependencyLoadError(BillingFailureCode.NoRemoteToken)}catch(err){g.reportError(err),this._notifyDependencyLoadError(BillingFailureCode.RemoteTokenParse)}}else this._clientTokenRequested=!1,this._notifyDependencyLoadError(BillingFailureCode.ContactingServer)}.bind(this)})):this._notifyDependencyLoadError(BillingFailureCode.NoClientIdentifier)},_processUpdateNonce:function _processUpdateNonce(err,nonce){g.sendEvent("Billing","PremiumUpdate"),!err&&nonce&&(this.isSubmitting.get()||(this.isSubmitting.set(!0),g.XHR_PrivateAPI({type:"POST",path:"/billing/updateMethod",data:{nonce:nonce},requireAuth:!0,cb:function(xhr){if(this.isSubmitting.set(!1),200===xhr.status)g.menus.isModalOpen(this.id)&&this.onClickClose(),g.menus.alert({text:"Your payment information has been updated.",actionText:"OKAY"}),g.sendEvent("Billing","PremiumUpdateSUCCESS");else{if(xhr.response)try{var statusData=JSON.parse(xhr.response);switch(statusData.code){case PrivateAPIErrorCodes.UnauthorizedUser:this.signupFailureCode.set(SignupFailureCode.UnauthorizedUser);break;case PrivateAPIErrorCodes.InvalidParameter:this.signupFailureCode.set(SignupFailureCode.InvalidParameter);break;case PrivateAPIErrorCodes.MissingParameter:this.signupFailureCode.set(SignupFailureCode.MissingParameter);break;case PrivateAPIErrorCodes.BraintreeUnknown:this.signupFailureCode.set(SignupFailureCode.BraintreeUnknown);break;default:this.signupFailureCode.set(SignupFailureCode.ServerFailure)}}catch(parseErr){g.reportError(parseErr),this.signupFailureCode.set(SignupFailureCode.ServerFailure)}else this.signupFailureCode.set(SignupFailureCode.ServerFailure);g.sendEvent("Billing","PremiumUpdateFAILURE")}}.bind(this)})))},_processPaymentNonce:function _processPaymentNonce(err,nonce){if(g.sendEvent("Billing","PremiumSignup"),!err&&nonce){this.signupFailureCode.set(SignupFailureCode.None);var planID=premiumPlans[g.billingManager.getBillingPeriod()];try{g.PAssert(4846,planID,"Must have selected a valid plan to signup")}catch(PERR){g.reportError(PERR)}planID?this.isSubmitting.get()||(this.isSubmitting.set(!0),g.XHR_PrivateAPI({type:"POST",path:"/billing/signup",data:{email:g.billingManager.getBillingIdentifier(),nonce:nonce,planID:planID},requireAuth:!0,cb:function(xhr){if(this.isSubmitting.set(!1),200===xhr.status)g.billingManager.setPremiumStatus(PremiumStatus.Active),g.menus.isModalOpen(this.id)&&this.onClickClose(),g.menus.alert({text:"Thank you for signing up for <b>Moo.do</b> premium!",actionText:"OKAY"}),g.sendEvent("Billing","PremiumSignupSUCCESS");else{if(xhr.response)try{var statusData=JSON.parse(xhr.response);switch(statusData.code){case PrivateAPIErrorCodes.UnauthorizedUser:this.signupFailureCode.set(SignupFailureCode.UnauthorizedUser);break;case PrivateAPIErrorCodes.InvalidParameter:this.signupFailureCode.set(SignupFailureCode.InvalidParameter);break;case PrivateAPIErrorCodes.MissingParameter:this.signupFailureCode.set(SignupFailureCode.MissingParameter);break;case PrivateAPIErrorCodes.BraintreeUnknown:this.signupFailureCode.set(SignupFailureCode.BraintreeUnknown);break;default:this.signupFailureCode.set(SignupFailureCode.ServerFailure)}}catch(parseErr){g.reportError(parseErr),this.signupFailureCode.set(SignupFailureCode.ServerFailure)}else this.signupFailureCode.set(SignupFailureCode.ServerFailure);g.sendEvent("Billing","PremiumSignupFAILURE")}}.bind(this)})):(this.signupFailureCode.set(SignupFailureCode.MissingPlanID),g.sendEvent("Billing","PremiumSignupFAILURE"))}else this.signupFailureCode.set(SignupFailureCode.MissingNonce),g.sendEvent("Billing","PremiumSignupFAILURE")},onClickSubmit:function onClickSubmit(){this.refs.form.submit()
},onClickClose:function onClickClose(){this.refs.modal.close()},render:function render(){var state=this.state,clsButton=g.classNames("billingSubmit"),height=state.billingFailureCode||state.signupFailureCode?180:380,clsButton=g.classNames("billingSubmit loading20 right",{loading:state.isSubmitting},{disabled:state.isLoading});return React.createElement(FancyModal,{id:"modalBilling",title:"Enter Billing Info",width:400,height:height,backdropClose:!1,scrollable:!1,modalID:Modals.Billing,ref:"modal"},React.createElement("div",{key:"content"},!state.billingFailureCode&&!state.signupFailureCode&&React.createElement("form",{id:"billingForm",method:"post",action:"javascript:void(0);",ref:"form"},React.createElement("div",{id:"braintreeDropin"}),state.isLoading&&React.createElement(FancyLoader,{center:!0},"Loading billing system..."),!state.billingFailureCode&&React.createElement("div",{className:clsButton},React.createElement("input",{type:"submit",className:"new-modal-button mat-button-raised mat-button-blue",value:"SUBMIT"}))),state.signupFailureCode&&React.createElement("div",{id:"billingSignupError"},"There was an error processing your payment. Please check your billing information or contact support@moo.do with code "+state.signupFailureCode+"."),state.billingFailureCode&&React.createElement("div",{id:"billingError"},"There was an error loading our payment system. Please contact support@moo.do with code "+state.billingFailureCode+" or try again in a few minutes.")),React.createElement("div",{key:"buttons",style:{textAlign:"right"}},state.billingFailureCode&&React.createElement(FancyButton,{primary:!0,onClick:this.onClickClose},"OK")))}});return ReactModalBilling});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactModalConfirm",["require","exports","module","react","MooReact","Hotkeys","Constants","Components/FancyButton","Components/FancyModal"],function(require,exports,module){var React=require("react"),MooReact=require("MooReact"),Hotkeys=require("Hotkeys"),C=require("Constants"),FancyButton=require("Components/FancyButton"),FancyModal=require("Components/FancyModal"),ReactModalConfirm=MooReact.createClass({displayName:"ReactModalConfirm",propTypes:{text:React.PropTypes.string.isRequired},getHotkeys:function getHotkeys(){return[Hotkeys.create(KeyCode.Escape,C.Primary.Either,C.Shift.Either,this.onClickNo),Hotkeys.create(KeyCode.N,C.Primary.Either,C.Shift.Either,this.onClickNo),Hotkeys.create(KeyCode.Enter,C.Primary.Either,C.Shift.Either,this.onClickYes),Hotkeys.create(KeyCode.Y,C.Primary.Either,C.Shift.Either,this.onClickYes)]},onClickYes:function onClickYes(){this.refs.modal.close(!0)},onClickNo:function onClickNo(){this.refs.modal.close(!1)},render:function render(){return React.createElement(FancyModal,_extends({},this.props,{id:"modalConfirm",title:"Please Confirm",small:!0,backdropClose:!1,scrollable:!1,modalID:Modals.Confirm,ref:"modal"}),React.createElement("div",{key:"content"},this.props.text),React.createElement("div",{key:"buttons"},React.createElement(FancyButton,{primary:!0,width:100,onClick:this.onClickYes},"YES"),React.createElement(FancyButton,{width:100,onClick:this.onClickNo},"NO")))}});return ReactModalConfirm});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactModalOptions",["require","exports","module","react","MooReact","Components/FancyButton","Components/FancyModal"],function(require,exports,module){var React=require("react"),MooReact=require("MooReact"),FancyButton=require("Components/FancyButton"),FancyModal=require("Components/FancyModal"),ReactModalOptions=MooReact.createClass({displayName:"ReactModalOptions",propTypes:{text:React.PropTypes.string.isRequired,options:React.PropTypes.array.isRequired},onClickOption:function onClickOption(value){this.refs.modal.close(value)},render:function render(){return React.createElement(FancyModal,_extends({},this.props,{id:"modalOptions",title:"Please Choose",small:!0,backdropClose:!1,scrollable:!1,modalID:Modals.Options,ref:"modal"}),React.createElement("div",{key:"content"},this.props.text),React.createElement("div",{key:"buttons"},this.props.options.map(function(text,index){return React.createElement(FancyButton,{key:index,width:100,onClick:this.onClickOption.bind(this,text)},text)}.bind(this)),React.createElement(FancyButton,{cancel:!0,width:100,onClick:this.onClickOption},"Cancel")))}});return ReactModalOptions}),define("ReactModalExport",["require","exports","module","globals","data","platform","react","MooReact","NativeSel","Components/FancyButton","Components/FancyListItem","Components/FancyCheckbox","Components/FancyModal"],function(require,exports,module){var g=require("globals"),d=require("data"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),NativeSel=require("NativeSel"),FancyButton=require("Components/FancyButton"),FancyListItem=require("Components/FancyListItem"),FancyCheckbox=require("Components/FancyCheckbox"),FancyModal=require("Components/FancyModal"),ReactModalExport=MooReact.createClass({displayName:"ReactModalExport",propTypes:{},init:function init(){this.createObservables({exportArchived:!1,includeNotes:!0,dataType:"html"})},setDataType:function setDataType(type){this.dataType.set(type)},exportData:function exportData(){var content,preview,root=d.getRootItem(),exportArchived=this.state.exportArchived,includeNotes=this.state.includeNotes;if("html"===this.dataType.get())content=d.toHtml(root,exportArchived,includeNotes),preview=content;else if("text"===this.dataType.get()){var tab="&nbsp;&nbsp;&nbsp;&nbsp;";content=d.toPlainText(root,0,exportArchived,includeNotes),preview=content.replace(/\n/g,"<br>").replace(/\t/g,tab)}else"json"===this.dataType.get()&&(content=d.toJSON(root,!1,exportArchived,includeNotes),preview=content);return this.exportedContent=content,preview},onChangeArchiveItems:function onChangeArchiveItems(value){value&&g.vmMain.parseSubtreeArchive(g.vmMain.root(),ChangeType.Auto),this.exportArchived.set(value)},onChangeIncludeNotes:function onChangeIncludeNotes(value){this.includeNotes.set(value)},onTapOpen:function onTapOpen(){var content="text"===this.dataType.get()?this.exportData():this.exportedContent,newWin=open("url");newWin.document.write(content)},onTapSelect:function onTapSelect(){var range=NativeSel.createSelectionRange();range.selectNodeContents(this.refs.exportedContent),NativeSel.setSelectionRange(range)},onTapSaveExport:function onTapSaveExport(){var ext;"html"===this.dataType.get()?ext="html":"text"===this.dataType.get()?ext="txt":"json"===this.dataType.get()&&(ext="json");try{g.saveFile(this.exportedContent,"moodo."+ext)}catch(err){g.reportError(err)}},onKeyDown:function onKeyDown(e){platform.normalizeKeys(e),(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.keyCode===KeyCode.A&&this.onTapSelect(),e.preventDefault(),e.stopPropagation()},render:function render(){var dataType=this.state.dataType,classExported=g.classNames("exportedContent",dataType),exportedPreview=this.exportData();return React.createElement(FancyModal,{id:"modalExport",title:"Export Data",width:860,height:900,modalID:Modals.ExportData},React.createElement("div",{key:"sidebar",width:180},React.createElement(FancyListItem,{header:!0},"Data Type"),React.createElement(FancyListItem,{selected:"html"===dataType,onClick:this.setDataType.bind(this,"html")},"HTML"),React.createElement(FancyListItem,{selected:"text"===dataType,onClick:this.setDataType.bind(this,"text")},"Plain Text"),React.createElement(FancyListItem,{selected:"json"===dataType,onClick:this.setDataType.bind(this,"json")},"JSON"),React.createElement(FancyListItem,{header:!0},"Options"),React.createElement(FancyListItem,null,React.createElement(FancyCheckbox,{checked:this.state.includeNotes,onChange:this.onChangeIncludeNotes},"Include Notes")),React.createElement(FancyListItem,null,React.createElement(FancyCheckbox,{checked:this.state.exportArchived,onChange:this.onChangeArchiveItems},"Archived Items")),React.createElement(FancyListItem,{header:!0},"Export"),React.createElement(FancyButton,{onClick:this.onTapOpen},"OPEN IN TAB"),React.createElement(FancyButton,{onClick:this.onTapSelect},"SELECT"),React.createElement(FancyButton,{onClick:this.onTapSaveExport},"SAVE")),React.createElement("div",{key:"content"},React.createElement("div",{className:classExported,onKeyDown:this.onKeyDown,contentEditable:!0,dangerouslySetInnerHTML:{__html:exportedPreview},ref:"exportedContent"})))}});return ReactModalExport}),define("dimport",["globals","platform","data","tracker","VMLI","parse","goog","International","AccountManager"],function(g,platform,d,tracker,VMLI,parser,goog,International,AccountManager){function dimport(){this.workflowy={login:this.workflowyLogin.bind(this),"import":this.workflowyImport.bind(this),save:this.workflowySave.bind(this)},this.wunderlist={login:this.wunderlistLogin.bind(this),"import":this.wunderlistImport.bind(this),save:this.wunderlistSave.bind(this)},this.opml={login:this.opmlLogin.bind(this),"import":this.opmlImport.bind(this),save:this.opmlSave.bind(this)},this.json={login:this.jsonLogin.bind(this),"import":this.jsonImport.bind(this),save:this.jsonSave.bind(this)},this.gtasks={login:this.gtasksLogin.bind(this),"import":this.gtasksImport.bind(this),save:this.gtasksSave.bind(this)},this.trello={preload:this.trelloPreload.bind(this),isLoaded:!1,login:this.trelloLogin.bind(this),"import":this.trelloImport.bind(this),save:this.trelloSave.bind(this)},this.todoist={login:this.todoistLogin.bind(this),"import":this.todoistImport.bind(this),save:this.todoistSave.bind(this)}}function formatDate(date){return date.toString(International.getFormat(DFormat.MonthDay))}return dimport.prototype={workflowyLogin:function workflowyLoginFn(username,password,cb,error){try{g.PAssert(4847,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4848,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}return username?password?void g.XHR_PrivateAPI({type:"POST",path:"/oauth/workflowy",data:{username:username,password:password},cb:function cbFn(xhr){if(200===xhr.status){try{var dataHolder=JSON.parse(xhr.response);this.workflowy.data=JSON.parse(dataHolder.data)}catch(err){return g.reportError(err),error("Error parsing successful response from server. The developers have been notified with details of the error.")}return!this.workflowy.data||this.workflowy.data.error?error("Invalid username or password."):cb()}var errorMsg;try{var parsedResponse=JSON.parse(xhr.response);switch(parsedResponse.code){case PrivateAPIErrorCodes.InvalidParameter:errorMsg="Must specify a username and password.";break;case PrivateAPIErrorCodes.UnauthorizedUser:errorMsg="Invalid username or password.";break;case PrivateAPIErrorCodes.ErrorContactingRemote:errorMsg=parsedResponse.data;break;default:errorMsg="Error contacting server. The developers have been notified with details of the error."}}catch(err){errorMsg="Error parsing error response from server. The developers have been notified with details of the error.",g.reportError(err)}return error(errorMsg)}.bind(this)}):error("Must provide a password."):error("Must provide a valid username.")},workflowyImport:function workflowyImportFn(cb,error){try{g.PAssert(4849,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4850,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}return cb(this.workflowy.data)},workflowyIterateItem:function workflowyIterateItemFn(item,parentVMLI){try{g.PAssert(4851,item&&void 0!==item.nm,"All items must exist and have stars and text, children and notes are optional",item)}catch(PERR){g.reportError(PERR)}try{g.PAssert(4853,parentVMLI,"A valid parent must always be defined")}catch(PERR){g.reportError(PERR)}if(item&&parentVMLI)try{var isComplete=!!item.cp;if(!isComplete){var itemText=g.stripTagsBasic(item.nm),itemVMLI=d.createVMLI({text:itemText,isComplete:isComplete},{parent:parentVMLI,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(itemVMLI),item.no){var noteVMLI=d.createVMLI({text:item.no,isNote:!0},{parent:itemVMLI,changeType:ChangeType.AllLocal});itemVMLI.setNote(noteVMLI,ChangeType.Local)}if(item.ch)for(var i=0;i<item.ch.length;++i){var entry=item.ch[i];this.workflowyIterateItem(entry,itemVMLI)}}}catch(err){throw g.reportError(err),err}},workflowySave:function workflowySaveFn(data,cb,error){try{g.PAssert(4854,data,"Workflowy requires having valid data")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4855,cb,"Workflowy requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4856,error,"Workflowy requires an error callback")}catch(PERR){g.reportError(PERR)}try{try{g.PAssert(4857,data.projectTreeData,"Missing Workflowy projectTreeData")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4858,data.projectTreeData.mainProjectTreeInfo,"Missing Workflowy mainProjectTreeInfo")}catch(PERR){g.reportError(PERR)}var project=data.projectTreeData.mainProjectTreeInfo;try{g.PAssert(4859,project.rootProjectChildren,"Missing Workflowy rootProjectChildren")}catch(PERR){g.reportError(PERR)}tracker.beginAction(),g.vmMain.beginUpdateItems();var docRoot=d.getRootModel();try{g.PAssert(4860,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=d.createVMLI({text:"Workflowy Import"},{parent:docRoot,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);try{for(var i=0;i<project.rootProjectChildren.length;++i){var entry=project.rootProjectChildren[i];this.workflowyIterateItem(entry,impRoot)}g.vmMain.parseSubtree(impRoot,ChangeType.Local|ChangeType.All)}catch(errIterate){return g.reportError(errIterate),error("There was an error iterating your Workflowy items. The developers have been notified with daetails of the error.",errIterate)}return g.vmMain.commitUpdateItems(),tracker.endAction(),cb()}catch(err){return g.reportError(err),error("There was an error parsing your Workflowy data. The developers have been notified with details of the error.",err)}},wunderlistLogin:function wunderlistLoginFn(username,password,cb,error){try{g.PAssert(4861,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4862,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}var clientID="localhost"===window.location.hostname?"f06a1334e250a9bb0b03":"ad988eeb954e9aabc288",redirectURL=window.location.protocol+"//"+window.location.host+"/oauthRelay.html";this.wunderlist.clientId=clientID;var state="Dchs"+(new Date).getTime(),url="https://www.wunderlist.com/oauth/authorize?client_id="+clientID+"&redirect_uri="+redirectURL+"&state="+state;window.open(url,"wunderlist","height=600,width=550");var handleRelayMessage=function(e){var validOrigin=g.getLocationOrigin(),validState=!1;try{validState=e.data.state===state}catch(err){g.reportError(err)}if(validOrigin&&validState)if(window.removeEventListener("message",handleRelayMessage),e.data.error)error("Error authenticating with Wunderlist");else{var code=e.data.code;code&&g.XHR_PrivateAPI({type:"POST",path:"/oauth/wunderlist",data:{code:code},requireAuth:!0,cb:function cbFn(xhr){if(200===xhr.status){try{var data=JSON.parse(xhr.response).data;this.wunderlist.token=data.access_token}catch(err){error("Error parsing response from remote server.",err)}this.wunderlist.token?cb():error("Invalid username or password.")}else error("Error contacting remote server.")}.bind(this)})}}.bind(this);window.addEventListener("message",handleRelayMessage)},wunderlistImport:function wunderlistImportFn(cb,error){try{g.PAssert(4863,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4864,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}var data={inbox:{title:"inbox",items:{},p:0}},listsCompleted=0;this.wunderlistGetLists(function(lists){for(var i=0;i<lists.length;++i){var list=lists[i];data[list.id]={title:list.title,items:{},p:list.position},this.wunderlistGetTasks(list.id,function(tasks){for(var j=0;j<tasks.length;++j){var task=tasks[j];if(task.parent_id){var taskParent=data[task.list_id].items[task.parent_id];taskParent?(taskParent.items||(taskParent.items=[]),taskParent.items.push(task)):data[task.list_id].items[task.parent_id]={items:[task]}}else{var prevData=data[task.list_id].items[task.id];data[task.list_id].items[task.id]=task,prevData&&(data[task.list_id].items[task.id].items=prevData.items)}}this.wunderlistGetSubtasks(list.id,function(subtasks){for(var j=0;j<subtasks.length;++j){var task=subtasks[j],listData=data[task.list_id];if(listData)if(task.parent_id){var taskParent=listData.items[task.parent_id];taskParent?(taskParent.items||(taskParent.items=[]),taskParent.items.push(task)):listData.items[task.parent_id]={items:[task]}}else{var prevData=listData.items[task.id];listData.items[task.id]=task,prevData&&(listData.items[task.id].items=prevData.items)}}++listsCompleted===lists.length&&cb(data)}.bind(this),error)}.bind(this),error)}}.bind(this),error)},wunderlistGetLists:function wunderlistGetListsFn(cb,error){try{g.PAssert(4865,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4866,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://a.wunderlist.com/api/v1/lists",headers:{"X-Access-Token":this.wunderlist.token,"X-Client-ID":this.wunderlist.clientId},cb:function cbFn(xhr){if(200===xhr.status){var data;try{data=JSON.parse(xhr.response)}catch(err){error("There was an error parsing your Wunderlist data. The developers have been notified with details of the error.",err)}cb(data)}else error("Error contacting remote server.")}.bind(this)})},wunderlistGetTasks:function wunderlistGetTasksFn(listId,cb,error){try{g.PAssert(4867,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4868,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://a.wunderlist.com/api/v1/tasks?list_id="+listId,headers:{"X-Access-Token":this.wunderlist.token,"X-Client-ID":this.wunderlist.clientId},cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);cb(data)}else error("Error contacting remote server.")}.bind(this)})},wunderlistGetSubtasks:function wunderlistGetSubtasksFn(listId,cb,error){try{g.PAssert(4869,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4870,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}g.XHR({type:"GET",url:"https://a.wunderlist.com/api/v1/subtasks?list_id="+listId,headers:{"X-Access-Token":this.wunderlist.token,"X-Client-ID":this.wunderlist.clientId},cb:function cbFn(xhr){if(200===xhr.status){var data=JSON.parse(xhr.response);cb(data)}else error("Error contacting remote server.")}.bind(this)})},wunderlistSave:function wunderlistSaveFn(data,cb,error){try{g.PAssert(4871,cb,"Wunderlist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4872,error,"Wunderlist requires an error callback")}catch(PERR){g.reportError(PERR)}try{tracker.beginAction(),g.vmMain.beginUpdateItems();var docRoot=d.getRootModel();try{g.PAssert(4873,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=d.createVMLI({text:"Wunderlist Import"},{parent:docRoot,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var listId in data){var list=data[listId],listText=list.title,listVMLI=d.createVMLI({text:listText},{parent:impRoot,changeType:ChangeType.AllLocal});impRoot.insertItem(listVMLI);for(var taskId in list.items){var task=list.items[taskId],taskVMLI=d.createVMLI({text:task.title,isComplete:!!task.completed_at,dateCompleted:task.completed_at,isStarred:task.starred},{parent:listVMLI,changeType:ChangeType.AllLocal});if(listVMLI.insertItem(taskVMLI),task.note){var noteVMLI=d.createVMLI({text:task.note},{parent:taskVMLI,changeType:ChangeType.AllLocal});taskVMLI.insertItem(noteVMLI)}if(task.items)for(var j=0;j<task.items.length;++j){var subtask=task.items[j],subtaskVMLI=d.createVMLI({text:subtask.title,isComplete:!!subtask.completed_at,dateCompleted:subtask.completed_at,isStarred:subtask.starred},{parent:taskVMLI,changeType:ChangeType.AllLocal});taskVMLI.insertItem(subtaskVMLI)}}}g.vmMain.parseSubtree(impRoot,ChangeType.Local|ChangeType.All),g.vmMain.commitUpdateItems(),tracker.endAction(),cb()}catch(err){error(void 0,err)}},opmlLogin:function opmlLoginFn(user,pw,cb,error){try{g.PAssert(4874,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4875,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}var input=document.getElementById("importFileUploadButton");input.onchange=cb,input.click()},opmlImport:function opmlImportFn(cb,error){try{g.PAssert(4876,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4877,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}try{var fReader=new FileReader,fileImport=document.forms.importFileUpload.importFile.files[0];fileImport?(fReader.onload=function(e){var data=e.target.result,xml;if((data.startsWith("<?xml ")||data.startsWith("<opml "))&&(xml=g.loadXML(data)),xml){tracker.beginAction(),g.vmMain.beginUpdateItems();var res=parser.parseOPML(xml,fileImport.name);g.vmMain.commitUpdateItems(),tracker.endAction(),res?cb():error("Error parsing OPML. Please validate your data.")}else error("Unable to load XML lib. Please update or try another browser.")},fReader.onerror=error,fReader.readAsText(fileImport)):error("You must select a file before importing.")}catch(err){error(void 0,err)}},opmlSave:function opmlSaveFn(data,cb,error){try{g.PAssert(4878,cb,"OPML requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4879,error,"OPML requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},jsonLogin:function jsonLoginFn(user,pw,cb,error){try{g.PAssert(4880,cb,"JSON requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4881,error,"JSON requires an error callback")}catch(PERR){g.reportError(PERR)}var input=document.getElementById("importFileUploadButton"),changed=!1;input.onchange=function(val){changed=!0,cb(val)},input.click();var onFocus=function(){changed||error(!1),document.body.onfocus=void 0};document.body.onfocus=onFocus},jsonImport:function jsonImportFn(cb,error){try{var fReader=new FileReader,fileImport=document.forms.importFileUpload.importFile.files[0];fileImport?(fReader.onload=function(e){var data=e.target.result;if(data)try{var parsedObj=JSON.parse(data);tracker.beginAction(),g.vmMain.beginUpdateItems();var res=parser.parseJSON(parsedObj);g.vmMain.commitUpdateItems(),tracker.endAction(),res?cb():error("Invalid JSON format. The developers have been notified with details of the error.")}catch(errParse){error("The JSON file has errors. The developers have been notified with details of the error.",errParse)}else error("Unable to import your requested file. Please try a different file.")},fReader.onerror=error,fReader.readAsText(fileImport)):error("You must select a file before importing.")}catch(err){error(void 0,err)}},jsonSave:function jsonSaveFn(data,cb,error){try{g.PAssert(4882,cb,"JSON requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4883,error,"JSON requires an error callback")}catch(PERR){g.reportError(PERR)}cb()},gtasksLogin:function gtasksLoginFn(username,password,cb,error){try{g.PAssert(4888,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4889,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}goog.runAuthenticate([GScope.TasksRO],!1,!1,function(token){token&&!token.error?(this.gtasks.token=token,cb(token)):error("Unable to authenticate with Google. Please try again.",token)}.bind(this))},gtasksImport:function gtasksImportFn(cb,error){try{g.PAssert(4890,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4891,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var info={roots:[],remoteItems:{},unassigned:[]};this.gtasksGetLists(function(listData){try{g.PAssert(4892,g.isArray(listData),"List data must be an array")}catch(PERR){g.reportError(PERR)}for(var numLists=listData.length,listsCreated=0,i=0;i<listData.length;++i){var list=listData[i];info.remoteItems[list.id]={id:list.id,text:list.title,isComplete:!1,dateCompleted:void 0,isArchived:!1,due:void 0,notes:void 0,parent:void 0,items:[]},info.roots.push(list.id),this.gtasksGetTasks(list,function(taskData,activeList){if(taskData){try{g.PAssert(4893,g.isArray(taskData),"List data must be an array")}catch(PERR){g.reportError(PERR)}if(g.isArray(taskData)){for(var j=0;j<taskData.length;++j){var task=taskData[j];if(task&&"completed"!==task.status){info.remoteItems[task.id]={id:task.id,text:task.title,isComplete:"completed"===task.status,dateCompleted:task.completed?new Date(task.completed):void 0,isArchived:task.hidden,due:task.due?new Date(task.due):void 0,notes:task.notes,parent:task.parent||activeList.id,items:[]};var parent=info.remoteItems[task.parent||activeList.id];parent?parent.items.push(task.id):info.unassigned.push(task.id)}}listsCreated++,listsCreated===numLists&&cb(info)}else error("Invalid task list returned.")}else listsCreated++}.bind(this),error)}}.bind(this),error)},gtasksGetLists:function gtasksGetListsFn(cb,error){try{g.PAssert(4894,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4895,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var maxResults=2e3;g.XHR({type:"GET",url:"https://www.googleapis.com/tasks/v1/users/@me/lists?maxResults="+maxResults+"&key="+window.gapiKey+"&access_token="+AccountManager.getDefaultAccessToken(),cb:function cbFn(xhr){if(200===xhr.status)try{var data=JSON.parse(xhr.response);try{g.PAssert(4896,data&&data.items,"Must have a valid set of data to get tasks from")}catch(PERR){g.reportError(PERR)}data&&data.items?cb(data.items):error("Error getting data from remote server.")}catch(err){error(err)}else error("Error contacting remote server.")}.bind(this)})},gtasksGetTasks:function gtasksGetTasksFn(list,cb,error){try{g.PAssert(4897,list,"GTasks requires a valid list to get tasks from")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4898,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4899,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}var maxResults=2500;g.XHR({type:"GET",url:"https://www.googleapis.com/tasks/v1/lists/"+list.id+"/tasks?maxResults="+maxResults+"&key="+window.gapiKey+"&access_token="+AccountManager.getDefaultAccessToken(),cb:function cbFn(xhr){if(200===xhr.status)try{var data=JSON.parse(xhr.response);try{g.PAssert(4900,data,"Must have a valid array of tasks")}catch(PERR){g.reportError(PERR)}data&&data.items?cb(data.items,list):cb([],list)}catch(err){error(err)}else error("Error contacting remote server.")}.bind(this)})},gtasksSave:function gtasksSaveFn(data,cb,error){function traverse(node,parentVMLI){var itemText=node.text;node.due&&(itemText+=" @"+formatDate(node.due));var itemVMLI=d.createVMLI({text:itemText,isComplete:node.isComplete,dateCompleted:node.dateCompleted?node.dateCompleted.getTime():node.dateCompleted,isArchived:node.isArchived},{parent:parentVMLI,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(itemVMLI),node.notes){var notesVMLI=d.createVMLI({text:node.notes,isNote:!0},{parent:itemVMLI,changeType:ChangeType.AllLocal});itemVMLI.setNote(notesVMLI,ChangeType.Local)}for(var i=0;i<node.items.length;++i)traverse(data.remoteItems[node.items[i]],itemVMLI)}try{g.PAssert(4901,cb,"GTasks requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4902,error,"GTasks requires an error callback")}catch(PERR){g.reportError(PERR)}try{try{g.PAssert(4903,0===data.unassigned.length,"We should never have unassigned tasks")}catch(PERR){g.reportError(PERR)}tracker.beginAction(),g.vmMain.beginUpdateItems();var docRoot=d.getRootModel();try{g.PAssert(4904,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=d.createVMLI({text:"Google Tasks Import"},{parent:docRoot,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var i=0;i<data.roots.length;++i)traverse(data.remoteItems[data.roots[i]],impRoot);g.vmMain.parseSubtree(impRoot,ChangeType.Local|ChangeType.All),g.vmMain.commitUpdateItems(),tracker.endAction(),cb()}catch(err){error(void 0,err)}},trelloPreload:function trelloPreloadFn(cb,error){var appKey="667ecf0c3d3e029c51d205b7173f6c38";this.trello.isLoaded||this.trello.isLoading?cb():(this.trello.isLoading=!0,g.addScript("https://code.jquery.com/jquery-1.7.1.min.js","jqueryScript",function(){g.addScript("https://api.trello.com/1/client.js?key="+appKey,"trelloScript",function(){this.trello.isLoading=!1;try{g.PAssert(4905,window.Trello,"The Trello client lib must have been loaded correctly")}catch(PERR){g.reportError(PERR)}window.Trello?(this.trello.isLoaded=!0,cb()):error("Error loading Trello. Please try again.")}.bind(this),function(e){this.trello.isLoading=!1,error(e)})}.bind(this),function(e){this.trello.isLoading=!1,error(e)}))},trelloLogin:function trelloLoginFn(username,password,cb,error){try{g.PAssert(4906,window.Trello,"The Trello client lib was not properly loaded")}catch(PERR){g.reportError(PERR)}if(window.Trello){if(platform.appPlatform===AppPlatform.Chrome){var handleRelayMessage=function(e){var validOrigin=g.getLocationOrigin();validOrigin&&(window.removeEventListener("message",handleRelayMessage),e.data.error?error("Error authenticating with Trello."):(Trello.setToken(e.data.token),cb()))};window.addEventListener("message",handleRelayMessage)}Trello.authorize({type:platform.appPlatform===AppPlatform.Chrome?"redirect":"popup",name:"Moo.do",persist:!1,expiration:"1hour",success:cb,error:error})}else error("Error loading Trello. Please try again.")},trelloImport:function trelloImportFn(cb,errorCB){var data=[];try{Trello.get("members/me/boards",function(boards){function checkFinished(){totalBoards===doneBoards&&cb(data)}function boardDone(success){doneBoards++,checkFinished()}for(var totalBoards=boards.length,doneBoards=0,i=0;i<boards.length;++i){var board=boards[i];if(board.closed)totalBoards--;else{var boardItem={text:board.name,items:[]};data.push(boardItem),this._handleBoard(boardItem,board.id,errorCB,boardDone)}}checkFinished()}.bind(this),errorCB)}catch(err){errorCB(err)}},_handleBoard:function _handleBoardFn(boardItem,id,errorCB,doneCB){Trello.get("boards/"+id+"/lists",function(lists){function checkFinished(){doneLists===totalLists&&doneCB()}function listDone(){doneLists++,checkFinished()}for(var doneLists=0,totalLists=lists.length,j=0;j<lists.length;++j){var list=lists[j];if(list.closed)totalLists--;else{var listItem={text:list.name,items:[]};boardItem.items.push(listItem),this._handleList(listItem,list.id,errorCB,listDone)}}checkFinished()}.bind(this),errorCB)},_handleList:function _handleListFn(listItem,id,errorCB,doneCB){Trello.get("lists/"+id+"/cards",function(cards){function checkFinished(){doneCards===totalCards&&doneCB()}function checklistDone(){doneCards++,checkFinished()}for(var doneCards=0,totalCards=cards.length,k=0;k<cards.length;++k){var card=cards[k];if(card.closed)totalCards--;else{var cardItem={text:card.name};if(card.labels&&card.labels.length>0){for(var labelText="",z=0;z<card.labels.length;++z){var label=card.labels[z];labelText+=TagPrefix+(label.name.length>0?label.name:label.color)+" "}cardItem.text=labelText+cardItem.text}if(card.due&&(cardItem.text+=" "+DatePrefix+formatDate(new Date(card.due))),card.desc&&card.desc.length>0){cardItem.items=[];
for(var descEntries=card.desc.split("\n"),z=0;z<descEntries.length;++z){var entry=descEntries[z];entry&&entry.length>0&&cardItem.items.push({text:entry})}}if(card.idChecklists&&card.idChecklists.length>0){cardItem.items||(cardItem.items=[]);for(var z=0;z<card.idChecklists.length;++z)this._handleChecklist(cardItem,card.idChecklists[z],errorCB,checklistDone)}else doneCards++;listItem.items.push(cardItem)}}checkFinished()}.bind(this),errorCB)},_handleChecklist:function _handleChecklistFn(cardItem,id,errorCB,doneCB){Trello.get("checklists/"+id+"/",function(checklist){for(var checklistItem={text:checklist.name,isCollapsed:!0,items:[]},x=0;x<checklist.checkItems.length;++x){var check=checklist.checkItems[x],isComplete="complete"===check.state;if(!isComplete){var checkItem={text:check.name,isComplete:isComplete};checklistItem.items.push(checkItem)}}cardItem.items.push(checklistItem),doneCB()}.bind(this),errorCB)},trelloSave:function trelloSaveFn(data,cb,error){function traverse(node,parentVMLI){var nodeVMLI=d.createVMLI({text:node.text,isComplete:node.isComplete,isCollapsed:node.isCollapsed},{parent:parentVMLI,changeType:ChangeType.AllLocal});if(parentVMLI.insertItem(nodeVMLI),node.items)for(var i=0;i<node.items.length;++i)traverse(node.items[i],nodeVMLI);return nodeVMLI}try{tracker.beginAction(),g.vmMain.beginUpdateItems();var docRoot=d.getRootModel();try{g.PAssert(4907,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=d.createVMLI({text:"Trello Import"},{parent:docRoot,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var i=0;i<data.length;++i)traverse(data[i],impRoot);g.vmMain.commitUpdateItems(),tracker.endAction()}catch(err){return error(err)}cb()},todoistLogin:function todoistLoginFn(username,password,cb,error){try{g.PAssert(4908,cb,"Todoist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4909,error,"Todoist requires an error callback")}catch(PERR){g.reportError(PERR)}var clientID="localhost"===window.location.hostname?"5d361221eddb4bcdb018457c7c74e698":"b701ac04f4df419ca4144ab208a9fb06",scope="data:read",state="Dchs"+(new Date).getTime(),url="https://todoist.com/oauth/authorize?client_id="+clientID+"&scope="+scope+"&state="+state;window.open(url,"todoist","height=600,width=550");var handleRelayMessage=function(e){var validOrigin=g.getLocationOrigin(),validState=!1;try{validState=e.data.state===state}catch(err){g.reportError(err)}if(validOrigin&&validState)if(window.removeEventListener("message",handleRelayMessage),e.data.error)error("Error authenticating with Todoist");else{var code=e.data.code;code&&g.XHR_PrivateAPI({type:"POST",path:"/oauth/todoist",data:{code:code},requireAuth:!0,cb:function cbFn(xhr){if(200===xhr.status){try{var data=JSON.parse(xhr.response).data;this.todoist.data=data}catch(err){error("Error parsing response from remote server.",err)}this.todoist.data?cb():error("Invalid username or password")}else error("Error contacting remote server.")}.bind(this)})}}.bind(this);window.addEventListener("message",handleRelayMessage)},todoistImport:function todoistImportFn(cb,error){try{g.PAssert(4910,cb,"Todoist requires a success callback")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4911,error,"Todoist requires an error callback")}catch(PERR){g.reportError(PERR)}for(var rawData=this.todoist.data,parsedData={},i=0;i<rawData.projects.length;++i){var project=rawData.projects[i];project.is_archived||project.is_deleted||(parsedData[project.id]={name:project.name,items:[]})}for(var i=0;i<rawData.items.length;++i){var item=rawData.items[i];!parsedData[item.project_id]||item.is_deleted||item.is_archived||item.checked||parsedData[item.project_id].items.push(item)}cb(parsedData)},todoistSave:function todoistSaveFn(data,cb,error){function initialize(node,parentVMLI){node.priority&&(node.priority=priorityMap[node.priority]),node.due_date_utc&&(node.content+=" @"+formatDate(new Date(node.due_date_utc)));var nodeVMLI=d.createVMLI({text:node.content||"",isCollapsed:!!node.collapsed,priority:node.priority},{parent:parentVMLI,changeType:ChangeType.AllLocal});return parentVMLI.insertItem(nodeVMLI),nodeVMLI}var priorityMap=[VMLIFlag.None,VMLIFlag.None,VMLIFlag.P2,VMLIFlag.P1,VMLIFlag.P0];try{tracker.beginAction(),g.vmMain.beginUpdateItems();var docRoot=d.getRootModel();try{g.PAssert(4912,docRoot,"Root item must exist in order to import")}catch(PERR){g.reportError(PERR)}var impRoot=d.createVMLI({text:"Todoist Import"},{parent:docRoot,changeType:ChangeType.AllLocal});docRoot.insertItem(impRoot);for(var projectID in data){var project=data[projectID],items=project.items;items.sort(function(left,right){return left.item_order>right.item_order});var projectVMLI=d.createVMLI({text:project.name},{parent:impRoot,changeType:ChangeType.AllLocal});impRoot.insertItem(projectVMLI);for(var createdVMLIs={},i=0;i<items.length;++i){var item=items[i],parentVMLI=item.parent_id?createdVMLIs[item.parent_id]:projectVMLI;createdVMLIs[item.id]=initialize(item,parentVMLI)}}g.vmMain.commitUpdateItems(),tracker.endAction()}catch(err){return error(err)}cb()}},dimport}),define("ReactModalImport",["require","exports","module","globals","platform","react","MooReact","Observable","dimport","Components/FancyModal","Components/FancyListItem","Components/FancyButton","Components/FancyInput","Components/FancyCheckbox"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Observable=require("Observable"),dimport=require("dimport"),FancyModal=require("Components/FancyModal"),FancyListItem=require("Components/FancyListItem"),FancyButton=require("Components/FancyButton"),FancyInput=require("Components/FancyInput"),FancyCheckbox=require("Components/FancyCheckbox"),ReactModalImport=MooReact.createClass({displayName:"ReactModalImport",propTypes:{},init:function init(){var importer=this.props.importer;"GTasks"===importer&&(importer="Google Tasks"),this.createObservables({isImporting:!1,preloadDisable:0,currentImporter:importer||"JSON",importMessage:""}),this.importer=new dimport},getImporterFromName:function getImporterFromName(name){var importFn;switch(name){case"Wunderlist":importFn=this.importer.wunderlist;break;case"Workflowy":importFn=this.importer.workflowy;break;case"OPML":importFn=this.importer.opml;break;case"JSON":importFn=this.importer.json;break;case"Text":importFn=this.importer.text;break;case"GTasks":case"Google Tasks":importFn=this.importer.gtasks;break;case"Trello":importFn=this.importer.trello;break;case"Todoist":importFn=this.importer.todoist;break;case"Toodledo":importFn=this.importer.toodledo;break;default:try{g.PAssert(4913,!1,"Must add valid importer: ",name)}catch(PERR){g.reportError(PERR)}}return importFn},selectImporter:function selectImporter(name){var importFn=this.getImporterFromName(name);this.currentImporter.set(name),this.importMessage.set(""),this.isImporting.set(!1),importFn&&importFn.preload&&!importFn.isLoaded&&(this.preloadDisable.set(this.preloadDisable.get()+1),this.importMessage.set("Loading Trello login..."),importFn.preload(function(){this.preloadDisable.set(this.preloadDisable.get()-1);var currentImporter=this.getImporterFromName(this.currentImporter.get());0===this.preloadDisable.get()&&currentImporter&&currentImporter.preload&&this.importMessage.set("")}.bind(this),function(err){this.preloadDisable.set(this.preloadDisable.get()-1),this.importMessage.set("Error loading Trello. Please try again.")}.bind(this)))},onImportError:function onImportError(message,error){message!==!1?(message&&g.isString(message)||(message="Moo.do encountered an error importing your data. The developers have been notified with details of the error."),g.reportError(error||message,message),this.importMessage.set(message)):this.importMessage.set(""),this.isImporting.set(!1)},runImport:function runImport(name,loginName,loginPW){if(!(this.isImporting.get()||this.preloadDisable.get()>0)){var importFn=this.getImporterFromName(name);if(importFn){g.sendEvent("Menu","Import"+name),this.isImporting.set(!0),this.importMessage.set("Importing...");try{setTimeout(function(){importFn.login(loginName,loginPW,function(){importFn["import"](function(data){importFn.save(data,function(){this.isImporting.set(!1),this.importMessage.set(""),g.menus.alert({text:"Your data has been imported successfully!",actionText:"OK",callback:function callback(){g.menus.closeModalNew(Modals.ImportData)}}),g.sendEvent("ImportSuccess",name)}.bind(this),this.onImportError)}.bind(this),this.onImportError)}.bind(this),this.onImportError)}.bind(this),0)}catch(err){this.onImportError("There was an issue importing your data. Please try again later.",err)}}}},onTapSelect:function onTapSelect(name){this.selectImporter(name,this.onImportSuccess,this.onImportError)},whichArea:function whichArea(){switch(this.state.currentImporter){case"Wunderlist":return"OAuthArea";case"Workflowy":return"LoginArea";case"OPML":return"UploadArea";case"JSON":return"UploadArea";case"Google Tasks":case"GTasks":return"OAuthArea";case"Trello":return"OAuthArea";case"Todoist":return"OAuthArea";case"Toodledo":return"OAuthArea";default:try{g.PAssert(4914,!1,"Must add valid importer")}catch(PERR){g.reportError(PERR)}}return!1},onClickImport:function onClickImport(){if(!this.isImporting.get()){var login=this.refs.email&&this.refs.email.getValue(),pw=this.refs.password&&this.refs.password.getValue();this.runImport(this.state.currentImporter,login,pw)}},renderListItem:function renderListItem(name){return React.createElement(FancyListItem,{selected:this.state.currentImporter===name,onClick:this.onTapSelect.bind(this,name)},name)},renderContent:function renderContent(){var state=this.state,importer=this.state.currentImporter,inside,area=this.whichArea(importer);return"LoginArea"===area?inside=React.createElement("div",null,React.createElement("div",{className:"importTitle"},"Import data from ",importer),React.createElement(FancyInput,{floatingText:"Email",display:"block",ref:"email"}),React.createElement(FancyInput,{type:"password",floatingText:"Password",display:"block",ref:"password"}),React.createElement("br",null)):"UploadArea"===area?inside=React.createElement("div",{id:"importUploadArea"},React.createElement("div",{className:"importTitle"},"Upload ",importer," file"),React.createElement("div",null,"Select a","OPML"===importer?"n":""," ",importer," file to upload"),React.createElement("form",{name:"importFileUpload"},React.createElement("input",{id:"importFileUploadButton",type:"file",required:"required",name:"importFile"}))):"OAuthArea"===area&&(inside=React.createElement("div",null,React.createElement("div",{className:"importTitle"},"Import data from ",importer),React.createElement("div",null,"Click to login to your account"))),React.createElement("div",{className:"importInside"},inside,React.createElement(FancyButton,{primary:!0,enabled:0===state.preloadDisable&&!state.isImporting,onClick:this.onClickImport},"IMPORT"),React.createElement("div",{className:"importMessage"},state.importMessage))},render:function render(){var dataType=this.state.dataType;return React.createElement(FancyModal,{id:"modalImport",title:"Import Data",width:600,height:600,modalID:Modals.ImportData},React.createElement("div",{key:"sidebar",width:180},React.createElement(FancyListItem,{header:!0},"Import from app"),this.renderListItem("Wunderlist"),this.renderListItem("Google Tasks"),this.renderListItem("Workflowy"),this.renderListItem("Trello"),this.renderListItem("Todoist"),React.createElement(FancyListItem,{header:!0},"Import from data"),this.renderListItem("JSON"),this.renderListItem("OPML")),React.createElement("div",{key:"content"},this.renderContent()))}});return ReactModalImport}),define("recovery",["globals","data","gdata","AccountManager"],function(g,d,gdata,AccountManager){function ref(o){return o?o.value:void 0}function val(o){var value;if(o){var match;recoverPluginRegexp.lastIndex=0,value=null!==(match=recoverPluginRegexp.exec(o.json))?o.json.substr(0,match.index)+window.EmbedAttachChar+match[1]+window.EmbedAttachChar+o.json.substr(match.index+match[0].length):o.json}return value}function Recovery(){}var recoverPluginRegexp=/(?:â(p:[^â]+)â)/gi;Recovery.prototype={_fixPlugins:function _fixPluginsFn(rawData){this.transformRawRevisionData(rawData,function(node){if(node.t){var newValue=val(node.t);newValue!==node.t.json&&log("Fixed Plugin: "+newValue),node.t.json=newValue}})},recoverRevision:function recoverRevisionFn(rev,successCB,failureCB){var docID=this.getCurrentDocID();this.getRawRevisionData(docID,rev,function(rawData){return rawData?(this._fixPlugins(rawData),void this.runRecovery(docID,rawData,successCB,failureCB)):(log("Unable to get revision data"),failureCB())}.bind(this))},runRecovery:function runRecoveryFn(docID,data,successCB,failureCB){var params={path:"/upload/drive/v2/files/"+docID+"/realtime",method:"PUT",params:{uploadType:"media",fileId:docID},headers:{"Content-Type":"text/plain;"},body:data},request=gapi.client.request(params),currentRecoverVersion=gdata.model.getRoot().get("recoverVersion")||0;gdata.model.getRoot().set("recoverVersion",currentRecoverVersion+1),gdata.clearItemEventListeners(),request.then(function(success){log("Recovery Success: ",success),g.settings.set(Settings.localRecoverVersion,currentRecoverVersion+1),gdata.model.getRoot().set("recoverVersion",currentRecoverVersion+1),d.addDefaultSkipSetting(Settings.gdocId,"Default"),d.addDefaultSkipSetting(Settings.gdocTitle,"Default"),gdata.close(!0),successCB()},function(failure){log("Recovery Failure: ",failure),failureCB()})},getCurrentRevision:function getCurrentRevisionFn(){var revision;try{revision=gdata.doc.getModel().serverVersion}catch(err){g.reportError(err)}return revision},getCurrentDocID:function getCurrentDocIDFn(){var docID;try{docID=g.settings.get(Settings.gdocId)}catch(err){g.reportError(err)}return docID},getRawRevisionData:function getRawRevisionDataFn(docID,rev,cb){var gapiToken=AccountManager.getDefaultAccessToken();if(gapiToken){var url="https://www.googleapis.com/drive/v2/files/"+(docID||this.getCurrentDocID())+"/realtime?revision="+rev;g.XHR({type:"GET",url:url,headers:{Authorization:"Bearer "+gapiToken},cb:function cbFn(xhr){if(200===xhr.status)try{var revData=JSON.parse(xhr.responseText);cb(revData)}catch(err){g.reportError(err),cb()}else cb()}})}else log("Invalid OAuth token"),cb()},getDefaultRawRevisionData:function getDefaultRawRevisionDataFn(rev,cb){return this.getRawRevisionData(this.getCurrentDocID(),rev,cb)},transformRawRevisionData:function transformRawRevisionDataFn(obj,perItemCB){function traverse(node,level){if(level>=0&&perItemCB(node,level),node.i)for(var children=ref(node.i),i=0;i<children.length;++i){var child=ref(children[i]);traverse(child,level+1)}if(node.n){var note=ref(node.n);note&&traverse(note,level+1)}}var data=ref(obj.data),root=ref(data.root);traverse(root,-1)},_makeConsumableOutput:function _makeConsumableOutputFn(docID,rev,perItemCB,doneCB){this.getRawRevisionData(docID,rev,function(rawData){try{g.PAssert(4915,rawData&&rawData.data,"Missing expected recovery data")}catch(PERR){g.reportError(PERR)}if(rawData&&rawData.data)try{this.transformRawRevisionData(rawData,perItemCB)}catch(err){g.reportError(err),rawData=void 0}doneCB&&doneCB(rawData)}.bind(this))},_padText:function _padTextFn(text,padding,padChar){var outText="";padChar=padChar||" ";for(var i=0;padding>i;++i)outText+=padChar;return outText+=text},printRevisionData:function printRevisionDataFn(docID,rev){this._makeConsumableOutput(docID,rev,function(node,level){console.log(this._padText(val(node.t),level))}.bind(this))},printDefaultRevisionData:function printDefaultRevisionDataFn(rev){return this.printRevisionData(this.getCurrentDocID(),rev)},printRevisionOffset:function printRevisionOffsetFn(offset){var rev=this.getCurrentRevision()-offset;return 0>rev?log("Maximum offset is: "+this.getCurrentRevision()):this.printDefaultRevisionData(rev)},getRevisionData:function getRevisionDataFn(docID,rev,format,cb){var fullText="",currentLevel=-1;this._makeConsumableOutput(docID,rev,function(node,level){if(format&&"text"!==format){if("html"===format){if(level>currentLevel)fullText+="<ul>";else if(currentLevel>level)for(var i=level;currentLevel>i;i++)fullText+="</ul>";fullText+="<li>"+val(node.t)+"</li>",currentLevel=level}}else fullText+=this._padText(val(node.t),level,"	")+"\r\n"}.bind(this),function(rawData){cb(fullText,rawData)})},saveRevisionData:function saveRevisionDataFn(docID,rev,format){var fullText="";this._makeConsumableOutput(docID,rev,function(node,level){fullText+=this._padText(val(node.t),level,"	")+"\r\n"}.bind(this),function(){var blob=new Blob([fullText],{type:"text/plain;charset=utf-8"});saveAs(blob,"DataRecovery_"+rev+".txt")})},saveDefaultRevisionData:function saveDefaultRevisionDataFn(rev,format){return this.saveRevisionData(this.getCurrentDocID(),rev,format)},saveRevisionOffset:function saveRevisionOffsetFn(offset,format){var rev=this.getCurrentRevision()-offset;return 0>rev?log("Maximum offset is: "+this.getCurrentRevision()):this.saveDefaultRevisionData(rev,format)},getHelp:function getHelpFn(){return console.log("To recover your data input __MoodoRecovery.saveRevisionOffset(<revision offset>)"),console.log("The maximum <revision offset> for this document is "+this.getCurrentRevision()),console.log("If you just lost data, an offset of 10 is a good place to start"),console.log("You may need to try larger offsets if the returned file does not contain the data you need"),console.log("This is a temporary tool to help recover data, please report any issues or data loss to support@moo.do"),window.__SendInfo("Recover Help Used!"),""}};var rec=new Recovery;return window.__MoodoRecovery={raw:rec,help:rec.getHelp.bind(rec),getCurrentRevision:rec.getCurrentRevision.bind(rec),getCurrentDocID:rec.getCurrentDocID.bind(rec),getRawData:rec.getDefaultRawRevisionData.bind(rec),printRevision:rec.printDefaultRevisionData.bind(rec),saveRevision:rec.saveDefaultRevisionData.bind(rec),printRevisionOffset:rec.printRevisionOffset.bind(rec),saveRevisionOffset:rec.saveRevisionOffset.bind(rec)},rec}),define("ReactModalRevisionHistory",["require","exports","module","globals","data","gdata","platform","react","MooReact","recovery","NativeSel","Components/FancyModal","Components/FancyListItem","Components/FancyCheckbox","Components/FancyButton"],function(require,exports,module){var g=require("globals"),d=require("data"),gdata=require("gdata"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),recovery=require("recovery"),NativeSel=require("NativeSel"),FancyModal=require("Components/FancyModal"),FancyListItem=require("Components/FancyListItem"),FancyCheckbox=require("Components/FancyCheckbox"),FancyButton=require("Components/FancyButton"),ReactModalRevisionHistory=MooReact.createClass({displayName:"ReactModalRevisionHistory",propTypes:{},init:function init(){if(this.maxRevision=0,this.revisions=[],this.selectedRevision=null,this.isOnline=!!gdata.doc,this.createObservables({isLoading:!1,recoveredPreview:null}),gdata.doc){var revision=recovery.getCurrentRevision()-1;this.maxRevision=revision,this.selectedRevision=revision;for(var minRevision=Math.max(revision-500,0),arr=[],i=revision;i>=minRevision;--i)arr.push(i);this.revisions=arr,this.updatePreview()}else this.recoveredPreview.set("You must be online to view your revision history. Please go online and try again.")},getState:function getState(){return{}},updatePreview:function updatePreview(){this.recoveredPreview.set("",!1),this.isLoading.set(!0);var docID=recovery.getCurrentDocID();recovery.getRevisionData(docID,this.selectedRevision,"html",function(data){this.recoveredPreview.set(data,!1),this.isLoading.set(!1)}.bind(this))},onSelectChange:function onSelectChange(e){this.selectedRevision=this.revisions[e.target.selectedIndex],log(this.selectedRevision),this.updatePreview()},onTapSelect:function onTapSelect(){var range=NativeSel.createSelectionRange();range.selectNodeContents(this.refs.exportedContent),NativeSel.setSelectionRange(range)},onKeyDown:function onKeyDown(e){platform.normalizeKeys(e),log(e.metaKey,e.ctrlKey,e.keyCode),(platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey)&&e.keyCode===KeyCode.A&&this.onTapSelect(),e.preventDefault(),e.stopPropagation()},onTapRestore:function onTapRestore(e,cb){var successCB=function successCB(){g.menus.alert({text:"Your data has been recovered.",actionText:"OKAY",callback:d.clearDataAndReload}),cb()},failureCB=function failureCB(){g.menus.alert({text:"There was an error recovering your data. Please contact support@moo.do for additional help.",actionText:"OKAY"}),cb()};return recovery.recoverRevision(this.selectedRevision,successCB,failureCB),!0},render:function render(){var dataType=this.state.dataType,classContent=g.classNames({loading:this.state.isLoading});return React.createElement(FancyModal,{id:"modalRevisionHistory",title:"Revision History",width:860,height:900,modalID:Modals.RevisionHistory},React.createElement("div",{key:"sidebar",width:180},React.createElement(FancyListItem,{header:!0},"Choose Revision"),React.createElement(FancyListItem,{style:{lineHeight:"24px",height:"36px"},clickable:!1},React.createElement("select",{onChange:this.onSelectChange},this.revisions.map(function(revision){return React.createElement("option",{key:revision,value:revision},revision)}))),React.createElement(FancyButton,{primary:!0,enabled:this.isOnline,onClick:this.onTapRestore},"RESTORE"),React.createElement(FancyListItem,{header:!0},"Directions"),React.createElement(FancyListItem,{clickable:!1,subtext:!0},React.createElement("p",null,"Choose the revision from the dropdown that you want to revert to."),React.createElement("p",null,"Each change is a new revision, so if you've made a lot of changes you may want to go back by 50 or 100."),React.createElement("p",null,"You may need to reload or re-login to other clients to see the recovered data there."))),React.createElement("div",{key:"content",className:classContent},React.createElement("div",{className:"exportedContent",onKeyDown:this.onKeyDown,contentEditable:!0,dangerouslySetInnerHTML:{__html:this.state.recoveredPreview},ref:"exportedContent"})))}});return ReactModalRevisionHistory});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactModalReportProblem",["require","exports","module","globals","Constants","react","EmailPreview","MooReact","Components/FancyButton","Components/FancyTextarea","Components/FancyModal"],function(require,exports,module){var g=require("globals"),C=require("Constants"),React=require("react"),EmailPreview=require("EmailPreview"),MooReact=require("MooReact"),FancyButton=require("Components/FancyButton"),FancyTextarea=require("Components/FancyTextarea"),FancyModal=require("Components/FancyModal"),ReactModalReportProblem=MooReact.createClass({displayName:"ReactModalReportProblem",propTypes:{accountID:React.PropTypes.string.isRequired,threadID:React.PropTypes.string.isRequired,msgID:React.PropTypes.string.isRequired},componentDidMount:function componentDidMount(){this.refs.textarea.focus()},sendReport:function sendReport(sendContent){var props=this.props;EmailPreview.reportMessage(props.accountID,props.threadID,props.msgID,this.refs.textarea.getValue(),sendContent),this.refs.modal.close()},onClickSend:function onClickSend(){this.sendReport(!0)},onClickCancel:function onClickCancel(){this.sendReport(!1)},render:function render(){return React.createElement(FancyModal,_extends({},this.props,{id:"modalReportProblem",title:"Report Problem",scrollable:!1,modalID:Modals.ReportProblem,ref:"modal"}),React.createElement("div",{key:"content"},React.createElement("div",{className:"fancyModalText"},"Please describe the display problem."),React.createElement(FancyTextarea,{ref:"textarea"}),React.createElement("div",{className:"fancyModalText"},"This will send the content of your email to the developers to fix display errors.")),React.createElement("div",{key:"buttons",style:{textAlign:"right"}},React.createElement(FancyButton,{width:100,onClick:this.onClickCancel},"CANCEL"),React.createElement(FancyButton,{primary:!0,width:100,onClick:this.onClickSend},"SEND")))}});return ReactModalReportProblem}),define("ReactModalWelcome",["require","exports","module","react","globals","Constants","platform","MooReact","PluginSettings","Components/FancyCheckbox","Components/FancyButton","Components/FancyModal"],function(require,exports,module){var React=require("react"),g=require("globals"),C=require("Constants"),platform=require("platform"),MooReact=require("MooReact"),PluginSettings=require("PluginSettings"),FancyCheckbox=require("Components/FancyCheckbox"),FancyButton=require("Components/FancyButton"),FancyModal=require("Components/FancyModal"),ReactModalWelcome=MooReact.createClass({displayName:"ReactModalWelcome",init:function init(){},onClickEnable:function onClickEnable(e,cb){var plugins=[PluginID.Contacts,PluginID.GCalendar,PluginID.Gmail,PluginID.Drive],enabledPlugins=plugins.filter(function(id){return this.refs[id].getValue()}.bind(this)).map(function(id){return id===PluginID.Drive?{id:id,shared:this.refs.DriveShared.getValue()}:{id:id}}.bind(this)),useOffline=this.refs.offlineFeatures.getValue();PluginSettings.enablePlugins(enabledPlugins,useOffline,function(success){success&&this.refs.modal&&this.refs.modal.close()}.bind(this))},onClickSkip:function onClickSkip(){this.refs.modal.close()},onChangeDrive:function onChangeDrive(value){this.onChangeFeature(value),value||this.refs.DriveShared.setValue(!1)},onChangeDriveShared:function onChangeDriveShared(value){this.onChangeFeature(value),value&&this.refs[PluginID.Drive].setValue(!0)},onChangeFree:function onChangeFree(value){this.refs[PluginID.Contacts].setValue(value),this.refs[PluginID.Gmail].setValue(value),this.refs.offlineFeatures.setValue(value)},onChangePremium:function onChangePremium(value){this.refs[PluginID.GCalendar].setValue(value),this.refs[PluginID.Drive].setValue(value),this.refs.DriveShared.setValue(value)},onChangeFeature:function onChangeFeature(value){this.refs.free.setValue(this.refs[PluginID.Contacts].getValue(value));for(var value=0,premium=this.refs.premium,premiums=[PluginID.GCalendar,PluginID.Gmail,PluginID.Drive,"offlineFeatures","DriveShared"],i=0;i<premiums.length;i++)this.refs[premiums[i]].getValue()?value++:value--;value===premiums.length&&premium.setValue(!0),value===-premiums.length&&premium.setValue(!1)},render:function render(){return React.createElement(FancyModal,{id:"modalWelcome",width:700,height:776,modalID:Modals.Welcome,closeButton:!1,backdropClose:!1,ref:"modal"},React.createElement("div",{key:"content"},React.createElement("div",{className:"setupTitle"},"Connect ",React.createElement("span",{className:"logoPseudo"})," with..."),React.createElement("div",{className:"setupFeatures featureCheckboxes"},React.createElement("div",{className:"featureTier"},React.createElement("div",{className:"tierTitleWrapper"},React.createElement(FancyCheckbox,{ref:"free",className:"tierTitle",checked:!0,onChange:this.onChangeFree},"Free Features")),React.createElement("div",{className:"row"},React.createElement("div",{className:"setupFeature setupFeatureHalf"},React.createElement(FancyCheckbox,{checked:!0,canChange:!1},"Outline, Tasks, Agenda"),React.createElement("div",{className:"setupFeatureDesc"},"Organize unlimited items in the Outline and integrated Agenda.")),React.createElement("div",{className:"setupFeature setupFeatureHalf"},React.createElement(FancyCheckbox,{ref:PluginID.Contacts,checked:!0,onChange:this.onChangeFeature},React.createElement("i",{className:"icon-group"}),"Google Contacts"),React.createElement("div",{className:"setupFeatureDesc"},"Sync email addresses and phone numbers."))),React.createElement("div",{className:"row"},React.createElement("div",{className:"setupFeature setupFeatureHalf"},React.createElement(FancyCheckbox,{ref:PluginID.Gmail,checked:!0,onChange:this.onChangeFeature},React.createElement("img",{src:"/img/plugin-gmail.png"}),"Gmail"),React.createElement("div",{className:"setupFeatureDesc"},"Read and write emails with Moo.do.")),React.createElement("div",{className:"setupFeature setupFeatureHalf"},React.createElement(FancyCheckbox,{ref:"offlineFeatures",checked:!0,onChange:this.onChangeFeature},"Offline Features"),React.createElement("div",{className:"setupFeatureDesc"},"Gmail features like Snooze require server access to your account so Moo.do can manage your inbox while you're not around.")))),React.createElement("div",{className:"featureTier"},React.createElement("div",{className:"tierTitleWrapper"},React.createElement(FancyCheckbox,{ref:"premium",className:"tierTitle",onChange:this.onChangePremium},"Premium Features")),React.createElement("div",{className:"featureTierDesc"},"Enabling Premium features will start a free "+C.TrialDuration+" day trial of Moo.do Premium."),React.createElement("div",{className:"row"},React.createElement("div",{className:"setupFeature setupFeatureHalf"},React.createElement(FancyCheckbox,{ref:PluginID.GCalendar,onChange:this.onChangeFeature},React.createElement("img",{src:"/img/plugin-gcal.png"}),"Google Calendar"),React.createElement("div",{className:"setupFeatureDesc"},"Sync calendar appointments with the ",React.createElement("b",null,"Moo.do")," Agenda.")),React.createElement("div",{className:"setupFeature setupFeatureHalf"},React.createElement(FancyCheckbox,{ref:PluginID.Drive,onChange:this.onChangeDrive},React.createElement("img",{src:"/img/plugin-gdrive.png"}),"Google Drive"),React.createElement("div",{className:"setupFeatureDesc"},"Attach files to tasks. Drag files from your desktop to upload to Drive."),React.createElement(FancyCheckbox,{ref:"DriveShared",className:"subcheckbox",onChange:this.onChangeDriveShared},"Share files with collaborators"))))),React.createElement("div",{className:"setupSubtext"},React.createElement("b",null,"Moo.do")," connects with your Google services to integrate everything together. ",React.createElement("b",null,"Moo.do")," data is stored in your personal Google Drive account and is never sent to any other server. Nobody can access any of your data. See our ",React.createElement("span",{className:"link"},"Privacy Policy")," for more details."),React.createElement("div",{className:"setupButtons"},React.createElement(FancyButton,{raised:!0,primary:!0,onClick:this.onClickEnable},"GET STARTED"),React.createElement(FancyButton,{raised:!0,marginLeft:32,onClick:this.onClickSkip},"I'll do this later"))))}});return ReactModalWelcome}),define("ReactModals",["require","exports","module","globals","react","MooReact","Dispatcher","VMPane","DragDrop","ReactModalEmailReply","ReactModalSettings","ReactModalAlert","ReactModalBilling","ReactModalConfirm","ReactModalOptions","ReactModalExport","ReactModalImport","ReactModalRevisionHistory","ReactModalReportProblem","ReactModalWelcome"],function(require,exports,module){var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},g=require("globals"),React=require("react"),ReactCSSTransitionGroup=React.addons.CSSTransitionGroup,MooReact=require("MooReact"),Dispatcher=require("Dispatcher"),VMPane=require("VMPane"),DragDrop=require("DragDrop"),ReactModalEmailReply=require("ReactModalEmailReply"),ReactModalSettings=require("ReactModalSettings"),ReactModalAlert=require("ReactModalAlert"),ReactModalBilling=require("ReactModalBilling"),ReactModalConfirm=require("ReactModalConfirm"),ReactModalOptions=require("ReactModalOptions"),ReactModalExport=require("ReactModalExport"),ReactModalImport=require("ReactModalImport"),ReactModalRevisionHistory=require("ReactModalRevisionHistory"),ReactModalReportProblem=require("ReactModalReportProblem"),ReactModalWelcome=require("ReactModalWelcome"),ReactMenus=MooReact.createClass({displayName:"ReactMenus",propTypes:{},getState:function getState(){return{modals:g.menus.modalStack}
},renderModal:function renderModal(params){var id=params.id,modal=id===Modals.Settings&&ReactModalSettings||id===Modals.Alert&&ReactModalAlert||id===Modals.Confirm&&ReactModalConfirm||id===Modals.Options&&ReactModalOptions||id===Modals.ExportData&&ReactModalExport||id===Modals.ImportData&&ReactModalImport||id===Modals.RevisionHistory&&ReactModalRevisionHistory||id===Modals.ReportProblem&&ReactModalReportProblem||id===Modals.Billing&&ReactModalBilling||id===Modals.EmailReply&&ReactModalEmailReply||id===Modals.Welcome&&ReactModalWelcome;try{g.PAssert(4916,modal,"Could not find modal with id "+id)}catch(PERR){g.reportError(PERR)}return React.createElement(modal,_extends({key:params.id},params))},render:function render(){for(var modals=[],i=0;i<this.state.modals.length;i++)modals.push(this.renderModal(this.state.modals[i]));return React.createElement(ReactCSSTransitionGroup,{className:"modals",transitionName:"modalTransition",transitionEnterTimeout:400,transitionLeaveTimeout:300},modals)}});return ReactMenus}),define("Components/FancyColorPickerContextMenu",["require","globals","react","MooReact","Components/FancyContextMenu"],function(require){function pad2(c){return 1===c.length?"0"+c:""+c}function rgbToHex(r,g,b){var hex=[pad2(Math.round(r).toString(16)),pad2(Math.round(g).toString(16)),pad2(Math.round(b).toString(16))];return hex.join("")}function hexToRgb(hex){var r=parseInt(hex.substr(1,2),16),g=parseInt(hex.substr(3,2),16),b=parseInt(hex.substr(5,2),16);return{r:r,g:g,b:b}}var colors=["#4D4D4D","#999999","#CCCCCC","#FFFFFF","#F44E3B","#FE9200","#FCDC00","#A4DD00","#68CCCA","#73D8FF","#AEA1FF","#FDA1FF","#333333","#808080","#BBBBBB","#EEEEEE","#D33115","#E27300","#FCC400","#22AA66","#16A5A5","#0099DD","#7B64FF","#FA28FF","#000000","#666666","#AAAAAA","#DDDDDD","#AA3300","#C45100","#FB9E00","#194D33","#0C797D","#0062B1","#653294","#AB149E"],matchers={hex3:/^(#)([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^(#)([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/},g=require("globals"),React=require("react"),MooReact=require("MooReact"),FancyContextMenu=require("Components/FancyContextMenu"),FancyColorPickerContextMenu=MooReact.createClass({displayName:"FancyColorPickerContextMenu",propTypes:{color:React.PropTypes.string.isRequired,onChange:React.PropTypes.func.isRequired},init:function init(){this.createObservables({color:this.props.color,value:this.props.color,isValid:!0})},parseColor:function parseColor(value){var match;return(match=matchers.hex3.exec(value))?"#"+match[2]+match[2]+match[3]+match[3]+match[4]+match[4]:(match=matchers.hex6.exec(value))?value:void 0},onClickColor:function onClickColor(color){this.color.set(color),this.value.set(color),this.props.onChange(color)},onChangeInputColor:function onChangeInputColor(e){var value=e.target.value.toUpperCase();0!==value.indexOf("#")&&(value="#"+value);var color=this.parseColor(value);color&&(this.color.set(color),this.props.onChange(color)),value.length<8&&this.value.set(value),this.isValid.set(!!this.parseColor(this.value.get()))},onChangeInputComponent:function onChangeInputComponent(){var refs=this.refs,cr=refs.r.value,cg=refs.g.value,cb=refs.b.value;if(cr>=0&&255>=cr&&cg>=0&&255>=cg&&cb>=0&&255>=cb){var color="#"+rgbToHex(cr,cg,cb);this.value.set(color),this.color.set(color),this.props.onChange(color)}},render:function render(){for(var state=this.state,color=this.state.color,colorRGB=hexToRgb(color),colorDivs=[],i=0;i<colors.length;i++){var c=colors[i],cls=g.classNames("fancyColor",{selected:c===color},{isWhite:"#FFFFFF"===c.toUpperCase()}),style={background:c};colorDivs.push(React.createElement("div",{key:c,className:cls,style:style,onClick:this.onClickColor.bind(this,c)}))}var clsInput=g.classNames("fancyColorInputColor",{invalid:!state.isValid});return React.createElement(FancyContextMenu,{id:"fancyColorPicker",element:this.props.element,offset:{left:-120,top:4}},React.createElement("div",{className:"fancyColors"},colorDivs),React.createElement("div",{className:"fancyColorText"},React.createElement("div",{key:color,className:"fancyColor",style:{background:color}}),React.createElement("input",{type:"text",className:clsInput,value:state.value,onChange:this.onChangeInputColor}),React.createElement("span",null,"R"),React.createElement("input",{type:"text",ref:"r",className:"fancyColorInputComponent",value:colorRGB.r,onChange:this.onChangeInputComponent}),React.createElement("span",null,"G"),React.createElement("input",{type:"text",ref:"g",className:"fancyColorInputComponent",value:colorRGB.g,onChange:this.onChangeInputComponent}),React.createElement("span",null,"B"),React.createElement("input",{type:"text",ref:"b",className:"fancyColorInputComponent",value:colorRGB.b,onChange:this.onChangeInputComponent})))}});return FancyColorPickerContextMenu}),define("Components/FancyColorPicker",["require","globals","react","MooReact","Components/FancyColorPickerContextMenu"],function(require){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),FancyColorPickerContextMenu=require("Components/FancyColorPickerContextMenu"),FancyColorPicker=MooReact.createClass({displayName:"FancyColorPicker",propTypes:{color:React.PropTypes.string.isRequired,onChange:React.PropTypes.func.isRequired},init:function init(){this.createObservables({color:this.props.color})},componentWillReceiveProps:function componentWillReceiveProps(nextProps){nextProps.color!==this.props.color&&this.color.set(nextProps.color)},openMenu:function openMenu(e){g.menus.openContextMenuReact({fn:this.renderContextMenu,element:e.target})},onChange:function onChange(value){this.color.set(value),this.props.onChange(value)},renderContextMenu:function renderContextMenu(params){return React.createElement(FancyColorPickerContextMenu,{key:"fancyColorPicker",color:this.state.color,onChange:this.onChange,element:params.element})},render:function render(){var style={background:this.state.color,border:"1px solid #666"},cls=g.classNames("fancyColor",{isWhite:"#FFFFFF"===this.state.color.toUpperCase()});return React.createElement("div",{className:cls,style:style,onClick:this.openMenu})}});return FancyColorPicker}),define("ReactDisplaySettingsSidebar",["require","exports","module","globals","platform","react","MooReact","DisplaySettings","Sel","Measure","Components/FancyInputNumber","Components/FancyButton","Components/FancyColorPicker","Components/FancyCheckbox","Components/FancyScroller"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),ReactCSSTransitionGroup=React.addons.CSSTransitionGroup,MooReact=require("MooReact"),DisplaySettings=require("DisplaySettings"),Sel=require("Sel"),Measure=require("Measure"),FancyInputNumber=require("Components/FancyInputNumber"),FancyButton=require("Components/FancyButton"),FancyColorPicker=require("Components/FancyColorPicker"),FancyCheckbox=require("Components/FancyCheckbox"),FancyScroller=require("Components/FancyScroller"),ReactDisplaySettingsSidebar=MooReact.createClass({displayName:"ReactDisplaySettingsSidebar",propTypes:{},init:function init(){this.createObservables({showAdvanced:!1})},componentDidMount:function componentDidMount(){},getState:function getState(){return{isOpen:g.vmMain.isDisplaySettingsOpen}},updateSetting:function updateSetting(setting,value){g.settings.set(setting,value,Settings.UISettingsGroup)},onClickTheme:function onClickTheme(theme){DisplaySettings.changeTheme(theme),this.forceUpdate()},isGrayscale:function isGrayscale(){return g.settings.get(Settings.grayscale,Settings.UISettingsGroup)===!0},toggleAdvanced:function toggleAdvanced(){this.showAdvanced.set(!this.showAdvanced.get())},close:function close(){g.vmMain.isDisplaySettingsOpen.set(!1)},render:function render(){var state=this.state,advanced;if(state.showAdvanced){var cls=g.classNames("settingsAdvanced",{disabledSettings:!g.billingManager.hasPremiumFeatures()});advanced=React.createElement("div",null,React.createElement("div",{style:{color:"#aaa",margin:"16px 0"}},"Advanced (Premium Only)"),React.createElement("div",{className:cls},React.createElement("div",null,React.createElement(FancyCheckbox,{checked:g.settings.get(Settings.showBullets,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.showBullets)},"Show Bullets")),React.createElement("div",null,React.createElement(FancyCheckbox,{checked:g.settings.get(Settings.showVerticalLines,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.showVerticalLines)},"Show Vertical Lines")),React.createElement("div",null,React.createElement("span",null,"Item Font Size: "),React.createElement(FancyInputNumber,{value:g.settings.get(Settings.fontSize,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.fontSize)})),React.createElement("div",null,React.createElement("span",null,"Note Font Size: "),React.createElement(FancyInputNumber,{value:g.settings.get(Settings.noteFontSize,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.noteFontSize)})),React.createElement("div",null,React.createElement("span",null,"Item Line Height: "),React.createElement(FancyInputNumber,{value:g.settings.get(Settings.itemLineHeight,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.itemLineHeight)})),React.createElement("div",null,React.createElement("span",null,"Item Padding: "),React.createElement(FancyInputNumber,{value:g.settings.get(Settings.itemPadding,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.itemPadding)})),React.createElement("div",null,React.createElement("span",null,"Indent Size: "),React.createElement(FancyInputNumber,{value:g.settings.get(Settings.itemIndentSize,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.itemIndentSize)})),React.createElement("div",null,React.createElement("span",null,"Bullet Color: "),React.createElement(FancyColorPicker,{color:g.settings.get(Settings.bulletColor,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.bulletColor)})),React.createElement("div",null,React.createElement("span",null,"Vertical Lines Color: "),React.createElement(FancyColorPicker,{color:g.settings.get(Settings.verticalLinesColor,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.verticalLinesColor)})),React.createElement("div",null,React.createElement("span",null,"Tag Color: "),React.createElement(FancyColorPicker,{color:g.settings.get(Settings.tagColor,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.tagColor)})),React.createElement("div",null,React.createElement("span",null,"Date Color: "),React.createElement(FancyColorPicker,{color:g.settings.get(Settings.dateColor,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.dateColor)})),React.createElement("div",null,React.createElement("span",null,"Contact Color: "),React.createElement(FancyColorPicker,{color:g.settings.get(Settings.contactColor,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.contactColor)})),React.createElement("div",null,React.createElement("span",null,"Link Color: "),React.createElement(FancyColorPicker,{color:g.settings.get(Settings.linkColor,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.linkColor)})),React.createElement("div",null,React.createElement(FancyCheckbox,{checked:g.settings.get(Settings.underlineP,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.underlineP,Settings.UISettingsGroup)},"Underline tags, dates, contacts"))))}var content=state.isOpen&&React.createElement("div",{className:"displaySettings"},React.createElement("div",{className:"displaySettingsSidebar"},React.createElement("div",{className:"overlayTitleBar"},React.createElement("div",{className:"displayTitle"},"Display Settings"),React.createElement(FancyButton,{className:"displayCloseButton",icon:"icon-close",width:36,height:36,onClick:this.close})),React.createElement(FancyScroller,null,React.createElement("div",null,React.createElement("div",{style:{color:"#aaa",fontStyle:"bold"}},"Theme"),React.createElement("div",{className:"themeButtons"},React.createElement(FancyButton,{primary:!0,raised:!0,onClick:this.onClickTheme.bind(this,"Classic")},"Classic"),React.createElement(FancyButton,{primary:!0,raised:!0,marginLeft:16,onClick:this.onClickTheme.bind(this,"Outliner")},"Outliner"),React.createElement(FancyButton,{primary:!0,raised:!0,marginLeft:16,onClick:this.onClickTheme.bind(this,"Light")},"Light")),React.createElement("div",{style:{color:"#aaa",fontStyle:"bold"}},"Options"),React.createElement("div",{style:{marginTop:16}},React.createElement(FancyCheckbox,{checked:this.isGrayscale(),onChange:this.updateSetting.bind(this,Settings.grayscale)},"Grayscale")),React.createElement("div",{style:{marginTop:16}},React.createElement(FancyCheckbox,{checked:g.settings.get(Settings.boldHeaders,Settings.UISettingsGroup),onChange:this.updateSetting.bind(this,Settings.boldHeaders)},"Automatically Bold Headers"))),advanced,React.createElement("div",{style:{marginTop:16,textAlign:"center"}},React.createElement(FancyButton,{raised:!0,onClick:this.toggleAdvanced},(state.showAdvanced?"Hide":"Show")+" Advanced (Premium)")))));return React.createElement(ReactCSSTransitionGroup,{transitionName:"previewOpen",component:"div",transitionEnterTimeout:200,transitionLeaveTimeout:200},content)}});return ReactDisplaySettingsSidebar}),define("ReactFile",["require","globals","tracker","react","MooReact","Components/FancyContextMenuItem"],function(require){var g=require("globals"),tracker=require("tracker"),React=require("react"),MooReact=require("MooReact"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),ReactFile=MooReact.createClass({displayName:"ReactFile",propTypes:{file:React.PropTypes.object.isRequired},getState:function getState(){var file=this.props.file;return{isShared:file._isShared,title:file._title,isOpen:file.isOpen()}},onClickDocumentTitle:function onClickDocumentTitle(){var doc=this.props.file,picker=g.vmMain.vmPicker;picker.openDocument(doc),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocument})},onClickDocumentSettings:function onClickDocumentSettings(doc){var doc=this.props.file,picker=g.vmMain.vmPicker;picker.openSharing(doc),g.sendEvent("Menu","OpenSharing"),tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocSharing})},render:function render(){var state=this.state,picker=g.vmMain.vmPicker;return React.createElement(FancyContextMenuItem,{icon:state.isShared?"icon-user":"icon-settings",selected:state.isOpen,tooltip:"Open "+state.title,iconTooltip:"Share / Rename / Delete",onClick:this.onClickDocumentTitle,onClickIcon:this.onClickDocumentSettings},state.title)}});return ReactFile});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};define("ReactContextMenuDocuments",["require","globals","platform","react","MooReact","ReactFile","Components/FancyScroller","Components/FancyContextMenu","Components/FancyContextMenuItem"],function(require){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),ReactFile=require("ReactFile"),FancyScroller=require("Components/FancyScroller"),FancyContextMenu=require("Components/FancyContextMenu"),FancyContextMenuItem=require("Components/FancyContextMenuItem"),ReactContextMenuDocuments=MooReact.createClass({displayName:"ReactContextMenuDocuments",getState:function getState(){var picker=g.vmMain.vmPicker;return{files:g.vmMain.docManager._docList,showError:picker.showError,isLoading:picker.isLoading}},render:function render(){var picker=g.vmMain.vmPicker,props=this.props,state=this.state,classMenu=g.classNames("flexbox flexvert",{loading:state.isLoading||0===state.files.length}),menu;if(state.showError)menu=React.createElement(FancyContextMenu,_extends({},props,{key:"contextMenuDocuments",id:"contextMenuDocuments",supportArrows:!0}),React.createElement(FancyContextMenuItem,{onClick:picker.onTapReloadDocuments.bind(picker)},state.showError));else if(state.isLoading||0===state.files.length)menu=React.createElement(FancyContextMenu,_extends({},props,{key:"contextMenuDocuments",id:"contextMenuDocuments",loading:!0,supportArrows:!0}));else{var clsScroller=g.classNames({f1:!platform.mobile}),styleScroller={maxHeight:platform.mobile?.6*platform.windowHeight():null};menu=React.createElement(FancyContextMenu,_extends({},props,{key:"contextMenuDocuments",id:"contextMenuDocuments",className:classMenu,supportArrows:!0}),React.createElement(FancyContextMenuItem,{id:"addDocument",onClick:picker.onTapAddDocument.bind(picker),icon:"icon-add",iconSize:18},"New Document"),React.createElement("hr",null),React.createElement(FancyScroller,{className:clsScroller,style:styleScroller},state.files.map(function(file){return React.createElement(ReactFile,{key:"file_"+file.id,file:file})})))}return menu}});return ReactContextMenuDocuments}),define("ReactDesktopMenu",["require","globals","Constants","platform","react","MooReact","tracker","Sel","ReactInviteSection","ReactContextMenuDocuments","Components/FancyContextMenu","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),tracker=require("tracker"),Sel=require("Sel"),ReactInviteSection=require("ReactInviteSection"),ReactContextMenuDocuments=require("ReactContextMenuDocuments"),FancyContextMenu=require("Components/FancyContextMenu"),FancyButton=require("Components/FancyButton"),height=36,ReactDesktopMenu=MooReact.createClass({displayName:"ReactDesktopMenu",propTypes:{main:React.PropTypes.object.isRequired},init:function init(){this.listenToDispatcher(g.settings,"settingChanged",Settings.DefaultGroup,Settings.gdocTitle),this.listenToDispatcher(g.vmMain.pluginManager,"pluginActiveChanged")},getState:function getState(){var main=this.props.main,state={gdriveStatus:main.gdriveStatusObs,daysLeftInTrial:g.billingManager.daysLeftInTrial,showCompose:g.vmMain.pluginManager.isEnabled(PluginID.Gmail),premiumStatus:g.billingManager._premiumStatus},driveStatus=main.gdriveStatus(),title=g.settings.get(Settings.gdocTitle);return state.isOnline=driveStatus!==DriveStatus.Offline,state.isConnected=driveStatus===DriveStatus.Saving||driveStatus===DriveStatus.Saved,state.documentName=title,state.onlineText=g.isDemoMode()&&"DEMO"||driveStatus===DriveStatus.Connecting&&"CONNECTING"||driveStatus===DriveStatus.Offline&&"OFFLINE"||driveStatus===DriveStatus.Reconnecting&&"RETRYING"||"",state},openContextMenu:function openContextMenu(fn,e){Sel.reset(),g.menus.openContextMenuReact({fn:fn,element:e.target}),e.preventDefault()},openContextMenuComponent:function openContextMenuComponent(componentName,e){Sel.reset(),g.menus.openContextMenuReact({componentName:componentName,element:e.target}),e.preventDefault()},onMouseDownDocuments:function onMouseDownDocuments(e){tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocumentsMenu}),this.openContextMenu(this.renderContextMenuDocuments,e)},onMouseDownHeart:function onMouseDownHeart(e){this.openContextMenu(this.renderContextMenuHeart,e)},onMouseDownAddPane:function onMouseDownAddPane(e){this.openContextMenuComponent("ReactContextMenuAddPane",e)},onMouseDownOptions:function onMouseDownOptions(e){this.openContextMenuComponent("ReactContextMenuOptions",e)},onMouseDownEmail:function onMouseDownEmail(){g.menus.openComposeEmail(g.vmMain.getDefaultEmailPlugin())},onClickAddDocument:function onClickAddDocument(){g.vmMain.vmPicker.onTapAddDocument()},onClickTrial:function onClickTrial(){g.menus.openSettings(C.SettingsSections.Account)},onClickStatusText:function onClickStatusText(){g.isDemoMode()&&g.menus.confirm("Go to the Moo.do homepage?",function(result){if(result)if(window.parent)try{window.parent.location="https://www.moo.do"}catch(err){window.location="/"}else window.location="/"})},renderContextMenuDocuments:function renderContextMenuDocuments(params){return React.createElement(ReactContextMenuDocuments,{key:"contextMenuDocuments",element:params.element})},renderContextMenuHeart:function renderContextMenuHeart(params){return React.createElement(FancyContextMenu,{key:"contextMenuHeart",id:"contextMenuHeart",element:params.element},React.createElement(ReactInviteSection,{shouldShowInvitedBy:!1}))},render:function render(){var state=this.state,onlineClass=g.classNames("desktopMenuText","desktopOnline",{offline:!state.isOnline},{connected:state.isConnected},{notEmpty:!!state.onlineText}),showTrial=g.billingManager.isTrialState()&&!g.settings.get(Settings.trialOverHidden),isTrialOver=g.billingManager.isTrialOver(),statusStyle=g.isDemoMode()?{cursor:"pointer"}:void 0,addPaneTooltip="Add Pane ("+platform.secModKey+" + T)",newEmailTooltip="New Email ("+platform.secModKey+" + N)";return React.createElement("div",{id:"desktopMenu",className:"ns"},React.createElement(FancyButton,{id:"desktopMenuButton",ref:"documentsButton",tooltip:"Documents",icon:"icon-folder",width:height,height:height,margin:"0 2px",onMouseDown:this.onMouseDownDocuments}),state.documentName&&React.createElement("div",{className:"desktopMenuText documentName"},state.documentName),React.createElement("div",{onClick:this.onClickStatusText,style:statusStyle,className:onlineClass},state.onlineText),React.createElement("div",{className:"flex-spacer"}),showTrial&&!isTrialOver&&React.createElement("div",{className:"desktopMenuText trial","data-tooltip":state.daysLeftInTrial+" days left in trial",onClick:this.onClickTrial},"TRIAL"),showTrial&&isTrialOver&&React.createElement("div",{className:"desktopMenuText trial","data-tooltip":"Learn More",onClick:this.onClickTrial},"TRIAL OVER"),state.showCompose&&React.createElement(FancyButton,{id:"newEmailButton",ref:"newEmail",icon:"icon-envelope",tooltip:newEmailTooltip,width:height,height:height,margin:"0 2px",onMouseDown:this.onMouseDownEmail}),React.createElement(FancyButton,{className:"right",id:"heartButton",ref:"heart",icon:"icon-heart",tooltip:"Share Moo.do",width:height,height:height,margin:"0 2px",onMouseDown:this.onMouseDownHeart}),React.createElement(FancyButton,{className:"right",id:"addPaneButton",ref:"addPane",tooltip:addPaneTooltip,icon:"icon-add",width:height,height:height,margin:"0 2px",onMouseDown:this.onMouseDownAddPane}),React.createElement(FancyButton,{className:"right",id:"optionsButton",ref:"options",tooltip:"Options",icon:"icon-settings",width:height,height:height,margin:"0 2px",onMouseDown:this.onMouseDownOptions}))}});return ReactDesktopMenu}),define("ReactEmailComposeWindow",["require","exports","module","globals","platform","react","MooReact","Sel","Dispatcher","ReactEmailCompose","Components/FancyInput","Components/FancyTextarea","Components/FancyButton"],function(require,exports,module){var g=require("globals"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),Sel=require("Sel"),Dispatcher=require("Dispatcher"),ReactEmailCompose=require("ReactEmailCompose"),FancyInput=require("Components/FancyInput"),FancyTextarea=require("Components/FancyTextarea"),FancyButton=require("Components/FancyButton"),ReactEmailComposeWindow=MooReact.createClass({displayName:"ReactEmailComposeWindow",propTypes:{threadAttach:React.PropTypes.object.isRequired,message:React.PropTypes.object.isRequired},init:function init(){this.createObservables({minimized:!1})},minimize:function minimize(){this.minimized.set(!this.minimized.get())},close:function close(){this.refs.compose.close(!0,!1,!0)},onClose:function onClose(){Dispatcher.fireEvent("EmailCompose","onClosed",[]),g.menus.closeComposeEmail(this.props.threadAttach,this.props.message)},onMouseDown:function onMouseDown(){Sel.reset()},openCc:function openCc(){this.cc.set(!0)},openBcc:function openBcc(){this.bcc.set(!0)},componentDidMount:function componentDidMount(){var compose=this.refs.compose;compose.focusTo(),requestAnimationFrame(function(){compose.focusTo()})},render:function render(){var style={height:this.minimized.get()?"44px":void 0};return React.createElement("div",{className:"composeEmail",ref:"element",style:style,onMouseDown:this.onMouseDown},React.createElement("div",{className:"overlayTitleBar composeTitleBar flexbox"},React.createElement("div",{className:"composeTitle f1"},"New Message"),React.createElement(FancyButton,{className:"composeMinimize",icon:"icon-minus",paddingTop:4,iconSize:14,width:36,height:36,onClick:this.minimize,tooltip:"Minimize"}),React.createElement(FancyButton,{className:"composeClose",icon:"icon-close",iconSize:18,width:36,height:36,onClick:this.close,tooltip:"Close"})),React.createElement(ReactEmailCompose,{threadAttach:this.props.threadAttach,message:this.props.message,showSubject:!0,onClose:this.onClose,ref:"compose",focus:"to"}))}});return ReactEmailComposeWindow}),define("ReactEmailComposes",["require","exports","module","globals","react","ReactEmailComposeWindow","MooReact"],function(require,exports,module){var g=require("globals"),React=require("react"),ReactEmailComposeWindow=require("ReactEmailComposeWindow"),MooReact=require("MooReact"),ReactEmailComposes=MooReact.createClass({displayName:"ReactEmailComposes",propTypes:{},getState:function getState(){return{emailComposes:g.menus.emailComposeStack}},render:function render(){for(var state=this.state,composes=[],i=0;i<state.emailComposes.length;i++){var draftData=state.emailComposes[i];composes.push(React.createElement(ReactEmailComposeWindow,{key:draftData.draftMsg.id,threadAttach:draftData.attach,message:draftData.draftMsg}))}return React.createElement("div",{className:"emailComposes flexbox"},composes)}});return ReactEmailComposes}),define("ReactIntro",["require","exports","module","globals","Constants","platform","react","MooReact","ReactIntroItem","Components/FancyScroller","Components/FancyButton"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),ReactIntroItem=require("ReactIntroItem"),FancyScroller=require("Components/FancyScroller"),FancyButton=require("Components/FancyButton"),importers=["Wunderlist","Workflowy","Trello","Google Tasks","Todoist"],ReactIntro=MooReact.createClass({displayName:"ReactIntro",init:function init(){this.intro=g.intro},getState:function getState(){var intro=this.intro;return{position:intro.position,mode:intro.mode,isHelpShowing:intro.isHelpShowing(),isImportShowing:intro.isImportShowing,sections:intro.sections,isIntroComplete:intro.isIntroComplete}},renderSection:function renderSection(section){return React.createElement("div",{className:"helpSection",key:section.id||section.text},React.createElement("div",{className:"helpTitle"},section.text),section.note&&React.createElement("div",{className:"helpNote"},section.note),React.createElement("ul",null,section.items.map(function(item,i){return React.createElement(ReactIntroItem,{item:item,key:i})})))},render:function render(){var state=this.state,intro=this.intro,isIntroMode=state.mode===C.HelpMode.Intro,renderedSections=[];if(state.isHelpShowing)for(var i=0;i<state.sections.length;i++)renderedSections.push(this.renderSection(state.sections[i]));var renderedImporters=[];if(state.isImportShowing)for(var i=0;i<importers.length;i++){var name=importers[i];renderedImporters.push(React.createElement(FancyButton,{key:i,onClick:intro.onClickImport.bind(intro,name)},name))}var helpClass=g.classNames("help","intro",{helpIntro:isIntroMode},{helpHotkeys:state.mode===C.HelpMode.Hotkeys},{helpNormal:state.mode===C.HelpMode.Normal},{showingImport:state.isImportShowing}),clsTabFeatures=g.classNames("tab tabFeatures f1",{selected:state.mode===C.HelpMode.Normal}),clsTabHotkeys=g.classNames("tab tabHotkeys f1",{selected:state.mode===C.HelpMode.Hotkeys}),style={};return style[platform.transform.react]="translate("+this.state.position+"px,0)",React.createElement("div",{id:"paneHelp",className:"paneHelp",style:style},React.createElement("div",{className:helpClass},React.createElement("div",{className:"helpInnerWrapper"},state.isHelpShowing&&React.createElement("div",{id:"helpHelp",className:"helpBox"},React.createElement("div",{className:"helpTop paneHeader"},React.createElement("div",{className:"paneHeaderRow"},React.createElement("div",{className:"title center"},"Help"),React.createElement(FancyButton,{className:"paneClose",icon:"icon-close",iconSize:18,width:44,height:44,onClick:intro.closeHelp.bind(intro),tooltip:"Close Pane"})),!isIntroMode&&React.createElement("div",{className:"paneHeaderRow"},React.createElement(FancyButton,{height:32,className:clsTabFeatures,onClick:intro.onTapFeatures.bind(intro)},"Features"),React.createElement(FancyButton,{height:32,className:clsTabHotkeys,onClick:intro.onTapHotkeys.bind(intro)},"Hotkeys"))),React.createElement(FancyScroller,{className:"helpScroller"},renderedSections,isIntroMode&&state.isIntroComplete&&React.createElement("div",{className:"introComplete"},React.createElement("hr",null),React.createElement("div",{className:"introCongrats"},"You have learned how to use Moo.do!"),React.createElement("div",{className:"introButtons"},React.createElement(FancyButton,{primary:!0,raised:!0,onClick:intro.switchToHelp.bind(intro)},"CONTINUE LEARNING")),React.createElement("div",{className:"introCongrats"},"Or press the ",React.createElement("i",{className:"icon-close gd"})," at the top right to close Help.")))),state.isImportShowing&&React.createElement("div",{id:"helpImporters",className:"helpBox"},React.createElement("div",{className:"helpTop paneHeader"},React.createElement("div",{className:"title center"},"Import your data"),React.createElement(FancyButton,{className:"paneClose",icon:"icon-close",iconSize:18,width:44,height:44,onClick:intro.onCloseImport.bind(intro),tooltip:"Close Importers"})),React.createElement("div",{className:"helpPadded"},React.createElement("div",{className:"helpNote"},"Start with your existing data to get started quickly."),React.createElement("div",{className:"importers"},renderedImporters),React.createElement("div",{className:"helpNote"},"You can import or export your data at any time by clicking ",React.createElement("i",{className:"icon-settings"})," in the top right."))))))}});return ReactIntro}),define("ReactOverview",["require","globals","Constants","platform","react","MooReact","VMPane","ReactCell","ReactInfiniteList","Components/FancyScroller"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),VMPane=require("VMPane"),ReactCell=require("ReactCell"),ReactInfiniteList=require("ReactInfiniteList"),FancyScroller=require("Components/FancyScroller"),ReactOverview=MooReact.createClass({displayName:"ReactOverview",propTypes:{pane:React.PropTypes.instanceOf(VMPane).isRequired},componentDidMount:function componentDidMount(){var pane=this.props.pane,overview=pane.getOverview(),scrollElement=overview.scrollElement=this.refs.overviewScroller.getScrollElement(),contentElement=overview.contentElement=this.refElement("overviewContentElement"),infiniteList=pane.getInfiniteList(!0);infiniteList.setupScroller(scrollElement,contentElement),this.setData(scrollElement,pane),g.setupClick(scrollElement,pane.getOverview(),pane.getOverview().onTap)},getState:function getState(){var pane=this.props.pane,overview=pane.getOverview(),state={isVisible:overview.isVisible,zoomed:pane.item};return platform.mobile?state.offsetX=pane.offsetX:(state.cursor=overview.cursor,state.rect=pane.rect),state},renderCell:function renderCell(index,cell){var pane=this.props.pane;return React.createElement(ReactCell,{key:index,pane:pane,cell:cell,overview:!0})},heightAtIndex:function heightAtIndex(index){var pane=this.props.pane,item=pane.headers.get()[index];return item.heightInPane(pane,!0)},itemsObs:function itemsObs(){return this.props.pane.headers
},render:function render(){var state=this.state,pane=this.props.pane,styleOverview={};platform.mobile||(styleOverview.cursor=state.cursor,styleOverview[platform.transform.react]="translate("+(state.rect.left-C.OverviewWidth)+"px,0)");var scrollerClass=g.classNames(this.props.className,"paneOverviewScroller","scroller",{customScroller:pane.useCustomScroller});return React.createElement(FancyScroller,{className:scrollerClass,ref:"overviewScroller",style:styleOverview,"data-moo-id":this.getUniqueID()},React.createElement("div",{className:"overviewContent"},React.createElement("div",{className:"paneOverview",ref:"overview"},React.createElement(ReactInfiniteList,{owner:pane.getInfiniteList(!0),pane:pane,overview:!0,renderCell:this.renderCell,itemsObs:this.itemsObs,minItemHeight:g.minItemHeight,contentClass:"overviewList noSelect mat-list",ref:"overviewContentElement"}))))}});return ReactOverview}),define("ReactMobileOverview",["require","globals","Constants","platform","react","MooReact","ReactOverview","ReactWrapper","ReactContextMenuDocuments","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),ReactOverview=require("ReactOverview"),ReactWrapper=require("ReactWrapper"),ReactContextMenuDocuments=require("ReactContextMenuDocuments"),FancyButton=require("Components/FancyButton"),ReactMobileOverview=MooReact.createClass({displayName:"ReactMobileOverview",getState:function getState(){return{documentName:g.settings.get(Settings.gdocTitle)||g.isDemoMode()&&"DEMO",mounted:this._isMounted}},componentDidMount:function componentDidMount(){this.updateState()},onTapFiles:function onTapFiles(){g.menus.openContextMenuReact({fn:this.renderContextMenuDocuments})},renderContextMenuDocuments:function renderContextMenuDocuments(){return React.createElement(ReactContextMenuDocuments,{key:"contextMenuDocuments",position:"bottom"})},renderWrapperStyle:function renderWrapperStyle(state,props){if(platform.mobile){var style={},offsetX=-(platform.windowWidth()*C.MobileOverviewWidth)+(this.state.mounted?state.offsetX:0);return style[platform.transform.react]="translate3d("+offsetX+"px,0,0)",this.props.pane.isAnimatingOffset&&(style[platform.transition.react]=platform.transform.style+" 0.15s"),style}},render:function render(){var state=this.state,pane=this.props.pane,styleBottom={height:C.MobileBottomHeight,lineHeight:C.MobileBottomHeight+"px"},wrapperObserve={};return platform.mobile&&(wrapperObserve.offsetX=pane.offsetX),React.createElement(ReactWrapper,{className:"mobileOverview flexbox flexvert",observe:wrapperObserve,renderStyle:this.renderWrapperStyle},React.createElement(ReactOverview,{pane:pane,className:"f1"}),React.createElement("div",{className:"mobileOverviewBottom mobileUIBottom flexbox",style:styleBottom},React.createElement(FancyButton,{icon:"icon-folder",color:"#777",iconSize:20,width:C.MobileBottomHeight,height:C.MobileBottomHeight,onClick:this.onTapFiles}),React.createElement("div",{className:"mobileDocumentName f1",onClick:this.onTapFiles},state.documentName),React.createElement(FancyButton,{icon:"icon-angle-right",color:"#777",iconSize:24,width:C.MobileBottomHeight,height:C.MobileBottomHeight,onClick:this.onTapFiles})))}});return ReactMobileOverview}),define("ReactMessagePreview",["require","exports","module","globals","Constants","platform","react","MooReact","International","EmailPreview","Sel","ReactMessageAttachments","Components/DivX","Components/FancyButton"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),International=require("International"),EmailPreview=require("EmailPreview"),Sel=require("Sel"),ReactMessageAttachments=require("ReactMessageAttachments"),DivX=require("Components/DivX"),FancyButton=require("Components/FancyButton"),ReactMessagePreview=MooReact.createClass({displayName:"ReactMessagePreview",propTypes:{threadAttach:React.PropTypes.object.isRequired,message:React.PropTypes.object.isRequired},init:function init(){this._initializedFrame=!1,this.createObservables({hovered:!1})},componentDidMount:function componentDidMount(){this.props.isLastMessage&&this.props.index>0&&(this.needsScrollIntoView=!0),this.checkIsHovered(),this._initializeFrame()},_forwardKeyEvent:function _forwardKeyEvent(e){platform.normalizeKeys(e),EmailPreview.getPane().keydown(e)},_initializeFrame:function _initializeFrame(){if(!this._initializedFrame&&this.refs.frame){this._initializedFrame=!0;var frameDoc=this.refs.frame.contentWindow.document;(platform.ie||platform.ieEdge)&&(frameDoc.open(),frameDoc.write(this.props.message.blob),frameDoc.close())}},getState:function getState(){return{responseMode:this.props.message.responseMode,height:this.props.message.height}},onAfterChanged:function onAfterChanged(state,oldState){this._initializeFrame(),state.height!==oldState.height&&state.height>0&&(this.checkIsHovered(),this.needsScrollIntoView&&(this.needsScrollIntoView=!1,this.scrollIntoView()))},checkIsHovered:function checkIsHovered(){var mousePos=Sel.getMousePos(),hoveredElement=document.elementFromPoint(mousePos.x,mousePos.y);if(hoveredElement){var messageParent=g.findParent(hoveredElement,"emailMessageWrapper");messageParent===this.refs.message&&this.hovered.set(!0)}},scrollIntoView:function scrollIntoView(){var element=this.refs.message,scrollView=g.findParent(element,platform.mobile?"fancyScroller":"fancyScrollContent"),y=0;y=element.clientHeight>scrollView.clientHeight?element.offsetTop:scrollView.scrollHeight-scrollView.clientHeight,g.scrollTo(0,y,ScrollDuration.Snap,scrollView)},onClickHeader:function onClickHeader(e){this.props.toggleExpanded()},onMouseEnterMessage:function onMouseEnterMessage(){this.hovered.set(!0)},onMouseLeaveMessage:function onMouseLeaveMessage(){this.hovered.set(!1)},onClickReply:function onClickReply(e){EmailPreview.setMessageResponseMode(this.props.message.id,C.EmailResponseMode.Reply),e.stopPropagation()},onClickReplyAll:function onClickReplyAll(e){EmailPreview.setMessageResponseMode(this.props.message.id,C.EmailResponseMode.ReplyAll),e.stopPropagation()},onClickForward:function onClickForward(e){EmailPreview.setMessageResponseMode(this.props.message.id,C.EmailResponseMode.Forward),e.stopPropagation()},onClickReport:function onClickReport(){g.menus.openModal(Modals.ReportProblem,{accountID:this.props.threadAttach.getField("accountID"),threadID:this.props.threadAttach.id,msgID:this.props.message.id})},_generateParticipantText:function _generateParticipantText(participant){return participant.text?participant.text:participant.email},_generateParticipantTextExpanded:function _generateParticipantTextExpanded(participant){return participant.text?participant.text+" <"+participant.email+">":participant.email},isExpanded:function isExpanded(){return this.props.expanded||this.props.isLastMessage||this.state.responseMode!==C.EmailResponseMode.None},render:function render(){var props=this.props,state=this.state,message=props.message,header,fromSnippet,isExpanded=this.isExpanded(),styleFrame={height:state.height},dateStr=message.date.toString(International.getFormat(DFormat.MonthDay)),timeStr=message.date.toString(International.getFormat(DFormat.ShortTime)),showPlaceholder=props.isLastMessage||!platform.mobile&&state.responseMode!==C.EmailResponseMode.None,showHeaderButtons=!platform.mobile||isExpanded,styleHeaderButtons={};platform.mobile||(styleHeaderButtons.opacity=state.hovered?"1":"0");var from,snippet;if(from=React.createElement("span",{className:"from","data-tooltip":this._generateParticipantTextExpanded(message.from)},this._generateParticipantText(message.from)),isExpanded){var recipients=(message.to?message.to:[]).concat(message.cc?message.cc:[]),toText=recipients.map(this._generateParticipantText).join(", "),toTextExpanded=recipients.map(this._generateParticipantTextExpanded).join("\n");snippet=React.createElement("span",{className:"to"},platform.mobile&&"To ",!platform.mobile&&React.createElement("i",{className:"icon-long-arrow-right"}),React.createElement("span",{"data-tooltip":toTextExpanded},toText))}else snippet=React.createElement("span",{className:"snippet",dangerouslySetInnerHTML:{__html:message.snippet}});var dateSpan=React.createElement("span",{className:"emailDate"},React.createElement("div",{className:"emailDateDate"},dateStr),React.createElement("div",{className:"emailDateTime"},timeStr)),replyIconSize=platform.mobile?22:16,replyButtonSize=platform.mobile?50:40;header=React.createElement(DivX,{className:"messageHeader flexbox collapsed",onClick:this.onClickHeader},React.createElement("span",{className:"messageHeaderText f1"},from,snippet,platform.mobile&&isExpanded&&dateSpan),showHeaderButtons&&React.createElement("span",{className:"headerButtons",style:styleHeaderButtons},platform.windowWidth()>1080&&!g.isDemoMode()&&React.createElement(FancyButton,{height:40,className:"reportEmail",onClick:this.onClickReport},"Report Problem"),React.createElement(FancyButton,{iconSize:replyIconSize,width:replyButtonSize,height:replyButtonSize,icon:"icon-reply",tooltip:"Reply",onClick:this.onClickReply}),React.createElement(FancyButton,{iconSize:replyIconSize,width:replyButtonSize,height:replyButtonSize,icon:"icon-reply-all",tooltip:"Reply All",onClick:this.onClickReplyAll}),React.createElement(FancyButton,{iconSize:replyIconSize,width:replyButtonSize,height:replyButtonSize,icon:"icon-forward",tooltip:"Forward",onClick:this.onClickForward})),!platform.mobile&&dateSpan);var iframe;iframe=platform.ie||platform.ieEdge?React.createElement("iframe",{key:"ep_"+this.props.message.id,ref:"frame",sandbox:"allow-scripts allow-same-origin",seamless:!0,id:"emailPreview_"+this.props.message.id,className:"emailPreviewFrame",style:styleFrame}):React.createElement("iframe",{key:"ep_"+this.props.message.id,ref:"frame",sandbox:"allow-scripts allow-same-origin",seamless:!0,id:"emailPreview_"+this.props.message.id,className:"emailPreviewFrame",src:message.blobURL,style:styleFrame,scrolling:"no"});var clsMsg=g.classNames("emailMessage emailBox",{collapsed:!isExpanded},{prevCollapsed:!props.prevExpanded},{nextCollapsed:!props.nextExpanded}),clsWrapper=g.classNames("emailMessageWrapper",{replying:state.responseMode!==C.EmailResponseMode.None});return React.createElement("div",{className:clsWrapper,onMouseEnter:this.onMouseEnterMessage,onMouseLeave:this.onMouseLeaveMessage,ref:"message"},React.createElement("div",{className:clsMsg},header,isExpanded&&React.createElement("div",{className:"messageContent"},iframe,React.createElement(ReactMessageAttachments,{threadAttach:props.threadAttach,message:props.message,editable:!1}))),showPlaceholder&&React.createElement("div",{className:"replyPlaceholder flexbox flex-center",ref:"placeholder"},React.createElement("div",{className:"replyPlaceholderInner"},React.createElement(FancyButton,{iconSize:replyIconSize,width:replyButtonSize,height:replyButtonSize,icon:"icon-reply",tooltip:"Reply",onClick:this.onClickReply,selected:state.responseMode===C.EmailResponseMode.Reply,padding:24}),React.createElement(FancyButton,{iconSize:replyIconSize,width:replyButtonSize,height:replyButtonSize,icon:"icon-reply-all",tooltip:"Reply All",onClick:this.onClickReplyAll,selected:state.responseMode===C.EmailResponseMode.ReplyAll,padding:24}),React.createElement(FancyButton,{iconSize:replyIconSize,width:replyButtonSize,height:replyButtonSize,icon:"icon-forward",tooltip:"Forward",onClick:this.onClickForward,selected:state.responseMode===C.EmailResponseMode.Forward,padding:24}))))}});return ReactMessagePreview}),define("ReactEmailReplyBox",["require","exports","module","globals","platform","Constants","react","MooReact","EmailPreview","ReactEmailCompose","Components/FancyInput","Components/FancyTextarea","Components/FancyButton"],function(require,exports,module){var g=require("globals"),platform=require("platform"),C=require("Constants"),React=require("react"),MooReact=require("MooReact"),EmailPreview=require("EmailPreview"),ReactEmailCompose=require("ReactEmailCompose"),FancyInput=require("Components/FancyInput"),FancyTextarea=require("Components/FancyTextarea"),FancyButton=require("Components/FancyButton"),ReactEmailReplyBox=MooReact.createClass({displayName:"ReactEmailReplyBox",propTypes:{threadAttach:React.PropTypes.object.isRequired,message:React.PropTypes.object.isRequired,inReplyToMessage:React.PropTypes.object.isRequired},componentDidUpdate:function componentDidUpdate(){this._updateFocus()},componentDidMount:function componentDidMount(){this.scrollIntoView(),this._updateFocus()},getState:function getState(){var replyMessage=this.props.inReplyToMessage;return{responseMode:replyMessage.responseMode,replytoMessageHeight:replyMessage.height}},onAfterChanged:function onAfterChanged(state,oldState){state.replytoMessageHeight!==oldState.replytoMessageHeight&&this.scrollIntoView()},scrollIntoView:function scrollIntoView(){var element=this.refs.message,scrollView=g.findParent(element,platform.mobile?"fancyScroller":"fancyScrollContent"),bottom=element.offsetTop+element.offsetHeight,y=bottom-scrollView.clientHeight+16;g.scrollTo(0,y,ScrollDuration.Default,scrollView)},_updateFocus:function _updateFocus(){var mode=this.state.responseMode;switch(mode){case C.EmailResponseMode.None:case C.EmailResponseMode.Reply:case C.EmailResponseMode.ReplyAll:this.focusBody();break;case C.EmailResponseMode.Forward:this.focusTo();break;default:try{g.PAssert(4917,!1,"Unknown response mode for reply box")}catch(PERR){g.reportError(PERR)}}},focusTo:function focusTo(){this.refs.compose.focusTo()},focusBody:function focusBody(){this.refs.compose.focusBody()},onClose:function onClose(){EmailPreview.setMessageResponseMode(this.props.inReplyToMessage.id,C.EmailResponseMode.None)},render:function render(){return React.createElement("div",{key:this.props.message.id,className:"emailReplyBox emailBox",ref:"message"},React.createElement(ReactEmailCompose,{threadAttach:this.props.threadAttach,message:this.props.message,ref:"compose",onClose:this.onClose,responseMode:this.state.responseMode,closeOnEscape:!0}))}});return ReactEmailReplyBox}),define("ReactEmailPreview",["require","exports","module","globals","Constants","platform","react","MooReact","EmailPreview","AccountManager","ReactMessagePreview","ReactEmailReplyBox","Components/FancyLoader","Components/FancyButton","Components/FancyScroller"],function(require,exports,module){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),EmailPreview=require("EmailPreview"),AccountManager=require("AccountManager"),ReactMessagePreview=require("ReactMessagePreview"),ReactEmailReplyBox=require("ReactEmailReplyBox"),FancyLoader=require("Components/FancyLoader"),FancyButton=require("Components/FancyButton"),FancyScroller=require("Components/FancyScroller"),PreviewWindowModes={Popup:"popup",Left:"left",Right:"right"},ReactEmailPreview=MooReact.createClass({displayName:"ReactEmailPreview",propTypes:{messages:React.PropTypes.array},init:function init(){this.listenToDispatcher("windowResize"),this.createObservables({expandedMessages:[]}),g.isDemoMode()&&(g.reactEmailPreview=this)},onBeforeChanged:function onBeforeChanged(state,oldState){if(state.thread!==oldState.thread){var messages=state.messages,expanded=[];if(messages.length>0){var lastMessageIndex=messages.length-1;this.isMessageDraft(messages[lastMessageIndex])&&lastMessageIndex--;for(var i=0;i<messages.length;i++){var m=messages[i];(i===lastMessageIndex||this.isMessageUnread(m))&&expanded.push(m.id)}}this.expandedMessages.set(expanded,!1),state.expandedMessages=expanded}},getState:function getState(){return{rect:this.props.pane.rect,pane:EmailPreview.openOnPane,isLoading:EmailPreview.isLoading,thread:EmailPreview.threadAttach,messages:EmailPreview.messages,errorMessage:EmailPreview.errorMessage,messagesLoaded:EmailPreview.messagesLoaded}},onEscapeKey:function onEscapeKey(){EmailPreview.close()},isMessageDraft:function isMessageDraft(message){return message.labelIds.indexOf("DRAFT")>=0},isMessageUnread:function isMessageUnread(message){return message.labelIds.indexOf("UNREAD")>=0},onClickClose:function onClickClose(){EmailPreview.close()},onClickArchive:function onClickArchive(){this.state.pane.archiveSelected(!0)},onClickLabel:function onClickLabel(e){this.state.pane.autocompleteLabel({elementDisplay:e.target})},onClickMove:function onClickMove(e){this.state.pane.autocompleteMove({elementDisplay:e.target})},onClickSchedule:function onClickSchedule(e){this.state.pane.autocompleteSchedule({elementDisplay:e.target})},onClickSnooze:function onClickSnooze(e){var accountID=this.state.thread.getField("accountID");this.state.pane.autocompleteSnooze({elementDisplay:e.target},accountID)},onClickUnread:function onClickUnread(e){this.state.pane.markReadSelected(!1)},onClickDelete:function onClickDelete(){var plugin=g.vmMain.getDefaultEmailPlugin();this.state.pane.deleteSelected(plugin.isGmailItem,!0)},onClickPrint:function onClickPrint(){var plugin=g.vmMain.getDefaultEmailPlugin(),printURL=plugin.createPrintURLForThread(this.state.thread);g.printPage(printURL)},toggleExpanded:function toggleExpanded(index){var messages=this.state.messages,m=messages[index];this.expandedMessages.indexOf(m.id)>=0?!(messages.length>1&&index<messages.length-1)||messages[index+1]&&this.isMessageDraft(messages[index+1])||this.expandedMessages.remove(m.id):this.expandedMessages.push(m.id)},render:function render(){var state=this.state,thread=state.thread,messages=state.messages||[],renderedContent=[];if(messages.length>0){var first=messages[0],subject=first.subject||"(no subject)",from=first.from.text||first.from.email,to=first.to.map(function(contact){return contact.text||contact.email}).join(", "),hasLastDraft=!1,lastMessage=messages[messages.length-1],lastMessageIndex=messages.length-1,renderedMessages=[];this.isMessageDraft(lastMessage)&&!thread.getPlugin().getAttachField(thread,"pendingSend")&&(hasLastDraft=!0,lastMessageIndex--);for(var expMes=this.expandedMessages.get(),i=0;i<messages.length;++i){var message=messages[i],reactMessage,isDraftMessage=this.isMessageDraft(message);if(isDraftMessage){try{g.PAssert(4918,i>0,"Should never have a draft as the first message in the list")}catch(PERR){g.reportError(PERR)}var inReplyToMessage=messages[i-1];reactMessage=platform.mobile?null:React.createElement(ReactEmailReplyBox,{key:inReplyToMessage.id+"_draft",threadAttach:thread,message:message,inReplyToMessage:inReplyToMessage})}else{var isExpanded=expMes.indexOf(message.id)>=0,mPrev=messages[i-1],mNext=messages[i+1],prevExpanded=0===i||expMes.indexOf(mPrev.id)>=0||this.isMessageDraft(mPrev),nextExpanded=i>=messages.length-2||expMes.indexOf(mNext.id)>=0||this.isMessageDraft(mNext);reactMessage=React.createElement(ReactMessagePreview,{key:message.id,index:i,threadAttach:thread,message:message,toggleExpanded:this.toggleExpanded.bind(this,i),expanded:isExpanded,isLastMessage:i===lastMessageIndex,prevExpanded:prevExpanded,nextExpanded:nextExpanded})}renderedMessages.push(reactMessage)}renderedContent=React.createElement("div",{className:"emailMessages",style:{opacity:state.messagesLoaded?1:0}},renderedMessages)}else renderedContent=state.isLoading?React.createElement(FancyLoader,{center:!0},"Loading messages..."):state.errorMessage?React.createElement("div",{className:"noMessages center"},state.errorMessage):React.createElement("div",{className:"noMessages center"},"No conversation selected");var cls=g.classNames("emailPreview"),style={};platform.mobile||(style.width=platform.emailPreviewSize(),style[platform.transform.react]="translate("+(state.rect.left+g.minPaneWidth)+"px,0)");var buttons;return state.pane&&state.pane.type===PaneMode.Gmail&&(buttons=[React.createElement(FancyButton,{key:"archive",icon:"icon-ok",iconSize:16,width:40,height:40,tooltip:"Archive (E)",onClick:this.onClickArchive}),React.createElement(FancyButton,{key:"snooze",icon:"icon-access_time",iconSize:17,width:40,height:40,tooltip:"Snooze (D)",onClick:this.onClickSnooze}),React.createElement(FancyButton,{key:"unread",icon:"icon-envelope",iconSize:15,width:40,height:40,tooltip:"Mark Unread (U)",onClick:this.onClickUnread}),React.createElement(FancyButton,{key:"label",icon:"icon-tag",iconSize:15,width:40,height:40,tooltip:"Label (L)",onClick:this.onClickLabel}),React.createElement(FancyButton,{key:"move",icon:"icon-list",iconSize:13,width:40,height:40,tooltip:"Move to Outline (M)",onClick:this.onClickMove}),React.createElement(FancyButton,{key:"schedule",icon:"icon-calendar",iconSize:15,width:40,height:40,tooltip:"Move to Calendar (C)",onClick:this.onClickSchedule}),React.createElement(FancyButton,{key:"delete",icon:"icon-trash",iconSize:18,width:40,height:40,tooltip:"Delete (Backspace)",onClick:this.onClickDelete}),platform.app?null:React.createElement(FancyButton,{key:"print",icon:"icon-print",iconSize:18,width:40,height:40,tooltip:"Print",onClick:this.onClickPrint})]),React.createElement("div",{className:cls,style:style},React.createElement("div",{className:"emailPreviewTop"},React.createElement("div",{className:"emailHeaderRow"},platform.mobile&&React.createElement("div",{className:"emailSubject"},subject),buttons),!platform.mobile&&React.createElement("div",{className:"emailHeaderRow emailSubject"},subject),React.createElement(FancyButton,{className:"closeButton",icon:"icon-close",iconSize:20,width:44,height:44,onClick:this.onClickClose,tooltip:"Close"})),React.createElement(FancyScroller,{className:"emailMessagesScroller",trackHasScrolled:!0},renderedContent))}});return ReactEmailPreview}),define("ReactToasts",["require","exports","module","globals","react","MooReact","Toasts"],function(require,exports,module){var g=require("globals"),React=require("react"),ReactCSSTransitionGroup=React.addons.CSSTransitionGroup,MooReact=require("MooReact"),Toasts=require("Toasts"),ReactToasts=MooReact.createClass({displayName:"ReactToasts",getState:function getState(){return{toasts:Toasts.queue}},render:function render(){for(var state=this.state,toasts=[],i=0;i<state.toasts.length;i++){var m=state.toasts[i],cls=g.classNames("toast noSelect",{hasAction:!!m.actionText},{big:m.isBig});toasts.push(React.createElement("div",{key:m.id,className:cls,onClick:m.onTapIgnore.bind(m)},React.createElement("span",{className:"messageText",dangerouslySetInnerHTML:{__html:m.text}}),React.createElement("span",{className:"messageAction",dangerouslySetInnerHTML:{__html:m.actionText},onClick:m.doAction.bind(m)})))}return React.createElement(ReactCSSTransitionGroup,{id:"toasts",transitionName:"reactFade",transitionEnterTimeout:800,transitionLeaveTimeout:100},toasts)}});return ReactToasts}),define("ReactDemoUI",["require","exports","module","globals","react","MooReact"],function(require,exports,module){var g=require("globals"),React=require("react"),MooReact=require("MooReact"),ReactDemoUI=MooReact.createClass({displayName:"ReactDemoUI",init:function init(){console.log("init")},getState:function getState(){return{caption:g.AScript.demoCaption}},render:function render(){var state=this.state,caption=state.caption;if(void 0!==caption){var cls=g.classNames("demoCaption",{center:caption.center},{light:caption.light});return React.createElement("div",{className:cls,style:{opacity:caption.opacity}},React.createElement("div",{className:"demoCaptionText",dangerouslySetInnerHTML:{__html:caption.text}}))}return null}});return ReactDemoUI}),define("ReactMobileKeyboardToolbar",["require","globals","Constants","platform","react","MooReact","tracker","android","Sel","KeyboardToolbar","Components/FancyButton"],function(require){var g=require("globals"),C=require("Constants"),platform=require("platform"),React=require("react"),MooReact=require("MooReact"),tracker=require("tracker"),android=require("android"),Sel=require("Sel"),KeyboardToolbar=require("KeyboardToolbar"),FancyButton=require("Components/FancyButton"),ReactMobileKeyboardToolbar=MooReact.createClass({displayName:"ReactMobileKeyboardToolbar",init:function init(){this.createObservables({isPriorityVisible:!1})},getState:function getState(){var KT=KeyboardToolbar,state={panes:g.vmMain.paneManager.displayPanes,position:KT.bottomPosition,mode:KT.mode};return state.pane=state.panes.get()[0].pane,state},insertCharacter:function insertCharacter(character,withSpace){if(!g.menus.isContextMenuOpen()){var text,prevChar;android.isEnabled()?(text=android.getInputText(),prevChar=text[android.getSelectionStart()-1],withSpace&&" "!==prevChar&&0!==android.getSelectionStart()?android.insertText(android.getSelectionStart()," "+character):android.insertText(android.getSelectionStart(),character)):Sel.isValid()&&(text=Sel.getStartItem().getRawText(),prevChar=text[Sel.getStartOffset()-1],withSpace&&" "!==prevChar&&0!==Sel.getStartOffset()&&g.fireKeyEvent(void 0,{normCode:KeyCode.Space}),g.fireKeyEvent(void 0,{normCode:character.charCodeAt(0)}))}},fireKey:function fireKey(character,params,paramsPressed,withSpace){if(!g.menus.isContextMenuOpen()){var text;if(android.isEnabled())this.insertCharacter(character,withSpace);else if(Sel.isValid()){text=Sel.getStartItem().getRawText();var prevChar=text[Sel.getStartOffset()-1];withSpace&&" "!==prevChar&&0!==Sel.getStartOffset()&&g.fireKeyEvent(void 0,{normCode:KeyCode.Space}),g.fireKeyEvent(void 0,params,paramsPressed)}}},onClickOutdent:function onClickOutdent(){g.menus.isContextMenuOpen()||g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0})},onClickIndent:function onClickIndent(){g.menus.isContextMenuOpen()||g.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1})},onClickOpenPriority:function onClickOpenPriority(){this.state.mode===C.KeyboardToolbarMode.Search?g.getActiveSearch().addToValue("!"):this.isPriorityVisible.set(!this.isPriorityVisible.get())},onClickNote:function onClickNote(){var item;tracker.beginAction(),android.isEnabled()?item=android.getCurrentVMLI():Sel.isValid()&&(item=Sel.getStartItem()),platform.ios&&g.menus.isContextMenuOpen()&&g.focusedPane.closeNoteContextMenu(),item&&((item.hasNote()||item.isNote())&&g.menus.isContextMenuOpen()?g.menus.closeContextMenuReact():android.isEnabled()&&android.finishInput(!0),item.editNote()),tracker.endAction()},onClickDate:function onClickDate(){this.state.mode===C.KeyboardToolbarMode.Search?g.getActiveSearch().addToValue(DatePrefix):(this.insertCharacter(DatePrefix,!0),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.AtButton}))},onClickContact:function onClickContact(){this.state.mode===C.KeyboardToolbarMode.Search?g.getActiveSearch().addToValue(ContactPrefix):this.insertCharacter(ContactPrefix,!0)},onClickTag:function onClickTag(){this.state.mode===C.KeyboardToolbarMode.Search?g.getActiveSearch().addToValue(TagPrefix):this.fireKey(TagPrefix,{normCode:KeyCode.D3,shiftKey:!0},{normCode:TagPrefix.charCodeAt(0)},!0)},onClickClose:function onClickClose(){g.closeKeyboard()},onClickPNone:function onClickPNone(){this.state.pane.applyPriorityToSelection(VMLIFlag.None,!0)},onClickP0:function onClickP0(){this.state.pane.applyPriorityToSelection(VMLIFlag.P0,!0)},onClickP1:function onClickP1(){this.state.pane.applyPriorityToSelection(VMLIFlag.P1,!0)},onClickP2:function onClickP2(){this.state.pane.applyPriorityToSelection(VMLIFlag.P2,!0)},onClickStar:function onClickStar(){g.vmMain.applyFnToSelection("isStarred",{toggle:!0,value2:ChangeType.Local})},openMobileFilterMenu:function openMobileFilterMenu(){g.menus.openContextMenuReact({componentName:"ReactContextMenuMobileFilter",position:"top-right",pane:g.focusedPane})},render:function render(){var state=this.state,mode=state.mode,Modes=C.KeyboardToolbarMode,pane=this.state.pane,style={bottom:state.position},buttons=mode!==Modes.Modal?React.createElement("div",{id:"mobileToolbarButtons",className:"flexbox"},React.createElement("div",{className:"toolbarButtonsLeft"},mode===Modes.Item&&pane.type===PaneMode.Outline&&React.createElement(FancyButton,{icon:"icon-double-angle-left",width:40,height:40,iconSize:26,onClick:this.onClickOutdent}),mode===Modes.Item&&pane.type===PaneMode.Outline&&React.createElement(FancyButton,{icon:"icon-double-angle-right",width:40,height:40,iconSize:26,onClick:this.onClickIndent}),mode===Modes.Search&&React.createElement(FancyButton,{icon:"icon-filter",width:40,height:40,iconSize:16,onClick:this.openMobileFilterMenu})),React.createElement("div",{className:"f1"}),React.createElement("div",{className:"toolbarButtonsRight"},mode!==Modes.Search&&React.createElement(FancyButton,{icon:"icon-sticky-note-o",width:40,height:40,iconSize:22,onClick:this.onClickNote}),React.createElement(FancyButton,{icon:"icon-calendar",width:40,height:40,iconSize:22,onClick:this.onClickDate}),React.createElement(FancyButton,{icon:"icon-user",width:40,height:40,iconSize:26,onClick:this.onClickContact}),React.createElement(FancyButton,{className:"tagIcon",width:40,height:40,onClick:this.onClickTag},"#"),mode!==Modes.Search&&React.createElement(FancyButton,{className:"exclamationIcon",width:40,height:40,onClick:this.onClickOpenPriority},"!"),!platform.ipad&&React.createElement(FancyButton,{icon:"icon-angle-down",width:40,height:40,iconSize:26,onClick:this.onClickClose}))):React.createElement("div",{id:"mobileToolbarButtons",className:"flexbox"},React.createElement("div",{className:"f1"}),React.createElement(FancyButton,{icon:"icon-angle-down",width:40,height:40,iconSize:26,onClick:this.onClickClose}));return!(mode===Modes.Modal&&platform.ipad)&&React.createElement("div",{id:"mobileKeyboardToolbar",style:style},state.isPriorityVisible&&React.createElement("div",{id:"priorityMenu"},React.createElement(FancyButton,{icon:"icon-close",width:40,height:40,iconSize:22,onClick:this.onClickPNone}),React.createElement(FancyButton,{className:"priorityButton",width:40,height:40,onClick:this.onClickP2},React.createElement("div",{className:"p2Button"})),React.createElement(FancyButton,{className:"priorityButton",width:40,height:40,onClick:this.onClickP1},React.createElement("div",{className:"p1Button"})),React.createElement(FancyButton,{className:"priorityButton",width:40,height:40,onClick:this.onClickP0},React.createElement("div",{className:"p0Button"})),React.createElement(FancyButton,{icon:"icon-star",width:40,height:40,iconSize:22,onClick:this.onClickStar})),buttons)}});return ReactMobileKeyboardToolbar}),define("ReactMain",["require","exports","module","globals","platform","Constants","react","MooReact","Sel","DragDrop","KeyboardToolbar","ReactPaneList","ReactPaneAgenda","plugins/ReactPaneGmail","ReactDragDrop","ReactContextMenus","ReactModals","ReactDisplaySettingsSidebar","ReactDesktopMenu","ReactEmailComposes","ReactIntro","ReactMobileOverview","ReactOverview","ReactEmailPreview","ReactToasts","ReactDemoUI","ReactMobileKeyboardToolbar","Components/FancyInput"],function(require,exports,module){var g=require("globals"),platform=require("platform"),C=require("Constants"),React=require("react"),ReactCSSTransitionGroup=React.addons.CSSTransitionGroup,MooReact=require("MooReact"),Sel=require("Sel"),DragDrop=require("DragDrop"),KeyboardToolbar=require("KeyboardToolbar"),ReactPaneList=require("ReactPaneList"),ReactPaneAgenda=require("ReactPaneAgenda"),ReactPaneGmail=require("plugins/ReactPaneGmail"),ReactDragDrop=require("ReactDragDrop"),ReactContextMenus=require("ReactContextMenus"),ReactModals=require("ReactModals"),ReactDisplaySettingsSidebar=require("ReactDisplaySettingsSidebar"),ReactDesktopMenu=require("ReactDesktopMenu"),ReactEmailComposes=require("ReactEmailComposes"),ReactIntro=require("ReactIntro"),ReactMobileOverview=require("ReactMobileOverview"),ReactOverview=require("ReactOverview"),ReactEmailPreview=require("ReactEmailPreview"),ReactToasts=require("ReactToasts"),ReactDemoUI=require("ReactDemoUI"),ReactMobileKeyboardToolbar=require("ReactMobileKeyboardToolbar"),FancyInput=require("Components/FancyInput"),ReactMain=MooReact.createClass({displayName:"ReactMain",propTypes:{main:React.PropTypes.object.isRequired},componentDidMount:function componentDidMount(){this.setPanesContainer(),document.addEventListener("keydown",this.keydown),document.addEventListener("keypress",this.keypress),document.addEventListener("keyup",this.keyup),this.listenToDispatcher("panesChanged",[])
},componentDidUpdate:function componentDidUpdate(prevProps,prevState){this.setPanesContainer()},setPanesContainer:function setPanesContainer(){var main=this.props.main;main.panesContainer||(main.panesContainer=this.refs.panes)},_isOkToSendKey:function _isOkToSendKey(e){return!(e.defaultPrevented||!Sel.getPane()||g.menus.isContextMenuOpen()||g.menus.isModalOpen()||g.vmMain.isFullscreenClickHandled()&&!e.synthetic||this.props.main.activeInput.get())},keydown:function keydown(e){return this._isOkToSendKey(e)&&Sel.getPane().keydown(e),e.target===document.body&&e.normCode===KeyCode.BackSpace?(e.handled=!0,e.preventDefault(),!1):void 0},keypress:function keypress(e){this._isOkToSendKey(e)&&Sel.getPane().keypress(e)},keyup:function keyup(e){this._isOkToSendKey(e)&&Sel.getPane().keyup(e)},getState:function getState(){var main=this.props.main,state={panes:main.paneManager.displayPanes,failedInitialDocLoad:main.failedInitialDocLoad,isHelpShowing:!platform.mobile&&g.intro.isVisible,isWindowFocused:Sel.isWindowFocused,isDragging:DragDrop.isVisible,isDraggingPane:DragDrop.isDraggingPane,isLoading:0===main.paneManager._panes.get().length,isKeyboardOpen:KeyboardToolbar.isVisible};return state},render:function render(){for(var state=this.state,panes=[],i=0;i<state.panes.length;++i){var paneInfo=state.panes[i],type=paneInfo.type,pane=paneInfo.pane;if("overview"===type)panes.push(platform.mobile?React.createElement(ReactMobileOverview,{key:"overview"+pane.id,pane:pane}):React.createElement(ReactOverview,{key:"overview"+pane.id,pane:pane}));else if("pane"===type)switch(pane.type){case PaneMode.Timeline:panes.push(React.createElement(ReactPaneAgenda,{key:"pane"+pane.id,pane:pane}));break;case PaneMode.Archived:case PaneMode.Outline:case PaneMode.Drive:panes.push(React.createElement(ReactPaneList,{key:"pane"+pane.id,pane:pane}));break;case PaneMode.Gmail:panes.push(React.createElement(ReactPaneGmail,{key:"pane"+pane.id,pane:pane}));break;default:try{g.PAssert(4919,!1,"Invalid pane mode requested"+pane.type)}catch(PERR){g.reportError(PERR)}}else"emailPreview"===type&&panes.push(React.createElement(ReactEmailPreview,{key:"emailPreview"+pane.id,pane:pane}))}var cls=g.classNames("renderedContent",{windowBlurred:!state.isWindowFocused},{draggingItems:!!state.isDragging||state.isDraggingPane},{draggingPane:state.isDraggingPane}),loading,renderedContent;if(!state.isLoading||g.isDemoMode()||state.failedInitialDocLoad){var panesContainer=platform.mobile?React.createElement(ReactCSSTransitionGroup,{className:"panes",ref:"panes","data-moo-id":"panes",transitionName:"reactMobilePaneAnim",transitionEnterTimeout:C.EmailOpenTimeMobile,transitionLeaveTimeout:C.EmailOpenTimeMobile},panes):React.createElement("div",{className:"panes",ref:"panes","data-moo-id":"panes"},panes,state.isHelpShowing&&React.createElement(ReactIntro,null));renderedContent=React.createElement("div",{key:"renderedContent",className:cls},!platform.mobile&&React.createElement(ReactDesktopMenu,{main:this.props.main}),panesContainer,!platform.mobile&&this.props.main.getDefaultEmailPlugin()&&React.createElement(ReactEmailComposes,null),React.createElement(ReactDragDrop,null),React.createElement(ReactModals,null),React.createElement(ReactDisplaySettingsSidebar,null),React.createElement(ReactContextMenus,null),React.createElement(ReactToasts,null),g.isDemoInIframe()&&React.createElement(ReactDemoUI,null),state.isKeyboardOpen&&React.createElement(ReactMobileKeyboardToolbar,null))}else loading=React.createElement("div",{key:"loadingRemote",id:"loadingRemote",className:"centerVH"},React.createElement("div",{className:"loading loading20"}),React.createElement("div",{className:"loadingText"},"Loading document"));return React.createElement(ReactCSSTransitionGroup,{transitionName:"reactFadeMain",transitionEnterTimeout:800,transitionLeaveTimeout:100},renderedContent,loading)}});return ReactMain}),define("VMMain",["ko","globals","Constants","Dispatcher","util","android","CacheManager","data","gdata","goog","edit","copypaste","VMLI","tracker","platform","VMPane","PaneFactory","VMMenus","VMSettings","VMPicker","KeyboardToolbar","Intro","Toasts","International","VMPluginManager","PaneManager","RealtimeDocManager","RecurringTaskManager","DeferredTaskManager","DocManager","ItemStoreManager","react","react-dom","ReactMain","Measure","NativeSel","Sel","DragDrop","Observable","AccountManager"],function(ko,g,C,Dispatcher,util,android,CacheManager,d,gdata,goog,edit,copypaste,VMLI,tracker,platform,VMPane,PaneFactory,VMMenus,VMSettings,VMPicker,KeyboardToolbar,Intro,Toasts,International,VMPluginManager,PaneManager,RealtimeDocManager,RecurringTaskManager,DeferredTaskManager,DocManager,ItemStoreManager,React,ReactDOM,ReactMain,Measure,NativeSel,Sel,DragDrop,Observable,AccountManager){var VMMain=function(){function runRemoteLoad(rootItem){g.isLoadingRemote=!0;try{d.beginTransaction();var lastServerVersion=g.settings.get(Settings.lastServerVersion),currentServerVersion=gdata.getServerVersion();lastServerVersion===currentServerVersion&&log("Client and Server Versions Match!"),g.startTimeEvent("PageLoad","RemoteData","Load Remote Data"),tracker.beginAction(!0);var previousLocalIntegrity=g.settings.get(Settings.localIntegrity);previousLocalIntegrity===!1&&(ShouldLog(LogLevels.Warning)&&log("Previous remote sync had an issue!"),g.reportError(new Error("Previous remote sync had an issue!"))),gdata.loadSeen={},self.beginQueuedParseItems(ChangeType.Remote|ChangeType.All),g.settings.set(Settings.localIntegrity,!1),self.root().initFromGDrive(rootItem),g.settings.set(Settings.localIntegrity,!0),gdata.loadSeen={},tracker.endAction(),ShouldLog(LogLevels.Timing)&&log("Drive done init",log.now()),self.flushParseItems(),self.flushModifiedItems(),log("Pending Updates: "+Object.keys(d.pendingRemoteUpdates).length),g.endTimeEvent(),Dispatcher.fireEvent("remoteDataLoaded",[])}catch(err){g.reportError(err),g.toasts.pushMessage({text:"There was an error loading your data from the server. Please try again.",action:MessageAction.Reload})}finally{d.endTransaction(),g.isLoadingRemote=!1}}function setupPageVisibility(){function handleVisibilityChange(){platform.isPageVisible()?(updateTimeout&&(clearTimeout(updateTimeout),updateTimeout=void 0),self.whenLowImpactEnd()):updateTimeout=setTimeout(function(){g.AppCache.checkForUpdate(!1,!0),g.vmMain.pluginManager.writeCaches(),self.whenLowImpactBegin()},5e3)}function checkActivity(){Date.now()>self.lastActivity+g.minutes(90)&&g.AppCache.checkForUpdate(!1,!0),activityTimeout=setTimeout(checkActivity,g.minutes(90))}platform.pageVisibilityChange&&document.addEventListener(platform.pageVisibilityChange,handleVisibilityChange),platform.mobile||(activityTimeout=setTimeout(checkActivity,g.minutes(90)))}function checkItemsUpdated(){self._numTimesItemsUpdated>1&&(console.log("Perf Warning: Pane items were updated "+self._numTimesItemsUpdated+" times in a single sync block."),EnableItemFlushStacks&&(window.__LastFlushStacks=itemFlushStacks,console.log("Update Stacks: ",itemFlushStacks))),self._itemsUpdateTimeout=void 0,self._numTimesItemsUpdated=0,EnableItemFlushStacks&&(itemFlushStacks=[])}function notifyItemsUpdated(){self._numTimesItemsUpdated++,EnableItemFlushStacks&&itemFlushStacks.push(g.getCurrentStack("Update Items Stack")),self._itemsUpdateTimeout||(self._itemsUpdateTimeout=setTimeout(checkItemsUpdated,0))}function updateWatchdog(){log("Last Update Items Stack: "+self._lastUpdateItemsStack);try{g.PAssert(5e3,!1,"Update Watchdog Triggered - This should never happen.",self._isWaitingUpdateItems)}catch(PERR){g.reportError(PERR)}self._isWaitingUpdateItems=1,self.commitUpdateItems()}var self={root:ko.observable(void 0),isLoaded:!1,isRendered:!1,_hasDisplayedArchivedItems:!1,gdriveStatusObs:new Observable(-1),isPhone:platform.phone,vmSettings:void 0,help:void 0,lastActivity:Date.now(),cacheManager:CacheManager,recurringTaskManager:new RecurringTaskManager,deferredTaskManager:new DeferredTaskManager,itemStoreManager:new ItemStoreManager,pluginManager:new VMPluginManager,paneManager:new PaneManager,paneFactory:PaneFactory,docManager:new DocManager,realtimeDocManager:new RealtimeDocManager,vmPicker:new VMPicker,_itemAnimationMode:C.ItemAnimationMode.Normal,isDisplaySettingsOpen:new Observable(!1),failedInitialDocLoad:new Observable(!1),activeInput:new Observable(null)};g.vmMain=self,self.remoteAPI=function remoteAPIFn(){return self.pluginManager.getPlugin(PluginID.Moodo)},self.loadPlugins=function loadPluginsFn(){var debugPlugin},self.getDefaultCalendarPlugin=function getDefaultCalendarPluginFn(){var defaultPlugin,calendarPlugin=self.pluginManager.getPlugin(PluginID.GCalendar);return calendarPlugin.getSetting(calendarPlugin.Settings.IsEnabled)&&(defaultPlugin=calendarPlugin),defaultPlugin},self.notifyFailedLoad=function notifyFailedLoadFn(){hasLoadedRemoteData||self.failedInitialDocLoad.set(!0)},self.notifySuccessfulLoad=function notifySuccessfulLoadFn(){self.failedInitialDocLoad.set(!1),util.hasURLParam("sinfo")&&util.removeURLParam("sinfo")},self.getDefaultEmailPlugin=function getDefaultEmailPluginFn(){return self.pluginManager.getPlugin(PluginID.Gmail)},g.vmSettings=self.vmSettings=new VMSettings(this),self.isOnline=function isOnlineFn(){return self.gdriveStatus()!==DriveStatus.Offline},self.isReconnecting=function isReconnectingFn(){return self.gdriveStatus()===DriveStatus.Reconnecting},self.isLocal=function isLocalFn(){return"localhost"===window.location.hostname},self.getUserEmail=function getUserEmailFn(){return g.getUserIdentifier()},self.getUserName=function getUserNameFn(){var user=gdata.authenticatedUser();return user?user.displayName:g.settings.get(Settings.displayName)||void 0},self.getUserImage=function getUserImageFn(){var user=gdata.authenticatedUser();return user?user.photoUrl:void 0},self.isDemoMode=function isDemoModeFn(){return g.isDemoMode()},window.addEventListener("scriptLoadError",function(e){self.handleScriptLoadError(e)}),self.handleScriptLoadError=function handleScriptLoadErrorFn(e){"gapiScript"===e.data.id&&(log("Failed to load GAPI!"),self.setGDriveStatus(DriveStatus.Offline),self.failedGapiLoad=!0,setTimeout(goog.goOnline,3e4))};var connectTimeout;self.connectFailed=function connectFailedFn(){self.setGDriveStatus(DriveStatus.Offline),connectTimeout=void 0,goog.ensureDocConnection()},self.gdriveStatus=function gdriveStatusFn(){return self.gdriveStatusObs.get()},self.setGDriveStatus=function setGDriveStatusFn(status){var prevStatus=self.gdriveStatus();status!==prevStatus&&status!==DriveStatus.Saving&&(self.gdriveStatusObs.set(status),status===DriveStatus.Connecting||status===DriveStatus.Reconnecting?gdata.loadedOnce&&(clearTimeout(connectTimeout),connectTimeout=setTimeout(self.connectFailed,gdata.offlineTimeoutMS)):(clearTimeout(connectTimeout),connectTimeout=void 0),status===DriveStatus.Offline?g.goOffline():prevStatus===DriveStatus.Offline&&g.goOnline())},self.init=function initFn(){g.settings._ensureRemoteSettings(),copypaste.init(),self.loadPlugins(),platform.mobile||g.intro.init(),Dispatcher.fireEvent("VMMainLoaded",[]),Dispatcher.listen("showArchived",function(){self._hasDisplayedArchivedItems||(self._hasDisplayedArchivedItems=!0,self.parseSubtreeArchive(self.root(),ChangeType.Auto))})},self.hasDisplayedArchivedItems=function hasDisplayedArchivedItemsFn(){return self._hasDisplayedArchivedItems},self.addModifiedItem=function addModifiedItemFn(item,changeType,changes){};var parseItems={},queueingParseItems=!1,queuedParseChangeType=void 0;self.flushModifiedItems=function flushModifiedItemsFn(){},self.addParseItem=function addParseItemFn(item,changeType){try{g.PAssert(4920,queueingParseItems,"Must be marked as queueing items")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4921,changeType===queuedParseChangeType,"ChangeType of queue must match")}catch(PERR){g.reportError(PERR)}parseItems[item.id]=item},self.beginQueuedParseItems=function beginQueuedParseItemsFn(changeType){try{g.PAssert(4922,!queueingParseItems,"Should not be already queueing parse items")}catch(PERR){g.reportError(PERR)}queueingParseItems||(queueingParseItems=!0,queuedParseChangeType=changeType)},self.flushParseItems=function flushParseItemsFn(){try{g.PAssert(4923,queueingParseItems,"Must be marked as queueing items before flushing")}catch(PERR){g.reportError(PERR)}if(queueingParseItems){queueingParseItems=!1;try{for(var id in parseItems){var item=parseItems[id];self.runSingleParse(item,queuedParseChangeType)}}catch(err){g.reportError(err)}parseItems={},queuedParseChangeType=void 0}},self.runParseWorkerNewContacts=function runParseWorkerNewContactsFn(){self.root()&&self.parseWorkerNewContactsHelper(self.root(),ChangeType.Auto)},self.parseWorkerNewContactsHelper=function parseWorkerNewContactsHelperFn(item,changeType){try{g.PAssert(4924,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}var rawText=item.getRawText();rawText.indexOf(ContactPrefix)>=0&&self.runSingleParse(item,changeType);for(var items=item.getItems(),i=0;i<items.length;i++)self.parseWorkerNewContactsHelper(items[i],changeType)},self.parseSubtree=function parseSubtreeFn(item,changeType){try{g.PAssert(4927,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}self.runSingleParse(item,changeType);for(var items=item.getItems(),i=0;i<items.length;i++)self.parseSubtree(items[i],changeType)},self.parseSubtreeArchive=function parseSubtreeArchiveFn(item,changeType){try{g.PAssert(4928,item,"Must supply a valid item to parse")}catch(PERR){g.reportError(PERR)}self.runSingleParse(item,changeType);for(var items=item.getItems(),i=0;i<items.length;i++)self.parseSubtreeArchive(items[i],changeType);if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;i++)self.parseSubtreeArchive(archivedItems[i],changeType)},self.runFnOnSubtree=function runFnOnSubtreeFn(item,fn){fn(item);for(var items=item.getItems(),i=0;i<items.length;i++)self.runFnOnSubtree(items[i],fn);if(item.hasArchivedChildren())for(var archivedItems=item.archivedItems(!0),i=0;i<archivedItems.length;i++)self.runFnOnSubtree(archivedItems[i],fn)},self.runSingleParse=function runSingleParseFn(item,changeType){try{g.PAssert(4935,item,"Must have a valid item to parse")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4936,!queueingParseItems,"Should not run single parse while queueing item parses")}catch(PERR){g.reportError(PERR)}var changedStyles={};item.parseText(!0,changeType,changedStyles)&&item.save(changedStyles,SaveFlag.None)},self.createWorkerFromObj=function createWorkerFromObjFn(obj,cb,cbErr){var worker;try{worker=new Worker(obj),worker.onmessage=cb,worker.onerror=cbErr}catch(err){g.reportError(err)}return worker},self.createWorkerFromFnList=function createWorkerFromFnListFn(fns,cb,cbErr){try{g.PAssert(4941,!platform.ie,"IE does not support creating workers from blob URLs")}catch(PERR){g.reportError(PERR)}var workerSource=[];try{for(var i=0;i<fns.length;++i)workerSource.push(window[fns[i]].toString()),workerSource.push(fns[i]+"();")}catch(err){g.reportError(err)}return self.createWorkerFromStrings(workerSource,cb,cbErr)},self.createWorkerFromStrings=function createWorkerFromStringsFn(strArr,cb,cbErr){var workerBlob=platform.URL.createObjectURL(new Blob(strArr,{type:"text/javascript"}));return self.createWorkerFromObj(workerBlob,cb,cbErr)};var lastDateRollover=0;self.setupDateRollover=function setupDateRolloverFn(){var currentTime=new Date,nextRolloverTime=currentTime.clone().addDays(1).clearTime();try{g.PAssert(4942,nextRolloverTime>currentTime,"Rollover time must be in the future")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4943,nextRolloverTime>lastDateRollover,"Rollover time must be after the last rollover")}catch(PERR){g.reportError(PERR)}return log("Next Rollover Time: ",nextRolloverTime),setTimeout(function(){function runRolloverWork(){self.root()&&self.parseSubtree(self.root(),ChangeType.Auto|ChangeType.Rollover),Measure.clearItemCache(),Measure.clearLineCache(),self.updateAllItems(!1,!0),g.timeline.updateNotifications(),log("-------------------------------")}try{g.PAssert(4944,self.isLoaded,"Expect that we have fully loaded the page before performing rollover")}catch(PERR){g.reportError(PERR)}log("---- Running Date Rollover ----"),lastDateRollover=new Date,self.setupDateRollover(),Date.Parsing.Normalizer.buildReplaceData(),g.timeline.clearDailyCaches(),g.settings.get(Settings.syncContacts)?(goog.loadedContacts=!1,goog.loadContacts(runRolloverWork)):runRolloverWork(),Dispatcher.fireEvent("dateChanged",[])},nextRolloverTime-currentTime),nextRolloverTime};var hasLoadedRemoteData=!1;self.notifyDriveDisconnect=function notifyDriveDisconnectFn(){hasLoadedRemoteData=!1,tracker.resetAggregateActionCount()},self.notifyDriveOperationError=function notifyDriveOperationErrorFn(){tracker.resetAggregateActionCount()},self.loadGDriveData=function loadGDriveDataFn(){if(!hasLoadedRemoteData){try{g.PAssert(4960,d.localDataLoaded(),"Must have already loaded local data from db")}catch(PERR){g.reportError(PERR)}try{g.PAssert(4961,g.vmMain.isLoaded===!0,"Must have already loaded local data")}catch(PERR){g.reportError(PERR)}hasLoadedRemoteData=!0,platform.mobile||(self.selectionOnLoad=Sel.save());var rootItem=gdata.rootItem;try{if(!self.root()){d.createRootItem(rootItem.id);var rootVMLI=d.createVMLI(d.getRootItem(),{changeType:ChangeType.Auto});g.vmMain.itemStoreManager.getDefaultItemStore().setRoot(rootVMLI),self.root(rootVMLI)}self.root().linkToGDrive(rootItem)}catch(err){g.reportError(err),g.menus.alert({text:"There was a fatal error in the application. Please reload to try again.",actionText:"RELOAD",callback:g.reload})}try{gdata.checkRemoteIntegrity()}catch(err){g.reportError(err)}var savedSelection;Sel.isValid()&&(savedSelection=Sel.save(),Sel.reset()),g.vmMain.beginUpdateItems(),runRemoteLoad(rootItem),g.vmMain.commitUpdateItems(),savedSelection&&Sel.restore(savedSelection,!0),Dispatcher.fireEvent("gdataLoaded",[]),self.vmPicker.refreshFiles()}};var hasLoadedData=!1;self.loadDemoContacts=function loadDemoContactsFn(names){function addContact(name){var email="test-"+name.split(" ")[0].toLowerCase()+"@moo.do";contacts.push({id:"contact_"+contactId++,name:name,isDemo:!0,emails:[{address:email,primary:!0}],phoneNumbers:[{number:"(555) 123-4567",type:"mobile"}]})}for(var contacts=[],contactId=0,i=0;i<names.length;i++)addContact(names[i]);d.contactManager.loadContacts(contacts,!0)},self.loadData=function loadDataFn(){if(!hasLoadedData){try{g.PAssert(4962,d.localDataLoaded(),"Must have already loaded local data")}catch(PERR){g.reportError(PERR)}if(ShouldLog(LogLevels.Timing))var start=log.now();if(hasLoadedData=!0,self.isDemoMode()){var contacts=["Jay","Grant","Ramada","Canyon Ranch","Jim Joseph","Miller Harris","Bob Johnson","Bill Wilson","Emily Edwards","Jane Johnson","Mike Thomas","Joe Lewis","Steve","Melissa","Mikey","Bart","Dad","Mom","James Rhodes","Neptures","Pepper","President Ellis","Contacts","Jane"];self.loadDemoContacts(contacts)}if(g.startTimeEvent("PageLoad","LocalData","Load Local Data"),d.getRootItem()){g.vmMain.beginUpdateItems();var rootVMLI=d.createVMLI(d.getRootItem(),{changeType:ChangeType.Auto});g.vmMain.itemStoreManager.getDefaultItemStore().setRoot(rootVMLI),self.root(rootVMLI),g.vmMain.commitUpdateItems()}g.checkpoint(Checkpoint.LocalDocLoad),g.endTimeEvent(),self.isLoaded=!0,g.requireGDriveDataCallback&&self.loadGDriveData(),ShouldLog(LogLevels.Timing)&&log("Run loading/parseWorker",log.now()),g.vmSetup.initDemo(),setTimeout(function(){self.isDemoMode()&&(platform.script&&g.vmSetup.runScript(util.getURLParam("script")),window.parent.postMessage("loaded","*"))},0),d.getRootItem()?self.afterLoaded():Dispatcher.listen("gdataLoaded",function(){self.afterLoaded()}),g.startTimeEvent("PageLoad","ApplyBindings","Apply Bindings"),ReactDOM.render(React.createElement(ReactMain,{main:this}),document.getElementById("container")),self.isDemoMode()&&platform.script&&g.setupClick(document.getElementById("container"),self,self.onTapMain),self.isRendered=!0,document.getElementById("container").style.display="block",platform.app&&g.nativeBridge.sendToApp("localLoaded"),self.pluginManager.notifyDependencyLoad(PluginDependency.LocalLoaded),ShouldLog(LogLevels.Timing)&&(log("DONE LOCALLY",log.now()),setTimeout(function(){var end=log.now();log("time react:",end-start,end)},0)),g.endTimeEvent()}},self.changeRoot=function changeRootFn(rootId){try{g.PAssert(4963,rootId,"Cannot use to reset root to undefined")}catch(PERR){g.reportError(PERR)}var newRoot=d.getModel(rootId);newRoot||(newRoot=d.createVMLI(d.getItem(rootId),{changeType:ChangeType.Auto}));try{g.PAssert(4964,newRoot,"Must have a new root VMLI at this point, otherwise failed creation")}catch(PERR){g.reportError(PERR)}newRoot&&(self.itemStoreManager.getDefaultItemStore().setRoot(newRoot),self.root(newRoot),self.paneManager.runForEachPane(function(pane){Sel.reset(),pane.setItem(newRoot)}))},self.resetScrollOffsets=function resetScrollOffsetsFn(){self.paneManager.runForEachPane(function(pane){pane.setScrollOffset(pane.defaultOffset)})},self.onTapMain={onStart:function onStartFn(){g.fireCustomEvent("tapMain")},onClick:function onClickFn(){try{g.PAssert(4965,self.isDemoMode()&&platform.script,"Tap handler should only be active on demo page")}catch(PERR){g.reportError(PERR)}window.parent.postMessage("click","*")}},self.loadDemoPanes=function loadDemoPanesFn(){self.paneManager.clearPanes();for(var i=0;i<g.demoPanes.length;i++){var paneInfo=g.demoPanes[i].split(",");if("help"===paneInfo[0])self.showHelp();else{var type=paneInfo[0];"1"===type?type=PaneMode.Outline:"2"===type&&(type=PaneMode.Timeline);var paneInit={};if(paneInfo.length>1){paneInfo[1]&&(paneInit.search=paneInfo[1]);var zoomModel=void 0;paneInfo[2]&&(zoomModel=d.getModel(paneInfo[2])),paneInit.item=zoomModel||self.root()}var addedPane=PaneFactory.createPane(type,paneInit);addedPane&&self.paneManager.addPaneAtIndex(addedPane)}}var firstPane=self.paneManager.getPaneAtIndex(0);try{g.PAssert(4970,firstPane,"Must always have at least one valid pane in demo mode")}catch(PERR){g.reportError(PERR)}firstPane&&(Sel.setFocusedPane(firstPane),self.zoomin(firstPane.getItem(),!0))},self.loadItemPane=function loadItemPaneFn(paneData){try{g.PAssert(4971,paneData,"Must specify valid pane data to load from")}catch(PERR){g.reportError(PERR)}var outlinePanes=self.paneManager.getPanesByType(PaneMode.Outline),zoomModel=d.getModel(paneData);if(zoomModel){var focusPane;if(outlinePanes.length>0)focusPane=outlinePanes[0];else{var initData={id:self.paneManager.getNextPaneID(),item:zoomModel};focusPane=PaneFactory.createPane(PaneMode.Outline,initData),focusPane&&self.paneManager.addPaneAtIndex(0)}focusPane&&(Sel.setFocusedPane(focusPane),self.zoomin(zoomModel,!0))}},self.afterLoaded=function afterLoadedFn(){var paneState=self.paneManager.getPaneState();if(paneState.length>0){try{g.PAssert(4972,1===paneState.length||!platform.mobile,"Mobile will always have a single pane")}catch(PERR){g.reportError(PERR)}for(var i=0;i<paneState.length;++i){if(platform.mobile&&i>0){try{g.PAssert(4973,!1,"Loading invalid pane state")}catch(PERR){g.reportError(PERR)}break}var paneInfo=paneState[i],itemID=paneInfo.item||paneInfo.focus,item=d.getModel(itemID),paneType=paneInfo.type||(1===paneInfo.mode?PaneMode.Outline:PaneMode.Timeline);"PaneNormal"===paneType&&(paneType=PaneMode.Outline);var params=g.clone(paneInfo);params.id=self.paneManager.getNextPaneID(),params.item=item,params.deferredItemID=item?void 0:itemID;var pane=PaneFactory.createPane(paneType,params);pane?(paneInfo.id=pane.id,paneInfo.showarch&&pane.showArchived.set(!0),pane.applyItemState(paneInfo.itemState),self.paneManager.addPaneAtIndex(pane,void 0,!0,!1),Sel.setFocusedPane(pane,!0),self.zoomin(pane.getItem(),!0)):(paneState.splice(i,1),self.paneManager.savePaneState(),--i)}self.paneManager.notifyPanes(),1!==self.paneManager.paneCount()&&Sel.setFocusedPane(pane,!0)}var loadPanes=util.getURLParam("panes");self.isDemoMode()&&g.demoPanes?self.loadDemoPanes():loadPanes?self.loadItemPane(loadPanes):0===self.paneManager.paneCount()&&d.getRootItem()&&self.createDefaultPane(),platform.mobile&&(g.keyboardToolbar=KeyboardToolbar),platform.app&&(document.onreadystatechange=function(){platform.mobile&&g.nativeBridge.sendToApp("kbsize"),g.nativeBridge.sendToApp("loaded")},document.onreadystatechange()),g.timeline.updateNotifications()},self.createDefaultPane=function createDefaultPaneFn(){var pane=PaneFactory.createPane(PaneMode.Outline,{id:self.paneManager.getNextPaneID(),isDefaultPane:!0});self.paneManager.addPaneAtIndex(pane),Sel.setFocusedPane(self.paneManager.getPaneAtIndex(0)),self.zoomin(self.root(),!0)},self.togglePaneModeMobile=function togglePaneModeMobileFn(srcPane,dstType){try{g.PAssert(4975,platform.mobile,"Should only call on mobile devices")}catch(PERR){g.reportError(PERR)}NativeSel.clearSelection(),DragDrop.stop(),DragDrop.finish(),g.vmMain.beginUpdateItems();var dstPane=self.paneManager.getSwappedPaneByType(dstType);try{g.PAssert(4976,dstPane,"Must always have a pane of requested type available")}catch(PERR){g.reportError(PERR)}dstPane.copyStateFrom(srcPane),dstPane.getInfiniteList(!0).hasSetHeightOnce=!1,self.paneManager.swapPaneAtIndex(0,dstPane),g.keyboardToolbar.hide(),Sel.setFocusedPane(dstPane),g.vmMain.commitUpdateItems()},self.zoomin=function zoominFn(item,forLoad){try{g.PAssert(4993,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var pane=g.focusedPane,oldItem=pane&&pane.item.get();if(self._zoom(item,forLoad),item.isDemandLoad()&&item.notifyDemandLoadUpdate(!0,pane),forLoad||g.sendEvent("Menu","ZoomIn"),!platform.mobile&&pane.paneContent&&pane.isWriteable){pane.addIfEmpty();var selIndex=pane.indexOfFirstItem();selIndex>=0?Sel.selectIndex(selIndex,0,0):Sel.clearSelection()}pane.isLoaded&&pane.setScrollOffset(pane.defaultOffset),forLoad||tracker.performAction(TrackerType.Zoom,{itemID:item.id,oldItemID:oldItem.id,zoomIn:!0,time:g.zoomTime})},self.zoomout=function zoomoutFn(item,fromUndo){try{g.PAssert(4994,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var pane=g.focusedPane,oldItem=pane&&pane.item.get(),savedSel=Sel.save();self._zoom(item,!1),g.sendEvent("Menu","ZoomOut");var pane=g.focusedPane;pane.isWriteable&&savedSel&&pane.indexOfItem(savedSel.startItem)>=0&&pane.indexOfItem(savedSel.endItem)>=0&&(Sel.selectItems(savedSel.startItem,savedSel.startOffset,savedSel.endItem,savedSel.endOffset),g.focusedPane.scrollItemToMiddle(savedSel.startItem,ScrollDuration.Snap)),fromUndo||tracker.performAction(TrackerType.Zoom,{itemID:item.id,oldItemID:oldItem.id,zoomOut:!0,time:g.zoomTime})},self._zoom=function _zoomFn(item,forLoad){try{g.PAssert(4995,item,"Must supply a valid item to zoom to")}catch(PERR){g.reportError(PERR)}var pane=g.focusedPane,oldItem=pane&&pane.item.get();if(!oldItem||oldItem.id!==item.id){Sel.reset();var pane=g.focusedPane;pane.setItem(item,!0),g.focusedItem=item,forLoad||self.paneManager.updatePaneStateForPane(g.focusedPane)}};var fullscreenClickHandled=!1,_handleDown=function(e){(g.findParentID(e.target,"container")||g.findParentID(e.target,"desktopMenu"))&&self.cancelFullscreenClick(),g.findParentID(e.target,"desktopMenu")&&e.stopPropagation()};self.handleFullscreenClick=function handleFullscreenClickFn(){fullscreenClickHandled||(document.addEventListener(platform.downEvent,_handleDown,!0),document.addEventListener(platform.touchStartEvent,_handleDown,!0),fullscreenClickHandled=!0)},self.cancelFullscreenClick=function cancelFullscreenClickFn(){fullscreenClickHandled&&(document.removeEventListener(platform.downEvent,_handleDown,!0),document.removeEventListener(platform.touchStartEvent,_handleDown,!0),fullscreenClickHandled=!1,g.menus.closeAllMenus())},self.isFullscreenClickHandled=function isFullscreenClickHandledFn(){return fullscreenClickHandled},self.applyFnToSelection=function applyFnToSelectionFn(fn,params){var savedSel=Sel.save(),toggle=params&&params.toggle,value=params&&void 0!==params.value?params.value:!0,value2=params&&void 0!==params.value2?params.value2:void 0;if(self.applyToSelection(function(item){toggle&&item[fn]()!==value&&(toggle=!1),toggle||item[fn](value,value2)}),toggle){var emptyValue=emptyValue=params&&void 0!==params.emptyValue?params.emptyValue:!1;self.applyToSelection(function(item){item[fn](emptyValue,value2)})}savedSel&&g.focusedPane.restoreSelection(savedSel)},self.applyToSelection=function applyToSelectionFn(action,options){try{g.PAssert(4996,!options||!options.restoreSelection,"restoreSelection is no longer a valid option")}catch(PERR){g.reportError(PERR)}tracker.beginAction();var items=Sel.getSelectedItems();options&&options.resetSelection&&Sel.reset(),self.beginUpdateItems();for(var i=0;i<items.length;++i){var actionRetVal=action(items[i],i,items.length);if(actionRetVal===!1)break}return self.commitUpdateItems(),tracker.endAction(),items.length};var prevMove,prevHovered;self.updateCursorFromEvent=function updateCursorFromEventFn(e){if(prevMove){var hovered=prevMove.target;if(hovered&&g.isAttachedToDoc(hovered)){var pane=g.getPaneForElement(hovered);if(pane){var target=g.elementFromPoint(prevMove.clientX,prevMove.clientY,prevMove.target);if(target){var item=g.dataFor(target,!0);g.isVMLI(item)||(item=void 0),self.updateCursor(e,pane,target,item)}}}}},self.getCursorForClass=function getCursorForClassFn(target,e,isOverview){for(var clsArr=target.classList,i=0;i<clsArr.length;i++){var cls=clsArr[i];switch(cls){case"link":case"date":return platform.mac&&e.metaKey||!platform.mac&&e.ctrlKey?"pointer":null;case"collapser":if(isOverview)return"pointer";var pane=g.getPaneForElement(target);return pane.pluginCursor()}}return isOverview?"pointer":void 0},self.updateCursor=function updateCursorFn(e,pane,element,item){var cursor=void 0;if(pane&&element){if(item&&g.isVMLI(item)){var pluginParent=g.findParentInItem(element,"plugin");pluginParent&&(element=pluginParent)}var isOverview=!!g.findParent(element,"paneOverviewScroller");Sel.isMouseDown()||(cursor=self.getCursorForClass(element,e,isOverview)),isOverview?pane.overview.cursor.set(cursor):pane.cursor.set(cursor)}},platform.touch||(self.mousemove=function mousemove(e,force){if(self.notifyActivity(),!g.disableMouseMove&&(force||!prevMove||e.clientX!==prevMove.clientX||e.clientY!==prevMove.clientY)){var itemHovered,reactCellHovered,pane,newTarget=g.ensureDOMNode(e.target);(g.findParent(newTarget,"paneRoot")||g.findParent(newTarget,"paneOverviewScroller"))&&(platform.normalizeMouse(e),pane=g.getPaneForElement(newTarget),pane&&(itemHovered=g.dataFor(newTarget,!0),g.isVMLI(itemHovered)?reactCellHovered=g.getReactCellForElement(newTarget):itemHovered=void 0,self.updateCursor(e,pane,newTarget,itemHovered))),Sel.setHovered(pane,itemHovered,reactCellHovered),prevMove&&prevMove.target===newTarget||(prevMove&&prevMove.target&&Dispatcher.fireEvent("mouseout",[{target:prevMove.target}]),newTarget&&Dispatcher.fireEvent("mouseover",[{target:newTarget}])),prevMove={clientX:e.clientX,clientY:e.clientY,target:newTarget}}},g.element("outerWrapper").addEventListener("mousemove",self.mousemove)),self.showHelp=function showHelpFn(helpState){g.intro.setMode(helpState||C.HelpMode.Intro)},self.runFirstRun=function runFirstRunFn(){platform.mobile||g.menus.openModal(Modals.Welcome,{callback:function callbackFn(){var plugin=self.getDefaultEmailPlugin();!plugin.isActive()||plugin.isPluginBlocked()||plugin.hasActiveDataPanes()||self.paneManager.createPaneAtIndex(plugin.getPaneType(),0)}})},self.oldUserNewTrial=function oldUserNewTrialFn(){g.toasts.pushMessage(MessageID.OldUserNewTrial)};var activityTimeout=void 0,updateTimeout=void 0,lowActivityTimer=void 0,activityThreshold=g.seconds(5);self.notifyActivity=function notifyActivityFn(){self.lastActivity=Date.now(),lowActivityTimer||(lowActivityTimer=setTimeout(self.checkLowActivity,2*activityThreshold)),self.whenLowImpactEnd()},self.checkLowActivity=function checkLowActivityFn(){var timeSinceActivity=Date.now()-self.lastActivity;
timeSinceActivity>activityThreshold&&self.whenLowImpactBegin(),lowActivityTimer=void 0};var isLowImpact=!1;if(self.whenLowImpactBegin=function whenLowImpactBeginFn(){isLowImpact||(isLowImpact=!0,Dispatcher.fireEvent("lowImpactBegin",[]))},self.whenLowImpactEnd=function whenLowImpactEndFn(){isLowImpact&&(Dispatcher.fireEvent("lowImpactEnd",[]),isLowImpact=!1)},self.isLowImpact=function isLowImpactFn(){return isLowImpact},self.isDemoMode()||(setupPageVisibility(),self.checkLowActivity()),self.paneManager.onResize(),g.shouldWriteLocal()){var setting="version"+(platform.mobile?"Mobile":"Desktop"),prevVersion=+util.storage.getItem(setting),ver=platform[setting];if(!g.isFirstRun&&!g.isDemoMode()&&(!prevVersion||ver>prevVersion))for(var messages=platform.getUpdateMessages(prevVersion),i=0;i<messages.length;++i)if(g.isString(messages[i]))g.toasts.pushMessage({text:messages[i],hold:!0,action:MessageAction.Blog});else{try{g.PAssert(4997,g.isFunction(messages[i]),"Must supply a valid getter fn for the message")}catch(PERR){g.reportError(PERR)}var msg=messages[i]();(!msg.isPremiumOnly||g.billingManager.hasPremium())&&g.toasts.pushMessage({text:msg.text,hold:!0,action:msg.action||MessageAction.Blog})}util.storage.setItem(setting,ver)}var itemFlushStacks,EnableItemFlushStacks;return self._updateAllItems=function _updateAllItemsFn(){var forceNotify=self._forceNotify;self._forceNotify=!1;var updateSearch=self._updateSearch;self._updateSearch=!1,(self._itemsDirty||forceNotify)&&(self._itemsDirty=!1,self._isUpdating=!0,self.paneManager.runForEachPane(function(pane){(forceNotify||pane.isItemsDirty())&&pane.updateItemsImmediate(updateSearch,forceNotify),pane.setIgnoreRestoreScroll(!1)}),self._isUpdating=!1)},self._isSearching=!1,self._isUpdating=!1,self._numFlushesInCommit=0,self._isWaitingUpdateItems=0,self._itemsDirty=!1,self._forceNotify=!1,self._updateSearch=!1,self._itemsUpdateWatchdog=void 0,self._lastUpdateItemsStack=void 0,self.isUpdatingItems=function isUpdatingItemsFn(){return self._isWaitingUpdateItems>0&&self._itemsDirty},self.beginUpdateItems=function beginUpdateItemsFn(){self._isWaitingUpdateItems++,1===self._isWaitingUpdateItems&&(self._lastUpdateItemsStack=g.getCurrentStack("Update Items Stack"),self._itemsUpdateWatchdog=setTimeout(updateWatchdog,0))},self.commitUpdateItems=function commitUpdateItemsFn(updateSearch,forceNotify){try{g.PAssert(5003,self._isWaitingUpdateItems>0,"Missing a call to beginUpdateItems: ",self._isWaitingUpdateItems)}catch(PERR){g.reportError(PERR)}self._isWaitingUpdateItems--,0===self._isWaitingUpdateItems&&(clearTimeout(self._itemsUpdateWatchdog),self._itemsUpdateWatchdog=void 0,self._lastUpdateItemsStack=void 0,self._numFlushesInCommit=0),self._itemsDirty&&self.updateAllItems(updateSearch,forceNotify)},self.flushItemsUpdate=function flushItemsUpdateFn(){self.isUpdatingItems()&&(self._numFlushesInCommit++,self._updateAllItems())},self.updateAllItems=function updateAllItemsFn(updateSearch,forceNotify){try{g.PAssert(5004,void 0===updateSearch||g.isBoolean(updateSearch),"Must supply a bool param for updateSearch")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5005,void 0===forceNotify||g.isBoolean(forceNotify),"Must supply a bool param for forceNotify")}catch(PERR){g.reportError(PERR)}self._itemsDirty=!0,forceNotify&&(self._forceNotify=forceNotify),updateSearch&&(self._updateSearch=updateSearch),0===self._isWaitingUpdateItems&&self._updateAllItems()},self.notifySearchStart=function notifySearchStartFn(){self._isSearching=!0},self.notifySearchEnd=function notifySearchEndFn(){self._isSearching=!1},self.getItemAnimationMode=function getItemAnimationModeFn(){return self._itemAnimationMode},self.setItemAnimationMode=function setItemAnimationModeFn(value){self._itemAnimationMode=value},self.resetItemAnimationMode=function resetItemAnimationModeFn(){self._itemAnimationMode=C.ItemAnimationMode.Normal},self.getScrollOffset=function getScrollOffsetFn(){return self.panesContainer.scrollLeft},self.setScrollOffset=function setScrollOffsetFn(value,duration){g.scrollTo(value,0,duration||ScrollDuration.Default,self.panesContainer)},self.pluginManager.registerPlugins(),self.init(),self};return util.defineBase(VMMain),VMMain}),define("ModalReportBug",["ko","globals","util","platform","ModalBase","Multiselect"],function(ko,g,util,platform,ModalBase,Multiselect){function ModalReportBug(){this._super.constructor.call(this,Modals.ReportBug),this.bugDescription=ko.observable(""),this.shareDocument=ko.observable(!1),this.init()}var ModalReportBugFns={init:function initFn(){this.registerModal(this.onModalOpen.bind(this))},onModalOpen:function onModalOpenFn(){platform.mobile||setTimeout(function(){document.getElementById("bugDescription").focus()}),this.shareDocument(!1)},onTapCancelBug:function onTapCancelBugFn(){g.menus.closeModal(this.id),g.blurActiveElement(),platform.mobile&&Multiselect.reset()},onTapSaveBug:function onTapSaveBugFn(){var desc=this.bugDescription()||g.element("bugDescription").value;if(desc&&desc.length>2){var name="Moo.do Feedback";if(this.shareDocument()){var doc=g.vmMain.docManager.getOpenDoc();if(doc){name+=" [DocShared]",desc+="\r\n\r\nShared Document - "+doc.id;var failureCB=function(){g.reportError(new Error("Unable to share doc with debug account"))};g.vmMain.remoteAPI().drivePermissionsInsert(doc.id,"debug@moo.do",!1,g.emptyFn,failureCB)}}g.sendFeedback(name,desc,function(){this.bugDescription("")}.bind(this)),g.menus.closeModal(Modals.ReportBug),g.toasts.pushMessage({text:"Thanks for taking the time to send us feedback!"}),g.sendEvent("Menu","SendFeedback"),g.blurActiveElement(),platform.mobile&&Multiselect.reset()}},onTapSocialTwitter:function onTapSocialTwitterFn(e){g.openUrl("https://www.twitter.com/MooDoApp",e),g.sendEvent("Menu","FeedbackTwitter")},onTapSocialFacebook:function onTapSocialFacebookFn(e){g.openUrl("https://www.facebook.com/MooDoApp",e),g.sendEvent("Menu","FeedbackFacebook")},onTapSocialGoogle:function onTapSocialGoogleFn(e){g.openUrl("https://www.google.com/+MooDoApp",e),g.sendEvent("Menu","FeedbackGoogle")},onTapSocialUserVoice:function onTapSocialUserVoiceFn(e){g.openUrl("https://feedback.moo.do/",e),g.sendEvent("Menu","FeedbackUserVoice")}};return util.inherit(ModalBase,ModalReportBug),util.extend(ModalReportBug.prototype,ModalReportBugFns),ModalReportBug}),define("VMDebug",["ko","globals","platform","data","ModalReportBug"],function(ko,g,platform,d,ModalReportBug){function VMDebug(){this.init()}return VMDebug.prototype={init:function initFn(){new ModalReportBug},addPadding:function addPaddingFn(){var padSize=platform.windowHeight()-platform.getKBSize()+g.topBarHeight;platform.android&&(padSize=platform.getKBSize()+20),g.element("feedbackScroller").style.paddingBottom=padSize+"px"},removePadding:function removePaddingFn(){document.getElementById("feedbackScroller").style.paddingBottom=""}},VMDebug}),define("VMTimeline",["globals","platform","Dispatcher","util"],function(g,platform,Dispatcher,util){function VMTimeline(){this.dateKeyCache={},this.notificationItems={},this.numNotificationItemsChanged=0,this.scheduledItems={},this.notifiedItems={},this.scheduleTimeout=void 0,util.forceBind("showNotification",this)}return window.__FULL_NOTIFICATION_UPDATES=0,window.__SINGLE_NOTIFICATION_UPDATES=0,VMTimeline.prototype={clearDailyCaches:function clearDailyCachesFn(){this.dateKeyCache={}},addNotification:function addNotificationFn(item){try{g.PAssert(5008,item,"Must provide a valid item to schedule notifications for")}catch(PERR){g.reportError(PERR)}this.notificationItems[item.id]=item,this.numNotificationItemsChanged++,this.scheduleTimeout||(this.scheduleTimeout=setTimeout(this.setupNotifications.bind(this),500))},removeNotification:function removeNotificationFn(item){try{g.PAssert(5009,item,"Must provide a valid item to unschedule notifications for")}catch(PERR){g.reportError(PERR)}this.notificationItems[item.id]&&(this.notificationItems[item.id]=void 0,this.numNotificationItemsChanged++,this.scheduleTimeout||(this.scheduleTimeout=setTimeout(this.setupNotifications.bind(this),500)))},clearNotifications:function clearNotificationsFn(){for(var prop in this.notificationItems)this.notificationItems.hasOwnProperty(prop)&&(this.notificationItems[prop]=void 0,this.numNotificationItemsChanged++);this.scheduleTimeout||(this.scheduleTimeout=setTimeout(this.setupNotifications.bind(this),500))},shouldNotify:function shouldNotifyFn(item,now){now||(now=new Date);var date=item.date();return!item.isComplete()&&!item.allDayDate()&&!item.isArchived()&&(date&&date>now&&date-Date.now()<864e5||item.repeatDate())},updateNotifications:function updateNotificationsFn(item){if(platform.supportsNotifications()&&g.vmSettings.enabledNotifications()){var now=new Date;item?(window.__SINGLE_NOTIFICATION_UPDATES++,this.shouldNotify(item,now)?this.addNotification(item):this.removeNotification(item)):(window.__FULL_NOTIFICATION_UPDATES++,this.clearNotifications(),g.searchVMLIs({item:g.vmMain.root(),includeArchived:!1,each:function eachFn(item){this.shouldNotify(item,now)&&this.addNotification(item)}.bind(this)}))}},setupNotifications:function setupNotificationsFn(){try{g.PAssert(5010,platform.supportsNotifications(),"Platform must support notifications")}catch(PERR){g.reportError(PERR)}var notifications=[];for(var prop in this.notificationItems)if(this.notificationItems.hasOwnProperty(prop)){var item=this.notificationItems[prop];if(item&&item.getNotificationEntries){var entries=item.getNotificationEntries();if(entries)if(g.isArray(entries))for(var i=0;i<entries.length;++i)notifications.push(entries[i]);else notifications.push(entries)}else delete this.notificationItems[prop]}if(platform.supportsHTML5Notifications()){for(var key in this.scheduledItems)if(this.scheduledItems.hasOwnProperty(key)){var itemInfo=this.scheduledItems[key];clearTimeout(itemInfo.timeout)}for(var i=0;i<notifications.length;++i){var item=notifications[i],dueDate=new Date(item.date),date=new Date(item.alertDate);if(!(this.notifiedItems[item.id]||this.scheduledItems[item.id]&&this.scheduledItems[item.id].date===item.date)){var timeFromNow=date-Date.now();0>timeFromNow&&(timeFromNow=0);var itemInfo={item:item};itemInfo.timeout=setTimeout(this.showNotification,timeFromNow,itemInfo),this.scheduledItems[item.id]=itemInfo}}}else g.nativeBridge.isEnabled()?g.nativeBridge.sendToApp("scheduledItems",notifications):g.nativeBridge.hasEmbedBridge()&&g.nativeBridge.sendToEmbed("scheduledItems",notifications);this.numNotificationItemsChanged=0,this.scheduleTimeout=void 0},showNotification:function showNotificationFn(itemInfo){var item=itemInfo.item,itemTime=new Date(item.date),timeTill=Math.round((itemTime-Date.now())/6e4);this.notifiedItems[item.id]=!0;var notification=new Notification(item.text,{body:"in "+timeTill+" minutes"})}},VMTimeline}),define("TemplateCache",["ko","globals"],function(ko,g){window.__TOTAL_TEMPLATES=0;var self={},cachedTemplatesDomDataKey="__cached_template__";self.templateSources=function templateSourcesFn(domElem){var templateSources={elem:domElem,__proto__:new ko.templateSources.domElement(domElem)};return templateSources.text=function(value){return 0===arguments.length?templateSources.elem.text:void(templateSources.elem.text=value)},templateSources.nodes=function(value){try{g.PAssert(5011,0===arguments.length)}catch(PERR){g.reportError(PERR)}if(0===arguments.length){var templateData=ko.utils.domData.get(templateSources.elem,cachedTemplatesDomDataKey);if(!templateData){for(var templateText=templateSources.text().replace(/(\r\n|\n|\r|\s*(?=<)|\s*$)/gm,""),parsedNodes=ko.utils.parseHtmlFragment(templateText),compiledNodes=document.createElement("div"),i=0;i<parsedNodes.length;i++)compiledNodes.appendChild(parsedNodes[i]);return ko.utils.domData.set(templateSources.elem,cachedTemplatesDomDataKey,{cachedNodes:compiledNodes}),compiledNodes}return templateData.cachedNodes}},templateSources},self.templateEngine=function templateEngineFn(){var templateEngine={__proto__:new ko.nativeTemplateEngine};return templateEngine.cachedDoc=void 0,templateEngine.makeTemplateSource=function(template,templateDocument){try{g.PAssert(5012,"string"==typeof template)}catch(PERR){g.reportError(PERR)}var incomingDoc=templateDocument||document,cachedDoc=templateEngine.cachedDoc;if(!templateEngine.cachedDoc){try{g.PAssert(5013,incomingDoc)}catch(PERR){g.reportError(PERR)}cachedDoc={doc:incomingDoc,cachedTemplates:{}},templateEngine.cachedDoc=cachedDoc}try{g.PAssert(5014,cachedDoc)}catch(PERR){g.reportError(PERR)}var elem=cachedDoc.cachedTemplates[template];if(!elem){var domElem=cachedDoc.doc.getElementById(template);try{g.PAssert(5015,domElem)}catch(PERR){g.reportError(PERR)}if(domElem)try{elem=new self.templateSources(domElem);try{g.PAssert(5016,elem)}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}else g.reportError(new Error('Unable to find element for template "'+template+'". '+domElem));cachedDoc.cachedTemplates[template]=elem,window.__TOTAL_TEMPLATES++}return elem},templateEngine};var engine=self.templateEngine();return engine instanceof ko.templateEngine&&ko.setTemplateEngine(engine),self}),define("VMAutocompleteItem",["ko","data","globals"],function(ko,d,g){function VMAutocompleteItem(p){this.id=p.id,this.text=ko.observable(p.text||""),this.index=p.index,this.object=p.object,this.isVisible=ko.observable(!0),this.isSelected=ko.observable(!1),this.element=void 0,this.init()}return VMAutocompleteItem.prototype={init:function initFn(){},html:function htmlFn(){var searchText=g.autocomplete.text(),text=this.text();try{g.PAssert(5017,g.isString(searchText),"Search text must be a string: ",searchText)}catch(PERR){g.reportError(PERR)}try{g.PAssert(5018,g.isString(text),"Item text must be a string: ",text)}catch(PERR){g.reportError(PERR)}if(void 0!==text&&void 0!==searchText&&searchText.length>0){var index=text.toLowerCase().indexOf(searchText.toLowerCase()),newText="";return newText=index>=0?text.substr(0,index)+"<b>"+text.substr(index,searchText.length)+"</b>"+text.substr(index+searchText.length):text}return text},onLoad:function onLoadFn(element){this.element=element}},VMAutocompleteItem}),define("VMNoneManager",["globals"],function(g){function VMNoneManager(){}return VMNoneManager.prototype={init:function initFn(){},previewTemplate:function previewTemplateFn(){return void 0},getItemStyledText:function getItemStyledTextFn(item){return item},getItemText:function getItemTextFn(){return void 0},getItemTextLength:function getItemTextLengthFn(){return 0},findMatchExact:function findMatchExactFn(str){return void 0},findMatchLike:function findMatchLikeFn(str,maxCount){return void 0}},VMNoneManager}),define("VMAutocomplete",["ko","data","globals","Constants","util","goog","platform","android","tracker","VMAutocompleteItem","AutocompleteDates","VMNoneManager","Sel","Measure","TagManager","DisplaySettings","Hotkeys","MobileUI","Dispatcher"],function(ko,d,g,C,util,goog,platform,android,tracker,VMAutocompleteItem,AutocompleteDates,VMNoneManager,Sel,Measure,TagManager,DisplaySettings,Hotkeys,MobileUI,Dispatcher){function VMAutocomplete(){try{g.PAssert(5019,!g.autocomplete,"Autocomplete is a singleton")}catch(PERR){g.reportError(PERR)}g.autocomplete=this,this.isEnabled=!0,this.items=ko.observableArray(),this.isVisible=ko.observable(!1),this.contactsEnabled=ko.observable(!0),this.element=void 0,this.trackingTag=void 0,this._activeOwner=void 0,this.selectedIndex=ko.observable(-1).extend({notify:"always"}),this.exactMatch=ko.observable(!1),this.text=ko.observable(""),this.lastParams=void 0,this.autocompleteDates=new AutocompleteDates,this.previousSelectionRect={},this.mode=ko.observable(void 0),this._validProviders=[],this._provider=void 0,this.registerProvider(ACProvider.None,new VMNoneManager),this.registerProvider(ACProvider.Contact,d.contactManager),this.registerProvider(ACProvider.DatePicker,this.autocompleteDates),this.registerProvider(ACProvider.DateList,this.autocompleteDates),this.registerProvider(ACProvider.Tag,TagManager),this._prefixes=[ContactPrefix,DatePrefix,TagPrefix],this._prefixMap={},this._prefixMap[ContactPrefix]=ACProvider.Contact,this._prefixMap[TagPrefix]=ACProvider.Tag,this._prefixMap[DatePrefix]=platform.mobile&&platform.app?ACProvider.DatePicker:ACProvider.DateList,g.vmMain.pluginManager.runForEachPlugin(function(plugin){plugin.registerAutocomplete()}),this.mode(ACProvider.None),util.forceBind("hide",this),this.init()}return VMAutocomplete.prototype={showDates:function showDatesFn(){return this.mode()===ACProvider.DatePicker&&(""===this.text()||this.autocompleteDates.nextDateWord())},showList:function showListFn(){return!(this.exactMatch()||this.showDates()||this.mode()===ACProvider.Contact&&!this.contactsEnabled())},showPreview:function showPreviewFn(){return this.mode()&&this._provider.previewTemplate()&&this.items().length>0&&this.selectedIndex()>=0&&this.selectedItem()&&(!platform.mobile||this.exactMatch())},showEnableContactsUI:function showEnableContactsUIFn(){return this.mode()===ACProvider.Contact&&this.isVisible()&&!this.contactsEnabled()},hasContent:function hasContentFn(){return this.showDates()||this.showList()||this.showPreview()||!this.contactsEnabled()},previewTemplate:function previewTemplateFn(){try{g.PAssert(5020,this._provider,"Provider must be valid")}catch(PERR){g.reportError(PERR)}return this._provider.previewTemplate()},autocompleteWidth:function autocompleteWidthFn(){return this.mode()&&this._provider.autocompleteWidth?this._provider.autocompleteWidth()+"px":void 0},selectedItem:function selectedItemFn(){try{g.PAssert(5021,this.selectedIndex()>=0,"Should always have a valid selection index")}catch(PERR){g.reportError(PERR)}if(this.selectedIndex()<0)return void 0;try{g.PAssert(5022,void 0!==this.items()[this.selectedIndex()],"Autocomplete should always have valid entries")}catch(PERR){g.reportError(PERR)}return this.items()[this.selectedIndex()]},init:function initFn(){this.onkeydown=this.onkeydown.bind(this),Dispatcher.listen("closeKeyboard",this.hide.bind(this)),this.element=document.getElementById("autocomplete"),setTimeout(function(){g.applyBindings(this,"autocomplete"),platform.isTouchDevice&&platform.mobile&&this.element.addEventListener(platform.touchStartEvent,function(e){return this.showPreview()||g.preventScrollPropagation(this.element)?void 0:(e.preventDefault(),!1)}.bind(this))}.bind(this),0)},registerProvider:function registerProviderFn(provider,obj){try{g.PAssert(5023,!this._validProviders[provider],"Registering a provider that has already been registered")}catch(PERR){g.reportError(PERR)}this._validProviders[provider]=obj},registerPrefix:function registerPrefixFn(provider,prefix){try{g.PAssert(5024,!this._prefixMap[prefix],"Should only register a prefix once")}catch(PERR){g.reportError(PERR)}this._prefixes.push(prefix),this._prefixMap[prefix]=provider},setProviderMode:function setProviderModeFn(mode){if(this.mode()!==mode){this._provider=this._validProviders[mode];try{g.PAssert(5025,this._provider,"Provider must be valid",mode)}catch(PERR){g.reportError(PERR)}this.clear(),this.mode(mode)}},getProviderForPrefix:function getProviderForPrefixFn(prefix){var provider=this._prefixMap[prefix]||ACProvider.None;return provider},show:function showFn(elTapped){if(!this.isVisible()){var completionElement=elTapped;if(this.mode()===ACProvider.Contact&&tracker.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenContact}),this.showList())try{g.PAssert(5027,this.element.children.length>0,"Must always have an items element when showing list")}catch(PERR){g.reportError(PERR)}var windowBounds=document.documentElement.getBoundingClientRect();if(!platform.mobile){var caretPos=Measure.getCaretScreenPosition(Sel.getPane(),Sel.getStartIndex(),Sel.getStartOffset()),selectionRect={left:caretPos.left,top:caretPos.top,right:caretPos.left,bottom:caretPos.top+DisplaySettings.itemLineHeight()+5},yDiff=Math.abs(selectionRect.top-this.previousSelectionRect.top);if(!(yDiff>10||!this.isVisible()||elTapped))return;var position={left:selectionRect.left,top:selectionRect.bottom,bottom:selectionRect.bottom+600},newHeight=g.adjustHeightToBeInsideBounds(windowBounds,position,100,600,10),width=this.mode()===ACProvider.Contact?550:250;if(position.left=Math.max(10,g.adjustLeftToBeInsideBounds(windowBounds,position.left,width,10)),this.showList()){try{g.PAssert(5028,this.element.children.length>0,"Must always have an items element when showing list")}catch(PERR){g.reportError(PERR)}this.element.children[0].style.maxHeight=newHeight+"px"}var translate="translate("+position.left+"px, "+position.top+"px)";g.isDemoMode()&&window.__AUTOCOMPLETE_SCALE&&(translate+=" scale("+window.__AUTOCOMPLETE_SCALE+")"),this.element.style[platform.transform.style]=translate}if(this.isVisible(!0),platform.mobile&&this._activeOwner){var time=150,bottomOfItem=0;if(this.mode()===ACProvider.Contact&&elTapped)this.element.style.top="",g.isKeyboardOpen?(this.element.style.paddingBottom="30px",this.element.style.bottom=android.isEnabled()?platform.getKBSize()+"px":0):(this.element.style.paddingBottom=0,this.element.style.bottom=0);else{var pane=g.focusedPane,amtMoved=pane.scrollItemToTop(this._activeOwner,time)||0,bounds;if(completionElement)bounds=completionElement.getBoundingClientRect();else{var element=pane.elementAtIndex(this._activeIndex);try{g.PAssert(5029,element,"Element should exist in autocomplete")}catch(PERR){g.reportError(PERR)}var top=pane.topOfIndex(this._activeIndex)-(pane.getScrollOffset()+amtMoved)+g.topBarHeight,height=pane.heightAtIndex(this._activeIndex);bounds={top:top,bottom:top+height}}bottomOfItem=bounds.bottom,this.element.style.paddingBottom="",this.element.style.top=bottomOfItem+"px",this.element.style.bottom=platform.getKBSize()+"px",this.mode()===ACProvider.Contact?MobileUI.setTopBarMode(C.TopBarMode.Contact):this.mode()===ACProvider.DatePicker?MobileUI.setTopBarMode(C.TopBarMode.Date):this.mode()===ACProvider.Tag&&MobileUI.setTopBarMode(C.TopBarMode.Tag)}g.keyboardToolbar.isVisible.set(!1);var trans=platform.windowHeight()-platform.kbsize-bottomOfItem;g.setTransform(this.element,0,trans),requestAnimationFrame(function(){g.setTransform(this.element,0,0,time,"ease-out")}.bind(this))}this.previousSelectionRect=selectionRect,this.__hotkeys=Hotkeys.pushStackEscape(this.hide),tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenAutocomplete})}},clear:function clearFn(){this.items.removeAll(),this.selectedIndex(-1),this.trackingTag=!1},hide:function hideFn(){if(this.isVisible()){var time=200;if(platform.mobile){var trans=platform.windowHeight()-platform.kbsize;g.setTransform(this.element,0,trans,time,"ease-out"),setTimeout(function(){this.selectedIndex(-1),this.isVisible(!1),g.isKeyboardOpen&&g.keyboardToolbar.isVisible.set(!0),this.clear(),MobileUI.resetTopBarMode()}.bind(this),time)}else this.selectedIndex(-1),this.isVisible(!1);Hotkeys.popStack(this.__hotkeys),this.__hotkeys=void 0,tracker.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseAutocomplete})}},onkeydown:function onkeydownFn(e){if(!this.isEnabled)return!0;if(0===this.items().length||!this.isVisible()||this.exactMatch()&&e.normCode!==KeyCode.Escape)return!0;if(e.normCode===KeyCode.UpArrow||e.normCode===KeyCode.DownArrow){if(this.items().length>1){var newIndex=this.selectedIndex()+(e.normCode===KeyCode.DownArrow?1:-1);this.selectedIndex(0>newIndex?this.items().length+newIndex:newIndex>=this.items().length?newIndex%this.items().length:newIndex);var listEle=document.getElementById("autocompleteItems");return g.scrollIntoView(listEle.children[this.selectedIndex()],200),!1}this.hide()}else{if(e.normCode===KeyCode.Enter){if(this.selectedIndex()>=0){var item=this.items()[this.selectedIndex()];this.onTapped(this._provider.getItemText(item),this._provider.getItemTextLength(item),!0)}return this.hide(),!1}if(e.normCode===KeyCode.Escape)return this.hide(),!1}return!0},onTap:{onClick:function onClickFn(e){var item=g.dataFor(e.srcElement);item&&item!==this&&this.onTapped(this._provider.getItemText(item),this._provider.getItemTextLength(item),!0),platform.mobile&&g.handlerPreventStop(e)}},onTapped:function onTappedFn(text,textLength,hide,hasAddedSpace){try{g.PAssert(5030,!text||g.isString(text),"Text must be a valid string",text)}catch(PERR){g.reportError(PERR)}try{g.PAssert(5031,textLength,g.isNumber(textLength),"TextLength must be a valid number",textLength)}catch(PERR){g.reportError(PERR)}try{g.PAssert(5032,void 0===hide||g.isBoolean(hide),"Hide must be a boolean value",hide)}catch(PERR){g.reportError(PERR)}if(this.trackingTag&&(this.text(text),this._activeOwner)){var insertText=hasAddedSpace?text:text+" ";this._activeOwner.onAutocompleteTapped(insertText,insertText.length,this.trackingTag)}hide&&this.hide()},find:function findFn(words,start,num,forceSpace){if(start+num>words.length-1)return void 0;if(this.mode()===ACProvider.None)return void 0;if(""===words[start]&&""===words[start+1])return void 0;try{g.PAssert(5033,this._provider,"Must have a valid AC provider in use")}catch(PERR){g.reportError(PERR)}var text=words[start];isNaN(num)&&(num=0);for(var i=0;num>i&&words[start+i+1];i++)text+=" "+words[start+i+1];forceSpace&&void 0!==words[start+num+1]&&(text+=" ");var MaxMatchCount=22,results=this._provider.findMatchLike(text,MaxMatchCount);return results.length>0?this.find(words,start,num+1,forceSpace)||{text:text,results:results}:void 0},setItems:function setItemsFn(items){this.selectedIndex()>=items.length&&this.selectedIndex(0),this.items(items)},checkPrefixes:function checkPrefixesFn(word){for(var i=0;i<this._prefixes.length;i++)if(word.startsWith(this._prefixes[i]))return this._prefixes[i].length},getAutocompleteInfo:function getAutocompleteInfoFn(words,selectionStart){for(var provider=ACProvider.None,lineIndex=0,startWord=-1,startChar=-1,prefixLength=0,prefix,i=0;i<words.length&&selectionStart>=lineIndex;++i){var word=words[i],tempLength=this.checkPrefixes(word);tempLength&&(startWord=i,startChar=lineIndex,prefixLength=tempLength),lineIndex+=word.length+1}return startWord>=0&&(prefix=words[startWord].substr(0,prefixLength),provider=this.getProviderForPrefix(prefix),words[startWord]=words[startWord].substr(prefixLength)),{startWord:startWord,startChar:startChar,provider:provider,prefix:prefix,prefixLength:prefixLength}},update:function updateFn(params){if(!this.isEnabled)return!0;try{g.PAssert(5034,params,"Params must be passed in")}catch(PERR){g.reportError(PERR)}this.lastParams=params,this._activeOwner=params.owner||this._activeOwner,this._activeIndex=params.index;var text=this._activeOwner.getACText()||"",selectionStart=params.start,fromArrows=params.fromArrows;this.trackingTag=!1;var words=text.split(" "),ch=text[params.start-1],forceSpace=" "===ch,acInfo;if(acInfo=this._activeOwner.getAutocompleteInfo?this._activeOwner.getAutocompleteInfo(words,selectionStart):this.getAutocompleteInfo(words,selectionStart),this.setProviderMode(acInfo.provider),acInfo.provider!==ACProvider.None){try{g.PAssert(5035,selectionStart>=acInfo.startChar,"Start of autocomplete word must be before selection start")}catch(PERR){g.reportError(PERR)}var result=this.find(words,acInfo.startWord,0,forceSpace),addAmount=acInfo.prefixLength;" "===ch&&text[params.start-2]!==acInfo.prefix&&addAmount++;var doShow=!1,acEnd=result&&acInfo.startChar+addAmount+result.text.length;if(result&&selectionStart>acInfo.startChar&&acEnd>=selectionStart){var exactMatch=this._provider.findMatchExact(result.text);this.exactMatch(!!exactMatch),this.selectedIndex(0),exactMatch?" "!==ch&&this.mode()===ACProvider.Contact&&acEnd!==selectionStart&&(this.setItems([exactMatch]),this.trackingTag=!0,fromArrows||platform.mobile||(doShow=!0)):(1!==result.results.length||result.results[0]!==result.text)&&(this.trackingTag={text:result.text,index:acInfo.startChar+acInfo.prefixLength,replaceLength:this._provider.autocompleteReplace?acInfo.prefixLength:0,length:result.text.length},this.text(result.text),this.setItems(result.results),fromArrows||(doShow=!0))}else if(!(result||this.mode()!==ACProvider.Contact||g.settings.get(Settings.syncContacts)||fromArrows||g.isDemoMode())){for(var hasSpace=!1,i=acInfo.startChar;selectionStart>i;++i)if(" "===text[i]){hasSpace=!0;break}hasSpace||(this.trackingTag=void 0,this.contactsEnabled(!1),doShow=!0)}doShow&&this.show()}if(this.autocompleteDates.nextDateWord(this.autocompleteDates.NextWordOptions.None),this.trackingTag===!1){try{g.PAssert(5036,!doShow,"Should never show then hide autocomplete in the same call")}catch(PERR){g.reportError(PERR)}this.hide()}},isItemSelected:function isItemSelectedFn(index){return this.selectedIndex()===index()},renderItem:function renderItemFn(item){var searchText=this.text(),itemText=this._provider.getItemStyledText(item,searchText);if(void 0!==itemText&&void 0!==searchText&&searchText.length>0){var index;g.isString(itemText)?index=itemText.toUpperCase().indexOf(searchText.toUpperCase()):(index=itemText.index,itemText=itemText.text);var newText;return newText=index>=0?itemText.substr(0,index)+"<b>"+itemText.substr(index,searchText.length)+"</b>"+itemText.substr(index+searchText.length):itemText}return g.isString(itemText)?itemText:itemText.text},onMouseover:function onMouseoverFn(UNUSED,e){if(this.showList()){var index=0,ele=e.srcElement||e.target,item=g.dataFor(ele);if(item&&item!==this){index=this.items.indexOf(item);try{g.PAssert(5037,index>=0,"Must be able to compute a valid selection index")}catch(PERR){g.reportError(PERR)}this.selectedIndex(index)}}},onTapEnableContacts:{onClick:function onClickFn(e){g.vmSettings.enableSyncContacts(function(value){if(value){this.contactsEnabled(!0),g.settings.set(Settings.syncContacts,!0);var last=this.lastParams;last&&(this.update(this.lastParams),this.show(this.completionElement))}}.bind(this)),e.preventDefault(),e.stopImmediatePropagation()}}},VMAutocomplete}),define("VMTooltip",["ko","Constants","globals","platform","DragDrop","Sel","Dispatcher"],function(ko,C,g,platform,DragDrop,Sel,Dispatcher){function VMTooltip(){this.displayElement=void 0,this.element=void 0,this.arrowElement=void 0,this.isSticky=!1,this.displayTimeout=void 0,this.extraTimeout=void 0,this.displayText=ko.observable(""),this.displayExtra=ko.observable(""),this.arrowClass=ko.observable("notVisible"),this.arrowX=ko.observable(0),this.tipExtras={},g.runOnLoad(function(){g.applyBindings(this,"tooltip")}.bind(this)),this.init()}var displayDelay=C.TooltipDelay,extraDelay=1e3;return VMTooltip.prototype={init:function initFn(){},onLoad:function onLoadFn(){this.element=document.getElementById("tooltip"),this.tooltipArrow=document.getElementById("tooltipArrow"),platform.touch||(Dispatcher.listen("mouseover",this.handleEleOver.bind(this)),Dispatcher.listen("mouseout",this.handleEleOut.bind(this)),window.addEventListener("mouseout",this.windowOut.bind(this)),document.addEventListener("mousedown",this.hideTip.bind(this),!0))},windowOut:function windowOutFn(e){(e.pageX>window.innerWidth||e.pageY>window.innerHeight||e.pageX<0||e.pageY<0)&&this.hideTip()},register:function registerFn(elem,text){this.update(elem,text)},update:function updateFn(elem,text){elem.setAttribute("tooltip",text)},tipIn:function tipInFn(e){this.displayElement===e.target||DragDrop.isDragging||Sel.isMouseDown()||(clearTimeout(this.displayTimeout),this.displayTimeout=setTimeout(this.displayTip.bind(this),displayDelay,{element:e.target,offset:{y:5}}))},adjustBounds:function adjustBoundsFn(options){var arrowSize=40,time=0,windowBounds=document.documentElement.getBoundingClientRect(),targetBounds;if(this.displayElement)targetBounds=this.displayElement.getBoundingClientRect();else if(options&&options.bottom)targetBounds={left:0,width:platform.windowWidth(),top:platform.windowHeight()},g.vmMain.gdriveStatus()!==DriveStatus.Online&&(targetBounds.top-=20),options.above=!0;else try{g.PAssert(5038,!1,"Adjust bounds had no valid options for determining an offset",options)}catch(PERR){g.reportError(PERR)}try{g.PAssert(5039,targetBounds,"Adjust bounds has no valid targetBounds",this.displayElement)
}catch(PERR){g.reportError(PERR)}if(targetBounds){var width=g.width(this.element),x=targetBounds.left+targetBounds.width/2-width/2,y;y=options&&options.above?targetBounds.top-g.height(this.element):targetBounds.bottom;var offset=options&&options.offset;offset?(offset.x?x+=offset.x:offset.right?x=windowBounds.right-width-offset.right:offset.left&&(x=offset.left),offset.y&&(y+=offset.y)):options&&options.above?y-=5:y+=5;var newX=x;x+width>windowBounds.right?newX=windowBounds.right-width-4:0>x&&(newX=4);var arrow=options&&options.arrow;if(arrow){var arrowX=(width-arrowSize)/2;newX!==x&&(arrowX+=x-newX),this.arrowClass(arrow),this.arrowX(arrowX+"px")}else this.arrowClass("notVisible");options&&options.time&&(time=options.time),newX=Math.round(newX),y=Math.round(y),g.setTransform(this.element,newX,y,time)}},displayTip:function displayTipFn(options){try{g.PAssert(5040,options,"When display a tooltip, must pass in some info")}catch(PERR){g.reportError(PERR)}if(options&&!this.isSticky&&this.element){clearTimeout(this.displayTimeout),this.displayTimeout=void 0,clearTimeout(this.extraTimeout),this.extraTimeout=void 0;var element=this.displayElement=options.element,text;if(!element||element.offsetWidth>0&&element.offsetHeight>0){options.text?text=options.text:element&&(text=element.getAttribute("tooltip")||element.getAttribute("data-tooltip")),this.isSticky=options.sticky;try{g.PAssert(5041,text,"When display a tooltip, elements should always have valid data set")}catch(PERR){g.reportError(PERR)}if(text&&(this.displayText(text),this.element.style["max-width"]=options.maxWidth?options.maxWidth+"px":"",options.sticky&&(this.element.style.padding="12px 16px"),this.adjustBounds(options),!platform.mobile)){try{g.PAssert(5042,this.displayElement,"Display element must be valid")}catch(PERR){g.reportError(PERR)}this.extraTimeout=setTimeout(this.showExtra.bind(this),extraDelay)}}}},tipOut:function tipOutFn(e){var isAncestor=!1;e.target&&(isAncestor=g.isAncestor(e.target,this.element)),isAncestor||e.target===this.element||this.hideTip()},handleEleOver:function handleEleOverFn(e){try{g.PAssert(5043,g.isDOMNode(e.target),"Must have a valid DOM node: ",typeof e.target)}catch(PERR){g.reportError(PERR)}var infoText=e.target&&e.target.getAttribute&&(e.target.getAttribute("tooltip")||e.target.getAttribute("data-tooltip"));infoText&&this.tipIn(e)},handleEleOut:function handleEleOutFn(e){this.tipOut(e)},showExtra:function showExtraFn(){var extraString;try{g.PAssert(5044,this.displayElement,"There should be a display element when showing extra information")}catch(PERR){g.reportError(PERR)}if(this.displayElement){if(this.displayElement.id){var idString="#"+this.displayElement.id;this.tipExtras[idString]&&(extraString=idString)}if(!extraString)for(var i=0;i<this.displayElement.classList.length;++i){var classString="."+this.displayElement.classList[i];if(this.tipExtras[classString]){extraString=classString;break}}if(extraString){var extraInfo=this.tipExtras[extraString];extraInfo&&(this.displayExtra(extraInfo),this.adjustBounds())}clearTimeout(this.extraTimeout),this.extraTimeout=void 0}},hideTip:function hideTipFn(){this.isSticky||(this.displayElement=void 0,clearTimeout(this.displayTimeout),this.displayTimeout=void 0,clearTimeout(this.extraTimeout),this.extraTimeout=void 0,this.displayText(""),this.displayExtra(""))}},VMTooltip}),define("AppCache",["globals","platform"],function(g,platform){function AppCache(){this.updateWaitTime=g.minutes(120),this.notifiedOfNew=!1,this.isFinished=!1,this.downloadingTimeout=0,this.lastUpdate=0,this.startStatus=window.applicationCache?window.applicationCache.status:-2,this.continuedUpdate=!1,this.updateActionDone=!1,this.fnToRun=[],this.requiredUpdate=!1,this.appUpdatePending=!1,this.runUpdate=!1,this.init()}return AppCache.prototype={init:function initFn(){log("Cache Status: "+this.startStatus),window.applicationCache?(window.applicationCache.addEventListener("noupdate",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("cached",this.onFirstUpdateReady.bind(this)),window.applicationCache.addEventListener("downloading",this.onUpdateDownloading.bind(this)),window.applicationCache.addEventListener("updateready",this.onUpdateReady.bind(this)),window.applicationCache.addEventListener("obsolete",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("error",this.onUpdateError.bind(this)),window.applicationCache.status>=window.applicationCache.UPDATEREADY||document.documentElement.attributes.getNamedItem("manifest")||this.onCacheLoadFinished()):this.onCacheLoadFinished()},isVisible:function isVisibleFn(value){value&&g.isDemoMode()&&g.reload(!0)},update:function updateFn(){if(Date.now()-this.lastUpdate>this.updateWaitTime&&window.applicationCache.status===window.applicationCache.IDLE){this.lastUpdate=Date.now();try{applicationCache.update()}catch(err){}}},checkForUpdate:function checkForUpdateFn(forceUpdate,runUpdate){this.requiredUpdate=!!forceUpdate,this.runUpdate=!!runUpdate,this.appUpdatePending?this.appUpdatePending&&this.runUpdate&&g.reload(!0):this.update()},endRunUpdate:function endRunUpdateFn(){this.runUpdate=!1},runOnFinish:function runOnFinishFn(cb,isTerminal){try{g.PAssert(5045,0===this.fnToRun.length,"Only a single callback is allowed to be run at this point.")}catch(PERR){g.reportError(PERR)}this.isFinished?setTimeout(cb,0):this.fnToRun.push(cb)},onUpdateReady:function onUpdateReadyFn(){log("Cache: New version available"),this.appUpdatePending=!0,this.startStatus===window.applicationCache.UNCACHED&&log("Cache Update from UNCACHED state. ERROR."),this.onCacheLoadFinished(),this.updateAction()},onFirstUpdateReady:function onFirstUpdateReadyFn(){log("Cache: first update")},onUpdateError:function onUpdateErrorFn(ev){platform.demo||g.vmMain&&!g.vmMain.isOnline()||log("Update Error: ",ev),this.isVisible(!1),this.onCacheLoadFinished()},onUpdateDownloading:function onUpdateDownloadingFn(){log("Cache: New version downloading")},onCacheLoadFinished:function onCacheLoadFinishedFn(){if(log("Cache: No update"),!this.isFinished){this.isFinished=!0;for(var i=0;i<this.fnToRun.length;++i)this.fnToRun[i]()}},notifyOfUpdate:function notifyOfUpdateFn(){this.notifiedOfNew||(this.notifiedOfNew=!0,g.setAppCacheUpdateState(!0),this.startStatus!==window.applicationCache.UNCACHED&&this.isVisible(!0))},updateAction:function updateActionFn(){this.runUpdate||!platform.isPageVisible()?g.reload(!0):this.requiredUpdate?g.menus.alert({text:"A software update is required to continue. Please reload to update.",actionText:"RELOAD",callback:g.reload}):this.isVisible(!0),g.sendEvent("AppCache","Update")}},AppCache}),define("NativeAPI",["globals","util"],function(g,util){function NativeAPI(name){try{g.PAssert(5046,void 0===window.__MoodoBridge[name],"Registering an Inbound API that already exists on the window object",name)}catch(PERR){g.reportError(PERR)}this._name=name,this._publicObj={},this._privateObj={},window.__MoodoBridge[name]=this._publicObj,this.init()}return NativeAPI.prototype={init:function initFn(){},_createWrapper:function _createWrapperFn(fn){function wrapper(){try{return fn.apply(this,arguments)}catch(err){g.reportError(err)}}return wrapper},registerFunction:function registerFunctionFn(name,fn,isPublic){try{g.PAssert(5047,name,"Name must be provided to register function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5048,fn,"A valid function must be provided to register")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5049,void 0===this._privateObj[name],"Re-registering an api function on private obj",name)}catch(PERR){g.reportError(PERR)}try{g.PAssert(5050,void 0===this._publicObj[name],"Re-registering an api function on public obj",name)}catch(PERR){g.reportError(PERR)}this._privateObj[name]=fn.bind(this._privateObj),isPublic&&(this._publicObj[name]=this._createWrapper(this._privateObj[name]))},registerVariable:function registerVariableFn(name,value,isPublic){try{g.PAssert(5051,name,"Name must be provided to register variable")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5052,!isPublic,"Public variables are not currently supported")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5053,void 0===this._privateObj[name],"Re-registering an api variable on private obj")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5054,void 0===this._publicObj[name],"Re-registering an api variable on public obj")}catch(PERR){g.reportError(PERR)}this._privateObj[name]=value}},util.defineBase(NativeAPI),NativeAPI}),define("NativeOutAPI",["globals","util"],function(g,util){function NativeOutAPI(name){this._name=name,this._apiLoaded=!1,this._apiError=!1,this._listeners=void 0,this._requiredFns=[],this._missingFns=void 0,this.init()}var checkTimeout=1e3;return NativeOutAPI.prototype={init:function initFn(){g.isObject(window[this._name])?this.onAPILoaded():(util.forceBind("_checkAPI",this),setTimeout(this._checkAPI,checkTimeout))},_checkAPI:function _checkAPIFn(){try{g.PAssert(5055,!this._apiLoaded,"Should not be checking for API load if already loaded")}catch(PERR){g.reportError(PERR)}g.isObject(window[this._name])&&this.onAPILoaded(),this._apiLoaded||setTimeout(this._checkAPI,checkTimeout)},onAPILoaded:function onAPILoadedFn(){this._apiLoaded=!0;for(var i=0;i<this._requiredFns.length;++i)g.isFunction(window[this._name][name])||(this._apiError=!0,this._addMissingFn(name));this.notifyListeners()},requestNotification:function requestNotificationFn(cb){this._apiLoaded?setTimeout(cb,0):this._listeners?this._listeners.push(cb):this._listeners=[cb]},notifyListeners:function notifyListenersFn(){try{g.PAssert(5056,this._apiLoaded,"API must be loaded to notify listeners")}catch(PERR){g.reportError(PERR)}if(this._listeners)for(var i=0;i<this._listeners.length;++i)this._listeners[i]();this._listeners=void 0},requireFunction:function requireFunctionFn(name,optional){try{g.PAssert(5057,this._requiredFns.indexOf(name)<0,"Should not double require a single function")}catch(PERR){g.reportError(PERR)}this._requiredFns.push(name),this._apiLoaded&&(g.isFunction(window[this._name][name])||optional||(this._apiError=!0,this._addMissingFn(name)))},_addMissingFn:function _addMissingFnFn(name){if(this._missingFns){try{g.PAssert(5058,this._missingFns.indexOf(name)<0,"Should not be missing the same function multiple times")}catch(PERR){g.reportError(PERR)}this._missingFns.push(name)}else this._missingFns=[name]},hasOptionalFunction:function hasOptionalFunctionFn(name){try{g.PAssert(5059,this._requiredFns.indexOf(name)>=0,"Must be querying for a registered function")}catch(PERR){g.reportError(PERR)}return window[this._name]?!!window[this._name][name]:!1},call:function callFn(name){try{g.PAssert(5060,this._apiLoaded,"Trying to call an API function before it is loaded",name)}catch(PERR){g.reportError(PERR)}if(this._apiLoaded){var args=Array.prototype.slice.call(arguments,1);try{return window[this._name][name].apply(window[this._name],args)}catch(err){g.reportError(err)}}return void 0}},util.defineBase(NativeOutAPI),NativeOutAPI}),define("NativeBridge",["globals","platform","tracker","android","goog","gdata","NativeAPI","NativeOutAPI","Dispatcher","Multiselect","edit"],function(g,platform,tracker,android,goog,gdata,NativeAPI,NativeOutAPI,Dispatcher,Multiselect,edit){function NativeBridge(){if(platform.app)try{this.backlog=[],this._iOS7Queue=[],this._iOS7QueueTimeout=void 0,this.flushingBacklog=!1,this.isPokingBackground=!1,this.setupFns=[],this.setupFns[AppPlatform.iOS]=this.setupiOS.bind(this),this.setupFns[AppPlatform.Android]=this.setupAndroid.bind(this),this.setupFns[AppPlatform.WinPhone]=void 0,this.setupFns[AppPlatform.Chrome]=this.setupChrome.bind(this),this.setupFns[AppPlatform.Electron]=this.setupElectron.bind(this),this.sendFns=[],this.sendFns[AppPlatform.iOS]=this.sendToAppiOS.bind(this),this.sendFns[AppPlatform.Android]=this.sendToAppAndroid.bind(this),this.sendFns[AppPlatform.WinPhone]=void 0,this.sendFns[AppPlatform.Chrome]=this.sendToAppChrome.bind(this),this.sendFns[AppPlatform.Electron]=this.sendToAppElectron.bind(this),this.setupFn=this.setupFns[platform.appPlatform],this.sendFn=this.sendFns[platform.appPlatform],this.init(),this._isEnabled=!0}catch(err){log("Native API Bridge Disabled"),g.reportError(err)}else this._isEnabled=!1;if(this._embedBridge=void 0,platform.app||platform.embed){try{g.PAssert(5061,void 0===window.__MoodoBridge,"Must not have a previous bridge in place")}catch(PERR){g.reportError(PERR)}window.__MoodoBridge={},this._canRegisterAPIs=!0,this._inboundAPIs={},this._outboundAPIs={}}}return NativeBridge.prototype={init:function initFn(){try{g.PAssert(5062,this.setupFn,"Must have a valid setup function")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5063,this.sendFn,"Must have a valid send function")}catch(PERR){g.reportError(PERR)}this.setupFn&&this.sendFn&&(this.initAppEvents(),this.setupFn(),this.backlog=g.nativeBacklog,this.flushBacklog(),window.__testNative=function(method,data){log("Sending To App: "+method),this.nativeBridge.sendToApp(method,data)}.bind(this))},isEnabled:function isEnabledFn(){return this._isEnabled},flushBacklog:function flushBacklogFn(){this.flushingBacklog=!0;for(var i=0;i<this.backlog.length;++i){var entry=this.backlog[i];this.sendToApp(entry.method,entry.data)}this.flushingBacklog=!1},addToBacklog:function addToBacklogFn(method,data){try{g.PAssert(5064,!this.flushingBacklog,"Should never be adding to backload while flushing it")}catch(PERR){g.reportError(PERR)}this.flushingBacklog||this.backlog.push({method:method,data:data})},registerEmbedBridge:function registerEmbedBridgeFn(bridge){try{g.PAssert(5065,bridge,"Must supply a valid embed bridge")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5066,platform.embed,"Must be embedded")}catch(PERR){g.reportError(PERR)}this._embedBridge=bridge},hasEmbedBridge:function hasEmbedBridgeFn(){return!!this._embedBridge},sendToEmbed:function sendToEmbedFn(method,data){try{g.PAssert(5067,this.hasEmbedBridge(),"Must have a valid embed bridge to send message: ",method)}catch(PERR){g.reportError(PERR)}this._embedBridge.handleEmbedMessage(method,data)},registerInboundAPI:function registerInboundAPIFn(name){try{g.PAssert(5068,!this._inboundAPIs[name],"Should not have already registered an outbound API with this name")}catch(PERR){g.reportError(PERR)}if(this._canRegisterAPIs){var api=new NativeAPI(name);return this._inboundAPIs[name]=api,api}return void 0},registerOutboundAPI:function registerOutboundAPIFn(name){try{g.PAssert(5069,!this._outboundAPIs[name],"Should not have already registered an outbound API with this name")}catch(PERR){g.reportError(PERR)}if(this._canRegisterAPIs){var api=new NativeOutAPI(name);return this._outboundAPIs[name]=api,api}return void 0},initAppEvents:function initAppEventsFn(){window.appEvents=this.appEvents,window.reportLowMemory=this.appEvents.reportLowMemory,window._SENDJSMESSAGE_=this.handleNativeMessage},setupChrome:function setupChromeFn(){window.addEventListener("message",this.onChromeMessage.bind(this))},setupAndroid:function setupAndroidFn(){},setupiOS:function setupiOSFn(){this.setupiOSUI(),gdata.registerSaveNotify(this.onSaveChange.bind(this))},setupiOSUI:function setupiOSUIFn(){this.iframeApp=document.createElement("IFRAME"),this.iframeApp.setAttribute("height","1px"),this.iframeApp.setAttribute("width","1px"),this.iframeApp.id="appComm",document.documentElement.appendChild(this.iframeApp)},setupElectron:function setupElectronFn(){this.ipcBridge=electronRequire("electron").ipcRenderer,this.ipcBridge.on("appEvents",function(e,msg){this.handleNativeMessage(msg.action,msg.data)}.bind(this))},onSaveChange:function onSaveChangeFn(numChanged){this.isPokingBackground&&(this.sendToApp("pokeChanged",numChanged>0?"true":"false"),this.isPokingBakground=!1)},onChromeMessage:function onChromeMessageFn(e){if(0===e.origin.indexOf("chrome"))if(this.appWindow&&this.appOrigin||(this.appWindow=event.source,this.appOrigin=event.origin,setTimeout(this.flushBacklog.bind(this),0)),e.data&&g.isString(e.data)){var index=e.data.indexOf(":"),action=e.data.substr(0,index),data=e.data.substr(index+1);switch(action){case"chrome":switch(log("Chrome Message: ",action,"->",data),data){case"start":this.sendToApp("loaded");break;default:log("Unhandled Chrome Message: ",data)}break;default:this.handleNativeMessage(action,data)}}else log("Invalid Chrome Message: ",data)},sendToApp:function sendToAppFn(method,data){try{g.PAssert(5070,platform.app,"Only use native bridge when creating an app")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5071,this.sendFn,"Must have a valid send method for the native bridge")}catch(PERR){g.reportError(PERR)}var returnValue=!1;try{var dataString;data&&(dataString=g.isString(data)?data:JSON.stringify(data)),this.sendFn&&(this.sendFn(method,dataString),returnValue=!0)}catch(err){g.reportError(err)}return returnValue},sendToAppiOS:function sendToAppiOSFn(method,data){platform.ioswk?this.sendToAppiOS8(method,data):this.sendToAppiOS7(method,data)},sendToAppiOS7:function sendToAppiOS7Fn(method,data){if(this.iframeApp){var href="duchess://"+method;void 0!==data&&(href+="//"+data),this._addiOS7Queue(href)}else this.addToBacklog(method,data)},_addiOS7Queue:function _addiOS7QueueFn(href){this._iOS7Queue.push(href),this._iOS7QueueTimeout||(this._iOS7QueueTimeout=setTimeout(this._pumpiOS7Queue.bind(this),17))},_pumpiOS7Queue:function _pumpiOS7QueueFn(){var href=this._iOS7Queue.shift();try{g.PAssert(5072,href,"Must have a valid href",href)}catch(PERR){g.reportError(PERR)}this.iframeApp.src=href,this._iOS7QueueTimeout=this._iOS7Queue.length>0?setTimeout(this._pumpiOS7Queue.bind(this),17):void 0},sendToAppiOS8:function sendToAppiOS8Fn(method,data){if(window.webkit.messageHandlers&&window.webkit.messageHandlers.MoodoEvents){var str=method;void 0!==data&&(str+="//"+data),window.webkit.messageHandlers.MoodoEvents.postMessage(str)}else this.addToBacklog(method,data)},sendToAppAndroid:function sendToAppAndroidFn(method,data){window.AppInterface&&void 0!==window.AppInterface.sendAppMessage&&null!==window.AppInterface.sendAppMessage?window.AppInterface.sendAppMessage(method,data):this.addToBacklog(method,data)},sendToAppChrome:function sendToAppChromeFn(method,data){if(this.appWindow){var msg=method+":";void 0!==data&&(msg+=data),this.appWindow.postMessage(msg,"*")}else this.addToBacklog(method,data)},sendToAppElectron:function sendToAppElectronFn(method,data){if(this.ipcBridge){var msg=method+":";void 0!==data&&(msg+=data),this.ipcBridge.send("moodo-message",msg)}else this.addToBacklog(method,data)},handleNativeMessage:function handleNativeMessageFn(method,data){try{window.appEvents[method]?window.appEvents[method](data):method.startsWith("-")||g.reportError(new Error("Calling invalid JS method from native: "+method))}catch(err){g.reportError(err)}},appEvents:{undo:function undoFn(){log("Native Undo"),g.sendEvent("Hotkey","ShakeUndo"),tracker.undoAction()},redo:function redoFn(){log("Native Redo"),g.sendEvent("Hotkey","ShakeRedo"),tracker.redoAction()},kbsize:function kbsizeFn(e){e>0&&e!==platform.kbsize&&(platform.setKBSize(e),g.keyboardToolbar&&g.keyboardToolbar.updatePosition())},closeKeyboard:function closeKeyboardFn(){android.isEnabled()&&android.finishInput(!1),g.closeKeyboard(),Multiselect.reset()},enterBackground:function enterBackgroundFn(){g.AppCache&&g.AppCache.checkForUpdate(!1,!0),g.onunload()},enterForeground:function enterForegroundFn(){gdata.poke(),g.checkForRemoteChanges(),g.AppCache&&g.AppCache.endRunUpdate(),Dispatcher.fireEvent("enterForeground",[])},pokeBackground:function pokeBackgroundFn(){g.nativeBridge.isPokingBackground=!0,gdata.poke()},reportLowMemory:function reportLowMemoryFn(msg){g.handleLowMemory(msg)},statusBarTap:function statusBarTapFn(){g.focusedPane&&g.focusedPane.setScrollOffset(0,ScrollDuration.Default)},features:function featuresFn(features){try{var featuresObj=JSON.parse(features);featuresObj.oauth&&goog.addOAuthMethod(OAuthSchemeType.Native),featuresObj.customKeyboard&&android.isEnabled()&&android.notifyCustomKeyboard(featuresObj.customKeyboard),featuresObj.version&&platform.recordAppSubVersion(featuresObj.version);try{g.PAssert(5073,featuresObj.notifications,"Notifications should always be available on all platforms")}catch(PERR){g.reportError(PERR)}}catch(err){g.reportError(err)}},notifyOAuth:function notifyOAuthFn(info){try{goog.handleNativeOAuthResponse(JSON.parse(info))}catch(err){g.reportError(err)}},onMenuClick:function onMenuClickFn(id){if("NewMessage"===id){var mailPlugin=g.vmMain.getDefaultEmailPlugin();mailPlugin.isEnabled()?g.menus.openComposeEmail(mailPlugin):g.toasts.pushMessage(MessaegeID.NeedGmailPermission)}else if("NewPane"===id){var el=g.element("addPaneButton");g.menus.openContextMenuReact({componentName:"ReactContextMenuAddPane",element:el})}else"Preferences"===id&&g.menus.openSettings()},selectAll:function selectAllFn(){g.focusedPane&&edit.handleSelectAll(g.focusedPane)}}},NativeBridge}),define("BillingManager",["globals","Constants","util","platform","International","goog","gdata","Observable","ObservableComputed","ObservableArray","Trigger","AccountManager","DisplaySettings","react","ReactInviteSection"],function(g,C,util,platform,International,goog,gdata,Observable,ObservableComputed,ObservableArray,Trigger,AccountManager,DisplaySettings,React,ReactInviteSection){function BillingManager(){this._premiumStatus=new Observable(PremiumStatus.Unknown),overridePremiumStatus&&this._premiumStatus.set(PremiumStatus.Active),this.hasPremiumFeaturesObservable=new ObservableComputed([this._premiumStatus],function(){return this.hasPremiumFeatures()}.bind(this)),this._lastSignupError=-1,this._earlyAdopter=!1,this._inviteCode=void 0,this._referredBy=void 0,this._joinDate=void 0,this._premiumStartDate=void 0,this._premiumEndDate=void 0,this._nextBillingDate=void 0,this._referralCount=new Observable(0),this._usedReferrals=0,this._nextMonthReferrals=0,this._nonReferralDiscounts=0,this._trialStart=void 0,this._trialDuration=void 0,this._pricingSelected=C.Pricing.None,this._billingIdentifier=void 0,this._hasValidBillingData=new Observable(!1),this.daysLeftInTrial=new Observable(-1),this.communityBlocks=[],this.alreadyBlocks=[],this.thisBlocks=[],this.nextBlocks=[],this.triggerBlocksUpdated=new Trigger,this.inviteCodeError=new Observable,this.inviteEmailError=new Observable,this.inviteEmailSuccess=new Observable,this.init()}var premiumPrices=["4.95","49.95","7","69"],premiumWhitelist=[],NumReferralsTo100=5,EarlyAccessRequirement=5,overridePremiumStatus=!1||platform.demo,MS_IN_DAY=864e5;return BillingManager.prototype={init:function initFn(){if(this._premiumStatus.listen(function(newValue,oldValue){g.vmMain&&g.vmMain.pluginManager&&(this.hasPremiumFeatures()?(g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.EarlyAccess),g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.PremiumSub)):this.hasEarlyAccess()&&g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.EarlyAccess)),newValue!==oldValue&&oldValue&&DisplaySettings.onSettingChanged()}.bind(this)),this._referralCount.listen(function(newValue){g.vmMain&&g.vmMain.pluginManager&&newValue>=EarlyAccessRequirement&&g.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.EarlyAccess)}.bind(this)),!overridePremiumStatus){var localStoredPremiumStatus=g.settings.get(Settings.premiumStatus),showPremiumDialog=util.getURLParam("premium");if(void 0!==showPremiumDialog&&util.removeURLParam("premium",!0),void 0!==localStoredPremiumStatus){var trialStart=g.settings.get(Settings.trialStart)||Date.now(),trialDuration=g.settings.get(Settings.trialDuration)||0;this._updateTrialDaysLeft(trialStart,trialDuration);var endDate=g.settings.get(Settings.premiumEndDate)||Date.now();this._premiumEndDate=new Date(endDate),this.setPremiumStatus(localStoredPremiumStatus),(localStoredPremiumStatus==PremiumStatus.Unknown||localStoredPremiumStatus==PremiumStatus.Never)&&showPremiumDialog&&setTimeout(function(){g.menus.openSettings(C.SettingsSections.Account)},100)}this.checkRemotePremiumStatus()}},checkRemotePremiumStatus:function checkRemotePremiumStatusFn(){try{g.PAssert(5074,!g.isDemoMode()||!1,"Should not be querying for premium status in demo mode")}catch(PERR){g.reportError(PERR)}this.onBillingIdentifierAvailable(function(){AccountManager.onUserAuthorized("me",function(){var signupInfo=goog.getCurrentUserSignupInfo(),requestData={email:this.getBillingIdentifier(),gid:signupInfo.full?signupInfo.full.id:void 0,fname:signupInfo.fname,lname:signupInfo.lname,lastTaskSync:g.settings.get(Settings.lastTaskSync)};g.XHR_PrivateAPI({type:"POST",path:"/billing/getStatus",data:requestData,requireAuth:!0,autoRetry:!0,maxRetries:6,cb:function cbFn(xhr){var hasInviteCode=util.hasURLParam("invite"),usedInviteCode=!1;if(xhr.status===C.HTTPStatusCode.Success&&xhr.response)try{AccountManager.setConnected();var statusData=JSON.parse(xhr.response).data;if(this.setBillingData(statusData),statusData.linkedAccounts)try{for(var i=0;i<statusData.linkedAccounts.length;++i){var account=statusData.linkedAccounts[i];AccountManager.updateServerLinkedAccount(account.email,account.gid,account.name,account.scopes,account.token)}}catch(err){g.reportError(err)}if(statusData.tasks&&g.vmMain.deferredTaskManager.notifyRemoteTasks(statusData.tasks),hasInviteCode){usedInviteCode=!0,g.sendEvent("Billing","URLReferralCode");var refCode=util.getURLParam("invite");g.XHR_PrivateAPI({type:"POST",path:"/sharing/setReferral",data:{email:this.getBillingIdentifier(),refCode:refCode},requireAuth:!0,autoRetry:!0,cb:function cbFn(xhrReferral){if(xhrReferral.status===C.HTTPStatusCode.Success){switch(g.toasts.clearMessage(MessageID.InviteFailure),g.toasts.clearMessage(MessageID.InviteInvalid),refCode.toUpperCase()){case"PRODUCTHUNT":g.toasts.pushMessage({text:"You have successfully applied your ProductHunt promotion. Thanks for checking out Moo.do!"});break;default:g.toasts.pushMessage(MessageID.InviteSuccess)}util.removeURLParam("invite",!0),this.checkRemotePremiumStatus()}else try{var referralData=JSON.parse(xhrReferral.response).data,specialCodes=["PRODUCTHUNT","UMICHEDU"];specialCodes.indexOf(refCode.toUpperCase())<0&&g.toasts.pushMessage(referralData.code===PrivateAPIErrorCodes.InvalidReferralCode||referralData.code===PrivateAPIErrorCodes.InvalidParameter?MessageID.InviteInvalid:MessageID.InviteFailure)}catch(referralParseErr){g.reportError(referralParseErr)}}.bind(this)})}if(statusData.premiumStatus===PremiumStatus.Trial){try{g.PAssert(5075,void 0!==statusData.trialStart,"Must have a valid trialStart set")}catch(PERR){g.reportError(PERR)}try{g.PAssert(5076,void 0!==statusData.trialDuration,"Must have a valid trialDuration set")}catch(PERR){g.reportError(PERR)}if(statusData.trialStart&&statusData.trialDuration)try{var trialStart=new Date(statusData.trialStart).getTime();g.settings.set(Settings.trialStart,trialStart),g.settings.set(Settings.trialDuration,statusData.trialDuration),this._updateTrialDaysLeft(trialStart,statusData.trialDuration)}catch(err2){g.reportError(err2)}else this.setPremiumStatus(PremiumStatus.TrialOver),g.settings.set(Settings.trialStart,Date.now()),g.settings.set(Settings.trialDuration,0);g.isFlagSet(statusData.loginFlags,C.LoginFlags.OldUserNewTrial)&&g.vmMain.oldUserNewTrial()}else if(statusData.premiumStatus===PremiumStatus.CanceledUser||statusData.premiumStatus===PremiumStatus.CanceledPastDue)if(statusData.premiumEndDate)try{var premiumEnd=new Date(statusData.premiumEndDate).getTime();g.settings.set(Settings.premiumEndDate,premiumEnd)}catch(err2){g.reportError(err2)}else g.settings.set(Settings.premiumEndDate,Date.now());else statusData.premiumStatus===PremiumStatus.TrialOver?(this.daysLeftInTrial.set(-1),g.isFlagSet(statusData.loginFlags,C.LoginFlags.TrialOver)&&this.notifyTrialOver()):statusData.premiumStatus===PremiumStatus.Active?(g.toasts.clearMessage(MessageID.TrialOver),g.settings.get(Settings.notifiedTrialOver)&&g.settings.set(Settings.notifiedTrialOver,!1)):g.isFlagSet(statusData.loginFlags,C.LoginFlags.NewUser)&&g.vmMain.runFirstRun()}catch(err){g.reportError(err)}else try{if(xhr.response){var statusData=JSON.parse(xhr.response);statusData.code===PrivateAPIErrorCodes.NoSignupFound?(usedInviteCode=!0,goog.onHaveUserSignupData(function(){g.sendEvent("Subscribe","NewUser"),g.reportSignup(goog.getCurrentUserEmail(),goog.getCurrentUserSignupInfo(),function(success){success?this.checkRemotePremiumStatus():this._reportRemoteStatusFailure()}.bind(this))}.bind(this))):this._reportRemoteStatusFailure()}else this._reportRemoteStatusFailure()}catch(err){this._reportRemoteStatusFailure(),g.reportError(err)}hasInviteCode&&!usedInviteCode&&g.toasts.pushMessage(MessageID.InviteFailure)}.bind(this)})}.bind(this))}.bind(this))},setLastSignupError:function setLastSignupErrorFn(code){this._lastSignupError=code},_reportRemoteStatusFailure:function _reportRemoteStatusFailureFn(){g.sendEvent("Billing","RemoteStatusFailure")},_updateTrialDaysLeft:function _updateTrialDaysLeftFn(trialStart,trialDuration){var remainingDays=trialDuration-Math.ceil((Date.now()-trialStart)/MS_IN_DAY);try{g.PAssert(5077,320>=remainingDays,"Sanity check on trial length",remainingDays)}catch(PERR){g.reportError(PERR)}this._trialStart=trialStart,this._trialDuration=trialDuration,this.daysLeftInTrial.set(remainingDays),this._premiumStatus.get()===PremiumStatus.Trial&&0>remainingDays?(this.setPremiumStatus(PremiumStatus.TrialOver),this.notifyTrialOver()):this._premiumStatus.get()===PremiumStatus.Trial&&5>remainingDays&&this.notifyTrialEndSoon()},getBillingIdentifier:function getBillingIdentifierFn(){if(!this._billingIdentifier){var user=goog.getCurrentUserEmail()||g.settings.get(Settings.activeUser);user&&(this._billingIdentifier=user)}return this._billingIdentifier},onBillingIdentifierAvailable:function onBillingIdentifierAvailableFn(cb){if(this._billingIdentifier)setTimeout(cb,0);else var infoSub=goog.authenticatedUserInfo.subscribe(function(){infoSub.dispose(),infoSub=void 0,setTimeout(cb,0)})},hasPremium:function hasPremiumFn(){return this._premiumStatus.get()===PremiumStatus.Active||this._premiumStatus.get()===PremiumStatus.PastDue},isTrialState:function isTrialStateFn(){return this._premiumStatus.get()===PremiumStatus.Trial||this._premiumStatus.get()===PremiumStatus.TrialOver},isCanceledState:function isCanceledStateFn(){return this._premiumStatus.get()===PremiumStatus.CanceledUser||this._premiumStatus.get()===PremiumStatus.CanceledPastDue},canceledUserHasPremiumAccess:function canceledUserHasPremiumAccessFn(){return this.isCanceledState()&&this.getPremiumEndDate().getTime()>Date.now()},isInFreeMonthAndPremium:function isInFreeMonthAndPremiumFn(){return(this.hasPremium()||this.canceledUserHasPremiumAccess())&&this._nonReferralDiscounts>=100},setBillingData:function setBillingDataFn(data){try{g.PAssert(5078,data,"Must have a valid data bundle")}catch(PERR){g.reportError(PERR)}this.setPremiumStatus(data.premiumStatus),this._earlyAdopter=data.earlyAdopter,this._loginFlags=data.loginFlags||C.LoginFlags.None,this._inviteCode=data.inviteCode,this._referredBy=data.referredBy,this._joinDate=data.joinDate?new Date(parseInt(data.joinDate)):new Date,this._premiumStartDate=data.premiumStartDate?new Date(parseInt(data.premiumStartDate)):new Date,this._premiumEndDate=data.premiumEndDate?new Date(parseInt(data.premiumEndDate)):new Date,this._nextBillingDate=data.nextBillingDate?new Date(parseInt(data.nextBillingDate)):new Date,this._referralCount.set(data.totalReferralCount||0),this._usedReferrals=data.totalReferralsUsed||0,this._nextMonthReferrals=data.nextMonthReferrals||0,this._trialStart=data.trialStart?new Date(parseInt(data.trialStart)):new Date,this._trialDuration=data.trialDuration||0,this._nonReferralDiscounts=data.nonReferralDiscounts||0,this.updatePremiumBlocks(),this._hasValidBillingData.set(!0)},setPremiumStatus:function setPremiumStatusFn(status){try{g.PAssert(5079,g.isNumber(status),"Status must be a valid number",status)}catch(PERR){g.reportError(PERR)}try{g.PAssert(5080,status>0&&8>status,"Should be a valid status identifier",status)
}catch(PERR){g.reportError(PERR)}var oldStatus=this._premiumStatus.get();status!==oldStatus&&(this._premiumStatus.set(status),g.settings.set(Settings.premiumStatus,status),g.fireCustomEvent("premiumStatusChanged"),g.setDimension(C.Analytics.Dimensions.PremiumStatus,status))},hasValidBillingData:function hasValidBillingDataFn(){return this._hasValidBillingData.get()},getPremiumStatus:function getPremiumStatusFn(){return this._premiumStatus.get()},getInviteCode:function getInviteCodeFn(){return this._inviteCode},getJoinDate:function getJoinDateFn(){return this._joinDate||new Date},getPremiumStartDate:function getPremiumStartDateFn(){return this._premiumStartDate||new Date},getPremiumEndDate:function getPremiumEndDateFn(){return this._premiumEndDate||new Date},getNextBillingDate:function getNextBillingDateFn(){return this._nextBillingDate||new Date},getActiveReferrals:function getActiveReferralsFn(){return this._nextMonthReferrals},getTotalReferrals:function getTotalReferralsFn(){return this._referralCount.get()},getUnusedReferrals:function getUnusedReferralsFn(){return this._referralCount.get()-this._usedReferrals-this._nextMonthReferrals},getPastReferrals:function getPastReferralsFn(){return this._usedReferrals},hasEarlyAccess:function hasEarlyAccessFn(){return this._referralCount.get()>=EarlyAccessRequirement||this.hasPremiumFeatures()||this.canceledUserHasPremiumAccess()},onTapCancelSubscription:function onTapCancelSubscriptionFn(e,cb){g.sendEvent("Billing","SubCancelTapped");var onDone=function(){cb&&g.isFunction(cb)&&cb()}.bind(this);return g.menus.confirm("Are you sure you want to cancel your subscription?",function(result){result?(g.sendEvent("Billing","SubCancelYES"),g.XHR_PrivateAPI({type:"POST",path:"/billing/cancel",data:{email:this.getBillingIdentifier()},requireAuth:!0,cb:function cbFn(xhr){var msg;try{var parsedResponse=JSON.parse(xhr.response)}catch(err){g.reportError(err)}if(200===xhr.status&&parsedResponse){var data=parsedResponse.data,premiumEnd=new Date(data.premiumEndDate).getTime();this._premiumEndDate=new Date(premiumEnd),g.settings.set(Settings.premiumEndDate,premiumEnd),this.setPremiumStatus(PremiumStatus.CanceledUser),msg="Your premium subscription has been canceled. Please contact support@moo.do if you need assistance."}else msg="There was a server error, please try again in a few minutes or contact support@moo.do.";g.menus.alert({text:msg,actionText:"OKAY"}),onDone()}.bind(this)})):(onDone(),g.sendEvent("Billing","SubCancelNO"))}.bind(this)),!0},onTapUpdatePaymentMethod:function onTapUpdatePaymentMethodFn(e,cb){g.menus.openModal(Modals.Billing,{isUpdate:!0})},onTapDeleteAccount:function onTapDeleteAccountFn(e,cb){try{g.PAssert(5089,cb&&g.isFunction(cb),"Delete account cannot be called without a callback")}catch(PERR){g.reportError(PERR)}g.sendEvent("Billing","DeleteAccountTapped");var onDone=function(){cb&&g.isFunction(cb)&&cb()}.bind(this);return g.menus.openModal(Modals.DeleteAccount,function(result){result?(g.sendEvent("Billing","DeleteAccountYES"),goog.deleteAccount(function(success,errorCode){success||errorCode===goog.DeleteErrorCode.RootFolder?g.vmMain.docManager.deleteAllDocs(function(fileSuccess){fileSuccess?g.XHR_PrivateAPI({type:"POST",path:"/tracking/delete",data:{email:this.getBillingIdentifier()},requireAuth:!0,cb:function cbFn(xhr){g.menus.alert(200===xhr.status?{text:"Your account has been successfully deleted.",actionText:"OKAY",callback:function callbackFn(){g.vmSetup.logout()}.bind(this)}:{text:"There was an error removing your email address from our server. Please contact support@moo.do for further assistance with code 3.",actionText:"OKAY"}),onDone()}.bind(this)}):(g.menus.alert({text:"There was an error deleting your Moo.do documents. Please contact support@moo.do for further assistance with code 2.",actionText:"OKAY"}),onDone())}.bind(this)):(g.menus.alert({text:"There was an error deleting your shared account data. Please contact support@moo.do for further assistance with code 1.",actionText:"OKAY"}),onDone())}.bind(this))):(onDone(),g.sendEvent("Billing","DeleteAccountNO"))}.bind(this)),!0},shouldShowAlready:function shouldShowAlreadyFn(){return this.getPastReferrals()>0},shouldShowNext:function shouldShowNextFn(){return this.isInFreeMonthAndPremium()||this.getActiveReferrals()>2},alreadyText:function alreadyTextFn(){var str="Already saved: ",months=this.getPastReferrals()/NumReferralsTo100;return 1>months?str+100*months+"%":str+months+" months"},thisMonthSubtitle:function thisMonthSubtitleFn(){if(this.isInFreeMonthAndPremium())return"Next month is free!";var str="Next month: ",perc=this.getActiveReferrals()/NumReferralsTo100;return str+100*perc+"% saved"},thisMonthSubtext:function thisMonthSubtextFn(){var num=NumReferralsTo100-this.getActiveReferrals();return this.isInFreeMonthAndPremium()?"Be sure to thank to your friend for inviting you.":0===num?"You get next month for free!":"Invite "+num+" more friend"+(num>1?"s":"")+" to save 100%"},nextMonthSubtitle:function nextMonthSubtitleFn(){var str="Following month",numAvailReferrals=this.getUnusedReferrals();this.isInFreeMonthAndPremium()&&(numAvailReferrals+=this.getActiveReferrals()),numAvailReferrals>NumReferralsTo100&&(str+="s");var perc=numAvailReferrals/NumReferralsTo100;return 0===perc?str:str+": "+100*perc+"%"},nextMonthSubtext:function nextMonthSubtextFn(){var num=0;return num=this.getActiveReferrals()===NumReferralsTo100?this.isInFreeMonthAndPremium()?-this.getUnusedReferrals():NumReferralsTo100-this.getUnusedReferrals():this.isInFreeMonthAndPremium()?NumReferralsTo100-this.getActiveReferrals():NumReferralsTo100-this.getActiveReferrals()+NumReferralsTo100,0>=num?"You get the following month for free too!":"Invite "+num+(this.isInFreeMonthAndPremium()?"":" more")+" friend"+(num>1?"s":"")+" to save 100%"},earlySubtitle:function earlySubtitleFn(){var num=NumReferralsTo100-this.getTotalReferrals();return num>0?"Invite "+num+" "+(NumReferralsTo100>num?"more ":"")+"friend"+(num>1?"s":"")+" to become a Community Member":""},earlySubtext:function earlySubtextFn(){var num=NumReferralsTo100-this.getTotalReferrals();return 1===num?"You're almost there! Just one more!":""},updatePremiumBlocks:function updatePremiumBlocksFn(){if(this.shouldShowAlready()){this.alreadyBlocks=[];for(var numPast=this.getPastReferrals(),i=0;i<Math.max(numPast,NumReferralsTo100);i++)this.alreadyBlocks.push({value:numPast>i})}var numActive=this.getActiveReferrals();this.isInFreeMonthAndPremium()&&(numActive=NumReferralsTo100),this.thisBlocks=[];for(var i=0;NumReferralsTo100>i;i++)this.thisBlocks.push({value:numActive>i});if(this.shouldShowNext()){this.nextBlocks=[];var numNext=this.getUnusedReferrals();this.isInFreeMonthAndPremium()&&(numNext+=this.getActiveReferrals());for(var i=0;NumReferralsTo100>i;i++)this.nextBlocks.push({value:numNext>i})}this.communityBlocks=[];for(var numTotal=this.getTotalReferrals(),i=0;NumReferralsTo100>i;i++)this.communityBlocks.push({value:numTotal>i});this.triggerBlocksUpdated.notify()},getUserName:function getUserNameFn(){var user=gdata.authenticatedUser();return user?user.displayName:void 0},getWelcomeText:function getWelcomeTextFn(){return"Hi "+this.getUserName()},getInviteUrl:function getInviteUrlFn(){return"https://www.moo.do/"},getSelectText:function getSelectTextFn(){return"Select and press "+platform.cmdChar+" + C to copy to clipboard"},wasInvited:function wasInvitedFn(){return!!this._referredBy},submitInviteCode:function submitInviteCodeFn(refCode,cb){return refCode&&refCode.length>2?(g.sendEvent("Billing","EnterRefCode"),g.XHR_PrivateAPI({type:"POST",path:"/sharing/setReferral",data:{email:this.getBillingIdentifier(),refCode:refCode},requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){if(xhr.response){try{var parsedResponse=JSON.parse(xhr.response)}catch(err){g.reportError(err)}if(200===xhr.status&&parsedResponse){var data=parsedResponse.data;this._referredBy=data.referredBy,this._nonReferralDiscounts=data.nonReferralDiscounts||0,this._premiumStatus.set(data.premiumStatus);var trialStart=new Date(data.trialStart).getTime();this._updateTrialDaysLeft(trialStart,data.trialDuration),this.updatePremiumBlocks(),this.inviteCodeError.set(""),g.sendEvent("Billing","EnterRefCodeSuccess")}else{if(parsedResponse)switch(parsedResponse.code){case PrivateAPIErrorCodes.AlreadyReferred:this.inviteCodeError.set(""),this.checkRemotePremiumStatus();break;case PrivateAPIErrorCodes.InvalidReferralCode:this.inviteCodeError.set("Referral code not found");break;default:this.inviteCodeError.set("Unable to use referral code")}else this.inviteCodeError.set("Unable to contact server");g.sendEvent("Billing","EnterRefCodeFailure")}}else this.inviteCodeError.set("Unable to contact server"),g.sendEvent("Billing","EnterRefCodeFailure");cb&&cb()}.bind(this)}),!0):void this.inviteCodeError.set("Please enter a valid code")},sendInviteEmail:function sendInviteEmailFn(emailList,cb){if(emailList&&emailList.length>0){for(var localFailedEmails=[],basicEmailRegexp=/.+@.+\..+/i,emailsToSend=[],i=0;i<emailList.length;++i){basicEmailRegexp.lastIndex=0;var email=emailList[i];email&&(email=email.trim(),null===basicEmailRegexp.exec(email)?localFailedEmails.push(email):emailsToSend.push(email))}if(0===localFailedEmails.length)return g.sendEvent("Billing","SendReferralEmail",emailsToSend.length),g.XHR_PrivateAPI({type:"POST",path:"/sharing/sendReferral",data:{fromUser:this.getBillingIdentifier(),toEmailList:emailsToSend},requireAuth:!0,autoRetry:!1,cb:function cbFn(xhr){if(cb&&cb(),200===xhr.status&&xhr.response){var remoteFailedEmails;try{var parsedResponse=JSON.parse(xhr.response);remoteFailedEmails=parsedResponse.data}catch(err){g.reportError(err)}if(remoteFailedEmails&&0!==remoteFailedEmails.length){for(var failReason,emailsFailed=[],i=0;i<remoteFailedEmails.length;++i)emailsFailed.push(remoteFailedEmails[i].email),failReason||(failReason=remoteFailedEmails[i].reason);var emailString=emailsFailed.join(",");this.inviteEmailError.set("exists"===failReason?"One or more of the users is already a Moo.do user.":"One or more of your emails could not be sent.")}else this.inviteEmailSuccess.set("Invite emails sent!"),this.inviteEmailError.set(""),setTimeout(function(){this.inviteEmailSuccess.set("")}.bind(this),4e3)}else this.inviteEmailError.set("Sorry! There was an error sending emails, please try again later.")}.bind(this)}),!0;this.inviteEmailError.set("Please enter a valid email: "+localFailedEmails[0])}},joinDateText:function joinDateTextFn(){return this.getJoinDate().toString(International.getFormat(DFormat.LongStrDate))},premiumStartDateText:function premiumStartDateTextFn(){return this.getPremiumStartDate().toString(International.getFormat(DFormat.LongStrDate))},premiumEndDateText:function premiumEndDateTextFn(){return this.getPremiumEndDate().toString(International.getFormat(DFormat.LongStrDate))},nextBillingDateText:function nextBillingDateTextFn(){return this.getNextBillingDate().toString(International.getFormat(DFormat.LongStrDate))},shareTwitter:function shareTwitterFn(){var message="I love this new organization app!",url="https://twitter.com/share?url="+escape(this.getInviteUrl())+"&text="+message;this.showPopup(url,550,420),g.sendEvent("Billing","ShareTwitter")},shareFacebook:function shareFacebookFn(){var url="https://www.facebook.com/sharer/sharer.php?u="+escape(this.getInviteUrl());this.showPopup(url,600,303),g.sendEvent("Billing","ShareFacebook")},shareGoogle:function shareGoogleFn(){var url="https://plus.google.com/share?url="+this.getInviteUrl();this.showPopup(url,500,650),g.sendEvent("Billing","ShareGoogle")},showPopup:function showPopupFn(url,width,height){var e="scrollbars=yes,resizable=yes,toolbar=no,location=yes",n=width,r=height,o=window.screen.height,i=window.screen.width,a=Math.round(i/2-n/2),c=Math.round(o/2-r/2),params=e+",width="+n+",height="+r+",left="+a+",top="+c;window.open(url,null,params)},onTapSignupMonth:function onTapSignupMonthFn(){this._pricingSelected=this.getMonthlyPricing(),g.menus.openModal(Modals.Billing),g.sendEvent("Billing","OpenSignupModal")},onTapSignupYear:function onTapSignupYearFn(){this._pricingSelected=this.getYearlyPricing(),g.menus.openModal(Modals.Billing),g.sendEvent("Billing","OpenSignupModal")},getMonthlyPricing:function getMonthlyPricingFn(){return this._earlyAdopter?C.Pricing.EarlyMonthly:C.Pricing.RegMonthly},getYearlyPricing:function getYearlyPricingFn(){return this._earlyAdopter?C.Pricing.EarlyYearly:C.Pricing.RegYearly},getMonthlyPrice:function getMonthlyPriceFn(){return premiumPrices[this.getMonthlyPricing()]},getYearlyPrice:function getYearlyPriceFn(){return premiumPrices[this.getYearlyPricing()]},notifyTrialOver:function notifyTrialOverFn(){var notified=g.settings.get(Settings.notifiedTrialOver);if(!notified){if(!g.toasts)return void setTimeout(this.notifyTrialOver.bind(this),0);g.toasts.pushMessage(MessageID.TrialOver),g.settings.set(Settings.notifiedTrialOver,!0)}},notifyTrialEndSoon:function notifyTrialEndSoonFn(){var notified=g.settings.get(Settings.notifiedTrialEndSoon);if(!notified){if(!g.toasts)return void setTimeout(this.notifyTrialEndSoon.bind(this),0);g.toasts.pushMessage(MessageID.TrialEndSoon),g.settings.set(Settings.notifiedTrialEndSoon,!0)}},isTrialOver:function isTrialOverFn(){var trialOver=!1;return this._premiumStatus.get()===PremiumStatus.TrialOver?trialOver=!0:(this._premiumStatus.get()===PremiumStatus.CanceledUser||this._premiumStatus.get()===PremiumStatus.CanceledPastDue)&&(this.canceledUserHasPremiumAccess()||(trialOver=!0)),trialOver},startTrial:function startTrialFn(){try{g.PAssert(5090,!this.isTrialOver(),"Should never try to start a trial once it is over")}catch(PERR){g.reportError(PERR)}g.XHR_PrivateAPI({type:"POST",path:"/billing/startTrial",requireAuth:!0,autoRetry:!0,cb:function cbFn(xhr){if(xhr.status===C.HTTPStatusCode.Success){this._premiumStatus.set(PremiumStatus.Trial);try{var trialData=JSON.parse(xhr.response).data,trialStart=new Date(trialData.trialStart).getTime();g.settings.set(Settings.trialStart,trialStart),g.settings.set(Settings.trialDuration,trialData.trialDuration),this._updateTrialDaysLeft(trialStart,trialData.trialDuration)}catch(err){g.reportError(err)}}else if(xhr.status===C.HTTPStatusCode.BadRequest)try{var trialData=JSON.parse(xhr.response);trialData.code===PrivateAPIErrorCodes.TrialOver&&(g.toasts.pushMessage({text:"Your free trial of Premium has ended. Please contact support@moo.do to extend.",actionText:"OKAY"}),this._premiumStatus.set(PremiumStatus.TrialOver))}catch(err){g.reportError(err)}else{try{g.PAssert(5091,!1,"Failed to start trial for user")}catch(PERR){g.reportError(PERR)}g.toasts.pushMessage({text:"There was an error starting your trial. Please contact support@moo.do.",actionText:"OKAY"})}}.bind(this)})},hasPremiumFeatures:function hasPremiumFeaturesFn(){return this.hasPremium()||this._premiumStatus.get()===PremiumStatus.Trial||this.canceledUserHasPremiumAccess()},getBillingPeriod:function getBillingPeriodFn(){return this._pricingSelected}},BillingManager}),"undefined"==typeof DETAILED_STATS&&(DETAILED_STATS=!0),"http:"===window.location.protocol&&(window.location.hash.indexOf("state=")<0||window.location.hash.indexOf("app")<0&&window.location.hash.indexOf("appv")<0)&&(window.location=window.location.href.replace(/^http:/,"https:")),Date.Config={DEBUG:!0,DisableCache:!0},Error.stackTraceLimit=1/0;try{window.__checkpoints|=1,window.__SESSION_ID=Math.round(1e4*Math.random())+"|"+Date.now(),window.__SESSION_BEGIN=Date.now();var empty=function(){};window.appEvents=window.appEvents||{kbsize:empty,enterBackground:empty,enterForeground:empty,statusBarTap:empty,closeKeyboard:empty,undo:empty,redo:empty,notifyOAuth:empty,features:empty,reportLowMemory:empty,pokeBackground:empty},window.console||(window.console={log:function(){},error:function(){}});var bindLog=!1;window.log=bindLog?function(){}:window.console.log.bind(window.console),window.__log=bindLog?function(){}:window.console.log.bind(window.console),window.__warn=bindLog?function(){}:window.console.warn.bind(window.console),window.__error=bindLog?function(){}:window.console.error.bind(window.console),window.performance&&window.performance.now?(window.log.start=window.performance.now(),window.log.now=function(){return window.performance.now()-window.log.start}):(window.log.start=Date.now(),window.performance={now:function(){return Date.now()-window.log.start}},window.log.now=window.performance.now),window.console.timeStamp||(Object.defineProperty?Object.defineProperty(window.console,"timeStamp",{value:function(){}}):window.console.timeStamp=function(){}),window.console.time||(Object.defineProperty?Object.defineProperty(console,"time",{value:function(){}}):window.console.time=function(){}),window.console.timeEnd||(Object.defineProperty?Object.defineProperty(window.console,"timeEnd",{value:function(){}}):window.console.timeEnd=function(){}),window.console.trace||(Object.defineProperty?Object.defineProperty(window.console,"trace",{value:function(){}}):window.console.trace=function(){}),window.LogLevels={Off:0,Error:1,Warning:2,Timing:4,Data:8,Status:16,Search:32,Timeline:64,Input:128,Tracker:256,Profile:512,PageLoad:1024,Toolbar:2048,Picker:4096,Intro:8192,Import:16384,Version:32768,Settings:65536,Selection:131072,ScrMgr:262144,NativeAuth:524288,DateRoll:1048576,DebugDOM:2097152,RepeatDate:4194304,Connection:8388608,Plugin:16777216,Folders:33554432,Verbose:67108864,Account:134217728,React:268435456,Autocomplete:536870912,Compose:1073741824},window.LogLevel=LogLevels.Error|LogLevels.Warning,window.ShouldLog=function(mask){return window.DEBUG===mask},window.inspectLocal=function(input){if(!input)return void log("Must specify either an item ID or item object to inspect");var item=input;return"string"==typeof input&&(item=window.getModel(input)),log("---- Inspecting Item:",item.id,"----"),log("  RawText:",item.getRawText()),log("  ParsedText:",item.getParsedText()),log("  Els:",item.els),log('  Parent: "'+item.parent().id+'"'),log("  Date:",item.date()),log("  AllDayDate:",item.allDayDate()),log("--------------------------------------------"),item}}catch(err){console.log("Error in main header",err),window.__ERRORINMAINHEADER=err}!function(){var rqConfig;rqConfig={paths:{ko:"lib/knockout-3.2.0",date:"lib/date",FileSaver:"lib/FileSaver",IndexedDBShim:"lib/IndexedDBShim.min",database:"lib/db",react:"lib/react-with-addons.min",IScroll:"lib/iscroll-probe"},shim:{IScroll:{exports:"IScroll"}},waitSeconds:0},require.config(rqConfig)}(),window.gapiKey="AIzaSyB9HEdSJ-nhLJG_ssSSqhI2DX74GSiKSao";var gapiCalled=!1,gapiLoadError=!1;requirejs(["data","globals","util","SettingsManager","gdata","goog","platform","android","edit","VMMain","VMSetup","VMDebug","VMTimeline","TemplateCache","VMAutocomplete","VMMenus","VMTooltip","AppCache","NativeBridge","copypaste","International","RepeatDate","BillingManager","Dispatcher","Multiselect"],function(d,g,util,SettingsManager,gdata,goog,platform,android,edit,VMMain,VMSetup,VMDebug,VMTimeline,TemplateCache,VMAutocomplete,VMMenus,VMTooltip,AppCache,NativeBridge,copypaste,International,RepeatDate,BillingManager,Dispatcher,Multiselect){g.checkpoint(Checkpoint.RequireLoaded),window.__ERRORINMAINHEADER&&g.reportError(window.__ERRORINMAINHEADER),g.nativeBridge=new NativeBridge,g.billingManager=new BillingManager,g.runOnLoad(function(){function onorientationchange(){platform.updateOrientation(),platform.mobile&&(g.keyboardToolbar&&g.keyboardToolbar.isVisible.get()&&g.keyboardToolbar.updatePosition(!0),document.body.scrollTop=0,g.keyboardToolbar&&g.keyboardToolbar.hideTopBarIfLandscape(),android.isEnabled()&&android.isVisible()&&setTimeout(function(){android.updateInputBounds(android.getCurrentVMLI())},0))}function windowResizeHandler(e){g.animFrameOnce("windowResize",windowResize)}function initialize(){initializeCalled||(initializeCalled=!0,g.checkpoint(Checkpoint.InitializeMain),g.openMainPage(),g.registerEvent("ItemCreated","ItemAction","Create"),g.registerEvent("ItemCompleted","ItemAction","Complete"),d.initData(onInitializedData),onInitializedData())}function onInitializedData(){try{if(initializeDataCalled||!initializeCalled||!d.localDataLoaded())return;initializeDataCalled=!0,g.checkpoint(Checkpoint.OnInitializedData),goog.loadClientDefaultFile(),g.isDemoMode()||g.vmMain.setupDateRollover(),g.vmMain.loadData(),ShouldLog(LogLevels.Timing)&&log("Data done loading: ",log.now()),g.menus&&g.menus.bind(),new VMAutocomplete}catch(err){g.reportError(err)}}try{g.checkpoint(Checkpoint.PageLoad);try{g.PAssert(5092,"loading"!==document.readyState,"Should only be calling mainjs after document is loaded"+document.readyState)}catch(PERR){g.reportError(PERR)}if("loading"===document.readyState){var errString="ERROR: MainJS running before document load! "+document.readyState;ShouldLog(LogLevels.Error)&&log(errString),g.reportError(new Error(errString))}window.scriptErrors=window.scriptErrors||{};for(var scriptError in window.scriptErrors)g.fireCustomEvent("scriptLoadError",{src:scriptError,id:window.scriptErrors[scriptError],firstChance:!0});if(window.handleLoadError=function handleLoadErrorSecondChanceFn(e){try{window.scriptErrors[e.target.src]=e.target.id,g.fireCustomEvent("scriptLoadError",{src:e.target.src,id:e.target.id,firstChance:!1})}catch(err){g.reportError(err)}},window.oncontextmenu=function(e){platform.normalizeMouse(e),g.isKeyboardInputElement(e.srcElement)||e.preventDefault()},g.isDemoMode()||platform.offline)var testFn;else{var e=document.createElement("script");e.type="text/javascript",e.src="https://apis.google.com/js/client.js?onload=GoogleApiLoaded",e.async=1,e.id="gapiScript",e.onerror=window.handleLoadError,document.getElementsByTagName("head")[0].appendChild(e),function(i,s,o,g,r,a,m){i.GoogleAnalyticsObject=r,i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date,a=s.createElement(o),m=s.getElementsByTagName(o)[0],a.async=1,a.src=g,m.parentNode.insertBefore(a,m)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-37740918-2",{cookieDomain:"auto",siteSpeedSampleRate:50}),ga("require","displayfeatures"),ga("send","pageview")}if(g.isDemoMode()){var panesStart=util.getURLParam("panes");panesStart&&(g.demoPanes=panesStart.split(":"))}setTimeout(function(){g.sendEvent("PageLoad","NewPage")},0);var setupEvent=function(name){document.documentElement.addEventListener(name,function(e){g.reportEvent(e)},!0)};setupEvent("keydown"),setupEvent("keyup"),setupEvent("keypress"),setupEvent("MSPointerDown"),setupEvent("MSPointerUp"),setupEvent("MSPointerHover"),setupEvent("MSPointerCancel"),setupEvent("mousedown"),setupEvent("mouseup"),setupEvent("touchstart"),setupEvent("touchend"),g.tooltip=new VMTooltip,g.AppCache=new AppCache;var erroredPlatform=platform.blockClient();if(void 0!==erroredPlatform){g.errorPlatformInfo=erroredPlatform;var text,showSignup=!1;if(erroredPlatform.platform?erroredPlatform.update?"Firefox"===erroredPlatform.platform?text='Please update your Firefox browser to use Moo.do. Moo.do requires at least Firefox 16. See <a href="https://support.mozilla.org/en-US/kb/update-firefox-latest-version">https://support.mozilla.org/en-US/kb/update-firefox-latest-version</a> for more information.':"Chrome"===erroredPlatform.platform?text='Please update your Chrome browser to use Moo.do. Moo.do requires at least Chrome 26. See <a href="https://support.google.com/chrome/answer/95414">https://support.google.com/chrome/answer/95414</a> for more information.':"Native Android"===erroredPlatform.platform?text="Please update your Android device to use Moo.do. Moo.do requires at least Android 2.1.":"Internet Explorer"===erroredPlatform.platform?text='Please update your Internet Explorer browser to use Moo.do. Moo.do requires at least Internet Explorer 10. See <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">http://windows.microsoft.com/en-us/internet-explorer/download-ie</a> for more information.':"Safari"===erroredPlatform.platform?text=platform.mobile?"Please update your "+platform.OSName+" to use Moo.do. Moo.do requires at least iOS 6.":'Please update your Safari browser to use Moo.do. Moo.do requires at least Safari 6.1. See <a href="http://support.apple.com/kb/HT6103">http://support.apple.com/kb/HT6103</a> for more information.':(text="Please update your browser to use Moo.do. If you are unable to update your browser, please let us know. Thanks!",showSignup=!0):(showSignup=!0,text="Sorry, we don't support "+erroredPlatform.platform+" yet. Please let us know that you're interested in using "+erroredPlatform.platform+" and we will make it a higher priority. Thanks!"):erroredPlatform.version?text="There was a mandatory update, please update to the latest version of Moo.do. Thanks!":erroredPlatform.cacheUpdate&&(text="There was an issue while updating the app, "+platform.actionVerb()+" to try again.",g.AppCache.update(),erroredPlatform.error&&setTimeout(function(){g.AppCache.runOnFinish(function(){util.insertURLParam("cacheError",!0,!0),g.reload(!0)},!0)},100)),text){var submitFn=function(){return g.requestNotification(navigator.userAgent)},refreshFn=function(){g.AppCache.runOnFinish(function(){g.reload(!0)},!0)};g.applyBindings({platformError:text,showSignup:showSignup,onTapRefresh:refreshFn,onTapSubmit:submitFn},"OSError")}return g.removeDOM("outerWrapper"),g.removeDOM("setupWrapper"),void g.removeDOM("templates")}if(util.removeURLParam("cacheError",!0),g.removeDOM("OSError"),g.localDocChangeRequested=!1,!g.isDemoMode()){var notifiedDocChange=!1;g.settings.registerForChangeNotification(Settings.gdocId,void 0,function(oldValue,newValue){!g.localDocChangeRequested&&oldValue&&oldValue!==newValue&&(notifiedDocChange||(notifiedDocChange=!0,g.menus.alert({text:"The document was changed in another tab. Please close this tab or reload.",actionText:"RELOAD",callback:g.reload})))})}new VMMenus,g.vmDebug=new VMDebug,g.vmSetup=new VMSetup,Dispatcher.listen("remoteDataLoaded",function(){function openRequestedDoc(){try{g.PAssert(5094,g.vmMain&&g.vmMain.vmPicker,"VMMain must be initialized before loading another doc")}catch(PERR){g.reportError(PERR)}g.vmMain.vmPicker.requestOpenDocument(fileForceID)}var fileForceID=util.getURLParam("file"),stateInfo=util.getURLParam("state");if(fileForceID||stateInfo){if(!fileForceID)try{var stateObj=JSON.parse(stateInfo);"open"===stateObj.action&&stateObj.ids&&stateObj.ids.length>=0&&(fileForceID=stateObj.ids[0])}catch(err){g.reportError(err)}var currentDocID=goog.getDocId();if(fileForceID&&currentDocID!==fileForceID){var shareInfo=g.decodeURLObject(util.getURLParam("sinfo")),userMatched=!1,sharingUser,expectedUser;if(shareInfo){var currentUser=g.getUserIdentifier();shareInfo.fromUser&&(sharingUser=shareInfo.fromUser,shareInfo.fromUser===currentUser&&(userMatched=!0)),shareInfo.toUser&&(expectedUser=shareInfo.toUser,shareInfo.toUser===currentUser&&(userMatched=!0))}else userMatched=!0;userMatched?g.menus.alert({text:"You have requested to view another document.",actionText:"OPEN IT",callback:openRequestedDoc}):expectedUser?g.menus.alert({text:"You have requested to view another document meant for "+expectedUser+".",actionText:"OPEN IT",callback:openRequestedDoc}):sharingUser&&g.menus.alert({text:"You have requested to view another document shared by "+sharedUser+".",actionText:"OPEN IT",callback:openRequestedDoc})}}});var windowResize=function(e){var w=document.body.clientWidth,h=document.body.clientHeight,oldWidth=platform.windowWidth(),oldHeight=platform.windowHeight();if(platform.ipad&&!platform.app&&e!==!0&&e!==!1&&setTimeout(windowResize,0,!0),(w!==oldWidth||h!==oldHeight)&&(platform.windowWidth(w),platform.windowHeight(h),platform.onResize.notify(),g.documentHeight=h,g.isMainPageOpen)){var heightDelta=h-oldHeight,kbClosed=(platform.android||platform.mobileie)&&h>oldHeight&&(!platform.app||heightDelta<=platform.kbsize)&&g.vmMain&&g.vmMain.isLoaded;kbClosed&&g.blurActiveElement(),g.autocomplete&&kbClosed&&g.autocomplete.hide(),oldWidth!==w&&e&&platform.mobile&&g.focusedPane&&(platform.mobile&&g.focusedPane&&g.focusedPane.updatePositionMobile(),g.isKeyboardOpen&&g.focusedPane.addPadding()),platform.mobile||(g.fireCustomEvent("windowResize"),Dispatcher.fireEvent("windowResize",[]))}};if(windowResize(!1),onorientationchange(),ShouldLog(LogLevels.Timing)&&log("Running main.js: ",log.now()),g.isDemoMode()||!platform.offline&&window.gapi&&window.gapi.auth&&!gapiCalled&&GoogleApiLoaded(),platform.mobile?(g.removeDOM("contextMenuItem"),g.removeDOM("contextMenuItem_Archived"),g.removeDOM("contextMenuItem_Date"),g.removeDOM("contextMenuItem_Contact"),g.removeDOM("contextMenuItem_Calendar"),g.removeDOM("contextMenuItem_Calendar_Cancelled"),g.removeDOM("contextMenuItem_Drive"),g.removeDOM("contextMenuItem_Gmail"),g.removeDOM("contextMenuItem_Note"),g.removeDOM("contextMenuLink"),g.removeDOM("deleteAccount"),g.removeDOM("billing")):(g.removeDOM("mobileSettings"),g.removeDOM("contextMenuMobileExternalApp")),window.onblur=function(){g.hasFocus=!1},window.onfocus=function(){g.hasFocus=!0,goog.onFocusHandler()},new VMMain,g.timeline=new VMTimeline,platform.mobile&&!platform.android?window.addEventListener("resize",windowResizeHandler):window.addEventListener("resize",windowResize),window.addEventListener("orientationchange",onorientationchange),platform.mobileie){document.addEventListener("focusin",function(e){if("HTML"===e.target.tagName)if(android.isEnabled())if(android.isVisible())android.finishInput(!1);else{var activeSearch=g.getActiveSearch();activeSearch&&activeSearch.isFocused.get()&&activeSearch.onblur()}else log("Skipping Close - Not Android")});var lastScroll=0,preventScrollInterval;window.addEventListener("scroll",function(){lastScroll=Date.now(),preventScrollInterval||(preventScrollInterval=setInterval(function(){Date.now()-lastScroll>5e3&&(clearInterval(preventScrollInterval),preventScrollInterval=void 0),window.scrollTo(0,0)},15))})}window.addEventListener("dragstart",function(dragEvent){return dragEvent.preventDefault(),!1}),window.addEventListener("dragover",function(dragEvent){return dragEvent.preventDefault(),!1});var initializeCalled=!1,initializeDataCalled=!1;g.vmSetup.loginState.subscribe(function(loginState){loginState==LoginState.LOGGED_IN?(initialize(),g.openMainPage()):loginState==LoginState.LOGGED_OUT&&(g.isSetupPageOpen||(g.isSetupPageOpen=!0,util.hasURLParam("login","true")||g.openSetupPage(),g.vmSetup.openLogin())),g.vmMain.setGDriveStatus(platform.offline||!navigator.onLine?DriveStatus.Offline:DriveStatus.Connecting)}),g.vmSetup.init(),g.isDemoMode()&&initialize();var loginState=g.getLoginState();loginState!=LoginState.LOGGED_OUT?d.initData(initialize):!g.isDemoMode()&&platform.app&&g.nativeBridge.sendToApp("loaded");var liveReloadAddress}catch(mainErr){g.handleCriticalError(),g.reportError(mainErr,"Critical Error")}})}),define("main",function(){});
//# sourceMappingURL=main-min.js.map